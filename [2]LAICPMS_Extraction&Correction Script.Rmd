---
title: "LAICPMS_Extraction&Correction Script"
author: "Thomas J Williams"
date: "16/05/2022"
version: "2.01"
edited by: "Thomas J Williams"
edit date: "03/08/2022"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r packages and functions, echo = F, message=T}
packages <- c("tidyverse", "janitor", "sjmisc", "Hmisc", "viridis", "ggthemes", "patchwork", "raster", "terra", "scales")
rasterpackages <- c("caTools", "scatterplot3d", "wesanderson", "matrixStats", "viridis", "RColorBrewer", "raster", "rasterVis", "hillshader")

options(scipen = 100)

for (i in packages) {
if (i %in% rownames(installed.packages()) == FALSE) 
{install.packages(i)
  require(i, character.only = T)} else {
    require(i, character.only = T)
  }
}

for (i in rasterpackages) {
if (i %in% rownames(installed.packages()) == FALSE) 
{install.packages(i)
  require(i, character.only = T)} else {
    require(i, character.only = T)
  }
}

# plotting multiple plots in a list
plot_a_list <- function(master_list_with_plots, no_of_rows, no_of_cols, ylim, xlim, ylab, xlab) {
  if(missing(ylim) | missing(xlim) | missing(ylab) | missing(xlab)) {
    patchwork::wrap_plots(master_list_with_plots, 
                        nrow = no_of_rows, ncol = no_of_cols)
  } else {
      patchwork::wrap_plots(master_list_with_plots, 
                        nrow = no_of_rows, ncol = no_of_cols) &
  ggplot2::lims(y = ylim, x = xlim) &
      ggplot2::xlab(label = xlab) &
      ggplot2::ylab(label = ylab)
  }
}
```

## Data extraction and import into R environment

```{r importing constants, echo = F, message=T}
Element_constants <- data.frame(Element = c("Li", "B", "Mg", "P", "S", "Ca", "Mn", "Ni", "Cu", "Zn", "Sr", "Ba", "Pb", "U"),
                                Mass = c(6.941, 10.811, 24.305, 30.974, 32.065, 40.078, 54.938044, 58.693, 63.546, 65.380, 87.620, 137.327, 207.200, 238.029))

Conversions <- data.frame(Conversion = c("nmol/mol", "Âµmol/mol", "mmol/mol"),
                          Value = c(1000000000, 1000000, 1000))

NIST612 <- data.frame(Papers = c("Expected", "Jochum et al., 2011", "Evans and Muller 2018"),
                      Li_Ca = c(0.000472673136124054, 0.000472673136124054, NA),
                      B_Ca = c(0.000403300710673011, 0.000403300710673011, NA),
                      Mg_Ca = c(0.000800, 0.000799546598418798, 0.000733702),
                      P_Ca = c(0.000547924580681117, 0.000547924580681117, NA),
                      S_Ca = c(0.00443278040593951, 0.00443278040593951, NA),
                      Mn_Ca = c(0.000455036078805992,0.000455036078805992, NA),
                      Sr_Ca = c(0.000921830195824026, 0.000921830195824026, NA),
                      Ba_Ca = c(0.000462090901733217, 0.000462090901733217, NA),
                      U_Ca = c(0.000439515468366098, 0.000439515468366098, NA))

JCP <- data.frame(Papers = c("Expected", "Hathorne et al. 2013", "Jochum et al. 2019", "Kazuya et al. 2013", "Okai 2002"),
                      Li_Ca = c(6.185, 6.185, NA, NA, NA),
                      B_Ca = c(459.6, 459.6, NA, NA, NA),
                      Mg_Ca = c(4.199, 4.199, NA, NA, NA),
                      P_Ca = c(44.9574477483416, NA, 44.9574477483416, 19.57170093706, NA),
                      S_Ca = c(6.23662202674343, NA, NA, NA, 6.23662202674343),
                      Mn_Ca = c(1.48841878415292,NA, 1.48841878415292, NA, NA),
                      Sr_Ca = c(8.838, 8.838, NA, NA, NA),
                      Ba_Ca = c(7.465, 7.465, NA, NA, NA),
                      U_Ca = c(1192, 1192, NA, NA, NA))

setNames <- c("Element_constants", "Conversions", "NIST612", "JCP")
Constants <- list(Element_constants, Conversions, NIST612, JCP)
Constants <- setNames(lapply(setNames, get),setNames)

```

```{r extraction & importation, echo = F, message=T}
# all relevant files are csv
ICPMS_csvfilelist <- list.files(path = "~/OneDrive - University of Southampton/PhD, INSPIRE DTP/Countries_Chapters/UK [Soton]/Chpt4 Bamboo Coral Analysis/LAICPMS/Bamboo Corals 05May22", 
                             pattern = ".csv", 
                             full.names = T, 
                             include.dirs = F, #includes subdirectories
                             recursive = T) #all subfolders as well

ICPMS_csvfiles <- lapply(ICPMS_csvfilelist, function(i) {
  read.csv2(i, header = F, sep = ",", stringsAsFactors = FALSE)
  })

# quality check - remove failed tracks & information tables (failed track dataframe usually precedes the other)
View(ICPMS_csvfiles) # check for small dataframes
View(ICPMS_csvfiles[[22]]) # failed ablation
View(ICPMS_csvfiles[[23]]) # directory file 1
View(ICPMS_csvfiles[[53]]) # failed ablation
View(ICPMS_csvfiles[[54]]) # directory file 2
View(ICPMS_csvfiles[[106]]) # directory file 3

# lets merge the directory files
ICPMS_directories <- rbind(ICPMS_csvfiles[[23]], ICPMS_csvfiles[[54]], ICPMS_csvfiles[[106]])

# add sample ID to directory and tidy up the dataframe
ICPMS_directories_tidy <- ICPMS_directories %>%
  row_to_names(row_number = 1) %>%
  clean_names() %>%
  slice(-c(23,54)) %>% #remove duplicated headings
  select(-na) 

ICPMS_directories_tidy <- ICPMS_directories_tidy %>%
  mutate(sampleID = paste("A", 1:nrow(ICPMS_directories_tidy), sep = ""), .before = acq_date_time)

# now rename the unneded dataframes in the large list based off the directory file sample IDs
ICPMS_csvfiles_tidy <- ICPMS_csvfiles
for (x in 1:length(ICPMS_csvfiles)) {
  if (length(ICPMS_directories_tidy[which(ICPMS_csvfiles_tidy[[x]]$V1[1] == ICPMS_directories_tidy$file_name),]$sample_name) > 0) {
  names(ICPMS_csvfiles_tidy)[x] <- ICPMS_directories_tidy[which(ICPMS_csvfiles_tidy[[x]]$V1[1] == ICPMS_directories_tidy$file_name),]$sampleID
  ICPMS_csvfiles_tidy[[x]] <- ICPMS_csvfiles_tidy[[x]] %>%
    row_to_names(row_number = 4, remove_rows_above = T) %>%
    mutate_if(is.character, as.numeric)
  } else {next} 
}


ICPMS_csvfiles_tidy[["NA"]] <- NULL
ICPMS_csvfiles_tidy[["NA"]] <- NULL
ICPMS_csvfiles_tidy[["NA"]] <- NULL
ICPMS_csvfiles_tidy[["NA"]] <- NULL
ICPMS_csvfiles_tidy[["NA"]] <- NULL

Sample_list <- ICPMS_directories_tidy %>%
  dplyr::select(sampleID, acq_date_time, sample_name, acquisition_result, total_acq_time)

write.csv(Sample_list, "Sample_list.csv")
```

CHUNK 5 - DATA PROCESSING
Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
```{r data processing, echo = F, message=T}
# This will be different for each corals sample + standards
# Cross-reference with the ICPMS_directories_tidy to extract the specific dataframes 
Runs_612 <- ICPMS_csvfiles_tidy[c("A1", "A9", "A17", "A26", "A34", "A42", "A50", "A53", "A61", "A69", "A77", "A85", "A93", "A101")]
Runs_JCP <- ICPMS_csvfiles_tidy[c("A2", "A10", "A18", "A27", "A35", "A43", "A51", "A54", "A62", "A70", "A78", "A86", "A94", "A102")]
Runs_DSC <- ICPMS_csvfiles_tidy[c("A3", "A11", "A19", "A28", "A36", "A44", "A55", "A63", "A71", "A79", "A87", "A95")]
Runs_Sample_23_16_1 <- ICPMS_csvfiles_tidy[c("A4","A5","A6","A7","A8")]
Runs_Sample_23_16_2 <- ICPMS_csvfiles_tidy[c("A12","A13","A14","A15","A16")]
Runs_Sample_23_16_3 <- ICPMS_csvfiles_tidy[c("A20","A21","A23","A24","A25")]
Runs_Sample_23_1_1 <- ICPMS_csvfiles_tidy[c("A29","A30","A31","A32","A33")]
Runs_Sample_23_1_2 <- ICPMS_csvfiles_tidy[c("A37","A38","A39","A40","A41")]
Runs_Sample_23_1_3 <- ICPMS_csvfiles_tidy[c("A45","A46","A47","A48","A49")]
Runs_Sample_23_10_1 <- ICPMS_csvfiles_tidy[c("A56","A57","A58","A59","A60")]
Runs_Sample_23_10_2 <- ICPMS_csvfiles_tidy[c("A64","A65","A66","A67","A68")]
Runs_Sample_23_10_3 <- ICPMS_csvfiles_tidy[c("A72","A73","A74","A75","A76")]
Runs_Sample_23_6_1 <- ICPMS_csvfiles_tidy[c("A80","A81","A82","A83","A84")]
Runs_Sample_23_6_2 <- ICPMS_csvfiles_tidy[c("A88","A89","A90","A91","A92")]
Runs_Sample_23_6_3 <- ICPMS_csvfiles_tidy[c("A96","A97","A98","A99","A100")]

Signals_graph_folder <- "~/OneDrive - University of Southampton/PhD, INSPIRE DTP/Countries_Chapters/UK [Soton]/Chpt4 Bamboo Coral Analysis/LAICPMS/Element_Signals"

# 612 standards code ####
Analysis_612 <- list()
Calculations_612 <- list()
Elementdata_612 <- list()
Li_Ca_ratios_612 <- list()
j <- 1
for (j in 1:length(Runs_612)) {
  
nc<-wes_palette(length(names(Runs_612[[j]][2:11])), name="Darjeeling1", type="continuous")
datapoints <- ggplot(data = Runs_612[[j]], aes(x = `Time [Sec]`)) 

for (a in 2:11) {
  datapoints <- datapoints + geom_line(aes_string(y = names(Runs_612[[j]])[a], color =  shQuote(names(Runs_612[[j]])[a])))
}

if (names(Runs_612[[j]][7]) != "Ca43") {stop(paste0("Wrong element! ", names(Runs_612[[j]][7]), " for Runs_612_", j))} # Ca43

Time_length <- length(Runs_612[[j]]$`Time [Sec]`)

Delta_Ca_dataframe <- data.frame(Delta_Ca = as.numeric(rep(NA, Time_length+14)),
                                 Time = c(Runs_612[[j]]$`Time [Sec]`,rep(NA,14))
                                  )

# Rolling 4 step difference
for(x in 1:length(Runs_612[[j]]$`Time [Sec]`)) {
Delta_Ca <- (Runs_612[[j]]$Ca43[x+3] - Runs_612[[j]]$Ca43[x])/(Runs_612[[j]]$`Time [Sec]`[x+3] - Runs_612[[j]]$`Time [Sec]`[x])
  Delta_Ca_dataframe$Delta_Ca[x+3]  <- ceiling(Delta_Ca)
  Delta_Ca_dataframe
}

Cut_off1 <- max(Delta_Ca_dataframe[which(Delta_Ca_dataframe$Time <= 50),]$Delta_Ca, na.rm = T)
# In case there is a jump in the calcium at the exterior of the coral (due to calcification boundary)
Cut_off2 <- min(Delta_Ca_dataframe[which(Delta_Ca_dataframe$Time >= max(Delta_Ca_dataframe$Time, na.rm = T)/2),]$Delta_Ca, na.rm = T)
Pre_blank_cut_off <- Delta_Ca_dataframe[which(Delta_Ca_dataframe$Delta_Ca == Cut_off1),]$Time
Post_blank_cut_off <- Delta_Ca_dataframe[which(Delta_Ca_dataframe$Delta_Ca == Cut_off2),]$Time

datapoints_graph <- datapoints + 
  geom_vline(xintercept = 0) +
  geom_vline(xintercept = 30.5) + # preblank cut off
  geom_vline(xintercept = max(Runs_612[[j]]$`Time [Sec]`, na.rm = T)) +
  geom_vline(xintercept = max(Runs_612[[j]]$`Time [Sec]`, na.rm = T)-45) + #postblank cut off
  geom_vline(xintercept = Pre_blank_cut_off, linetype = 2) + # start of analysis
  geom_vline(xintercept = Post_blank_cut_off-2, linetype = 2) + # end of analysis
  scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
                labels = trans_format("log10", math_format(10^.x))) +
  annotation_logticks(sides = "l") +
  annotate("text", x = 100, y = 100, hjust = 1, vjust = 2, label = names(Runs_612[j]), col = "black") +
  ylab("Signal") +
  scale_fill_discrete(name = "Element") +
  theme_classic()

assign(paste0(names(Runs_612[j]), "_Elementsignals"), datapoints_graph)
Elementdata_612[[paste0(names(Runs_612[j]), "_Elementsignals")]] <- datapoints_graph

Preblank <- Runs_612[[j]] %>%
  filter(`Time [Sec]` <= 30.5) %>%
  mutate( across(all_of(c(2:11)), ~ ., .names = "{col}_preblank"))

Postblank <- Runs_612[[j]] %>%
  filter(`Time [Sec]` >= max(`Time [Sec]`, na.rm = T)-45) %>%
  mutate(across(all_of(c(2:11)), ~ ., .names = "{col}_postblank"))

Allblanks <- full_join(Preblank, Postblank)

Analysis <- Runs_612[[j]] %>%
  filter(`Time [Sec]` >= Pre_blank_cut_off & `Time [Sec]` <= Post_blank_cut_off) %>% 
  mutate(across(all_of(c(2:11)), ~ ., .names = "{col}_analysis"))

Analysis_full <- full_join(full_join(Allblanks, Analysis), Runs_612[[j]])
Analysis_full <- Analysis_full[order(Analysis_full$`Time [Sec]`),]
row.names(Analysis_full) <- NULL

Data_averages <- Analysis_full %>%
  summarise(across(all_of(c(12:41)), 
                   ~c(sum(!is.na(.x)),
                      mean(.x, na.rm = T), 
                   (sd(.x, na.rm = T)*2),
                   (sd(.x, na.rm = T)*2)/(mean(.x, na.rm = T))*100,
                   (sd(.x, na.rm = T)*3),
                   ((sd(.x, na.rm = T)*2)/sqrt(((sum(!is.na(.x)))-1))),
                   (((sd(.x, na.rm = T)*2)/sqrt(((sum(!is.na(.x)))-1))))/(mean(.x, na.rm = T))*100
                   )
                   )
            ) %>%
    add_column(Calculation = c("n", "mean", "2sd","2sd %","3sd", "2se", "2se%"), .before = "Li7_preblank")

cutoffs_table <- data.frame()

for(i in 12:ncol(Analysis_full)) {
 cutoffs <- Analysis_full[i] %>%
  filter(Analysis_full[i] < (mean(Analysis_full[[i]], na.rm = T) + (sd(Analysis_full[[i]], na.rm = T)*2)) &
           Analysis_full[i] > (mean(Analysis_full[[i]], na.rm = T) - (sd(Analysis_full[[i]], na.rm = T)*2)))
 meancutoffs <- mean(cutoffs[,1])
 print(meancutoffs)
 meancutoffs_data <- data.frame(variable = colnames(Analysis_full[i]),
                                mean2sd = meancutoffs)
 colnames(meancutoffs_data) <- c("variable", "mean2sd")
 cutoffs_table <- rbind(cutoffs_table, meancutoffs_data)
}

cutoffs_table <- cutoffs_table %>%
  rotate_df(rn = "Calculation", cn = T)

Data_averages_V2 <- full_join(cutoffs_table, Data_averages)

# starting the blank correction
Blankcorrections <- Analysis_full %>%
  dplyr::select(1,32:41) %>%
  mutate(
    Li7_analysis_blankcorrected = (Li7_analysis-(mean(Data_averages_V2$Li7_preblank[3],Data_averages_V2$Li7_postblank[3]))),
    B11_analysis_blankcorrected = (B11_analysis-(mean(Data_averages_V2$B11_preblank[3],Data_averages_V2$B11_postblank[3]))),
    Mg24_analysis_blankcorrected = (Mg24_analysis-(mean(Data_averages_V2$Mg24_preblank[3],Data_averages_V2$Mg24_postblank[3]))),
    P31_analysis_blankcorrected = (P31_analysis-(mean(Data_averages_V2$P31_preblank[3],Data_averages_V2$P31_postblank[3]))),
    S34_analysis_blankcorrected = (S34_analysis-(mean(Data_averages_V2$S34_preblank[3],Data_averages_V2$S34_postblank[3]))),
    Ca43_analysis_blankcorrected = (Ca43_analysis-(mean(Data_averages_V2$Ca43_preblank[3],Data_averages_V2$Ca43_postblank[3]))),
    Mn55_analysis_blankcorrected = (Mn55_analysis-(mean(Data_averages_V2$Mn55_preblank[3],Data_averages_V2$Mn55_postblank[3]))),
    Sr86_analysis_blankcorrected = (Sr86_analysis-(mean(Data_averages_V2$Sr86_preblank[3],Data_averages_V2$Sr86_postblank[3]))),
    Ba137_analysis_blankcorrected = (Ba137_analysis-(mean(Data_averages_V2$Ba137_preblank[3],Data_averages_V2$Ba137_postblank[3]))),
    U238_analysis_blankcorrected = (U238_analysis-(mean(Data_averages_V2$U238_preblank[3],Data_averages_V2$U238_postblank[3]))),
  )

Blankcorrections_ratios <- Blankcorrections %>%
  mutate(
    Li_Ca = Li7_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    B_Ca = B11_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    Mg_Ca = Mg24_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    P_Ca = P31_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    S_Ca = S34_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    Mn_Ca = Mn55_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    Sr_Ca = Sr86_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    Ba_Ca = Ba137_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    U_Ca = U238_analysis_blankcorrected/Ca43_analysis_blankcorrected
  )


Li_Ca <- ggplot() +
  geom_point(aes_(Blankcorrections_ratios$`Time [Sec]`,Blankcorrections_ratios$Li_Ca)) + 
  annotate("text", x = Inf, y = Inf, hjust = 1, vjust = 2, label = "Blank corrected", col = "red") +
  annotate("text", x = -Inf, y = Inf, hjust = -.25, vjust = 2, label = names(Runs_612[j]), col = "black")

assign(paste0(names(Runs_612[j]), "_Li/Ca ratio"), Li_Ca)
Li_Ca_ratios_612[[paste0(names(Runs_612[j]), "_Li/Ca ratio")]] <- Li_Ca

Analysis_full_blankcorrections_ratios <- full_join(Analysis_full, Blankcorrections_ratios)
assign(paste0(names(Runs_612[j]), "_Analysis table"), Analysis_full_blankcorrections_ratios)
Analysis_612[[paste0(names(Runs_612[j]), "_Analysis table")]] <- Analysis_full_blankcorrections_ratios

Data_averages <- Analysis_full_blankcorrections_ratios %>%
  summarise(across(all_of(c(12:60)), 
                   ~c(sum(!is.na(.x)),
                      mean(.x, na.rm = T), 
                   (sd(.x, na.rm = T)*2),
                   (sd(.x, na.rm = T)*2)/(mean(.x, na.rm = T))*100,
                   (sd(.x, na.rm = T)*3),
                   ((sd(.x, na.rm = T)*2)/sqrt(((sum(!is.na(.x)))-1))),
                   (((sd(.x, na.rm = T)*2)/sqrt(((sum(!is.na(.x)))-1))))/(mean(.x, na.rm = T))*100
                   )
                   )
            ) %>%
    add_column(Calculation = c("n", "mean", "2sd","2sd %","3sd", "2se", "2se%"), .before = "Li7_preblank")

cutoffs_table <- data.frame()

for(i in 12:ncol(Analysis_full_blankcorrections_ratios)) {
 cutoffs <- Analysis_full_blankcorrections_ratios[i] %>%
  filter(Analysis_full_blankcorrections_ratios[i] < (mean(Analysis_full_blankcorrections_ratios[[i]], na.rm = T) + (sd(Analysis_full_blankcorrections_ratios[[i]], na.rm = T)*2)) &
           Analysis_full_blankcorrections_ratios[i] > (mean(Analysis_full_blankcorrections_ratios[[i]], na.rm = T) - (sd(Analysis_full_blankcorrections_ratios[[i]], na.rm = T)*2)))
 meancutoffs <- mean(cutoffs[,1])
 print(meancutoffs)
 meancutoffs_data <- data.frame(variable = colnames(Analysis_full_blankcorrections_ratios[i]),
                                mean2sd = meancutoffs)
 colnames(meancutoffs_data) <- c("variable", "mean2sd")
 cutoffs_table <- rbind(cutoffs_table, meancutoffs_data)
}

cutoffs_table <- cutoffs_table %>%
  rotate_df(rn = "Calculation", cn = T)

Data_averages_V2 <- full_join(cutoffs_table, Data_averages)
assign(paste0(names(Runs_612[j]), "_Calculations"), Data_averages_V2)
Calculations_612[[paste0(names(Runs_612[j]), "_Calculations")]] <- Data_averages_V2

}
plot_a_list(Elementdata_612, 7,2)

ggsave(
  "612_Element_Signals.tiff",
  plot = last_plot(),
  device = "tiff",
  path = Signals_graph_folder,
  scale = 1,
  width = 30,
  height = 40,
  units = "cm",
  dpi = 300,
  bg = NULL
)

plot_a_list(Li_Ca_ratios_612, 7,2, ylim = c(0,.6), xlim = c(0,200))

# JCP standards code ####
Analysis_JCP <- list()
Calculations_JCP <- list()
Elementdata_JCP <- list()
Li_Ca_ratios_JCP <- list()

for (j in 1:length(Runs_JCP)) {
  
nc<-wes_palette(length(names(Runs_JCP[[j]][2:11])), name="Darjeeling1", type="continuous")
datapoints <- ggplot(data = Runs_JCP[[j]], aes(x = `Time [Sec]`)) 

for (a in 2:11) {
  datapoints <- datapoints + geom_line(aes_string(y = names(Runs_JCP[[j]])[a], color =  shQuote(names(Runs_JCP[[j]])[a])))
}

if (names(Runs_JCP[[j]][7]) != "Ca43") {stop(paste0("Wrong element! ", names(Runs_JCP[[j]][7]), " for Runs_JCP_", j))} # Ca43

Time_length <- length(Runs_JCP[[j]]$`Time [Sec]`)

Delta_Ca_dataframe <- data.frame(Delta_Ca = as.numeric(rep(NA, Time_length+14)),
                                 Time = c(Runs_JCP[[j]]$`Time [Sec]`,rep(NA,14))
                                  )

# Rolling 4 step difference
for(x in 1:length(Runs_JCP[[j]]$`Time [Sec]`)) {
Delta_Ca <- (Runs_JCP[[j]]$Ca43[x+3] - Runs_JCP[[j]]$Ca43[x])/(Runs_JCP[[j]]$`Time [Sec]`[x+3] - Runs_JCP[[j]]$`Time [Sec]`[x])
  Delta_Ca_dataframe$Delta_Ca[x+3]  <- ceiling(Delta_Ca)
  Delta_Ca_dataframe
}

Cut_off1 <- max(Delta_Ca_dataframe[which(Delta_Ca_dataframe$Time <= 50),]$Delta_Ca, na.rm = T)
# In case there is a jump in the calcium at the exterior of the coral (due to calcification boundary)
Cut_off2 <- min(Delta_Ca_dataframe[which(Delta_Ca_dataframe$Time >= max(Delta_Ca_dataframe$Time, na.rm = T)/2),]$Delta_Ca, na.rm = T)
Pre_blank_cut_off <- Delta_Ca_dataframe[which(Delta_Ca_dataframe$Delta_Ca == Cut_off1),]$Time
Post_blank_cut_off <- Delta_Ca_dataframe[which(Delta_Ca_dataframe$Delta_Ca == Cut_off2),]$Time

datapoints_graph <- datapoints + 
  geom_vline(xintercept = 0) +
  geom_vline(xintercept = 30.5) + # preblank cut off
  geom_vline(xintercept = max(Runs_JCP[[j]]$`Time [Sec]`, na.rm = T)) +
  geom_vline(xintercept = max(Runs_JCP[[j]]$`Time [Sec]`, na.rm = T)-45) + #postblank cut off
  geom_vline(xintercept = Pre_blank_cut_off, linetype = 2) + # start of analysis
  geom_vline(xintercept = Post_blank_cut_off-2, linetype = 2) + # end of analysis
  scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
                labels = trans_format("log10", math_format(10^.x))) +
  annotation_logticks(sides = "l") +
  annotate("text", x = 100, y = 100, hjust = 1, vjust = 2, label = names(Runs_JCP[j]), col = "black") +
  ylab("Signal") +
  scale_fill_discrete(name = "Element") +
  theme_classic()

assign(paste0(names(Runs_JCP[j]), "_Elementsignals"), datapoints_graph)
Elementdata_JCP[[paste0(names(Runs_JCP[j]), "_Elementsignals")]] <- datapoints_graph

Preblank <- Runs_JCP[[j]] %>%
  filter(`Time [Sec]` <= 30.5) %>%
  mutate( across(all_of(c(2:11)), ~ ., .names = "{col}_preblank"))

Postblank <- Runs_JCP[[j]] %>%
  filter(`Time [Sec]` >= max(`Time [Sec]`, na.rm = T)-45) %>%
  mutate(across(all_of(c(2:11)), ~ ., .names = "{col}_postblank"))

Allblanks <- full_join(Preblank, Postblank)

Analysis <- Runs_JCP[[j]] %>%
  filter(`Time [Sec]` >= Pre_blank_cut_off & `Time [Sec]` <= Post_blank_cut_off) %>% 
  mutate(across(all_of(c(2:11)), ~ ., .names = "{col}_analysis"))

Analysis_full <- full_join(full_join(Allblanks, Analysis), Runs_JCP[[j]])
Analysis_full <- Analysis_full[order(Analysis_full$`Time [Sec]`),]
row.names(Analysis_full) <- NULL

Data_averages <- Analysis_full %>%
  summarise(across(all_of(c(12:41)), 
                   ~c(sum(!is.na(.x)),
                      mean(.x, na.rm = T), 
                   (sd(.x, na.rm = T)*2),
                   (sd(.x, na.rm = T)*2)/(mean(.x, na.rm = T))*100,
                   (sd(.x, na.rm = T)*3),
                   ((sd(.x, na.rm = T)*2)/sqrt(((sum(!is.na(.x)))-1))),
                   (((sd(.x, na.rm = T)*2)/sqrt(((sum(!is.na(.x)))-1))))/(mean(.x, na.rm = T))*100
                   )
                   )
            ) %>%
    add_column(Calculation = c("n", "mean", "2sd","2sd %","3sd", "2se", "2se%"), .before = "Li7_preblank")

cutoffs_table <- data.frame()

for(i in 12:ncol(Analysis_full)) {
 cutoffs <- Analysis_full[i] %>%
  filter(Analysis_full[i] < (mean(Analysis_full[[i]], na.rm = T) + (sd(Analysis_full[[i]], na.rm = T)*2)) &
           Analysis_full[i] > (mean(Analysis_full[[i]], na.rm = T) - (sd(Analysis_full[[i]], na.rm = T)*2)))
 meancutoffs <- mean(cutoffs[,1])
 print(meancutoffs)
 meancutoffs_data <- data.frame(variable = colnames(Analysis_full[i]),
                                mean2sd = meancutoffs)
 colnames(meancutoffs_data) <- c("variable", "mean2sd")
 cutoffs_table <- rbind(cutoffs_table, meancutoffs_data)
}

cutoffs_table <- cutoffs_table %>%
  rotate_df(rn = "Calculation", cn = T)

Data_averages_V2 <- full_join(cutoffs_table, Data_averages)

# starting the blank correction
Blankcorrections <- Analysis_full %>%
  dplyr::select(1,32:41) %>%
  mutate(
    Li7_analysis_blankcorrected = (Li7_analysis-(mean(Data_averages_V2$Li7_preblank[3],Data_averages_V2$Li7_postblank[3]))),
    B11_analysis_blankcorrected = (B11_analysis-(mean(Data_averages_V2$B11_preblank[3],Data_averages_V2$B11_postblank[3]))),
    Mg24_analysis_blankcorrected = (Mg24_analysis-(mean(Data_averages_V2$Mg24_preblank[3],Data_averages_V2$Mg24_postblank[3]))),
    P31_analysis_blankcorrected = (P31_analysis-(mean(Data_averages_V2$P31_preblank[3],Data_averages_V2$P31_postblank[3]))),
    S34_analysis_blankcorrected = (S34_analysis-(mean(Data_averages_V2$S34_preblank[3],Data_averages_V2$S34_postblank[3]))),
    Ca43_analysis_blankcorrected = (Ca43_analysis-(mean(Data_averages_V2$Ca43_preblank[3],Data_averages_V2$Ca43_postblank[3]))),
    Mn55_analysis_blankcorrected = (Mn55_analysis-(mean(Data_averages_V2$Mn55_preblank[3],Data_averages_V2$Mn55_postblank[3]))),
    Sr86_analysis_blankcorrected = (Sr86_analysis-(mean(Data_averages_V2$Sr86_preblank[3],Data_averages_V2$Sr86_postblank[3]))),
    Ba137_analysis_blankcorrected = (Ba137_analysis-(mean(Data_averages_V2$Ba137_preblank[3],Data_averages_V2$Ba137_postblank[3]))),
    U238_analysis_blankcorrected = (U238_analysis-(mean(Data_averages_V2$U238_preblank[3],Data_averages_V2$U238_postblank[3]))),
  )

Blankcorrections_ratios <- Blankcorrections %>%
  mutate(
    Li_Ca = Li7_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    B_Ca = B11_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    Mg_Ca = Mg24_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    P_Ca = P31_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    S_Ca = S34_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    Mn_Ca = Mn55_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    Sr_Ca = Sr86_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    Ba_Ca = Ba137_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    U_Ca = U238_analysis_blankcorrected/Ca43_analysis_blankcorrected
  )


Li_Ca <- ggplot() +
  geom_point(aes_(Blankcorrections_ratios$`Time [Sec]`,Blankcorrections_ratios$Li_Ca)) + 
  annotate("text", x = Inf, y = Inf, hjust = 1, vjust = 2, label = "Blank corrected", col = "red") +
  annotate("text", x = -Inf, y = Inf, hjust = -.25, vjust = 2, label = names(Runs_JCP[j]), col = "black")

assign(paste0(names(Runs_JCP[j]), "_Li/Ca ratio"), Li_Ca)
Li_Ca_ratios_JCP[[paste0(names(Runs_JCP[j]), "_Li/Ca ratio")]] <- Li_Ca

Analysis_full_blankcorrections_ratios <- full_join(Analysis_full, Blankcorrections_ratios)
assign(paste0(names(Runs_JCP[j]), "_Analysis table"), Analysis_full_blankcorrections_ratios)
Analysis_JCP[[paste0(names(Runs_JCP[j]), "_Analysis table")]] <- Analysis_full_blankcorrections_ratios

Data_averages <- Analysis_full_blankcorrections_ratios %>%
  summarise(across(all_of(c(12:60)), 
                   ~c(sum(!is.na(.x)),
                      mean(.x, na.rm = T), 
                   (sd(.x, na.rm = T)*2),
                   (sd(.x, na.rm = T)*2)/(mean(.x, na.rm = T))*100,
                   (sd(.x, na.rm = T)*3),
                   ((sd(.x, na.rm = T)*2)/sqrt(((sum(!is.na(.x)))-1))),
                   (((sd(.x, na.rm = T)*2)/sqrt(((sum(!is.na(.x)))-1))))/(mean(.x, na.rm = T))*100
                   )
                   )
            ) %>%
    add_column(Calculation = c("n", "mean", "2sd","2sd %","3sd", "2se", "2se%"), .before = "Li7_preblank")

cutoffs_table <- data.frame()

for(i in 12:ncol(Analysis_full_blankcorrections_ratios)) {
 cutoffs <- Analysis_full_blankcorrections_ratios[i] %>%
  filter(Analysis_full_blankcorrections_ratios[i] < (mean(Analysis_full_blankcorrections_ratios[[i]], na.rm = T) + (sd(Analysis_full_blankcorrections_ratios[[i]], na.rm = T)*2)) &
           Analysis_full_blankcorrections_ratios[i] > (mean(Analysis_full_blankcorrections_ratios[[i]], na.rm = T) - (sd(Analysis_full_blankcorrections_ratios[[i]], na.rm = T)*2)))
 meancutoffs <- mean(cutoffs[,1])
 print(meancutoffs)
 meancutoffs_data <- data.frame(variable = colnames(Analysis_full_blankcorrections_ratios[i]),
                                mean2sd = meancutoffs)
 colnames(meancutoffs_data) <- c("variable", "mean2sd")
 cutoffs_table <- rbind(cutoffs_table, meancutoffs_data)
}

cutoffs_table <- cutoffs_table %>%
  rotate_df(rn = "Calculation", cn = T)

Data_averages_V2 <- full_join(cutoffs_table, Data_averages)
assign(paste0(names(Runs_JCP[j]), "_Calculations"), Data_averages_V2)
Calculations_JCP[[paste0(names(Runs_JCP[j]), "_Calculations")]] <- Data_averages_V2

}


plot_a_list(Elementdata_JCP, 7,2)

ggsave(
  "JCP_Element_Signals.tiff",
  plot = last_plot(),
  device = "tiff",
  path = Signals_graph_folder,
  scale = 1,
  width = 30,
  height = 40,
  units = "cm",
  dpi = 300,
  bg = NULL
)

plot_a_list(Elementdata_612, 7,2)


plot_a_list(Li_Ca_ratios_JCP, 7,2, ylim = c(0,.01), xlim = c(0,200))

# DSC standards code ####
Analysis_DSC <- list()
Calculations_DSC <- list()
Elementdata_DSC <- list()
Li_Ca_ratios_DSC <- list()

for (j in 1:length(Runs_DSC)) {
  
nc<-wes_palette(length(names(Runs_DSC[[j]][2:11])), name="Darjeeling1", type="continuous")
datapoints <- ggplot(data = Runs_DSC[[j]], aes(x = `Time [Sec]`)) 

for (a in 2:11) {
  datapoints <- datapoints + geom_line(aes_string(y = names(Runs_JCP[[j]])[a], color =  shQuote(names(Runs_JCP[[j]])[a])))
}

if (names(Runs_DSC[[j]][7]) != "Ca43") {stop(paste0("Wrong element! ", names(Runs_DSC[[j]][7]), " for Runs_DSC_", j))} # Ca43

Time_length <- length(Runs_DSC[[j]]$`Time [Sec]`)

Delta_Ca_dataframe <- data.frame(Delta_Ca = as.numeric(rep(NA, Time_length+14)),
                                 Time = c(Runs_DSC[[j]]$`Time [Sec]`,rep(NA,14))
                                  )

# Rolling 4 step difference
for(x in 1:length(Runs_DSC[[j]]$`Time [Sec]`)) {
Delta_Ca <- (Runs_DSC[[j]]$Ca43[x+3] - Runs_DSC[[j]]$Ca43[x])/(Runs_DSC[[j]]$`Time [Sec]`[x+3] - Runs_DSC[[j]]$`Time [Sec]`[x])
  Delta_Ca_dataframe$Delta_Ca[x+3]  <- ceiling(Delta_Ca)
  Delta_Ca_dataframe
}

Cut_off1 <- max(Delta_Ca_dataframe[which(Delta_Ca_dataframe$Time <= 50),]$Delta_Ca, na.rm = T)
# In case there is a jump in the calcium at the exterior of the coral (due to calcification boundary)
Cut_off2 <- min(Delta_Ca_dataframe[which(Delta_Ca_dataframe$Time >= max(Delta_Ca_dataframe$Time, na.rm = T)/2),]$Delta_Ca, na.rm = T)
Pre_blank_cut_off <- Delta_Ca_dataframe[which(Delta_Ca_dataframe$Delta_Ca == Cut_off1),]$Time
Post_blank_cut_off <- Delta_Ca_dataframe[which(Delta_Ca_dataframe$Delta_Ca == Cut_off2),]$Time

datapoints_graph <- datapoints + 
  geom_vline(xintercept = 0) +
  geom_vline(xintercept = 30.5) + # preblank cut off
  geom_vline(xintercept = max(Runs_DSC[[j]]$`Time [Sec]`, na.rm = T)) +
  geom_vline(xintercept = max(Runs_DSC[[j]]$`Time [Sec]`, na.rm = T)-45) + #postblank cut off
  geom_vline(xintercept = Pre_blank_cut_off, linetype = 2) + # start of analysis
  geom_vline(xintercept = Post_blank_cut_off-2, linetype = 2) + # end of analysis
  scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
                labels = trans_format("log10", math_format(10^.x))) +
  annotation_logticks(sides = "l") +
  annotate("text", x = 100, y = 100, hjust = 1, vjust = 2, label = names(Runs_DSC[j]), col = "black") +
  ylab("Signal") +
  scale_fill_discrete(name = "Element") +
  theme_classic()

assign(paste0(names(Runs_DSC[j]), "_Elementsignals"), datapoints_graph)
Elementdata_DSC[[paste0(names(Runs_DSC[j]), "_Elementsignals")]] <- datapoints_graph

Preblank <- Runs_DSC[[j]] %>%
  filter(`Time [Sec]` <= 30.5) %>%
  mutate( across(all_of(c(2:11)), ~ ., .names = "{col}_preblank"))

Postblank <- Runs_DSC[[j]] %>%
  filter(`Time [Sec]` >= max(`Time [Sec]`, na.rm = T)-45) %>%
  mutate(across(all_of(c(2:11)), ~ ., .names = "{col}_postblank"))

Allblanks <- full_join(Preblank, Postblank)

Analysis <- Runs_DSC[[j]] %>%
  filter(`Time [Sec]` >= Pre_blank_cut_off & `Time [Sec]` <= Post_blank_cut_off) %>% 
  mutate(across(all_of(c(2:11)), ~ ., .names = "{col}_analysis"))

Analysis_full <- full_join(full_join(Allblanks, Analysis), Runs_DSC[[j]])
Analysis_full <- Analysis_full[order(Analysis_full$`Time [Sec]`),]
row.names(Analysis_full) <- NULL

Data_averages <- Analysis_full %>%
  summarise(across(all_of(c(12:41)), 
                   ~c(sum(!is.na(.x)),
                      mean(.x, na.rm = T), 
                   (sd(.x, na.rm = T)*2),
                   (sd(.x, na.rm = T)*2)/(mean(.x, na.rm = T))*100,
                   (sd(.x, na.rm = T)*3),
                   ((sd(.x, na.rm = T)*2)/sqrt(((sum(!is.na(.x)))-1))),
                   (((sd(.x, na.rm = T)*2)/sqrt(((sum(!is.na(.x)))-1))))/(mean(.x, na.rm = T))*100
                   )
                   )
            ) %>%
    add_column(Calculation = c("n", "mean", "2sd","2sd %","3sd", "2se", "2se%"), .before = "Li7_preblank")

cutoffs_table <- data.frame()

for(i in 12:ncol(Analysis_full)) {
 cutoffs <- Analysis_full[i] %>%
  filter(Analysis_full[i] < (mean(Analysis_full[[i]], na.rm = T) + (sd(Analysis_full[[i]], na.rm = T)*2)) &
           Analysis_full[i] > (mean(Analysis_full[[i]], na.rm = T) - (sd(Analysis_full[[i]], na.rm = T)*2)))
 meancutoffs <- mean(cutoffs[,1])
 print(meancutoffs)
 meancutoffs_data <- data.frame(variable = colnames(Analysis_full[i]),
                                mean2sd = meancutoffs)
 colnames(meancutoffs_data) <- c("variable", "mean2sd")
 cutoffs_table <- rbind(cutoffs_table, meancutoffs_data)
}

cutoffs_table <- cutoffs_table %>%
  rotate_df(rn = "Calculation", cn = T)

Data_averages_V2 <- full_join(cutoffs_table, Data_averages)

# starting the blank correction
Blankcorrections <- Analysis_full %>%
  dplyr::select(1,32:41) %>%
  mutate(
    Li7_analysis_blankcorrected = (Li7_analysis-(mean(Data_averages_V2$Li7_preblank[3],Data_averages_V2$Li7_postblank[3]))),
    B11_analysis_blankcorrected = (B11_analysis-(mean(Data_averages_V2$B11_preblank[3],Data_averages_V2$B11_postblank[3]))),
    Mg24_analysis_blankcorrected = (Mg24_analysis-(mean(Data_averages_V2$Mg24_preblank[3],Data_averages_V2$Mg24_postblank[3]))),
    P31_analysis_blankcorrected = (P31_analysis-(mean(Data_averages_V2$P31_preblank[3],Data_averages_V2$P31_postblank[3]))),
    S34_analysis_blankcorrected = (S34_analysis-(mean(Data_averages_V2$S34_preblank[3],Data_averages_V2$S34_postblank[3]))),
    Ca43_analysis_blankcorrected = (Ca43_analysis-(mean(Data_averages_V2$Ca43_preblank[3],Data_averages_V2$Ca43_postblank[3]))),
    Mn55_analysis_blankcorrected = (Mn55_analysis-(mean(Data_averages_V2$Mn55_preblank[3],Data_averages_V2$Mn55_postblank[3]))),
    Sr86_analysis_blankcorrected = (Sr86_analysis-(mean(Data_averages_V2$Sr86_preblank[3],Data_averages_V2$Sr86_postblank[3]))),
    Ba137_analysis_blankcorrected = (Ba137_analysis-(mean(Data_averages_V2$Ba137_preblank[3],Data_averages_V2$Ba137_postblank[3]))),
    U238_analysis_blankcorrected = (U238_analysis-(mean(Data_averages_V2$U238_preblank[3],Data_averages_V2$U238_postblank[3]))),
  )

Blankcorrections_ratios <- Blankcorrections %>%
  mutate(
    Li_Ca = Li7_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    B_Ca = B11_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    Mg_Ca = Mg24_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    P_Ca = P31_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    S_Ca = S34_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    Mn_Ca = Mn55_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    Sr_Ca = Sr86_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    Ba_Ca = Ba137_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    U_Ca = U238_analysis_blankcorrected/Ca43_analysis_blankcorrected
  )


Li_Ca <- ggplot() +
  geom_point(aes_(Blankcorrections_ratios$`Time [Sec]`,Blankcorrections_ratios$Li_Ca)) + 
  annotate("text", x = Inf, y = Inf, hjust = 1, vjust = 2, label = "Blank corrected", col = "red") +
  annotate("text", x = -Inf, y = Inf, hjust = -.25, vjust = 2, label = names(Runs_DSC[j]), col = "black") +
  lims(y =c (0,0.0005))

assign(paste0(names(Runs_DSC[j]), "_Li/Ca ratio"), Li_Ca)
Li_Ca_ratios_DSC[[paste0(names(Runs_DSC[j]), "_Li/Ca ratio")]] <- Li_Ca

Analysis_full_blankcorrections_ratios <- full_join(Analysis_full, Blankcorrections_ratios)
assign(paste0(names(Runs_DSC[j]), "_Analysis table"), Analysis_full_blankcorrections_ratios)
Analysis_DSC[[paste0(names(Runs_DSC[j]), "_Analysis table")]] <- Analysis_full_blankcorrections_ratios

Data_averages <- Analysis_full_blankcorrections_ratios %>%
  summarise(across(all_of(c(12:60)), 
                   ~c(sum(!is.na(.x)),
                      mean(.x, na.rm = T), 
                   (sd(.x, na.rm = T)*2),
                   (sd(.x, na.rm = T)*2)/(mean(.x, na.rm = T))*100,
                   (sd(.x, na.rm = T)*3),
                   ((sd(.x, na.rm = T)*2)/sqrt(((sum(!is.na(.x)))-1))),
                   (((sd(.x, na.rm = T)*2)/sqrt(((sum(!is.na(.x)))-1))))/(mean(.x, na.rm = T))*100
                   )
                   )
            ) %>%
    add_column(Calculation = c("n", "mean", "2sd","2sd %","3sd", "2se", "2se%"), .before = "Li7_preblank")

cutoffs_table <- data.frame()

for(i in 12:ncol(Analysis_full_blankcorrections_ratios)) {
 cutoffs <- Analysis_full_blankcorrections_ratios[i] %>%
  filter(Analysis_full_blankcorrections_ratios[i] < (mean(Analysis_full_blankcorrections_ratios[[i]], na.rm = T) + (sd(Analysis_full_blankcorrections_ratios[[i]], na.rm = T)*2)) &
           Analysis_full_blankcorrections_ratios[i] > (mean(Analysis_full_blankcorrections_ratios[[i]], na.rm = T) - (sd(Analysis_full_blankcorrections_ratios[[i]], na.rm = T)*2)))
 meancutoffs <- mean(cutoffs[,1])
 print(meancutoffs)
 meancutoffs_data <- data.frame(variable = colnames(Analysis_full_blankcorrections_ratios[i]),
                                mean2sd = meancutoffs)
 colnames(meancutoffs_data) <- c("variable", "mean2sd")
 cutoffs_table <- rbind(cutoffs_table, meancutoffs_data)
}

cutoffs_table <- cutoffs_table %>%
  rotate_df(rn = "Calculation", cn = T)

Data_averages_V2 <- full_join(cutoffs_table, Data_averages)
assign(paste0(names(Runs_DSC[j]), "_Calculations"), Data_averages_V2)
Calculations_DSC[[paste0(names(Runs_DSC[j]), "_Calculations")]] <- Data_averages_V2

}

plot_a_list(Elementdata_DSC, 6,2)

ggsave(
  "DSC_Element_Signals.tiff",
  plot = last_plot(),
  device = "tiff",
  path = Signals_graph_folder,
  scale = 1,
  width = 30,
  height = 40,
  units = "cm",
  dpi = 300,
  bg = NULL
)

plot_a_list(Li_Ca_ratios_DSC, 7,2, ylim = c(0,.005), xlim = c(0,200))

# Samples code - first sample (23-16_1) ####
Analysis_Sample_23_16_1 <- list()
Calculations_Sample_23_16_1 <- list()
Elementdata_Sample_23_16_1 <- list()
Li_Ca_ratios_Sample_23_16_1 <- list()
j <- 1
for (j in 1:length(Runs_Sample_23_16_1)) {
  
nc<-wes_palette(length(names(Runs_Sample_23_16_1[[j]][2:11])), name="Darjeeling1", type="continuous")
datapoints <- ggplot(data = Runs_Sample_23_16_1[[j]], aes(x = `Time [Sec]`)) 

for (a in 2:11) {
  datapoints <- datapoints + geom_line(aes_string(y = names(Runs_Sample_23_16_1[[j]])[a], color =  shQuote(names(Runs_Sample_23_16_1[[j]])[a])))
}

if (names(Runs_Sample_23_16_1[[j]][7]) != "Ca43") {stop(paste0("Wrong element! ", names(Runs_Sample_23_16_1[[j]][7]), " for Runs_Sample_23_16_1_", j))} # Ca43

Time_length <- length(Runs_Sample_23_16_1[[j]]$`Time [Sec]`)

Delta_Ca_dataframe <- data.frame(Delta_Ca = as.numeric(rep(NA, Time_length+14)),
                                 Time = c(Runs_Sample_23_16_1[[j]]$`Time [Sec]`,rep(NA,14))
                                  )

# Rolling 4 step difference
for(x in 1:length(Runs_Sample_23_16_1[[j]]$`Time [Sec]`)) {
Delta_Ca <- (Runs_Sample_23_16_1[[j]]$Ca43[x+3] - Runs_Sample_23_16_1[[j]]$Ca43[x])/(Runs_Sample_23_16_1[[j]]$`Time [Sec]`[x+3] - Runs_Sample_23_16_1[[j]]$`Time [Sec]`[x])
  Delta_Ca_dataframe$Delta_Ca[x+3]  <- ceiling(Delta_Ca)
  Delta_Ca_dataframe
}

Cut_off1 <- max(Delta_Ca_dataframe[which(Delta_Ca_dataframe$Time <= 50),]$Delta_Ca, na.rm = T)
# In case there is a jump in the calcium at the exterior of the coral (due to calcification boundary)
Cut_off2 <- min(Delta_Ca_dataframe[which(Delta_Ca_dataframe$Time >= max(Delta_Ca_dataframe$Time, na.rm = T)/2),]$Delta_Ca, na.rm = T)
Pre_blank_cut_off <- Delta_Ca_dataframe[which(Delta_Ca_dataframe$Delta_Ca == Cut_off1),]$Time
Post_blank_cut_off <- Delta_Ca_dataframe[which(Delta_Ca_dataframe$Delta_Ca == Cut_off2),]$Time

datapoints_graph <- datapoints + 
  geom_vline(xintercept = 0) +
  geom_vline(xintercept = 30.5) + # preblank cut off
  geom_vline(xintercept = max(Runs_Sample_23_16_1[[j]]$`Time [Sec]`, na.rm = T)) +
  geom_vline(xintercept = max(Runs_Sample_23_16_1[[j]]$`Time [Sec]`, na.rm = T)-45) + #postblank cut off
  geom_vline(xintercept = Pre_blank_cut_off, linetype = 2) + # start of analysis
  geom_vline(xintercept = Post_blank_cut_off-2, linetype = 2) + # end of analysis
  scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
                labels = trans_format("log10", math_format(10^.x))) +
  annotation_logticks(sides = "l") +
  annotate("text", x = 100, y = 100, hjust = 1, vjust = 2, label = names(Runs_Sample_23_16_1[j]), col = "black") +
  ylab("Signal") +
  scale_fill_discrete(name = "Element") +
  theme_classic()

assign(paste0(names(Runs_Sample_23_16_1[j]), "_Elementsignals"), datapoints_graph)
Elementdata_Sample_23_16_1[[paste0(names(Runs_Sample_23_16_1[j]), "_Elementsignals")]] <- datapoints_graph

Preblank <- Runs_Sample_23_16_1[[j]] %>%
  filter(`Time [Sec]` <= 30.5) %>%
  mutate( across(all_of(c(2:11)), ~ ., .names = "{col}_preblank"))

Postblank <- Runs_Sample_23_16_1[[j]] %>%
  filter(`Time [Sec]` >= max(`Time [Sec]`, na.rm = T)-45) %>%
  mutate(across(all_of(c(2:11)), ~ ., .names = "{col}_postblank"))

Allblanks <- full_join(Preblank, Postblank)

Analysis <- Runs_Sample_23_16_1[[j]] %>%
  filter(`Time [Sec]` >= Pre_blank_cut_off & `Time [Sec]` <= Post_blank_cut_off) %>% 
  mutate(across(all_of(c(2:11)), ~ ., .names = "{col}_analysis"))

Analysis_full <- full_join(full_join(Allblanks, Analysis), Runs_Sample_23_16_1[[j]])
Analysis_full <- Analysis_full[order(Analysis_full$`Time [Sec]`),]
row.names(Analysis_full) <- NULL

Data_averages <- Analysis_full %>%
  summarise(across(all_of(c(12:41)), 
                   ~c(sum(!is.na(.x)),
                      mean(.x, na.rm = T), 
                   (sd(.x, na.rm = T)*2),
                   (sd(.x, na.rm = T)*2)/(mean(.x, na.rm = T))*100,
                   (sd(.x, na.rm = T)*3),
                   ((sd(.x, na.rm = T)*2)/sqrt(((sum(!is.na(.x)))-1))),
                   (((sd(.x, na.rm = T)*2)/sqrt(((sum(!is.na(.x)))-1))))/(mean(.x, na.rm = T))*100
                   )
                   )
            ) %>%
    add_column(Calculation = c("n", "mean", "2sd","2sd %","3sd", "2se", "2se%"), .before = "Li7_preblank")

cutoffs_table <- data.frame()

for(i in 12:ncol(Analysis_full)) {
 cutoffs <- Analysis_full[i] %>%
  filter(Analysis_full[i] < (mean(Analysis_full[[i]], na.rm = T) + (sd(Analysis_full[[i]], na.rm = T)*2)) &
           Analysis_full[i] > (mean(Analysis_full[[i]], na.rm = T) - (sd(Analysis_full[[i]], na.rm = T)*2)))
 meancutoffs <- mean(cutoffs[,1])
 print(meancutoffs)
 meancutoffs_data <- data.frame(variable = colnames(Analysis_full[i]),
                                mean2sd = meancutoffs)
 colnames(meancutoffs_data) <- c("variable", "mean2sd")
 cutoffs_table <- rbind(cutoffs_table, meancutoffs_data)
}

cutoffs_table <- cutoffs_table %>%
  rotate_df(rn = "Calculation", cn = T)

Data_averages_V2 <- full_join(cutoffs_table, Data_averages)

# starting the blank correction
Blankcorrections <- Analysis_full %>%
  dplyr::select(1,32:41) %>%
  mutate(
    Li7_analysis_blankcorrected = (Li7_analysis-(mean(Data_averages_V2$Li7_preblank[3],Data_averages_V2$Li7_postblank[3]))),
    B11_analysis_blankcorrected = (B11_analysis-(mean(Data_averages_V2$B11_preblank[3],Data_averages_V2$B11_postblank[3]))),
    Mg24_analysis_blankcorrected = (Mg24_analysis-(mean(Data_averages_V2$Mg24_preblank[3],Data_averages_V2$Mg24_postblank[3]))),
    P31_analysis_blankcorrected = (P31_analysis-(mean(Data_averages_V2$P31_preblank[3],Data_averages_V2$P31_postblank[3]))),
    S34_analysis_blankcorrected = (S34_analysis-(mean(Data_averages_V2$S34_preblank[3],Data_averages_V2$S34_postblank[3]))),
    Ca43_analysis_blankcorrected = (Ca43_analysis-(mean(Data_averages_V2$Ca43_preblank[3],Data_averages_V2$Ca43_postblank[3]))),
    Mn55_analysis_blankcorrected = (Mn55_analysis-(mean(Data_averages_V2$Mn55_preblank[3],Data_averages_V2$Mn55_postblank[3]))),
    Sr86_analysis_blankcorrected = (Sr86_analysis-(mean(Data_averages_V2$Sr86_preblank[3],Data_averages_V2$Sr86_postblank[3]))),
    Ba137_analysis_blankcorrected = (Ba137_analysis-(mean(Data_averages_V2$Ba137_preblank[3],Data_averages_V2$Ba137_postblank[3]))),
    U238_analysis_blankcorrected = (U238_analysis-(mean(Data_averages_V2$U238_preblank[3],Data_averages_V2$U238_postblank[3]))),
  )

Blankcorrections_ratios <- Blankcorrections %>%
  mutate(
    Li_Ca = Li7_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    B_Ca = B11_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    Mg_Ca = Mg24_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    P_Ca = P31_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    S_Ca = S34_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    Mn_Ca = Mn55_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    Sr_Ca = Sr86_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    Ba_Ca = Ba137_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    U_Ca = U238_analysis_blankcorrected/Ca43_analysis_blankcorrected
  )


Li_Ca <- ggplot() +
  geom_point(aes_(Blankcorrections_ratios$`Time [Sec]`,Blankcorrections_ratios$Li_Ca)) + 
  annotate("text", x = Inf, y = Inf, hjust = 1, vjust = 2, label = "Blank corrected", col = "red") +
  annotate("text", x = -Inf, y = Inf, hjust = -.25, vjust = 2, label = names(Runs_Sample_23_16_1[j]), col = "black") +
  lims(y =c (0,0.0005))

assign(paste0(names(Runs_Sample_23_16_1[j]), "_Li/Ca ratio"), Li_Ca)
Li_Ca_ratios_Sample_23_16_1[[paste0(names(Runs_Sample_23_16_1[j]), "_Li/Ca ratio")]] <- Li_Ca

Analysis_full_blankcorrections_ratios <- full_join(Analysis_full, Blankcorrections_ratios)
assign(paste0(names(Runs_Sample_23_16_1[j]), "_Analysis table"), Analysis_full_blankcorrections_ratios)
Analysis_Sample_23_16_1[[paste0(names(Runs_Sample_23_16_1[j]), "_Analysis table")]] <- Analysis_full_blankcorrections_ratios

Data_averages <- Analysis_full_blankcorrections_ratios %>%
  summarise(across(all_of(c(12:60)), 
                   ~c(sum(!is.na(.x)),
                      mean(.x, na.rm = T), 
                   (sd(.x, na.rm = T)*2),
                   (sd(.x, na.rm = T)*2)/(mean(.x, na.rm = T))*100,
                   (sd(.x, na.rm = T)*3),
                   ((sd(.x, na.rm = T)*2)/sqrt(((sum(!is.na(.x)))-1))),
                   (((sd(.x, na.rm = T)*2)/sqrt(((sum(!is.na(.x)))-1))))/(mean(.x, na.rm = T))*100
                   )
                   )
            ) %>%
    add_column(Calculation = c("n", "mean", "2sd","2sd %","3sd", "2se", "2se%"), .before = "Li7_preblank")

cutoffs_table <- data.frame()

for(i in 12:ncol(Analysis_full_blankcorrections_ratios)) {
 cutoffs <- Analysis_full_blankcorrections_ratios[i] %>%
  filter(Analysis_full_blankcorrections_ratios[i] < (mean(Analysis_full_blankcorrections_ratios[[i]], na.rm = T) + (sd(Analysis_full_blankcorrections_ratios[[i]], na.rm = T)*2)) &
           Analysis_full_blankcorrections_ratios[i] > (mean(Analysis_full_blankcorrections_ratios[[i]], na.rm = T) - (sd(Analysis_full_blankcorrections_ratios[[i]], na.rm = T)*2)))
 meancutoffs <- mean(cutoffs[,1])
 print(meancutoffs)
 meancutoffs_data <- data.frame(variable = colnames(Analysis_full_blankcorrections_ratios[i]),
                                mean2sd = meancutoffs)
 colnames(meancutoffs_data) <- c("variable", "mean2sd")
 cutoffs_table <- rbind(cutoffs_table, meancutoffs_data)
}

cutoffs_table <- cutoffs_table %>%
  rotate_df(rn = "Calculation", cn = T)

Data_averages_V2 <- full_join(cutoffs_table, Data_averages)
assign(paste0(names(Runs_Sample_23_16_1[j]), "_Calculations"), Data_averages_V2)
Calculations_Sample_23_16_1[[paste0(names(Runs_Sample_23_16_1[j]), "_Calculations")]] <- Data_averages_V2

}

plot_a_list(Elementdata_Sample_23_16_1, 2,3)

ggsave(
  "Sample_23_16_1_Element_Signals.tiff",
  plot = last_plot(),
  device = "tiff",
  path = Signals_graph_folder,
  scale = 1,
  width = 50,
  height = 20,
  units = "cm",
  dpi = 300,
  bg = NULL
)

# Samples code - first sample (23-16_2) ####
Analysis_Sample_23_16_2 <- list()
Calculations_Sample_23_16_2 <- list()
Elementdata_Sample_23_16_2 <- list()
Li_Ca_ratios_Sample_23_16_2 <- list()
j <- 1
for (j in 1:length(Runs_Sample_23_16_2)) {
  
nc<-wes_palette(length(names(Runs_Sample_23_16_2[[j]][2:11])), name="Darjeeling1", type="continuous")
datapoints <- ggplot(data = Runs_Sample_23_16_2[[j]], aes(x = `Time [Sec]`)) 

for (a in 2:11) {
  datapoints <- datapoints + geom_line(aes_string(y = names(Runs_JCP[[j]])[a], color =  shQuote(names(Runs_JCP[[j]])[a])))
}

if (names(Runs_Sample_23_16_2[[j]][7]) != "Ca43") {stop(paste0("Wrong element! ", names(Runs_Sample_23_16_2[[j]][7]), " for Runs_Sample_23_16_2_", j))} # Ca43

Time_length <- length(Runs_Sample_23_16_2[[j]]$`Time [Sec]`)

Delta_Ca_dataframe <- data.frame(Delta_Ca = as.numeric(rep(NA, Time_length+14)),
                                 Time = c(Runs_Sample_23_16_2[[j]]$`Time [Sec]`,rep(NA,14))
                                  )

# Rolling 4 step difference
for(x in 1:length(Runs_Sample_23_16_2[[j]]$`Time [Sec]`)) {
Delta_Ca <- (Runs_Sample_23_16_2[[j]]$Ca43[x+3] - Runs_Sample_23_16_2[[j]]$Ca43[x])/(Runs_Sample_23_16_2[[j]]$`Time [Sec]`[x+3] - Runs_Sample_23_16_2[[j]]$`Time [Sec]`[x])
  Delta_Ca_dataframe$Delta_Ca[x+3]  <- ceiling(Delta_Ca)
  Delta_Ca_dataframe
}

Cut_off1 <- max(Delta_Ca_dataframe[which(Delta_Ca_dataframe$Time <= 50),]$Delta_Ca, na.rm = T)
# In case there is a jump in the calcium at the exterior of the coral (due to calcification boundary)
Cut_off2 <- min(Delta_Ca_dataframe[which(Delta_Ca_dataframe$Time >= max(Delta_Ca_dataframe$Time, na.rm = T)/2),]$Delta_Ca, na.rm = T)
Pre_blank_cut_off <- Delta_Ca_dataframe[which(Delta_Ca_dataframe$Delta_Ca == Cut_off1),]$Time
Post_blank_cut_off <- Delta_Ca_dataframe[which(Delta_Ca_dataframe$Delta_Ca == Cut_off2),]$Time

datapoints_graph <- datapoints + 
  geom_vline(xintercept = 0) +
  geom_vline(xintercept = 30.5) + # preblank cut off
  geom_vline(xintercept = max(Runs_Sample_23_16_2[[j]]$`Time [Sec]`, na.rm = T)) +
  geom_vline(xintercept = max(Runs_Sample_23_16_2[[j]]$`Time [Sec]`, na.rm = T)-45) + #postblank cut off
  geom_vline(xintercept = Pre_blank_cut_off, linetype = 2) + # start of analysis
  geom_vline(xintercept = Post_blank_cut_off-2, linetype = 2) + # end of analysis
  scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
                labels = trans_format("log10", math_format(10^.x))) +
  annotation_logticks(sides = "l") +
  annotate("text", x = 100, y = 100, hjust = 1, vjust = 2, label = names(Runs_Sample_23_16_2[j]), col = "black") +
  ylab("Signal") +
  scale_fill_discrete(name = "Element") +
  theme_classic()

assign(paste0(names(Runs_Sample_23_16_2[j]), "_Elementsignals"), datapoints_graph)
Elementdata_Sample_23_16_2[[paste0(names(Runs_Sample_23_16_2[j]), "_Elementsignals")]] <- datapoints_graph

Preblank <- Runs_Sample_23_16_2[[j]] %>%
  filter(`Time [Sec]` <= 30.5) %>%
  mutate( across(all_of(c(2:11)), ~ ., .names = "{col}_preblank"))

Postblank <- Runs_Sample_23_16_2[[j]] %>%
  filter(`Time [Sec]` >= max(`Time [Sec]`, na.rm = T)-45) %>%
  mutate(across(all_of(c(2:11)), ~ ., .names = "{col}_postblank"))

Allblanks <- full_join(Preblank, Postblank)

Analysis <- Runs_Sample_23_16_2[[j]] %>%
  filter(`Time [Sec]` >= Pre_blank_cut_off & `Time [Sec]` <= Post_blank_cut_off) %>% 
  mutate(across(all_of(c(2:11)), ~ ., .names = "{col}_analysis"))

Analysis_full <- full_join(full_join(Allblanks, Analysis), Runs_Sample_23_16_2[[j]])
Analysis_full <- Analysis_full[order(Analysis_full$`Time [Sec]`),]
row.names(Analysis_full) <- NULL

Data_averages <- Analysis_full %>%
  summarise(across(all_of(c(12:41)), 
                   ~c(sum(!is.na(.x)),
                      mean(.x, na.rm = T), 
                   (sd(.x, na.rm = T)*2),
                   (sd(.x, na.rm = T)*2)/(mean(.x, na.rm = T))*100,
                   (sd(.x, na.rm = T)*3),
                   ((sd(.x, na.rm = T)*2)/sqrt(((sum(!is.na(.x)))-1))),
                   (((sd(.x, na.rm = T)*2)/sqrt(((sum(!is.na(.x)))-1))))/(mean(.x, na.rm = T))*100
                   )
                   )
            ) %>%
    add_column(Calculation = c("n", "mean", "2sd","2sd %","3sd", "2se", "2se%"), .before = "Li7_preblank")

cutoffs_table <- data.frame()

for(i in 12:ncol(Analysis_full)) {
 cutoffs <- Analysis_full[i] %>%
  filter(Analysis_full[i] < (mean(Analysis_full[[i]], na.rm = T) + (sd(Analysis_full[[i]], na.rm = T)*2)) &
           Analysis_full[i] > (mean(Analysis_full[[i]], na.rm = T) - (sd(Analysis_full[[i]], na.rm = T)*2)))
 meancutoffs <- mean(cutoffs[,1])
 print(meancutoffs)
 meancutoffs_data <- data.frame(variable = colnames(Analysis_full[i]),
                                mean2sd = meancutoffs)
 colnames(meancutoffs_data) <- c("variable", "mean2sd")
 cutoffs_table <- rbind(cutoffs_table, meancutoffs_data)
}

cutoffs_table <- cutoffs_table %>%
  rotate_df(rn = "Calculation", cn = T)

Data_averages_V2 <- full_join(cutoffs_table, Data_averages)

# starting the blank correction
Blankcorrections <- Analysis_full %>%
  dplyr::select(1,32:41) %>%
  mutate(
    Li7_analysis_blankcorrected = (Li7_analysis-(mean(Data_averages_V2$Li7_preblank[3],Data_averages_V2$Li7_postblank[3]))),
    B11_analysis_blankcorrected = (B11_analysis-(mean(Data_averages_V2$B11_preblank[3],Data_averages_V2$B11_postblank[3]))),
    Mg24_analysis_blankcorrected = (Mg24_analysis-(mean(Data_averages_V2$Mg24_preblank[3],Data_averages_V2$Mg24_postblank[3]))),
    P31_analysis_blankcorrected = (P31_analysis-(mean(Data_averages_V2$P31_preblank[3],Data_averages_V2$P31_postblank[3]))),
    S34_analysis_blankcorrected = (S34_analysis-(mean(Data_averages_V2$S34_preblank[3],Data_averages_V2$S34_postblank[3]))),
    Ca43_analysis_blankcorrected = (Ca43_analysis-(mean(Data_averages_V2$Ca43_preblank[3],Data_averages_V2$Ca43_postblank[3]))),
    Mn55_analysis_blankcorrected = (Mn55_analysis-(mean(Data_averages_V2$Mn55_preblank[3],Data_averages_V2$Mn55_postblank[3]))),
    Sr86_analysis_blankcorrected = (Sr86_analysis-(mean(Data_averages_V2$Sr86_preblank[3],Data_averages_V2$Sr86_postblank[3]))),
    Ba137_analysis_blankcorrected = (Ba137_analysis-(mean(Data_averages_V2$Ba137_preblank[3],Data_averages_V2$Ba137_postblank[3]))),
    U238_analysis_blankcorrected = (U238_analysis-(mean(Data_averages_V2$U238_preblank[3],Data_averages_V2$U238_postblank[3]))),
  )

Blankcorrections_ratios <- Blankcorrections %>%
  mutate(
    Li_Ca = Li7_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    B_Ca = B11_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    Mg_Ca = Mg24_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    P_Ca = P31_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    S_Ca = S34_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    Mn_Ca = Mn55_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    Sr_Ca = Sr86_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    Ba_Ca = Ba137_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    U_Ca = U238_analysis_blankcorrected/Ca43_analysis_blankcorrected
  )


Li_Ca <- ggplot() +
  geom_point(aes_(Blankcorrections_ratios$`Time [Sec]`,Blankcorrections_ratios$Li_Ca)) + 
  annotate("text", x = Inf, y = Inf, hjust = 1, vjust = 2, label = "Blank corrected", col = "red") +
  annotate("text", x = -Inf, y = Inf, hjust = -.25, vjust = 2, label = names(Runs_Sample_23_16_2[j]), col = "black") +
  lims(y =c (0,0.0005))

assign(paste0(names(Runs_Sample_23_16_2[j]), "_Li/Ca ratio"), Li_Ca)
Li_Ca_ratios_Sample_23_16_2[[paste0(names(Runs_Sample_23_16_2[j]), "_Li/Ca ratio")]] <- Li_Ca

Analysis_full_blankcorrections_ratios <- full_join(Analysis_full, Blankcorrections_ratios)
assign(paste0(names(Runs_Sample_23_16_2[j]), "_Analysis table"), Analysis_full_blankcorrections_ratios)
Analysis_Sample_23_16_2[[paste0(names(Runs_Sample_23_16_2[j]), "_Analysis table")]] <- Analysis_full_blankcorrections_ratios

Data_averages <- Analysis_full_blankcorrections_ratios %>%
  summarise(across(all_of(c(12:60)), 
                   ~c(sum(!is.na(.x)),
                      mean(.x, na.rm = T), 
                   (sd(.x, na.rm = T)*2),
                   (sd(.x, na.rm = T)*2)/(mean(.x, na.rm = T))*100,
                   (sd(.x, na.rm = T)*3),
                   ((sd(.x, na.rm = T)*2)/sqrt(((sum(!is.na(.x)))-1))),
                   (((sd(.x, na.rm = T)*2)/sqrt(((sum(!is.na(.x)))-1))))/(mean(.x, na.rm = T))*100
                   )
                   )
            ) %>%
    add_column(Calculation = c("n", "mean", "2sd","2sd %","3sd", "2se", "2se%"), .before = "Li7_preblank")

cutoffs_table <- data.frame()

for(i in 12:ncol(Analysis_full_blankcorrections_ratios)) {
 cutoffs <- Analysis_full_blankcorrections_ratios[i] %>%
  filter(Analysis_full_blankcorrections_ratios[i] < (mean(Analysis_full_blankcorrections_ratios[[i]], na.rm = T) + (sd(Analysis_full_blankcorrections_ratios[[i]], na.rm = T)*2)) &
           Analysis_full_blankcorrections_ratios[i] > (mean(Analysis_full_blankcorrections_ratios[[i]], na.rm = T) - (sd(Analysis_full_blankcorrections_ratios[[i]], na.rm = T)*2)))
 meancutoffs <- mean(cutoffs[,1])
 print(meancutoffs)
 meancutoffs_data <- data.frame(variable = colnames(Analysis_full_blankcorrections_ratios[i]),
                                mean2sd = meancutoffs)
 colnames(meancutoffs_data) <- c("variable", "mean2sd")
 cutoffs_table <- rbind(cutoffs_table, meancutoffs_data)
}

cutoffs_table <- cutoffs_table %>%
  rotate_df(rn = "Calculation", cn = T)

Data_averages_V2 <- full_join(cutoffs_table, Data_averages)
assign(paste0(names(Runs_Sample_23_16_2[j]), "_Calculations"), Data_averages_V2)
Calculations_Sample_23_16_2[[paste0(names(Runs_Sample_23_16_2[j]), "_Calculations")]] <- Data_averages_V2

}

plot_a_list(Elementdata_Sample_23_16_2, 2,3)

ggsave(
  "Sample_23_16_2_Element_Signals.tiff",
  plot = last_plot(),
  device = "tiff",
  path = Signals_graph_folder,
  scale = 1,
  width = 50,
  height = 20,
  units = "cm",
  dpi = 300,
  bg = NULL
)

# Samples code - first sample (23-16_3) ####
Analysis_Sample_23_16_3 <- list()
Calculations_Sample_23_16_3 <- list()
Elementdata_Sample_23_16_3 <- list()
Li_Ca_ratios_Sample_23_16_3 <- list()
j <- 1
for (j in 1:length(Runs_Sample_23_16_3)) {

nc<-wes_palette(length(names(Runs_Sample_23_16_2[[j]][2:11])), name="Darjeeling1", type="continuous")
datapoints <- ggplot(data = Runs_Sample_23_16_3[[j]], aes(x = `Time [Sec]`)) 

for (a in 2:11) {
  datapoints <- datapoints + geom_line(aes_string(y = names(Runs_Sample_23_16_3[[j]])[a], color =  shQuote(names(Runs_Sample_23_16_3[[j]])[a])))
}

if (names(Runs_Sample_23_16_3[[j]][7]) != "Ca43") {stop(paste0("Wrong element! ", names(Runs_Sample_23_16_3[[j]][7]), " for Runs_Sample_23_16_3_", j))} # Ca43

Time_length <- length(Runs_Sample_23_16_3[[j]]$`Time [Sec]`)

Delta_Ca_dataframe <- data.frame(Delta_Ca = as.numeric(rep(NA, Time_length+14)),
                                 Time = c(Runs_Sample_23_16_3[[j]]$`Time [Sec]`,rep(NA,14))
                                  )

# Rolling 4 step difference
for(x in 1:length(Runs_Sample_23_16_3[[j]]$`Time [Sec]`)) {
Delta_Ca <- (Runs_Sample_23_16_3[[j]]$Ca43[x+3] - Runs_Sample_23_16_3[[j]]$Ca43[x])/(Runs_Sample_23_16_3[[j]]$`Time [Sec]`[x+3] - Runs_Sample_23_16_3[[j]]$`Time [Sec]`[x])
  Delta_Ca_dataframe$Delta_Ca[x+3]  <- ceiling(Delta_Ca)
  Delta_Ca_dataframe
}

Cut_off1 <- max(Delta_Ca_dataframe[which(Delta_Ca_dataframe$Time <= 50),]$Delta_Ca, na.rm = T)
# In case there is a jump in the calcium at the exterior of the coral (due to calcification boundary)
Cut_off2 <- min(Delta_Ca_dataframe[which(Delta_Ca_dataframe$Time >= max(Delta_Ca_dataframe$Time, na.rm = T)/2),]$Delta_Ca, na.rm = T)
Pre_blank_cut_off <- Delta_Ca_dataframe[which(Delta_Ca_dataframe$Delta_Ca == Cut_off1),]$Time
Post_blank_cut_off <- Delta_Ca_dataframe[which(Delta_Ca_dataframe$Delta_Ca == Cut_off2),]$Time

datapoints_graph <- datapoints + 
  geom_vline(xintercept = 0) +
  geom_vline(xintercept = 30.5) + # preblank cut off
  geom_vline(xintercept = max(Runs_Sample_23_16_3[[j]]$`Time [Sec]`, na.rm = T)) +
  geom_vline(xintercept = max(Runs_Sample_23_16_3[[j]]$`Time [Sec]`, na.rm = T)-45) + #postblank cut off
  geom_vline(xintercept = Pre_blank_cut_off, linetype = 2) + # start of analysis
  geom_vline(xintercept = Post_blank_cut_off-2, linetype = 2) + # end of analysis
  scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
                labels = trans_format("log10", math_format(10^.x))) +
  annotation_logticks(sides = "l") +
  annotate("text", x = 100, y = 100, hjust = 1, vjust = 2, label = names(Runs_Sample_23_16_3[j]), col = "black") +
  ylab("Signal") +
  scale_fill_discrete(name = "Element") +
  theme_classic()

assign(paste0(names(Runs_Sample_23_16_3[j]), "_Elementsignals"), datapoints_graph)
Elementdata_Sample_23_16_3[[paste0(names(Runs_Sample_23_16_3[j]), "_Elementsignals")]] <- datapoints_graph

Preblank <- Runs_Sample_23_16_3[[j]] %>%
  filter(`Time [Sec]` <= 30.5) %>%
  mutate( across(all_of(c(2:11)), ~ ., .names = "{col}_preblank"))

Postblank <- Runs_Sample_23_16_3[[j]] %>%
  filter(`Time [Sec]` >= max(`Time [Sec]`, na.rm = T)-45) %>%
  mutate(across(all_of(c(2:11)), ~ ., .names = "{col}_postblank"))

Allblanks <- full_join(Preblank, Postblank)

Analysis <- Runs_Sample_23_16_3[[j]] %>%
  filter(`Time [Sec]` >= Pre_blank_cut_off & `Time [Sec]` <= Post_blank_cut_off) %>% 
  mutate(across(all_of(c(2:11)), ~ ., .names = "{col}_analysis"))

Analysis_full <- full_join(full_join(Allblanks, Analysis), Runs_Sample_23_16_3[[j]])
Analysis_full <- Analysis_full[order(Analysis_full$`Time [Sec]`),]
row.names(Analysis_full) <- NULL

Data_averages <- Analysis_full %>%
  summarise(across(all_of(c(12:41)), 
                   ~c(sum(!is.na(.x)),
                      mean(.x, na.rm = T), 
                   (sd(.x, na.rm = T)*2),
                   (sd(.x, na.rm = T)*2)/(mean(.x, na.rm = T))*100,
                   (sd(.x, na.rm = T)*3),
                   ((sd(.x, na.rm = T)*2)/sqrt(((sum(!is.na(.x)))-1))),
                   (((sd(.x, na.rm = T)*2)/sqrt(((sum(!is.na(.x)))-1))))/(mean(.x, na.rm = T))*100
                   )
                   )
            ) %>%
    add_column(Calculation = c("n", "mean", "2sd","2sd %","3sd", "2se", "2se%"), .before = "Li7_preblank")

cutoffs_table <- data.frame()

for(i in 12:ncol(Analysis_full)) {
 cutoffs <- Analysis_full[i] %>%
  filter(Analysis_full[i] < (mean(Analysis_full[[i]], na.rm = T) + (sd(Analysis_full[[i]], na.rm = T)*2)) &
           Analysis_full[i] > (mean(Analysis_full[[i]], na.rm = T) - (sd(Analysis_full[[i]], na.rm = T)*2)))
 meancutoffs <- mean(cutoffs[,1])
 print(meancutoffs)
 meancutoffs_data <- data.frame(variable = colnames(Analysis_full[i]),
                                mean2sd = meancutoffs)
 colnames(meancutoffs_data) <- c("variable", "mean2sd")
 cutoffs_table <- rbind(cutoffs_table, meancutoffs_data)
}

cutoffs_table <- cutoffs_table %>%
  rotate_df(rn = "Calculation", cn = T)

Data_averages_V2 <- full_join(cutoffs_table, Data_averages)

# starting the blank correction
Blankcorrections <- Analysis_full %>%
  dplyr::select(1,32:41) %>%
  mutate(
    Li7_analysis_blankcorrected = (Li7_analysis-(mean(Data_averages_V2$Li7_preblank[3],Data_averages_V2$Li7_postblank[3]))),
    B11_analysis_blankcorrected = (B11_analysis-(mean(Data_averages_V2$B11_preblank[3],Data_averages_V2$B11_postblank[3]))),
    Mg24_analysis_blankcorrected = (Mg24_analysis-(mean(Data_averages_V2$Mg24_preblank[3],Data_averages_V2$Mg24_postblank[3]))),
    P31_analysis_blankcorrected = (P31_analysis-(mean(Data_averages_V2$P31_preblank[3],Data_averages_V2$P31_postblank[3]))),
    S34_analysis_blankcorrected = (S34_analysis-(mean(Data_averages_V2$S34_preblank[3],Data_averages_V2$S34_postblank[3]))),
    Ca43_analysis_blankcorrected = (Ca43_analysis-(mean(Data_averages_V2$Ca43_preblank[3],Data_averages_V2$Ca43_postblank[3]))),
    Mn55_analysis_blankcorrected = (Mn55_analysis-(mean(Data_averages_V2$Mn55_preblank[3],Data_averages_V2$Mn55_postblank[3]))),
    Sr86_analysis_blankcorrected = (Sr86_analysis-(mean(Data_averages_V2$Sr86_preblank[3],Data_averages_V2$Sr86_postblank[3]))),
    Ba137_analysis_blankcorrected = (Ba137_analysis-(mean(Data_averages_V2$Ba137_preblank[3],Data_averages_V2$Ba137_postblank[3]))),
    U238_analysis_blankcorrected = (U238_analysis-(mean(Data_averages_V2$U238_preblank[3],Data_averages_V2$U238_postblank[3]))),
  )

Blankcorrections_ratios <- Blankcorrections %>%
  mutate(
    Li_Ca = Li7_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    B_Ca = B11_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    Mg_Ca = Mg24_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    P_Ca = P31_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    S_Ca = S34_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    Mn_Ca = Mn55_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    Sr_Ca = Sr86_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    Ba_Ca = Ba137_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    U_Ca = U238_analysis_blankcorrected/Ca43_analysis_blankcorrected
  )


Li_Ca <- ggplot() +
  geom_point(aes_(Blankcorrections_ratios$`Time [Sec]`,Blankcorrections_ratios$Li_Ca)) + 
  annotate("text", x = Inf, y = Inf, hjust = 1, vjust = 2, label = "Blank corrected", col = "red") +
  annotate("text", x = -Inf, y = Inf, hjust = -.25, vjust = 2, label = names(Runs_Sample_23_16_3[j]), col = "black") +
  lims(y =c (0,0.0005))

assign(paste0(names(Runs_Sample_23_16_3[j]), "_Li/Ca ratio"), Li_Ca)
Li_Ca_ratios_Sample_23_16_3[[paste0(names(Runs_Sample_23_16_3[j]), "_Li/Ca ratio")]] <- Li_Ca

Analysis_full_blankcorrections_ratios <- full_join(Analysis_full, Blankcorrections_ratios)
assign(paste0(names(Runs_Sample_23_16_3[j]), "_Analysis table"), Analysis_full_blankcorrections_ratios)
Analysis_Sample_23_16_3[[paste0(names(Runs_Sample_23_16_3[j]), "_Analysis table")]] <- Analysis_full_blankcorrections_ratios

Data_averages <- Analysis_full_blankcorrections_ratios %>%
  summarise(across(all_of(c(12:60)), 
                   ~c(sum(!is.na(.x)),
                      mean(.x, na.rm = T), 
                   (sd(.x, na.rm = T)*2),
                   (sd(.x, na.rm = T)*2)/(mean(.x, na.rm = T))*100,
                   (sd(.x, na.rm = T)*3),
                   ((sd(.x, na.rm = T)*2)/sqrt(((sum(!is.na(.x)))-1))),
                   (((sd(.x, na.rm = T)*2)/sqrt(((sum(!is.na(.x)))-1))))/(mean(.x, na.rm = T))*100
                   )
                   )
            ) %>%
    add_column(Calculation = c("n", "mean", "2sd","2sd %","3sd", "2se", "2se%"), .before = "Li7_preblank")

cutoffs_table <- data.frame()

for(i in 12:ncol(Analysis_full_blankcorrections_ratios)) {
 cutoffs <- Analysis_full_blankcorrections_ratios[i] %>%
  filter(Analysis_full_blankcorrections_ratios[i] < (mean(Analysis_full_blankcorrections_ratios[[i]], na.rm = T) + (sd(Analysis_full_blankcorrections_ratios[[i]], na.rm = T)*2)) &
           Analysis_full_blankcorrections_ratios[i] > (mean(Analysis_full_blankcorrections_ratios[[i]], na.rm = T) - (sd(Analysis_full_blankcorrections_ratios[[i]], na.rm = T)*2)))
 meancutoffs <- mean(cutoffs[,1])
 print(meancutoffs)
 meancutoffs_data <- data.frame(variable = colnames(Analysis_full_blankcorrections_ratios[i]),
                                mean2sd = meancutoffs)
 colnames(meancutoffs_data) <- c("variable", "mean2sd")
 cutoffs_table <- rbind(cutoffs_table, meancutoffs_data)
}

cutoffs_table <- cutoffs_table %>%
  rotate_df(rn = "Calculation", cn = T)

Data_averages_V2 <- full_join(cutoffs_table, Data_averages)
assign(paste0(names(Runs_Sample_23_16_3[j]), "_Calculations"), Data_averages_V2)
Calculations_Sample_23_16_3[[paste0(names(Runs_Sample_23_16_3[j]), "_Calculations")]] <- Data_averages_V2

}

plot_a_list(Elementdata_Sample_23_16_3, 2,3)

ggsave(
  "Sample_23_16_3_Element_Signals.tiff",
  plot = last_plot(),
  device = "tiff",
  path = Signals_graph_folder,
  scale = 1,
  width = 50,
  height = 20,
  units = "cm",
  dpi = 300,
  bg = NULL
)

plot_a_list(Li_Ca_ratios_Sample_23_16_3, 5,1, ylim = c(0,.005), xlim = c(0,200))

# Samples code - first sample (23-1_1) ####
Analysis_Sample_23_1_1 <- list()
Calculations_Sample_23_1_1 <- list()
Elementdata_Sample_23_1_1 <- list()
Li_Ca_ratios_Sample_23_1_1 <- list()
j <- 1
for (j in 1:length(Runs_Sample_23_1_1)) {
  
nc<-wes_palette(length(names(Runs_Sample_23_1_1[[j]][2:11])), name="Darjeeling1", type="continuous")
datapoints <- ggplot(data = Runs_Sample_23_1_1[[j]], aes(x = `Time [Sec]`)) 

for (a in 2:11) {
  datapoints <- datapoints + geom_line(aes_string(y = names(Runs_Sample_23_1_1[[j]])[a], color =  shQuote(names(Runs_Sample_23_1_1[[j]])[a])))
}

if (names(Runs_Sample_23_1_1[[j]][7]) != "Ca43") {stop(paste0("Wrong element! ", names(Runs_Sample_23_1_1[[j]][7]), " for Runs_Sample_23_1_1_", j))} # Ca43

Time_length <- length(Runs_Sample_23_1_1[[j]]$`Time [Sec]`)

Delta_Ca_dataframe <- data.frame(Delta_Ca = as.numeric(rep(NA, Time_length+14)),
                                 Time = c(Runs_Sample_23_1_1[[j]]$`Time [Sec]`,rep(NA,14))
                                  )

# Rolling 4 step difference
for(x in 1:length(Runs_Sample_23_1_1[[j]]$`Time [Sec]`)) {
Delta_Ca <- (Runs_Sample_23_1_1[[j]]$Ca43[x+3] - Runs_Sample_23_1_1[[j]]$Ca43[x])/(Runs_Sample_23_1_1[[j]]$`Time [Sec]`[x+3] - Runs_Sample_23_1_1[[j]]$`Time [Sec]`[x])
  Delta_Ca_dataframe$Delta_Ca[x+3]  <- ceiling(Delta_Ca)
  Delta_Ca_dataframe
}

Cut_off1 <- max(Delta_Ca_dataframe[which(Delta_Ca_dataframe$Time <= 50),]$Delta_Ca, na.rm = T)
# In case there is a jump in the calcium at the exterior of the coral (due to calcification boundary)
Cut_off2 <- min(Delta_Ca_dataframe[which(Delta_Ca_dataframe$Time >= max(Delta_Ca_dataframe$Time, na.rm = T)/2),]$Delta_Ca, na.rm = T)
Pre_blank_cut_off <- Delta_Ca_dataframe[which(Delta_Ca_dataframe$Delta_Ca == Cut_off1),]$Time
Post_blank_cut_off <- Delta_Ca_dataframe[which(Delta_Ca_dataframe$Delta_Ca == Cut_off2),]$Time

datapoints_graph <- datapoints + 
  geom_vline(xintercept = 0) +
  geom_vline(xintercept = 30.5) + # preblank cut off
  geom_vline(xintercept = max(Runs_Sample_23_1_1[[j]]$`Time [Sec]`, na.rm = T)) +
  geom_vline(xintercept = max(Runs_Sample_23_1_1[[j]]$`Time [Sec]`, na.rm = T)-45) + #postblank cut off
  geom_vline(xintercept = Pre_blank_cut_off, linetype = 2) + # start of analysis
  geom_vline(xintercept = Post_blank_cut_off-2, linetype = 2) + # end of analysis
  scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
                labels = trans_format("log10", math_format(10^.x))) +
  annotation_logticks(sides = "l") +
  annotate("text", x = 100, y = 100, hjust = 1, vjust = 2, label = names(Runs_Sample_23_1_1[j]), col = "black") +
  ylab("Signal") +
  scale_fill_discrete(name = "Element") +
  theme_classic()

assign(paste0(names(Runs_Sample_23_1_1[j]), "_Elementsignals"), datapoints_graph)
Elementdata_Sample_23_1_1[[paste0(names(Runs_Sample_23_1_1[j]), "_Elementsignals")]] <- datapoints_graph

Preblank <- Runs_Sample_23_1_1[[j]] %>%
  filter(`Time [Sec]` <= 30.5) %>%
  mutate( across(all_of(c(2:11)), ~ ., .names = "{col}_preblank"))

Postblank <- Runs_Sample_23_1_1[[j]] %>%
  filter(`Time [Sec]` >= max(`Time [Sec]`, na.rm = T)-45) %>%
  mutate(across(all_of(c(2:11)), ~ ., .names = "{col}_postblank"))

Allblanks <- full_join(Preblank, Postblank)

Analysis <- Runs_Sample_23_1_1[[j]] %>%
  filter(`Time [Sec]` >= Pre_blank_cut_off & `Time [Sec]` <= Post_blank_cut_off) %>% 
  mutate(across(all_of(c(2:11)), ~ ., .names = "{col}_analysis"))

Analysis_full <- full_join(full_join(Allblanks, Analysis), Runs_Sample_23_1_1[[j]])
Analysis_full <- Analysis_full[order(Analysis_full$`Time [Sec]`),]
row.names(Analysis_full) <- NULL

Data_averages <- Analysis_full %>%
  summarise(across(all_of(c(12:41)), 
                   ~c(sum(!is.na(.x)),
                      mean(.x, na.rm = T), 
                   (sd(.x, na.rm = T)*2),
                   (sd(.x, na.rm = T)*2)/(mean(.x, na.rm = T))*100,
                   (sd(.x, na.rm = T)*3),
                   ((sd(.x, na.rm = T)*2)/sqrt(((sum(!is.na(.x)))-1))),
                   (((sd(.x, na.rm = T)*2)/sqrt(((sum(!is.na(.x)))-1))))/(mean(.x, na.rm = T))*100
                   )
                   )
            ) %>%
    add_column(Calculation = c("n", "mean", "2sd","2sd %","3sd", "2se", "2se%"), .before = "Li7_preblank")

cutoffs_table <- data.frame()

for(i in 12:ncol(Analysis_full)) {
 cutoffs <- Analysis_full[i] %>%
  filter(Analysis_full[i] < (mean(Analysis_full[[i]], na.rm = T) + (sd(Analysis_full[[i]], na.rm = T)*2)) &
           Analysis_full[i] > (mean(Analysis_full[[i]], na.rm = T) - (sd(Analysis_full[[i]], na.rm = T)*2)))
 meancutoffs <- mean(cutoffs[,1])
 print(meancutoffs)
 meancutoffs_data <- data.frame(variable = colnames(Analysis_full[i]),
                                mean2sd = meancutoffs)
 colnames(meancutoffs_data) <- c("variable", "mean2sd")
 cutoffs_table <- rbind(cutoffs_table, meancutoffs_data)
}

cutoffs_table <- cutoffs_table %>%
  rotate_df(rn = "Calculation", cn = T)

Data_averages_V2 <- full_join(cutoffs_table, Data_averages)

# starting the blank correction
Blankcorrections <- Analysis_full %>%
  dplyr::select(1,32:41) %>%
  mutate(
    Li7_analysis_blankcorrected = (Li7_analysis-(mean(Data_averages_V2$Li7_preblank[3],Data_averages_V2$Li7_postblank[3]))),
    B11_analysis_blankcorrected = (B11_analysis-(mean(Data_averages_V2$B11_preblank[3],Data_averages_V2$B11_postblank[3]))),
    Mg24_analysis_blankcorrected = (Mg24_analysis-(mean(Data_averages_V2$Mg24_preblank[3],Data_averages_V2$Mg24_postblank[3]))),
    P31_analysis_blankcorrected = (P31_analysis-(mean(Data_averages_V2$P31_preblank[3],Data_averages_V2$P31_postblank[3]))),
    S34_analysis_blankcorrected = (S34_analysis-(mean(Data_averages_V2$S34_preblank[3],Data_averages_V2$S34_postblank[3]))),
    Ca43_analysis_blankcorrected = (Ca43_analysis-(mean(Data_averages_V2$Ca43_preblank[3],Data_averages_V2$Ca43_postblank[3]))),
    Mn55_analysis_blankcorrected = (Mn55_analysis-(mean(Data_averages_V2$Mn55_preblank[3],Data_averages_V2$Mn55_postblank[3]))),
    Sr86_analysis_blankcorrected = (Sr86_analysis-(mean(Data_averages_V2$Sr86_preblank[3],Data_averages_V2$Sr86_postblank[3]))),
    Ba137_analysis_blankcorrected = (Ba137_analysis-(mean(Data_averages_V2$Ba137_preblank[3],Data_averages_V2$Ba137_postblank[3]))),
    U238_analysis_blankcorrected = (U238_analysis-(mean(Data_averages_V2$U238_preblank[3],Data_averages_V2$U238_postblank[3]))),
  )

Blankcorrections_ratios <- Blankcorrections %>%
  mutate(
    Li_Ca = Li7_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    B_Ca = B11_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    Mg_Ca = Mg24_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    P_Ca = P31_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    S_Ca = S34_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    Mn_Ca = Mn55_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    Sr_Ca = Sr86_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    Ba_Ca = Ba137_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    U_Ca = U238_analysis_blankcorrected/Ca43_analysis_blankcorrected
  )


Li_Ca <- ggplot() +
  geom_point(aes_(Blankcorrections_ratios$`Time [Sec]`,Blankcorrections_ratios$Li_Ca)) + 
  annotate("text", x = Inf, y = Inf, hjust = 1, vjust = 2, label = "Blank corrected", col = "red") +
  annotate("text", x = -Inf, y = Inf, hjust = -.25, vjust = 2, label = names(Runs_Sample_23_1_1[j]), col = "black") +
  lims(y =c (0,0.0005))

assign(paste0(names(Runs_Sample_23_1_1[j]), "_Li/Ca ratio"), Li_Ca)
Li_Ca_ratios_Sample_23_1_1[[paste0(names(Runs_Sample_23_1_1[j]), "_Li/Ca ratio")]] <- Li_Ca

Analysis_full_blankcorrections_ratios <- full_join(Analysis_full, Blankcorrections_ratios)
assign(paste0(names(Runs_Sample_23_1_1[j]), "_Analysis table"), Analysis_full_blankcorrections_ratios)
Analysis_Sample_23_1_1[[paste0(names(Runs_Sample_23_1_1[j]), "_Analysis table")]] <- Analysis_full_blankcorrections_ratios

Data_averages <- Analysis_full_blankcorrections_ratios %>%
  summarise(across(all_of(c(12:60)), 
                   ~c(sum(!is.na(.x)),
                      mean(.x, na.rm = T), 
                   (sd(.x, na.rm = T)*2),
                   (sd(.x, na.rm = T)*2)/(mean(.x, na.rm = T))*100,
                   (sd(.x, na.rm = T)*3),
                   ((sd(.x, na.rm = T)*2)/sqrt(((sum(!is.na(.x)))-1))),
                   (((sd(.x, na.rm = T)*2)/sqrt(((sum(!is.na(.x)))-1))))/(mean(.x, na.rm = T))*100
                   )
                   )
            ) %>%
    add_column(Calculation = c("n", "mean", "2sd","2sd %","3sd", "2se", "2se%"), .before = "Li7_preblank")

cutoffs_table <- data.frame()

for(i in 12:ncol(Analysis_full_blankcorrections_ratios)) {
 cutoffs <- Analysis_full_blankcorrections_ratios[i] %>%
  filter(Analysis_full_blankcorrections_ratios[i] < (mean(Analysis_full_blankcorrections_ratios[[i]], na.rm = T) + (sd(Analysis_full_blankcorrections_ratios[[i]], na.rm = T)*2)) &
           Analysis_full_blankcorrections_ratios[i] > (mean(Analysis_full_blankcorrections_ratios[[i]], na.rm = T) - (sd(Analysis_full_blankcorrections_ratios[[i]], na.rm = T)*2)))
 meancutoffs <- mean(cutoffs[,1])
 print(meancutoffs)
 meancutoffs_data <- data.frame(variable = colnames(Analysis_full_blankcorrections_ratios[i]),
                                mean2sd = meancutoffs)
 colnames(meancutoffs_data) <- c("variable", "mean2sd")
 cutoffs_table <- rbind(cutoffs_table, meancutoffs_data)
}

cutoffs_table <- cutoffs_table %>%
  rotate_df(rn = "Calculation", cn = T)

Data_averages_V2 <- full_join(cutoffs_table, Data_averages)
assign(paste0(names(Runs_Sample_23_1_1[j]), "_Calculations"), Data_averages_V2)
Calculations_Sample_23_1_1[[paste0(names(Runs_Sample_23_1_1[j]), "_Calculations")]] <- Data_averages_V2

}

plot_a_list(Elementdata_Sample_23_1_1, 2,3)

ggsave(
  "Sample_23_1_1_Element_Signals.tiff",
  plot = last_plot(),
  device = "tiff",
  path = Signals_graph_folder,
  scale = 1,
  width = 50,
  height = 20,
  units = "cm",
  dpi = 300,
  bg = NULL
)

# Samples code - first sample (23-1_2) ####
Analysis_Sample_23_1_2 <- list()
Calculations_Sample_23_1_2 <- list()
Elementdata_Sample_23_1_2 <- list()
Li_Ca_ratios_Sample_23_1_2 <- list()
j <- 1
for (j in 1:length(Runs_Sample_23_1_2)) {
  
nc<-wes_palette(length(names(Runs_Sample_23_1_2[[j]][2:11])), name="Darjeeling1", type="continuous")
datapoints <- ggplot(data = Runs_Sample_23_1_2[[j]], aes(x = `Time [Sec]`)) 

for (a in 2:11) {
  datapoints <- datapoints + geom_line(aes_string(y = names(Runs_Sample_23_1_2[[j]])[a], color =  shQuote(names(Runs_Sample_23_1_2[[j]])[a])))
}

if (names(Runs_Sample_23_1_2[[j]][7]) != "Ca43") {stop(paste0("Wrong element! ", names(Runs_Sample_23_1_2[[j]][7]), " for Runs_Sample_23_1_2_", j))} # Ca43

Time_length <- length(Runs_Sample_23_1_2[[j]]$`Time [Sec]`)

Delta_Ca_dataframe <- data.frame(Delta_Ca = as.numeric(rep(NA, Time_length+14)),
                                 Time = c(Runs_Sample_23_1_2[[j]]$`Time [Sec]`,rep(NA,14))
                                  )

# Rolling 4 step difference
for(x in 1:length(Runs_Sample_23_1_2[[j]]$`Time [Sec]`)) {
Delta_Ca <- (Runs_Sample_23_1_2[[j]]$Ca43[x+3] - Runs_Sample_23_1_2[[j]]$Ca43[x])/(Runs_Sample_23_1_2[[j]]$`Time [Sec]`[x+3] - Runs_Sample_23_1_2[[j]]$`Time [Sec]`[x])
  Delta_Ca_dataframe$Delta_Ca[x+3]  <- ceiling(Delta_Ca)
  Delta_Ca_dataframe
}

Cut_off1 <- max(Delta_Ca_dataframe[which(Delta_Ca_dataframe$Time <= 50),]$Delta_Ca, na.rm = T)
# In case there is a jump in the calcium at the exterior of the coral (due to calcification boundary)
Cut_off2 <- min(Delta_Ca_dataframe[which(Delta_Ca_dataframe$Time >= max(Delta_Ca_dataframe$Time, na.rm = T)/2),]$Delta_Ca, na.rm = T)
Pre_blank_cut_off <- Delta_Ca_dataframe[which(Delta_Ca_dataframe$Delta_Ca == Cut_off1),]$Time
Post_blank_cut_off <- Delta_Ca_dataframe[which(Delta_Ca_dataframe$Delta_Ca == Cut_off2),]$Time

datapoints_graph <- datapoints + 
  geom_vline(xintercept = 0) +
  geom_vline(xintercept = 30.5) + # preblank cut off
  geom_vline(xintercept = max(Runs_Sample_23_1_2[[j]]$`Time [Sec]`, na.rm = T)) +
  geom_vline(xintercept = max(Runs_Sample_23_1_2[[j]]$`Time [Sec]`, na.rm = T)-45) + #postblank cut off
  geom_vline(xintercept = Pre_blank_cut_off, linetype = 2) + # start of analysis
  geom_vline(xintercept = Post_blank_cut_off-2, linetype = 2) + # end of analysis
  scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
                labels = trans_format("log10", math_format(10^.x))) +
  annotation_logticks(sides = "l") +
  annotate("text", x = 100, y = 100, hjust = 1, vjust = 2, label = names(Runs_Sample_23_1_2[j]), col = "black") +
  ylab("Signal") +
  scale_fill_discrete(name = "Element") +
  theme_classic()

assign(paste0(names(Runs_Sample_23_1_2[j]), "_Elementsignals"), datapoints_graph)
Elementdata_Sample_23_1_2[[paste0(names(Runs_Sample_23_1_2[j]), "_Elementsignals")]] <- datapoints_graph

Preblank <- Runs_Sample_23_1_2[[j]] %>%
  filter(`Time [Sec]` <= 30.5) %>%
  mutate( across(all_of(c(2:11)), ~ ., .names = "{col}_preblank"))

Postblank <- Runs_Sample_23_1_2[[j]] %>%
  filter(`Time [Sec]` >= max(`Time [Sec]`, na.rm = T)-45) %>%
  mutate(across(all_of(c(2:11)), ~ ., .names = "{col}_postblank"))

Allblanks <- full_join(Preblank, Postblank)

Analysis <- Runs_Sample_23_1_2[[j]] %>%
  filter(`Time [Sec]` >= Pre_blank_cut_off & `Time [Sec]` <= Post_blank_cut_off) %>% 
  mutate(across(all_of(c(2:11)), ~ ., .names = "{col}_analysis"))

Analysis_full <- full_join(full_join(Allblanks, Analysis), Runs_Sample_23_1_2[[j]])
Analysis_full <- Analysis_full[order(Analysis_full$`Time [Sec]`),]
row.names(Analysis_full) <- NULL

Data_averages <- Analysis_full %>%
  summarise(across(all_of(c(12:41)), 
                   ~c(sum(!is.na(.x)),
                      mean(.x, na.rm = T), 
                   (sd(.x, na.rm = T)*2),
                   (sd(.x, na.rm = T)*2)/(mean(.x, na.rm = T))*100,
                   (sd(.x, na.rm = T)*3),
                   ((sd(.x, na.rm = T)*2)/sqrt(((sum(!is.na(.x)))-1))),
                   (((sd(.x, na.rm = T)*2)/sqrt(((sum(!is.na(.x)))-1))))/(mean(.x, na.rm = T))*100
                   )
                   )
            ) %>%
    add_column(Calculation = c("n", "mean", "2sd","2sd %","3sd", "2se", "2se%"), .before = "Li7_preblank")

cutoffs_table <- data.frame()

for(i in 12:ncol(Analysis_full)) {
 cutoffs <- Analysis_full[i] %>%
  filter(Analysis_full[i] < (mean(Analysis_full[[i]], na.rm = T) + (sd(Analysis_full[[i]], na.rm = T)*2)) &
           Analysis_full[i] > (mean(Analysis_full[[i]], na.rm = T) - (sd(Analysis_full[[i]], na.rm = T)*2)))
 meancutoffs <- mean(cutoffs[,1])
 print(meancutoffs)
 meancutoffs_data <- data.frame(variable = colnames(Analysis_full[i]),
                                mean2sd = meancutoffs)
 colnames(meancutoffs_data) <- c("variable", "mean2sd")
 cutoffs_table <- rbind(cutoffs_table, meancutoffs_data)
}

cutoffs_table <- cutoffs_table %>%
  rotate_df(rn = "Calculation", cn = T)

Data_averages_V2 <- full_join(cutoffs_table, Data_averages)

# starting the blank correction
Blankcorrections <- Analysis_full %>%
  dplyr::select(1,32:41) %>%
  mutate(
    Li7_analysis_blankcorrected = (Li7_analysis-(mean(Data_averages_V2$Li7_preblank[3],Data_averages_V2$Li7_postblank[3]))),
    B11_analysis_blankcorrected = (B11_analysis-(mean(Data_averages_V2$B11_preblank[3],Data_averages_V2$B11_postblank[3]))),
    Mg24_analysis_blankcorrected = (Mg24_analysis-(mean(Data_averages_V2$Mg24_preblank[3],Data_averages_V2$Mg24_postblank[3]))),
    P31_analysis_blankcorrected = (P31_analysis-(mean(Data_averages_V2$P31_preblank[3],Data_averages_V2$P31_postblank[3]))),
    S34_analysis_blankcorrected = (S34_analysis-(mean(Data_averages_V2$S34_preblank[3],Data_averages_V2$S34_postblank[3]))),
    Ca43_analysis_blankcorrected = (Ca43_analysis-(mean(Data_averages_V2$Ca43_preblank[3],Data_averages_V2$Ca43_postblank[3]))),
    Mn55_analysis_blankcorrected = (Mn55_analysis-(mean(Data_averages_V2$Mn55_preblank[3],Data_averages_V2$Mn55_postblank[3]))),
    Sr86_analysis_blankcorrected = (Sr86_analysis-(mean(Data_averages_V2$Sr86_preblank[3],Data_averages_V2$Sr86_postblank[3]))),
    Ba137_analysis_blankcorrected = (Ba137_analysis-(mean(Data_averages_V2$Ba137_preblank[3],Data_averages_V2$Ba137_postblank[3]))),
    U238_analysis_blankcorrected = (U238_analysis-(mean(Data_averages_V2$U238_preblank[3],Data_averages_V2$U238_postblank[3]))),
  )

Blankcorrections_ratios <- Blankcorrections %>%
  mutate(
    Li_Ca = Li7_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    B_Ca = B11_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    Mg_Ca = Mg24_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    P_Ca = P31_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    S_Ca = S34_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    Mn_Ca = Mn55_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    Sr_Ca = Sr86_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    Ba_Ca = Ba137_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    U_Ca = U238_analysis_blankcorrected/Ca43_analysis_blankcorrected
  )


Li_Ca <- ggplot() +
  geom_point(aes_(Blankcorrections_ratios$`Time [Sec]`,Blankcorrections_ratios$Li_Ca)) + 
  annotate("text", x = Inf, y = Inf, hjust = 1, vjust = 2, label = "Blank corrected", col = "red") +
  annotate("text", x = -Inf, y = Inf, hjust = -.25, vjust = 2, label = names(Runs_Sample_23_1_2[j]), col = "black") +
  lims(y =c (0,0.0005))

assign(paste0(names(Runs_Sample_23_1_2[j]), "_Li/Ca ratio"), Li_Ca)
Li_Ca_ratios_Sample_23_1_2[[paste0(names(Runs_Sample_23_1_2[j]), "_Li/Ca ratio")]] <- Li_Ca

Analysis_full_blankcorrections_ratios <- full_join(Analysis_full, Blankcorrections_ratios)
assign(paste0(names(Runs_Sample_23_1_2[j]), "_Analysis table"), Analysis_full_blankcorrections_ratios)
Analysis_Sample_23_1_2[[paste0(names(Runs_Sample_23_1_2[j]), "_Analysis table")]] <- Analysis_full_blankcorrections_ratios

Data_averages <- Analysis_full_blankcorrections_ratios %>%
  summarise(across(all_of(c(12:60)), 
                   ~c(sum(!is.na(.x)),
                      mean(.x, na.rm = T), 
                   (sd(.x, na.rm = T)*2),
                   (sd(.x, na.rm = T)*2)/(mean(.x, na.rm = T))*100,
                   (sd(.x, na.rm = T)*3),
                   ((sd(.x, na.rm = T)*2)/sqrt(((sum(!is.na(.x)))-1))),
                   (((sd(.x, na.rm = T)*2)/sqrt(((sum(!is.na(.x)))-1))))/(mean(.x, na.rm = T))*100
                   )
                   )
            ) %>%
    add_column(Calculation = c("n", "mean", "2sd","2sd %","3sd", "2se", "2se%"), .before = "Li7_preblank")

cutoffs_table <- data.frame()

for(i in 12:ncol(Analysis_full_blankcorrections_ratios)) {
 cutoffs <- Analysis_full_blankcorrections_ratios[i] %>%
  filter(Analysis_full_blankcorrections_ratios[i] < (mean(Analysis_full_blankcorrections_ratios[[i]], na.rm = T) + (sd(Analysis_full_blankcorrections_ratios[[i]], na.rm = T)*2)) &
           Analysis_full_blankcorrections_ratios[i] > (mean(Analysis_full_blankcorrections_ratios[[i]], na.rm = T) - (sd(Analysis_full_blankcorrections_ratios[[i]], na.rm = T)*2)))
 meancutoffs <- mean(cutoffs[,1])
 print(meancutoffs)
 meancutoffs_data <- data.frame(variable = colnames(Analysis_full_blankcorrections_ratios[i]),
                                mean2sd = meancutoffs)
 colnames(meancutoffs_data) <- c("variable", "mean2sd")
 cutoffs_table <- rbind(cutoffs_table, meancutoffs_data)
}

cutoffs_table <- cutoffs_table %>%
  rotate_df(rn = "Calculation", cn = T)

Data_averages_V2 <- full_join(cutoffs_table, Data_averages)
assign(paste0(names(Runs_Sample_23_1_2[j]), "_Calculations"), Data_averages_V2)
Calculations_Sample_23_1_2[[paste0(names(Runs_Sample_23_1_2[j]), "_Calculations")]] <- Data_averages_V2

}

plot_a_list(Elementdata_Sample_23_1_2, 2,3)

ggsave(
  "Sample_23_1_2_Element_Signals.tiff",
  plot = last_plot(),
  device = "tiff",
  path = Signals_graph_folder,
  scale = 1,
  width = 50,
  height = 20,
  units = "cm",
  dpi = 300,
  bg = NULL
)

# Samples code - first sample (23-1_3) ####
Analysis_Sample_23_1_3 <- list()
Calculations_Sample_23_1_3 <- list()
Elementdata_Sample_23_1_3 <- list()
Li_Ca_ratios_Sample_23_1_3 <- list()
j <- 1
for (j in 1:length(Runs_Sample_23_1_3)) {
  
nc<-wes_palette(length(names(Runs_Sample_23_1_3[[j]][2:11])), name="Darjeeling1", type="continuous")
datapoints <- ggplot(data = Runs_Sample_23_1_3[[j]], aes(x = `Time [Sec]`)) 

for (a in 2:11) {
  datapoints <- datapoints + geom_line(aes_string(y = names(Runs_Sample_23_1_3[[j]])[a], color =  shQuote(names(Runs_Sample_23_1_3[[j]])[a])))
}

if (names(Runs_Sample_23_1_3[[j]][7]) != "Ca43") {stop(paste0("Wrong element! ", names(Runs_Sample_23_1_3[[j]][7]), " for Runs_Sample_23_1_3_", j))} # Ca43

Time_length <- length(Runs_Sample_23_1_3[[j]]$`Time [Sec]`)

Delta_Ca_dataframe <- data.frame(Delta_Ca = as.numeric(rep(NA, Time_length+14)),
                                 Time = c(Runs_Sample_23_1_3[[j]]$`Time [Sec]`,rep(NA,14))
                                  )

# Rolling 4 step difference
for(x in 1:length(Runs_Sample_23_1_3[[j]]$`Time [Sec]`)) {
Delta_Ca <- (Runs_Sample_23_1_3[[j]]$Ca43[x+3] - Runs_Sample_23_1_3[[j]]$Ca43[x])/(Runs_Sample_23_1_3[[j]]$`Time [Sec]`[x+3] - Runs_Sample_23_1_3[[j]]$`Time [Sec]`[x])
  Delta_Ca_dataframe$Delta_Ca[x+3]  <- ceiling(Delta_Ca)
  Delta_Ca_dataframe
}

Cut_off1 <- max(Delta_Ca_dataframe[which(Delta_Ca_dataframe$Time <= 50),]$Delta_Ca, na.rm = T)
# In case there is a jump in the calcium at the exterior of the coral (due to calcification boundary)
Cut_off2 <- min(Delta_Ca_dataframe[which(Delta_Ca_dataframe$Time >= max(Delta_Ca_dataframe$Time, na.rm = T)/2),]$Delta_Ca, na.rm = T)
Pre_blank_cut_off <- Delta_Ca_dataframe[which(Delta_Ca_dataframe$Delta_Ca == Cut_off1),]$Time
Post_blank_cut_off <- Delta_Ca_dataframe[which(Delta_Ca_dataframe$Delta_Ca == Cut_off2),]$Time

datapoints_graph <- datapoints + 
  geom_vline(xintercept = 0) +
  geom_vline(xintercept = 30.5) + # preblank cut off
  geom_vline(xintercept = max(Runs_Sample_23_1_3[[j]]$`Time [Sec]`, na.rm = T)) +
  geom_vline(xintercept = max(Runs_Sample_23_1_3[[j]]$`Time [Sec]`, na.rm = T)-45) + #postblank cut off
  geom_vline(xintercept = Pre_blank_cut_off, linetype = 2) + # start of analysis
  geom_vline(xintercept = Post_blank_cut_off-2, linetype = 2) + # end of analysis
  scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
                labels = trans_format("log10", math_format(10^.x))) +
  annotation_logticks(sides = "l") +
  annotate("text", x = 100, y = 100, hjust = 1, vjust = 2, label = names(Runs_Sample_23_1_3[j]), col = "black") +
  ylab("Signal") +
  scale_fill_discrete(name = "Element") +
  theme_classic()

assign(paste0(names(Runs_Sample_23_1_3[j]), "_Elementsignals"), datapoints_graph)
Elementdata_Sample_23_1_3[[paste0(names(Runs_Sample_23_1_3[j]), "_Elementsignals")]] <- datapoints_graph

Preblank <- Runs_Sample_23_1_3[[j]] %>%
  filter(`Time [Sec]` <= 30.5) %>%
  mutate( across(all_of(c(2:11)), ~ ., .names = "{col}_preblank"))

Postblank <- Runs_Sample_23_1_3[[j]] %>%
  filter(`Time [Sec]` >= max(`Time [Sec]`, na.rm = T)-45) %>%
  mutate(across(all_of(c(2:11)), ~ ., .names = "{col}_postblank"))

Allblanks <- full_join(Preblank, Postblank)

Analysis <- Runs_Sample_23_1_3[[j]] %>%
  filter(`Time [Sec]` >= Pre_blank_cut_off & `Time [Sec]` <= Post_blank_cut_off) %>% 
  mutate(across(all_of(c(2:11)), ~ ., .names = "{col}_analysis"))

Analysis_full <- full_join(full_join(Allblanks, Analysis), Runs_Sample_23_1_3[[j]])
Analysis_full <- Analysis_full[order(Analysis_full$`Time [Sec]`),]
row.names(Analysis_full) <- NULL

Data_averages <- Analysis_full %>%
  summarise(across(all_of(c(12:41)), 
                   ~c(sum(!is.na(.x)),
                      mean(.x, na.rm = T), 
                   (sd(.x, na.rm = T)*2),
                   (sd(.x, na.rm = T)*2)/(mean(.x, na.rm = T))*100,
                   (sd(.x, na.rm = T)*3),
                   ((sd(.x, na.rm = T)*2)/sqrt(((sum(!is.na(.x)))-1))),
                   (((sd(.x, na.rm = T)*2)/sqrt(((sum(!is.na(.x)))-1))))/(mean(.x, na.rm = T))*100
                   )
                   )
            ) %>%
    add_column(Calculation = c("n", "mean", "2sd","2sd %","3sd", "2se", "2se%"), .before = "Li7_preblank")

cutoffs_table <- data.frame()

for(i in 12:ncol(Analysis_full)) {
 cutoffs <- Analysis_full[i] %>%
  filter(Analysis_full[i] < (mean(Analysis_full[[i]], na.rm = T) + (sd(Analysis_full[[i]], na.rm = T)*2)) &
           Analysis_full[i] > (mean(Analysis_full[[i]], na.rm = T) - (sd(Analysis_full[[i]], na.rm = T)*2)))
 meancutoffs <- mean(cutoffs[,1])
 print(meancutoffs)
 meancutoffs_data <- data.frame(variable = colnames(Analysis_full[i]),
                                mean2sd = meancutoffs)
 colnames(meancutoffs_data) <- c("variable", "mean2sd")
 cutoffs_table <- rbind(cutoffs_table, meancutoffs_data)
}

cutoffs_table <- cutoffs_table %>%
  rotate_df(rn = "Calculation", cn = T)

Data_averages_V2 <- full_join(cutoffs_table, Data_averages)

# starting the blank correction
Blankcorrections <- Analysis_full %>%
  dplyr::select(1,32:41) %>%
  mutate(
    Li7_analysis_blankcorrected = (Li7_analysis-(mean(Data_averages_V2$Li7_preblank[3],Data_averages_V2$Li7_postblank[3]))),
    B11_analysis_blankcorrected = (B11_analysis-(mean(Data_averages_V2$B11_preblank[3],Data_averages_V2$B11_postblank[3]))),
    Mg24_analysis_blankcorrected = (Mg24_analysis-(mean(Data_averages_V2$Mg24_preblank[3],Data_averages_V2$Mg24_postblank[3]))),
    P31_analysis_blankcorrected = (P31_analysis-(mean(Data_averages_V2$P31_preblank[3],Data_averages_V2$P31_postblank[3]))),
    S34_analysis_blankcorrected = (S34_analysis-(mean(Data_averages_V2$S34_preblank[3],Data_averages_V2$S34_postblank[3]))),
    Ca43_analysis_blankcorrected = (Ca43_analysis-(mean(Data_averages_V2$Ca43_preblank[3],Data_averages_V2$Ca43_postblank[3]))),
    Mn55_analysis_blankcorrected = (Mn55_analysis-(mean(Data_averages_V2$Mn55_preblank[3],Data_averages_V2$Mn55_postblank[3]))),
    Sr86_analysis_blankcorrected = (Sr86_analysis-(mean(Data_averages_V2$Sr86_preblank[3],Data_averages_V2$Sr86_postblank[3]))),
    Ba137_analysis_blankcorrected = (Ba137_analysis-(mean(Data_averages_V2$Ba137_preblank[3],Data_averages_V2$Ba137_postblank[3]))),
    U238_analysis_blankcorrected = (U238_analysis-(mean(Data_averages_V2$U238_preblank[3],Data_averages_V2$U238_postblank[3]))),
  )

Blankcorrections_ratios <- Blankcorrections %>%
  mutate(
    Li_Ca = Li7_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    B_Ca = B11_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    Mg_Ca = Mg24_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    P_Ca = P31_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    S_Ca = S34_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    Mn_Ca = Mn55_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    Sr_Ca = Sr86_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    Ba_Ca = Ba137_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    U_Ca = U238_analysis_blankcorrected/Ca43_analysis_blankcorrected
  )


Li_Ca <- ggplot() +
  geom_point(aes_(Blankcorrections_ratios$`Time [Sec]`,Blankcorrections_ratios$Li_Ca)) + 
  annotate("text", x = Inf, y = Inf, hjust = 1, vjust = 2, label = "Blank corrected", col = "red") +
  annotate("text", x = -Inf, y = Inf, hjust = -.25, vjust = 2, label = names(Runs_Sample_23_1_3[j]), col = "black") +
  lims(y =c (0,0.0005))

assign(paste0(names(Runs_Sample_23_1_3[j]), "_Li/Ca ratio"), Li_Ca)
Li_Ca_ratios_Sample_23_1_3[[paste0(names(Runs_Sample_23_1_3[j]), "_Li/Ca ratio")]] <- Li_Ca

Analysis_full_blankcorrections_ratios <- full_join(Analysis_full, Blankcorrections_ratios)
assign(paste0(names(Runs_Sample_23_1_3[j]), "_Analysis table"), Analysis_full_blankcorrections_ratios)
Analysis_Sample_23_1_3[[paste0(names(Runs_Sample_23_1_3[j]), "_Analysis table")]] <- Analysis_full_blankcorrections_ratios

Data_averages <- Analysis_full_blankcorrections_ratios %>%
  summarise(across(all_of(c(12:60)), 
                   ~c(sum(!is.na(.x)),
                      mean(.x, na.rm = T), 
                   (sd(.x, na.rm = T)*2),
                   (sd(.x, na.rm = T)*2)/(mean(.x, na.rm = T))*100,
                   (sd(.x, na.rm = T)*3),
                   ((sd(.x, na.rm = T)*2)/sqrt(((sum(!is.na(.x)))-1))),
                   (((sd(.x, na.rm = T)*2)/sqrt(((sum(!is.na(.x)))-1))))/(mean(.x, na.rm = T))*100
                   )
                   )
            ) %>%
    add_column(Calculation = c("n", "mean", "2sd","2sd %","3sd", "2se", "2se%"), .before = "Li7_preblank")

cutoffs_table <- data.frame()

for(i in 12:ncol(Analysis_full_blankcorrections_ratios)) {
 cutoffs <- Analysis_full_blankcorrections_ratios[i] %>%
  filter(Analysis_full_blankcorrections_ratios[i] < (mean(Analysis_full_blankcorrections_ratios[[i]], na.rm = T) + (sd(Analysis_full_blankcorrections_ratios[[i]], na.rm = T)*2)) &
           Analysis_full_blankcorrections_ratios[i] > (mean(Analysis_full_blankcorrections_ratios[[i]], na.rm = T) - (sd(Analysis_full_blankcorrections_ratios[[i]], na.rm = T)*2)))
 meancutoffs <- mean(cutoffs[,1])
 print(meancutoffs)
 meancutoffs_data <- data.frame(variable = colnames(Analysis_full_blankcorrections_ratios[i]),
                                mean2sd = meancutoffs)
 colnames(meancutoffs_data) <- c("variable", "mean2sd")
 cutoffs_table <- rbind(cutoffs_table, meancutoffs_data)
}

cutoffs_table <- cutoffs_table %>%
  rotate_df(rn = "Calculation", cn = T)

Data_averages_V2 <- full_join(cutoffs_table, Data_averages)
assign(paste0(names(Runs_Sample_23_1_3[j]), "_Calculations"), Data_averages_V2)
Calculations_Sample_23_1_3[[paste0(names(Runs_Sample_23_1_3[j]), "_Calculations")]] <- Data_averages_V2

}

plot_a_list(Elementdata_Sample_23_1_3, 2,3)

ggsave(
  "Sample_23_1_3_Element_Signals.tiff",
  plot = last_plot(),
  device = "tiff",
  path = Signals_graph_folder,
  scale = 1,
  width = 50,
  height = 20,
  units = "cm",
  dpi = 300,
  bg = NULL
)

plot_a_list(Li_Ca_ratios_Sample_23_1_3, 5,1, ylim = c(0,.005), xlim = c(0,200))

# Samples code - first sample (23-10_1) ####
Analysis_Sample_23_10_1 <- list()
Calculations_Sample_23_10_1 <- list()
Elementdata_Sample_23_10_1 <- list()
Li_Ca_ratios_Sample_23_10_1 <- list()
j <- 1
for (j in 1:length(Runs_Sample_23_10_1)) {

nc<-wes_palette(length(names(Runs_Sample_23_10_1[[j]][2:11])), name="Darjeeling1", type="continuous")
datapoints <- ggplot(data = Runs_Sample_23_10_1[[j]], aes(x = `Time [Sec]`)) 

for (a in 2:11) {
  datapoints <- datapoints + geom_line(aes_string(y = names(Runs_Sample_23_10_1[[j]])[a], color =  shQuote(names(Runs_Sample_23_10_1[[j]])[a])))
}

if (names(Runs_Sample_23_10_1[[j]][7]) != "Ca43") {stop(paste0("Wrong element! ", names(Runs_Sample_23_10_1[[j]][7]), " for Runs_Sample_23_10_1_", j))} # Ca43

Time_length <- length(Runs_Sample_23_10_1[[j]]$`Time [Sec]`)

Delta_Ca_dataframe <- data.frame(Delta_Ca = as.numeric(rep(NA, Time_length+14)),
                                 Time = c(Runs_Sample_23_10_1[[j]]$`Time [Sec]`,rep(NA,14))
                                  )

# Rolling 4 step difference
for(x in 1:length(Runs_Sample_23_10_1[[j]]$`Time [Sec]`)) {
Delta_Ca <- (Runs_Sample_23_10_1[[j]]$Ca43[x+3] - Runs_Sample_23_10_1[[j]]$Ca43[x])/(Runs_Sample_23_10_1[[j]]$`Time [Sec]`[x+3] - Runs_Sample_23_10_1[[j]]$`Time [Sec]`[x])
  Delta_Ca_dataframe$Delta_Ca[x+3]  <- ceiling(Delta_Ca)
  Delta_Ca_dataframe
}

Cut_off1 <- max(Delta_Ca_dataframe[which(Delta_Ca_dataframe$Time <= 50),]$Delta_Ca, na.rm = T)
# In case there is a jump in the calcium at the exterior of the coral (due to calcification boundary)
Cut_off2 <- min(Delta_Ca_dataframe[which(Delta_Ca_dataframe$Time >= max(Delta_Ca_dataframe$Time, na.rm = T)/2),]$Delta_Ca, na.rm = T)
Pre_blank_cut_off <- Delta_Ca_dataframe[which(Delta_Ca_dataframe$Delta_Ca == Cut_off1),]$Time
Post_blank_cut_off <- Delta_Ca_dataframe[which(Delta_Ca_dataframe$Delta_Ca == Cut_off2),]$Time

datapoints_graph <- datapoints + 
  geom_vline(xintercept = 0) +
  geom_vline(xintercept = 30.5) + # preblank cut off
  geom_vline(xintercept = max(Runs_Sample_23_10_1[[j]]$`Time [Sec]`, na.rm = T)) +
  geom_vline(xintercept = max(Runs_Sample_23_10_1[[j]]$`Time [Sec]`, na.rm = T)-45) + #postblank cut off
  geom_vline(xintercept = Pre_blank_cut_off, linetype = 2) + # start of analysis
  geom_vline(xintercept = Post_blank_cut_off-2, linetype = 2) + # end of analysis
  scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
                labels = trans_format("log10", math_format(10^.x))) +
  annotation_logticks(sides = "l") +
  annotate("text", x = 100, y = 100, hjust = 1, vjust = 2, label = names(Runs_Sample_23_10_1[j]), col = "black") +
  ylab("Signal") +
  scale_fill_discrete(name = "Element") +
  theme_classic()

assign(paste0(names(Runs_Sample_23_10_1[j]), "_Elementsignals"), datapoints_graph)
Elementdata_Sample_23_10_1[[paste0(names(Runs_Sample_23_10_1[j]), "_Elementsignals")]] <- datapoints_graph

Preblank <- Runs_Sample_23_10_1[[j]] %>%
  filter(`Time [Sec]` <= 30.5) %>%
  mutate( across(all_of(c(2:11)), ~ ., .names = "{col}_preblank"))

Postblank <- Runs_Sample_23_10_1[[j]] %>%
  filter(`Time [Sec]` >= max(`Time [Sec]`, na.rm = T)-45) %>%
  mutate(across(all_of(c(2:11)), ~ ., .names = "{col}_postblank"))

Allblanks <- full_join(Preblank, Postblank)

Analysis <- Runs_Sample_23_10_1[[j]] %>%
  filter(`Time [Sec]` >= Pre_blank_cut_off & `Time [Sec]` <= Post_blank_cut_off) %>% 
  mutate(across(all_of(c(2:11)), ~ ., .names = "{col}_analysis"))

Analysis_full <- full_join(full_join(Allblanks, Analysis), Runs_Sample_23_10_1[[j]])
Analysis_full <- Analysis_full[order(Analysis_full$`Time [Sec]`),]
row.names(Analysis_full) <- NULL

Data_averages <- Analysis_full %>%
  summarise(across(all_of(c(12:41)), 
                   ~c(sum(!is.na(.x)),
                      mean(.x, na.rm = T), 
                   (sd(.x, na.rm = T)*2),
                   (sd(.x, na.rm = T)*2)/(mean(.x, na.rm = T))*100,
                   (sd(.x, na.rm = T)*3),
                   ((sd(.x, na.rm = T)*2)/sqrt(((sum(!is.na(.x)))-1))),
                   (((sd(.x, na.rm = T)*2)/sqrt(((sum(!is.na(.x)))-1))))/(mean(.x, na.rm = T))*100
                   )
                   )
            ) %>%
    add_column(Calculation = c("n", "mean", "2sd","2sd %","3sd", "2se", "2se%"), .before = "Li7_preblank")

cutoffs_table <- data.frame()

for(i in 12:ncol(Analysis_full)) {
 cutoffs <- Analysis_full[i] %>%
  filter(Analysis_full[i] < (mean(Analysis_full[[i]], na.rm = T) + (sd(Analysis_full[[i]], na.rm = T)*2)) &
           Analysis_full[i] > (mean(Analysis_full[[i]], na.rm = T) - (sd(Analysis_full[[i]], na.rm = T)*2)))
 meancutoffs <- mean(cutoffs[,1])
 print(meancutoffs)
 meancutoffs_data <- data.frame(variable = colnames(Analysis_full[i]),
                                mean2sd = meancutoffs)
 colnames(meancutoffs_data) <- c("variable", "mean2sd")
 cutoffs_table <- rbind(cutoffs_table, meancutoffs_data)
}

cutoffs_table <- cutoffs_table %>%
  rotate_df(rn = "Calculation", cn = T)

Data_averages_V2 <- full_join(cutoffs_table, Data_averages)

# starting the blank correction
Blankcorrections <- Analysis_full %>%
  dplyr::select(1,32:41) %>%
  mutate(
    Li7_analysis_blankcorrected = (Li7_analysis-(mean(Data_averages_V2$Li7_preblank[3],Data_averages_V2$Li7_postblank[3]))),
    B11_analysis_blankcorrected = (B11_analysis-(mean(Data_averages_V2$B11_preblank[3],Data_averages_V2$B11_postblank[3]))),
    Mg24_analysis_blankcorrected = (Mg24_analysis-(mean(Data_averages_V2$Mg24_preblank[3],Data_averages_V2$Mg24_postblank[3]))),
    P31_analysis_blankcorrected = (P31_analysis-(mean(Data_averages_V2$P31_preblank[3],Data_averages_V2$P31_postblank[3]))),
    S34_analysis_blankcorrected = (S34_analysis-(mean(Data_averages_V2$S34_preblank[3],Data_averages_V2$S34_postblank[3]))),
    Ca43_analysis_blankcorrected = (Ca43_analysis-(mean(Data_averages_V2$Ca43_preblank[3],Data_averages_V2$Ca43_postblank[3]))),
    Mn55_analysis_blankcorrected = (Mn55_analysis-(mean(Data_averages_V2$Mn55_preblank[3],Data_averages_V2$Mn55_postblank[3]))),
    Sr86_analysis_blankcorrected = (Sr86_analysis-(mean(Data_averages_V2$Sr86_preblank[3],Data_averages_V2$Sr86_postblank[3]))),
    Ba137_analysis_blankcorrected = (Ba137_analysis-(mean(Data_averages_V2$Ba137_preblank[3],Data_averages_V2$Ba137_postblank[3]))),
    U238_analysis_blankcorrected = (U238_analysis-(mean(Data_averages_V2$U238_preblank[3],Data_averages_V2$U238_postblank[3]))),
  )

Blankcorrections_ratios <- Blankcorrections %>%
  mutate(
    Li_Ca = Li7_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    B_Ca = B11_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    Mg_Ca = Mg24_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    P_Ca = P31_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    S_Ca = S34_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    Mn_Ca = Mn55_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    Sr_Ca = Sr86_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    Ba_Ca = Ba137_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    U_Ca = U238_analysis_blankcorrected/Ca43_analysis_blankcorrected
  )


Li_Ca <- ggplot() +
  geom_point(aes_(Blankcorrections_ratios$`Time [Sec]`,Blankcorrections_ratios$Li_Ca)) + 
  annotate("text", x = Inf, y = Inf, hjust = 1, vjust = 2, label = "Blank corrected", col = "red") +
  annotate("text", x = -Inf, y = Inf, hjust = -.25, vjust = 2, label = names(Runs_Sample_23_10_1[j]), col = "black") +
  lims(y =c (0,0.0005))

assign(paste0(names(Runs_Sample_23_10_1[j]), "_Li/Ca ratio"), Li_Ca)
Li_Ca_ratios_Sample_23_10_1[[paste0(names(Runs_Sample_23_10_1[j]), "_Li/Ca ratio")]] <- Li_Ca

Analysis_full_blankcorrections_ratios <- full_join(Analysis_full, Blankcorrections_ratios)
assign(paste0(names(Runs_Sample_23_10_1[j]), "_Analysis table"), Analysis_full_blankcorrections_ratios)
Analysis_Sample_23_10_1[[paste0(names(Runs_Sample_23_10_1[j]), "_Analysis table")]] <- Analysis_full_blankcorrections_ratios

Data_averages <- Analysis_full_blankcorrections_ratios %>%
  summarise(across(all_of(c(12:60)), 
                   ~c(sum(!is.na(.x)),
                      mean(.x, na.rm = T), 
                   (sd(.x, na.rm = T)*2),
                   (sd(.x, na.rm = T)*2)/(mean(.x, na.rm = T))*100,
                   (sd(.x, na.rm = T)*3),
                   ((sd(.x, na.rm = T)*2)/sqrt(((sum(!is.na(.x)))-1))),
                   (((sd(.x, na.rm = T)*2)/sqrt(((sum(!is.na(.x)))-1))))/(mean(.x, na.rm = T))*100
                   )
                   )
            ) %>%
    add_column(Calculation = c("n", "mean", "2sd","2sd %","3sd", "2se", "2se%"), .before = "Li7_preblank")

cutoffs_table <- data.frame()

for(i in 12:ncol(Analysis_full_blankcorrections_ratios)) {
 cutoffs <- Analysis_full_blankcorrections_ratios[i] %>%
  filter(Analysis_full_blankcorrections_ratios[i] < (mean(Analysis_full_blankcorrections_ratios[[i]], na.rm = T) + (sd(Analysis_full_blankcorrections_ratios[[i]], na.rm = T)*2)) &
           Analysis_full_blankcorrections_ratios[i] > (mean(Analysis_full_blankcorrections_ratios[[i]], na.rm = T) - (sd(Analysis_full_blankcorrections_ratios[[i]], na.rm = T)*2)))
 meancutoffs <- mean(cutoffs[,1])
 print(meancutoffs)
 meancutoffs_data <- data.frame(variable = colnames(Analysis_full_blankcorrections_ratios[i]),
                                mean2sd = meancutoffs)
 colnames(meancutoffs_data) <- c("variable", "mean2sd")
 cutoffs_table <- rbind(cutoffs_table, meancutoffs_data)
}

cutoffs_table <- cutoffs_table %>%
  rotate_df(rn = "Calculation", cn = T)

Data_averages_V2 <- full_join(cutoffs_table, Data_averages)
assign(paste0(names(Runs_Sample_23_10_1[j]), "_Calculations"), Data_averages_V2)
Calculations_Sample_23_10_1[[paste0(names(Runs_Sample_23_10_1[j]), "_Calculations")]] <- Data_averages_V2

}

plot_a_list(Li_Ca_ratios_Sample_23_10_1, 2,3, ylim = c(0,0.05), xlim = c(0,300))

plot_a_list(Elementdata_Sample_23_10_1, 2,3)

ggsave(
  "Sample_23_10_1_Element_Signals.tiff",
  plot = last_plot(),
  device = "tiff",
  path = Signals_graph_folder,
  scale = 1,
  width = 50,
  height = 20,
  units = "cm",
  dpi = 300,
  bg = NULL
)

# Samples code - first sample (23-10_2) ####
Analysis_Sample_23_10_2 <- list()
Calculations_Sample_23_10_2 <- list()
Elementdata_Sample_23_10_2 <- list()
Li_Ca_ratios_Sample_23_10_2 <- list()
j <- 1
for (j in 1:length(Runs_Sample_23_10_2)) {
  
nc<-wes_palette(length(names(Runs_Sample_23_10_2[[j]][2:11])), name="Darjeeling1", type="continuous")
datapoints <- ggplot(data = Runs_Sample_23_10_2[[j]], aes(x = `Time [Sec]`)) 

for (a in 2:11) {
  datapoints <- datapoints + geom_line(aes_string(y = names(Runs_Sample_23_10_2[[j]])[a], color =  shQuote(names(Runs_Sample_23_10_2[[j]])[a])))
}

if (names(Runs_Sample_23_10_2[[j]][7]) != "Ca43") {stop(paste0("Wrong element! ", names(Runs_Sample_23_10_2[[j]][7]), " for Runs_Sample_23_10_2_", j))} # Ca43

Time_length <- length(Runs_Sample_23_10_2[[j]]$`Time [Sec]`)

Delta_Ca_dataframe <- data.frame(Delta_Ca = as.numeric(rep(NA, Time_length+14)),
                                 Time = c(Runs_Sample_23_10_2[[j]]$`Time [Sec]`,rep(NA,14))
                                  )

# Rolling 4 step difference
for(x in 1:length(Runs_Sample_23_10_2[[j]]$`Time [Sec]`)) {
Delta_Ca <- (Runs_Sample_23_10_2[[j]]$Ca43[x+3] - Runs_Sample_23_10_2[[j]]$Ca43[x])/(Runs_Sample_23_10_2[[j]]$`Time [Sec]`[x+3] - Runs_Sample_23_10_2[[j]]$`Time [Sec]`[x])
  Delta_Ca_dataframe$Delta_Ca[x+3]  <- ceiling(Delta_Ca)
  Delta_Ca_dataframe
}

Cut_off1 <- max(Delta_Ca_dataframe[which(Delta_Ca_dataframe$Time <= 50),]$Delta_Ca, na.rm = T)
# In case there is a jump in the calcium at the exterior of the coral (due to calcification boundary)
Cut_off2 <- min(Delta_Ca_dataframe[which(Delta_Ca_dataframe$Time >= max(Delta_Ca_dataframe$Time, na.rm = T)/2),]$Delta_Ca, na.rm = T)
Pre_blank_cut_off <- Delta_Ca_dataframe[which(Delta_Ca_dataframe$Delta_Ca == Cut_off1),]$Time
Post_blank_cut_off <- Delta_Ca_dataframe[which(Delta_Ca_dataframe$Delta_Ca == Cut_off2),]$Time

datapoints_graph <- datapoints + 
  geom_vline(xintercept = 0) +
  geom_vline(xintercept = 30.5) + # preblank cut off
  geom_vline(xintercept = max(Runs_Sample_23_10_2[[j]]$`Time [Sec]`, na.rm = T)) +
  geom_vline(xintercept = max(Runs_Sample_23_10_2[[j]]$`Time [Sec]`, na.rm = T)-45) + #postblank cut off
  geom_vline(xintercept = Pre_blank_cut_off, linetype = 2) + # start of analysis
  geom_vline(xintercept = Post_blank_cut_off-2, linetype = 2) + # end of analysis
  scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
                labels = trans_format("log10", math_format(10^.x))) +
  annotation_logticks(sides = "l") +
  annotate("text", x = 100, y = 100, hjust = 1, vjust = 2, label = names(Runs_Sample_23_10_2[j]), col = "black") +
  ylab("Signal") +
  scale_fill_discrete(name = "Element") +
  theme_classic()

assign(paste0(names(Runs_Sample_23_10_2[j]), "_Elementsignals"), datapoints_graph)
Elementdata_Sample_23_10_2[[paste0(names(Runs_Sample_23_10_2[j]), "_Elementsignals")]] <- datapoints_graph

Preblank <- Runs_Sample_23_10_2[[j]] %>%
  filter(`Time [Sec]` <= 30.5) %>%
  mutate( across(all_of(c(2:11)), ~ ., .names = "{col}_preblank"))

Postblank <- Runs_Sample_23_10_2[[j]] %>%
  filter(`Time [Sec]` >= max(`Time [Sec]`, na.rm = T)-45) %>%
  mutate(across(all_of(c(2:11)), ~ ., .names = "{col}_postblank"))

Allblanks <- full_join(Preblank, Postblank)

Analysis <- Runs_Sample_23_10_2[[j]] %>%
  filter(`Time [Sec]` >= Pre_blank_cut_off & `Time [Sec]` <= Post_blank_cut_off) %>% 
  mutate(across(all_of(c(2:11)), ~ ., .names = "{col}_analysis"))

Analysis_full <- full_join(full_join(Allblanks, Analysis), Runs_Sample_23_10_2[[j]])
Analysis_full <- Analysis_full[order(Analysis_full$`Time [Sec]`),]
row.names(Analysis_full) <- NULL

Data_averages <- Analysis_full %>%
  summarise(across(all_of(c(12:41)), 
                   ~c(sum(!is.na(.x)),
                      mean(.x, na.rm = T), 
                   (sd(.x, na.rm = T)*2),
                   (sd(.x, na.rm = T)*2)/(mean(.x, na.rm = T))*100,
                   (sd(.x, na.rm = T)*3),
                   ((sd(.x, na.rm = T)*2)/sqrt(((sum(!is.na(.x)))-1))),
                   (((sd(.x, na.rm = T)*2)/sqrt(((sum(!is.na(.x)))-1))))/(mean(.x, na.rm = T))*100
                   )
                   )
            ) %>%
    add_column(Calculation = c("n", "mean", "2sd","2sd %","3sd", "2se", "2se%"), .before = "Li7_preblank")

cutoffs_table <- data.frame()

for(i in 12:ncol(Analysis_full)) {
 cutoffs <- Analysis_full[i] %>%
  filter(Analysis_full[i] < (mean(Analysis_full[[i]], na.rm = T) + (sd(Analysis_full[[i]], na.rm = T)*2)) &
           Analysis_full[i] > (mean(Analysis_full[[i]], na.rm = T) - (sd(Analysis_full[[i]], na.rm = T)*2)))
 meancutoffs <- mean(cutoffs[,1])
 print(meancutoffs)
 meancutoffs_data <- data.frame(variable = colnames(Analysis_full[i]),
                                mean2sd = meancutoffs)
 colnames(meancutoffs_data) <- c("variable", "mean2sd")
 cutoffs_table <- rbind(cutoffs_table, meancutoffs_data)
}

cutoffs_table <- cutoffs_table %>%
  rotate_df(rn = "Calculation", cn = T)

Data_averages_V2 <- full_join(cutoffs_table, Data_averages)

# starting the blank correction
Blankcorrections <- Analysis_full %>%
  dplyr::select(1,32:41) %>%
  mutate(
    Li7_analysis_blankcorrected = (Li7_analysis-(mean(Data_averages_V2$Li7_preblank[3],Data_averages_V2$Li7_postblank[3]))),
    B11_analysis_blankcorrected = (B11_analysis-(mean(Data_averages_V2$B11_preblank[3],Data_averages_V2$B11_postblank[3]))),
    Mg24_analysis_blankcorrected = (Mg24_analysis-(mean(Data_averages_V2$Mg24_preblank[3],Data_averages_V2$Mg24_postblank[3]))),
    P31_analysis_blankcorrected = (P31_analysis-(mean(Data_averages_V2$P31_preblank[3],Data_averages_V2$P31_postblank[3]))),
    S34_analysis_blankcorrected = (S34_analysis-(mean(Data_averages_V2$S34_preblank[3],Data_averages_V2$S34_postblank[3]))),
    Ca43_analysis_blankcorrected = (Ca43_analysis-(mean(Data_averages_V2$Ca43_preblank[3],Data_averages_V2$Ca43_postblank[3]))),
    Mn55_analysis_blankcorrected = (Mn55_analysis-(mean(Data_averages_V2$Mn55_preblank[3],Data_averages_V2$Mn55_postblank[3]))),
    Sr86_analysis_blankcorrected = (Sr86_analysis-(mean(Data_averages_V2$Sr86_preblank[3],Data_averages_V2$Sr86_postblank[3]))),
    Ba137_analysis_blankcorrected = (Ba137_analysis-(mean(Data_averages_V2$Ba137_preblank[3],Data_averages_V2$Ba137_postblank[3]))),
    U238_analysis_blankcorrected = (U238_analysis-(mean(Data_averages_V2$U238_preblank[3],Data_averages_V2$U238_postblank[3]))),
  )

Blankcorrections_ratios <- Blankcorrections %>%
  mutate(
    Li_Ca = Li7_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    B_Ca = B11_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    Mg_Ca = Mg24_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    P_Ca = P31_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    S_Ca = S34_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    Mn_Ca = Mn55_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    Sr_Ca = Sr86_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    Ba_Ca = Ba137_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    U_Ca = U238_analysis_blankcorrected/Ca43_analysis_blankcorrected
  )


Li_Ca <- ggplot() +
  geom_point(aes_(Blankcorrections_ratios$`Time [Sec]`,Blankcorrections_ratios$Li_Ca)) + 
  annotate("text", x = Inf, y = Inf, hjust = 1, vjust = 2, label = "Blank corrected", col = "red") +
  annotate("text", x = -Inf, y = Inf, hjust = -.25, vjust = 2, label = names(Runs_Sample_23_10_2[j]), col = "black") +
  lims(y =c (0,0.0005))

assign(paste0(names(Runs_Sample_23_10_2[j]), "_Li/Ca ratio"), Li_Ca)
Li_Ca_ratios_Sample_23_10_2[[paste0(names(Runs_Sample_23_10_2[j]), "_Li/Ca ratio")]] <- Li_Ca

Analysis_full_blankcorrections_ratios <- full_join(Analysis_full, Blankcorrections_ratios)
assign(paste0(names(Runs_Sample_23_10_2[j]), "_Analysis table"), Analysis_full_blankcorrections_ratios)
Analysis_Sample_23_10_2[[paste0(names(Runs_Sample_23_10_2[j]), "_Analysis table")]] <- Analysis_full_blankcorrections_ratios

Data_averages <- Analysis_full_blankcorrections_ratios %>%
  summarise(across(all_of(c(12:60)), 
                   ~c(sum(!is.na(.x)),
                      mean(.x, na.rm = T), 
                   (sd(.x, na.rm = T)*2),
                   (sd(.x, na.rm = T)*2)/(mean(.x, na.rm = T))*100,
                   (sd(.x, na.rm = T)*3),
                   ((sd(.x, na.rm = T)*2)/sqrt(((sum(!is.na(.x)))-1))),
                   (((sd(.x, na.rm = T)*2)/sqrt(((sum(!is.na(.x)))-1))))/(mean(.x, na.rm = T))*100
                   )
                   )
            ) %>%
    add_column(Calculation = c("n", "mean", "2sd","2sd %","3sd", "2se", "2se%"), .before = "Li7_preblank")

cutoffs_table <- data.frame()

for(i in 12:ncol(Analysis_full_blankcorrections_ratios)) {
 cutoffs <- Analysis_full_blankcorrections_ratios[i] %>%
  filter(Analysis_full_blankcorrections_ratios[i] < (mean(Analysis_full_blankcorrections_ratios[[i]], na.rm = T) + (sd(Analysis_full_blankcorrections_ratios[[i]], na.rm = T)*2)) &
           Analysis_full_blankcorrections_ratios[i] > (mean(Analysis_full_blankcorrections_ratios[[i]], na.rm = T) - (sd(Analysis_full_blankcorrections_ratios[[i]], na.rm = T)*2)))
 meancutoffs <- mean(cutoffs[,1])
 print(meancutoffs)
 meancutoffs_data <- data.frame(variable = colnames(Analysis_full_blankcorrections_ratios[i]),
                                mean2sd = meancutoffs)
 colnames(meancutoffs_data) <- c("variable", "mean2sd")
 cutoffs_table <- rbind(cutoffs_table, meancutoffs_data)
}

cutoffs_table <- cutoffs_table %>%
  rotate_df(rn = "Calculation", cn = T)

Data_averages_V2 <- full_join(cutoffs_table, Data_averages)
assign(paste0(names(Runs_Sample_23_10_2[j]), "_Calculations"), Data_averages_V2)
Calculations_Sample_23_10_2[[paste0(names(Runs_Sample_23_10_2[j]), "_Calculations")]] <- Data_averages_V2

}

plot_a_list(Elementdata_Sample_23_10_2, 2,3)

ggsave(
  "Sample_23_10_2_Element_Signals.tiff",
  plot = last_plot(),
  device = "tiff",
  path = Signals_graph_folder,
  scale = 1,
  width = 50,
  height = 20,
  units = "cm",
  dpi = 300,
  bg = NULL
)

# Samples code - first sample (23-10_3) ####
Analysis_Sample_23_10_3 <- list()
Calculations_Sample_23_10_3 <- list()
Elementdata_Sample_23_10_3 <- list()
Li_Ca_ratios_Sample_23_10_3 <- list()
j <- 1
for (j in 1:length(Runs_Sample_23_10_3)) {

nc<-wes_palette(length(names(Runs_Sample_23_10_3[[j]][2:11])), name="Darjeeling1", type="continuous")
datapoints <- ggplot(data = Runs_Sample_23_10_3[[j]], aes(x = `Time [Sec]`)) 

for (a in 2:11) {
  datapoints <- datapoints + geom_line(aes_string(y = names(Runs_Sample_23_10_3[[j]])[a], color =  shQuote(names(Runs_Sample_23_10_3[[j]])[a])))
}

if (names(Runs_Sample_23_10_3[[j]][7]) != "Ca43") {stop(paste0("Wrong element! ", names(Runs_Sample_23_10_3[[j]][7]), " for Runs_Sample_23_10_3_", j))} # Ca43

Time_length <- length(Runs_Sample_23_10_3[[j]]$`Time [Sec]`)

Delta_Ca_dataframe <- data.frame(Delta_Ca = as.numeric(rep(NA, Time_length+14)),
                                 Time = c(Runs_Sample_23_10_3[[j]]$`Time [Sec]`,rep(NA,14))
                                  )

# Rolling 4 step difference
for(x in 1:length(Runs_Sample_23_10_3[[j]]$`Time [Sec]`)) {
Delta_Ca <- (Runs_Sample_23_10_3[[j]]$Ca43[x+3] - Runs_Sample_23_10_3[[j]]$Ca43[x])/(Runs_Sample_23_10_3[[j]]$`Time [Sec]`[x+3] - Runs_Sample_23_10_3[[j]]$`Time [Sec]`[x])
  Delta_Ca_dataframe$Delta_Ca[x+3]  <- ceiling(Delta_Ca)
  Delta_Ca_dataframe
}

Cut_off1 <- max(Delta_Ca_dataframe[which(Delta_Ca_dataframe$Time <= 50),]$Delta_Ca, na.rm = T)
# In case there is a jump in the calcium at the exterior of the coral (due to calcification boundary)
Cut_off2 <- min(Delta_Ca_dataframe[which(Delta_Ca_dataframe$Time >= max(Delta_Ca_dataframe$Time, na.rm = T)/2),]$Delta_Ca, na.rm = T)
Pre_blank_cut_off <- Delta_Ca_dataframe[which(Delta_Ca_dataframe$Delta_Ca == Cut_off1),]$Time
Post_blank_cut_off <- Delta_Ca_dataframe[which(Delta_Ca_dataframe$Delta_Ca == Cut_off2),]$Time

datapoints_graph <- datapoints + 
  geom_vline(xintercept = 0) +
  geom_vline(xintercept = 30.5) + # preblank cut off
  geom_vline(xintercept = max(Runs_Sample_23_10_3[[j]]$`Time [Sec]`, na.rm = T)) +
  geom_vline(xintercept = max(Runs_Sample_23_10_3[[j]]$`Time [Sec]`, na.rm = T)-45) + #postblank cut off
  geom_vline(xintercept = Pre_blank_cut_off, linetype = 2) + # start of analysis
  geom_vline(xintercept = Post_blank_cut_off-2, linetype = 2) + # end of analysis
  scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
                labels = trans_format("log10", math_format(10^.x))) +
  annotation_logticks(sides = "l") +
  annotate("text", x = 100, y = 100, hjust = 1, vjust = 2, label = names(Runs_Sample_23_10_3[j]), col = "black") +
  ylab("Signal") +
  scale_fill_discrete(name = "Element") +
  theme_classic()

assign(paste0(names(Runs_Sample_23_10_3[j]), "_Elementsignals"), datapoints_graph)
Elementdata_Sample_23_10_3[[paste0(names(Runs_Sample_23_10_3[j]), "_Elementsignals")]] <- datapoints_graph

Preblank <- Runs_Sample_23_10_3[[j]] %>%
  filter(`Time [Sec]` <= 30.5) %>%
  mutate( across(all_of(c(2:11)), ~ ., .names = "{col}_preblank"))

Postblank <- Runs_Sample_23_10_3[[j]] %>%
  filter(`Time [Sec]` >= max(`Time [Sec]`, na.rm = T)-45) %>%
  mutate(across(all_of(c(2:11)), ~ ., .names = "{col}_postblank"))

Allblanks <- full_join(Preblank, Postblank)

Analysis <- Runs_Sample_23_10_3[[j]] %>%
  filter(`Time [Sec]` >= Pre_blank_cut_off & `Time [Sec]` <= Post_blank_cut_off) %>% 
  mutate(across(all_of(c(2:11)), ~ ., .names = "{col}_analysis"))

Analysis_full <- full_join(full_join(Allblanks, Analysis), Runs_Sample_23_10_3[[j]])
Analysis_full <- Analysis_full[order(Analysis_full$`Time [Sec]`),]
row.names(Analysis_full) <- NULL

Data_averages <- Analysis_full %>%
  summarise(across(all_of(c(12:41)), 
                   ~c(sum(!is.na(.x)),
                      mean(.x, na.rm = T), 
                   (sd(.x, na.rm = T)*2),
                   (sd(.x, na.rm = T)*2)/(mean(.x, na.rm = T))*100,
                   (sd(.x, na.rm = T)*3),
                   ((sd(.x, na.rm = T)*2)/sqrt(((sum(!is.na(.x)))-1))),
                   (((sd(.x, na.rm = T)*2)/sqrt(((sum(!is.na(.x)))-1))))/(mean(.x, na.rm = T))*100
                   )
                   )
            ) %>%
    add_column(Calculation = c("n", "mean", "2sd","2sd %","3sd", "2se", "2se%"), .before = "Li7_preblank")

cutoffs_table <- data.frame()

for(i in 12:ncol(Analysis_full)) {
 cutoffs <- Analysis_full[i] %>%
  filter(Analysis_full[i] < (mean(Analysis_full[[i]], na.rm = T) + (sd(Analysis_full[[i]], na.rm = T)*2)) &
           Analysis_full[i] > (mean(Analysis_full[[i]], na.rm = T) - (sd(Analysis_full[[i]], na.rm = T)*2)))
 meancutoffs <- mean(cutoffs[,1])
 print(meancutoffs)
 meancutoffs_data <- data.frame(variable = colnames(Analysis_full[i]),
                                mean2sd = meancutoffs)
 colnames(meancutoffs_data) <- c("variable", "mean2sd")
 cutoffs_table <- rbind(cutoffs_table, meancutoffs_data)
}

cutoffs_table <- cutoffs_table %>%
  rotate_df(rn = "Calculation", cn = T)

Data_averages_V2 <- full_join(cutoffs_table, Data_averages)

# starting the blank correction
Blankcorrections <- Analysis_full %>%
  dplyr::select(1,32:41) %>%
  mutate(
    Li7_analysis_blankcorrected = (Li7_analysis-(mean(Data_averages_V2$Li7_preblank[3],Data_averages_V2$Li7_postblank[3]))),
    B11_analysis_blankcorrected = (B11_analysis-(mean(Data_averages_V2$B11_preblank[3],Data_averages_V2$B11_postblank[3]))),
    Mg24_analysis_blankcorrected = (Mg24_analysis-(mean(Data_averages_V2$Mg24_preblank[3],Data_averages_V2$Mg24_postblank[3]))),
    P31_analysis_blankcorrected = (P31_analysis-(mean(Data_averages_V2$P31_preblank[3],Data_averages_V2$P31_postblank[3]))),
    S34_analysis_blankcorrected = (S34_analysis-(mean(Data_averages_V2$S34_preblank[3],Data_averages_V2$S34_postblank[3]))),
    Ca43_analysis_blankcorrected = (Ca43_analysis-(mean(Data_averages_V2$Ca43_preblank[3],Data_averages_V2$Ca43_postblank[3]))),
    Mn55_analysis_blankcorrected = (Mn55_analysis-(mean(Data_averages_V2$Mn55_preblank[3],Data_averages_V2$Mn55_postblank[3]))),
    Sr86_analysis_blankcorrected = (Sr86_analysis-(mean(Data_averages_V2$Sr86_preblank[3],Data_averages_V2$Sr86_postblank[3]))),
    Ba137_analysis_blankcorrected = (Ba137_analysis-(mean(Data_averages_V2$Ba137_preblank[3],Data_averages_V2$Ba137_postblank[3]))),
    U238_analysis_blankcorrected = (U238_analysis-(mean(Data_averages_V2$U238_preblank[3],Data_averages_V2$U238_postblank[3]))),
  )

Blankcorrections_ratios <- Blankcorrections %>%
  mutate(
    Li_Ca = Li7_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    B_Ca = B11_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    Mg_Ca = Mg24_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    P_Ca = P31_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    S_Ca = S34_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    Mn_Ca = Mn55_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    Sr_Ca = Sr86_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    Ba_Ca = Ba137_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    U_Ca = U238_analysis_blankcorrected/Ca43_analysis_blankcorrected
  )


Li_Ca <- ggplot() +
  geom_point(aes_(Blankcorrections_ratios$`Time [Sec]`,Blankcorrections_ratios$Li_Ca)) + 
  annotate("text", x = Inf, y = Inf, hjust = 1, vjust = 2, label = "Blank corrected", col = "red") +
  annotate("text", x = -Inf, y = Inf, hjust = -.25, vjust = 2, label = names(Runs_Sample_23_10_3[j]), col = "black") +
  lims(y =c (0,0.0005))

assign(paste0(names(Runs_Sample_23_10_3[j]), "_Li/Ca ratio"), Li_Ca)
Li_Ca_ratios_Sample_23_10_3[[paste0(names(Runs_Sample_23_10_3[j]), "_Li/Ca ratio")]] <- Li_Ca

Analysis_full_blankcorrections_ratios <- full_join(Analysis_full, Blankcorrections_ratios)
assign(paste0(names(Runs_Sample_23_10_3[j]), "_Analysis table"), Analysis_full_blankcorrections_ratios)
Analysis_Sample_23_10_3[[paste0(names(Runs_Sample_23_10_3[j]), "_Analysis table")]] <- Analysis_full_blankcorrections_ratios

Data_averages <- Analysis_full_blankcorrections_ratios %>%
  summarise(across(all_of(c(12:60)), 
                   ~c(sum(!is.na(.x)),
                      mean(.x, na.rm = T), 
                   (sd(.x, na.rm = T)*2),
                   (sd(.x, na.rm = T)*2)/(mean(.x, na.rm = T))*100,
                   (sd(.x, na.rm = T)*3),
                   ((sd(.x, na.rm = T)*2)/sqrt(((sum(!is.na(.x)))-1))),
                   (((sd(.x, na.rm = T)*2)/sqrt(((sum(!is.na(.x)))-1))))/(mean(.x, na.rm = T))*100
                   )
                   )
            ) %>%
    add_column(Calculation = c("n", "mean", "2sd","2sd %","3sd", "2se", "2se%"), .before = "Li7_preblank")

cutoffs_table <- data.frame()

for(i in 12:ncol(Analysis_full_blankcorrections_ratios)) {
 cutoffs <- Analysis_full_blankcorrections_ratios[i] %>%
  filter(Analysis_full_blankcorrections_ratios[i] < (mean(Analysis_full_blankcorrections_ratios[[i]], na.rm = T) + (sd(Analysis_full_blankcorrections_ratios[[i]], na.rm = T)*2)) &
           Analysis_full_blankcorrections_ratios[i] > (mean(Analysis_full_blankcorrections_ratios[[i]], na.rm = T) - (sd(Analysis_full_blankcorrections_ratios[[i]], na.rm = T)*2)))
 meancutoffs <- mean(cutoffs[,1])
 print(meancutoffs)
 meancutoffs_data <- data.frame(variable = colnames(Analysis_full_blankcorrections_ratios[i]),
                                mean2sd = meancutoffs)
 colnames(meancutoffs_data) <- c("variable", "mean2sd")
 cutoffs_table <- rbind(cutoffs_table, meancutoffs_data)
}

cutoffs_table <- cutoffs_table %>%
  rotate_df(rn = "Calculation", cn = T)

Data_averages_V2 <- full_join(cutoffs_table, Data_averages)
assign(paste0(names(Runs_Sample_23_10_3[j]), "_Calculations"), Data_averages_V2)
Calculations_Sample_23_10_3[[paste0(names(Runs_Sample_23_10_3[j]), "_Calculations")]] <- Data_averages_V2

}


plot_a_list(Elementdata_Sample_23_10_3, 2,3)

ggsave(
  "Sample_23_10_3_Element_Signals.tiff",
  plot = last_plot(),
  device = "tiff",
  path = Signals_graph_folder,
  scale = 1,
  width = 50,
  height = 20,
  units = "cm",
  dpi = 300,
  bg = NULL
)

plot_a_list(Li_Ca_ratios_Sample_23_10_3, 5,1, ylim = c(0,.005), xlim = c(0,200))

# Samples code - first sample (23-6_1) ####
Analysis_Sample_23_6_1 <- list()
Calculations_Sample_23_6_1 <- list()
Elementdata_Sample_23_6_1 <- list()
Li_Ca_ratios_Sample_23_6_1 <- list()
j <- 1
for (j in 1:length(Runs_Sample_23_6_1)) {

nc<-wes_palette(length(names(Runs_Sample_23_6_1[[j]][2:11])), name="Darjeeling1", type="continuous")
datapoints <- ggplot(data = Runs_Sample_23_6_1[[j]], aes(x = `Time [Sec]`)) 

for (a in 2:11) {
  datapoints <- datapoints + geom_line(aes_string(y = names(Runs_Sample_23_6_1[[j]])[a], color =  shQuote(names(Runs_Sample_23_6_1[[j]])[a])))
}

if (names(Runs_Sample_23_6_1[[j]][7]) != "Ca43") {stop(paste0("Wrong element! ", names(Runs_Sample_23_6_1[[j]][7]), " for Runs_Sample_23_6_1_", j))} # Ca43

Time_length <- length(Runs_Sample_23_6_1[[j]]$`Time [Sec]`)

Delta_Ca_dataframe <- data.frame(Delta_Ca = as.numeric(rep(NA, Time_length+14)),
                                 Time = c(Runs_Sample_23_6_1[[j]]$`Time [Sec]`,rep(NA,14))
                                  )

# Rolling 4 step difference
for(x in 1:length(Runs_Sample_23_6_1[[j]]$`Time [Sec]`)) {
Delta_Ca <- (Runs_Sample_23_6_1[[j]]$Ca43[x+3] - Runs_Sample_23_6_1[[j]]$Ca43[x])/(Runs_Sample_23_6_1[[j]]$`Time [Sec]`[x+3] - Runs_Sample_23_6_1[[j]]$`Time [Sec]`[x])
  Delta_Ca_dataframe$Delta_Ca[x+3]  <- ceiling(Delta_Ca)
  Delta_Ca_dataframe
}

Cut_off1 <- max(Delta_Ca_dataframe[which(Delta_Ca_dataframe$Time <= 50),]$Delta_Ca, na.rm = T)
# In case there is a jump in the calcium at the exterior of the coral (due to calcification boundary)
Cut_off2 <- min(Delta_Ca_dataframe[which(Delta_Ca_dataframe$Time >= max(Delta_Ca_dataframe$Time, na.rm = T)/2),]$Delta_Ca, na.rm = T)
Pre_blank_cut_off <- Delta_Ca_dataframe[which(Delta_Ca_dataframe$Delta_Ca == Cut_off1),]$Time
Post_blank_cut_off <- Delta_Ca_dataframe[which(Delta_Ca_dataframe$Delta_Ca == Cut_off2),]$Time

datapoints_graph <- datapoints + 
  geom_vline(xintercept = 0) +
  geom_vline(xintercept = 30.5) + # preblank cut off
  geom_vline(xintercept = max(Runs_Sample_23_6_1[[j]]$`Time [Sec]`, na.rm = T)) +
  geom_vline(xintercept = max(Runs_Sample_23_6_1[[j]]$`Time [Sec]`, na.rm = T)-45) + #postblank cut off
  geom_vline(xintercept = Pre_blank_cut_off, linetype = 2) + # start of analysis
  geom_vline(xintercept = Post_blank_cut_off-2, linetype = 2) + # end of analysis
  scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
                labels = trans_format("log10", math_format(10^.x))) +
  annotation_logticks(sides = "l") +
  annotate("text", x = 100, y = 100, hjust = 1, vjust = 2, label = names(Runs_Sample_23_6_1[j]), col = "black") +
  ylab("Signal") +
  scale_fill_discrete(name = "Element") +
  theme_classic()

assign(paste0(names(Runs_Sample_23_6_1[j]), "_Elementsignals"), datapoints_graph)
Elementdata_Sample_23_6_1[[paste0(names(Runs_Sample_23_6_1[j]), "_Elementsignals")]] <- datapoints_graph

Preblank <- Runs_Sample_23_6_1[[j]] %>%
  filter(`Time [Sec]` <= 30.5) %>%
  mutate( across(all_of(c(2:11)), ~ ., .names = "{col}_preblank"))

Postblank <- Runs_Sample_23_6_1[[j]] %>%
  filter(`Time [Sec]` >= max(`Time [Sec]`, na.rm = T)-45) %>%
  mutate(across(all_of(c(2:11)), ~ ., .names = "{col}_postblank"))

Allblanks <- full_join(Preblank, Postblank)

Analysis <- Runs_Sample_23_6_1[[j]] %>%
  filter(`Time [Sec]` >= Pre_blank_cut_off & `Time [Sec]` <= Post_blank_cut_off) %>% 
  mutate(across(all_of(c(2:11)), ~ ., .names = "{col}_analysis"))

Analysis_full <- full_join(full_join(Allblanks, Analysis), Runs_Sample_23_6_1[[j]])
Analysis_full <- Analysis_full[order(Analysis_full$`Time [Sec]`),]
row.names(Analysis_full) <- NULL

Data_averages <- Analysis_full %>%
  summarise(across(all_of(c(12:41)), 
                   ~c(sum(!is.na(.x)),
                      mean(.x, na.rm = T), 
                   (sd(.x, na.rm = T)*2),
                   (sd(.x, na.rm = T)*2)/(mean(.x, na.rm = T))*100,
                   (sd(.x, na.rm = T)*3),
                   ((sd(.x, na.rm = T)*2)/sqrt(((sum(!is.na(.x)))-1))),
                   (((sd(.x, na.rm = T)*2)/sqrt(((sum(!is.na(.x)))-1))))/(mean(.x, na.rm = T))*100
                   )
                   )
            ) %>%
    add_column(Calculation = c("n", "mean", "2sd","2sd %","3sd", "2se", "2se%"), .before = "Li7_preblank")

cutoffs_table <- data.frame()

for(i in 12:ncol(Analysis_full)) {
 cutoffs <- Analysis_full[i] %>%
  filter(Analysis_full[i] < (mean(Analysis_full[[i]], na.rm = T) + (sd(Analysis_full[[i]], na.rm = T)*2)) &
           Analysis_full[i] > (mean(Analysis_full[[i]], na.rm = T) - (sd(Analysis_full[[i]], na.rm = T)*2)))
 meancutoffs <- mean(cutoffs[,1])
 print(meancutoffs)
 meancutoffs_data <- data.frame(variable = colnames(Analysis_full[i]),
                                mean2sd = meancutoffs)
 colnames(meancutoffs_data) <- c("variable", "mean2sd")
 cutoffs_table <- rbind(cutoffs_table, meancutoffs_data)
}

cutoffs_table <- cutoffs_table %>%
  rotate_df(rn = "Calculation", cn = T)

Data_averages_V2 <- full_join(cutoffs_table, Data_averages)

# starting the blank correction
Blankcorrections <- Analysis_full %>%
  dplyr::select(1,32:41) %>%
  mutate(
    Li7_analysis_blankcorrected = (Li7_analysis-(mean(Data_averages_V2$Li7_preblank[3],Data_averages_V2$Li7_postblank[3]))),
    B11_analysis_blankcorrected = (B11_analysis-(mean(Data_averages_V2$B11_preblank[3],Data_averages_V2$B11_postblank[3]))),
    Mg24_analysis_blankcorrected = (Mg24_analysis-(mean(Data_averages_V2$Mg24_preblank[3],Data_averages_V2$Mg24_postblank[3]))),
    P31_analysis_blankcorrected = (P31_analysis-(mean(Data_averages_V2$P31_preblank[3],Data_averages_V2$P31_postblank[3]))),
    S34_analysis_blankcorrected = (S34_analysis-(mean(Data_averages_V2$S34_preblank[3],Data_averages_V2$S34_postblank[3]))),
    Ca43_analysis_blankcorrected = (Ca43_analysis-(mean(Data_averages_V2$Ca43_preblank[3],Data_averages_V2$Ca43_postblank[3]))),
    Mn55_analysis_blankcorrected = (Mn55_analysis-(mean(Data_averages_V2$Mn55_preblank[3],Data_averages_V2$Mn55_postblank[3]))),
    Sr86_analysis_blankcorrected = (Sr86_analysis-(mean(Data_averages_V2$Sr86_preblank[3],Data_averages_V2$Sr86_postblank[3]))),
    Ba137_analysis_blankcorrected = (Ba137_analysis-(mean(Data_averages_V2$Ba137_preblank[3],Data_averages_V2$Ba137_postblank[3]))),
    U238_analysis_blankcorrected = (U238_analysis-(mean(Data_averages_V2$U238_preblank[3],Data_averages_V2$U238_postblank[3]))),
  )

Blankcorrections_ratios <- Blankcorrections %>%
  mutate(
    Li_Ca = Li7_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    B_Ca = B11_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    Mg_Ca = Mg24_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    P_Ca = P31_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    S_Ca = S34_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    Mn_Ca = Mn55_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    Sr_Ca = Sr86_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    Ba_Ca = Ba137_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    U_Ca = U238_analysis_blankcorrected/Ca43_analysis_blankcorrected
  )


Li_Ca <- ggplot() +
  geom_point(aes_(Blankcorrections_ratios$`Time [Sec]`,Blankcorrections_ratios$Li_Ca)) + 
  annotate("text", x = Inf, y = Inf, hjust = 1, vjust = 2, label = "Blank corrected", col = "red") +
  annotate("text", x = -Inf, y = Inf, hjust = -.25, vjust = 2, label = names(Runs_Sample_23_6_1[j]), col = "black") +
  lims(y =c (0,0.0005))

assign(paste0(names(Runs_Sample_23_6_1[j]), "_Li/Ca ratio"), Li_Ca)
Li_Ca_ratios_Sample_23_6_1[[paste0(names(Runs_Sample_23_6_1[j]), "_Li/Ca ratio")]] <- Li_Ca

Analysis_full_blankcorrections_ratios <- full_join(Analysis_full, Blankcorrections_ratios)
assign(paste0(names(Runs_Sample_23_6_1[j]), "_Analysis table"), Analysis_full_blankcorrections_ratios)
Analysis_Sample_23_6_1[[paste0(names(Runs_Sample_23_6_1[j]), "_Analysis table")]] <- Analysis_full_blankcorrections_ratios

Data_averages <- Analysis_full_blankcorrections_ratios %>%
  summarise(across(all_of(c(12:60)), 
                   ~c(sum(!is.na(.x)),
                      mean(.x, na.rm = T), 
                   (sd(.x, na.rm = T)*2),
                   (sd(.x, na.rm = T)*2)/(mean(.x, na.rm = T))*100,
                   (sd(.x, na.rm = T)*3),
                   ((sd(.x, na.rm = T)*2)/sqrt(((sum(!is.na(.x)))-1))),
                   (((sd(.x, na.rm = T)*2)/sqrt(((sum(!is.na(.x)))-1))))/(mean(.x, na.rm = T))*100
                   )
                   )
            ) %>%
    add_column(Calculation = c("n", "mean", "2sd","2sd %","3sd", "2se", "2se%"), .before = "Li7_preblank")

cutoffs_table <- data.frame()

for(i in 12:ncol(Analysis_full_blankcorrections_ratios)) {
 cutoffs <- Analysis_full_blankcorrections_ratios[i] %>%
  filter(Analysis_full_blankcorrections_ratios[i] < (mean(Analysis_full_blankcorrections_ratios[[i]], na.rm = T) + (sd(Analysis_full_blankcorrections_ratios[[i]], na.rm = T)*2)) &
           Analysis_full_blankcorrections_ratios[i] > (mean(Analysis_full_blankcorrections_ratios[[i]], na.rm = T) - (sd(Analysis_full_blankcorrections_ratios[[i]], na.rm = T)*2)))
 meancutoffs <- mean(cutoffs[,1])
 print(meancutoffs)
 meancutoffs_data <- data.frame(variable = colnames(Analysis_full_blankcorrections_ratios[i]),
                                mean2sd = meancutoffs)
 colnames(meancutoffs_data) <- c("variable", "mean2sd")
 cutoffs_table <- rbind(cutoffs_table, meancutoffs_data)
}

cutoffs_table <- cutoffs_table %>%
  rotate_df(rn = "Calculation", cn = T)

Data_averages_V2 <- full_join(cutoffs_table, Data_averages)
assign(paste0(names(Runs_Sample_23_6_1[j]), "_Calculations"), Data_averages_V2)
Calculations_Sample_23_6_1[[paste0(names(Runs_Sample_23_6_1[j]), "_Calculations")]] <- Data_averages_V2

}

plot_a_list(Elementdata_Sample_23_6_1, 2,3)

ggsave(
  "Sample_23_6_1_Element_Signals.tiff",
  plot = last_plot(),
  device = "tiff",
  path = Signals_graph_folder,
  scale = 1,
  width = 50,
  height = 20,
  units = "cm",
  dpi = 300,
  bg = NULL
)

# Samples code - first sample (23-6_2) ####
Analysis_Sample_23_6_2 <- list()
Calculations_Sample_23_6_2 <- list()
Elementdata_Sample_23_6_2 <- list()
Li_Ca_ratios_Sample_23_6_2 <- list()
j <- 1
for (j in 1:length(Runs_Sample_23_6_2)) {

nc<-wes_palette(length(names(Runs_Sample_23_6_2[[j]][2:11])), name="Darjeeling1", type="continuous")
datapoints <- ggplot(data = Runs_Sample_23_6_2[[j]], aes(x = `Time [Sec]`)) 

for (a in 2:11) {
  datapoints <- datapoints + geom_line(aes_string(y = names(Runs_Sample_23_6_2[[j]])[a], color =  shQuote(names(Runs_Sample_23_6_2[[j]])[a])))
}

if (names(Runs_Sample_23_6_2[[j]][7]) != "Ca43") {stop(paste0("Wrong element! ", names(Runs_Sample_23_6_2[[j]][7]), " for Runs_Sample_23_6_2_", j))} # Ca43

Time_length <- length(Runs_Sample_23_6_2[[j]]$`Time [Sec]`)

Delta_Ca_dataframe <- data.frame(Delta_Ca = as.numeric(rep(NA, Time_length+14)),
                                 Time = c(Runs_Sample_23_6_2[[j]]$`Time [Sec]`,rep(NA,14))
                                  )

# Rolling 4 step difference
for(x in 1:length(Runs_Sample_23_6_2[[j]]$`Time [Sec]`)) {
Delta_Ca <- (Runs_Sample_23_6_2[[j]]$Ca43[x+3] - Runs_Sample_23_6_2[[j]]$Ca43[x])/(Runs_Sample_23_6_2[[j]]$`Time [Sec]`[x+3] - Runs_Sample_23_6_2[[j]]$`Time [Sec]`[x])
  Delta_Ca_dataframe$Delta_Ca[x+3]  <- ceiling(Delta_Ca)
  Delta_Ca_dataframe
}

Cut_off1 <- max(Delta_Ca_dataframe[which(Delta_Ca_dataframe$Time <= 50),]$Delta_Ca, na.rm = T)
# In case there is a jump in the calcium at the exterior of the coral (due to calcification boundary)
Cut_off2 <- min(Delta_Ca_dataframe[which(Delta_Ca_dataframe$Time >= max(Delta_Ca_dataframe$Time, na.rm = T)/2),]$Delta_Ca, na.rm = T)
Pre_blank_cut_off <- Delta_Ca_dataframe[which(Delta_Ca_dataframe$Delta_Ca == Cut_off1),]$Time
Post_blank_cut_off <- Delta_Ca_dataframe[which(Delta_Ca_dataframe$Delta_Ca == Cut_off2),]$Time

datapoints_graph <- datapoints + 
  geom_vline(xintercept = 0) +
  geom_vline(xintercept = 30.5) + # preblank cut off
  geom_vline(xintercept = max(Runs_Sample_23_6_2[[j]]$`Time [Sec]`, na.rm = T)) +
  geom_vline(xintercept = max(Runs_Sample_23_6_2[[j]]$`Time [Sec]`, na.rm = T)-45) + #postblank cut off
  geom_vline(xintercept = Pre_blank_cut_off, linetype = 2) + # start of analysis
  geom_vline(xintercept = Post_blank_cut_off-2, linetype = 2) + # end of analysis
  scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
                labels = trans_format("log10", math_format(10^.x))) +
  annotation_logticks(sides = "l") +
  annotate("text", x = 100, y = 100, hjust = 1, vjust = 2, label = names(Runs_Sample_23_6_2[j]), col = "black") +
  ylab("Signal") +
  scale_fill_discrete(name = "Element") +
  theme_classic()

assign(paste0(names(Runs_Sample_23_6_2[j]), "_Elementsignals"), datapoints_graph)
Elementdata_Sample_23_6_2[[paste0(names(Runs_Sample_23_6_2[j]), "_Elementsignals")]] <- datapoints_graph

Preblank <- Runs_Sample_23_6_2[[j]] %>%
  filter(`Time [Sec]` <= 30.5) %>%
  mutate( across(all_of(c(2:11)), ~ ., .names = "{col}_preblank"))

Postblank <- Runs_Sample_23_6_2[[j]] %>%
  filter(`Time [Sec]` >= max(`Time [Sec]`, na.rm = T)-45) %>%
  mutate(across(all_of(c(2:11)), ~ ., .names = "{col}_postblank"))

Allblanks <- full_join(Preblank, Postblank)

Analysis <- Runs_Sample_23_6_2[[j]] %>%
  filter(`Time [Sec]` >= Pre_blank_cut_off & `Time [Sec]` <= Post_blank_cut_off) %>% 
  mutate(across(all_of(c(2:11)), ~ ., .names = "{col}_analysis"))

Analysis_full <- full_join(full_join(Allblanks, Analysis), Runs_Sample_23_6_2[[j]])
Analysis_full <- Analysis_full[order(Analysis_full$`Time [Sec]`),]
row.names(Analysis_full) <- NULL

Data_averages <- Analysis_full %>%
  summarise(across(all_of(c(12:41)), 
                   ~c(sum(!is.na(.x)),
                      mean(.x, na.rm = T), 
                   (sd(.x, na.rm = T)*2),
                   (sd(.x, na.rm = T)*2)/(mean(.x, na.rm = T))*100,
                   (sd(.x, na.rm = T)*3),
                   ((sd(.x, na.rm = T)*2)/sqrt(((sum(!is.na(.x)))-1))),
                   (((sd(.x, na.rm = T)*2)/sqrt(((sum(!is.na(.x)))-1))))/(mean(.x, na.rm = T))*100
                   )
                   )
            ) %>%
    add_column(Calculation = c("n", "mean", "2sd","2sd %","3sd", "2se", "2se%"), .before = "Li7_preblank")

cutoffs_table <- data.frame()

for(i in 12:ncol(Analysis_full)) {
 cutoffs <- Analysis_full[i] %>%
  filter(Analysis_full[i] < (mean(Analysis_full[[i]], na.rm = T) + (sd(Analysis_full[[i]], na.rm = T)*2)) &
           Analysis_full[i] > (mean(Analysis_full[[i]], na.rm = T) - (sd(Analysis_full[[i]], na.rm = T)*2)))
 meancutoffs <- mean(cutoffs[,1])
 print(meancutoffs)
 meancutoffs_data <- data.frame(variable = colnames(Analysis_full[i]),
                                mean2sd = meancutoffs)
 colnames(meancutoffs_data) <- c("variable", "mean2sd")
 cutoffs_table <- rbind(cutoffs_table, meancutoffs_data)
}

cutoffs_table <- cutoffs_table %>%
  rotate_df(rn = "Calculation", cn = T)

Data_averages_V2 <- full_join(cutoffs_table, Data_averages)

# starting the blank correction
Blankcorrections <- Analysis_full %>%
  dplyr::select(1,32:41) %>%
  mutate(
    Li7_analysis_blankcorrected = (Li7_analysis-(mean(Data_averages_V2$Li7_preblank[3],Data_averages_V2$Li7_postblank[3]))),
    B11_analysis_blankcorrected = (B11_analysis-(mean(Data_averages_V2$B11_preblank[3],Data_averages_V2$B11_postblank[3]))),
    Mg24_analysis_blankcorrected = (Mg24_analysis-(mean(Data_averages_V2$Mg24_preblank[3],Data_averages_V2$Mg24_postblank[3]))),
    P31_analysis_blankcorrected = (P31_analysis-(mean(Data_averages_V2$P31_preblank[3],Data_averages_V2$P31_postblank[3]))),
    S34_analysis_blankcorrected = (S34_analysis-(mean(Data_averages_V2$S34_preblank[3],Data_averages_V2$S34_postblank[3]))),
    Ca43_analysis_blankcorrected = (Ca43_analysis-(mean(Data_averages_V2$Ca43_preblank[3],Data_averages_V2$Ca43_postblank[3]))),
    Mn55_analysis_blankcorrected = (Mn55_analysis-(mean(Data_averages_V2$Mn55_preblank[3],Data_averages_V2$Mn55_postblank[3]))),
    Sr86_analysis_blankcorrected = (Sr86_analysis-(mean(Data_averages_V2$Sr86_preblank[3],Data_averages_V2$Sr86_postblank[3]))),
    Ba137_analysis_blankcorrected = (Ba137_analysis-(mean(Data_averages_V2$Ba137_preblank[3],Data_averages_V2$Ba137_postblank[3]))),
    U238_analysis_blankcorrected = (U238_analysis-(mean(Data_averages_V2$U238_preblank[3],Data_averages_V2$U238_postblank[3]))),
  )

Blankcorrections_ratios <- Blankcorrections %>%
  mutate(
    Li_Ca = Li7_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    B_Ca = B11_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    Mg_Ca = Mg24_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    P_Ca = P31_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    S_Ca = S34_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    Mn_Ca = Mn55_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    Sr_Ca = Sr86_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    Ba_Ca = Ba137_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    U_Ca = U238_analysis_blankcorrected/Ca43_analysis_blankcorrected
  )


Li_Ca <- ggplot() +
  geom_point(aes_(Blankcorrections_ratios$`Time [Sec]`,Blankcorrections_ratios$Li_Ca)) + 
  annotate("text", x = Inf, y = Inf, hjust = 1, vjust = 2, label = "Blank corrected", col = "red") +
  annotate("text", x = -Inf, y = Inf, hjust = -.25, vjust = 2, label = names(Runs_Sample_23_6_2[j]), col = "black") +
  lims(y =c (0,0.0005))

assign(paste0(names(Runs_Sample_23_6_2[j]), "_Li/Ca ratio"), Li_Ca)
Li_Ca_ratios_Sample_23_6_2[[paste0(names(Runs_Sample_23_6_2[j]), "_Li/Ca ratio")]] <- Li_Ca

Analysis_full_blankcorrections_ratios <- full_join(Analysis_full, Blankcorrections_ratios)
assign(paste0(names(Runs_Sample_23_6_2[j]), "_Analysis table"), Analysis_full_blankcorrections_ratios)
Analysis_Sample_23_6_2[[paste0(names(Runs_Sample_23_6_2[j]), "_Analysis table")]] <- Analysis_full_blankcorrections_ratios

Data_averages <- Analysis_full_blankcorrections_ratios %>%
  summarise(across(all_of(c(12:60)), 
                   ~c(sum(!is.na(.x)),
                      mean(.x, na.rm = T), 
                   (sd(.x, na.rm = T)*2),
                   (sd(.x, na.rm = T)*2)/(mean(.x, na.rm = T))*100,
                   (sd(.x, na.rm = T)*3),
                   ((sd(.x, na.rm = T)*2)/sqrt(((sum(!is.na(.x)))-1))),
                   (((sd(.x, na.rm = T)*2)/sqrt(((sum(!is.na(.x)))-1))))/(mean(.x, na.rm = T))*100
                   )
                   )
            ) %>%
    add_column(Calculation = c("n", "mean", "2sd","2sd %","3sd", "2se", "2se%"), .before = "Li7_preblank")

cutoffs_table <- data.frame()

for(i in 12:ncol(Analysis_full_blankcorrections_ratios)) {
 cutoffs <- Analysis_full_blankcorrections_ratios[i] %>%
  filter(Analysis_full_blankcorrections_ratios[i] < (mean(Analysis_full_blankcorrections_ratios[[i]], na.rm = T) + (sd(Analysis_full_blankcorrections_ratios[[i]], na.rm = T)*2)) &
           Analysis_full_blankcorrections_ratios[i] > (mean(Analysis_full_blankcorrections_ratios[[i]], na.rm = T) - (sd(Analysis_full_blankcorrections_ratios[[i]], na.rm = T)*2)))
 meancutoffs <- mean(cutoffs[,1])
 print(meancutoffs)
 meancutoffs_data <- data.frame(variable = colnames(Analysis_full_blankcorrections_ratios[i]),
                                mean2sd = meancutoffs)
 colnames(meancutoffs_data) <- c("variable", "mean2sd")
 cutoffs_table <- rbind(cutoffs_table, meancutoffs_data)
}

cutoffs_table <- cutoffs_table %>%
  rotate_df(rn = "Calculation", cn = T)

Data_averages_V2 <- full_join(cutoffs_table, Data_averages)
assign(paste0(names(Runs_Sample_23_6_2[j]), "_Calculations"), Data_averages_V2)
Calculations_Sample_23_6_2[[paste0(names(Runs_Sample_23_6_2[j]), "_Calculations")]] <- Data_averages_V2

}

plot_a_list(Elementdata_Sample_23_6_2, 2,3)

ggsave(
  "Sample_23_6_2_Element_Signals.tiff",
  plot = last_plot(),
  device = "tiff",
  path = Signals_graph_folder,
  scale = 1,
  width = 50,
  height = 20,
  units = "cm",
  dpi = 300,
  bg = NULL
)

# Samples code - first sample (23-6_3) ####
Analysis_Sample_23_6_3 <- list()
Calculations_Sample_23_6_3 <- list()
Elementdata_Sample_23_6_3 <- list()
Li_Ca_ratios_Sample_23_6_3 <- list()
j <- 1
for (j in 1:length(Runs_Sample_23_6_3)) {

nc<-wes_palette(length(names(Runs_Sample_23_6_3[[j]][2:11])), name="Darjeeling1", type="continuous")
datapoints <- ggplot(data = Runs_Sample_23_6_3[[j]], aes(x = `Time [Sec]`)) 

for (a in 2:11) {
  datapoints <- datapoints + geom_line(aes_string(y = names(Runs_Sample_23_6_3[[j]])[a], color =  shQuote(names(Runs_Sample_23_6_3[[j]])[a])))
}

if (names(Runs_Sample_23_6_3[[j]][7]) != "Ca43") {stop(paste0("Wrong element! ", names(Runs_Sample_23_6_3[[j]][7]), " for Runs_Sample_23_6_3_", j))} # Ca43

Time_length <- length(Runs_Sample_23_6_3[[j]]$`Time [Sec]`)

Delta_Ca_dataframe <- data.frame(Delta_Ca = as.numeric(rep(NA, Time_length+14)),
                                 Time = c(Runs_Sample_23_6_3[[j]]$`Time [Sec]`,rep(NA,14))
                                  )

# Rolling 4 step difference
for(x in 1:length(Runs_Sample_23_6_3[[j]]$`Time [Sec]`)) {
Delta_Ca <- (Runs_Sample_23_6_3[[j]]$Ca43[x+3] - Runs_Sample_23_6_3[[j]]$Ca43[x])/(Runs_Sample_23_6_3[[j]]$`Time [Sec]`[x+3] - Runs_Sample_23_6_3[[j]]$`Time [Sec]`[x])
  Delta_Ca_dataframe$Delta_Ca[x+3]  <- ceiling(Delta_Ca)
  Delta_Ca_dataframe
}

Cut_off1 <- max(Delta_Ca_dataframe[which(Delta_Ca_dataframe$Time <= 50),]$Delta_Ca, na.rm = T)
# In case there is a jump in the calcium at the exterior of the coral (due to calcification boundary)
Cut_off2 <- min(Delta_Ca_dataframe[which(Delta_Ca_dataframe$Time >= max(Delta_Ca_dataframe$Time, na.rm = T)/2),]$Delta_Ca, na.rm = T)
Pre_blank_cut_off <- Delta_Ca_dataframe[which(Delta_Ca_dataframe$Delta_Ca == Cut_off1),]$Time
Post_blank_cut_off <- Delta_Ca_dataframe[which(Delta_Ca_dataframe$Delta_Ca == Cut_off2),]$Time

datapoints_graph <- datapoints + 
  geom_vline(xintercept = 0) +
  geom_vline(xintercept = 30.5) + # preblank cut off
  geom_vline(xintercept = max(Runs_Sample_23_6_3[[j]]$`Time [Sec]`, na.rm = T)) +
  geom_vline(xintercept = max(Runs_Sample_23_6_3[[j]]$`Time [Sec]`, na.rm = T)-45) + #postblank cut off
  geom_vline(xintercept = Pre_blank_cut_off, linetype = 2) + # start of analysis
  geom_vline(xintercept = Post_blank_cut_off-2, linetype = 2) + # end of analysis
  scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
                labels = trans_format("log10", math_format(10^.x))) +
  annotation_logticks(sides = "l") +
  annotate("text", x = 100, y = 100, hjust = 1, vjust = 2, label = names(Runs_Sample_23_6_3[j]), col = "black") +
  ylab("Signal") +
  scale_fill_discrete(name = "Element") +
  theme_classic()

assign(paste0(names(Runs_Sample_23_6_3[j]), "_Elementsignals"), datapoints_graph)
Elementdata_Sample_23_6_3[[paste0(names(Runs_Sample_23_6_3[j]), "_Elementsignals")]] <- datapoints_graph

Preblank <- Runs_Sample_23_6_3[[j]] %>%
  filter(`Time [Sec]` <= 30.5) %>%
  mutate( across(all_of(c(2:11)), ~ ., .names = "{col}_preblank"))

Postblank <- Runs_Sample_23_6_3[[j]] %>%
  filter(`Time [Sec]` >= max(`Time [Sec]`, na.rm = T)-45) %>%
  mutate(across(all_of(c(2:11)), ~ ., .names = "{col}_postblank"))

Allblanks <- full_join(Preblank, Postblank)

Analysis <- Runs_Sample_23_6_3[[j]] %>%
  filter(`Time [Sec]` >= Pre_blank_cut_off & `Time [Sec]` <= Post_blank_cut_off) %>% 
  mutate(across(all_of(c(2:11)), ~ ., .names = "{col}_analysis"))

Analysis_full <- full_join(full_join(Allblanks, Analysis), Runs_Sample_23_6_3[[j]])
Analysis_full <- Analysis_full[order(Analysis_full$`Time [Sec]`),]
row.names(Analysis_full) <- NULL

Data_averages <- Analysis_full %>%
  summarise(across(all_of(c(12:41)), 
                   ~c(sum(!is.na(.x)),
                      mean(.x, na.rm = T), 
                   (sd(.x, na.rm = T)*2),
                   (sd(.x, na.rm = T)*2)/(mean(.x, na.rm = T))*100,
                   (sd(.x, na.rm = T)*3),
                   ((sd(.x, na.rm = T)*2)/sqrt(((sum(!is.na(.x)))-1))),
                   (((sd(.x, na.rm = T)*2)/sqrt(((sum(!is.na(.x)))-1))))/(mean(.x, na.rm = T))*100
                   )
                   )
            ) %>%
    add_column(Calculation = c("n", "mean", "2sd","2sd %","3sd", "2se", "2se%"), .before = "Li7_preblank")

cutoffs_table <- data.frame()

for(i in 12:ncol(Analysis_full)) {
 cutoffs <- Analysis_full[i] %>%
  filter(Analysis_full[i] < (mean(Analysis_full[[i]], na.rm = T) + (sd(Analysis_full[[i]], na.rm = T)*2)) &
           Analysis_full[i] > (mean(Analysis_full[[i]], na.rm = T) - (sd(Analysis_full[[i]], na.rm = T)*2)))
 meancutoffs <- mean(cutoffs[,1])
 print(meancutoffs)
 meancutoffs_data <- data.frame(variable = colnames(Analysis_full[i]),
                                mean2sd = meancutoffs)
 colnames(meancutoffs_data) <- c("variable", "mean2sd")
 cutoffs_table <- rbind(cutoffs_table, meancutoffs_data)
}

cutoffs_table <- cutoffs_table %>%
  rotate_df(rn = "Calculation", cn = T)

Data_averages_V2 <- full_join(cutoffs_table, Data_averages)

# starting the blank correction
Blankcorrections <- Analysis_full %>%
  dplyr::select(1,32:41) %>%
  mutate(
    Li7_analysis_blankcorrected = (Li7_analysis-(mean(Data_averages_V2$Li7_preblank[3],Data_averages_V2$Li7_postblank[3]))),
    B11_analysis_blankcorrected = (B11_analysis-(mean(Data_averages_V2$B11_preblank[3],Data_averages_V2$B11_postblank[3]))),
    Mg24_analysis_blankcorrected = (Mg24_analysis-(mean(Data_averages_V2$Mg24_preblank[3],Data_averages_V2$Mg24_postblank[3]))),
    P31_analysis_blankcorrected = (P31_analysis-(mean(Data_averages_V2$P31_preblank[3],Data_averages_V2$P31_postblank[3]))),
    S34_analysis_blankcorrected = (S34_analysis-(mean(Data_averages_V2$S34_preblank[3],Data_averages_V2$S34_postblank[3]))),
    Ca43_analysis_blankcorrected = (Ca43_analysis-(mean(Data_averages_V2$Ca43_preblank[3],Data_averages_V2$Ca43_postblank[3]))),
    Mn55_analysis_blankcorrected = (Mn55_analysis-(mean(Data_averages_V2$Mn55_preblank[3],Data_averages_V2$Mn55_postblank[3]))),
    Sr86_analysis_blankcorrected = (Sr86_analysis-(mean(Data_averages_V2$Sr86_preblank[3],Data_averages_V2$Sr86_postblank[3]))),
    Ba137_analysis_blankcorrected = (Ba137_analysis-(mean(Data_averages_V2$Ba137_preblank[3],Data_averages_V2$Ba137_postblank[3]))),
    U238_analysis_blankcorrected = (U238_analysis-(mean(Data_averages_V2$U238_preblank[3],Data_averages_V2$U238_postblank[3]))),
  )

Blankcorrections_ratios <- Blankcorrections %>%
  mutate(
    Li_Ca = Li7_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    B_Ca = B11_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    Mg_Ca = Mg24_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    P_Ca = P31_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    S_Ca = S34_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    Mn_Ca = Mn55_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    Sr_Ca = Sr86_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    Ba_Ca = Ba137_analysis_blankcorrected/Ca43_analysis_blankcorrected,
    U_Ca = U238_analysis_blankcorrected/Ca43_analysis_blankcorrected
  )


Li_Ca <- ggplot() +
  geom_point(aes_(Blankcorrections_ratios$`Time [Sec]`,Blankcorrections_ratios$Li_Ca)) + 
  annotate("text", x = Inf, y = Inf, hjust = 1, vjust = 2, label = "Blank corrected", col = "red") +
  annotate("text", x = -Inf, y = Inf, hjust = -.25, vjust = 2, label = names(Runs_Sample_23_6_3[j]), col = "black") +
  lims(y =c (0,0.0005))

assign(paste0(names(Runs_Sample_23_6_3[j]), "_Li/Ca ratio"), Li_Ca)
Li_Ca_ratios_Sample_23_6_3[[paste0(names(Runs_Sample_23_6_3[j]), "_Li/Ca ratio")]] <- Li_Ca

Analysis_full_blankcorrections_ratios <- full_join(Analysis_full, Blankcorrections_ratios)
assign(paste0(names(Runs_Sample_23_6_3[j]), "_Analysis table"), Analysis_full_blankcorrections_ratios)
Analysis_Sample_23_6_3[[paste0(names(Runs_Sample_23_6_3[j]), "_Analysis table")]] <- Analysis_full_blankcorrections_ratios

Data_averages <- Analysis_full_blankcorrections_ratios %>%
  summarise(across(all_of(c(12:60)), 
                   ~c(sum(!is.na(.x)),
                      mean(.x, na.rm = T), 
                   (sd(.x, na.rm = T)*2),
                   (sd(.x, na.rm = T)*2)/(mean(.x, na.rm = T))*100,
                   (sd(.x, na.rm = T)*3),
                   ((sd(.x, na.rm = T)*2)/sqrt(((sum(!is.na(.x)))-1))),
                   (((sd(.x, na.rm = T)*2)/sqrt(((sum(!is.na(.x)))-1))))/(mean(.x, na.rm = T))*100
                   )
                   )
            ) %>%
    add_column(Calculation = c("n", "mean", "2sd","2sd %","3sd", "2se", "2se%"), .before = "Li7_preblank")

cutoffs_table <- data.frame()

for(i in 12:ncol(Analysis_full_blankcorrections_ratios)) {
 cutoffs <- Analysis_full_blankcorrections_ratios[i] %>%
  filter(Analysis_full_blankcorrections_ratios[i] < (mean(Analysis_full_blankcorrections_ratios[[i]], na.rm = T) + (sd(Analysis_full_blankcorrections_ratios[[i]], na.rm = T)*2)) &
           Analysis_full_blankcorrections_ratios[i] > (mean(Analysis_full_blankcorrections_ratios[[i]], na.rm = T) - (sd(Analysis_full_blankcorrections_ratios[[i]], na.rm = T)*2)))
 meancutoffs <- mean(cutoffs[,1])
 print(meancutoffs)
 meancutoffs_data <- data.frame(variable = colnames(Analysis_full_blankcorrections_ratios[i]),
                                mean2sd = meancutoffs)
 colnames(meancutoffs_data) <- c("variable", "mean2sd")
 cutoffs_table <- rbind(cutoffs_table, meancutoffs_data)
}

cutoffs_table <- cutoffs_table %>%
  rotate_df(rn = "Calculation", cn = T)

Data_averages_V2 <- full_join(cutoffs_table, Data_averages)
assign(paste0(names(Runs_Sample_23_6_3[j]), "_Calculations"), Data_averages_V2)
Calculations_Sample_23_6_3[[paste0(names(Runs_Sample_23_6_3[j]), "_Calculations")]] <- Data_averages_V2

}

plot_a_list(Elementdata_Sample_23_6_3, 2,3)

ggsave(
  "Sample_23_6_3_Element_Signals.tiff",
  plot = last_plot(),
  device = "tiff",
  path = Signals_graph_folder,
  scale = 1,
  width = 50,
  height = 20,
  units = "cm",
  dpi = 300,
  bg = NULL
)

plot_a_list(Li_Ca_ratios_Sample_23_6_3, 5,1, ylim = c(0,.005), xlim = c(0,400))

```

```{r JCP corrected ratios - samples and DSC, echo = F, message=T}
i <- 1
JCP_Corrected_DSC <- list()
JCP_Corrected_Sample_23_16_1 <- list()
JCP_Corrected_Sample_23_16_2 <- list()
JCP_Corrected_Sample_23_16_3 <- list()
JCP_Corrected_Sample_23_1_1 <- list()
JCP_Corrected_Sample_23_1_2 <- list()
JCP_Corrected_Sample_23_1_3 <- list()
JCP_Corrected_Sample_23_10_1 <- list()
JCP_Corrected_Sample_23_10_2 <- list()
JCP_Corrected_Sample_23_10_3 <- list()
JCP_Corrected_Sample_23_6_1 <- list()
JCP_Corrected_Sample_23_6_2 <- list()
JCP_Corrected_Sample_23_6_3 <- list()

# remember need to keep all ratios to same unit (Âµmol/mol)
# Mg/Ca JCP constant is in mmol/mol so needs to be multiplied by 1000
# S/Ca JCP constant is in mmol/mol so needs to be multiplied by 1000
# Sr/Ca JCP constant is in mmol/mol so needs to be multiplied by 1000
# U/Ca JCP constant is in nmol/mol so needs to be divided by 1000

# need to change the JCP for each DSC run (i & i +1) #### 
for (i in 1:length(Analysis_DSC)) {
  JCP_corrected_ratios <-
  Analysis_DSC[[i]] %>%
    mutate(
    Li_Ca_MB_corrected = Li_Ca/(mean(c(Calculations_JCP[[i]]$Li_Ca[1],Calculations_JCP[[i+1]]$Li_Ca[1]))/Constants$JCP$Li_Ca[1]),
    B_Ca_MB_corrected = B_Ca/(mean(c(Calculations_JCP[[i]]$B_Ca[1],Calculations_JCP[[i+1]]$B_Ca[1]))/Constants$JCP$B_Ca[1]),
    Mg_Ca_MB_corrected = (Mg_Ca/(mean(c(Calculations_JCP[[i]]$Mg_Ca[1],Calculations_JCP[[i+1]]$Mg_Ca[1]))/Constants$JCP$Mg_Ca[1]))*1000,
    P_Ca_MB_corrected = P_Ca/(mean(c(Calculations_JCP[[i]]$P_Ca[1],Calculations_JCP[[i+1]]$P_Ca[1]))/Constants$JCP$P_Ca[1]),
    S_Ca_MB_corrected = (S_Ca/(mean(c(Calculations_JCP[[i]]$S_Ca[1],Calculations_JCP[[i+1]]$S_Ca[1]))/Constants$JCP$S_Ca[1]))*1000,
    Mn_Ca_MB_corrected = Mn_Ca/(mean(c(Calculations_JCP[[i]]$Mn_Ca[1],Calculations_JCP[[i+1]]$Mn_Ca[1]))/Constants$JCP$Mn_Ca[1]),
    Sr_Ca_MB_corrected = (Sr_Ca/(mean(c(Calculations_JCP[[i]]$Sr_Ca[1],Calculations_JCP[[i+1]]$Sr_Ca[1]))/Constants$JCP$Sr_Ca[1]))*1000,
    Ba_Ca_MB_corrected = Ba_Ca/(mean(c(Calculations_JCP[[i]]$Ba_Ca[1],Calculations_JCP[[i+1]]$Ba_Ca[1]))/Constants$JCP$Ba_Ca[1]),
    U_Ca_MB_corrected = (U_Ca/(mean(c(Calculations_JCP[[i]]$U_Ca[1],Calculations_JCP[[i+1]]$U_Ca[1]))/Constants$JCP$U_Ca[1]))/1000
    )
  
assign(paste0(names(Analysis_DSC[i]), "_JCP_corrected"), JCP_corrected_ratios)
JCP_Corrected_DSC[[paste0(names(Analysis_DSC[i]), "_JCP_corrected")]] <- JCP_corrected_ratios
}
# JCP 1 & 2 ####
for (i in 1:length(Analysis_Sample_23_16_1)) {
  JCP_corrected_ratios <-
  Analysis_Sample_23_16_1[[i]] %>%
    mutate(
    Li_Ca_MB_corrected = Li_Ca/(mean(c(Calculations_JCP[[1]]$Li_Ca[1],Calculations_JCP[[2]]$Li_Ca[1]))/Constants$JCP$Li_Ca[1]),
    B_Ca_MB_corrected = B_Ca/(mean(c(Calculations_JCP[[1]]$B_Ca[1],Calculations_JCP[[2]]$B_Ca[1]))/Constants$JCP$B_Ca[1]),
    Mg_Ca_MB_corrected = (Mg_Ca/(mean(c(Calculations_JCP[[1]]$Mg_Ca[1],Calculations_JCP[[2]]$Mg_Ca[1]))/Constants$JCP$Mg_Ca[1]))*1000,
    P_Ca_MB_corrected = P_Ca/(mean(c(Calculations_JCP[[1]]$P_Ca[1],Calculations_JCP[[2]]$P_Ca[1]))/Constants$JCP$P_Ca[1]),
    S_Ca_MB_corrected = (S_Ca/(mean(c(Calculations_JCP[[1]]$S_Ca[1],Calculations_JCP[[2]]$S_Ca[1]))/Constants$JCP$S_Ca[1]))*1000,
    Mn_Ca_MB_corrected = Mn_Ca/(mean(c(Calculations_JCP[[1]]$Mn_Ca[1],Calculations_JCP[[2]]$Mn_Ca[1]))/Constants$JCP$Mn_Ca[1]),
    Sr_Ca_MB_corrected = (Sr_Ca/(mean(c(Calculations_JCP[[1]]$Sr_Ca[1],Calculations_JCP[[2]]$Sr_Ca[1]))/Constants$JCP$Sr_Ca[1]))*1000,
    Ba_Ca_MB_corrected = Ba_Ca/(mean(c(Calculations_JCP[[1]]$Ba_Ca[1],Calculations_JCP[[2]]$Ba_Ca[1]))/Constants$JCP$Ba_Ca[1]),
    U_Ca_MB_corrected = (U_Ca/(mean(c(Calculations_JCP[[1]]$U_Ca[1],Calculations_JCP[[2]]$U_Ca[1]))/Constants$JCP$U_Ca[1]))/1000
    )
  
assign(paste0(names(Analysis_Sample_23_16_1[i]), "_JCP_corrected"), JCP_corrected_ratios)
JCP_Corrected_Sample_23_16_1[[paste0(names(Analysis_Sample_23_16_1[i]), "_JCP_corrected")]] <- JCP_corrected_ratios
}
# JCP 2 & 3 ####
for (i in 1:length(Analysis_Sample_23_16_2)) {
  JCP_corrected_ratios <-
  Analysis_Sample_23_16_2[[i]] %>%
    mutate(
    Li_Ca_MB_corrected = Li_Ca/(mean(c(Calculations_JCP[[2]]$Li_Ca[1],Calculations_JCP[[3]]$Li_Ca[1]))/Constants$JCP$Li_Ca[1]),
    B_Ca_MB_corrected = B_Ca/(mean(c(Calculations_JCP[[2]]$B_Ca[1],Calculations_JCP[[3]]$B_Ca[1]))/Constants$JCP$B_Ca[1]),
    Mg_Ca_MB_corrected = (Mg_Ca/(mean(c(Calculations_JCP[[2]]$Mg_Ca[1],Calculations_JCP[[3]]$Mg_Ca[1]))/Constants$JCP$Mg_Ca[1]))*1000,
    P_Ca_MB_corrected = P_Ca/(mean(c(Calculations_JCP[[2]]$P_Ca[1],Calculations_JCP[[3]]$P_Ca[1]))/Constants$JCP$P_Ca[1]),
    S_Ca_MB_corrected = (S_Ca/(mean(c(Calculations_JCP[[2]]$S_Ca[1],Calculations_JCP[[3]]$S_Ca[1]))/Constants$JCP$S_Ca[1]))*1000,
    Mn_Ca_MB_corrected = Mn_Ca/(mean(c(Calculations_JCP[[2]]$Mn_Ca[1],Calculations_JCP[[3]]$Mn_Ca[1]))/Constants$JCP$Mn_Ca[1]),
    Sr_Ca_MB_corrected = (Sr_Ca/(mean(c(Calculations_JCP[[2]]$Sr_Ca[1],Calculations_JCP[[3]]$Sr_Ca[1]))/Constants$JCP$Sr_Ca[1]))*1000,
    Ba_Ca_MB_corrected = Ba_Ca/(mean(c(Calculations_JCP[[2]]$Ba_Ca[1],Calculations_JCP[[3]]$Ba_Ca[1]))/Constants$JCP$Ba_Ca[1]),
    U_Ca_MB_corrected = (U_Ca/(mean(c(Calculations_JCP[[2]]$U_Ca[1],Calculations_JCP[[3]]$U_Ca[1]))/Constants$JCP$U_Ca[1]))/1000
    )
  
assign(paste0(names(Analysis_Sample_23_16_2[i]), "_JCP_corrected"), JCP_corrected_ratios)
JCP_Corrected_Sample_23_16_2[[paste0(names(Analysis_Sample_23_16_2[i]), "_JCP_corrected")]] <- JCP_corrected_ratios
}
# JCP 3 & 4 ####
for (i in 1:length(Analysis_Sample_23_16_3)) {
  JCP_corrected_ratios <-
  Analysis_Sample_23_16_3[[i]] %>%
    mutate(
    Li_Ca_MB_corrected = Li_Ca/(mean(c(Calculations_JCP[[3]]$Li_Ca[1],Calculations_JCP[[4]]$Li_Ca[1]))/Constants$JCP$Li_Ca[1]),
    B_Ca_MB_corrected = B_Ca/(mean(c(Calculations_JCP[[3]]$B_Ca[1],Calculations_JCP[[4]]$B_Ca[1]))/Constants$JCP$B_Ca[1]),
    Mg_Ca_MB_corrected = (Mg_Ca/(mean(c(Calculations_JCP[[3]]$Mg_Ca[1],Calculations_JCP[[4]]$Mg_Ca[1]))/Constants$JCP$Mg_Ca[1]))*1000,
    P_Ca_MB_corrected = P_Ca/(mean(c(Calculations_JCP[[3]]$P_Ca[1],Calculations_JCP[[4]]$P_Ca[1]))/Constants$JCP$P_Ca[1]),
    S_Ca_MB_corrected = (S_Ca/(mean(c(Calculations_JCP[[3]]$S_Ca[1],Calculations_JCP[[4]]$S_Ca[1]))/Constants$JCP$S_Ca[1]))*1000,
    Mn_Ca_MB_corrected = Mn_Ca/(mean(c(Calculations_JCP[[3]]$Mn_Ca[1],Calculations_JCP[[4]]$Mn_Ca[1]))/Constants$JCP$Mn_Ca[1]),
    Sr_Ca_MB_corrected = (Sr_Ca/(mean(c(Calculations_JCP[[3]]$Sr_Ca[1],Calculations_JCP[[4]]$Sr_Ca[1]))/Constants$JCP$Sr_Ca[1]))*1000,
    Ba_Ca_MB_corrected = Ba_Ca/(mean(c(Calculations_JCP[[3]]$Ba_Ca[1],Calculations_JCP[[4]]$Ba_Ca[1]))/Constants$JCP$Ba_Ca[1]),
    U_Ca_MB_corrected = (U_Ca/(mean(c(Calculations_JCP[[3]]$U_Ca[1],Calculations_JCP[[4]]$U_Ca[1]))/Constants$JCP$U_Ca[1]))/1000
    )
  
assign(paste0(names(Analysis_Sample_23_16_3[i]), "_JCP_corrected"), JCP_corrected_ratios)
JCP_Corrected_Sample_23_16_3[[paste0(names(Analysis_Sample_23_16_3[i]), "_JCP_corrected")]] <- JCP_corrected_ratios
}

JCP_Corrected_Sample_23_16 <- list()
JCP_Corrected_Sample_23_16[[paste0("JCP_Corrected_Sample_23_16_1")]] <- JCP_Corrected_Sample_23_16_1
JCP_Corrected_Sample_23_16[[paste0("JCP_Corrected_Sample_23_16_2")]] <- JCP_Corrected_Sample_23_16_2
JCP_Corrected_Sample_23_16[[paste0("JCP_Corrected_Sample_23_16_3")]] <- JCP_Corrected_Sample_23_16_3

# JCP 4 & 5 ####
for (i in 1:length(Analysis_Sample_23_1_1)) {
  JCP_corrected_ratios <-
  Analysis_Sample_23_1_1[[i]] %>%
    mutate(
    Li_Ca_MB_corrected = Li_Ca/(mean(c(Calculations_JCP[[4]]$Li_Ca[1],Calculations_JCP[[5]]$Li_Ca[1]))/Constants$JCP$Li_Ca[1]),
    B_Ca_MB_corrected = B_Ca/(mean(c(Calculations_JCP[[4]]$B_Ca[1],Calculations_JCP[[5]]$B_Ca[1]))/Constants$JCP$B_Ca[1]),
    Mg_Ca_MB_corrected = (Mg_Ca/(mean(c(Calculations_JCP[[4]]$Mg_Ca[1],Calculations_JCP[[5]]$Mg_Ca[1]))/Constants$JCP$Mg_Ca[1]))*1000,
    P_Ca_MB_corrected = P_Ca/(mean(c(Calculations_JCP[[4]]$P_Ca[1],Calculations_JCP[[5]]$P_Ca[1]))/Constants$JCP$P_Ca[1]),
    S_Ca_MB_corrected = (S_Ca/(mean(c(Calculations_JCP[[4]]$S_Ca[1],Calculations_JCP[[5]]$S_Ca[1]))/Constants$JCP$S_Ca[1]))*1000,
    Mn_Ca_MB_corrected = Mn_Ca/(mean(c(Calculations_JCP[[4]]$Mn_Ca[1],Calculations_JCP[[5]]$Mn_Ca[1]))/Constants$JCP$Mn_Ca[1]),
    Sr_Ca_MB_corrected = (Sr_Ca/(mean(c(Calculations_JCP[[4]]$Sr_Ca[1],Calculations_JCP[[5]]$Sr_Ca[1]))/Constants$JCP$Sr_Ca[1]))*1000,
    Ba_Ca_MB_corrected = Ba_Ca/(mean(c(Calculations_JCP[[4]]$Ba_Ca[1],Calculations_JCP[[5]]$Ba_Ca[1]))/Constants$JCP$Ba_Ca[1]),
    U_Ca_MB_corrected = (U_Ca/(mean(c(Calculations_JCP[[4]]$U_Ca[1],Calculations_JCP[[5]]$U_Ca[1]))/Constants$JCP$U_Ca[1]))/1000
    )
  
assign(paste0(names(Analysis_Sample_23_1_1[i]), "_JCP_corrected"), JCP_corrected_ratios)
JCP_Corrected_Sample_23_1_1[[paste0(names(Analysis_Sample_23_1_1[i]), "_JCP_corrected")]] <- JCP_corrected_ratios
}
# JCP 5 & 6 ####
for (i in 1:length(Analysis_Sample_23_1_2)) {
  JCP_corrected_ratios <-
  Analysis_Sample_23_1_2[[i]] %>%
    mutate(
    Li_Ca_MB_corrected = Li_Ca/(mean(c(Calculations_JCP[[5]]$Li_Ca[1],Calculations_JCP[[6]]$Li_Ca[1]))/Constants$JCP$Li_Ca[1]),
    B_Ca_MB_corrected = B_Ca/(mean(c(Calculations_JCP[[5]]$B_Ca[1],Calculations_JCP[[6]]$B_Ca[1]))/Constants$JCP$B_Ca[1]),
    Mg_Ca_MB_corrected = (Mg_Ca/(mean(c(Calculations_JCP[[5]]$Mg_Ca[1],Calculations_JCP[[6]]$Mg_Ca[1]))/Constants$JCP$Mg_Ca[1]))*1000,
    P_Ca_MB_corrected = P_Ca/(mean(c(Calculations_JCP[[5]]$P_Ca[1],Calculations_JCP[[6]]$P_Ca[1]))/Constants$JCP$P_Ca[1]),
    S_Ca_MB_corrected = (S_Ca/(mean(c(Calculations_JCP[[5]]$S_Ca[1],Calculations_JCP[[6]]$S_Ca[1]))/Constants$JCP$S_Ca[1]))*1000,
    Mn_Ca_MB_corrected = Mn_Ca/(mean(c(Calculations_JCP[[5]]$Mn_Ca[1],Calculations_JCP[[6]]$Mn_Ca[1]))/Constants$JCP$Mn_Ca[1]),
    Sr_Ca_MB_corrected = (Sr_Ca/(mean(c(Calculations_JCP[[5]]$Sr_Ca[1],Calculations_JCP[[6]]$Sr_Ca[1]))/Constants$JCP$Sr_Ca[1]))*1000,
    Ba_Ca_MB_corrected = Ba_Ca/(mean(c(Calculations_JCP[[5]]$Ba_Ca[1],Calculations_JCP[[6]]$Ba_Ca[1]))/Constants$JCP$Ba_Ca[1]),
    U_Ca_MB_corrected = (U_Ca/(mean(c(Calculations_JCP[[5]]$U_Ca[1],Calculations_JCP[[6]]$U_Ca[1]))/Constants$JCP$U_Ca[1]))/1000
    )
  
assign(paste0(names(Analysis_Sample_23_1_2[i]), "_JCP_corrected"), JCP_corrected_ratios)
JCP_Corrected_Sample_23_1_2[[paste0(names(Analysis_Sample_23_1_2[i]), "_JCP_corrected")]] <- JCP_corrected_ratios
}
# JCP 6 & 7 ####
for (i in 1:length(Analysis_Sample_23_1_3)) {
  JCP_corrected_ratios <-
  Analysis_Sample_23_1_3[[i]] %>%
    mutate(
    Li_Ca_MB_corrected = Li_Ca/(mean(c(Calculations_JCP[[6]]$Li_Ca[1],Calculations_JCP[[7]]$Li_Ca[1]))/Constants$JCP$Li_Ca[1]),
    B_Ca_MB_corrected = B_Ca/(mean(c(Calculations_JCP[[6]]$B_Ca[1],Calculations_JCP[[7]]$B_Ca[1]))/Constants$JCP$B_Ca[1]),
    Mg_Ca_MB_corrected = (Mg_Ca/(mean(c(Calculations_JCP[[6]]$Mg_Ca[1],Calculations_JCP[[7]]$Mg_Ca[1]))/Constants$JCP$Mg_Ca[1]))*1000,
    P_Ca_MB_corrected = P_Ca/(mean(c(Calculations_JCP[[6]]$P_Ca[1],Calculations_JCP[[7]]$P_Ca[1]))/Constants$JCP$P_Ca[1]),
    S_Ca_MB_corrected = (S_Ca/(mean(c(Calculations_JCP[[6]]$S_Ca[1],Calculations_JCP[[7]]$S_Ca[1]))/Constants$JCP$S_Ca[1]))*1000,
    Mn_Ca_MB_corrected = Mn_Ca/(mean(c(Calculations_JCP[[6]]$Mn_Ca[1],Calculations_JCP[[7]]$Mn_Ca[1]))/Constants$JCP$Mn_Ca[1]),
    Sr_Ca_MB_corrected = (Sr_Ca/(mean(c(Calculations_JCP[[6]]$Sr_Ca[1],Calculations_JCP[[7]]$Sr_Ca[1]))/Constants$JCP$Sr_Ca[1]))*1000,
    Ba_Ca_MB_corrected = Ba_Ca/(mean(c(Calculations_JCP[[6]]$Ba_Ca[1],Calculations_JCP[[7]]$Ba_Ca[1]))/Constants$JCP$Ba_Ca[1]),
    U_Ca_MB_corrected = (U_Ca/(mean(c(Calculations_JCP[[6]]$U_Ca[1],Calculations_JCP[[7]]$U_Ca[1]))/Constants$JCP$U_Ca[1]))/1000
    )
  
assign(paste0(names(Analysis_Sample_23_1_3[i]), "_JCP_corrected"), JCP_corrected_ratios)
JCP_Corrected_Sample_23_1_3[[paste0(names(Analysis_Sample_23_1_3[i]), "_JCP_corrected")]] <- JCP_corrected_ratios
}

JCP_Corrected_Sample_23_1 <- list()
JCP_Corrected_Sample_23_1[[paste0("JCP_Corrected_Sample_23_1_1")]] <- JCP_Corrected_Sample_23_1_1
JCP_Corrected_Sample_23_1[[paste0("JCP_Corrected_Sample_23_1_2")]] <- JCP_Corrected_Sample_23_1_2
JCP_Corrected_Sample_23_1[[paste0("JCP_Corrected_Sample_23_1_3")]] <- JCP_Corrected_Sample_23_1_3

# JCP 8 & 9 - as new day of ablation so different standards ####
for (i in 1:length(Analysis_Sample_23_10_1)) {
  JCP_corrected_ratios <-
  Analysis_Sample_23_10_1[[i]] %>%
    mutate(
    Li_Ca_MB_corrected = Li_Ca/(mean(c(Calculations_JCP[[8]]$Li_Ca[1],Calculations_JCP[[9]]$Li_Ca[1]))/Constants$JCP$Li_Ca[1]),
    B_Ca_MB_corrected = B_Ca/(mean(c(Calculations_JCP[[8]]$B_Ca[1],Calculations_JCP[[9]]$B_Ca[1]))/Constants$JCP$B_Ca[1]),
    Mg_Ca_MB_corrected = (Mg_Ca/(mean(c(Calculations_JCP[[8]]$Mg_Ca[1],Calculations_JCP[[9]]$Mg_Ca[1]))/Constants$JCP$Mg_Ca[1]))*1000,
    P_Ca_MB_corrected = P_Ca/(mean(c(Calculations_JCP[[8]]$P_Ca[1],Calculations_JCP[[9]]$P_Ca[1]))/Constants$JCP$P_Ca[1]),
    S_Ca_MB_corrected = (S_Ca/(mean(c(Calculations_JCP[[8]]$S_Ca[1],Calculations_JCP[[9]]$S_Ca[1]))/Constants$JCP$S_Ca[1]))*1000,
    Mn_Ca_MB_corrected = Mn_Ca/(mean(c(Calculations_JCP[[8]]$Mn_Ca[1],Calculations_JCP[[9]]$Mn_Ca[1]))/Constants$JCP$Mn_Ca[1]),
    Sr_Ca_MB_corrected = (Sr_Ca/(mean(c(Calculations_JCP[[8]]$Sr_Ca[1],Calculations_JCP[[9]]$Sr_Ca[1]))/Constants$JCP$Sr_Ca[1]))*1000,
    Ba_Ca_MB_corrected = Ba_Ca/(mean(c(Calculations_JCP[[8]]$Ba_Ca[1],Calculations_JCP[[9]]$Ba_Ca[1]))/Constants$JCP$Ba_Ca[1]),
    U_Ca_MB_corrected = (U_Ca/(mean(c(Calculations_JCP[[8]]$U_Ca[1],Calculations_JCP[[9]]$U_Ca[1]))/Constants$JCP$U_Ca[1]))/1000
    )
  
assign(paste0(names(Analysis_Sample_23_10_1[i]), "_JCP_corrected"), JCP_corrected_ratios)
JCP_Corrected_Sample_23_10_1[[paste0(names(Analysis_Sample_23_10_1[i]), "_JCP_corrected")]] <- JCP_corrected_ratios
}
# JCP 9 & 10 ####
for (i in 1:length(Analysis_Sample_23_10_2)) {
  JCP_corrected_ratios <-
  Analysis_Sample_23_10_2[[i]] %>%
    mutate(
    Li_Ca_MB_corrected = Li_Ca/(mean(c(Calculations_JCP[[9]]$Li_Ca[1],Calculations_JCP[[10]]$Li_Ca[1]))/Constants$JCP$Li_Ca[1]),
    B_Ca_MB_corrected = B_Ca/(mean(c(Calculations_JCP[[9]]$B_Ca[1],Calculations_JCP[[10]]$B_Ca[1]))/Constants$JCP$B_Ca[1]),
    Mg_Ca_MB_corrected = (Mg_Ca/(mean(c(Calculations_JCP[[9]]$Mg_Ca[1],Calculations_JCP[[10]]$Mg_Ca[1]))/Constants$JCP$Mg_Ca[1]))*1000,
    P_Ca_MB_corrected = P_Ca/(mean(c(Calculations_JCP[[9]]$P_Ca[1],Calculations_JCP[[10]]$P_Ca[1]))/Constants$JCP$P_Ca[1]),
    S_Ca_MB_corrected = (S_Ca/(mean(c(Calculations_JCP[[9]]$S_Ca[1],Calculations_JCP[[10]]$S_Ca[1]))/Constants$JCP$S_Ca[1]))*1000,
    Mn_Ca_MB_corrected = Mn_Ca/(mean(c(Calculations_JCP[[9]]$Mn_Ca[1],Calculations_JCP[[10]]$Mn_Ca[1]))/Constants$JCP$Mn_Ca[1]),
    Sr_Ca_MB_corrected = (Sr_Ca/(mean(c(Calculations_JCP[[9]]$Sr_Ca[1],Calculations_JCP[[10]]$Sr_Ca[1]))/Constants$JCP$Sr_Ca[1]))*1000,
    Ba_Ca_MB_corrected = Ba_Ca/(mean(c(Calculations_JCP[[9]]$Ba_Ca[1],Calculations_JCP[[10]]$Ba_Ca[1]))/Constants$JCP$Ba_Ca[1]),
    U_Ca_MB_corrected = (U_Ca/(mean(c(Calculations_JCP[[9]]$U_Ca[1],Calculations_JCP[[10]]$U_Ca[1]))/Constants$JCP$U_Ca[1]))/1000
    )
  
assign(paste0(names(Analysis_Sample_23_10_2[i]), "_JCP_corrected"), JCP_corrected_ratios)
JCP_Corrected_Sample_23_10_2[[paste0(names(Analysis_Sample_23_10_2[i]), "_JCP_corrected")]] <- JCP_corrected_ratios
}
# JCP 10 & 11 ####
for (i in 1:length(Analysis_Sample_23_10_3)) {
  JCP_corrected_ratios <-
  Analysis_Sample_23_10_3[[i]] %>%
    mutate(
    Li_Ca_MB_corrected = Li_Ca/(mean(c(Calculations_JCP[[10]]$Li_Ca[1],Calculations_JCP[[11]]$Li_Ca[1]))/Constants$JCP$Li_Ca[1]),
    B_Ca_MB_corrected = B_Ca/(mean(c(Calculations_JCP[[10]]$B_Ca[1],Calculations_JCP[[11]]$B_Ca[1]))/Constants$JCP$B_Ca[1]),
    Mg_Ca_MB_corrected = (Mg_Ca/(mean(c(Calculations_JCP[[10]]$Mg_Ca[1],Calculations_JCP[[11]]$Mg_Ca[1]))/Constants$JCP$Mg_Ca[1]))*1000,
    P_Ca_MB_corrected = P_Ca/(mean(c(Calculations_JCP[[10]]$P_Ca[1],Calculations_JCP[[11]]$P_Ca[1]))/Constants$JCP$P_Ca[1]),
    S_Ca_MB_corrected = (S_Ca/(mean(c(Calculations_JCP[[10]]$S_Ca[1],Calculations_JCP[[11]]$S_Ca[1]))/Constants$JCP$S_Ca[1]))*1000,
    Mn_Ca_MB_corrected = Mn_Ca/(mean(c(Calculations_JCP[[10]]$Mn_Ca[1],Calculations_JCP[[11]]$Mn_Ca[1]))/Constants$JCP$Mn_Ca[1]),
    Sr_Ca_MB_corrected = (Sr_Ca/(mean(c(Calculations_JCP[[10]]$Sr_Ca[1],Calculations_JCP[[11]]$Sr_Ca[1]))/Constants$JCP$Sr_Ca[1]))*1000,
    Ba_Ca_MB_corrected = Ba_Ca/(mean(c(Calculations_JCP[[10]]$Ba_Ca[1],Calculations_JCP[[11]]$Ba_Ca[1]))/Constants$JCP$Ba_Ca[1]),
    U_Ca_MB_corrected = (U_Ca/(mean(c(Calculations_JCP[[10]]$U_Ca[1],Calculations_JCP[[11]]$U_Ca[1]))/Constants$JCP$U_Ca[1]))/1000
    )
  
assign(paste0(names(Analysis_Sample_23_10_3[i]), "_JCP_corrected"), JCP_corrected_ratios)
JCP_Corrected_Sample_23_10_3[[paste0(names(Analysis_Sample_23_10_3[i]), "_JCP_corrected")]] <- JCP_corrected_ratios
}

JCP_Corrected_Sample_23_10 <- list()
JCP_Corrected_Sample_23_10[[paste0("JCP_Corrected_Sample_23_10_1")]] <- JCP_Corrected_Sample_23_10_1
JCP_Corrected_Sample_23_10[[paste0("JCP_Corrected_Sample_23_10_2")]] <- JCP_Corrected_Sample_23_10_2
JCP_Corrected_Sample_23_10[[paste0("JCP_Corrected_Sample_23_10_3")]] <- JCP_Corrected_Sample_23_10_3

# JCP 11 & 12 ####
for (i in 1:length(Analysis_Sample_23_6_1)) {
  JCP_corrected_ratios <-
  Analysis_Sample_23_6_1[[i]] %>%
    mutate(
    Li_Ca_MB_corrected = Li_Ca/(mean(c(Calculations_JCP[[11]]$Li_Ca[1],Calculations_JCP[[12]]$Li_Ca[1]))/Constants$JCP$Li_Ca[1]),
    B_Ca_MB_corrected = B_Ca/(mean(c(Calculations_JCP[[11]]$B_Ca[1],Calculations_JCP[[12]]$B_Ca[1]))/Constants$JCP$B_Ca[1]),
    Mg_Ca_MB_corrected = (Mg_Ca/(mean(c(Calculations_JCP[[11]]$Mg_Ca[1],Calculations_JCP[[12]]$Mg_Ca[1]))/Constants$JCP$Mg_Ca[1]))*1000,
    P_Ca_MB_corrected = P_Ca/(mean(c(Calculations_JCP[[11]]$P_Ca[1],Calculations_JCP[[12]]$P_Ca[1]))/Constants$JCP$P_Ca[1]),
    S_Ca_MB_corrected = (S_Ca/(mean(c(Calculations_JCP[[11]]$S_Ca[1],Calculations_JCP[[12]]$S_Ca[1]))/Constants$JCP$S_Ca[1]))*1000,
    Mn_Ca_MB_corrected = Mn_Ca/(mean(c(Calculations_JCP[[11]]$Mn_Ca[1],Calculations_JCP[[12]]$Mn_Ca[1]))/Constants$JCP$Mn_Ca[1]),
    Sr_Ca_MB_corrected = (Sr_Ca/(mean(c(Calculations_JCP[[11]]$Sr_Ca[1],Calculations_JCP[[12]]$Sr_Ca[1]))/Constants$JCP$Sr_Ca[1]))*1000,
    Ba_Ca_MB_corrected = Ba_Ca/(mean(c(Calculations_JCP[[11]]$Ba_Ca[1],Calculations_JCP[[12]]$Ba_Ca[1]))/Constants$JCP$Ba_Ca[1]),
    U_Ca_MB_corrected = (U_Ca/(mean(c(Calculations_JCP[[11]]$U_Ca[1],Calculations_JCP[[12]]$U_Ca[1]))/Constants$JCP$U_Ca[1]))/1000
    )
  
assign(paste0(names(Analysis_Sample_23_6_1[i]), "_JCP_corrected"), JCP_corrected_ratios)
JCP_Corrected_Sample_23_6_1[[paste0(names(Analysis_Sample_23_6_1[i]), "_JCP_corrected")]] <- JCP_corrected_ratios
}
# JCP 12 & 13 ####
for (i in 1:length(Analysis_Sample_23_6_2)) {
  JCP_corrected_ratios <-
  Analysis_Sample_23_6_2[[i]] %>%
    mutate(
    Li_Ca_MB_corrected = Li_Ca/(mean(c(Calculations_JCP[[12]]$Li_Ca[1],Calculations_JCP[[13]]$Li_Ca[1]))/Constants$JCP$Li_Ca[1]),
    B_Ca_MB_corrected = B_Ca/(mean(c(Calculations_JCP[[12]]$B_Ca[1],Calculations_JCP[[13]]$B_Ca[1]))/Constants$JCP$B_Ca[1]),
    (Mg_Ca_MB_corrected = Mg_Ca/(mean(c(Calculations_JCP[[12]]$Mg_Ca[1],Calculations_JCP[[13]]$Mg_Ca[1]))/Constants$JCP$Mg_Ca[1]))*1000,
    P_Ca_MB_corrected = P_Ca/(mean(c(Calculations_JCP[[12]]$P_Ca[1],Calculations_JCP[[13]]$P_Ca[1]))/Constants$JCP$P_Ca[1]),
    (S_Ca_MB_corrected = S_Ca/(mean(c(Calculations_JCP[[12]]$S_Ca[1],Calculations_JCP[[13]]$S_Ca[1]))/Constants$JCP$S_Ca[1]))*1000,
    Mn_Ca_MB_corrected = Mn_Ca/(mean(c(Calculations_JCP[[12]]$Mn_Ca[1],Calculations_JCP[[13]]$Mn_Ca[1]))/Constants$JCP$Mn_Ca[1]),
    (Sr_Ca_MB_corrected = Sr_Ca/(mean(c(Calculations_JCP[[12]]$Sr_Ca[1],Calculations_JCP[[13]]$Sr_Ca[1]))/Constants$JCP$Sr_Ca[1]))*1000,
    Ba_Ca_MB_corrected = Ba_Ca/(mean(c(Calculations_JCP[[12]]$Ba_Ca[1],Calculations_JCP[[13]]$Ba_Ca[1]))/Constants$JCP$Ba_Ca[1]),
    (U_Ca_MB_corrected = U_Ca/(mean(c(Calculations_JCP[[12]]$U_Ca[1],Calculations_JCP[[13]]$U_Ca[1]))/Constants$JCP$U_Ca[1]))/1000
    )
  
assign(paste0(names(Analysis_Sample_23_6_2[i]), "_JCP_corrected"), JCP_corrected_ratios)
JCP_Corrected_Sample_23_6_2[[paste0(names(Analysis_Sample_23_6_2[i]), "_JCP_corrected")]] <- JCP_corrected_ratios
}
# JCP 13 & 14 ####
for (i in 1:length(Analysis_Sample_23_6_3)) {
  JCP_corrected_ratios <-
  Analysis_Sample_23_6_3[[i]] %>%
    mutate(
    Li_Ca_MB_corrected = Li_Ca/(mean(c(Calculations_JCP[[13]]$Li_Ca[1],Calculations_JCP[[14]]$Li_Ca[1]))/Constants$JCP$Li_Ca[1]),
    B_Ca_MB_corrected = B_Ca/(mean(c(Calculations_JCP[[13]]$B_Ca[1],Calculations_JCP[[14]]$B_Ca[1]))/Constants$JCP$B_Ca[1]),
    (Mg_Ca_MB_corrected = Mg_Ca/(mean(c(Calculations_JCP[[13]]$Mg_Ca[1],Calculations_JCP[[14]]$Mg_Ca[1]))/Constants$JCP$Mg_Ca[1]))*1000,
    P_Ca_MB_corrected = P_Ca/(mean(c(Calculations_JCP[[13]]$P_Ca[1],Calculations_JCP[[14]]$P_Ca[1]))/Constants$JCP$P_Ca[1]),
    (S_Ca_MB_corrected = S_Ca/(mean(c(Calculations_JCP[[13]]$S_Ca[1],Calculations_JCP[[14]]$S_Ca[1]))/Constants$JCP$S_Ca[1]))*1000,
    Mn_Ca_MB_corrected = Mn_Ca/(mean(c(Calculations_JCP[[13]]$Mn_Ca[1],Calculations_JCP[[14]]$Mn_Ca[1]))/Constants$JCP$Mn_Ca[1]),
    (Sr_Ca_MB_corrected = Sr_Ca/(mean(c(Calculations_JCP[[13]]$Sr_Ca[1],Calculations_JCP[[14]]$Sr_Ca[1]))/Constants$JCP$Sr_Ca[1]))*1000,
    Ba_Ca_MB_corrected = Ba_Ca/(mean(c(Calculations_JCP[[13]]$Ba_Ca[1],Calculations_JCP[[14]]$Ba_Ca[1]))/Constants$JCP$Ba_Ca[1]),
    (U_Ca_MB_corrected = U_Ca/(mean(c(Calculations_JCP[[13]]$U_Ca[1],Calculations_JCP[[14]]$U_Ca[1]))/Constants$JCP$U_Ca[1]))/1000
    )
  
assign(paste0(names(Analysis_Sample_23_6_3[i]), "_JCP_corrected"), JCP_corrected_ratios)
JCP_Corrected_Sample_23_6_3[[paste0(names(Analysis_Sample_23_6_3[i]), "_JCP_corrected")]] <- JCP_corrected_ratios
}

JCP_Corrected_Sample_23_6 <- list()
JCP_Corrected_Sample_23_6[[paste0("JCP_Corrected_Sample_23_6_1")]] <- JCP_Corrected_Sample_23_6_1
JCP_Corrected_Sample_23_6[[paste0("JCP_Corrected_Sample_23_6_2")]] <- JCP_Corrected_Sample_23_6_2
JCP_Corrected_Sample_23_6[[paste0("JCP_Corrected_Sample_23_6_3")]] <- JCP_Corrected_Sample_23_6_3

JCP_Corrected_Samples <- list()
JCP_Corrected_Samples[[paste0("JCP_Corrected_Sample_23_16")]] <- JCP_Corrected_Sample_23_16
JCP_Corrected_Samples[[paste0("JCP_Corrected_Sample_23_1")]] <- JCP_Corrected_Sample_23_1
JCP_Corrected_Samples[[paste0("JCP_Corrected_Sample_23_10")]] <- JCP_Corrected_Sample_23_10
JCP_Corrected_Samples[[paste0("JCP_Corrected_Sample_23_6")]] <- JCP_Corrected_Sample_23_6

for (i in 1:length(JCP_Corrected_Samples)) {
  for (j in 1:length(JCP_Corrected_Samples[[i]])) {
    for (x in 1:length(JCP_Corrected_Samples[[i]][[j]])) {
      filename = paste(names(JCP_Corrected_Samples[[i]][[j]])[[x]], ".csv")
      write.csv(JCP_Corrected_Samples[[i]][[j]][[x]], filename)
    }
  }
}

```

```{r 612 corrected ratios and conversion to mol, echo = F, message=T}
# N.B. REMEMBER TO SET WORKING DIRECTORY TO WHERE YOU WANT 612 CORRECTIONS TO GO
i <- 1
NIST612_Corrected_DSC <- list()
NIST612_Corrected_Sample_23_16_1 <- list()
NIST612_Corrected_Sample_23_16_2 <- list()
NIST612_Corrected_Sample_23_16_3 <- list()
NIST612_Corrected_Sample_23_1_1 <- list()
NIST612_Corrected_Sample_23_1_2 <- list()
NIST612_Corrected_Sample_23_1_3 <- list()
NIST612_Corrected_Sample_23_10_1 <- list()
NIST612_Corrected_Sample_23_10_2 <- list()
NIST612_Corrected_Sample_23_10_3 <- list()
NIST612_Corrected_Sample_23_6_1 <- list()
NIST612_Corrected_Sample_23_6_2 <- list()
NIST612_Corrected_Sample_23_6_3 <- list()

# need to change the 612 for each DSC run (i & i +1) #### 
for (i in 1:length(Analysis_DSC)) {
  NIST612_corrected_ratios <-
  Analysis_DSC[[i]] %>%
    mutate(
    Li_Ca_NIST612_corrected = Li_Ca/(mean(c(Calculations_612[[i]]$Li_Ca[1],Calculations_612[[i+1]]$Li_Ca[1]))/Constants$NIST612$Li_Ca[1]),
    B_Ca_NIST612_corrected = B_Ca/(mean(c(Calculations_612[[i]]$B_Ca[1],Calculations_612[[i+1]]$B_Ca[1]))/Constants$NIST612$B_Ca[1]),
    Mg_Ca_NIST612_corrected = Mg_Ca/(mean(c(Calculations_612[[i]]$Mg_Ca[1],Calculations_612[[i+1]]$Mg_Ca[1]))/Constants$NIST612$Mg_Ca[1]),
    P_Ca_NIST612_corrected = P_Ca/(mean(c(Calculations_612[[i]]$P_Ca[1],Calculations_612[[i+1]]$P_Ca[1]))/Constants$NIST612$P_Ca[1]),
    S_Ca_NIST612_corrected = S_Ca/(mean(c(Calculations_612[[i]]$S_Ca[1],Calculations_612[[i+1]]$S_Ca[1]))/Constants$NIST612$S_Ca[1]),
    Mn_Ca_NIST612_corrected = Mn_Ca/(mean(c(Calculations_612[[i]]$Mn_Ca[1],Calculations_612[[i+1]]$Mn_Ca[1]))/Constants$NIST612$Mn_Ca[1]),
    Sr_Ca_NIST612_corrected = Sr_Ca/(mean(c(Calculations_612[[i]]$Sr_Ca[1],Calculations_612[[i+1]]$Sr_Ca[1]))/Constants$NIST612$Sr_Ca[1]),
    Ba_Ca_NIST612_corrected = Ba_Ca/(mean(c(Calculations_612[[i]]$Ba_Ca[1],Calculations_612[[i+1]]$Ba_Ca[1]))/Constants$NIST612$Ba_Ca[1]),
    U_Ca_NIST612_corrected = U_Ca/(mean(c(Calculations_612[[i]]$U_Ca[1],Calculations_612[[i+1]]$U_Ca[1]))/Constants$NIST612$U_Ca[1])
    )
  
  NIST612_corrected_ratios <- NIST612_corrected_ratios %>%
    mutate(
      Li_Ca_umol_mol = Li_Ca_NIST612_corrected /(Constants$Element_constants$Mass[1]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      B_Ca_umol_mol = B_Ca_NIST612_corrected /(Constants$Element_constants$Mass[2]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      Mg_Ca_umol_mol = Mg_Ca_NIST612_corrected /(Constants$Element_constants$Mass[3]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      P_Ca_umol_mol = P_Ca_NIST612_corrected /(Constants$Element_constants$Mass[4]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      S_Ca_umol_mol = S_Ca_NIST612_corrected /(Constants$Element_constants$Mass[5]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      Mn_Ca_umol_mol = Mn_Ca_NIST612_corrected /(Constants$Element_constants$Mass[7]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      Sr_Ca_umol_mol = Sr_Ca_NIST612_corrected /(Constants$Element_constants$Mass[11]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      Ba_Ca_umol_mol = Ba_Ca_NIST612_corrected /(Constants$Element_constants$Mass[12]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      U_Ca_umol_mol = U_Ca_NIST612_corrected /(Constants$Element_constants$Mass[14]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2])
    )
  
  
assign(paste0(names(Analysis_DSC[i]), "_NIST612_Corrected"), NIST612_corrected_ratios)
NIST612_Corrected_DSC[[paste0(names(Analysis_DSC[i]), "_NIST612_Corrected")]] <- NIST612_corrected_ratios
}
# 612 1 & 2 ####
for (i in 1:length(Analysis_Sample_23_16_1)) {
  NIST612_corrected_ratios <-
  Analysis_Sample_23_16_1[[i]] %>%
    mutate(
    Li_Ca_NIST612_corrected = Li_Ca/(mean(c(Calculations_612[[1]]$Li_Ca[1],Calculations_612[[2]]$Li_Ca[1]))/Constants$NIST612$Li_Ca[1]),
    B_Ca_NIST612_corrected = B_Ca/(mean(c(Calculations_612[[1]]$B_Ca[1],Calculations_612[[2]]$B_Ca[1]))/Constants$NIST612$B_Ca[1]),
    Mg_Ca_NIST612_corrected = Mg_Ca/(mean(c(Calculations_612[[1]]$Mg_Ca[1],Calculations_612[[2]]$Mg_Ca[1]))/Constants$NIST612$Mg_Ca[1]),
    P_Ca_NIST612_corrected = P_Ca/(mean(c(Calculations_612[[1]]$P_Ca[1],Calculations_612[[2]]$P_Ca[1]))/Constants$NIST612$P_Ca[1]),
    S_Ca_NIST612_corrected = S_Ca/(mean(c(Calculations_612[[1]]$S_Ca[1],Calculations_612[[2]]$S_Ca[1]))/Constants$NIST612$S_Ca[1]),
    Mn_Ca_NIST612_corrected = Mn_Ca/(mean(c(Calculations_612[[1]]$Mn_Ca[1],Calculations_612[[2]]$Mn_Ca[1]))/Constants$NIST612$Mn_Ca[1]),
    Sr_Ca_NIST612_corrected = Sr_Ca/(mean(c(Calculations_612[[1]]$Sr_Ca[1],Calculations_612[[2]]$Sr_Ca[1]))/Constants$NIST612$Sr_Ca[1]),
    Ba_Ca_NIST612_corrected = Ba_Ca/(mean(c(Calculations_612[[1]]$Ba_Ca[1],Calculations_612[[2]]$Ba_Ca[1]))/Constants$NIST612$Ba_Ca[1]),
    U_Ca_NIST612_corrected = U_Ca/(mean(c(Calculations_612[[1]]$U_Ca[1],Calculations_612[[2]]$U_Ca[1]))/Constants$NIST612$U_Ca[1])
    )
  
    NIST612_corrected_ratios <- NIST612_corrected_ratios %>%
    mutate(
      Li_Ca_umol_mol = Li_Ca_NIST612_corrected /(Constants$Element_constants$Mass[1]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      B_Ca_umol_mol = B_Ca_NIST612_corrected /(Constants$Element_constants$Mass[2]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      Mg_Ca_umol_mol = Mg_Ca_NIST612_corrected /(Constants$Element_constants$Mass[3]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      P_Ca_umol_mol = P_Ca_NIST612_corrected /(Constants$Element_constants$Mass[4]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      S_Ca_umol_mol = S_Ca_NIST612_corrected /(Constants$Element_constants$Mass[5]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      Mn_Ca_umol_mol = Mn_Ca_NIST612_corrected /(Constants$Element_constants$Mass[7]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      Sr_Ca_umol_mol = Sr_Ca_NIST612_corrected /(Constants$Element_constants$Mass[11]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      Ba_Ca_umol_mol = Ba_Ca_NIST612_corrected /(Constants$Element_constants$Mass[12]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      U_Ca_umol_mol = U_Ca_NIST612_corrected /(Constants$Element_constants$Mass[14]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2])
    )
    
assign(paste0(names(Analysis_Sample_23_16_1[i]), "_NIST612_Corrected"), NIST612_corrected_ratios)
NIST612_Corrected_Sample_23_16_1[[paste0(names(Analysis_Sample_23_16_1[i]), "_NIST612_Corrected")]] <- NIST612_corrected_ratios
}
# 612 2 & 3 ####
for (i in 1:length(Analysis_Sample_23_16_2)) {
  NIST612_corrected_ratios <-
  Analysis_Sample_23_16_2[[i]] %>%
    mutate(
    Li_Ca_NIST612_corrected = Li_Ca/(mean(c(Calculations_612[[2]]$Li_Ca[1],Calculations_612[[3]]$Li_Ca[1]))/Constants$NIST612$Li_Ca[1]),
    B_Ca_NIST612_corrected = B_Ca/(mean(c(Calculations_612[[2]]$B_Ca[1],Calculations_612[[3]]$B_Ca[1]))/Constants$NIST612$B_Ca[1]),
    Mg_Ca_NIST612_corrected = Mg_Ca/(mean(c(Calculations_612[[2]]$Mg_Ca[1],Calculations_612[[3]]$Mg_Ca[1]))/Constants$NIST612$Mg_Ca[1]),
    P_Ca_NIST612_corrected = P_Ca/(mean(c(Calculations_612[[2]]$P_Ca[1],Calculations_612[[3]]$P_Ca[1]))/Constants$NIST612$P_Ca[1]),
    S_Ca_NIST612_corrected = S_Ca/(mean(c(Calculations_612[[2]]$S_Ca[1],Calculations_612[[3]]$S_Ca[1]))/Constants$NIST612$S_Ca[1]),
    Mn_Ca_NIST612_corrected = Mn_Ca/(mean(c(Calculations_612[[2]]$Mn_Ca[1],Calculations_612[[3]]$Mn_Ca[1]))/Constants$NIST612$Mn_Ca[1]),
    Sr_Ca_NIST612_corrected = Sr_Ca/(mean(c(Calculations_612[[2]]$Sr_Ca[1],Calculations_612[[3]]$Sr_Ca[1]))/Constants$NIST612$Sr_Ca[1]),
    Ba_Ca_NIST612_corrected = Ba_Ca/(mean(c(Calculations_612[[2]]$Ba_Ca[1],Calculations_612[[3]]$Ba_Ca[1]))/Constants$NIST612$Ba_Ca[1]),
    U_Ca_NIST612_corrected = U_Ca/(mean(c(Calculations_612[[2]]$U_Ca[1],Calculations_612[[3]]$U_Ca[1]))/Constants$NIST612$U_Ca[1])
    )
  
    NIST612_corrected_ratios <- NIST612_corrected_ratios %>%
    mutate(
      Li_Ca_umol_mol = Li_Ca_NIST612_corrected /(Constants$Element_constants$Mass[1]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      B_Ca_umol_mol = B_Ca_NIST612_corrected /(Constants$Element_constants$Mass[2]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      Mg_Ca_umol_mol = Mg_Ca_NIST612_corrected /(Constants$Element_constants$Mass[3]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      P_Ca_umol_mol = P_Ca_NIST612_corrected /(Constants$Element_constants$Mass[4]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      S_Ca_umol_mol = S_Ca_NIST612_corrected /(Constants$Element_constants$Mass[5]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      Mn_Ca_umol_mol = Mn_Ca_NIST612_corrected /(Constants$Element_constants$Mass[7]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      Sr_Ca_umol_mol = Sr_Ca_NIST612_corrected /(Constants$Element_constants$Mass[11]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      Ba_Ca_umol_mol = Ba_Ca_NIST612_corrected /(Constants$Element_constants$Mass[12]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      U_Ca_umol_mol = U_Ca_NIST612_corrected /(Constants$Element_constants$Mass[14]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2])
    )
    
assign(paste0(names(Analysis_Sample_23_16_2[i]), "_NIST612_Corrected"), NIST612_corrected_ratios)
NIST612_Corrected_Sample_23_16_2[[paste0(names(Analysis_Sample_23_16_2[i]), "_NIST612_Corrected")]] <- NIST612_corrected_ratios
}
# 612 3 & 4 ####
for (i in 1:length(Analysis_Sample_23_16_3)) {
  NIST612_corrected_ratios <-
  Analysis_Sample_23_16_3[[i]] %>%
    mutate(
    Li_Ca_NIST612_corrected = Li_Ca/(mean(c(Calculations_612[[3]]$Li_Ca[1],Calculations_612[[4]]$Li_Ca[1]))/Constants$NIST612$Li_Ca[1]),
    B_Ca_NIST612_corrected = B_Ca/(mean(c(Calculations_612[[3]]$B_Ca[1],Calculations_612[[4]]$B_Ca[1]))/Constants$NIST612$B_Ca[1]),
    Mg_Ca_NIST612_corrected = Mg_Ca/(mean(c(Calculations_612[[3]]$Mg_Ca[1],Calculations_612[[4]]$Mg_Ca[1]))/Constants$NIST612$Mg_Ca[1]),
    P_Ca_NIST612_corrected = P_Ca/(mean(c(Calculations_612[[3]]$P_Ca[1],Calculations_612[[4]]$P_Ca[1]))/Constants$NIST612$P_Ca[1]),
    S_Ca_NIST612_corrected = S_Ca/(mean(c(Calculations_612[[3]]$S_Ca[1],Calculations_612[[4]]$S_Ca[1]))/Constants$NIST612$S_Ca[1]),
    Mn_Ca_NIST612_corrected = Mn_Ca/(mean(c(Calculations_612[[3]]$Mn_Ca[1],Calculations_612[[4]]$Mn_Ca[1]))/Constants$NIST612$Mn_Ca[1]),
    Sr_Ca_NIST612_corrected = Sr_Ca/(mean(c(Calculations_612[[3]]$Sr_Ca[1],Calculations_612[[4]]$Sr_Ca[1]))/Constants$NIST612$Sr_Ca[1]),
    Ba_Ca_NIST612_corrected = Ba_Ca/(mean(c(Calculations_612[[3]]$Ba_Ca[1],Calculations_612[[4]]$Ba_Ca[1]))/Constants$NIST612$Ba_Ca[1]),
    U_Ca_NIST612_corrected = U_Ca/(mean(c(Calculations_612[[3]]$U_Ca[1],Calculations_612[[4]]$U_Ca[1]))/Constants$NIST612$U_Ca[1])
    )
  
    NIST612_corrected_ratios <- NIST612_corrected_ratios %>%
    mutate(
      Li_Ca_umol_mol = Li_Ca_NIST612_corrected /(Constants$Element_constants$Mass[1]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      B_Ca_umol_mol = B_Ca_NIST612_corrected /(Constants$Element_constants$Mass[2]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      Mg_Ca_umol_mol = Mg_Ca_NIST612_corrected /(Constants$Element_constants$Mass[3]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      P_Ca_umol_mol = P_Ca_NIST612_corrected /(Constants$Element_constants$Mass[4]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      S_Ca_umol_mol = S_Ca_NIST612_corrected /(Constants$Element_constants$Mass[5]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      Mn_Ca_umol_mol = Mn_Ca_NIST612_corrected /(Constants$Element_constants$Mass[7]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      Sr_Ca_umol_mol = Sr_Ca_NIST612_corrected /(Constants$Element_constants$Mass[11]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      Ba_Ca_umol_mol = Ba_Ca_NIST612_corrected /(Constants$Element_constants$Mass[12]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      U_Ca_umol_mol = U_Ca_NIST612_corrected /(Constants$Element_constants$Mass[14]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2])
    )
    
assign(paste0(names(Analysis_Sample_23_16_3[i]), "_NIST612_Corrected"), NIST612_corrected_ratios)
NIST612_Corrected_Sample_23_16_3[[paste0(names(Analysis_Sample_23_16_3[i]), "_NIST612_Corrected")]] <- NIST612_corrected_ratios
}

NIST612_Corrected_Sample_23_16 <- list()
NIST612_Corrected_Sample_23_16[[paste0("NIST612_Corrected_Sample_23_16_1")]] <- NIST612_Corrected_Sample_23_16_1
NIST612_Corrected_Sample_23_16[[paste0("NIST612_Corrected_Sample_23_16_2")]] <- NIST612_Corrected_Sample_23_16_2
NIST612_Corrected_Sample_23_16[[paste0("NIST612_Corrected_Sample_23_16_3")]] <- NIST612_Corrected_Sample_23_16_3

# 612 4 & 5 ####
for (i in 1:length(Analysis_Sample_23_1_1)) {
  NIST612_corrected_ratios <-
  Analysis_Sample_23_1_1[[i]] %>%
    mutate(
    Li_Ca_NIST612_corrected = Li_Ca/(mean(c(Calculations_612[[4]]$Li_Ca[1],Calculations_612[[5]]$Li_Ca[1]))/Constants$NIST612$Li_Ca[1]),
    B_Ca_NIST612_corrected = B_Ca/(mean(c(Calculations_612[[4]]$B_Ca[1],Calculations_612[[5]]$B_Ca[1]))/Constants$NIST612$B_Ca[1]),
    Mg_Ca_NIST612_corrected = Mg_Ca/(mean(c(Calculations_612[[4]]$Mg_Ca[1],Calculations_612[[5]]$Mg_Ca[1]))/Constants$NIST612$Mg_Ca[1]),
    P_Ca_NIST612_corrected = P_Ca/(mean(c(Calculations_612[[4]]$P_Ca[1],Calculations_612[[5]]$P_Ca[1]))/Constants$NIST612$P_Ca[1]),
    S_Ca_NIST612_corrected = S_Ca/(mean(c(Calculations_612[[4]]$S_Ca[1],Calculations_612[[5]]$S_Ca[1]))/Constants$NIST612$S_Ca[1]),
    Mn_Ca_NIST612_corrected = Mn_Ca/(mean(c(Calculations_612[[4]]$Mn_Ca[1],Calculations_612[[5]]$Mn_Ca[1]))/Constants$NIST612$Mn_Ca[1]),
    Sr_Ca_NIST612_corrected = Sr_Ca/(mean(c(Calculations_612[[4]]$Sr_Ca[1],Calculations_612[[5]]$Sr_Ca[1]))/Constants$NIST612$Sr_Ca[1]),
    Ba_Ca_NIST612_corrected = Ba_Ca/(mean(c(Calculations_612[[4]]$Ba_Ca[1],Calculations_612[[5]]$Ba_Ca[1]))/Constants$NIST612$Ba_Ca[1]),
    U_Ca_NIST612_corrected = U_Ca/(mean(c(Calculations_612[[4]]$U_Ca[1],Calculations_612[[5]]$U_Ca[1]))/Constants$NIST612$U_Ca[1])
    )
  
    NIST612_corrected_ratios <- NIST612_corrected_ratios %>%
    mutate(
      Li_Ca_umol_mol = Li_Ca_NIST612_corrected /(Constants$Element_constants$Mass[1]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      B_Ca_umol_mol = B_Ca_NIST612_corrected /(Constants$Element_constants$Mass[2]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      Mg_Ca_umol_mol = Mg_Ca_NIST612_corrected /(Constants$Element_constants$Mass[3]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      P_Ca_umol_mol = P_Ca_NIST612_corrected /(Constants$Element_constants$Mass[4]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      S_Ca_umol_mol = S_Ca_NIST612_corrected /(Constants$Element_constants$Mass[5]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      Mn_Ca_umol_mol = Mn_Ca_NIST612_corrected /(Constants$Element_constants$Mass[7]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      Sr_Ca_umol_mol = Sr_Ca_NIST612_corrected /(Constants$Element_constants$Mass[11]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      Ba_Ca_umol_mol = Ba_Ca_NIST612_corrected /(Constants$Element_constants$Mass[12]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      U_Ca_umol_mol = U_Ca_NIST612_corrected /(Constants$Element_constants$Mass[14]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2])
    )
    
assign(paste0(names(Analysis_Sample_23_1_1[i]), "_NIST612_Corrected"), NIST612_corrected_ratios)
NIST612_Corrected_Sample_23_1_1[[paste0(names(Analysis_Sample_23_1_1[i]), "_NIST612_Corrected")]] <- NIST612_corrected_ratios
}
# 612 5 & 6 ####
for (i in 1:length(Analysis_Sample_23_1_2)) {
  NIST612_corrected_ratios <-
  Analysis_Sample_23_1_2[[i]] %>%
    mutate(
    Li_Ca_NIST612_corrected = Li_Ca/(mean(c(Calculations_612[[5]]$Li_Ca[1],Calculations_612[[6]]$Li_Ca[1]))/Constants$NIST612$Li_Ca[1]),
    B_Ca_NIST612_corrected = B_Ca/(mean(c(Calculations_612[[5]]$B_Ca[1],Calculations_612[[6]]$B_Ca[1]))/Constants$NIST612$B_Ca[1]),
    Mg_Ca_NIST612_corrected = Mg_Ca/(mean(c(Calculations_612[[5]]$Mg_Ca[1],Calculations_612[[6]]$Mg_Ca[1]))/Constants$NIST612$Mg_Ca[1]),
    P_Ca_NIST612_corrected = P_Ca/(mean(c(Calculations_612[[5]]$P_Ca[1],Calculations_612[[6]]$P_Ca[1]))/Constants$NIST612$P_Ca[1]),
    S_Ca_NIST612_corrected = S_Ca/(mean(c(Calculations_612[[5]]$S_Ca[1],Calculations_612[[6]]$S_Ca[1]))/Constants$NIST612$S_Ca[1]),
    Mn_Ca_NIST612_corrected = Mn_Ca/(mean(c(Calculations_612[[5]]$Mn_Ca[1],Calculations_612[[6]]$Mn_Ca[1]))/Constants$NIST612$Mn_Ca[1]),
    Sr_Ca_NIST612_corrected = Sr_Ca/(mean(c(Calculations_612[[5]]$Sr_Ca[1],Calculations_612[[6]]$Sr_Ca[1]))/Constants$NIST612$Sr_Ca[1]),
    Ba_Ca_NIST612_corrected = Ba_Ca/(mean(c(Calculations_612[[5]]$Ba_Ca[1],Calculations_612[[6]]$Ba_Ca[1]))/Constants$NIST612$Ba_Ca[1]),
    U_Ca_NIST612_corrected = U_Ca/(mean(c(Calculations_612[[5]]$U_Ca[1],Calculations_612[[6]]$U_Ca[1]))/Constants$NIST612$U_Ca[1])
    )
  
    NIST612_corrected_ratios <- NIST612_corrected_ratios %>%
    mutate(
      Li_Ca_umol_mol = Li_Ca_NIST612_corrected /(Constants$Element_constants$Mass[1]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      B_Ca_umol_mol = B_Ca_NIST612_corrected /(Constants$Element_constants$Mass[2]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      Mg_Ca_umol_mol = Mg_Ca_NIST612_corrected /(Constants$Element_constants$Mass[3]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      P_Ca_umol_mol = P_Ca_NIST612_corrected /(Constants$Element_constants$Mass[4]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      S_Ca_umol_mol = S_Ca_NIST612_corrected /(Constants$Element_constants$Mass[5]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      Mn_Ca_umol_mol = Mn_Ca_NIST612_corrected /(Constants$Element_constants$Mass[7]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      Sr_Ca_umol_mol = Sr_Ca_NIST612_corrected /(Constants$Element_constants$Mass[11]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      Ba_Ca_umol_mol = Ba_Ca_NIST612_corrected /(Constants$Element_constants$Mass[12]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      U_Ca_umol_mol = U_Ca_NIST612_corrected /(Constants$Element_constants$Mass[14]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2])
    )
    
assign(paste0(names(Analysis_Sample_23_1_2[i]), "_NIST612_Corrected"), NIST612_corrected_ratios)
NIST612_Corrected_Sample_23_1_2[[paste0(names(Analysis_Sample_23_1_2[i]), "_NIST612_Corrected")]] <- NIST612_corrected_ratios
}
# 612 6 & 7 ####
for (i in 1:length(Analysis_Sample_23_1_3)) {
  NIST612_corrected_ratios <-
  Analysis_Sample_23_1_3[[i]] %>%
    mutate(
    Li_Ca_NIST612_corrected = Li_Ca/(mean(c(Calculations_612[[6]]$Li_Ca[1],Calculations_612[[7]]$Li_Ca[1]))/Constants$NIST612$Li_Ca[1]),
    B_Ca_NIST612_corrected = B_Ca/(mean(c(Calculations_612[[6]]$B_Ca[1],Calculations_612[[7]]$B_Ca[1]))/Constants$NIST612$B_Ca[1]),
    Mg_Ca_NIST612_corrected = Mg_Ca/(mean(c(Calculations_612[[6]]$Mg_Ca[1],Calculations_612[[7]]$Mg_Ca[1]))/Constants$NIST612$Mg_Ca[1]),
    P_Ca_NIST612_corrected = P_Ca/(mean(c(Calculations_612[[6]]$P_Ca[1],Calculations_612[[7]]$P_Ca[1]))/Constants$NIST612$P_Ca[1]),
    S_Ca_NIST612_corrected = S_Ca/(mean(c(Calculations_612[[6]]$S_Ca[1],Calculations_612[[7]]$S_Ca[1]))/Constants$NIST612$S_Ca[1]),
    Mn_Ca_NIST612_corrected = Mn_Ca/(mean(c(Calculations_612[[6]]$Mn_Ca[1],Calculations_612[[7]]$Mn_Ca[1]))/Constants$NIST612$Mn_Ca[1]),
    Sr_Ca_NIST612_corrected = Sr_Ca/(mean(c(Calculations_612[[6]]$Sr_Ca[1],Calculations_612[[7]]$Sr_Ca[1]))/Constants$NIST612$Sr_Ca[1]),
    Ba_Ca_NIST612_corrected = Ba_Ca/(mean(c(Calculations_612[[6]]$Ba_Ca[1],Calculations_612[[7]]$Ba_Ca[1]))/Constants$NIST612$Ba_Ca[1]),
    U_Ca_NIST612_corrected = U_Ca/(mean(c(Calculations_612[[6]]$U_Ca[1],Calculations_612[[7]]$U_Ca[1]))/Constants$NIST612$U_Ca[1])
    )
  
    NIST612_corrected_ratios <- NIST612_corrected_ratios %>%
    mutate(
      Li_Ca_umol_mol = Li_Ca_NIST612_corrected /(Constants$Element_constants$Mass[1]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      B_Ca_umol_mol = B_Ca_NIST612_corrected /(Constants$Element_constants$Mass[2]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      Mg_Ca_umol_mol = Mg_Ca_NIST612_corrected /(Constants$Element_constants$Mass[3]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      P_Ca_umol_mol = P_Ca_NIST612_corrected /(Constants$Element_constants$Mass[4]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      S_Ca_umol_mol = S_Ca_NIST612_corrected /(Constants$Element_constants$Mass[5]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      Mn_Ca_umol_mol = Mn_Ca_NIST612_corrected /(Constants$Element_constants$Mass[7]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      Sr_Ca_umol_mol = Sr_Ca_NIST612_corrected /(Constants$Element_constants$Mass[11]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      Ba_Ca_umol_mol = Ba_Ca_NIST612_corrected /(Constants$Element_constants$Mass[12]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      U_Ca_umol_mol = U_Ca_NIST612_corrected /(Constants$Element_constants$Mass[14]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2])
    )
    
assign(paste0(names(Analysis_Sample_23_1_3[i]), "_NIST612_Corrected"), NIST612_corrected_ratios)
NIST612_Corrected_Sample_23_1_3[[paste0(names(Analysis_Sample_23_1_3[i]), "_NIST612_Corrected")]] <- NIST612_corrected_ratios
}

NIST612_Corrected_Sample_23_1 <- list()
NIST612_Corrected_Sample_23_1[[paste0("NIST612_Corrected_Sample_23_1_1")]] <- NIST612_Corrected_Sample_23_1_1
NIST612_Corrected_Sample_23_1[[paste0("NIST612_Corrected_Sample_23_1_2")]] <- NIST612_Corrected_Sample_23_1_2
NIST612_Corrected_Sample_23_1[[paste0("NIST612_Corrected_Sample_23_1_3")]] <- NIST612_Corrected_Sample_23_1_3

# 612 8 & 9 - as new day of ablation so different standards ####
for (i in 1:length(Analysis_Sample_23_10_1)) {
  NIST612_corrected_ratios <-
  Analysis_Sample_23_10_1[[i]] %>%
    mutate(
    Li_Ca_NIST612_corrected = Li_Ca/(mean(c(Calculations_612[[8]]$Li_Ca[1],Calculations_612[[9]]$Li_Ca[1]))/Constants$NIST612$Li_Ca[1]),
    B_Ca_NIST612_corrected = B_Ca/(mean(c(Calculations_612[[8]]$B_Ca[1],Calculations_612[[9]]$B_Ca[1]))/Constants$NIST612$B_Ca[1]),
    Mg_Ca_NIST612_corrected = Mg_Ca/(mean(c(Calculations_612[[8]]$Mg_Ca[1],Calculations_612[[9]]$Mg_Ca[1]))/Constants$NIST612$Mg_Ca[1]),
    P_Ca_NIST612_corrected = P_Ca/(mean(c(Calculations_612[[8]]$P_Ca[1],Calculations_612[[9]]$P_Ca[1]))/Constants$NIST612$P_Ca[1]),
    S_Ca_NIST612_corrected = S_Ca/(mean(c(Calculations_612[[8]]$S_Ca[1],Calculations_612[[9]]$S_Ca[1]))/Constants$NIST612$S_Ca[1]),
    Mn_Ca_NIST612_corrected = Mn_Ca/(mean(c(Calculations_612[[8]]$Mn_Ca[1],Calculations_612[[9]]$Mn_Ca[1]))/Constants$NIST612$Mn_Ca[1]),
    Sr_Ca_NIST612_corrected = Sr_Ca/(mean(c(Calculations_612[[8]]$Sr_Ca[1],Calculations_612[[9]]$Sr_Ca[1]))/Constants$NIST612$Sr_Ca[1]),
    Ba_Ca_NIST612_corrected = Ba_Ca/(mean(c(Calculations_612[[8]]$Ba_Ca[1],Calculations_612[[9]]$Ba_Ca[1]))/Constants$NIST612$Ba_Ca[1]),
    U_Ca_NIST612_corrected = U_Ca/(mean(c(Calculations_612[[8]]$U_Ca[1],Calculations_612[[9]]$U_Ca[1]))/Constants$NIST612$U_Ca[1])
    )
  
    NIST612_corrected_ratios <- NIST612_corrected_ratios %>%
    mutate(
      Li_Ca_umol_mol = Li_Ca_NIST612_corrected /(Constants$Element_constants$Mass[1]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      B_Ca_umol_mol = B_Ca_NIST612_corrected /(Constants$Element_constants$Mass[2]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      Mg_Ca_umol_mol = Mg_Ca_NIST612_corrected /(Constants$Element_constants$Mass[3]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      P_Ca_umol_mol = P_Ca_NIST612_corrected /(Constants$Element_constants$Mass[4]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      S_Ca_umol_mol = S_Ca_NIST612_corrected /(Constants$Element_constants$Mass[5]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      Mn_Ca_umol_mol = Mn_Ca_NIST612_corrected /(Constants$Element_constants$Mass[7]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      Sr_Ca_umol_mol = Sr_Ca_NIST612_corrected /(Constants$Element_constants$Mass[11]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      Ba_Ca_umol_mol = Ba_Ca_NIST612_corrected /(Constants$Element_constants$Mass[12]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      U_Ca_umol_mol = U_Ca_NIST612_corrected /(Constants$Element_constants$Mass[14]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2])
    )
    
assign(paste0(names(Analysis_Sample_23_10_1[i]), "_NIST612_Corrected"), NIST612_corrected_ratios)
NIST612_Corrected_Sample_23_10_1[[paste0(names(Analysis_Sample_23_10_1[i]), "_NIST612_Corrected")]] <- NIST612_corrected_ratios
}
# 612 9 & 10 ####
for (i in 1:length(Analysis_Sample_23_10_2)) {
  NIST612_corrected_ratios <-
  Analysis_Sample_23_10_2[[i]] %>%
    mutate(
    Li_Ca_NIST612_corrected = Li_Ca/(mean(c(Calculations_612[[9]]$Li_Ca[1],Calculations_612[[10]]$Li_Ca[1]))/Constants$NIST612$Li_Ca[1]),
    B_Ca_NIST612_corrected = B_Ca/(mean(c(Calculations_612[[9]]$B_Ca[1],Calculations_612[[10]]$B_Ca[1]))/Constants$NIST612$B_Ca[1]),
    Mg_Ca_NIST612_corrected = Mg_Ca/(mean(c(Calculations_612[[9]]$Mg_Ca[1],Calculations_612[[10]]$Mg_Ca[1]))/Constants$NIST612$Mg_Ca[1]),
    P_Ca_NIST612_corrected = P_Ca/(mean(c(Calculations_612[[9]]$P_Ca[1],Calculations_612[[10]]$P_Ca[1]))/Constants$NIST612$P_Ca[1]),
    S_Ca_NIST612_corrected = S_Ca/(mean(c(Calculations_612[[9]]$S_Ca[1],Calculations_612[[10]]$S_Ca[1]))/Constants$NIST612$S_Ca[1]),
    Mn_Ca_NIST612_corrected = Mn_Ca/(mean(c(Calculations_612[[9]]$Mn_Ca[1],Calculations_612[[10]]$Mn_Ca[1]))/Constants$NIST612$Mn_Ca[1]),
    Sr_Ca_NIST612_corrected = Sr_Ca/(mean(c(Calculations_612[[9]]$Sr_Ca[1],Calculations_612[[10]]$Sr_Ca[1]))/Constants$NIST612$Sr_Ca[1]),
    Ba_Ca_NIST612_corrected = Ba_Ca/(mean(c(Calculations_612[[9]]$Ba_Ca[1],Calculations_612[[10]]$Ba_Ca[1]))/Constants$NIST612$Ba_Ca[1]),
    U_Ca_NIST612_corrected = U_Ca/(mean(c(Calculations_612[[9]]$U_Ca[1],Calculations_612[[10]]$U_Ca[1]))/Constants$NIST612$U_Ca[1])
    )
  
    NIST612_corrected_ratios <- NIST612_corrected_ratios %>%
    mutate(
      Li_Ca_umol_mol = Li_Ca_NIST612_corrected /(Constants$Element_constants$Mass[1]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      B_Ca_umol_mol = B_Ca_NIST612_corrected /(Constants$Element_constants$Mass[2]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      Mg_Ca_umol_mol = Mg_Ca_NIST612_corrected /(Constants$Element_constants$Mass[3]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      P_Ca_umol_mol = P_Ca_NIST612_corrected /(Constants$Element_constants$Mass[4]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      S_Ca_umol_mol = S_Ca_NIST612_corrected /(Constants$Element_constants$Mass[5]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      Mn_Ca_umol_mol = Mn_Ca_NIST612_corrected /(Constants$Element_constants$Mass[7]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      Sr_Ca_umol_mol = Sr_Ca_NIST612_corrected /(Constants$Element_constants$Mass[11]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      Ba_Ca_umol_mol = Ba_Ca_NIST612_corrected /(Constants$Element_constants$Mass[12]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      U_Ca_umol_mol = U_Ca_NIST612_corrected /(Constants$Element_constants$Mass[14]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2])
    )
    
assign(paste0(names(Analysis_Sample_23_10_2[i]), "_NIST612_Corrected"), NIST612_corrected_ratios)
NIST612_Corrected_Sample_23_10_2[[paste0(names(Analysis_Sample_23_10_2[i]), "_NIST612_Corrected")]] <- NIST612_corrected_ratios
}
# 612 10 & 11 ####
for (i in 1:length(Analysis_Sample_23_10_3)) {
  NIST612_corrected_ratios <-
  Analysis_Sample_23_10_3[[i]] %>%
    mutate(
    Li_Ca_NIST612_corrected = Li_Ca/(mean(c(Calculations_612[[10]]$Li_Ca[1],Calculations_612[[11]]$Li_Ca[1]))/Constants$NIST612$Li_Ca[1]),
    B_Ca_NIST612_corrected = B_Ca/(mean(c(Calculations_612[[10]]$B_Ca[1],Calculations_612[[11]]$B_Ca[1]))/Constants$NIST612$B_Ca[1]),
    Mg_Ca_NIST612_corrected = Mg_Ca/(mean(c(Calculations_612[[10]]$Mg_Ca[1],Calculations_612[[11]]$Mg_Ca[1]))/Constants$NIST612$Mg_Ca[1]),
    P_Ca_NIST612_corrected = P_Ca/(mean(c(Calculations_612[[10]]$P_Ca[1],Calculations_612[[11]]$P_Ca[1]))/Constants$NIST612$P_Ca[1]),
    S_Ca_NIST612_corrected = S_Ca/(mean(c(Calculations_612[[10]]$S_Ca[1],Calculations_612[[11]]$S_Ca[1]))/Constants$NIST612$S_Ca[1]),
    Mn_Ca_NIST612_corrected = Mn_Ca/(mean(c(Calculations_612[[10]]$Mn_Ca[1],Calculations_612[[11]]$Mn_Ca[1]))/Constants$NIST612$Mn_Ca[1]),
    Sr_Ca_NIST612_corrected = Sr_Ca/(mean(c(Calculations_612[[10]]$Sr_Ca[1],Calculations_612[[11]]$Sr_Ca[1]))/Constants$NIST612$Sr_Ca[1]),
    Ba_Ca_NIST612_corrected = Ba_Ca/(mean(c(Calculations_612[[10]]$Ba_Ca[1],Calculations_612[[11]]$Ba_Ca[1]))/Constants$NIST612$Ba_Ca[1]),
    U_Ca_NIST612_corrected = U_Ca/(mean(c(Calculations_612[[10]]$U_Ca[1],Calculations_612[[11]]$U_Ca[1]))/Constants$NIST612$U_Ca[1])
    )
  
    NIST612_corrected_ratios <- NIST612_corrected_ratios %>%
    mutate(
      Li_Ca_umol_mol = Li_Ca_NIST612_corrected /(Constants$Element_constants$Mass[1]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      B_Ca_umol_mol = B_Ca_NIST612_corrected /(Constants$Element_constants$Mass[2]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      Mg_Ca_umol_mol = Mg_Ca_NIST612_corrected /(Constants$Element_constants$Mass[3]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      P_Ca_umol_mol = P_Ca_NIST612_corrected /(Constants$Element_constants$Mass[4]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      S_Ca_umol_mol = S_Ca_NIST612_corrected /(Constants$Element_constants$Mass[5]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      Mn_Ca_umol_mol = Mn_Ca_NIST612_corrected /(Constants$Element_constants$Mass[7]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      Sr_Ca_umol_mol = Sr_Ca_NIST612_corrected /(Constants$Element_constants$Mass[11]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      Ba_Ca_umol_mol = Ba_Ca_NIST612_corrected /(Constants$Element_constants$Mass[12]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      U_Ca_umol_mol = U_Ca_NIST612_corrected /(Constants$Element_constants$Mass[14]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2])
    )
    
assign(paste0(names(Analysis_Sample_23_10_3[i]), "_NIST612_Corrected"), NIST612_corrected_ratios)
NIST612_Corrected_Sample_23_10_3[[paste0(names(Analysis_Sample_23_10_3[i]), "_NIST612_Corrected")]] <- NIST612_corrected_ratios
}

NIST612_Corrected_Sample_23_10 <- list()
NIST612_Corrected_Sample_23_10[[paste0("NIST612_Corrected_Sample_23_10_1")]] <- NIST612_Corrected_Sample_23_10_1
NIST612_Corrected_Sample_23_10[[paste0("NIST612_Corrected_Sample_23_10_2")]] <- NIST612_Corrected_Sample_23_10_2
NIST612_Corrected_Sample_23_10[[paste0("NIST612_Corrected_Sample_23_10_3")]] <- NIST612_Corrected_Sample_23_10_3

# 612 11 & 12 ####
for (i in 1:length(Analysis_Sample_23_6_1)) {
  NIST612_corrected_ratios <-
  Analysis_Sample_23_6_1[[i]] %>%
    mutate(
    Li_Ca_NIST612_corrected = Li_Ca/(mean(c(Calculations_612[[11]]$Li_Ca[1],Calculations_612[[12]]$Li_Ca[1]))/Constants$NIST612$Li_Ca[1]),
    B_Ca_NIST612_corrected = B_Ca/(mean(c(Calculations_612[[11]]$B_Ca[1],Calculations_612[[12]]$B_Ca[1]))/Constants$NIST612$B_Ca[1]),
    Mg_Ca_NIST612_corrected = Mg_Ca/(mean(c(Calculations_612[[11]]$Mg_Ca[1],Calculations_612[[12]]$Mg_Ca[1]))/Constants$NIST612$Mg_Ca[1]),
    P_Ca_NIST612_corrected = P_Ca/(mean(c(Calculations_612[[11]]$P_Ca[1],Calculations_612[[12]]$P_Ca[1]))/Constants$NIST612$P_Ca[1]),
    S_Ca_NIST612_corrected = S_Ca/(mean(c(Calculations_612[[11]]$S_Ca[1],Calculations_612[[12]]$S_Ca[1]))/Constants$NIST612$S_Ca[1]),
    Mn_Ca_NIST612_corrected = Mn_Ca/(mean(c(Calculations_612[[11]]$Mn_Ca[1],Calculations_612[[12]]$Mn_Ca[1]))/Constants$NIST612$Mn_Ca[1]),
    Sr_Ca_NIST612_corrected = Sr_Ca/(mean(c(Calculations_612[[11]]$Sr_Ca[1],Calculations_612[[12]]$Sr_Ca[1]))/Constants$NIST612$Sr_Ca[1]),
    Ba_Ca_NIST612_corrected = Ba_Ca/(mean(c(Calculations_612[[11]]$Ba_Ca[1],Calculations_612[[12]]$Ba_Ca[1]))/Constants$NIST612$Ba_Ca[1]),
    U_Ca_NIST612_corrected = U_Ca/(mean(c(Calculations_612[[11]]$U_Ca[1],Calculations_612[[12]]$U_Ca[1]))/Constants$NIST612$U_Ca[1])
    )
  
    NIST612_corrected_ratios <- NIST612_corrected_ratios %>%
    mutate(
      Li_Ca_umol_mol = Li_Ca_NIST612_corrected /(Constants$Element_constants$Mass[1]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      B_Ca_umol_mol = B_Ca_NIST612_corrected /(Constants$Element_constants$Mass[2]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      Mg_Ca_umol_mol = Mg_Ca_NIST612_corrected /(Constants$Element_constants$Mass[3]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      P_Ca_umol_mol = P_Ca_NIST612_corrected /(Constants$Element_constants$Mass[4]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      S_Ca_umol_mol = S_Ca_NIST612_corrected /(Constants$Element_constants$Mass[5]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      Mn_Ca_umol_mol = Mn_Ca_NIST612_corrected /(Constants$Element_constants$Mass[7]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      Sr_Ca_umol_mol = Sr_Ca_NIST612_corrected /(Constants$Element_constants$Mass[11]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      Ba_Ca_umol_mol = Ba_Ca_NIST612_corrected /(Constants$Element_constants$Mass[12]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      U_Ca_umol_mol = U_Ca_NIST612_corrected /(Constants$Element_constants$Mass[14]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2])
    )
    
assign(paste0(names(Analysis_Sample_23_6_1[i]), "_NIST612_Corrected"), NIST612_corrected_ratios)
NIST612_Corrected_Sample_23_6_1[[paste0(names(Analysis_Sample_23_6_1[i]), "_NIST612_Corrected")]] <- NIST612_corrected_ratios
}
# 612 12 & 13 ####
for (i in 1:length(Analysis_Sample_23_6_2)) {
  NIST612_corrected_ratios <-
  Analysis_Sample_23_6_2[[i]] %>%
    mutate(
    Li_Ca_NIST612_corrected = Li_Ca/(mean(c(Calculations_612[[12]]$Li_Ca[1],Calculations_612[[13]]$Li_Ca[1]))/Constants$NIST612$Li_Ca[1]),
    B_Ca_NIST612_corrected = B_Ca/(mean(c(Calculations_612[[12]]$B_Ca[1],Calculations_612[[13]]$B_Ca[1]))/Constants$NIST612$B_Ca[1]),
    Mg_Ca_NIST612_corrected = Mg_Ca/(mean(c(Calculations_612[[12]]$Mg_Ca[1],Calculations_612[[13]]$Mg_Ca[1]))/Constants$NIST612$Mg_Ca[1]),
    P_Ca_NIST612_corrected = P_Ca/(mean(c(Calculations_612[[12]]$P_Ca[1],Calculations_612[[13]]$P_Ca[1]))/Constants$NIST612$P_Ca[1]),
    S_Ca_NIST612_corrected = S_Ca/(mean(c(Calculations_612[[12]]$S_Ca[1],Calculations_612[[13]]$S_Ca[1]))/Constants$NIST612$S_Ca[1]),
    Mn_Ca_NIST612_corrected = Mn_Ca/(mean(c(Calculations_612[[12]]$Mn_Ca[1],Calculations_612[[13]]$Mn_Ca[1]))/Constants$NIST612$Mn_Ca[1]),
    Sr_Ca_NIST612_corrected = Sr_Ca/(mean(c(Calculations_612[[12]]$Sr_Ca[1],Calculations_612[[13]]$Sr_Ca[1]))/Constants$NIST612$Sr_Ca[1]),
    Ba_Ca_NIST612_corrected = Ba_Ca/(mean(c(Calculations_612[[12]]$Ba_Ca[1],Calculations_612[[13]]$Ba_Ca[1]))/Constants$NIST612$Ba_Ca[1]),
    U_Ca_NIST612_corrected = U_Ca/(mean(c(Calculations_612[[12]]$U_Ca[1],Calculations_612[[13]]$U_Ca[1]))/Constants$NIST612$U_Ca[1])
    )
  
    NIST612_corrected_ratios <- NIST612_corrected_ratios %>%
    mutate(
      Li_Ca_umol_mol = Li_Ca_NIST612_corrected /(Constants$Element_constants$Mass[1]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      B_Ca_umol_mol = B_Ca_NIST612_corrected /(Constants$Element_constants$Mass[2]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      Mg_Ca_umol_mol = Mg_Ca_NIST612_corrected /(Constants$Element_constants$Mass[3]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      P_Ca_umol_mol = P_Ca_NIST612_corrected /(Constants$Element_constants$Mass[4]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      S_Ca_umol_mol = S_Ca_NIST612_corrected /(Constants$Element_constants$Mass[5]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      Mn_Ca_umol_mol = Mn_Ca_NIST612_corrected /(Constants$Element_constants$Mass[7]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      Sr_Ca_umol_mol = Sr_Ca_NIST612_corrected /(Constants$Element_constants$Mass[11]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      Ba_Ca_umol_mol = Ba_Ca_NIST612_corrected /(Constants$Element_constants$Mass[12]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      U_Ca_umol_mol = U_Ca_NIST612_corrected /(Constants$Element_constants$Mass[14]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2])
    )
    
assign(paste0(names(Analysis_Sample_23_6_2[i]), "_NIST612_Corrected"), NIST612_corrected_ratios)
NIST612_Corrected_Sample_23_6_2[[paste0(names(Analysis_Sample_23_6_2[i]), "_NIST612_Corrected")]] <- NIST612_corrected_ratios
}
# 612 13 & 14 ####
for (i in 1:length(Analysis_Sample_23_6_3)) {
  NIST612_corrected_ratios <-
  Analysis_Sample_23_6_3[[i]] %>%
    mutate(
    Li_Ca_NIST612_corrected = Li_Ca/(mean(c(Calculations_612[[13]]$Li_Ca[1],Calculations_612[[14]]$Li_Ca[1]))/Constants$NIST612$Li_Ca[1]),
    B_Ca_NIST612_corrected = B_Ca/(mean(c(Calculations_612[[13]]$B_Ca[1],Calculations_612[[14]]$B_Ca[1]))/Constants$NIST612$B_Ca[1]),
    Mg_Ca_NIST612_corrected = Mg_Ca/(mean(c(Calculations_612[[13]]$Mg_Ca[1],Calculations_612[[14]]$Mg_Ca[1]))/Constants$NIST612$Mg_Ca[1]),
    P_Ca_NIST612_corrected = P_Ca/(mean(c(Calculations_612[[13]]$P_Ca[1],Calculations_612[[14]]$P_Ca[1]))/Constants$NIST612$P_Ca[1]),
    S_Ca_NIST612_corrected = S_Ca/(mean(c(Calculations_612[[13]]$S_Ca[1],Calculations_612[[14]]$S_Ca[1]))/Constants$NIST612$S_Ca[1]),
    Mn_Ca_NIST612_corrected = Mn_Ca/(mean(c(Calculations_612[[13]]$Mn_Ca[1],Calculations_612[[14]]$Mn_Ca[1]))/Constants$NIST612$Mn_Ca[1]),
    Sr_Ca_NIST612_corrected = Sr_Ca/(mean(c(Calculations_612[[13]]$Sr_Ca[1],Calculations_612[[14]]$Sr_Ca[1]))/Constants$NIST612$Sr_Ca[1]),
    Ba_Ca_NIST612_corrected = Ba_Ca/(mean(c(Calculations_612[[13]]$Ba_Ca[1],Calculations_612[[14]]$Ba_Ca[1]))/Constants$NIST612$Ba_Ca[1]),
    U_Ca_NIST612_corrected = U_Ca/(mean(c(Calculations_612[[13]]$U_Ca[1],Calculations_612[[14]]$U_Ca[1]))/Constants$NIST612$U_Ca[1])
    )
  
    NIST612_corrected_ratios <- NIST612_corrected_ratios %>%
    mutate(
      Li_Ca_umol_mol = Li_Ca_NIST612_corrected /(Constants$Element_constants$Mass[1]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      B_Ca_umol_mol = B_Ca_NIST612_corrected /(Constants$Element_constants$Mass[2]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      Mg_Ca_umol_mol = Mg_Ca_NIST612_corrected /(Constants$Element_constants$Mass[3]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      P_Ca_umol_mol = P_Ca_NIST612_corrected /(Constants$Element_constants$Mass[4]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      S_Ca_umol_mol = S_Ca_NIST612_corrected /(Constants$Element_constants$Mass[5]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      Mn_Ca_umol_mol = Mn_Ca_NIST612_corrected /(Constants$Element_constants$Mass[7]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      Sr_Ca_umol_mol = Sr_Ca_NIST612_corrected /(Constants$Element_constants$Mass[11]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      Ba_Ca_umol_mol = Ba_Ca_NIST612_corrected /(Constants$Element_constants$Mass[12]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      U_Ca_umol_mol = U_Ca_NIST612_corrected /(Constants$Element_constants$Mass[14]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2])
    )
    
assign(paste0(names(Analysis_Sample_23_6_3[i]), "_NIST612_Corrected"), NIST612_corrected_ratios)
NIST612_Corrected_Sample_23_6_3[[paste0(names(Analysis_Sample_23_6_3[i]), "_NIST612_Corrected")]] <- NIST612_corrected_ratios
}

NIST612_Corrected_Sample_23_6 <- list()
NIST612_Corrected_Sample_23_6[[paste0("NIST612_Corrected_Sample_23_6_1")]] <- NIST612_Corrected_Sample_23_6_1
NIST612_Corrected_Sample_23_6[[paste0("NIST612_Corrected_Sample_23_6_2")]] <- NIST612_Corrected_Sample_23_6_2
NIST612_Corrected_Sample_23_6[[paste0("NIST612_Corrected_Sample_23_6_3")]] <- NIST612_Corrected_Sample_23_6_3

NIST612_Corrected_Samples <- list()
NIST612_Corrected_Samples[[paste0("NIST612_Corrected_Sample_23_16")]] <- NIST612_Corrected_Sample_23_16
NIST612_Corrected_Samples[[paste0("NIST612_Corrected_Sample_23_1")]] <- NIST612_Corrected_Sample_23_1
NIST612_Corrected_Samples[[paste0("NIST612_Corrected_Sample_23_10")]] <- NIST612_Corrected_Sample_23_10
NIST612_Corrected_Samples[[paste0("NIST612_Corrected_Sample_23_6")]] <- NIST612_Corrected_Sample_23_6

i <-1
j <- 1
x <- 1
for (i in 1:length(NIST612_Corrected_Samples)) {
  for (j in 1:length(NIST612_Corrected_Samples[[i]])) {
    for (x in 1:length(NIST612_Corrected_Samples[[i]][[j]])) {
      filename = paste(names(NIST612_Corrected_Samples[[i]][[j]])[[x]], ".csv")
      write.csv(NIST612_Corrected_Samples[[i]][[j]][[x]], filename)
    }
  }
}

```

Summary tables for mean values of standards to check the accuracy of measurements ((i) Deep Sea Coral post-JCP normalisation (ii) JCP and Deep Sea Coral post-NIST612 normalisation)
```{r Standard Summaries, echo = F, message=T}

# NIST612 Summary - JCP and DSC ####
View(Calculations_JCP)
View(Calculations_612)
NIST612_Corrected_JCP <- list()
i<-1
select
## JCP ####
for (i in 1:length(Calculations_JCP)) {
  NIST612_corrected_ratios <-
  Calculations_JCP[[i]] %>%
    slice(1L,8L) %>% # select mean(-values 2SD outside) + %2SE
    dplyr::select(42:50) %>% # select only ratios
    mutate(
    Li_Ca_NIST612_corrected = Li_Ca[1]/(mean(c(Calculations_612[[i]]$Li_Ca[1],Calculations_612[[i+1]]$Li_Ca[1]))/Constants$NIST612$Li_Ca[1]),
    Li_Ca_NIST612_corrected_2SE = Li_Ca_NIST612_corrected*(sqrt(((sd(c(Calculations_612[[i]]$Li_Ca[1],Calculations_612[[i+1]]$Li_Ca[1]))/mean(c(Calculations_612[[i]]$Li_Ca[1],Calculations_612[[i+1]]$Li_Ca[1]))*100)^2)+(Calculations_JCP[[i]]$Li_Ca[8]^2)))/100,
    B_Ca_NIST612_corrected = B_Ca[1]/(mean(c(Calculations_612[[i]]$B_Ca[1],Calculations_612[[i+1]]$B_Ca[1]))/Constants$NIST612$B_Ca[1]),
    B_Ca_NIST612_corrected_2SE = B_Ca_NIST612_corrected*(sqrt(((sd(c(Calculations_612[[i]]$B_Ca[1],Calculations_612[[i+1]]$B_Ca[1]))/mean(c(Calculations_612[[i]]$B_Ca[1],Calculations_612[[i+1]]$B_Ca[1]))*100)^2)+(Calculations_JCP[[i]]$B_Ca[8]^2)))/100,
    Mg_Ca_NIST612_corrected = Mg_Ca[1]/(mean(c(Calculations_612[[i]]$Mg_Ca[1],Calculations_612[[i+1]]$Mg_Ca[1]))/Constants$NIST612$Mg_Ca[1]),
    Mg_Ca_NIST612_corrected_2SE = Mg_Ca_NIST612_corrected*(sqrt(((sd(c(Calculations_612[[i]]$Mg_Ca[1],Calculations_612[[i+1]]$Mg_Ca[1]))/mean(c(Calculations_612[[i]]$Mg_Ca[1],Calculations_612[[i+1]]$Mg_Ca[1]))*100)^2)+(Calculations_JCP[[i]]$Mg_Ca[8]^2)))/100,
    P_Ca_NIST612_corrected = P_Ca[1]/(mean(c(Calculations_612[[i]]$P_Ca[1],Calculations_612[[i+1]]$P_Ca[1]))/Constants$NIST612$P_Ca[1]),
    P_Ca_NIST612_corrected_2SE = P_Ca_NIST612_corrected*(sqrt(((sd(c(Calculations_612[[i]]$P_Ca[1],Calculations_612[[i+1]]$P_Ca[1]))/mean(c(Calculations_612[[i]]$P_Ca[1],Calculations_612[[i+1]]$P_Ca[1]))*100)^2)+(Calculations_JCP[[i]]$P_Ca[8]^2)))/100,
    S_Ca_NIST612_corrected = S_Ca[1]/(mean(c(Calculations_612[[i]]$S_Ca[1],Calculations_612[[i+1]]$S_Ca[1]))/Constants$NIST612$S_Ca[1]),
    S_Ca_NIST612_corrected_2SE = S_Ca_NIST612_corrected*(sqrt(((sd(c(Calculations_612[[i]]$S_Ca[1],Calculations_612[[i+1]]$S_Ca[1]))/mean(c(Calculations_612[[i]]$S_Ca[1],Calculations_612[[i+1]]$S_Ca[1]))*100)^2)+(Calculations_JCP[[i]]$S_Ca[8]^2)))/100,
    Mn_Ca_NIST612_corrected = Mn_Ca[1]/(mean(c(Calculations_612[[i]]$Mn_Ca[1],Calculations_612[[i+1]]$Mn_Ca[1]))/Constants$NIST612$Mn_Ca[1]),
    Mn_Ca_NIST612_corrected_2SE = Mn_Ca_NIST612_corrected*(sqrt(((sd(c(Calculations_612[[i]]$Mn_Ca[1],Calculations_612[[i+1]]$Mn_Ca[1]))/mean(c(Calculations_612[[i]]$Mn_Ca[1],Calculations_612[[i+1]]$Mn_Ca[1]))*100)^2)+(Calculations_JCP[[i]]$Mn_Ca[8]^2)))/100,
    Sr_Ca_NIST612_corrected = Sr_Ca[1]/(mean(c(Calculations_612[[i]]$Sr_Ca[1],Calculations_612[[i+1]]$Sr_Ca[1]))/Constants$NIST612$Sr_Ca[1]),
    Sr_Ca_NIST612_corrected_2SE = Sr_Ca_NIST612_corrected*(sqrt(((sd(c(Calculations_612[[i]]$Sr_Ca[1],Calculations_612[[i+1]]$Sr_Ca[1]))/mean(c(Calculations_612[[i]]$Sr_Ca[1],Calculations_612[[i+1]]$Sr_Ca[1]))*100)^2)+(Calculations_JCP[[i]]$Sr_Ca[8]^2)))/100,
    Ba_Ca_NIST612_corrected = Ba_Ca[1]/(mean(c(Calculations_612[[i]]$Ba_Ca[1],Calculations_612[[i+1]]$Ba_Ca[1]))/Constants$NIST612$Ba_Ca[1]),
    Ba_Ca_NIST612_corrected_2SE = Ba_Ca_NIST612_corrected*(sqrt(((sd(c(Calculations_612[[i]]$Ba_Ca[1],Calculations_612[[i+1]]$Ba_Ca[1]))/mean(c(Calculations_612[[i]]$Ba_Ca[1],Calculations_612[[i+1]]$Ba_Ca[1]))*100)^2)+(Calculations_JCP[[i]]$Ba_Ca[8]^2)))/100,
    U_Ca_NIST612_corrected = U_Ca[1]/(mean(c(Calculations_612[[i]]$U_Ca[1],Calculations_612[[i+1]]$U_Ca[1]))/Constants$NIST612$U_Ca[1]),
    U_Ca_NIST612_corrected_2SE = U_Ca_NIST612_corrected*(sqrt(((sd(c(Calculations_612[[i]]$U_Ca[1],Calculations_612[[i+1]]$U_Ca[1]))/mean(c(Calculations_612[[i]]$U_Ca[1],Calculations_612[[i+1]]$U_Ca[1]))*100)^2)+(Calculations_JCP[[i]]$U_Ca[8]^2)))/100,
    )
                                                           
NIST612_corrected_ratios <- NIST612_corrected_ratios %>%
  slice(1L) %>% #remove row for %2SE
  dplyr::select(10:27) %>%
    mutate(
      Li_Ca_umol_mol = Li_Ca_NIST612_corrected /(Constants$Element_constants$Mass[1]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      Li_Ca_umol_mol_2SE = Li_Ca_umol_mol/100*(Li_Ca_NIST612_corrected_2SE/Li_Ca_NIST612_corrected*100),
      B_Ca_umol_mol = B_Ca_NIST612_corrected /(Constants$Element_constants$Mass[2]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      B_Ca_umol_mol_2SE = B_Ca_umol_mol/100*(B_Ca_NIST612_corrected_2SE/B_Ca_NIST612_corrected*100),
      Mg_Ca_umol_mol = Mg_Ca_NIST612_corrected /(Constants$Element_constants$Mass[3]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      Mg_Ca_umol_mol_2SE = Mg_Ca_umol_mol/100*(Mg_Ca_NIST612_corrected_2SE/Mg_Ca_NIST612_corrected*100),
      P_Ca_umol_mol = P_Ca_NIST612_corrected /(Constants$Element_constants$Mass[4]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      P_Ca_umol_mol_2SE = P_Ca_umol_mol/100*(P_Ca_NIST612_corrected_2SE/P_Ca_NIST612_corrected*100),
      S_Ca_umol_mol = S_Ca_NIST612_corrected /(Constants$Element_constants$Mass[5]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      S_Ca_umol_mol_2SE = S_Ca_umol_mol/100*(S_Ca_NIST612_corrected_2SE/S_Ca_NIST612_corrected*100),
      Mn_Ca_umol_mol = Mn_Ca_NIST612_corrected /(Constants$Element_constants$Mass[7]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      Mn_Ca_umol_mol_2SE = Mn_Ca_umol_mol/100*(Mn_Ca_NIST612_corrected_2SE/Mn_Ca_NIST612_corrected*100),
      Sr_Ca_umol_mol = Sr_Ca_NIST612_corrected /(Constants$Element_constants$Mass[11]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      Sr_Ca_umol_mol_2SE = Sr_Ca_umol_mol/100*(Sr_Ca_NIST612_corrected_2SE/Sr_Ca_NIST612_corrected*100),
      Ba_Ca_umol_mol = Ba_Ca_NIST612_corrected /(Constants$Element_constants$Mass[12]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      Ba_Ca_umol_mol_2SE = Ba_Ca_umol_mol/100*(Ba_Ca_NIST612_corrected_2SE/Ba_Ca_NIST612_corrected*100),
      U_Ca_umol_mol = U_Ca_NIST612_corrected /(Constants$Element_constants$Mass[14]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      U_Ca_umol_mol_2SE = U_Ca_umol_mol/100*(U_Ca_NIST612_corrected_2SE/U_Ca_NIST612_corrected*100),
    )

assign(paste0(names(Calculations_JCP[i]), "_NIST612_Corrected_Means"), NIST612_corrected_ratios)
NIST612_Corrected_JCP[[paste0(names(Calculations_JCP[i]), "_NIST612_Corrected_Means")]] <- NIST612_corrected_ratios
}

JCP_Summary_table_NIST612 <- data.frame(JCP = c(1:13, "", "mean", "2SD", "%2SD", "Expected", "Accuracy"))
for (i in 1:length(NIST612_Corrected_JCP)) {
  JCP_Summary_table_NIST612[JCP_Summary_table_NIST612$JCP == i, "Li_Ca_umol_mol"] <- NIST612_Corrected_JCP[[i]]$Li_Ca_umol_mol
  JCP_Summary_table_NIST612[JCP_Summary_table_NIST612$JCP == i, "Li_Ca_umol_mol_2SE"] <- NIST612_Corrected_JCP[[i]]$Li_Ca_umol_mol_2SE
  JCP_Summary_table_NIST612[JCP_Summary_table_NIST612$JCP == i, "B_Ca_umol_mol"] <- NIST612_Corrected_JCP[[i]]$B_Ca_umol_mol
  JCP_Summary_table_NIST612[JCP_Summary_table_NIST612$JCP == i, "B_Ca_umol_mol_2SE"] <- NIST612_Corrected_JCP[[i]]$B_Ca_umol_mol_2SE
  JCP_Summary_table_NIST612[JCP_Summary_table_NIST612$JCP == i, "Mg_Ca_umol_mol"] <- NIST612_Corrected_JCP[[i]]$Mg_Ca_umol_mol
  JCP_Summary_table_NIST612[JCP_Summary_table_NIST612$JCP == i, "Mg_Ca_umol_mol_2SE"] <- NIST612_Corrected_JCP[[i]]$Mg_Ca_umol_mol_2SE
  JCP_Summary_table_NIST612[JCP_Summary_table_NIST612$JCP == i, "P_Ca_umol_mol"] <- NIST612_Corrected_JCP[[i]]$P_Ca_umol_mol
  JCP_Summary_table_NIST612[JCP_Summary_table_NIST612$JCP == i, "P_Ca_umol_mol_2SE"] <- NIST612_Corrected_JCP[[i]]$P_Ca_umol_mol_2SE
  JCP_Summary_table_NIST612[JCP_Summary_table_NIST612$JCP == i, "S_Ca_umol_mol"] <- NIST612_Corrected_JCP[[i]]$S_Ca_umol_mol
  JCP_Summary_table_NIST612[JCP_Summary_table_NIST612$JCP == i, "S_Ca_umol_mol_2SE"] <- NIST612_Corrected_JCP[[i]]$S_Ca_umol_mol_2SE
  JCP_Summary_table_NIST612[JCP_Summary_table_NIST612$JCP == i, "Mn_Ca_umol_mol"] <- NIST612_Corrected_JCP[[i]]$Mn_Ca_umol_mol
  JCP_Summary_table_NIST612[JCP_Summary_table_NIST612$JCP == i, "Mn_Ca_umol_mol_2SE"] <- NIST612_Corrected_JCP[[i]]$Mn_Ca_umol_mol_2SE
  JCP_Summary_table_NIST612[JCP_Summary_table_NIST612$JCP == i, "Sr_Ca_umol_mol"] <- NIST612_Corrected_JCP[[i]]$Sr_Ca_umol_mol
  JCP_Summary_table_NIST612[JCP_Summary_table_NIST612$JCP == i, "Sr_Ca_umol_mol_2SE"] <- NIST612_Corrected_JCP[[i]]$Sr_Ca_umol_mol_2SE
  JCP_Summary_table_NIST612[JCP_Summary_table_NIST612$JCP == i, "Ba_Ca_umol_mol"] <- NIST612_Corrected_JCP[[i]]$Ba_Ca_umol_mol
  JCP_Summary_table_NIST612[JCP_Summary_table_NIST612$JCP == i, "Ba_Ca_umol_mol_2SE"] <- NIST612_Corrected_JCP[[i]]$Ba_Ca_umol_mol_2SE
  JCP_Summary_table_NIST612[JCP_Summary_table_NIST612$JCP == i, "U_Ca_umol_mol"] <- NIST612_Corrected_JCP[[i]]$U_Ca_umol_mol
  JCP_Summary_table_NIST612[JCP_Summary_table_NIST612$JCP == i, "U_Ca_umol_mol_2SE"] <- NIST612_Corrected_JCP[[i]]$U_Ca_umol_mol_2SE
  JCP_Summary_table_NIST612[JCP_Summary_table_NIST612$JCP == "mean", "Li_Ca_umol_mol"] <- mean(JCP_Summary_table_NIST612$Li_Ca_umol_mol[1:13])
  JCP_Summary_table_NIST612[JCP_Summary_table_NIST612$JCP == "mean", "B_Ca_umol_mol"] <- mean(JCP_Summary_table_NIST612$B_Ca_umol_mol[1:13])
  JCP_Summary_table_NIST612[JCP_Summary_table_NIST612$JCP == "mean", "Mg_Ca_umol_mol"] <- mean(JCP_Summary_table_NIST612$Mg_Ca_umol_mol[1:13])
  JCP_Summary_table_NIST612[JCP_Summary_table_NIST612$JCP == "mean", "P_Ca_umol_mol"] <- mean(JCP_Summary_table_NIST612$P_Ca_umol_mol[1:13])
  JCP_Summary_table_NIST612[JCP_Summary_table_NIST612$JCP == "mean", "S_Ca_umol_mol"] <- mean(JCP_Summary_table_NIST612$S_Ca_umol_mol[1:13])  
  JCP_Summary_table_NIST612[JCP_Summary_table_NIST612$JCP == "mean", "Mn_Ca_umol_mol"] <- mean(JCP_Summary_table_NIST612$Mn_Ca_umol_mol[1:13])
  JCP_Summary_table_NIST612[JCP_Summary_table_NIST612$JCP == "mean", "Sr_Ca_umol_mol"] <- mean(JCP_Summary_table_NIST612$Sr_Ca_umol_mol[1:13])
  JCP_Summary_table_NIST612[JCP_Summary_table_NIST612$JCP == "mean", "Ba_Ca_umol_mol"] <- mean(JCP_Summary_table_NIST612$Ba_Ca_umol_mol[1:13])
  JCP_Summary_table_NIST612[JCP_Summary_table_NIST612$JCP == "mean", "U_Ca_umol_mol"] <- mean(JCP_Summary_table_NIST612$U_Ca_umol_mol[1:13])
  JCP_Summary_table_NIST612[JCP_Summary_table_NIST612$JCP == "2SD", "Li_Ca_umol_mol"] <- sd(JCP_Summary_table_NIST612$Li_Ca_umol_mol[1:13])*2
  JCP_Summary_table_NIST612[JCP_Summary_table_NIST612$JCP == "2SD", "B_Ca_umol_mol"] <- sd(JCP_Summary_table_NIST612$B_Ca_umol_mol[1:13])*2
  JCP_Summary_table_NIST612[JCP_Summary_table_NIST612$JCP == "2SD", "Mg_Ca_umol_mol"] <- sd(JCP_Summary_table_NIST612$Mg_Ca_umol_mol[1:13])*2
  JCP_Summary_table_NIST612[JCP_Summary_table_NIST612$JCP == "2SD", "P_Ca_umol_mol"] <- sd(JCP_Summary_table_NIST612$P_Ca_umol_mol[1:13])*2
  JCP_Summary_table_NIST612[JCP_Summary_table_NIST612$JCP == "2SD", "S_Ca_umol_mol"] <- sd(JCP_Summary_table_NIST612$S_Ca_umol_mol[1:13])*2
  JCP_Summary_table_NIST612[JCP_Summary_table_NIST612$JCP == "2SD", "Mn_Ca_umol_mol"] <- sd(JCP_Summary_table_NIST612$Mn_Ca_umol_mol[1:13])*2
  JCP_Summary_table_NIST612[JCP_Summary_table_NIST612$JCP == "2SD", "Sr_Ca_umol_mol"] <- sd(JCP_Summary_table_NIST612$Sr_Ca_umol_mol[1:13])*2
  JCP_Summary_table_NIST612[JCP_Summary_table_NIST612$JCP == "2SD", "Ba_Ca_umol_mol"] <- sd(JCP_Summary_table_NIST612$Ba_Ca_umol_mol[1:13])*2
  JCP_Summary_table_NIST612[JCP_Summary_table_NIST612$JCP == "2SD", "U_Ca_umol_mol"] <- sd(JCP_Summary_table_NIST612$U_Ca_umol_mol[1:13])*2
  JCP_Summary_table_NIST612[JCP_Summary_table_NIST612$JCP == "%2SD", "Li_Ca_umol_mol"] <- JCP_Summary_table_NIST612$Li_Ca_umol_mol[16]/JCP_Summary_table_NIST612$Li_Ca_umol_mol[15]*100
  JCP_Summary_table_NIST612[JCP_Summary_table_NIST612$JCP == "%2SD", "B_Ca_umol_mol"] <- JCP_Summary_table_NIST612$B_Ca_umol_mol[16]/JCP_Summary_table_NIST612$B_Ca_umol_mol[15]*100
  JCP_Summary_table_NIST612[JCP_Summary_table_NIST612$JCP == "%2SD", "Mg_Ca_umol_mol"] <- JCP_Summary_table_NIST612$Mg_Ca_umol_mol[16]/JCP_Summary_table_NIST612$Mg_Ca_umol_mol[15]*100
  JCP_Summary_table_NIST612[JCP_Summary_table_NIST612$JCP == "%2SD", "P_Ca_umol_mol"] <- JCP_Summary_table_NIST612$P_Ca_umol_mol[16]/JCP_Summary_table_NIST612$P_Ca_umol_mol[15]*100
  JCP_Summary_table_NIST612[JCP_Summary_table_NIST612$JCP == "%2SD", "S_Ca_umol_mol"] <- JCP_Summary_table_NIST612$S_Ca_umol_mol[16]/JCP_Summary_table_NIST612$S_Ca_umol_mol[15]*100
  JCP_Summary_table_NIST612[JCP_Summary_table_NIST612$JCP == "%2SD", "Mn_Ca_umol_mol"] <- JCP_Summary_table_NIST612$Mn_Ca_umol_mol[16]/JCP_Summary_table_NIST612$Mn_Ca_umol_mol[15]*100
  JCP_Summary_table_NIST612[JCP_Summary_table_NIST612$JCP == "%2SD", "Sr_Ca_umol_mol"] <- JCP_Summary_table_NIST612$Sr_Ca_umol_mol[16]/JCP_Summary_table_NIST612$Sr_Ca_umol_mol[15]*100
  JCP_Summary_table_NIST612[JCP_Summary_table_NIST612$JCP == "%2SD", "Ba_Ca_umol_mol"] <- JCP_Summary_table_NIST612$Ba_Ca_umol_mol[16]/JCP_Summary_table_NIST612$Ba_Ca_umol_mol[15]*100
  JCP_Summary_table_NIST612[JCP_Summary_table_NIST612$JCP == "%2SD", "U_Ca_umol_mol"] <- JCP_Summary_table_NIST612$U_Ca_umol_mol[16]/JCP_Summary_table_NIST612$U_Ca_umol_mol[15]*100
  JCP_Summary_table_NIST612[JCP_Summary_table_NIST612$JCP == "Expected", "Li_Ca_umol_mol"] <- 6.19
  JCP_Summary_table_NIST612[JCP_Summary_table_NIST612$JCP == "Expected", "B_Ca_umol_mol"] <- 459.60
  JCP_Summary_table_NIST612[JCP_Summary_table_NIST612$JCP == "Expected", "Mg_Ca_umol_mol"] <- 4200
  JCP_Summary_table_NIST612[JCP_Summary_table_NIST612$JCP == "Expected", "P_Ca_umol_mol"] <- 44.96
  JCP_Summary_table_NIST612[JCP_Summary_table_NIST612$JCP == "Expected", "S_Ca_umol_mol"] <- 6240
  JCP_Summary_table_NIST612[JCP_Summary_table_NIST612$JCP == "Expected", "Mn_Ca_umol_mol"] <- 1.49
  JCP_Summary_table_NIST612[JCP_Summary_table_NIST612$JCP == "Expected", "Sr_Ca_umol_mol"] <- 8840
  JCP_Summary_table_NIST612[JCP_Summary_table_NIST612$JCP == "Expected", "Ba_Ca_umol_mol"] <- 7.47
  JCP_Summary_table_NIST612[JCP_Summary_table_NIST612$JCP == "Expected", "U_Ca_umol_mol"] <- 1.192
  JCP_Summary_table_NIST612[JCP_Summary_table_NIST612$JCP == "Accuracy", "Li_Ca_umol_mol"] <- (JCP_Summary_table_NIST612$Li_Ca_umol_mol[15]-JCP_Summary_table_NIST612$Li_Ca_umol_mol[18])/JCP_Summary_table_NIST612$Li_Ca_umol_mol[18]*100
  JCP_Summary_table_NIST612[JCP_Summary_table_NIST612$JCP == "Accuracy", "B_Ca_umol_mol"] <- (JCP_Summary_table_NIST612$B_Ca_umol_mol[15]-JCP_Summary_table_NIST612$B_Ca_umol_mol[18])/JCP_Summary_table_NIST612$B_Ca_umol_mol[18]*100
  JCP_Summary_table_NIST612[JCP_Summary_table_NIST612$JCP == "Accuracy", "Mg_Ca_umol_mol"] <- (JCP_Summary_table_NIST612$Mg_Ca_umol_mol[15]-JCP_Summary_table_NIST612$Mg_Ca_umol_mol[18])/JCP_Summary_table_NIST612$Mg_Ca_umol_mol[18]*100
  JCP_Summary_table_NIST612[JCP_Summary_table_NIST612$JCP == "Accuracy", "P_Ca_umol_mol"] <- (JCP_Summary_table_NIST612$P_Ca_umol_mol[15]-JCP_Summary_table_NIST612$P_Ca_umol_mol[18])/JCP_Summary_table_NIST612$P_Ca_umol_mol[18]*100
  JCP_Summary_table_NIST612[JCP_Summary_table_NIST612$JCP == "Accuracy", "S_Ca_umol_mol"] <- (JCP_Summary_table_NIST612$S_Ca_umol_mol[15]-JCP_Summary_table_NIST612$S_Ca_umol_mol[18])/JCP_Summary_table_NIST612$S_Ca_umol_mol[18]*100
  JCP_Summary_table_NIST612[JCP_Summary_table_NIST612$JCP == "Accuracy", "Mn_Ca_umol_mol"] <- (JCP_Summary_table_NIST612$Mn_Ca_umol_mol[15]-JCP_Summary_table_NIST612$Mn_Ca_umol_mol[18])/JCP_Summary_table_NIST612$Mn_Ca_umol_mol[18]*100
  JCP_Summary_table_NIST612[JCP_Summary_table_NIST612$JCP == "Accuracy", "Sr_Ca_umol_mol"] <- (JCP_Summary_table_NIST612$Sr_Ca_umol_mol[15]-JCP_Summary_table_NIST612$Sr_Ca_umol_mol[18])/JCP_Summary_table_NIST612$Sr_Ca_umol_mol[18]*100
  JCP_Summary_table_NIST612[JCP_Summary_table_NIST612$JCP == "Accuracy", "Ba_Ca_umol_mol"] <- (JCP_Summary_table_NIST612$Ba_Ca_umol_mol[15]-JCP_Summary_table_NIST612$Ba_Ca_umol_mol[18])/JCP_Summary_table_NIST612$Ba_Ca_umol_mol[18]*100
  JCP_Summary_table_NIST612[JCP_Summary_table_NIST612$JCP == "Accuracy", "U_Ca_umol_mol"] <- (JCP_Summary_table_NIST612$U_Ca_umol_mol[15]-JCP_Summary_table_NIST612$U_Ca_umol_mol[18])/JCP_Summary_table_NIST612$U_Ca_umol_mol[18]*100
}

write.csv(JCP_Summary_table_NIST612, "JCP_Summary_table_NIST612.csv")


## DSC ####
NIST612_Corrected_DSC_Means <- list()
for (i in 1:length(Calculations_DSC)) {
  NIST612_corrected_ratios <-
  Calculations_DSC[[i]] %>%
    slice(1L,8L) %>% # select mean(-values 2SD outside) + %2SE
    dplyr::select(1,42:50) %>% # select only ratios
    mutate(
    Li_Ca_NIST612_corrected = Li_Ca[1]/(mean(c(Calculations_612[[i]]$Li_Ca[1],Calculations_612[[i+1]]$Li_Ca[1]))/Constants$NIST612$Li_Ca[1]),
    Li_Ca_NIST612_corrected_2SE = Li_Ca_NIST612_corrected*(sqrt(((sd(c(Calculations_612[[i]]$Li_Ca[1],Calculations_612[[i+1]]$Li_Ca[1]))/mean(c(Calculations_612[[i]]$Li_Ca[1],Calculations_612[[i+1]]$Li_Ca[1]))*100)^2)+(Calculations_DSC[[i]]$Li_Ca[8]^2)))/100,
    B_Ca_NIST612_corrected = B_Ca[1]/(mean(c(Calculations_612[[i]]$B_Ca[1],Calculations_612[[i+1]]$B_Ca[1]))/Constants$NIST612$B_Ca[1]),
    B_Ca_NIST612_corrected_2SE = B_Ca_NIST612_corrected*(sqrt(((sd(c(Calculations_612[[i]]$B_Ca[1],Calculations_612[[i+1]]$B_Ca[1]))/mean(c(Calculations_612[[i]]$B_Ca[1],Calculations_612[[i+1]]$B_Ca[1]))*100)^2)+(Calculations_DSC[[i]]$B_Ca[8]^2)))/100,
    Mg_Ca_NIST612_corrected = Mg_Ca[1]/(mean(c(Calculations_612[[i]]$Mg_Ca[1],Calculations_612[[i+1]]$Mg_Ca[1]))/Constants$NIST612$Mg_Ca[1]),
    Mg_Ca_NIST612_corrected_2SE = Mg_Ca_NIST612_corrected*(sqrt(((sd(c(Calculations_612[[i]]$Mg_Ca[1],Calculations_612[[i+1]]$Mg_Ca[1]))/mean(c(Calculations_612[[i]]$Mg_Ca[1],Calculations_612[[i+1]]$Mg_Ca[1]))*100)^2)+(Calculations_DSC[[i]]$Mg_Ca[8]^2)))/100,
    P_Ca_NIST612_corrected = P_Ca[1]/(mean(c(Calculations_612[[i]]$P_Ca[1],Calculations_612[[i+1]]$P_Ca[1]))/Constants$NIST612$P_Ca[1]),
    P_Ca_NIST612_corrected_2SE = P_Ca_NIST612_corrected*(sqrt(((sd(c(Calculations_612[[i]]$P_Ca[1],Calculations_612[[i+1]]$P_Ca[1]))/mean(c(Calculations_612[[i]]$P_Ca[1],Calculations_612[[i+1]]$P_Ca[1]))*100)^2)+(Calculations_DSC[[i]]$P_Ca[8]^2)))/100,
    S_Ca_NIST612_corrected = S_Ca[1]/(mean(c(Calculations_612[[i]]$S_Ca[1],Calculations_612[[i+1]]$S_Ca[1]))/Constants$NIST612$S_Ca[1]),
    S_Ca_NIST612_corrected_2SE = S_Ca_NIST612_corrected*(sqrt(((sd(c(Calculations_612[[i]]$S_Ca[1],Calculations_612[[i+1]]$S_Ca[1]))/mean(c(Calculations_612[[i]]$S_Ca[1],Calculations_612[[i+1]]$S_Ca[1]))*100)^2)+(Calculations_DSC[[i]]$S_Ca[8]^2)))/100,
    Mn_Ca_NIST612_corrected = Mn_Ca[1]/(mean(c(Calculations_612[[i]]$Mn_Ca[1],Calculations_612[[i+1]]$Mn_Ca[1]))/Constants$NIST612$Mn_Ca[1]),
    Mn_Ca_NIST612_corrected_2SE = Mn_Ca_NIST612_corrected*(sqrt(((sd(c(Calculations_612[[i]]$Mn_Ca[1],Calculations_612[[i+1]]$Mn_Ca[1]))/mean(c(Calculations_612[[i]]$Mn_Ca[1],Calculations_612[[i+1]]$Mn_Ca[1]))*100)^2)+(Calculations_DSC[[i]]$Mn_Ca[8]^2)))/100,
    Sr_Ca_NIST612_corrected = Sr_Ca[1]/(mean(c(Calculations_612[[i]]$Sr_Ca[1],Calculations_612[[i+1]]$Sr_Ca[1]))/Constants$NIST612$Sr_Ca[1]),
    Sr_Ca_NIST612_corrected_2SE = Sr_Ca_NIST612_corrected*(sqrt(((sd(c(Calculations_612[[i]]$Sr_Ca[1],Calculations_612[[i+1]]$Sr_Ca[1]))/mean(c(Calculations_612[[i]]$Sr_Ca[1],Calculations_612[[i+1]]$Sr_Ca[1]))*100)^2)+(Calculations_DSC[[i]]$Sr_Ca[8]^2)))/100,
    Ba_Ca_NIST612_corrected = Ba_Ca[1]/(mean(c(Calculations_612[[i]]$Ba_Ca[1],Calculations_612[[i+1]]$Ba_Ca[1]))/Constants$NIST612$Ba_Ca[1]),
    Ba_Ca_NIST612_corrected_2SE = Ba_Ca_NIST612_corrected*(sqrt(((sd(c(Calculations_612[[i]]$Ba_Ca[1],Calculations_612[[i+1]]$Ba_Ca[1]))/mean(c(Calculations_612[[i]]$Ba_Ca[1],Calculations_612[[i+1]]$Ba_Ca[1]))*100)^2)+(Calculations_DSC[[i]]$Ba_Ca[8]^2)))/100,
    U_Ca_NIST612_corrected = U_Ca[1]/(mean(c(Calculations_612[[i]]$U_Ca[1],Calculations_612[[i+1]]$U_Ca[1]))/Constants$NIST612$U_Ca[1]),
    U_Ca_NIST612_corrected_2SE = U_Ca_NIST612_corrected*(sqrt(((sd(c(Calculations_612[[i]]$U_Ca[1],Calculations_612[[i+1]]$U_Ca[1]))/mean(c(Calculations_612[[i]]$U_Ca[1],Calculations_612[[i+1]]$U_Ca[1]))*100)^2)+(Calculations_DSC[[i]]$U_Ca[8]^2)))/100,
    )
                                                           
NIST612_corrected_ratios <- NIST612_corrected_ratios %>%
  slice(1L) %>% #remove row for %2SE
  dplyr::select(11:28) %>%
    mutate(
      Li_Ca_umol_mol = Li_Ca_NIST612_corrected /(Constants$Element_constants$Mass[1]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      Li_Ca_umol_mol_2SE = Li_Ca_umol_mol/100*(Li_Ca_NIST612_corrected_2SE/Li_Ca_NIST612_corrected*100),
      B_Ca_umol_mol = B_Ca_NIST612_corrected /(Constants$Element_constants$Mass[2]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      B_Ca_umol_mol_2SE = B_Ca_umol_mol/100*(B_Ca_NIST612_corrected_2SE/B_Ca_NIST612_corrected*100),
      Mg_Ca_umol_mol = Mg_Ca_NIST612_corrected /(Constants$Element_constants$Mass[3]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      Mg_Ca_umol_mol_2SE = Mg_Ca_umol_mol/100*(Mg_Ca_NIST612_corrected_2SE/Mg_Ca_NIST612_corrected*100),
      P_Ca_umol_mol = P_Ca_NIST612_corrected /(Constants$Element_constants$Mass[4]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      P_Ca_umol_mol_2SE = P_Ca_umol_mol/100*(P_Ca_NIST612_corrected_2SE/P_Ca_NIST612_corrected*100),
      S_Ca_umol_mol = S_Ca_NIST612_corrected /(Constants$Element_constants$Mass[5]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      S_Ca_umol_mol_2SE = S_Ca_umol_mol/100*(S_Ca_NIST612_corrected_2SE/S_Ca_NIST612_corrected*100),
      Mn_Ca_umol_mol = Mn_Ca_NIST612_corrected /(Constants$Element_constants$Mass[7]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      Mn_Ca_umol_mol_2SE = Mn_Ca_umol_mol/100*(Mn_Ca_NIST612_corrected_2SE/Mn_Ca_NIST612_corrected*100),
      Sr_Ca_umol_mol = Sr_Ca_NIST612_corrected /(Constants$Element_constants$Mass[11]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      Sr_Ca_umol_mol_2SE = Sr_Ca_umol_mol/100*(Sr_Ca_NIST612_corrected_2SE/Sr_Ca_NIST612_corrected*100),
      Ba_Ca_umol_mol = Ba_Ca_NIST612_corrected /(Constants$Element_constants$Mass[12]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      Ba_Ca_umol_mol_2SE = Ba_Ca_umol_mol/100*(Ba_Ca_NIST612_corrected_2SE/Ba_Ca_NIST612_corrected*100),
      U_Ca_umol_mol = U_Ca_NIST612_corrected /(Constants$Element_constants$Mass[14]/Constants$Element_constants$Mass[6]/Constants$Conversions$Value[2]),
      U_Ca_umol_mol_2SE = U_Ca_umol_mol/100*(U_Ca_NIST612_corrected_2SE/U_Ca_NIST612_corrected*100),
    )

assign(paste0(names(Calculations_DSC[i]), "_NIST612_Corrected_Means"), NIST612_corrected_ratios)
NIST612_Corrected_DSC_Means[[paste0(names(Calculations_DSC[i]), "_NIST612_Corrected_Means")]] <- NIST612_corrected_ratios
}

DSC_Summary_table_NIST612 <- data.frame(DeepSeaCoral = c(1:12, "", "mean", "2SD", "%2SD", "Expected", "Accuracy"))
for (i in 1:length(NIST612_Corrected_DSC_Means)) {
  DSC_Summary_table_NIST612 [DSC_Summary_table_NIST612 $DeepSeaCoral == i, "Li_Ca_umol_mol"] <- NIST612_Corrected_DSC_Means[[i]]$Li_Ca_umol_mol
  DSC_Summary_table_NIST612 [DSC_Summary_table_NIST612 $DeepSeaCoral == i, "Li_Ca_umol_mol_2SE"] <- NIST612_Corrected_DSC_Means[[i]]$Li_Ca_umol_mol_2SE
  DSC_Summary_table_NIST612 [DSC_Summary_table_NIST612 $DeepSeaCoral == i, "B_Ca_umol_mol"] <- NIST612_Corrected_DSC_Means[[i]]$B_Ca_umol_mol
  DSC_Summary_table_NIST612 [DSC_Summary_table_NIST612 $DeepSeaCoral == i, "B_Ca_umol_mol_2SE"] <- NIST612_Corrected_DSC_Means[[i]]$B_Ca_umol_mol_2SE
  DSC_Summary_table_NIST612 [DSC_Summary_table_NIST612 $DeepSeaCoral == i, "Mg_Ca_umol_mol"] <- NIST612_Corrected_DSC_Means[[i]]$Mg_Ca_umol_mol
  DSC_Summary_table_NIST612 [DSC_Summary_table_NIST612 $DeepSeaCoral == i, "Mg_Ca_umol_mol_2SE"] <- NIST612_Corrected_DSC_Means[[i]]$Mg_Ca_umol_mol_2SE
  DSC_Summary_table_NIST612 [DSC_Summary_table_NIST612 $DeepSeaCoral == i, "P_Ca_umol_mol"] <- NIST612_Corrected_DSC_Means[[i]]$P_Ca_umol_mol
  DSC_Summary_table_NIST612 [DSC_Summary_table_NIST612 $DeepSeaCoral == i, "P_Ca_umol_mol_2SE"] <- NIST612_Corrected_DSC_Means[[i]]$P_Ca_umol_mol_2SE
  DSC_Summary_table_NIST612 [DSC_Summary_table_NIST612 $DeepSeaCoral == i, "S_Ca_umol_mol"] <- NIST612_Corrected_DSC_Means[[i]]$S_Ca_umol_mol
  DSC_Summary_table_NIST612 [DSC_Summary_table_NIST612 $DeepSeaCoral == i, "S_Ca_umol_mol_2SE"] <- NIST612_Corrected_DSC_Means[[i]]$S_Ca_umol_mol_2SE
  DSC_Summary_table_NIST612 [DSC_Summary_table_NIST612 $DeepSeaCoral == i, "Mn_Ca_umol_mol"] <- NIST612_Corrected_DSC_Means[[i]]$Mn_Ca_umol_mol
  DSC_Summary_table_NIST612 [DSC_Summary_table_NIST612 $DeepSeaCoral == i, "Mn_Ca_umol_mol_2SE"] <- NIST612_Corrected_DSC_Means[[i]]$Mn_Ca_umol_mol_2SE
  DSC_Summary_table_NIST612 [DSC_Summary_table_NIST612 $DeepSeaCoral == i, "Sr_Ca_umol_mol"] <- NIST612_Corrected_DSC_Means[[i]]$Sr_Ca_umol_mol
  DSC_Summary_table_NIST612 [DSC_Summary_table_NIST612 $DeepSeaCoral == i, "Sr_Ca_umol_mol_2SE"] <- NIST612_Corrected_DSC_Means[[i]]$Sr_Ca_umol_mol_2SE
  DSC_Summary_table_NIST612 [DSC_Summary_table_NIST612 $DeepSeaCoral == i, "Ba_Ca_umol_mol"] <- NIST612_Corrected_DSC_Means[[i]]$Ba_Ca_umol_mol
  DSC_Summary_table_NIST612 [DSC_Summary_table_NIST612 $DeepSeaCoral == i, "Ba_Ca_umol_mol_2SE"] <- NIST612_Corrected_DSC_Means[[i]]$Ba_Ca_umol_mol_2SE
  DSC_Summary_table_NIST612 [DSC_Summary_table_NIST612 $DeepSeaCoral == i, "U_Ca_umol_mol"] <- NIST612_Corrected_DSC_Means[[i]]$U_Ca_umol_mol
  DSC_Summary_table_NIST612 [DSC_Summary_table_NIST612 $DeepSeaCoral == i, "U_Ca_umol_mol_2SE"] <- NIST612_Corrected_DSC_Means[[i]]$U_Ca_umol_mol_2SE
  DSC_Summary_table_NIST612 [DSC_Summary_table_NIST612 $DeepSeaCoral == "mean", "Li_Ca_umol_mol"] <- mean(DSC_Summary_table_NIST612 $Li_Ca_umol_mol[1:12])
  DSC_Summary_table_NIST612 [DSC_Summary_table_NIST612 $DeepSeaCoral == "mean", "B_Ca_umol_mol"] <- mean(DSC_Summary_table_NIST612 $B_Ca_umol_mol[1:12])
  DSC_Summary_table_NIST612 [DSC_Summary_table_NIST612 $DeepSeaCoral == "mean", "Mg_Ca_umol_mol"] <- mean(DSC_Summary_table_NIST612 $Mg_Ca_umol_mol[1:12])
  DSC_Summary_table_NIST612 [DSC_Summary_table_NIST612 $DeepSeaCoral == "mean", "P_Ca_umol_mol"] <- mean(DSC_Summary_table_NIST612 $P_Ca_umol_mol[1:12])
  DSC_Summary_table_NIST612 [DSC_Summary_table_NIST612 $DeepSeaCoral == "mean", "S_Ca_umol_mol"] <- mean(DSC_Summary_table_NIST612 $S_Ca_umol_mol[1:12])  
  DSC_Summary_table_NIST612 [DSC_Summary_table_NIST612 $DeepSeaCoral == "mean", "Mn_Ca_umol_mol"] <- mean(DSC_Summary_table_NIST612 $Mn_Ca_umol_mol[1:12])
  DSC_Summary_table_NIST612 [DSC_Summary_table_NIST612 $DeepSeaCoral == "mean", "Sr_Ca_umol_mol"] <- mean(DSC_Summary_table_NIST612 $Sr_Ca_umol_mol[1:12])
  DSC_Summary_table_NIST612 [DSC_Summary_table_NIST612 $DeepSeaCoral == "mean", "Ba_Ca_umol_mol"] <- mean(DSC_Summary_table_NIST612 $Ba_Ca_umol_mol[1:12])
  DSC_Summary_table_NIST612 [DSC_Summary_table_NIST612 $DeepSeaCoral == "mean", "U_Ca_umol_mol"] <- mean(DSC_Summary_table_NIST612 $U_Ca_umol_mol[1:12])
  DSC_Summary_table_NIST612 [DSC_Summary_table_NIST612 $DeepSeaCoral == "2SD", "Li_Ca_umol_mol"] <- sd(DSC_Summary_table_NIST612 $Li_Ca_umol_mol[1:12])*2
  DSC_Summary_table_NIST612 [DSC_Summary_table_NIST612 $DeepSeaCoral == "2SD", "B_Ca_umol_mol"] <- sd(DSC_Summary_table_NIST612 $B_Ca_umol_mol[1:12])*2
  DSC_Summary_table_NIST612 [DSC_Summary_table_NIST612 $DeepSeaCoral == "2SD", "Mg_Ca_umol_mol"] <- sd(DSC_Summary_table_NIST612 $Mg_Ca_umol_mol[1:12])*2
  DSC_Summary_table_NIST612 [DSC_Summary_table_NIST612 $DeepSeaCoral == "2SD", "P_Ca_umol_mol"] <- sd(DSC_Summary_table_NIST612 $P_Ca_umol_mol[1:12])*2
  DSC_Summary_table_NIST612 [DSC_Summary_table_NIST612 $DeepSeaCoral == "2SD", "S_Ca_umol_mol"] <- sd(DSC_Summary_table_NIST612 $S_Ca_umol_mol[1:12])*2
  DSC_Summary_table_NIST612 [DSC_Summary_table_NIST612 $DeepSeaCoral == "2SD", "Mn_Ca_umol_mol"] <- sd(DSC_Summary_table_NIST612 $Mn_Ca_umol_mol[1:12])*2
  DSC_Summary_table_NIST612 [DSC_Summary_table_NIST612 $DeepSeaCoral == "2SD", "Sr_Ca_umol_mol"] <- sd(DSC_Summary_table_NIST612 $Sr_Ca_umol_mol[1:12])*2
  DSC_Summary_table_NIST612 [DSC_Summary_table_NIST612 $DeepSeaCoral == "2SD", "Ba_Ca_umol_mol"] <- sd(DSC_Summary_table_NIST612 $Ba_Ca_umol_mol[1:12])*2
  DSC_Summary_table_NIST612 [DSC_Summary_table_NIST612 $DeepSeaCoral == "2SD", "U_Ca_umol_mol"] <- sd(DSC_Summary_table_NIST612 $U_Ca_umol_mol[1:12])*2
  DSC_Summary_table_NIST612 [DSC_Summary_table_NIST612 $DeepSeaCoral == "%2SD", "Li_Ca_umol_mol"] <- DSC_Summary_table_NIST612 $Li_Ca_umol_mol[15]/DSC_Summary_table_NIST612 $Li_Ca_umol_mol[14]*100
  DSC_Summary_table_NIST612 [DSC_Summary_table_NIST612 $DeepSeaCoral == "%2SD", "B_Ca_umol_mol"] <- DSC_Summary_table_NIST612 $B_Ca_umol_mol[15]/DSC_Summary_table_NIST612 $B_Ca_umol_mol[14]*100
  DSC_Summary_table_NIST612 [DSC_Summary_table_NIST612 $DeepSeaCoral == "%2SD", "Mg_Ca_umol_mol"] <- DSC_Summary_table_NIST612 $Mg_Ca_umol_mol[15]/DSC_Summary_table_NIST612 $Mg_Ca_umol_mol[14]*100
  DSC_Summary_table_NIST612 [DSC_Summary_table_NIST612 $DeepSeaCoral == "%2SD", "P_Ca_umol_mol"] <- DSC_Summary_table_NIST612 $P_Ca_umol_mol[15]/DSC_Summary_table_NIST612 $P_Ca_umol_mol[14]*100
  DSC_Summary_table_NIST612 [DSC_Summary_table_NIST612 $DeepSeaCoral == "%2SD", "S_Ca_umol_mol"] <- DSC_Summary_table_NIST612 $S_Ca_umol_mol[15]/DSC_Summary_table_NIST612 $S_Ca_umol_mol[14]*100
  DSC_Summary_table_NIST612 [DSC_Summary_table_NIST612 $DeepSeaCoral == "%2SD", "Mn_Ca_umol_mol"] <- DSC_Summary_table_NIST612 $Mn_Ca_umol_mol[15]/DSC_Summary_table_NIST612 $Mn_Ca_umol_mol[14]*100
  DSC_Summary_table_NIST612 [DSC_Summary_table_NIST612 $DeepSeaCoral == "%2SD", "Sr_Ca_umol_mol"] <- DSC_Summary_table_NIST612 $Sr_Ca_umol_mol[15]/DSC_Summary_table_NIST612 $Sr_Ca_umol_mol[14]*100
  DSC_Summary_table_NIST612 [DSC_Summary_table_NIST612 $DeepSeaCoral == "%2SD", "Ba_Ca_umol_mol"] <- DSC_Summary_table_NIST612 $Ba_Ca_umol_mol[15]/DSC_Summary_table_NIST612 $Ba_Ca_umol_mol[14]*100
  DSC_Summary_table_NIST612 [DSC_Summary_table_NIST612 $DeepSeaCoral == "%2SD", "U_Ca_umol_mol"] <- DSC_Summary_table_NIST612 $U_Ca_umol_mol[15]/DSC_Summary_table_NIST612 $U_Ca_umol_mol[14]*100
  DSC_Summary_table_NIST612 [DSC_Summary_table_NIST612 $DeepSeaCoral == "Expected", "Li_Ca_umol_mol"] <- 48.67
  DSC_Summary_table_NIST612 [DSC_Summary_table_NIST612 $DeepSeaCoral == "Expected", "B_Ca_umol_mol"] <- 233.82
  DSC_Summary_table_NIST612 [DSC_Summary_table_NIST612 $DeepSeaCoral == "Expected", "Mg_Ca_umol_mol"] <- 78970
  DSC_Summary_table_NIST612 [DSC_Summary_table_NIST612 $DeepSeaCoral == "Expected", "P_Ca_umol_mol"] <- NA
  DSC_Summary_table_NIST612 [DSC_Summary_table_NIST612 $DeepSeaCoral == "Expected", "S_Ca_umol_mol"] <- NA
  DSC_Summary_table_NIST612 [DSC_Summary_table_NIST612 $DeepSeaCoral == "Expected", "Mn_Ca_umol_mol"] <- NA
  DSC_Summary_table_NIST612 [DSC_Summary_table_NIST612 $DeepSeaCoral == "Expected", "Sr_Ca_umol_mol"] <- 2900
  DSC_Summary_table_NIST612 [DSC_Summary_table_NIST612 $DeepSeaCoral == "Expected", "Ba_Ca_umol_mol"] <- 13.64
  DSC_Summary_table_NIST612 [DSC_Summary_table_NIST612 $DeepSeaCoral == "Expected", "U_Ca_umol_mol"] <- 0.0183
  DSC_Summary_table_NIST612 [DSC_Summary_table_NIST612 $DeepSeaCoral == "Accuracy", "Li_Ca_umol_mol"] <- (DSC_Summary_table_NIST612 $Li_Ca_umol_mol[14]-DSC_Summary_table_NIST612 $Li_Ca_umol_mol[17])/DSC_Summary_table_NIST612 $Li_Ca_umol_mol[17]*100
  DSC_Summary_table_NIST612 [DSC_Summary_table_NIST612 $DeepSeaCoral == "Accuracy", "B_Ca_umol_mol"] <- (DSC_Summary_table_NIST612 $B_Ca_umol_mol[14]-DSC_Summary_table_NIST612 $B_Ca_umol_mol[17])/DSC_Summary_table_NIST612 $B_Ca_umol_mol[17]*100
  DSC_Summary_table_NIST612 [DSC_Summary_table_NIST612 $DeepSeaCoral == "Accuracy", "Mg_Ca_umol_mol"] <- (DSC_Summary_table_NIST612 $Mg_Ca_umol_mol[14]-DSC_Summary_table_NIST612 $Mg_Ca_umol_mol[17])/DSC_Summary_table_NIST612 $Mg_Ca_umol_mol[17]*100
  DSC_Summary_table_NIST612 [DSC_Summary_table_NIST612 $DeepSeaCoral == "Accuracy", "P_Ca_umol_mol"] <- (DSC_Summary_table_NIST612 $P_Ca_umol_mol[14]-DSC_Summary_table_NIST612 $P_Ca_umol_mol[17])/DSC_Summary_table_NIST612 $P_Ca_umol_mol[17]*100
  DSC_Summary_table_NIST612 [DSC_Summary_table_NIST612 $DeepSeaCoral == "Accuracy", "S_Ca_umol_mol"] <- (DSC_Summary_table_NIST612 $S_Ca_umol_mol[14]-DSC_Summary_table_NIST612 $S_Ca_umol_mol[17])/DSC_Summary_table_NIST612 $S_Ca_umol_mol[17]*100
  DSC_Summary_table_NIST612 [DSC_Summary_table_NIST612 $DeepSeaCoral == "Accuracy", "Mn_Ca_umol_mol"] <- (DSC_Summary_table_NIST612 $Mn_Ca_umol_mol[14]-DSC_Summary_table_NIST612 $Mn_Ca_umol_mol[17])/DSC_Summary_table_NIST612 $Mn_Ca_umol_mol[17]*100
  DSC_Summary_table_NIST612 [DSC_Summary_table_NIST612 $DeepSeaCoral == "Accuracy", "Sr_Ca_umol_mol"] <- (DSC_Summary_table_NIST612 $Sr_Ca_umol_mol[14]-DSC_Summary_table_NIST612 $Sr_Ca_umol_mol[17])/DSC_Summary_table_NIST612 $Sr_Ca_umol_mol[17]*100
  DSC_Summary_table_NIST612 [DSC_Summary_table_NIST612 $DeepSeaCoral == "Accuracy", "Ba_Ca_umol_mol"] <- (DSC_Summary_table_NIST612 $Ba_Ca_umol_mol[14]-DSC_Summary_table_NIST612 $Ba_Ca_umol_mol[17])/DSC_Summary_table_NIST612 $Ba_Ca_umol_mol[17]*100
  DSC_Summary_table_NIST612 [DSC_Summary_table_NIST612 $DeepSeaCoral == "Accuracy", "U_Ca_umol_mol"] <- (DSC_Summary_table_NIST612 $U_Ca_umol_mol[14]-DSC_Summary_table_NIST612 $U_Ca_umol_mol[17])/DSC_Summary_table_NIST612 $U_Ca_umol_mol[17]*100
}

write.csv(DSC_Summary_table_NIST612, "DSC_Summary_table_NIST612.csv")

# JCP Summary - DSC ####
## DSC
## DSC #### 
i <-1
JCP_Corrected_DSC_Means <- list()
for (i in 1:length(Calculations_DSC)) {
  JCP_corrected_ratios <-
  Calculations_DSC[[i]] %>%
    slice(1L,8L) %>% # select mean(-values 2SD outside) + %2SE
    dplyr::select(1,42:50) %>% # select only ratios
    mutate(
    Li_Ca_JCP_corrected = Li_Ca[1]/(mean(c(Calculations_JCP[[i]]$Li_Ca[1],Calculations_JCP[[i+1]]$Li_Ca[1]))/Constants$JCP$Li_Ca[1]),
    Li_Ca_JCP_corrected_2SE = Li_Ca_JCP_corrected*(sqrt(((sd(c(Calculations_JCP[[i]]$Li_Ca[1],Calculations_JCP[[i+1]]$Li_Ca[1]))/mean(c(Calculations_JCP[[i]]$Li_Ca[1],Calculations_JCP[[i+1]]$Li_Ca[1]))*100)^2)+(Calculations_DSC[[i]]$Li_Ca[8]^2)))/100,
    B_Ca_JCP_corrected = B_Ca[1]/(mean(c(Calculations_JCP[[i]]$B_Ca[1],Calculations_JCP[[i+1]]$B_Ca[1]))/Constants$JCP$B_Ca[1]),
    B_Ca_JCP_corrected_2SE = B_Ca_JCP_corrected*(sqrt(((sd(c(Calculations_JCP[[i]]$B_Ca[1],Calculations_JCP[[i+1]]$B_Ca[1]))/mean(c(Calculations_JCP[[i]]$B_Ca[1],Calculations_JCP[[i+1]]$B_Ca[1]))*100)^2)+(Calculations_DSC[[i]]$B_Ca[8]^2)))/100,
    Mg_Ca_JCP_corrected = Mg_Ca[1]/(mean(c(Calculations_JCP[[i]]$Mg_Ca[1],Calculations_JCP[[i+1]]$Mg_Ca[1]))/Constants$JCP$Mg_Ca[1]),
    Mg_Ca_JCP_corrected_2SE = Mg_Ca_JCP_corrected*(sqrt(((sd(c(Calculations_JCP[[i]]$Mg_Ca[1],Calculations_JCP[[i+1]]$Mg_Ca[1]))/mean(c(Calculations_JCP[[i]]$Mg_Ca[1],Calculations_JCP[[i+1]]$Mg_Ca[1]))*100)^2)+(Calculations_DSC[[i]]$Mg_Ca[8]^2)))/100,
    P_Ca_JCP_corrected = P_Ca[1]/(mean(c(Calculations_JCP[[i]]$P_Ca[1],Calculations_JCP[[i+1]]$P_Ca[1]))/Constants$JCP$P_Ca[1]),
    P_Ca_JCP_corrected_2SE = P_Ca_JCP_corrected*(sqrt(((sd(c(Calculations_JCP[[i]]$P_Ca[1],Calculations_JCP[[i+1]]$P_Ca[1]))/mean(c(Calculations_JCP[[i]]$P_Ca[1],Calculations_JCP[[i+1]]$P_Ca[1]))*100)^2)+(Calculations_DSC[[i]]$P_Ca[8]^2)))/100,
    S_Ca_JCP_corrected = S_Ca[1]/(mean(c(Calculations_JCP[[i]]$S_Ca[1],Calculations_JCP[[i+1]]$S_Ca[1]))/Constants$JCP$S_Ca[1]),
    S_Ca_JCP_corrected_2SE = S_Ca_JCP_corrected*(sqrt(((sd(c(Calculations_JCP[[i]]$S_Ca[1],Calculations_JCP[[i+1]]$S_Ca[1]))/mean(c(Calculations_JCP[[i]]$S_Ca[1],Calculations_JCP[[i+1]]$S_Ca[1]))*100)^2)+(Calculations_DSC[[i]]$S_Ca[8]^2)))/100,
    Mn_Ca_JCP_corrected = Mn_Ca[1]/(mean(c(Calculations_JCP[[i]]$Mn_Ca[1],Calculations_JCP[[i+1]]$Mn_Ca[1]))/Constants$JCP$Mn_Ca[1]),
    Mn_Ca_JCP_corrected_2SE = Mn_Ca_JCP_corrected*(sqrt(((sd(c(Calculations_JCP[[i]]$Mn_Ca[1],Calculations_JCP[[i+1]]$Mn_Ca[1]))/mean(c(Calculations_JCP[[i]]$Mn_Ca[1],Calculations_JCP[[i+1]]$Mn_Ca[1]))*100)^2)+(Calculations_DSC[[i]]$Mn_Ca[8]^2)))/100,
    Sr_Ca_JCP_corrected = Sr_Ca[1]/(mean(c(Calculations_JCP[[i]]$Sr_Ca[1],Calculations_JCP[[i+1]]$Sr_Ca[1]))/Constants$JCP$Sr_Ca[1]),
    Sr_Ca_JCP_corrected_2SE = Sr_Ca_JCP_corrected*(sqrt(((sd(c(Calculations_JCP[[i]]$Sr_Ca[1],Calculations_JCP[[i+1]]$Sr_Ca[1]))/mean(c(Calculations_JCP[[i]]$Sr_Ca[1],Calculations_JCP[[i+1]]$Sr_Ca[1]))*100)^2)+(Calculations_DSC[[i]]$Sr_Ca[8]^2)))/100,
    Ba_Ca_JCP_corrected = Ba_Ca[1]/(mean(c(Calculations_JCP[[i]]$Ba_Ca[1],Calculations_JCP[[i+1]]$Ba_Ca[1]))/Constants$JCP$Ba_Ca[1]),
    Ba_Ca_JCP_corrected_2SE = Ba_Ca_JCP_corrected*(sqrt(((sd(c(Calculations_JCP[[i]]$Ba_Ca[1],Calculations_JCP[[i+1]]$Ba_Ca[1]))/mean(c(Calculations_JCP[[i]]$Ba_Ca[1],Calculations_JCP[[i+1]]$Ba_Ca[1]))*100)^2)+(Calculations_DSC[[i]]$Ba_Ca[8]^2)))/100,
    U_Ca_JCP_corrected = U_Ca[1]/(mean(c(Calculations_JCP[[i]]$U_Ca[1],Calculations_JCP[[i+1]]$U_Ca[1]))/Constants$JCP$U_Ca[1]),
    U_Ca_JCP_corrected_2SE = U_Ca_JCP_corrected*(sqrt(((sd(c(Calculations_JCP[[i]]$U_Ca[1],Calculations_JCP[[i+1]]$U_Ca[1]))/mean(c(Calculations_JCP[[i]]$U_Ca[1],Calculations_JCP[[i+1]]$U_Ca[1]))*100)^2)+(Calculations_DSC[[i]]$U_Ca[8]^2)))/100,
    )
                                                           
JCP_corrected_ratios <- JCP_corrected_ratios %>%
  slice(1L) %>% #remove row for %2SE
  dplyr::select(11:28) %>%
    mutate(
      Li_Ca_umol_mol = Li_Ca_JCP_corrected,
      Li_Ca_umol_mol_2SE = Li_Ca_umol_mol/100*(Li_Ca_JCP_corrected_2SE/Li_Ca_JCP_corrected*100),
      B_Ca_umol_mol = B_Ca_JCP_corrected,
      B_Ca_umol_mol_2SE = B_Ca_umol_mol/100*(B_Ca_JCP_corrected_2SE/B_Ca_JCP_corrected*100),
      Mg_Ca_umol_mol = Mg_Ca_JCP_corrected*1000,
      Mg_Ca_umol_mol_2SE = (Mg_Ca_umol_mol/100*(Mg_Ca_JCP_corrected_2SE/Mg_Ca_JCP_corrected*100))*1000,
      P_Ca_umol_mol = P_Ca_JCP_corrected,
      P_Ca_umol_mol_2SE = P_Ca_umol_mol/100*(P_Ca_JCP_corrected_2SE/P_Ca_JCP_corrected*100),
      S_Ca_umol_mol = S_Ca_JCP_corrected*1000,
      S_Ca_umol_mol_2SE = (S_Ca_umol_mol/100*(S_Ca_JCP_corrected_2SE/S_Ca_JCP_corrected*100))*1000,
      Mn_Ca_umol_mol = Mn_Ca_JCP_corrected,
      Mn_Ca_umol_mol_2SE = Mn_Ca_umol_mol/100*(Mn_Ca_JCP_corrected_2SE/Mn_Ca_JCP_corrected*100),
      Sr_Ca_umol_mol = Sr_Ca_JCP_corrected*1000,
      Sr_Ca_umol_mol_2SE = (Sr_Ca_umol_mol/100*(Sr_Ca_JCP_corrected_2SE/Sr_Ca_JCP_corrected*100))*1000,
      Ba_Ca_umol_mol = Ba_Ca_JCP_corrected,
      Ba_Ca_umol_mol_2SE = Ba_Ca_umol_mol/100*(Ba_Ca_JCP_corrected_2SE/Ba_Ca_JCP_corrected*100),
      U_Ca_umol_mol = U_Ca_JCP_corrected/1000,
      U_Ca_umol_mol_2SE = (U_Ca_umol_mol/100*(U_Ca_JCP_corrected_2SE/U_Ca_JCP_corrected*100))/1000
    )

assign(paste0(names(Calculations_DSC[i]), "_JCP_Corrected_Means"), JCP_corrected_ratios)
JCP_Corrected_DSC_Means[[paste0(names(Calculations_DSC[i]), "_JCP_Corrected_Means")]] <- JCP_corrected_ratios
}

DSC_Summary_table_JCP <- data.frame(DeepSeaCoral = c(1:12, "", "mean", "2SD", "%2SD", "Expected", "Accuracy"))
for (i in 1:length(JCP_Corrected_DSC_Means)) {
  DSC_Summary_table_JCP[DSC_Summary_table_JCP$DeepSeaCoral == i, "Li_Ca_umol_mol"] <- JCP_Corrected_DSC_Means[[i]]$Li_Ca_umol_mol
  DSC_Summary_table_JCP[DSC_Summary_table_JCP$DeepSeaCoral == i, "Li_Ca_umol_mol_2SE"] <- JCP_Corrected_DSC_Means[[i]]$Li_Ca_umol_mol_2SE
  DSC_Summary_table_JCP[DSC_Summary_table_JCP$DeepSeaCoral == i, "B_Ca_umol_mol"] <- JCP_Corrected_DSC_Means[[i]]$B_Ca_umol_mol
  DSC_Summary_table_JCP[DSC_Summary_table_JCP$DeepSeaCoral == i, "B_Ca_umol_mol_2SE"] <- JCP_Corrected_DSC_Means[[i]]$B_Ca_umol_mol_2SE
  DSC_Summary_table_JCP[DSC_Summary_table_JCP$DeepSeaCoral == i, "Mg_Ca_umol_mol"] <- JCP_Corrected_DSC_Means[[i]]$Mg_Ca_umol_mol
  DSC_Summary_table_JCP[DSC_Summary_table_JCP$DeepSeaCoral == i, "Mg_Ca_umol_mol_2SE"] <- JCP_Corrected_DSC_Means[[i]]$Mg_Ca_umol_mol_2SE
  DSC_Summary_table_JCP[DSC_Summary_table_JCP$DeepSeaCoral == i, "P_Ca_umol_mol"] <- JCP_Corrected_DSC_Means[[i]]$P_Ca_umol_mol
  DSC_Summary_table_JCP[DSC_Summary_table_JCP$DeepSeaCoral == i, "P_Ca_umol_mol_2SE"] <- JCP_Corrected_DSC_Means[[i]]$P_Ca_umol_mol_2SE
  DSC_Summary_table_JCP[DSC_Summary_table_JCP$DeepSeaCoral == i, "S_Ca_umol_mol"] <- JCP_Corrected_DSC_Means[[i]]$S_Ca_umol_mol
  DSC_Summary_table_JCP[DSC_Summary_table_JCP$DeepSeaCoral == i, "S_Ca_umol_mol_2SE"] <- JCP_Corrected_DSC_Means[[i]]$S_Ca_umol_mol_2SE
  DSC_Summary_table_JCP[DSC_Summary_table_JCP$DeepSeaCoral == i, "Mn_Ca_umol_mol"] <- JCP_Corrected_DSC_Means[[i]]$Mn_Ca_umol_mol
  DSC_Summary_table_JCP[DSC_Summary_table_JCP$DeepSeaCoral == i, "Mn_Ca_umol_mol_2SE"] <- JCP_Corrected_DSC_Means[[i]]$Mn_Ca_umol_mol_2SE
  DSC_Summary_table_JCP[DSC_Summary_table_JCP$DeepSeaCoral == i, "Sr_Ca_umol_mol"] <- JCP_Corrected_DSC_Means[[i]]$Sr_Ca_umol_mol
  DSC_Summary_table_JCP[DSC_Summary_table_JCP$DeepSeaCoral == i, "Sr_Ca_umol_mol_2SE"] <- JCP_Corrected_DSC_Means[[i]]$Sr_Ca_umol_mol_2SE
  DSC_Summary_table_JCP[DSC_Summary_table_JCP$DeepSeaCoral == i, "Ba_Ca_umol_mol"] <- JCP_Corrected_DSC_Means[[i]]$Ba_Ca_umol_mol
  DSC_Summary_table_JCP[DSC_Summary_table_JCP$DeepSeaCoral == i, "Ba_Ca_umol_mol_2SE"] <- JCP_Corrected_DSC_Means[[i]]$Ba_Ca_umol_mol_2SE
  DSC_Summary_table_JCP[DSC_Summary_table_JCP$DeepSeaCoral == i, "U_Ca_umol_mol"] <- JCP_Corrected_DSC_Means[[i]]$U_Ca_umol_mol
  DSC_Summary_table_JCP[DSC_Summary_table_JCP$DeepSeaCoral == i, "U_Ca_umol_mol_2SE"] <- JCP_Corrected_DSC_Means[[i]]$U_Ca_umol_mol_2SE
  DSC_Summary_table_JCP[DSC_Summary_table_JCP$DeepSeaCoral == "mean", "Li_Ca_umol_mol"] <- mean(DSC_Summary_table_JCP$Li_Ca_umol_mol[1:12])
  DSC_Summary_table_JCP[DSC_Summary_table_JCP$DeepSeaCoral == "mean", "B_Ca_umol_mol"] <- mean(DSC_Summary_table_JCP$B_Ca_umol_mol[1:12])
  DSC_Summary_table_JCP[DSC_Summary_table_JCP$DeepSeaCoral == "mean", "Mg_Ca_umol_mol"] <- mean(DSC_Summary_table_JCP$Mg_Ca_umol_mol[1:12])
  DSC_Summary_table_JCP[DSC_Summary_table_JCP$DeepSeaCoral == "mean", "P_Ca_umol_mol"] <- mean(DSC_Summary_table_JCP$P_Ca_umol_mol[1:12])
  DSC_Summary_table_JCP[DSC_Summary_table_JCP$DeepSeaCoral == "mean", "S_Ca_umol_mol"] <- mean(DSC_Summary_table_JCP$S_Ca_umol_mol[1:12])  
  DSC_Summary_table_JCP[DSC_Summary_table_JCP$DeepSeaCoral == "mean", "Mn_Ca_umol_mol"] <- mean(DSC_Summary_table_JCP$Mn_Ca_umol_mol[1:12])
  DSC_Summary_table_JCP[DSC_Summary_table_JCP$DeepSeaCoral == "mean", "Sr_Ca_umol_mol"] <- mean(DSC_Summary_table_JCP$Sr_Ca_umol_mol[1:12])
  DSC_Summary_table_JCP[DSC_Summary_table_JCP$DeepSeaCoral == "mean", "Ba_Ca_umol_mol"] <- mean(DSC_Summary_table_JCP$Ba_Ca_umol_mol[1:12])
  DSC_Summary_table_JCP[DSC_Summary_table_JCP$DeepSeaCoral == "mean", "U_Ca_umol_mol"] <- mean(DSC_Summary_table_JCP$U_Ca_umol_mol[1:12])
  DSC_Summary_table_JCP[DSC_Summary_table_JCP$DeepSeaCoral == "2SD", "Li_Ca_umol_mol"] <- sd(DSC_Summary_table_JCP$Li_Ca_umol_mol[1:12])*2
  DSC_Summary_table_JCP[DSC_Summary_table_JCP$DeepSeaCoral == "2SD", "B_Ca_umol_mol"] <- sd(DSC_Summary_table_JCP$B_Ca_umol_mol[1:12])*2
  DSC_Summary_table_JCP[DSC_Summary_table_JCP$DeepSeaCoral == "2SD", "Mg_Ca_umol_mol"] <- sd(DSC_Summary_table_JCP$Mg_Ca_umol_mol[1:12])*2
  DSC_Summary_table_JCP[DSC_Summary_table_JCP$DeepSeaCoral == "2SD", "P_Ca_umol_mol"] <- sd(DSC_Summary_table_JCP$P_Ca_umol_mol[1:12])*2
  DSC_Summary_table_JCP[DSC_Summary_table_JCP$DeepSeaCoral == "2SD", "S_Ca_umol_mol"] <- sd(DSC_Summary_table_JCP$S_Ca_umol_mol[1:12])*2
  DSC_Summary_table_JCP[DSC_Summary_table_JCP$DeepSeaCoral == "2SD", "Mn_Ca_umol_mol"] <- sd(DSC_Summary_table_JCP$Mn_Ca_umol_mol[1:12])*2
  DSC_Summary_table_JCP[DSC_Summary_table_JCP$DeepSeaCoral == "2SD", "Sr_Ca_umol_mol"] <- sd(DSC_Summary_table_JCP$Sr_Ca_umol_mol[1:12])*2
  DSC_Summary_table_JCP[DSC_Summary_table_JCP$DeepSeaCoral == "2SD", "Ba_Ca_umol_mol"] <- sd(DSC_Summary_table_JCP$Ba_Ca_umol_mol[1:12])*2
  DSC_Summary_table_JCP[DSC_Summary_table_JCP$DeepSeaCoral == "2SD", "U_Ca_umol_mol"] <- sd(DSC_Summary_table_JCP$U_Ca_umol_mol[1:12])*2
  DSC_Summary_table_JCP[DSC_Summary_table_JCP$DeepSeaCoral == "%2SD", "Li_Ca_umol_mol"] <- DSC_Summary_table_JCP$Li_Ca_umol_mol[15]/DSC_Summary_table_JCP$Li_Ca_umol_mol[14]*100
  DSC_Summary_table_JCP[DSC_Summary_table_JCP$DeepSeaCoral == "%2SD", "B_Ca_umol_mol"] <- DSC_Summary_table_JCP$B_Ca_umol_mol[15]/DSC_Summary_table_JCP$B_Ca_umol_mol[14]*100
  DSC_Summary_table_JCP[DSC_Summary_table_JCP$DeepSeaCoral == "%2SD", "Mg_Ca_umol_mol"] <- DSC_Summary_table_JCP$Mg_Ca_umol_mol[15]/DSC_Summary_table_JCP$Mg_Ca_umol_mol[14]*100
  DSC_Summary_table_JCP[DSC_Summary_table_JCP$DeepSeaCoral == "%2SD", "P_Ca_umol_mol"] <- DSC_Summary_table_JCP$P_Ca_umol_mol[15]/DSC_Summary_table_JCP$P_Ca_umol_mol[14]*100
  DSC_Summary_table_JCP[DSC_Summary_table_JCP$DeepSeaCoral == "%2SD", "S_Ca_umol_mol"] <- DSC_Summary_table_JCP$S_Ca_umol_mol[15]/DSC_Summary_table_JCP$S_Ca_umol_mol[14]*100
  DSC_Summary_table_JCP[DSC_Summary_table_JCP$DeepSeaCoral == "%2SD", "Mn_Ca_umol_mol"] <- DSC_Summary_table_JCP$Mn_Ca_umol_mol[15]/DSC_Summary_table_JCP$Mn_Ca_umol_mol[14]*100
  DSC_Summary_table_JCP[DSC_Summary_table_JCP$DeepSeaCoral == "%2SD", "Sr_Ca_umol_mol"] <- DSC_Summary_table_JCP$Sr_Ca_umol_mol[15]/DSC_Summary_table_JCP$Sr_Ca_umol_mol[14]*100
  DSC_Summary_table_JCP[DSC_Summary_table_JCP$DeepSeaCoral == "%2SD", "Ba_Ca_umol_mol"] <- DSC_Summary_table_JCP$Ba_Ca_umol_mol[15]/DSC_Summary_table_JCP$Ba_Ca_umol_mol[14]*100
  DSC_Summary_table_JCP[DSC_Summary_table_JCP$DeepSeaCoral == "%2SD", "U_Ca_umol_mol"] <- DSC_Summary_table_JCP$U_Ca_umol_mol[15]/DSC_Summary_table_JCP$U_Ca_umol_mol[14]*100
  DSC_Summary_table_JCP[DSC_Summary_table_JCP$DeepSeaCoral == "Expected", "Li_Ca_umol_mol"] <- 48.67
  DSC_Summary_table_JCP[DSC_Summary_table_JCP$DeepSeaCoral == "Expected", "B_Ca_umol_mol"] <- 233.82
  DSC_Summary_table_JCP[DSC_Summary_table_JCP$DeepSeaCoral == "Expected", "Mg_Ca_umol_mol"] <- 78970
  DSC_Summary_table_JCP[DSC_Summary_table_JCP$DeepSeaCoral == "Expected", "P_Ca_umol_mol"] <- NA
  DSC_Summary_table_JCP[DSC_Summary_table_JCP$DeepSeaCoral == "Expected", "S_Ca_umol_mol"] <- NA
  DSC_Summary_table_JCP[DSC_Summary_table_JCP$DeepSeaCoral == "Expected", "Mn_Ca_umol_mol"] <- NA
  DSC_Summary_table_JCP[DSC_Summary_table_JCP$DeepSeaCoral == "Expected", "Sr_Ca_umol_mol"] <- 2900
  DSC_Summary_table_JCP[DSC_Summary_table_JCP$DeepSeaCoral == "Expected", "Ba_Ca_umol_mol"] <- 13.64
  DSC_Summary_table_JCP[DSC_Summary_table_JCP$DeepSeaCoral == "Expected", "U_Ca_umol_mol"] <- 0.0183
  DSC_Summary_table_JCP[DSC_Summary_table_JCP$DeepSeaCoral == "Accuracy", "Li_Ca_umol_mol"] <- (DSC_Summary_table_JCP$Li_Ca_umol_mol[14]-DSC_Summary_table_JCP$Li_Ca_umol_mol[17])/DSC_Summary_table_JCP$Li_Ca_umol_mol[17]*100
  DSC_Summary_table_JCP[DSC_Summary_table_JCP$DeepSeaCoral == "Accuracy", "B_Ca_umol_mol"] <- (DSC_Summary_table_JCP$B_Ca_umol_mol[14]-DSC_Summary_table_JCP$B_Ca_umol_mol[17])/DSC_Summary_table_JCP$B_Ca_umol_mol[17]*100
  DSC_Summary_table_JCP[DSC_Summary_table_JCP$DeepSeaCoral == "Accuracy", "Mg_Ca_umol_mol"] <- (DSC_Summary_table_JCP$Mg_Ca_umol_mol[14]-DSC_Summary_table_JCP$Mg_Ca_umol_mol[17])/DSC_Summary_table_JCP$Mg_Ca_umol_mol[17]*100
  DSC_Summary_table_JCP[DSC_Summary_table_JCP$DeepSeaCoral == "Accuracy", "P_Ca_umol_mol"] <- (DSC_Summary_table_JCP$P_Ca_umol_mol[14]-DSC_Summary_table_JCP$P_Ca_umol_mol[17])/DSC_Summary_table_JCP$P_Ca_umol_mol[17]*100
  DSC_Summary_table_JCP[DSC_Summary_table_JCP$DeepSeaCoral == "Accuracy", "S_Ca_umol_mol"] <- (DSC_Summary_table_JCP$S_Ca_umol_mol[14]-DSC_Summary_table_JCP$S_Ca_umol_mol[17])/DSC_Summary_table_JCP$S_Ca_umol_mol[17]*100
  DSC_Summary_table_JCP[DSC_Summary_table_JCP$DeepSeaCoral == "Accuracy", "Mn_Ca_umol_mol"] <- (DSC_Summary_table_JCP$Mn_Ca_umol_mol[14]-DSC_Summary_table_JCP$Mn_Ca_umol_mol[17])/DSC_Summary_table_JCP$Mn_Ca_umol_mol[17]*100
  DSC_Summary_table_JCP[DSC_Summary_table_JCP$DeepSeaCoral == "Accuracy", "Sr_Ca_umol_mol"] <- (DSC_Summary_table_JCP$Sr_Ca_umol_mol[14]-DSC_Summary_table_JCP$Sr_Ca_umol_mol[17])/DSC_Summary_table_JCP$Sr_Ca_umol_mol[17]*100
  DSC_Summary_table_JCP[DSC_Summary_table_JCP$DeepSeaCoral == "Accuracy", "Ba_Ca_umol_mol"] <- (DSC_Summary_table_JCP$Ba_Ca_umol_mol[14]-DSC_Summary_table_JCP$Ba_Ca_umol_mol[17])/DSC_Summary_table_JCP$Ba_Ca_umol_mol[17]*100
  DSC_Summary_table_JCP[DSC_Summary_table_JCP$DeepSeaCoral == "Accuracy", "U_Ca_umol_mol"] <- (DSC_Summary_table_JCP$U_Ca_umol_mol[14]-DSC_Summary_table_JCP$U_Ca_umol_mol[17])/DSC_Summary_table_JCP$U_Ca_umol_mol[17]*100
}

write.csv(DSC_Summary_table_JCP, "DSC_Summary_table_JCP.csv")


```

