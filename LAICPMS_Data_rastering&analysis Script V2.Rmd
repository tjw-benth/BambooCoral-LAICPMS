---
title: "LAICPMS_Data_rastering&analysis Script"
author: "Thomas J Williams"
date: "26/05/2022"
version: "2.10"
edited by: "Thomas J Williams"
edit date: "24/01/2023"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r packages and functions, echo = F, message=T}

packages <- c("tidyverse", "janitor", "sjmisc", "Hmisc", "viridis", "ggthemes", "ggpmisc", "patchwork", "raster", "terra", "GGally")
rasterpackages <- c("caTools", "scatterplot3d", "wesanderson", "matrixStats", "viridis", "RColorBrewer", "raster", "rasterVis", "hillshader")

options(scipen = 100)

for (i in packages) {
if (i %in% rownames(installed.packages()) == FALSE) 
{install.packages(i)
  require(i, character.only = T)} else {
    require(i, character.only = T)
  }
}

for (i in rasterpackages) {
if (i %in% rownames(installed.packages()) == FALSE) 
{install.packages(i)
  require(i, character.only = T)} else {
    require(i, character.only = T)
  }
}

# plotting multiple plots in a list
plot_a_list <- function(master_list_with_plots, no_of_rows, no_of_cols, ylim, xlim, ylab, xlab) {
  if(missing(ylim) | missing(xlim) | missing(ylab) | missing(xlab)) {
    patchwork::wrap_plots(master_list_with_plots, 
                        nrow = no_of_rows, ncol = no_of_cols)
  } else {
      patchwork::wrap_plots(master_list_with_plots, 
                        nrow = no_of_rows, ncol = no_of_cols) &
  ggplot2::lims(y = ylim, x = xlim) &
      ggplot2::xlab(label = xlab) &
      ggplot2::ylab(label = ylab)
  }
}

# pause function
testit <- function(x)
{
    p1 <- proc.time()
    Sys.sleep(x)
    proc.time() - p1 # The cpu usage should be negligible
}

# my_fun function
my_fn <- function(data, mapping, ...){
      p <- ggplot(data = data, mapping = mapping) + 
        geom_bin_2d(bins = 30, alpha = 0.5, show.legend = T, na.rm = T) +
  scale_fill_continuous(type = "viridis") +
  theme_classic()
      p
   }

```

## Collating tracks to each coral section (5 adjacent tracks per section) and applying secondary normalisation based off JcP inaccuracies

```{r collating tracks per section - 612 corrected, echo=T, message=T}

View(NIST612_Corrected_Samples)
detach(package::plyr)

Samples <-c("23_10", "23_6", "23_1", "23_16")
j <-1
a<-1
i <- 70

# for all ratios ####
for(j in 1:length(Samples)) { # 4 samples
  for(a in 1:3) { # 3 sections
    Sample_ratios <- list()
  for(i in 70:78) { # 9 element ratios
    Tracks <- get(paste0("NIST612_Corrected_Sample_",Samples[j],"_",a))
    Element <- colnames(Tracks[[1]])[[i]]
    cat("Sample: ", Samples[j], a, Element, "\n")
    Track1_data <- data.frame(Row = seq(1,nrow(Tracks[[1]]), by = 1),
                              Track1 = Tracks[[1]][[i]])
    Track2_data <- data.frame(Row = seq(1,nrow(Tracks[[2]]), by = 1),
                              Track2 = Tracks[[2]][[i]])
    Track3_data <- data.frame(Row = seq(1,nrow(Tracks[[3]]), by = 1),
                              Track3 = Tracks[[3]][[i]])
    Track4_data <- data.frame(Row = seq(1,nrow(Tracks[[4]]), by = 1),
                              Track4 = Tracks[[4]][[i]])
    Track5_data <- data.frame(Row = seq(1,nrow(Tracks[[5]]), by = 1),
                              Track5 = Tracks[[5]][[i]])
    Tracks_data <- full_join(full_join(full_join(full_join(Track1_data,
                                                           Track2_data),
                                                 Track3_data),
                                       Track4_data), 
                             Track5_data) 
    Tracks_data <- Tracks_data[-c(1:60),] # remove first 60 rows (30 second blank at 0.5s)
    Tracks_data <- head(Tracks_data, -90) # remove last 90 rows (45 second blank at 0.5s)
    Tracks_data$Row <- NULL
    
    # Secondary normalization - based off JCp standard inaccuracies (no P or Mn as massive variability - %SD > 70)
    if(Element == "Li_Ca_umol_mol") {
      Tracks_data_normalised <- Tracks_data * (100-8.76811768)/100
    } else { if(Element == "B_Ca_umol_mol"){
      Tracks_data_normalised <- Tracks_data * (100+1.7848328)/100
    } else { if(Element == "Mg_Ca_umol_mol"){
      Tracks_data_normalised <- Tracks_data * (100-3.76115643)/100
    } else { if(Element == "Sr_Ca_umol_mol"){
      Tracks_data_normalised <- Tracks_data * (100+4.6428207)/100
    } else { if(Element == "U_Ca_umol_mol"){
      Tracks_data_normalised <- Tracks_data * (100+8.6738645)/100
    } else { if(Element == "S_Ca_umol_mol"){
      Tracks_data_normalised <- Tracks_data * (100+27.92745)/100
    } else { if(Element == "Ba_Ca_umol_mol"){
      Tracks_data_normalised <- Tracks_data * (100+28.26798)/100
    } else { Tracks_data_normalised <- Tracks_data }}}}}}}
    
    assign(paste0(Element), Tracks_data_normalised)
    Sample_ratios[[paste0(Element)]] <- Tracks_data_normalised
    rm(Tracks_data)
    rm(Tracks_data_normalised)
    }
  assign(paste0("Sample_",Samples[j],"_",a,"_ratios"), Sample_ratios)
  rm(Sample_ratios)
  }
}
# View(Sample_23_16_3_ratios)

# Adding Li/Mg to samples 
Sample_23_1_1_ratios[["Li_Mg_umol_mmol"]] <- Sample_23_1_1_ratios[["Li_Ca_umol_mol"]]/(Sample_23_1_1_ratios[["Mg_Ca_umol_mol"]]/1000)
Sample_23_1_2_ratios[["Li_Mg_umol_mmol"]] <- Sample_23_1_2_ratios[["Li_Ca_umol_mol"]]/(Sample_23_1_2_ratios[["Mg_Ca_umol_mol"]]/1000)
Sample_23_1_3_ratios[["Li_Mg_umol_mmol"]] <- Sample_23_1_3_ratios[["Li_Ca_umol_mol"]]/(Sample_23_1_3_ratios[["Mg_Ca_umol_mol"]]/1000)

Sample_23_6_1_ratios[["Li_Mg_umol_mmol"]] <- Sample_23_6_1_ratios[["Li_Ca_umol_mol"]]/(Sample_23_6_1_ratios[["Mg_Ca_umol_mol"]]/1000)
Sample_23_6_2_ratios[["Li_Mg_umol_mmol"]] <- Sample_23_6_2_ratios[["Li_Ca_umol_mol"]]/(Sample_23_6_2_ratios[["Mg_Ca_umol_mol"]]/1000)
Sample_23_6_3_ratios[["Li_Mg_umol_mmol"]] <- Sample_23_6_3_ratios[["Li_Ca_umol_mol"]]/(Sample_23_6_3_ratios[["Mg_Ca_umol_mol"]]/1000)

Sample_23_10_1_ratios[["Li_Mg_umol_mmol"]] <- Sample_23_10_1_ratios[["Li_Ca_umol_mol"]]/(Sample_23_10_1_ratios[["Mg_Ca_umol_mol"]]/1000)
Sample_23_10_2_ratios[["Li_Mg_umol_mmol"]] <- Sample_23_10_2_ratios[["Li_Ca_umol_mol"]]/(Sample_23_10_2_ratios[["Mg_Ca_umol_mol"]]/1000)
Sample_23_10_3_ratios[["Li_Mg_umol_mmol"]] <- Sample_23_10_3_ratios[["Li_Ca_umol_mol"]]/(Sample_23_10_3_ratios[["Mg_Ca_umol_mol"]]/1000)

Sample_23_16_1_ratios[["Li_Mg_umol_mmol"]] <- Sample_23_16_1_ratios[["Li_Ca_umol_mol"]]/(Sample_23_16_1_ratios[["Mg_Ca_umol_mol"]]/1000)
Sample_23_16_2_ratios[["Li_Mg_umol_mmol"]] <- Sample_23_16_2_ratios[["Li_Ca_umol_mol"]]/(Sample_23_16_2_ratios[["Mg_Ca_umol_mol"]]/1000)
Sample_23_16_3_ratios[["Li_Mg_umol_mmol"]] <- Sample_23_16_3_ratios[["Li_Ca_umol_mol"]]/(Sample_23_16_3_ratios[["Mg_Ca_umol_mol"]]/1000)

# for Calcium counts ONLY ####
for(j in 1:length(Samples)) { # 4 samples
  for(a in 1:3) { # 3 sections
    Ca43_counts <- list()
    Tracks <- get(paste0("NIST612_Corrected_Sample_",Samples[j],"_",a))
    Element <- colnames(Tracks[[1]])[[47]] #Ca45_analysis_blankcorrected (Ca counts per second)
    cat("Sample: ", Samples[j], a, Element, "\n")
    Track1_data <- data.frame(Row = seq(1,nrow(Tracks[[1]]), by = 1),
                              Track1 = Tracks[[1]][[47]])
    Track2_data <- data.frame(Row = seq(1,nrow(Tracks[[2]]), by = 1),
                              Track2 = Tracks[[2]][[47]])
    Track3_data <- data.frame(Row = seq(1,nrow(Tracks[[3]]), by = 1),
                              Track3 = Tracks[[3]][[47]])
    Track4_data <- data.frame(Row = seq(1,nrow(Tracks[[4]]), by = 1),
                              Track4 = Tracks[[4]][[47]])
    Track5_data <- data.frame(Row = seq(1,nrow(Tracks[[5]]), by = 1),
                              Track5 = Tracks[[5]][[47]])
    Tracks_data <- full_join(full_join(full_join(full_join(Track1_data,
                                                           Track2_data),
                                                 Track3_data),
                                       Track4_data), 
                             Track5_data) 
    Tracks_data <- Tracks_data[-c(1:60),] # remove first 60 rows (30 second blank at 0.5s)
    Tracks_data <- head(Tracks_data, -90) # remove last 90 rows (45 second blank at 0.5s)
    Tracks_data$Row <- NULL
    assign(paste0(Element), Tracks_data)
    Ca43_counts[[paste0(Element)]] <- Tracks_data
    rm(Tracks_data)
  assign(paste0("Sample_",Samples[j],"_",a,"_Ca43_counts"), Ca43_counts)
  rm(Ca43_counts)
  }
}

# View(Sample_23_16_1_Ca43_counts)

```

# 1st half of code; reading element data of collated tracks, removing outliers, smoothing and plotting. 
# Second half of code; rastering in various formats

```{r intial read and plot of line scans}

Ratios <- c("Li_Ca", "B_Ca", "Mg_Ca", "P_Ca", "S_Ca", "Mn_Ca", "Sr_Ca", "Ba_Ca", "U_Ca", "Li_Mg")

plotdimensions <- par(mfrow=c(1,1),
                     mar=c(0.2,0.2,0.2,0.2),
                     oma=c(5,4,1,5),
                     bty = "n", 
                     bg = "transparent")

# Separate folders for rasters, line plots and the dimension files. These can be adapted to whichever folder you decide. 
Rasterpath <- "~/OneDrive - University of Southampton/PhD, INSPIRE DTP/Countries_Chapters/UK [Soton]/Chpt4 Bamboo Coral Analysis/LAICPMS/Data_R_processed/NIST612_Corrected_rasters/"
Linepath <- "~/OneDrive - University of Southampton/PhD, INSPIRE DTP/Countries_Chapters/UK [Soton]/Chpt4 Bamboo Coral Analysis/LAICPMS/Data_R_processed/NIST612_Corrected_lineplots/"
Dimensionspath <- "~/OneDrive - University of Southampton/PhD, INSPIRE DTP/Countries_Chapters/UK [Soton]/Chpt4 Bamboo Coral Analysis/LAICPMS/Data_R_processed/XY_dimensions_samples/"

# Reset for loops (should happen anyway but just in case)
a <- 1
c <- 1
b <- 1

# Do you want to plot outputs or just run code?
lineplot = F
pattern = T

#Standard error output dataframe
Standard_errors <- data.frame(Sample = character(),
                              Section = character(),
                              Element = character(),
                              mean_value = numeric(),
                              standard_dev_2_av = numeric(),
                              standard_error_2_av = numeric(),
                              coefficient_variation_av = numeric(),
                              max_value = numeric(),
                              min_value = numeric()
                                 )

#Reset plot dimensions
dev.off()

# for all ratios ####
#START OF SUPERLOOP
b <- 1
for(c in 1:length(Samples)) { # 4 samples
  for(b in 1:3) { # 3 sections
    
    Sample_ratios <- get(paste0("Sample_",Samples[c],"_",b,"_ratios"))
    testit(0.05) #pause for script to find file in time before reading
    temp = list.files(path = Dimensionspath, pattern = paste0(Samples[c],"_",b,"_TJW.csv"))
    testit(0.05) #pause for script to find file in time before reading
    XY_dim<-read.csv(file = paste0(Dimensionspath,temp), header=TRUE)
    
    for(a in 1:length(Ratios)) { # 10 ratios
      Sample_ratio <- Sample_ratios[[a]]
      cat("Sample: ", Samples[c], b, Ratios[a], "\n")

size <- length(Sample_ratio[,1])
r.depth <- seq(1, size, by =1)

#number of line scans used to make the image
no.tracks<-length(Sample_ratio[1,])

##degree of smoothing----
SM<-5

##level of rejection----
if (Ratios[a] == "U_Ca" | Ratios[a] == "Ba_Ca" | Ratios[a] == "Mn_Ca") {
  R<-2 
} else { if(Ratios[a] == "P_Ca") {
  R<-3
} else { if (Ratios[a] == "Li_Ca" | Ratios[a] == "Sr_Ca" | Ratios[a] == "Li_Mg") {
  R<-3
} else {
  R<-4
  }
  }
  }

#resolution factor ---- converts QQQ integration to MCICPMS integration of 2s 
#degrades the Y resolution of the raster
RS<-1 

###make the grid ---- 
#using the Y length and spot spacing

dim.Y<-XY_dim$Y[2]-XY_dim$Y[1] #nb for landscape orientation this is the Y dimension

x.grid.dim<-seq (1, size,  by=1)
y.grid.dim<-seq (-1, -no.tracks, by=-1)
x.grid<-matrix (NA, ncol=no.tracks, nrow=size/RS)
y.grid<-matrix (NA, ncol=no.tracks, nrow=size/RS)

for (i in 1:no.tracks){
  x.grid[,i]<-seq (1, size/RS,  by=1)
}
for (i in 1:no.tracks){
  y.grid[,i]<-rep (y.grid.dim[i], size/RS)
}

##turn the grid into dimensions ####
spot.size<-50 #um
#int.time <-1*RS #seconds per data point #0.472 s for TE on QQQ and 1.049s for d11B
#scan.speed <- 10 #microns per second

x.grid.um<-x.grid*(dim.Y/size)
y.grid.um<-y.grid*spot.size

#plot (x.grid.um, y.grid.um)

# #colours
# nc<-wes_palette(no.tracks, name="Darjeeling1", type="continuous")
# 
# ##Plots ####
# plot (r.depth, Sample_ratio[,1], type="n", ylim=c(min (Sample_ratio, na.rm=TRUE),max(Sample_ratio, na.rm=TRUE)), ylab = paste0(Ratios[a]))
# mtext("Raw data", side = 3)
# #loop to plot each line scan, stepping through the Li_Ca vector column at a time (j increase by 1 up to a max = number of lines) 
# for (j in 1:no.tracks){
#   lines (r.depth, (Sample_ratio[,j]), col=nc[j])
# }

#want to now do some rejection of "bad" data - we use a +/-3sd limit
#determine the means and sd of each line
m.L<-rep (NA, size)
m.sd<-rep (NA, size)

#loop again to determine the mean and sd of each line
for (j in 1:no.tracks){
  m.L[j]<-mean (Sample_ratio[,j], na.rm=TRUE)
  m.sd[j]<-sd (Sample_ratio[,j], na.rm=TRUE)
  }

# #plot of these 
# plot (m.L)
# plot (m.sd)

#replace 3sd outliers with NA ####
#make matrix to fill with original data and NA when original data outside of +/-3sd

L.o<-matrix (NA, ncol=no.tracks, nrow=size)

#bit of a more complex loop - where it uses an ifelse statment to evaluate each data point
for (j in 1:no.tracks){
  for (i in 1:size) {
    L.o[i,j]<-ifelse (Sample_ratio[i,j] < m.L[j]+R*m.sd[j] & Sample_ratio[i,j] > m.L[j]-R*m.sd[j], Sample_ratio[i,j], NA)
  }}

# #have a look at the data -rejections
# plot (r.depth, Sample_ratio[,1], type="n", ylim=c(min(L.o, na.rm=TRUE),max(L.o, na.rm=TRUE)), ylab = paste0(Ratios[a]))
# mtext("No outliers", side = 3)
# #number of colours
# #loop to plot each line
# for (j in 1:no.tracks){
#   lines (r.depth, (L.o[,j]), col=nc[j])
# }

##smoothing ####
#degree of smoothing (choose a variable from 2 to n, 5 is probably ok)

#make a couple of matrix's to be filled with smoothed data
L.o.s<-matrix (NA, ncol=no.tracks, nrow=size)
L.o.s.sd<-matrix (NA, ncol=no.tracks, nrow=size)


for (j in 1:no.tracks){
    L.o.s[,j]<-runmean (L.o[,j], SM, endrule = "NA")
    L.o.s.sd[,j]<-runsd (L.o[,j], SM, endrule = "NA")
    
  }

# #take a look at the results of the smoothing
# plot (r.depth, Sample_ratio[,1], type="n", ylim=c(min(L.o.s, na.rm = T),max(L.o.s, na.rm=TRUE)), ylab = paste0(Ratios[a]))
# mtext("Smoothed data", side = 3)
# for (j in 1:no.tracks){
#   lines (r.depth, (L.o.s[,j]), col=nc[j])
# }
# dev.copy(png, paste0(Smoothpath, "Sample_",Samples[c],"_",b,"_",Ratios[a], "smoothplot.png"))
# dev.off()
# assign(paste0("Sample_",Samples[c],"_",b,"_",Ratios[a], "_smoothplot"), smoothplot)
# rm(smoothplot)

# # standard deviation over the track
# plot (r.depth, Sample_ratio[,1], type="n", ylim=c(min(L.o.s.sd, na.rm=TRUE),max(L.o.s.sd, na.rm=TRUE)), ylab = paste0(Ratios[a]))
# mtext("Rolling st.dev", side = 3)
# #number of cols
# for (j in 1:no.tracks){
#   lines (r.depth, (L.o.s.sd[,j])/(no.tracks^0.5), col=nc[j])
# }

##average se for each of the smoothed points####
se <- mean (L.o.s.sd/(SM^0.5), na.rm=TRUE)*2

## collate the lineplots and export####
if(lineplot == T) {
dev.off()
pdf(file = paste0(Linepath, "Sample_", Samples[c],"_",b," ", Ratios[a], " line plots.pdf"))

par(oma = c(3,3,0,0), mar = c(3,3,2,2), 
    layout(mat = matrix(c(1,3,2,4), 
                  nrow= 2, 
                  ncol = 2), 
                  heights = c(1, 1), # Heights of the two rows
                  widths = c(2, 2)), 
    bty= "n")


{plot (r.depth, Sample_ratio[,1], type="n", ylim=c(min (Sample_ratio, na.rm=TRUE),max(Sample_ratio, na.rm=TRUE)), ylab = paste0(Ratios[a]))
mtext("Raw data", side = 3)
#loop to plot each line scan, stepping through the Li_Ca vector column at a time (j increase by 1 up to a max = number of lines) 
for (j in 1:no.tracks){
  lines (r.depth, (Sample_ratio[,j]), col=nc[j])
}}
{plot (r.depth, Sample_ratio[,1], type="n", ylim=c(min(L.o, na.rm=TRUE),max(L.o, na.rm=TRUE)), ylab = paste0(Ratios[a]))
mtext("No outliers", side = 3)
#number of colours
#loop to plot each line
for (j in 1:no.tracks){
  lines (r.depth, (L.o[,j]), col=nc[j])
}}

{plot (r.depth, Sample_ratio[,1], type="n", ylim=c(min(L.o.s, na.rm=TRUE),max(L.o.s, na.rm=TRUE)), ylab = paste0(Ratios[a]))
mtext("Smoothed data", side = 3)
for (j in 1:no.tracks){
  lines (r.depth, (L.o.s[,j]), col=nc[j])
}}

{plot (r.depth, Sample_ratio[,1], type="n", ylim=c(min(L.o.s.sd, na.rm=TRUE),max(L.o.s.sd, na.rm=TRUE)), ylab = paste0(Ratios[a]))
mtext("Rolling st.dev", side = 3)
#number of cols
for (j in 1:no.tracks){
  lines (r.depth, (L.o.s.sd[,j])/(no.tracks^0.5), col=nc[j])
}}
mtext(text= "Distance",side=1,line=0,outer=TRUE)
mtext(text=paste0(Ratios[a]),side=2,line=0,outer=TRUE)

dev.off()
}

## pattern plots ####
if (pattern == T) {
  pattern_data <- as.data.frame(L.o.s)
  if(Samples[c] == "23_6") { 
    pattern_data$distance.um <- x.grid.um[,1] } else {
         pattern_data$distance.um <- -x.grid.um[,1] 
       }
  
pattern_data <-  pattern_data %>%
    rowwise() %>%
    mutate(n = count(!is.na(c(V1,V2,V3,V4,V5))),
           mean = mean(c(V1,V2,V3,V4,V5), na.rm = TRUE),
           sd = sd(c(V1,V2,V3,V4,V5), na.rm = TRUE),
           sd2 = sd*2,
           se2 = sd2/sqrt(n),
           max = max(c(V1,V2,V3,V4,V5), na.rm = TRUE),
           min = min(c(V1,V2,V3,V4,V5), na.rm = TRUE),
           coefficient_var = sd/mean)

pattern_data[pattern_data$max == -Inf,]$max <- NA
pattern_data[pattern_data$min == Inf,]$min <- NA

assign(paste0("Sample_",Samples[c],"_",b,"_",Ratios[a], "_patterndata"), pattern_data)

Standard_errors <- Standard_errors %>% add_row(
  Sample = paste0(Samples[c]),
  Section = paste0(b),
  Element = Ratios[a],
  mean_value = mean(pattern_data$mean, na.rm = T),
  standard_dev_2_av = mean(pattern_data$sd2, na.rm = T),
  standard_error_2_av = mean(pattern_data$se2, na.rm = T),
  coefficient_variation_av = mean(pattern_data$coefficient_var, na.rm = T),
  max_value = max(pattern_data$max, na.rm = T),
  min_value = min(pattern_data$min, na.rm = T)
)

Variability_plot <- ggplot(data = pattern_data, aes(x = distance.um, y = mean)) +
  geom_ribbon(aes(x = distance.um, y=mean, ymax=mean+se2, ymin=mean-se2), fill="#227988",alpha=.5) +
  geom_path(aes(distance.um, max), lty =2, size = 0.5) +
  geom_path(aes(distance.um, min), lty =2, size = 0.5) +
  geom_path(aes(distance.um, mean), lty =1, size = 0.8) +
  stat_poly_line(col = "red", linetype = 3) +
  stat_poly_eq(aes(label = paste(after_stat(eq.label),
                                 after_stat(rr.label), sep = "*\", \"*"))) +
  ggpubr::stat_cor(method = "pearson", label.x.npc = .5) +
  scale_y_continuous(name = paste0(Ratios[a]," (µmol/mol)")) +
  scale_x_reverse(name = "Distance from coral edge (µm)") +
  theme_classic()

assign(paste0("Sample_",Samples[c],"_",b,"_",Ratios[a], "_variabilityplot"), Variability_plot)

rm(pattern_data)
rm(Variability_plot)

}
#now we have rejected the outliers and smoothed the data we can make a raster image (a map)
## rasterise ####
#sets the dimensions of the plot 

#fill up a matrix with X and Y coordinates and smoothed and rejected laser ablation values
s100<-matrix (c(x.grid.um, rev(y.grid.um), L.o.s), ncol=3, byrow=FALSE)
#s100<-matrix (c(x.grid, rev(y.grid), L.o), ncol=3, byrow=FALSE) #not smoothed
colnames(s100) <- c('X', 'Y', 'Z')
e <- extent(s100[,1:2]) #tells the raster its X and Y that form the grid

# important - nrow here is the number of laser lines going into the raster
# for some reason n-1 makes the best images and makes the resolution correct (Gavin)
# HOWEVER, with smaller number of tracks I (Tom) find that it works better having n and changing the aspect of the plots accordingly.  Otherwise the last track has weird overlapping data.  
r <- raster(e, ncol=size, nrow=no.tracks)

#using nrow < lenght of lines or ncol< number of lines will lower the resolution

# you need to provide a function 'fun' for when there are multiple points per cell
x <- rasterize(s100[, 1:2], r, s100[,3], fun=mean)

assign(paste0("Sample_", Samples[c],"_",b," ", Ratios[a], " raster"), x)
    }
  }
}


# For Ca43 ONLY ####

for(c in 1:length(Samples)) { # 4 samples
  for(b in 1:3) { # 3 sections
    
    Ca43_counts <- get(paste0("Sample_",Samples[c],"_",b,"_Ca43_counts"))
    testit(0.05) #pause for script to find file in time before reading
    temp = list.files(path = Dimensionspath, pattern = paste0(Samples[c],"_",b,"_TJW.csv"))
    testit(0.05) #pause for script to find file in time before reading
    XY_dim<-read.csv(file = paste0(Dimensionspath,temp), header=TRUE)
    
      Ca43_count <- Ca43_counts[[1]]
      cat("Sample: ", Samples[c], b, "Ca43_counts", "\n")

size <- length(Ca43_count[,1])
r.depth <- seq(1, size, by =1)

#number of line scans used to make the image
no.tracks<-length(Ca43_count[1,])

#degree of smoothing----
SM<-5

#level of rejection----
R<-4
 
#resolution factor ---- converts QQQ integration to MCICPMS integration of 2s 
#degrades the Y resolution of the raster
RS<-1 

###make the grid ---- 
#using the Y length and spot spacing

dim.Y<-XY_dim$Y[2]-XY_dim$Y[1] #nb for landscape orientation this is the Y dimension

x.grid.dim<-seq (1, size,  by=1)
y.grid.dim<-seq (-1, -no.tracks, by=-1)
x.grid<-matrix (NA, ncol=no.tracks, nrow=size/RS)
y.grid<-matrix (NA, ncol=no.tracks, nrow=size/RS)

for (i in 1:no.tracks){
  x.grid[,i]<-seq (1, size/RS,  by=1)
}
for (i in 1:no.tracks){
  y.grid[,i]<-rep (y.grid.dim[i], size/RS)
}

#turn the grid into dimensions ####
spot.size<-50 #um
#int.time <-1*RS #seconds per data point #0.472 s for TE on QQQ and 1.049s for d11B
#scan.speed <- 10 #microns per second

x.grid.um<-x.grid*(dim.Y/size)
y.grid.um<-y.grid*spot.size

#plot (x.grid.um, y.grid.um)

#colours
nc<-wes_palette(no.tracks, name="Darjeeling1", type="continuous")

#Plots ####
plot (r.depth, Ca43_count[,1], type="n", ylim=c(min (Ca43_count, na.rm=TRUE),max(Ca43_count, na.rm=TRUE)), ylab = paste0("Ca43 (counts per second)"))
mtext("Raw data", side = 3)
#loop to plot each line scan, stepping through the Li_Ca vector column at a time (j increase by 1 up to a max = number of lines) 
for (j in 1:no.tracks){
  lines (r.depth, (Ca43_count[,j]), col=nc[j])
}

#want to now do some rejection of "bad" data - we use a +/-3sd limit
#determine the means and sd of each line
m.L<-rep (NA, size)
m.sd<-rep (NA, size)

#loop again to determine the mean and sd of each line
for (j in 1:no.tracks){
  m.L[j]<-mean (Ca43_count[,j], na.rm=TRUE)
  m.sd[j]<-sd (Ca43_count[,j], na.rm=TRUE)
  }

#plot of these 
plot (m.L)
plot (m.sd)

#replace 3sd outliers with NA ####
#make matrix to fill with original data and NA when original data outside of +/-3sd

L.o<-matrix (NA, ncol=no.tracks, nrow=size)

#bit of a more complex loop - where it uses an ifelse statment to evaluate each data point
for (j in 1:no.tracks){
  for (i in 1:size) {
    L.o[i,j]<-ifelse (Ca43_count[i,j] < m.L[j]+R*m.sd[j] & Ca43_count[i,j] > m.L[j]-R*m.sd[j], Ca43_count[i,j], NA)
  }}

#have a look at the data -rejections
plot (r.depth, Ca43_count[,1], type="n", ylim=c(min(L.o, na.rm=TRUE),max(L.o, na.rm=TRUE)), ylab = paste0("Ca43 (counts per second)"))
mtext("No outliers", side = 3)
#number of colours
#loop to plot each line
for (j in 1:no.tracks){
  lines (r.depth, (L.o[,j]), col=nc[j])
}

#smoothing ####
#degree of smoothing (choose a variable from 2 to n, 5 is probably ok)

#make a couple of matrix's to be filled with smoothed data
L.o.s<-matrix (NA, ncol=no.tracks, nrow=size)
L.o.s.sd<-matrix (NA, ncol=no.tracks, nrow=size)


for (j in 1:no.tracks){
    L.o.s[,j]<-runmean (L.o[,j], SM, endrule = "NA")
    L.o.s.sd[,j]<-runsd (L.o[,j], SM, endrule = "NA")
    
  }

#take a look at the results of the smoothing
plot (r.depth, Ca43_count[,1], type="n", ylim=c(min(L.o.s, na.rm = T),max(L.o.s, na.rm=TRUE)), ylab = paste0("Ca43 (counts per second)"))
mtext("Smoothed data", side = 3)
for (j in 1:no.tracks){
  lines (r.depth, (L.o.s[,j]), col=nc[j])
}


# standard deviation over the track
plot (r.depth, Ca43_count[,1], type="n", ylim=c(min(L.o.s.sd, na.rm=TRUE),max(L.o.s.sd, na.rm=TRUE)), ylab = paste0("Ca43 (counts per second)"))
mtext("Rolling st.dev", side = 3)
#number of cols
for (j in 1:no.tracks){
  lines (r.depth, (L.o.s.sd[,j])/(no.tracks^0.5), col=nc[j])
}

#average se for each of the smoothed points####
se <- mean (L.o.s.sd/(SM^0.5), na.rm=TRUE)*2


#now we have rejected the outliers and smoothed the data we can make a raster image (a map)
## rasterise ####
#sets the dimensions of the plot 

#fill up a matrix with X and Y coordinates and smoothed and rejected laser ablation values
s100<-matrix (c(x.grid.um, rev(y.grid.um), L.o.s), ncol=3, byrow=FALSE)
#s100<-matrix (c(x.grid, rev(y.grid), L.o), ncol=3, byrow=FALSE) #not smoothed
colnames(s100) <- c('X', 'Y', 'Z')
e <- extent(s100[,1:2]) #tells the raster its X and Y that form the grid

# important - nrow here is the number of laser lines going into the raster
# for some reason n-1 makes the best images and makes the resolution correct (Gavin)
# HOWEVER, with smaller number of tracks I (Tom) find that it works better having n and changing the aspect of the plots accordingly.  Otherwise the last track has weird overlapping data.  
r <- raster(e, ncol=size, nrow=no.tracks)

#using nrow < lenght of lines or ncol< number of lines will lower the resolution

# you need to provide a function 'fun' for when there are multiple points per cell
x <- rasterize(s100[, 1:2], r, s100[,3], fun=mean)

assign(paste0("Sample_", Samples[c],"_",b, "_Ca43_counts_raster"), x)
    }
  }
```


Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.

```{r rastering each element ratio seperately}

for(a in 1:length(Ratios)) {
Element_rasters <- grep(paste0("*",Ratios[a], " raster"),names(.GlobalEnv),value=TRUE)
Element_raster_list <-do.call("list",mget(Element_rasters))
assign(paste0(Ratios[a], "_raster_list"), Element_raster_list)
}
rm(Element_raster_list)

Sr_Ca_rasters <- grep(paste0("*","Sr_Ca", " raster"),names(.GlobalEnv),value=TRUE)
Sr_Ca_rasters_list <- do.call("list", mget(Sr_Ca_rasters))
Sr_Ca_rasters_list <- Sr_Ca_rasters_list[order(names(Sr_Ca_rasters_list))]
U_Ca_rasters <- grep(paste0("*","U_Ca", " raster"),names(.GlobalEnv),value=TRUE)
U_Ca_rasters_list <- do.call("list", mget(U_Ca_rasters))
U_Ca_rasters_list <- U_Ca_rasters_list[order(names(U_Ca_rasters_list))]

rm(Sr_Ca_rasters)
rm(U_Ca_rasters)

for(a in 1:length(Sr_Ca_rasters_list)) {
  Sr_U_raster <- (Sr_Ca_rasters_list[[a]]/1000) - (U_Ca_rasters_list[[a]]*1.1107)
  assign(paste0(gsub(" .*$", "", names(Sr_Ca_raster_list[a])), " Sr_U raster"), Sr_U_raster)
}

Sr_U_rasters <- grep(paste0("*","Sr_U", " raster"),names(.GlobalEnv),value=TRUE)
Sr_U_raster_list <-do.call("list",mget(Sr_U_rasters))

rm(Sr_U_rasters)

Rasterpath_viridis <- "~/OneDrive - University of Southampton/PhD, INSPIRE DTP/Countries_Chapters/UK [Soton]/Chpt4 Bamboo Coral Analysis/LAICPMS/Data_R_processed/NIST612_Corrected_rasters/Interpolated/"

b<- 1
# Temperature proxies
col2 <- viridis(40)
plot.new()
for (b in 1:length(Li_Mg_raster_list)) {
  par(mfrow=c(1,1),
                     mar=c(0.2,0.2,0.2,0.2),
                     oma=c(5,5,1,4),
                     bty = "n",
                     bg = "transparent")
plot(Li_Mg_raster_list[[b]],col=(col2), interpolate=TRUE, axes = F, cex.axis=0.8, asp = 1.25, alpha = 0.6, legend.args=list(text=" Li/Mg (µmol/mol)", side=4, line=3,cex=0.8, las=0), breaks = seq(0,2,by = 0.05))
mtext(paste0(names(Li_Mg_raster_list[b]),"_viridis"), side = 3)
dev.copy(png, paste0(Rasterpath_viridis, names(Li_Mg_raster_list[b]), "_viridis_interpolated.png"))
dev.off()
frame()
}

# V high values, not saying much
col2 <- inferno(40)
plot.new()
for (b in 1:length(Mg_Ca_raster_list)) {
  par(mfrow=c(1,1),
                     mar=c(0.2,0.2,0.2,0.2),
                     oma=c(5,5,1,4),
                     bty = "n",
                     bg = "transparent")
plot(Mg_Ca_raster_list[[b]],col=(col2), interpolate=TRUE, axes = F, cex.axis=0.8, asp = 1.25, alpha = 0.6, legend.args=list(text=" Mg/Ca (µmol/mol)", side=4, line=3,cex=0.8, las=0), breaks = seq(60000,100000,by = 1000))
mtext(paste0(names(Mg_Ca_raster_list[b]),"_viridis"), side = 3)
dev.copy(png, paste0(Rasterpath_viridis, names(Mg_Ca_raster_list[b]), "_viridis_interpolated.png"))
dev.off()
frame()
}

col1 <-inferno(20)
plot.new()
for (b in 1:length(Sr_Ca_raster_list)) {
  par(mfrow=c(1,1),
                     mar=c(0.2,0.2,0.2,0.2),
                     oma=c(5,5,1,4),
                     bty = "n",
                     bg = "transparent")
plot(Sr_Ca_raster_list[[b]],col=(col1), interpolate=TRUE, axes = F, cex.axis=0.8, asp = 1.25, alpha = 0.6, legend.args=list(text=" Sr/Ca (µmol/mol)", side=4, line=3,cex=0.8, las=0), breaks = seq(2500,3500,by = 50))
mtext(paste0(names(Sr_Ca_raster_list[b]),"_viridis"), side = 3)
dev.copy(png, paste0(Rasterpath_viridis, names(Sr_Ca_raster_list[b]), "_inferno_interpolated.png"))
dev.off()
frame()
}

col1 <-inferno(20)
plot.new
for (b in 1:length(Sr_U_raster_list)) {
  par(mfrow=c(1,1),
                     mar=c(0.2,0.2,0.2,0.2),
                     oma=c(5,5,1,4),
                     bty = "n",
                     bg = "transparent")
plot(Sr_U_raster_list[[b]],col=(col1), interpolate=TRUE, axes = F, cex.axis=0.8, asp = 1.25, alpha = 0.6, legend.args=list(text=" Sr/U (mmol/µmol)", side=4, line=3,cex=0.8, las=0), breaks = seq(2,4,by = 0.1))
mtext(paste0(names(Sr_U_raster_list[b]),"_viridis"), side = 3)
dev.copy(png, paste0(Rasterpath_viridis, names(Sr_U_raster_list[b]), "_inferno_interpolated.png"))
dev.off()
frame()
}

col2 <- viridis(24)
plot.new()
for (b in 1:length(Li_Ca_raster_list)) {
  par(mfrow=c(1,1),
                     mar=c(0.2,0.2,0.2,0.2),
                     oma=c(5,5,1,4),
                     bty = "n",
                     bg = "transparent")
plot(Li_Ca_raster_list[[b]],col=(col2), interpolate=TRUE, axes = F, cex.axis=0.8, asp = 1.25, alpha = 0.6, legend.args=list(text=" Li/Ca (µmol/mol)", side=4, line=3,cex=0.8, las=0), breaks = seq(0,120,by = 5))
mtext(paste0(names(Li_Ca_raster_list[b]),"_viridis"), side = 3)
dev.copy(png, paste0(Rasterpath_viridis, names(Li_Ca_raster_list[b]), "_viridis_interpolated.png"))
dev.off()
frame()
}

col1 <- inferno(40)
plot.new()
for (b in 1:length(B_Ca_raster_list)) {
  par(mfrow=c(1,1),
                     mar=c(0.2,0.2,0.2,0.2),
                     oma=c(5,5,1,4),
                     bty = "n",
                     bg = "transparent")
plot(B_Ca_raster_list[[b]],col=(col1), interpolate=TRUE, axes = F, cex.axis=0.8, asp = 1.25, alpha = 0.6, legend.args=list(text=" B/Ca (µmol/mol)", side=4, line=3,cex=0.8, las=0), breaks = seq(100,300,by = 5))
mtext(paste0(names(B_Ca_raster_list[b]),"_viridis"), side = 3)
dev.copy(png, paste0(Rasterpath_viridis, names(B_Ca_raster_list[b]), "_inferno_interpolated.png"))
dev.off()
frame()
}

col3 <-c(inferno(20),rep("#FFFFFF",20))
plot.new()
for (b in 1:length(Ba_Ca_raster_list)) {
  par(mfrow=c(1,1),
                     mar=c(0.2,0.2,0.2,0.2),
                     oma=c(5,5,1,4),
                     bty = "n",
                     bg = "transparent")
plot(Ba_Ca_raster_list[[b]],col=(col3), interpolate=TRUE, axes = F, cex.axis=0.8, asp = 1.25, alpha = 0.6, legend = F, breaks = seq(0,40,by = 1))
plot(Ba_Ca_raster_list[[b]], col =(inferno(20)), breaks = seq(0,20, by = 1), zlim = c(0,10), interpolate=T, axes = F, legend.args=list(text=" Ba/Ca (µmol/mol)", side=4, line=3,cex=0.8, las=0), legend.only = T)
mtext(paste0(names(Ba_Ca_raster_list[b]),"_inferno"), side = 3)
dev.copy(png, paste0(Rasterpath_viridis, names(Ba_Ca_raster_list[b]), "_Inferno_interpolated.png"))
dev.off()
frame()
}

# Poor, negative ratios. Peaks at coral boundary edge (opposite to Li and B)
col1 <- c(inferno(20), rep("#FFFFFF", 50))
plot.new()
for (b in 1:length(Mn_Ca_raster_list)) {
  par(mfrow=c(1,1),
                     mar=c(0.2,0.2,0.2,0.2),
                     oma=c(5,5,1,4),
                     bty = "n",
                     bg = "transparent")
plot(Mn_Ca_raster_list[[b]],col=(col1), interpolate=TRUE, axes = F, cex.axis=0.8, asp = 1.25, alpha = 0.6, breaks = seq(0,35,by = 0.5), zlim = c(0,35), legend = FALSE)
plot(Mn_Ca_raster_list[[b]], col =(inferno(20)), breaks = seq(0,10, by = 0.5), zlim = c(0,10), interpolate=T, axes = F, legend.args=list(text=" Mn/Ca (µmol/mol)", side=4, line=3,cex=0.8, las=0), legend.only = T)

mtext(paste0(names(Mn_Ca_raster_list[b]),"_viridis"), side = 3)

dev.copy(png, paste0(Rasterpath_viridis, names(Mn_Ca_raster_list[b]), "_inferno_interpolated.png"))
dev.off()
frame()
}

col3 <-wes_palette(24, name="FantasticFox1", type="continuous")
plot.new()
for (b in 1:length(P_Ca_raster_list)) {
  par(mfrow=c(1,1),
                     mar=c(0.2,0.2,0.2,0.2),
                     oma=c(5,5,1,4),
                     bty = "n",
                     bg = "transparent")
plot(P_Ca_raster_list[[b]],col=(col3), interpolate=TRUE, axes = F, cex.axis=0.8, asp = 1.25, alpha = 0.6, legend.args=list(text=" P/Ca (µmol/mol)", side=4, line=3,cex=0.8, las=0), breaks = seq(150,700,by = 25))
mtext(paste0(names(P_Ca_raster_list[b]),"_viridis"), side = 3)
dev.copy(png, paste0(Rasterpath_viridis, names(P_Ca_raster_list[b]), "_FF_interpolated.png"))
dev.off()
frame()
}

col2 <-viridis(40)
plot.new()
for (b in 1:length(S_Ca_raster_list)) {
  par(mfrow=c(1,1),
                     mar=c(0.2,0.2,0.2,0.2),
                     oma=c(5,5,1,4),
                     bty = "n",
                     bg = "transparent")
plot(S_Ca_raster_list[[b]],col=(col2), interpolate=TRUE, axes = F, cex.axis=0.8, asp = 1.25, alpha = 0.6, legend.args=list(text=" S/Ca (µmol/mol)", side=4, line=3,cex=0.8, las=0), breaks = seq(6000,12000,by = 150))
mtext(paste0(names(S_Ca_raster_list[b]),"_viridis"), side = 3)
dev.copy(png, paste0(Rasterpath_viridis, names(S_Ca_raster_list[b]), "_viridis_interpolated.png"))
dev.off()
frame()
}

col3 <-c(viridis(20),rep("#FFFFFF", 50))
plot.new()
for (b in 1:length(U_Ca_raster_list)) {
  par(mfrow=c(1,1),
                     mar=c(0.2,0.2,0.2,0.2),
                     oma=c(5,5,1,4),
                     bty = "n",
                     bg = "transparent")
plot(U_Ca_raster_list[[b]],col=(col3), interpolate=TRUE, axes = F, cex.axis=0.8, asp = 1.25, alpha = 0.6, breaks = seq(0,0.28,by = 0.004), zlim = c(0,0.28), legend = FALSE)
plot(U_Ca_raster_list[[b]], col =(col3), breaks = seq(0,0.08, by = 0.004), zlim = c(0,0.08), interpolate=T, axes = F, legend.args=list(text=" U/Ca (µmol/mol)", side=4, line=3,cex=0.8, las=0), legend.only = T)

mtext(paste0(names(U_Ca_raster_list[b]),"_viridis"), side = 3)

dev.copy(png, paste0(Rasterpath_viridis, names(U_Ca_raster_list[b]), "_DJ_interpolated.png"))
dev.off()
frame()
}

# for Ca43 ONLY ####


Ca43_rasters <- grep(paste0("*","_Ca43_counts_raster"),names(.GlobalEnv),value=TRUE)
Ca43_raster_list <-do.call("list",mget(Ca43_rasters))

col1 <-inferno(25)
plot.new()
for (b in 1:length(Ca43_raster_list)) {
  par(mfrow=c(1,1),
                     mar=c(0.2,0.2,0.2,0.2),
                     oma=c(5,5,1,4),
                     bty = "n",
                     bg = "transparent")
plot(Ca43_raster_list[[b]],col=(col1), interpolate=TRUE, axes = F, cex.axis=0.8, asp = 1.25, alpha = 0.6, legend.args=list(text=" Ca (counts per second)", side=4, line=4.5,cex=0.8, las=0), breaks = seq(4000000,9000000,by = 200000))
mtext(paste0(names(Ca43_raster_list[b]),"_viridis"), side = 3)
dev.copy(png, paste0(Rasterpath_viridis, names(Ca43_raster_list[b]), "_inferno_interpolated.png"))
dev.off()
frame()
}
```

```{r Intra & inter-individual reproducibility}

#Varability plots####
for(a in 1:length(Ratios)) {
  for(c in 1:length(Samples)) {
    patterns <- c(paste0(Samples[c],"_"), paste0(Ratios[a],"_variabilityplot"))
Sample_Variability_plots <- grep(paste0(patterns, collapse = ".*"),names(.GlobalEnv),value=TRUE)
Variability_plots_list <-do.call("list",mget(Sample_Variability_plots))
Variability_plots_list <- Variability_plots_list[order(names(Variability_plots_list))]
assign(paste0("Sample_",Samples[c]," ",Ratios[a], " Variability_plots_list"), Variability_plots_list)
  }
}
rm(Variability_plots_list)

## Sample 23-16 ####
plot_a_list(`Sample_23_16 B_Ca Variability_plots_list`, 3,1, ylim = c(100,300), xlim = c(1200,0), ylab = "B/Ca (µmol/mol)", xlab = "Distance (µm)")
plot_a_list(`Sample_23_16 Ba_Ca Variability_plots_list`, 3,1, ylim = c(5,20), xlim = c(1200,0), ylab = "Ba/Ca (µmol/mol)", xlab = "Distance (µm)")
plot_a_list(`Sample_23_16 Mg_Ca Variability_plots_list`, 3,1, ylim = c(60000,100000), xlim = c(1200,0), ylab = "Mg/Ca (µmol/mol)", xlab = "Distance (µm)")
plot_a_list(`Sample_23_16 Mg_Ca Variability_plots_list`, 3,1, ylim = c(60000,100000), xlim = c(1200,0), ylab = "Mg/Ca (µmol/mol)", xlab = "Distance (µm)")
plot_a_list(`Sample_23_16 Li_Ca Variability_plots_list`, 3,1, ylim = c(0,100), xlim = c(1200,0), ylab = "Li/Ca (µmol/mol)", xlab = "Distance (µm)")
plot_a_list(`Sample_23_16 Mn_Ca Variability_plots_list`, 3,1, ylim = c(0,80), xlim = c(1200,0), ylab = "Mn/Ca (µmol/mol)", xlab = "Distance (µm)")
plot_a_list(`Sample_23_16 Mn_Ca Variability_plots_list`, 3,1, ylim = c(0,5), xlim = c(1200,250), ylab = "Mn/Ca (µmol/mol)", xlab = "Distance (µm)")
plot_a_list(`Sample_23_16 P_Ca Variability_plots_list`, 3,1, ylim = c(150,800), xlim = c(1200,0), ylab = "P/Ca (µmol/mol)", xlab = "Distance (µm)")
plot_a_list(`Sample_23_16 S_Ca Variability_plots_list`, 3,1, ylim = c(5000,9000), xlim = c(1200,0), ylab = "S/Ca (µmol/mol)", xlab = "Distance (µm)")
plot_a_list(`Sample_23_16 Sr_Ca Variability_plots_list`, 3,1, ylim = c(2500,3500), xlim = c(1200,0), ylab = "Sr/Ca (µmol/mol)", xlab = "Distance (µm)")
plot_a_list(`Sample_23_16 U_Ca Variability_plots_list`, 3,1, ylim = c(0,0.08), xlim = c(1200,0), ylab = "U/Ca (µmol/mol)", xlab = "Distance (µm)")
plot_a_list(`Sample_23_16 U_Ca Variability_plots_list`, 3,1, ylim = c(0,0.02), xlim = c(1200,250), ylab = "U/Ca (µmol/mol)", xlab = "Distance (µm)")

## Sample 23-10 ####
plot_a_list(`Sample_23_10 B_Ca Variability_plots_list`, 3,1, ylim = c(100,300), xlim = c(1600,0), ylab = "B/Ca (µmol/mol)", xlab = "Distance (µm)")
plot_a_list(`Sample_23_10 Ba_Ca Variability_plots_list`, 3,1, ylim = c(5,15), xlim = c(1600,0), ylab = "Ba/Ca (µmol/mol)", xlab = "Distance (µm)")
plot_a_list(`Sample_23_10 Mg_Ca Variability_plots_list`, 3,1, ylim = c(60000,100000), xlim = c(1600,0), ylab = "Mg/Ca (µmol/mol)", xlab = "Distance (µm)")
plot_a_list(`Sample_23_10 Li_Ca Variability_plots_list`, 3,1, ylim = c(0,100), xlim = c(1600,0), ylab = "Li/Ca (µmol/mol)", xlab = "Distance (µm)")
plot_a_list(`Sample_23_10 Mn_Ca Variability_plots_list`, 3,1, ylim = c(0,25), xlim = c(1600,0), ylab = "Mn/Ca (µmol/mol)", xlab = "Distance (µm)")
plot_a_list(`Sample_23_10 Mn_Ca Variability_plots_list`, 3,1, ylim = c(0,5), xlim = c(1600,250), ylab = "Mn/Ca (µmol/mol)", xlab = "Distance (µm)")
plot_a_list(`Sample_23_10 P_Ca Variability_plots_list`, 3,1, ylim = c(150,800), xlim = c(1600,0), ylab = "P/Ca (µmol/mol)", xlab = "Distance (µm)")
plot_a_list(`Sample_23_10 S_Ca Variability_plots_list`, 3,1, ylim = c(6500,12000), xlim = c(1600,0), ylab = "S/Ca (µmol/mol)", xlab = "Distance (µm)")
plot_a_list(`Sample_23_10 Sr_Ca Variability_plots_list`, 3,1, ylim = c(2800,4000), xlim = c(1600,0), ylab = "Sr/Ca (µmol/mol)", xlab = "Distance (µm)")
plot_a_list(`Sample_23_10 U_Ca Variability_plots_list`, 3,1, ylim = c(0,0.1), xlim = c(1600,0), ylab = "U/Ca (µmol/mol)", xlab = "Distance (µm)")
plot_a_list(`Sample_23_10 U_Ca Variability_plots_list`, 3,1, ylim = c(0,0.025), xlim = c(1600,250), ylab = "U/Ca (µmol/mol)", xlab = "Distance (µm)")

## Sample 23-6 ####
plot_a_list(`Sample_23_6 B_Ca Variability_plots_list`, 3,1, ylim = c(100,250), xlim = c(3500,0), ylab = "B/Ca (µmol/mol)", xlab = "Distance (µm)")
plot_a_list(`Sample_23_6 Ba_Ca Variability_plots_list`, 3,1, ylim = c(5,15), xlim = c(3500,0), ylab = "Ba/Ca (µmol/mol)", xlab = "Distance (µm)")
plot_a_list(`Sample_23_6 Mg_Ca Variability_plots_list`, 3,1, ylim = c(60000,100000), xlim = c(3500,0), ylab = "Mg/Ca (µmol/mol)", xlab = "Distance (µm)")
plot_a_list(`Sample_23_6 Li_Ca Variability_plots_list`, 3,1, ylim = c(0,75), xlim = c(3500,0), ylab = "Li/Ca (µmol/mol)", xlab = "Distance (µm)")
plot_a_list(`Sample_23_6 Mn_Ca Variability_plots_list`, 3,1, ylim = c(0,20), xlim = c(3500,0), ylab = "Mn/Ca (µmol/mol)", xlab = "Distance (µm)")
plot_a_list(`Sample_23_6 Mn_Ca Variability_plots_list`, 3,1, ylim = c(0,5), xlim = c(-3500,250), ylab = "Mn/Ca (µmol/mol)", xlab = "Distance (µm)")
plot_a_list(`Sample_23_6 P_Ca Variability_plots_list`, 3,1, ylim = c(150,600), xlim = c(3500,0), ylab = "P/Ca (µmol/mol)", xlab = "Distance (µm)")
plot_a_list(`Sample_23_6 S_Ca Variability_plots_list`, 3,1, ylim = c(6000,10000), xlim = c(3500,0), ylab = "S/Ca (µmol/mol)", xlab = "Distance (µm)")
plot_a_list(`Sample_23_6 Sr_Ca Variability_plots_list`, 3,1, ylim = c(2900,3500), xlim = c(3500,0), ylab = "Sr/Ca (µmol/mol)", xlab = "Distance (µm)")
plot_a_list(`Sample_23_6 U_Ca Variability_plots_list`, 3,1, ylim = c(0,0.05), xlim = c(3500,0), ylab = "U/Ca (µmol/mol)", xlab = "Distance (µm)")
plot_a_list(`Sample_23_6 U_Ca Variability_plots_list`, 3,1, ylim = c(0,0.025), xlim = c(3500,250), ylab = "U/Ca (µmol/mol)", xlab = "Distance (µm)")

## Sample 23-1 ####
plot_a_list(`Sample_23_1 B_Ca Variability_plots_list`, 3,1, ylim = c(100,300), xlim = c(1600,0), ylab = "B/Ca (µmol/mol)", xlab = "Distance (µm)")
plot_a_list(`Sample_23_1 Ba_Ca Variability_plots_list`, 3,1, ylim = c(5,20), xlim = c(1600,0), ylab = "Ba/Ca (µmol/mol)", xlab = "Distance (µm)")
plot_a_list(`Sample_23_1 Mg_Ca Variability_plots_list`, 3,1, ylim = c(60000,100000), xlim = c(1600,0), ylab = "Mg/Ca (µmol/mol)", xlab = "Distance (µm)")
plot_a_list(`Sample_23_1 Li_Ca Variability_plots_list`, 3,1, ylim = c(0,100), xlim = c(1600,0), ylab = "Li/Ca (µmol/mol)", xlab = "Distance (µm)")
plot_a_list(`Sample_23_1 Mn_Ca Variability_plots_list`, 3,1, ylim = c(0,30), xlim = c(1600,0), ylab = "Mn/Ca (µmol/mol)", xlab = "Distance (µm)")
plot_a_list(`Sample_23_1 Mn_Ca Variability_plots_list`, 3,1, ylim = c(0,5), xlim = c(1600,250), ylab = "Mn/Ca (µmol/mol)", xlab = "Distance (µm)")
plot_a_list(`Sample_23_1 P_Ca Variability_plots_list`, 3,1, ylim = c(150,700), xlim = c(1600,0), ylab = "P/Ca (µmol/mol)", xlab = "Distance (µm)")
plot_a_list(`Sample_23_1 S_Ca Variability_plots_list`, 3,1, ylim = c(6500,10000), xlim = c(1600,0), ylab = "S/Ca (µmol/mol)", xlab = "Distance (µm)")
plot_a_list(`Sample_23_1 Sr_Ca Variability_plots_list`, 3,1, ylim = c(3000,3400), xlim = c(-1600,0), ylab = "Sr/Ca (µmol/mol)", xlab = "Distance (µm)")
plot_a_list(`Sample_23_1 U_Ca Variability_plots_list`, 3,1, ylim = c(0,0.05), xlim = c(1600,0), ylab = "U/Ca (µmol/mol)", xlab = "Distance (µm)")
plot_a_list(`Sample_23_1 U_Ca Variability_plots_list`, 3,1, ylim = c(0,0.02), xlim = c(1600,250), ylab = "U/Ca (µmol/mol)", xlab = "Distance (µm)")

# Element vs element plots####
Sample_element_patterns_list <- list()
Ratios_folder_path <- paste0("~/OneDrive - University of Southampton/PhD, INSPIRE DTP/Countries_Chapters/UK [Soton]/Chpt4 Bamboo Coral Analysis/LAICPMS/Data_R_processed/NIST612_Corrected_Element_ratios/")
c <- 1
b <- 1
i <- 1
j <- 1

for(c in 1:length(Samples)) { # 4 samples
   for(b in 1:3) { # 3 sections
     cat("Sample: ", Samples[c], b, "\n")
    patterns <- c(paste0(Samples[c],"_",b), "_patterndata")
Section_element_patterns <- grep(paste0(patterns, collapse = ".*"),names(.GlobalEnv),value=TRUE)
Section_element_patterns_list <-do.call("list",mget(Section_element_patterns))
for(i in 1:length(Section_element_patterns_list)) {
  Tracks_element_patterns_list <- list()
  for(j in 1:5){
  Tracks_element_patterns_list[[j]] <- Section_element_patterns_list[[i]][c(j,6)]
  Data_name <- names(Section_element_patterns_list[i])
  Element_name <- sub(paste0("Sample_",Samples[c],"_",b,"_"), "", Data_name)
  Element_name <- sub("_patterndata", "", Element_name)
  colnames(Tracks_element_patterns_list[[j]]) <- c(Element_name, "distance.um")
  Tracks_element_patterns_list[[j]] <- Tracks_element_patterns_list[[j]] %>%
    mutate(Track = j)
  }
  Section_element_patterns_list[[i]] <- Tracks_element_patterns_list %>%
    reduce(full_join , by = c("distance.um", "Track", Element_name)) 
}
Section_element_pattern_data <- Section_element_patterns_list %>%
  reduce(full_join, by = c("distance.um", "Track")) %>% 
  mutate(Internode = b) 
assign(paste0("Sample_",Samples[c]," ",b, " element_patterns_data"), Section_element_pattern_data)
Sample_element_patterns_list[[paste0("Sample_",Samples[c]," ",b, " element_patterns_data")]] <- Section_element_pattern_data
   }
   
   cat("Sample: ", Samples[c], "combining internodes...", "\n")
   
   Sample_element_patterns_data <- Sample_element_patterns_list[grep(paste0(Samples[c]), names(Sample_element_patterns_list))] %>%
     reduce(full_join, by = c("distance.um", 
                              "Mg_Ca","Mn_Ca", 
                              "Ba_Ca","Sr_Ca", 
                              "P_Ca","U_Ca",
                              "B_Ca","Li_Ca",
                              "S_Ca","Li_Mg", 
                              "Internode", 
                              "Track")) 
   
      Sample_element_patterns_data <- Sample_element_patterns_data[, c("distance.um","Internode","Track","Li_Mg","Li_Ca","B_Ca","Mg_Ca","P_Ca","S_Ca","Mn_Ca","Sr_Ca","Ba_Ca","U_Ca")]
      
      
   my_fn <- function(data, mapping, ...){
      p <- data %>%
        ggplot(data = data, mapping = mapping) + 
        geom_point(show.legend = T, na.rm = T, alpha =0.4) +
        # scale_color_manual(values = c("red", "green",  "blue"), name = "Internode") +
        # scale_shape_manual(values = c(21,22,24), name = "Internode") +
        theme_classic()
      p
   }

   # All element ratios    
   Sample_element_patterns_ggpairs_internode <- ggpairs(Sample_element_patterns_data, columns = c(4:13), 
           aes(color = as.factor(Internode), pch = as.factor(Internode), alpha = 0.6),
           title = paste0("Sample ",Samples[c], " element ratios [by internode]  (µmol/mol)"),
           legend = 1,
           lower = list(continuous = my_fn), 
           diag = list(continuous = "densityDiag", alpha = 0.6),
           upper = list(continuous = wrap("cor", method = "spearman", size = 2.5))) +
           scale_color_manual(values = c("red", "green",  "blue")) +
           theme(legend.position = "bottom", axis.text.x.bottom = element_text(size = 6, angle = 45, vjust = 1, hjust=1)) +
     labs(fill = "Internode", color = "Internode")
   

    Sample_element_patterns_ggpairs_internode[1,1] <- Sample_element_patterns_ggpairs_internode[1,1] +
        scale_fill_manual(values=c("red", "green", "blue"))
    Sample_element_patterns_ggpairs_internode[2,2] <- Sample_element_patterns_ggpairs_internode[2,2] +
        scale_fill_manual(values=c("red", "green", "blue")) 
    Sample_element_patterns_ggpairs_internode[3,3] <- Sample_element_patterns_ggpairs_internode[3,3] +
        scale_fill_manual(values=c("red", "green", "blue"))
    Sample_element_patterns_ggpairs_internode[4,4] <- Sample_element_patterns_ggpairs_internode[4,4] +
        scale_fill_manual(values=c("red", "green", "blue")) 
    Sample_element_patterns_ggpairs_internode[5,5] <- Sample_element_patterns_ggpairs_internode[5,5] +
        scale_fill_manual(values=c("red", "green", "blue")) 
    Sample_element_patterns_ggpairs_internode[6,6] <- Sample_element_patterns_ggpairs_internode[6,6] +
        scale_fill_manual(values=c("red", "green", "blue"))
    Sample_element_patterns_ggpairs_internode[7,7] <- Sample_element_patterns_ggpairs_internode[7,7] +
        scale_fill_manual(values=c("red", "green", "blue")) 
    Sample_element_patterns_ggpairs_internode[8,8] <- Sample_element_patterns_ggpairs_internode[8,8] +
        scale_fill_manual(values=c("red", "green", "blue")) 
    Sample_element_patterns_ggpairs_internode[9,9] <- Sample_element_patterns_ggpairs_internode[9,9] +
        scale_fill_manual(values=c("red", "green", "blue")) 
    Sample_element_patterns_ggpairs_internode[9,9] <- Sample_element_patterns_ggpairs_internode[10,10] +
        scale_fill_manual(values=c("red", "green", "blue")) 
    
   assign(paste0("Sample_",Samples[c]," element ratios [by internode]"), Sample_element_patterns_ggpairs_internode)
   rm(Sample_element_patterns_ggpairs_internode)
   
   # Li, Mg, Sr, S and U
      Sample_Tempproxy_element_patterns_ggpairs_internode <- ggpairs(Sample_element_patterns_data, columns = c(4,5,7,9,11,13), 
           aes(color = as.factor(Internode), pch = as.factor(Internode), fill = as.factor(Internode), linetype = as.factor(Internode)),
           legend = 1,
           lower = list(continuous = my_fn), 
           diag = list(continuous = wrap("densityDiag", alpha = 0.6)),
           upper = list(continuous = wrap("cor", method = "spearman", size = 4)),
           columnLabels = c("Li/Mg", "Li/Ca", "Mg/Ca", "S/Ca", "Sr/Ca", "U/Ca"),
           labeller = "label_parsed") +
           scale_color_manual(values = c("red", "green",  "blue")) +
           scale_shape_manual(values = c(21,22,24), name = "Internode") +
           scale_linetype_manual(values = c(1,2,3), name = "Internode") +
           theme(legend.position = "bottom", axis.text.x.bottom = element_text(size = 9, angle = 45, vjust = 1, hjust=1),
                 strip.placement = "outside", text = element_text(size = 12)) +
     labs(fill = "Internode", color = "Internode")
   
    Sample_Tempproxy_element_patterns_ggpairs_internode[1,1] <- Sample_Tempproxy_element_patterns_ggpairs_internode[1,1] + scale_x_continuous(limits = c(0,2)) + theme_classic()
    Sample_Tempproxy_element_patterns_ggpairs_internode[1,2] <- Sample_Tempproxy_element_patterns_ggpairs_internode[1,2] + theme(panel.ontop = T, panel.background = element_rect(fill = "black"))
    Sample_Tempproxy_element_patterns_ggpairs_internode[1,3] <- Sample_Tempproxy_element_patterns_ggpairs_internode[1,3] + theme(panel.ontop = T, panel.background = element_rect(fill = "black"))
    Sample_Tempproxy_element_patterns_ggpairs_internode[2,1] <- Sample_Tempproxy_element_patterns_ggpairs_internode[2,1] + scale_x_continuous(limits = c(0,2)) + scale_y_continuous(limits = c(0,120)) + theme_classic() + theme(panel.ontop = T, panel.background = element_rect(fill = "black"))
    Sample_Tempproxy_element_patterns_ggpairs_internode[2,2] <- Sample_Tempproxy_element_patterns_ggpairs_internode[2,2] + scale_x_continuous(limits = c(0,120)) + theme_classic()
    Sample_Tempproxy_element_patterns_ggpairs_internode[3,1] <- Sample_Tempproxy_element_patterns_ggpairs_internode[3,1] + scale_x_continuous(limits = c(0,2)) + scale_y_continuous(limits = c(40000,130000)) + theme(panel.ontop = T, panel.background = element_rect(fill = "black"))  
    Sample_Tempproxy_element_patterns_ggpairs_internode[3,2] <- Sample_Tempproxy_element_patterns_ggpairs_internode[3,2] + scale_x_continuous(limits = c(0,120)) + scale_y_continuous(limits = c(40000,130000)) 
    Sample_Tempproxy_element_patterns_ggpairs_internode[3,3] <- Sample_Tempproxy_element_patterns_ggpairs_internode[3,3] + scale_x_continuous(limits = c(40000,130000)) + theme_classic()
    Sample_Tempproxy_element_patterns_ggpairs_internode[4,1] <- Sample_Tempproxy_element_patterns_ggpairs_internode[4,1] + scale_x_continuous(limits = c(0,2)) + scale_y_continuous(limits = c(3000,15000))     
    Sample_Tempproxy_element_patterns_ggpairs_internode[4,2] <- Sample_Tempproxy_element_patterns_ggpairs_internode[4,2] + scale_x_continuous(limits = c(0,120)) + scale_y_continuous(limits = c(3000,15000)) 
    Sample_Tempproxy_element_patterns_ggpairs_internode[4,3] <- Sample_Tempproxy_element_patterns_ggpairs_internode[4,3] + scale_x_continuous(limits = c(40000,130000)) + scale_y_continuous(limits = c(3000,15000)) 
    Sample_Tempproxy_element_patterns_ggpairs_internode[4,4] <- Sample_Tempproxy_element_patterns_ggpairs_internode[4,4] + scale_x_continuous(limits = c(3000,15000)) + theme_classic()
    Sample_Tempproxy_element_patterns_ggpairs_internode[5,1] <- Sample_Tempproxy_element_patterns_ggpairs_internode[5,1] + scale_x_continuous(limits = c(0,2)) + scale_y_continuous(limits = c(2000,5000))     
    Sample_Tempproxy_element_patterns_ggpairs_internode[5,2] <- Sample_Tempproxy_element_patterns_ggpairs_internode[5,2] + scale_x_continuous(limits = c(0,120)) + scale_y_continuous(limits = c(2000,5000)) 
    Sample_Tempproxy_element_patterns_ggpairs_internode[5,3] <- Sample_Tempproxy_element_patterns_ggpairs_internode[5,3] + scale_x_continuous(limits = c(40000,130000)) + scale_y_continuous(limits = c(2000,5000)) 
    Sample_Tempproxy_element_patterns_ggpairs_internode[5,4] <- Sample_Tempproxy_element_patterns_ggpairs_internode[5,4] + scale_x_continuous(limits = c(3000,15000)) + scale_y_continuous(limits = c(2000,5000)) 
    Sample_Tempproxy_element_patterns_ggpairs_internode[5,5] <- Sample_Tempproxy_element_patterns_ggpairs_internode[5,5] + scale_x_continuous(limits = c(2000,5000)) + theme_classic()
    Sample_Tempproxy_element_patterns_ggpairs_internode[6,1] <- Sample_Tempproxy_element_patterns_ggpairs_internode[6,1] + scale_x_continuous(limits = c(0,2)) + scale_y_continuous(limits = c(0,0.15))    
    Sample_Tempproxy_element_patterns_ggpairs_internode[6,2] <- Sample_Tempproxy_element_patterns_ggpairs_internode[6,2] + scale_x_continuous(limits = c(0,120)) + scale_y_continuous(limits = c(0,0.15))
    Sample_Tempproxy_element_patterns_ggpairs_internode[6,3] <- Sample_Tempproxy_element_patterns_ggpairs_internode[6,3] + scale_x_continuous(limits = c(40000,130000)) + scale_y_continuous(limits = c(0,0.15))
    Sample_Tempproxy_element_patterns_ggpairs_internode[6,4] <- Sample_Tempproxy_element_patterns_ggpairs_internode[6,4] + scale_x_continuous(limits = c(3000,15000)) + scale_y_continuous(limits = c(0,0.15))
    Sample_Tempproxy_element_patterns_ggpairs_internode[6,5] <- Sample_Tempproxy_element_patterns_ggpairs_internode[6,5] + scale_x_continuous(limits = c(2000,5000)) + scale_y_continuous(limits = c(0,0.15)) 
    Sample_Tempproxy_element_patterns_ggpairs_internode[6,6] <- Sample_Tempproxy_element_patterns_ggpairs_internode[6,6] + scale_x_continuous(limits = c(0,0.15)) + theme_classic()

    
   assign(paste0("Sample_",Samples[c]," Temp proxy element ratios [by internode]"), Sample_Tempproxy_element_patterns_ggpairs_internode)
   rm(Sample_Tempproxy_element_patterns_ggpairs_internode)
   
   
      # Ba vs Li, Mg, Sr, S and U
      Sample_Ba_patterns_ggpairs_internode <- ggpairs(Sample_element_patterns_data, columns = c(5,7,9,11,13,12), 
           aes(color = as.factor(Internode), pch = as.factor(Internode), fill = as.factor(Internode), linetype = as.factor(Internode)),
           legend = 1,
           lower = list(continuous = my_fn), 
           diag = list(continuous = wrap("densityDiag", alpha = 0.6)),
           upper = list(continuous = wrap("cor", method = "spearman", size = 4)),
           columnLabels = c("Li/Ca", "Mg/Ca", "S/Ca", "Sr/Ca", "U/Ca", "Ba/Ca"),
           labeller = "label_parsed") +
           scale_color_manual(values = c("red", "green",  "blue")) +
           scale_shape_manual(values = c(21,22,24), name = "Internode") +
           scale_linetype_manual(values = c(1,2,3), name = "Internode") +
           theme(legend.position = "bottom", axis.text.x.bottom = element_text(size = 9, angle = 45, vjust = 1, hjust=1),
                 strip.placement = "outside", text = element_text(size = 12), axis.text.y.left = element_blank(), axis.ticks.y.left = element_blank()) +
     labs(fill = "Internode", color = "Internode")
   

    Sample_Ba_patterns_ggpairs_internode[1,1] <- Sample_Ba_patterns_ggpairs_internode[1,1] + theme_classic()
    Sample_Ba_patterns_ggpairs_internode[2,2] <- Sample_Ba_patterns_ggpairs_internode[2,2] + theme_classic()
    Sample_Ba_patterns_ggpairs_internode[3,3] <- Sample_Ba_patterns_ggpairs_internode[3,3] + theme_classic()
    Sample_Ba_patterns_ggpairs_internode[4,4] <- Sample_Ba_patterns_ggpairs_internode[4,4] + theme_classic()
    Sample_Ba_patterns_ggpairs_internode[5,5] <- Sample_Ba_patterns_ggpairs_internode[5,5] + theme_classic()
    Sample_Ba_patterns_ggpairs_internode[6,6] <- Sample_Ba_patterns_ggpairs_internode[6,6] + theme_classic()
    
    plots <- lapply(1:Sample_Ba_patterns_ggpairs_internode$nrow, function(i) getPlot(Sample_Ba_patterns_ggpairs_internode, i = i, j = 6))
    
    Sample_Ba_patterns_ggpairs_internode <- ggmatrix(plots,
    nrow = Sample_Ba_patterns_ggpairs_internode$nrow,
    ncol = 6,
    xAxisLabels = "Ba/Ca",
    yAxisLabels = Sample_Ba_patterns_ggpairs_internode$yAxisLabels)
    
   assign(paste0("Sample_",Samples[c]," Ba/Ca vs TE Spearman cor [by internode]"), Sample_Ba_patterns_ggpairs_internode)
   rm(Sample_Ba_patterns_ggpairs_internode)
   
   Sample_Ba_patterns_ggpairs_internode <- ggpairs(Sample_element_patterns_data, columns = c(4,6,8,10,12,11), 
           aes(color = as.factor(Internode), pch = as.factor(Internode), fill = as.factor(Internode), linetype = as.factor(Internode)),
           legend = 1,
           lower = list(continuous = my_fn), 
           diag = list(continuous = wrap("densityDiag", alpha = 0.6)),
           upper = list(continuous = wrap("cor", method = "pearson", size = 4)),
           columnLabels = c("Li/Ca", "Mg/Ca", "S/Ca", "Sr/Ca", "U/Ca", "Ba/Ca"),
           labeller = "label_parsed") +
           scale_color_manual(values = c("red", "green",  "blue")) +
           scale_shape_manual(values = c(21,22,24), name = "Internode") +
           scale_linetype_manual(values = c(1,2,3), name = "Internode") +
           theme(legend.position = "bottom", axis.text.x.bottom = element_text(size = 9, angle = 45, vjust = 1, hjust=1),
                 strip.placement = "outside", text = element_text(size = 12), axis.text.y.left = element_blank(), axis.ticks.y.left = element_blank()) +
     labs(fill = "Internode", color = "Internode")
   

    Sample_Ba_patterns_ggpairs_internode[1,1] <- Sample_Ba_patterns_ggpairs_internode[1,1] + theme_classic()
    Sample_Ba_patterns_ggpairs_internode[2,2] <- Sample_Ba_patterns_ggpairs_internode[2,2] + theme_classic()
    Sample_Ba_patterns_ggpairs_internode[3,3] <- Sample_Ba_patterns_ggpairs_internode[3,3] + theme_classic()
    Sample_Ba_patterns_ggpairs_internode[4,4] <- Sample_Ba_patterns_ggpairs_internode[4,4] + theme_classic()
    Sample_Ba_patterns_ggpairs_internode[5,5] <- Sample_Ba_patterns_ggpairs_internode[5,5] + theme_classic()
    Sample_Ba_patterns_ggpairs_internode[6,6] <- Sample_Ba_patterns_ggpairs_internode[6,6] + theme_classic()
    
    plots <- lapply(1:Sample_Ba_patterns_ggpairs_internode$nrow, function(i) getPlot(Sample_Ba_patterns_ggpairs_internode, i = i, j = 6))
    
    Sample_Ba_patterns_ggpairs_internode <- ggmatrix(plots,
    nrow = Sample_Ba_patterns_ggpairs_internode$nrow,
    ncol = 6,
    xAxisLabels = "Ba/Ca",
    yAxisLabels = Sample_Ba_patterns_ggpairs_internode$yAxisLabels)
    
   assign(paste0("Sample_",Samples[c]," Ba/Ca vs TE Pearson cor [by internode]"), Sample_Ba_patterns_ggpairs_internode)
   rm(Sample_Ba_patterns_ggpairs_internode)
   
   my_fn <- function(data, mapping, ...){
      p <- ggplot(data = data, mapping = mapping) + 
        geom_point(show.legend = T, na.rm = T, alpha =0.4) +
  theme_classic()
      p
   }
   
   # All element ratios
      Sample_element_patterns_ggpairs <- ggpairs(Sample_element_patterns_data, columns = c(4:13), 
           title = paste0("Sample ",Samples[c], " element ratios  (µmol/mol)"),
           lower = list(continuous = my_fn), 
           upper = list(continuous = "blank")) +
        theme(axis.text.x.bottom = element_text(size = 6, angle = 45, vjust = 1, hjust=1))
  
    assign(paste0("Sample_",Samples[c]," element ratios"), Sample_element_patterns_ggpairs)
    rm(Sample_element_patterns_ggpairs)
  
    # Li, Mg, Sr, S and U
        Sample_Tempproxy_element_patterns_ggpairs <- ggpairs(Sample_element_patterns_data, columns = c(4,5,7,9,11,13), 
           title = paste0("Sample ",Samples[c], " element ratios  (µmol/mol)"),
           lower = list(continuous = my_fn), 
           upper = list(continuous = "blank")) +
        theme(axis.text.x.bottom = element_text(size = 6, angle = 45, vjust = 1, hjust=1))
  
    assign(paste0("Sample_",Samples[c]," Temp proxy element ratios"), Sample_Tempproxy_element_patterns_ggpairs)
    rm(Sample_Tempproxy_element_patterns_ggpairs)
  }

#Ratio vs ratio ####
`Sample_23_16 element ratios` # missing legend for geom_bins

ggsave(
  "Sample_23_16 element ratios.tiff",
  plot = `Sample_23_16 element ratios`,
  path = Ratios_folder_path,
  scale = 1,
  width = 20,
  height = 20,
  units = "cm",
  dpi = 300,
)

`Sample_23_16 Temp proxy element ratios` # missing legend for geom_bins

ggsave(
  "Sample_23_16 Temp proxy element ratios.tiff",
  plot = `Sample_23_16 Temp proxy element ratios`,
  path = Ratios_folder_path,
  scale = 1,
  width = 20,
  height = 20,
  units = "cm",
  dpi = 300,
)

`Sample_23_16 element ratios [by internode]` # missing legend for geom_bins

ggsave(
  "Sample_23_16 element ratios [by internode].tiff",
  plot = `Sample_23_16 element ratios [by internode]`,
  path = Ratios_folder_path,
  scale = 1,
  width = 20,
  height = 20,
  units = "cm",
  dpi = 300,
)

`Sample_23_16 Temp proxy element ratios [by internode]` # missing legend for geom_bins

ggsave(
  "Sample_23_16 Temp proxy element ratios [by internode].tiff",
  plot = `Sample_23_16 Temp proxy element ratios [by internode]`,
  path = Ratios_folder_path,
  scale = 1,
  width = 20,
  height = 20,
  units = "cm",
  dpi = 300,
)

`Sample_23_10 element ratios` # missing legend for geom_bins

ggsave(
  "Sample_23_10 element ratios.tiff",
  plot = `Sample_23_10 element ratios`,
  path = Ratios_folder_path,
  scale = 1,
  width = 20,
  height = 20,
  units = "cm",
  dpi = 300,
)

`Sample_23_10 Temp proxy element ratios` # missing legend for geom_bins

ggsave(
  "Sample_23_10 Temp proxy element ratios.tiff",
  plot = `Sample_23_10 Temp proxy element ratios`,
  path = Ratios_folder_path,
  scale = 1,
  width = 20,
  height = 20,
  units = "cm",
  dpi = 300,
)

`Sample_23_10 element ratios [by internode]` # missing legend for geom_bins

ggsave(
  "Sample_23_10 element ratios [by internode].tiff",
  plot = `Sample_23_10 element ratios [by internode]`,
  path = Ratios_folder_path,
  scale = 1,
  width = 20,
  height = 20,
  units = "cm",
  dpi = 300,
)

`Sample_23_10 Temp proxy element ratios [by internode]` # missing legend for geom_bins

ggsave(
  "Sample_23_10 Temp proxy element ratios [by internode].tiff",
  plot = `Sample_23_10 Temp proxy element ratios [by internode]`,
  path = Ratios_folder_path,
  scale = 1,
  width = 20,
  height = 20,
  units = "cm",
  dpi = 300,
)

`Sample_23_6 element ratios` # missing legend for geom_bins

ggsave(
  "Sample_23_6 element ratios.tiff",
  plot = `Sample_23_6 element ratios`,
  path = Ratios_folder_path,
  scale = 1,
  width = 20,
  height = 20,
  units = "cm",
  dpi = 300,
)

`Sample_23_6 Temp proxy element ratios` # missing legend for geom_bins

ggsave(
  "Sample_23_6 Temp proxy element ratios.tiff",
  plot = `Sample_23_6 Temp proxy element ratios`,
  path = Ratios_folder_path,
  scale = 1,
  width = 20,
  height = 20,
  units = "cm",
  dpi = 300,
)

`Sample_23_6 element ratios [by internode]` # missing legend for geom_bins

ggsave(
  "Sample_23_6 element ratios [by internode].tiff",
  plot = `Sample_23_6 element ratios [by internode]`,
  path = Ratios_folder_path,
  scale = 1,
  width = 20,
  height = 20,
  units = "cm",
  dpi = 300,
)

`Sample_23_6 Temp proxy element ratios [by internode]` # missing legend for geom_bins

ggsave(
  "Sample_23_6 Temp proxy element ratios [by internode].tiff",
  plot = `Sample_23_6 Temp proxy element ratios [by internode]`,
  path = Ratios_folder_path,
  scale = 1,
  width = 20,
  height = 20,
  units = "cm",
  dpi = 300,
)


`Sample_23_1 element ratios` # missing legend for geom_bins

ggsave(
  "Sample_23_1 element ratios.tiff",
  plot = `Sample_23_1 element ratios`,
  path = Ratios_folder_path,
  scale = 1,
  width = 20,
  height = 20,
  units = "cm",
  dpi = 300,
)

`Sample_23_1 Temp proxy element ratios` # missing legend for geom_bins

ggsave(
  "Sample_23_1 Temp proxy element ratios.tiff",
  plot = `Sample_23_1 Temp proxy element ratios`,
  path = Ratios_folder_path,
  scale = 1,
  width = 20,
  height = 20,
  units = "cm",
  dpi = 300,
)

`Sample_23_1 element ratios [by internode]` # missing legend for geom_bins

ggsave(
  "Sample_23_1 element ratios [by internode].tiff",
  plot = `Sample_23_1 element ratios [by internode]`,
  path = Ratios_folder_path,
  scale = 1,
  width = 20,
  height = 20,
  units = "cm",
  dpi = 300,
)

`Sample_23_1 Temp proxy element ratios [by internode]` # missing legend for geom_bins

ggsave(
  "Sample_23_1 Temp proxy element ratios [by internode].tiff",
  plot = `Sample_23_1 Temp proxy element ratios [by internode]`,
  path = Ratios_folder_path,
  scale = 1,
  width = 20,
  height = 20,
  units = "cm",
  dpi = 300,
)

`Sample_23_1 Ba/Ca vs TE Spearman cor [by internode]`

ggsave(
  "Sample_23_1 Barium v element ratios [spearman by internode].tiff",
  plot = `Sample_23_1 Ba/Ca vs TE Spearman cor [by internode]`,
  path = Ratios_folder_path,
  scale = 1,
  width = 5,
  height = 24,
  units = "cm",
  dpi = 300,
)

`Sample_23_1 Ba/Ca vs TE Pearson cor [by internode]`

ggsave(
  "Sample_23_1 Barium v element ratios [pearson by internode].tiff",
  plot = `Sample_23_1 Ba/Ca vs TE Pearson cor [by internode]`,
  path = Ratios_folder_path,
  scale = 1,
  width = 5,
  height = 24,
  units = "cm",
  dpi = 300,
)

`Sample_23_6 Ba/Ca vs TE Spearman cor [by internode]`

ggsave(
  "Sample_23_6 Barium v element ratios [spearman by internode].tiff",
  plot = `Sample_23_6 Ba/Ca vs TE Spearman cor [by internode]`,
  path = Ratios_folder_path,
  scale = 1,
  width = 5,
  height = 24,
  units = "cm",
  dpi = 300,
)

`Sample_23_6 Ba/Ca vs TE Pearson cor [by internode]`

ggsave(
  "Sample_23_6 Barium v element ratios [pearson by internode].tiff",
  plot = `Sample_23_6 Ba/Ca vs TE Pearson cor [by internode]`,
  path = Ratios_folder_path,
  scale = 1,
  width = 5,
  height = 24,
  units = "cm",
  dpi = 300,
)

`Sample_23_10 Ba/Ca vs TE Spearman cor [by internode]`

ggsave(
  "Sample_23_10 Barium v element ratios [spearman by internode].tiff",
  plot = `Sample_23_10 Ba/Ca vs TE Spearman cor [by internode]`,
  path = Ratios_folder_path,
  scale = 1,
  width = 5,
  height = 24,
  units = "cm",
  dpi = 300,
)

`Sample_23_10 Ba/Ca vs TE Pearson cor [by internode]`

ggsave(
  "Sample_23_10 Barium v element ratios [pearson by internode].tiff",
  plot = `Sample_23_10 Ba/Ca vs TE Pearson cor [by internode]`,
  path = Ratios_folder_path,
  scale = 1,
  width = 5,
  height = 24,
  units = "cm",
  dpi = 300,
)

`Sample_23_16 Ba/Ca vs TE Spearman cor [by internode]`

ggsave(
  "Sample_23_16 Barium v element ratios [spearman by internode].tiff",
  plot = `Sample_23_16 Ba/Ca vs TE Spearman cor [by internode]`,
  path = Ratios_folder_path,
  scale = 1,
  width = 5,
  height = 24,
  units = "cm",
  dpi = 300,
)

`Sample_23_16 Ba/Ca vs TE Pearson cor [by internode]`

ggsave(
  "Sample_23_16 Barium v element ratios [pearson by internode].tiff",
  plot = `Sample_23_16 Ba/Ca vs TE Pearson cor [by internode]`,
  path = Ratios_folder_path,
  scale = 1,
  width = 5,
  height = 24,
  units = "cm",
  dpi = 300,
)

```


```{r experimental code}

View(Sample_element_patterns_list)

Sample_element_patterns_list[["Sample_23_10 1 element_patterns_data"]] <- Sample_element_patterns_list[["Sample_23_10 1 element_patterns_data"]] %>% mutate_all(~ifelse(is.nan(.), NA, .))

## Thermometry data for QAnalyseries #####
i <- "23_6"
j <- 1
for(i in Samples) {
  for (j in 1:3) {
    
    thermometry_data <- Sample_element_patterns_list[[paste0("Sample_",i, " ",j, " element_patterns_data")]] %>%
      ungroup() %>%
      mutate_all(~ifelse(is.nan(.), NA, .)) %>%
      group_by(distance.um) %>% # calculate across all tracks
      summarise(Li_Ca = mean(Li_Ca, na.rm = T),
            Mg_Ca = mean(Mg_Ca, na.rm = T),
            Ba_Ca = mean(Ba_Ca, na.rm = T),
            S_Ca = mean(S_Ca, na.rm = T),
            Sr_Ca = mean(Sr_Ca, na.rm = T),
            U_Ca = mean(U_Ca, na.rm = T),
            Li_Mg = Li_Ca/(Mg_Ca/1000),
            Li_Mg_proxy = ((log(Li_Mg/0.522))/-0.0343),
            Mg_Ca_proxy = ((0.313*Mg_Ca/1000)-21.4),
            S_Ca_proxy = (3.79*S_Ca/1000) + 0.128,
            Sr_U = (Sr_Ca/1000) - (1.1107*U_Ca),
            Sr_Ca_proxy = (1.76*Sr_Ca/1000) + 0.553,
            Sr_U_proxy = (1.85*Sr_U) - 0.292)
    
    thermometry_mean <- thermometry_data %>%
      ungroup() %>%
      summarise(Li_Mg = mean(Li_Mg, na.rm = T),
                Mg_Ca = mean(Mg_Ca, na.rm = T),
                Ba_Ca = mean(Ba_Ca, na.rm = T),
                S_Ca = mean(S_Ca, na.rm = T),
                Sr_Ca = mean(Sr_Ca, na.rm = T),
                U_Ca = mean(U_Ca, na.rm = T),
                Li_Mg_proxy = mean(Li_Mg_proxy, na.rm = T),
                Mg_Ca_proxy = mean(Mg_Ca_proxy, na.rm = T),
                S_Ca_proxy = mean(S_Ca_proxy, na.rm = T),
                Sr_Ca_proxy = mean(Sr_Ca_proxy, na.rm = T),
                Sr_U_proxy = mean(Sr_U_proxy, na.rm = T))
    
    assign(paste0("Sample_",i, " ",j, " thermometry_data"), thermometry_data)
    assign(paste0("Sample_",i, " ",j, " thermometry_mean"), thermometry_mean)
    rm(thermometry_data)
    rm(thermometry_mean)
  }
}

`Sample_23_1 1 thermometry_data` %>%
  na.omit %>%
  dplyr::summarise(Distance = distance.um,
         Li_Ca, Mg_Ca, Sr_Ca, Ba_Ca, S_Ca, U_Ca, Li_Mg) %>%
  write_csv(., file = "Sample_23_1_1 TE_data.csv")

`Sample_23_1 2 thermometry_data` %>%
  na.omit %>%
  dplyr::summarise(Distance = distance.um,
         Li_Ca, Mg_Ca, Sr_Ca, Ba_Ca, S_Ca, U_Ca, Li_Mg) %>%
  write_csv(., file = "Sample_23_1_2 TE_data.csv")

`Sample_23_1 3 thermometry_data` %>%
  na.omit %>%
  dplyr::summarise(Distance = distance.um,
         Li_Ca, Mg_Ca, Sr_Ca, Ba_Ca, S_Ca, U_Ca, Li_Mg) %>%
  write_csv(., file = "Sample_23_1_3 TE_data.csv")

`Sample_23_10 1 thermometry_data` %>%
  na.omit %>%
  dplyr::summarise(Distance = distance.um,
         Li_Ca, Mg_Ca, Sr_Ca, Ba_Ca, S_Ca, U_Ca, Li_Mg) %>%
  write_csv(., file = "Sample_23_10_1 TE_data.csv")

`Sample_23_10 2 thermometry_data` %>%
  na.omit %>%
  dplyr::summarise(Distance = distance.um,
         Li_Ca, Mg_Ca, Sr_Ca, Ba_Ca, S_Ca, U_Ca, Li_Mg) %>%
  write_csv(., file = "Sample_23_10_2 TE_data.csv")

`Sample_23_10 3 thermometry_data` %>%
  na.omit %>%
  dplyr::summarise(Distance = distance.um,
         Li_Ca, Mg_Ca, Sr_Ca, Ba_Ca, S_Ca, U_Ca, Li_Mg) %>%
  write_csv(., file = "Sample_23_10_3 TE_data.csv")

`Sample_23_6 1 thermometry_data` %>%
  na.omit %>%
  dplyr::summarise(Distance = distance.um,
         Li_Ca, Mg_Ca, Sr_Ca, Ba_Ca, S_Ca, U_Ca, Li_Mg) %>%
  write_csv(., file = "Sample_23_6_1 TE_data.csv")

`Sample_23_6 2 thermometry_data` %>%
  na.omit %>%
  dplyr::summarise(Distance = distance.um,
         Li_Ca, Mg_Ca, Sr_Ca, Ba_Ca, S_Ca, U_Ca, Li_Mg) %>%
  write_csv(., file = "Sample_23_6_2 TE_data.csv")

`Sample_23_6 3 thermometry_data` %>%
  na.omit %>%
  dplyr::summarise(Distance = distance.um,
         Li_Ca, Mg_Ca, Sr_Ca, Ba_Ca, S_Ca, U_Ca, Li_Mg) %>%
  write_csv(., file = "Sample_23_6_3 TE_data.csv")

`Sample_23_16 1 thermometry_data` %>%
  na.omit %>%
  dplyr::summarise(Distance = distance.um,
         Li_Ca, Mg_Ca, Sr_Ca, Ba_Ca, S_Ca, U_Ca, Li_Mg) %>%
  write_csv(., file = "Sample_23_16_1 TE_data.csv")

`Sample_23_16 2 thermometry_data` %>%
  na.omit %>%
  dplyr::summarise(Distance = distance.um,
         Li_Ca, Mg_Ca, Sr_Ca, Ba_Ca, S_Ca, U_Ca, Li_Mg) %>%
  write_csv(., file = "Sample_23_16_2 TE_data.csv")

`Sample_23_16 3 thermometry_data` %>%
  na.omit %>%
  dplyr::summarise(Distance = distance.um,
         Li_Ca, Mg_Ca, Sr_Ca, Ba_Ca, S_Ca, U_Ca, Li_Mg) %>%
  write_csv(., file = "Sample_23_16_3 TE_data.csv")

# Thermometry plots ####

All_samples_thermometry_data <- dplyr::bind_rows(list(S_23_1=`Sample_23_1 1 thermometry_data`, S_23_6=`Sample_23_6 1 thermometry_data`, S_23_10=`Sample_23_10 1 thermometry_data`, S_23_16=`Sample_23_16 1 thermometry_data`), .id = 'Specimen')

# Adding the tuned internodes 
All_samples_thermometry_data <- All_samples_thermometry_data %>%
  mutate(Internode = 1)

Sample_23_1_2_tuned_data <- Sample_23_1_2_ages %>%
  dplyr::select(-old.depth) %>%
  mutate(Specimen = "S_23_1",
         Internode = 2)

Sample_23_1_3_tuned_data <- Sample_23_1_3_ages %>%
  dplyr::select(-old.depth) %>%
  mutate(Specimen = "S_23_1",
         Internode = 3)

Sample_23_6_2_tuned_data <- Sample_23_6_2_ages %>%
  dplyr::select(-old.depth) %>%
  mutate(Specimen = "S_23_6",
         Internode = 2)

Sample_23_6_3_tuned_data <- Sample_23_6_3_ages %>%
  dplyr::select(-old.depth) %>%
  mutate(Specimen = "S_23_6",
         Internode = 3)

Sample_23_10_2_tuned_data <- Sample_23_10_2_ages %>%
  dplyr::select(-old.depth) %>%
  mutate(Specimen = "S_23_10",
         Internode = 2)

Sample_23_10_3_tuned_data <- Sample_23_10_3_ages %>%
  dplyr::select(-old.depth) %>%
  mutate(Specimen = "S_23_10",
         Internode = 3)

Sample_23_16_2_tuned_data <- Sample_23_16_2_ages %>%
  dplyr::select(-old.depth) %>%
  mutate(Specimen = "S_23_16",
         Internode = 2)

Sample_23_16_3_tuned_data <- Sample_23_16_3_ages %>%
  dplyr::select(-old.depth) %>%
  mutate(Specimen = "S_23_16",
         Internode = 3)

All_samples_thermometry_data_V2 <- dplyr::full_join(All_samples_thermometry_data, Sample_23_1_2_tuned_data,
          by = c("distance.um" ="tuned.depth", "Specimen", "Internode", "Li_Ca", "Mg_Ca", "Ba_Ca", "S_Ca", "Sr_Ca", "U_Ca", "Li_Mg"))

All_samples_thermometry_data_V2 <- dplyr::full_join(All_samples_thermometry_data_V2, Sample_23_6_2_tuned_data, 
          by = c("distance.um" ="tuned.depth", "Specimen", "Internode", "Li_Ca", "Mg_Ca", "Ba_Ca", "S_Ca", "Sr_Ca", "U_Ca", "Li_Mg"))

All_samples_thermometry_data_V2 <- dplyr::full_join(All_samples_thermometry_data_V2, Sample_23_10_2_tuned_data, 
          by = c("distance.um" ="tuned.depth", "Specimen", "Internode", "Li_Ca", "Mg_Ca", "Ba_Ca", "S_Ca", "Sr_Ca", "U_Ca", "Li_Mg"))

All_samples_thermometry_data_V2 <- dplyr::full_join(All_samples_thermometry_data_V2, Sample_23_16_2_tuned_data, 
          by = c("distance.um" ="tuned.depth", "Specimen", "Internode", "Li_Ca", "Mg_Ca", "Ba_Ca", "S_Ca", "Sr_Ca", "U_Ca", "Li_Mg"))

All_samples_thermometry_data_V2 <- dplyr::full_join(All_samples_thermometry_data_V2, Sample_23_1_3_tuned_data,
          by = c("distance.um" ="tuned.depth", "Specimen", "Internode", "Li_Ca", "Mg_Ca", "Ba_Ca", "S_Ca", "Sr_Ca", "U_Ca", "Li_Mg"))

All_samples_thermometry_data_V2 <- dplyr::full_join(All_samples_thermometry_data_V2, Sample_23_6_3_tuned_data,
          by = c("distance.um" ="tuned.depth", "Specimen", "Internode", "Li_Ca", "Mg_Ca", "Ba_Ca", "S_Ca", "Sr_Ca", "U_Ca", "Li_Mg"))

All_samples_thermometry_data_V2 <- dplyr::full_join(All_samples_thermometry_data_V2, Sample_23_10_3_tuned_data,
          by = c("distance.um" ="tuned.depth", "Specimen", "Internode", "Li_Ca", "Mg_Ca", "Ba_Ca", "S_Ca", "Sr_Ca", "U_Ca", "Li_Mg"))

All_samples_thermometry_data_V2 <- dplyr::full_join(All_samples_thermometry_data_V2, Sample_23_16_3_tuned_data,
          by = c("distance.um" ="tuned.depth", "Specimen", "Internode", "Li_Ca", "Mg_Ca", "Ba_Ca", "S_Ca", "Sr_Ca", "U_Ca", "Li_Mg"))

All_samples_thermometry_data_V2 <- All_samples_thermometry_data_V2 %>%
  dplyr::select(-c(10:15))

# Interpolation ####
layout <- "
AAAABB
CCCCDD
EEEEFF
"
## Li/Mg ####
Li_Mg_thermometry_plot_uninterpolated <- All_samples_thermometry_data_V2 %>%
      group_by(distance.um, Specimen) %>% 
      summarise(Timepoint = 2021-(distance.um/51),
            Li_Mg = Li_Ca/(Mg_Ca/1000),
            Li_Mg_proxy = ((log(Li_Mg/0.63))/-0.050),
            Li_Mg_proxy_TJW = ((log(Li_Mg/0.521))/-0.0343)) %>%
      ggplot() +
      geom_path(aes(x = Timepoint, y = Li_Mg_proxy, col = Specimen), linetype = 3) + # Steward et al., 2020 Ear. Plan. Sci. Lett. for high-Mg octocorals
      geom_path(aes(x = Timepoint, y = Li_Mg_proxy_TJW, col = Specimen)) + # this study
geom_point(aes(x = 2018.6068, y =0.86), col = "orange") +
      geom_point(aes(x = 2017.5466, y =0.68), col = "orange") +
      geom_point(aes(x = 2016.5642, y =1.05), col = "orange") +
      geom_point(aes(x = 2021.5849, y = 1.1), col = "orange") +
      labs(y = expression("T"["[rec]"]*" (°C)"), x = "Timepoint (years)") +
      geom_hline(yintercept = 1.1, linetype = 2) +
      geom_hline(yintercept = 0.68, linetype = 2) +
      geom_label(aes(y = 30, x = 1990, label = "No interpolation")) +
      scale_x_continuous(limits = c(1960,2021), breaks = seq(1960,2020,5), sec.axis = sec_axis(~ -(. - 2021)*51, name = "Distance from coral wall (µm)")) +
      scale_y_continuous(limits = c(-5,45)) +
      theme_classic()

Li_Mg_thermometry_plot_uninterpolated_averages <- All_samples_thermometry_data_V2 %>%
      group_by(distance.um, Specimen) %>% 
      summarise(Timepoint = 2021-(distance.um/51),
            Li_Mg = Li_Ca/(Mg_Ca/1000),
            Li_Mg_proxy = ((log(Li_Mg/0.63))/-0.050),
            Li_Mg_proxy_TJW = ((log(Li_Mg/0.521))/-0.0343)) %>%
 filter(Timepoint >= 2000 & Timepoint <= 2021 & Li_Mg_proxy <= 45 & Li_Mg_proxy >= -5 & Li_Mg_proxy_TJW <= 45 & Li_Mg_proxy_TJW >= -5) %>%
  group_by(Specimen) %>%
  summarise(Samples = n(),
    Pub_mean = mean(Li_Mg_proxy, na.rm = T),
            Pub_sd = sd(Li_Mg_proxy, na.rm = T),
            Pub_se = sd(Li_Mg_proxy, na.rm = T)/sqrt(n()),
        TJW_mean = mean(Li_Mg_proxy_TJW, na.rm = T),
            TJW_sd = sd(Li_Mg_proxy_TJW, na.rm = T),
            TJW_se = sd(Li_Mg_proxy_TJW, na.rm = T)/sqrt(n())) %>%
  mutate(Pub_alpha = c(0.499,0.259,0.989,0.586),
         TJW_alpha = c(0.399,0.378,1.41,0.781)) %>%
  pivot_longer(cols = c(3:10), names_to = "Calculation", values_to = "value") %>%
  separate(col = "Calculation", "_", into = c("Calibration", "Calculation")) %>%
  pivot_wider(names_from = "Calculation", values_from = "value") %>%
      ggplot() +
          geom_hline(yintercept = 1.1, linetype = 2) +
      geom_hline(yintercept = 0.68, linetype = 2) +
  geom_vline(xintercept = 0, linetype = 2) +
    geom_errorbar(aes(x = alpha, ymin = mean-sd, ymax = mean+sd, linetype = Calibration), 
                width = 0.1) +
      geom_point(aes(x = alpha, y = mean, col = Specimen, fill = Calibration), 
                 pch = 21, size = 4, stroke = 2) +
  scale_fill_manual(values = c("white", "black")) +
  scale_linetype_manual(values = c(3,1)) +
      labs(y = expression("T"["[rec]"]*" (°C)"), x = expression("T"["[rec]"]*" trend (°C.yr"^"-1"*")")) +
      scale_y_continuous(limits = c(-5,45)) +
      scale_x_continuous(limits = c(-0.25,1.5)) +
      theme_classic()
    

Li_Mg_thermometry_plot_seasonal_interpolation <- All_samples_thermometry_data_V2 %>%
      group_by(distance.um, Specimen) %>% 
      summarise(Timepoint = 2021-(distance.um/51),
            Li_Mg = Li_Ca/(Mg_Ca/1000),
            Li_Mg_proxy = ((log(Li_Mg/0.63))/-0.050),
            Li_Mg_proxy_TJW = ((log(Li_Mg/0.521))/-0.0343)) %>%
  drop_na() %>%
  ungroup(distance.um) %>%
  group_by(Specimen) %>%
  summarise(
            Time = spline(Timepoint, Li_Mg_proxy_TJW, xout = seq(min(Timepoint),2021, by = 0.25))$x,
            Li_Mg_proxy_season_TJW = spline(Timepoint, Li_Mg_proxy_TJW, xout = seq(min(Timepoint),2021, by = 0.25))$y,
            Li_Mg_proxy_season = spline(Timepoint, Li_Mg_proxy, xout = seq(min(Timepoint),2021, by = 0.25))$y) %>% 
  ggplot() +
  geom_path(aes(Time, Li_Mg_proxy_season_TJW, group = Specimen, col = Specimen)) +
  geom_path(aes(Time, Li_Mg_proxy_season, group = Specimen, col = Specimen), linetype = 3) +
  geom_point(aes(x = 2018.6068, y =0.86), col = "orange") +
      geom_point(aes(x = 2017.5466, y =0.68), col = "orange") +
      geom_point(aes(x = 2016.5642, y =1.05), col = "orange") +
      geom_point(aes(x = 2021.5849, y = 1.1), col = "orange") +
      labs(y = expression("T"["[rec]"]*" (°C)"), x = "Timepoint (years)") +
      geom_hline(yintercept = 1.1, linetype = 2) +
      geom_hline(yintercept = 0.68, linetype = 2) +
      geom_label(aes(y = 30, x = 1990, label = "Seasonal interpolation (spline)")) +
      scale_x_continuous(limits = c(1960,2021), breaks = seq(1960,2020,5), sec.axis = sec_axis(~ -(. - 2021)*51, name = "Distance from coral wall (µm)")) +
      scale_y_continuous(limits = c(-5,45)) +
      theme_classic()

Li_Mg_thermometry_plot_seasonal_interpolation_averages <- All_samples_thermometry_data_V2 %>%
      group_by(distance.um, Specimen) %>% 
      summarise(Timepoint = 2021-(distance.um/51),
            Li_Mg = Li_Ca/(Mg_Ca/1000),
            Li_Mg_proxy = ((log(Li_Mg/0.63))/-0.050),
            Li_Mg_proxy_TJW = ((log(Li_Mg/0.521))/-0.0343)) %>%
  drop_na() %>%
  ungroup(distance.um) %>%
  group_by(Specimen) %>%
  summarise(
            Time = spline(Timepoint, Li_Mg_proxy_TJW, xout = seq(min(Timepoint),2021, by = 0.25))$x,
            Li_Mg_proxy_season_TJW = spline(Timepoint, Li_Mg_proxy_TJW, xout = seq(min(Timepoint),2021, by = 0.25))$y,
            Li_Mg_proxy_season = spline(Timepoint, Li_Mg_proxy, xout = seq(min(Timepoint),2021, by = 0.25))$y) %>% 
  filter(Time >= 2000 & Time <= 2021 & Li_Mg_proxy_season <= 45 & Li_Mg_proxy_season >= -5 & Li_Mg_proxy_season_TJW <= 45 & Li_Mg_proxy_season_TJW >= -5) %>%
  group_by(Specimen) %>%
  summarise(Samples = n(),
    Pub_mean = mean(Li_Mg_proxy_season, na.rm = T),
            Pub_sd = sd(Li_Mg_proxy_season, na.rm = T),
            Pub_se = sd(Li_Mg_proxy_season, na.rm = T)/sqrt(n()),
        TJW_mean = mean(Li_Mg_proxy_season_TJW, na.rm = T),
            TJW_sd = sd(Li_Mg_proxy_season_TJW, na.rm = T),
            TJW_se = sd(Li_Mg_proxy_season_TJW, na.rm = T)/sqrt(n())) %>%
  mutate(Pub_alpha = c(0.499,0.259,0.989,0.586),
         TJW_alpha = c(0.399,0.378,1.41,0.781)) %>%
  pivot_longer(cols = c(3:10), names_to = "Calculation", values_to = "value") %>%
  separate(col = "Calculation", "_", into = c("Calibration", "Calculation")) %>%
  pivot_wider(names_from = "Calculation", values_from = "value") %>%
      ggplot() +
          geom_hline(yintercept = 1.1, linetype = 2) +
      geom_hline(yintercept = 0.68, linetype = 2) +
  geom_vline(xintercept = 0, linetype = 2) +
    geom_errorbar(aes(x = alpha, ymin = mean-sd, ymax = mean+sd, linetype = Calibration), 
                width = 0.1) +
      geom_point(aes(x = alpha, y = mean, col = Specimen, fill = Calibration), 
                 pch = 21, size = 4, stroke = 2) +
  scale_fill_manual(values = c("white", "black")) +
  scale_linetype_manual(values = c(3,1)) +
      labs(y = expression("T"["[rec]"]*" (°C)"), x = expression("T"["[rec]"]*" trend (°C.yr"^"-1"*")")) +
      scale_y_continuous(limits = c(-5,45)) +
      scale_x_continuous(limits = c(-0.25,1.5)) +
      theme_classic()

Li_Mg_thermometry_plot_annual_interpolation <- All_samples_thermometry_data_V2 %>%
      group_by(distance.um, Specimen) %>% 
      summarise(Timepoint = 2021-(distance.um/51),
            Li_Mg = Li_Ca/(Mg_Ca/1000),
            Li_Mg_proxy = ((log(Li_Mg/0.63))/-0.050),
            Li_Mg_proxy_TJW = ((log(Li_Mg/0.521))/-0.0343)
            ) %>%
  drop_na() %>%
  ungroup(distance.um) %>%
  group_by(Specimen) %>%
  summarise(
            Time = spline(Timepoint, Li_Mg_proxy_TJW, xout = seq(min(Timepoint),2021, by = 1))$x,
            Li_Mg_proxy_season_TJW = spline(Timepoint, Li_Mg_proxy_TJW, xout = seq(min(Timepoint),2021, by = 1))$y,
            Li_Mg_proxy_season = spline(Timepoint, Li_Mg_proxy, xout = seq(min(Timepoint),2021, by = 1))$y) %>% 
  ggplot() +
  geom_path(aes(Time, Li_Mg_proxy_season, group = Specimen, col = Specimen), linetype = 3) +
      geom_path(aes(Time, Li_Mg_proxy_season_TJW, group = Specimen, col = Specimen)) +
      geom_point(aes(x = 2018.6068, y =0.86), col = "orange") +
      geom_point(aes(x = 2017.5466, y =0.68), col = "orange") +
      geom_point(aes(x = 2016.5642, y =1.05), col = "orange") +
      geom_point(aes(x = 2021.5849, y = 1.1), col = "orange") +
      labs(y = expression("T"["[rec]"]*" (°C)"), x = "Timepoint (years)") +
      geom_hline(yintercept = 1.1, linetype = 2) +
      geom_hline(yintercept = 0.68, linetype = 2) +
      geom_label(aes(y = 30, x = 1990, label = "Annual interpolation (spline)")) +
      scale_x_continuous(limits = c(1960,2021), breaks = seq(1960,2020,5), sec.axis = sec_axis(~ -(. - 2021)*51, name = "Distance from coral wall (µm)")) +
      scale_y_continuous(limits = c(-5,45)) +
      theme_classic()

Li_Mg_thermometry_plot_annual_interpolation_averages <- All_samples_thermometry_data_V2 %>%
      group_by(distance.um, Specimen) %>% 
      summarise(Timepoint = 2021-(distance.um/51),
            Li_Mg = Li_Ca/(Mg_Ca/1000),
            Li_Mg_proxy = ((log(Li_Mg/0.63))/-0.050),
            Li_Mg_proxy_TJW = ((log(Li_Mg/0.521))/-0.0343)
            ) %>%
  drop_na() %>%
  ungroup(distance.um) %>%
  group_by(Specimen) %>%
  summarise(
            Time = spline(Timepoint, Li_Mg_proxy_TJW, xout = seq(min(Timepoint),2021, by = 1))$x,
            Li_Mg_proxy_season_TJW = spline(Timepoint, Li_Mg_proxy_TJW, xout = seq(min(Timepoint),2021, by = 1))$y,
            Li_Mg_proxy_season = spline(Timepoint, Li_Mg_proxy, xout = seq(min(Timepoint),2021, by = 1))$y) %>% 
  filter(Time >= 2000 & Time <= 2021 & Li_Mg_proxy_season <= 45 & Li_Mg_proxy_season >= -5 & Li_Mg_proxy_season_TJW <= 45 & Li_Mg_proxy_season_TJW >= -5) %>%
  group_by(Specimen) %>%
  summarise(Samples = n(),
    Pub_mean = mean(Li_Mg_proxy_season, na.rm = T),
            Pub_sd = sd(Li_Mg_proxy_season, na.rm = T),
            Pub_se = sd(Li_Mg_proxy_season, na.rm = T)/sqrt(n()),
        TJW_mean = mean(Li_Mg_proxy_season_TJW, na.rm = T),
            TJW_sd = sd(Li_Mg_proxy_season_TJW, na.rm = T),
            TJW_se = sd(Li_Mg_proxy_season_TJW, na.rm = T)/sqrt(n())) %>%
  mutate(Pub_alpha = c(0.495,0.199,0.921,0.612),
         TJW_alpha = c(0.379,0.289,1.34,0.892)) %>%
  pivot_longer(cols = c(3:10), names_to = "Calculation", values_to = "value") %>%
  separate(col = "Calculation", "_", into = c("Calibration", "Calculation")) %>%
  pivot_wider(names_from = "Calculation", values_from = "value") %>%
      ggplot() +
          geom_hline(yintercept = 1.1, linetype = 2) +
      geom_hline(yintercept = 0.68, linetype = 2) +
  geom_vline(xintercept = 0, linetype = 2) +
    geom_errorbar(aes(x = alpha, ymin = mean-sd, ymax = mean+sd, linetype = Calibration), 
                width = 0.1) +
      geom_point(aes(x = alpha, y = mean, col = Specimen, fill = Calibration), 
                 pch = 21, size = 4, stroke = 2) +
  scale_fill_manual(values = c("white", "black")) +
  scale_linetype_manual(values = c(3,1)) +
      labs(y = expression("T"["[rec]"]*" (°C)"), x = expression("T"["[rec]"]*" trend (°C.yr"^"-1"*")")) +
      scale_y_continuous(limits = c(-5,45)) +
      scale_x_continuous(limits = c(-0.25,1.5)) +
      theme_classic()

Li_Mg_thermometry_plots <- Li_Mg_thermometry_plot_uninterpolated + theme(axis.title.x.bottom = element_blank(), axis.title.y = element_blank()) + 
  Li_Mg_thermometry_plot_uninterpolated_averages + theme(axis.title.x.bottom = element_blank(), axis.title.y = element_blank()) +
  Li_Mg_thermometry_plot_seasonal_interpolation  + theme(axis.title.x = element_blank()) +
  Li_Mg_thermometry_plot_seasonal_interpolation_averages  + theme(axis.title.x.bottom = element_blank(), axis.title.y = element_blank()) +
  Li_Mg_thermometry_plot_annual_interpolation + theme(axis.title.y = element_blank(), axis.title.x.top = element_blank()) +
  Li_Mg_thermometry_plot_annual_interpolation_averages + theme(axis.title.y = element_blank()) +
  plot_layout(design = layout, guides = "collect", )

### Remove coral edge and central axis - common timeframe is now 2003 to 2016 ####

Li_Mg_thermometry_plot_uninterpolated_constrained <- All_samples_thermometry_data_V2 %>%
      group_by(distance.um, Specimen) %>% 
      summarise(Timepoint = 2021-(distance.um/51),
            Li_Mg = Li_Ca/(Mg_Ca/1000),
            Li_Mg_proxy = ((log(Li_Mg/0.63))/-0.050),
            Li_Mg_proxy_TJW = ((log(Li_Mg/0.521))/-0.0343)) %>%
  ungroup() %>%
  filter(Specimen == "S_23_6" & Timepoint >= 1967 | Specimen == "S_23_1" & Timepoint >= 1999 |
           Specimen == "S_23_16" & Timepoint >= 2003 | Specimen == "S_23_10" & Timepoint >= 1996) %>%
      ggplot() +
      geom_path(aes(x = Timepoint, y = Li_Mg_proxy, col = Specimen), linetype = 3) + # Steward et al., 2020 Ear. Plan. Sci. Lett. for high-Mg octocorals
      geom_path(aes(x = Timepoint, y = Li_Mg_proxy_TJW, col = Specimen)) + # this study
geom_point(aes(x = 2018.6068, y =0.86), col = "orange") +
      geom_point(aes(x = 2017.5466, y =0.68), col = "orange") +
      geom_point(aes(x = 2016.5642, y =1.05), col = "orange") +
      geom_point(aes(x = 2021.5849, y = 1.1), col = "orange") +
      labs(y = expression("T"["[rec]"]*" (°C)"), x = "Timepoint (years)") +
      geom_hline(yintercept = 1.1, linetype = 2) +
      geom_hline(yintercept = 0.68, linetype = 2) +
      geom_label(aes(y = 30, x = 1990, label = "No interpolation")) +
      scale_x_continuous(limits = c(1960,2016), breaks = seq(1960,2020,5), sec.axis = sec_axis(~ -(. - 2021)*51, name = "Distance from coral wall (µm)")) +
      scale_y_continuous(limits = c(-5,45)) +
      theme_classic()

Li_Mg_thermometry_plot_uninterpolated_constrained_averages <- All_samples_thermometry_data_V2 %>%
      group_by(distance.um, Specimen) %>% 
      summarise(Timepoint = 2021-(distance.um/51),
            Li_Mg = Li_Ca/(Mg_Ca/1000),
            Li_Mg_proxy = ((log(Li_Mg/0.63))/-0.050),
            Li_Mg_proxy_TJW = ((log(Li_Mg/0.521))/-0.0343)) %>%
  ungroup() %>%
  filter(Specimen == "S_23_6" & Timepoint >= 1967 | Specimen == "S_23_1" & Timepoint >= 1999 |
           Specimen == "S_23_16" & Timepoint >= 2003 | Specimen == "S_23_10" & Timepoint >= 1996) %>%
  filter(Timepoint >= 2003 & Timepoint <= 2016 & Li_Mg_proxy <= 45 & Li_Mg_proxy >= -5 & Li_Mg_proxy_TJW <= 45 & Li_Mg_proxy_TJW >= -5) %>%
  group_by(Specimen) %>%
  summarise(Samples = n(),
    Pub_mean = mean(Li_Mg_proxy, na.rm = T),
            Pub_sd = sd(Li_Mg_proxy, na.rm = T),
            Pub_se = sd(Li_Mg_proxy, na.rm = T)/sqrt(n()),
        TJW_mean = mean(Li_Mg_proxy_TJW, na.rm = T),
            TJW_sd = sd(Li_Mg_proxy_TJW, na.rm = T),
            TJW_se = sd(Li_Mg_proxy_TJW, na.rm = T)/sqrt(n())) %>%
  mutate(Pub_alpha = c(-0.13,-0.06,0.3,0.345),
         TJW_alpha = c(-0.19,-0.09,0.437,0.502)) %>%
  pivot_longer(cols = c(3:10), names_to = "Calculation", values_to = "value") %>%
  separate(col = "Calculation", "_", into = c("Calibration", "Calculation")) %>%
  pivot_wider(names_from = "Calculation", values_from = "value") %>%
      ggplot() +
          geom_hline(yintercept = 1.1, linetype = 2) +
      geom_hline(yintercept = 0.68, linetype = 2) +
  geom_vline(xintercept = 0, linetype = 2) +
    geom_errorbar(aes(x = alpha, ymin = mean-sd, ymax = mean+sd, linetype = Calibration), 
                width = 0.1) +
      geom_point(aes(x = alpha, y = mean, col = Specimen, fill = Calibration), 
                 pch = 21, size = 4, stroke = 2) +
  scale_fill_manual(values = c("white", "black")) +
  scale_linetype_manual(values = c(3,1)) +
      labs(y = expression("T"["[rec]"]*" (°C)"), x = expression("T"["[rec]"]*" trend (°C.yr"^"-1"*")")) +
      scale_y_continuous(limits = c(-5,45)) +
      scale_x_continuous(limits = c(-0.25,0.75)) +
      theme_classic()

Li_Mg_thermometry_plot_seasonal_interpolation_constrained <- All_samples_thermometry_data_V2 %>%
      group_by(distance.um, Specimen) %>% 
      summarise(Timepoint = 2021-(distance.um/51),
            Li_Mg = Li_Ca/(Mg_Ca/1000),
            Li_Mg_proxy = ((log(Li_Mg/0.63))/-0.050),
            Li_Mg_proxy_TJW = ((log(Li_Mg/0.521))/-0.0343)) %>%
  drop_na() %>%
  ungroup() %>%
  filter(Specimen == "S_23_6" & Timepoint >= 1967 | Specimen == "S_23_1" & Timepoint >= 1999 |
           Specimen == "S_23_16" & Timepoint >= 2003 | Specimen == "S_23_10" & Timepoint >= 1996) %>%
  group_by(Specimen) %>%
  summarise(
            Time = spline(Timepoint, Li_Mg_proxy_TJW, xout = seq(min(Timepoint),2021, by = 0.25))$x,
            Li_Mg_proxy_season_TJW = spline(Timepoint, Li_Mg_proxy_TJW, xout = seq(min(Timepoint),2021, by = 0.25))$y,
            Li_Mg_proxy_season = spline(Timepoint, Li_Mg_proxy, xout = seq(min(Timepoint),2021, by = 0.25))$y) %>% 
  ggplot() +
  geom_path(aes(Time, Li_Mg_proxy_season_TJW, group = Specimen, col = Specimen)) +
  geom_path(aes(Time, Li_Mg_proxy_season, group = Specimen, col = Specimen), linetype = 3) +
  geom_point(aes(x = 2018.6068, y =0.86), col = "orange") +
      geom_point(aes(x = 2017.5466, y =0.68), col = "orange") +
      geom_point(aes(x = 2016.5642, y =1.05), col = "orange") +
      geom_point(aes(x = 2021.5849, y = 1.1), col = "orange") +
      labs(y = expression("T"["[rec]"]*" (°C)"), x = "Timepoint (years)") +
      geom_hline(yintercept = 1.1, linetype = 2) +
      geom_hline(yintercept = 0.68, linetype = 2) +
      geom_label(aes(y = 30, x = 1990, label = "Seasonal interpolation (spline)")) +
      scale_x_continuous(limits = c(1960,2016), breaks = seq(1960,2020,5), sec.axis = sec_axis(~ -(. - 2021)*51, name = "Distance from coral wall (µm)")) +
      scale_y_continuous(limits = c(-5,45)) +
      theme_classic()

Li_Mg_thermometry_plot_seasonal_interpolation_constrained_averages <- All_samples_thermometry_data_V2 %>%
      group_by(distance.um, Specimen) %>% 
      summarise(Timepoint = 2021-(distance.um/51),
            Li_Mg = Li_Ca/(Mg_Ca/1000),
            Li_Mg_proxy = ((log(Li_Mg/0.63))/-0.050),
            Li_Mg_proxy_TJW = ((log(Li_Mg/0.521))/-0.0343)) %>%
  drop_na() %>%
  ungroup() %>%
  filter(Specimen == "S_23_6" & Timepoint >= 1967 | Specimen == "S_23_1" & Timepoint >= 1999 |
           Specimen == "S_23_16" & Timepoint >= 2003 | Specimen == "S_23_10" & Timepoint >= 1996) %>%
  group_by(Specimen) %>%
  summarise(
            Time = spline(Timepoint, Li_Mg_proxy_TJW, xout = seq(min(Timepoint),2021, by = 0.25))$x,
            Li_Mg_proxy_season_TJW = spline(Timepoint, Li_Mg_proxy_TJW, xout = seq(min(Timepoint),2021, by = 0.25))$y,
            Li_Mg_proxy_season = spline(Timepoint, Li_Mg_proxy, xout = seq(min(Timepoint),2021, by = 0.25))$y) %>% 
  filter(Time >= 2003 & Time <= 2016 & Li_Mg_proxy_season <= 45 & Li_Mg_proxy_season >= -5 & Li_Mg_proxy_season_TJW <= 45 & Li_Mg_proxy_season_TJW >= -5) %>%
  group_by(Specimen) %>%
  summarise(Samples = n(),
    Pub_mean = mean(Li_Mg_proxy_season, na.rm = T),
            Pub_sd = sd(Li_Mg_proxy_season, na.rm = T),
            Pub_se = sd(Li_Mg_proxy_season, na.rm = T)/sqrt(n()),
        TJW_mean = mean(Li_Mg_proxy_season_TJW, na.rm = T),
            TJW_sd = sd(Li_Mg_proxy_season_TJW, na.rm = T),
            TJW_se = sd(Li_Mg_proxy_season_TJW, na.rm = T)/sqrt(n())) %>%
  mutate(Pub_alpha = c(-0.12,-0.06,0.281,0.342),
         TJW_alpha = c(-0.18, -0.09, 0.41, 0.498)) %>%
  pivot_longer(cols = c(3:10), names_to = "Calculation", values_to = "value") %>%
  separate(col = "Calculation", "_", into = c("Calibration", "Calculation")) %>%
  pivot_wider(names_from = "Calculation", values_from = "value") %>%
      ggplot() +
          geom_hline(yintercept = 1.1, linetype = 2) +
      geom_hline(yintercept = 0.68, linetype = 2) +
  geom_vline(xintercept = 0, linetype = 2) +
    geom_errorbar(aes(x = alpha, ymin = mean-sd, ymax = mean+sd, linetype = Calibration), 
                width = 0.1) +
      geom_point(aes(x = alpha, y = mean, col = Specimen, fill = Calibration), 
                 pch = 21, size = 4, stroke = 2) +
  scale_fill_manual(values = c("white", "black")) +
  scale_linetype_manual(values = c(3,1)) +
      labs(y = expression("T"["[rec]"]*" (°C)"), x = expression("T"["[rec]"]*" trend (°C.yr"^"-1"*")")) +
      scale_y_continuous(limits = c(-5,45)) +
      scale_x_continuous(limits = c(-0.25,0.75)) +
      theme_classic()

Li_Mg_thermometry_plot_annual_interpolation_constrained <- All_samples_thermometry_data_V2 %>%
      group_by(distance.um, Specimen) %>% 
      summarise(Timepoint = 2021-(distance.um/51),
            Li_Mg = Li_Ca/(Mg_Ca/1000),
            Li_Mg_proxy = ((log(Li_Mg/0.63))/-0.050),
            Li_Mg_proxy_TJW = ((log(Li_Mg/0.521))/-0.0343)
            ) %>%
  drop_na() %>%
  ungroup() %>%
  filter(Specimen == "S_23_6" & Timepoint >= 1967 | Specimen == "S_23_1" & Timepoint >= 1999 |
           Specimen == "S_23_16" & Timepoint >= 2003 | Specimen == "S_23_10" & Timepoint >= 1996) %>%
  group_by(Specimen) %>%
  summarise(
            Time = spline(Timepoint, Li_Mg_proxy_TJW, xout = seq(min(Timepoint),2021, by = 1))$x,
            Li_Mg_proxy_season_TJW = spline(Timepoint, Li_Mg_proxy_TJW, xout = seq(min(Timepoint),2021, by = 1))$y,
            Li_Mg_proxy_season = spline(Timepoint, Li_Mg_proxy, xout = seq(min(Timepoint),2021, by = 1))$y) %>% 
  ggplot() +
  geom_path(aes(Time, Li_Mg_proxy_season, group = Specimen, col = Specimen), linetype = 3) +
      geom_path(aes(Time, Li_Mg_proxy_season_TJW, group = Specimen, col = Specimen)) +
      geom_point(aes(x = 2018.6068, y =0.86), col = "orange") +
      geom_point(aes(x = 2017.5466, y =0.68), col = "orange") +
      geom_point(aes(x = 2016.5642, y =1.05), col = "orange") +
      geom_point(aes(x = 2021.5849, y = 1.1), col = "orange") +
      labs(y = expression("T"["[rec]"]*" (°C)"), x = "Timepoint (years)") +
      geom_hline(yintercept = 1.1, linetype = 2) +
      geom_hline(yintercept = 0.68, linetype = 2) +
      geom_label(aes(y = 30, x = 1990, label = "Annual interpolation (spline)")) +
      scale_x_continuous(limits = c(1960,2016), breaks = seq(1960,2020,5), sec.axis = sec_axis(~ -(. - 2021)*51, name = "Distance from coral wall (µm)")) +
      scale_y_continuous(limits = c(-5,45)) +
      theme_classic()

Li_Mg_thermometry_plot_annual_interpolation_constrained_averages <- All_samples_thermometry_data_V2 %>%
      group_by(distance.um, Specimen) %>% 
      summarise(Timepoint = 2021-(distance.um/51),
            Li_Mg = Li_Ca/(Mg_Ca/1000),
            Li_Mg_proxy = ((log(Li_Mg/0.63))/-0.050),
            Li_Mg_proxy_TJW = ((log(Li_Mg/0.521))/-0.0343)
            ) %>%
  drop_na() %>%
  ungroup() %>%
  filter(Specimen == "S_23_6" & Timepoint >= 1967 | Specimen == "S_23_1" & Timepoint >= 1999 |
           Specimen == "S_23_16" & Timepoint >= 2003 | Specimen == "S_23_10" & Timepoint >= 1996) %>%
  group_by(Specimen) %>%
  summarise(
            Time = spline(Timepoint, Li_Mg_proxy_TJW, xout = seq(min(Timepoint),2021, by = 1))$x,
            Li_Mg_proxy_season_TJW = spline(Timepoint, Li_Mg_proxy_TJW, xout = seq(min(Timepoint),2021, by = 1))$y,
            Li_Mg_proxy_season = spline(Timepoint, Li_Mg_proxy, xout = seq(min(Timepoint),2021, by = 1))$y) %>% 
  filter(Time >= 2003 & Time <= 2016 & Li_Mg_proxy_season <= 45 & Li_Mg_proxy_season >= -5 & Li_Mg_proxy_season_TJW <= 45 & Li_Mg_proxy_season_TJW >= -5) %>%
  group_by(Specimen) %>%
  summarise(Samples = n(),
    Pub_mean = mean(Li_Mg_proxy_season, na.rm = T),
            Pub_sd = sd(Li_Mg_proxy_season, na.rm = T),
            Pub_se = sd(Li_Mg_proxy_season, na.rm = T)/sqrt(n()),
        TJW_mean = mean(Li_Mg_proxy_season_TJW, na.rm = T),
            TJW_sd = sd(Li_Mg_proxy_season_TJW, na.rm = T),
            TJW_se = sd(Li_Mg_proxy_season_TJW, na.rm = T)/sqrt(n())) %>%
  mutate(Pub_alpha = c(-0.11,-0.07,0.28,0.362),
         TJW_alpha = c(-0.16, -0.11, 0.408, 0.527)) %>%
  pivot_longer(cols = c(3:10), names_to = "Calculation", values_to = "value") %>%
  separate(col = "Calculation", "_", into = c("Calibration", "Calculation")) %>%
  pivot_wider(names_from = "Calculation", values_from = "value") %>%
      ggplot() +
          geom_hline(yintercept = 1.1, linetype = 2) +
      geom_hline(yintercept = 0.68, linetype = 2) +
  geom_vline(xintercept = 0, linetype = 2) +
    geom_errorbar(aes(x = alpha, ymin = mean-sd, ymax = mean+sd, linetype = Calibration), 
                width = 0.1) +
      geom_point(aes(x = alpha, y = mean, col = Specimen, fill = Calibration), 
                 pch = 21, size = 4, stroke = 2) +
  scale_fill_manual(values = c("white", "black")) +
  scale_linetype_manual(values = c(3,1)) +
      labs(y = expression("T"["[rec]"]*" (°C)"), x = expression("T"["[rec]"]*" trend (°C.yr"^"-1"*")")) +
      scale_y_continuous(limits = c(-5,45)) +
      scale_x_continuous(limits = c(-0.25,0.75)) +
      theme_classic()

Li_Mg_thermometry_plots_constrained <- Li_Mg_thermometry_plot_uninterpolated_constrained + theme(axis.title.x.bottom = element_blank(), axis.title.y = element_blank()) + 
  Li_Mg_thermometry_plot_uninterpolated_constrained_averages + theme(axis.title.x.bottom = element_blank(), axis.title.y = element_blank()) +
  Li_Mg_thermometry_plot_seasonal_interpolation_constrained  + theme(axis.title.x = element_blank()) +
  Li_Mg_thermometry_plot_seasonal_interpolation_constrained_averages  + theme(axis.title.x.bottom = element_blank(), axis.title.y = element_blank()) +
  Li_Mg_thermometry_plot_annual_interpolation_constrained + theme(axis.title.y = element_blank(), axis.title.x.top = element_blank()) +
  Li_Mg_thermometry_plot_annual_interpolation_constrained_averages + theme(axis.title.y = element_blank()) +
  plot_layout(design = layout, guides = "collect")
    
## Mg ####
Mg_thermometry_plot_uninterpolated <- All_samples_thermometry_data_V2 %>%
      group_by(distance.um, Specimen, Internode) %>% 
      summarise(Timepoint = 2021-(distance.um/51),
            Mg_Ca_proxy = ((0.34*Mg_Ca/1000)-23.9),
            Mg_Ca_proxy_TJW = ((0.313*Mg_Ca/1000)-21.4)) %>%
      ggplot() +
      # geom_path(aes(x = Timepoint, y = Mg_Ca_proxy, col = Specimen), linetype = 3)+ # Thresher et al., 2016 - Geochim. et Cosmich. Acta
      geom_path(aes(x = Timepoint, y = Mg_Ca_proxy_TJW, col = Specimen, linetype = as.factor(Internode))) + # My calculated relationship
      geom_point(aes(x = 2018.6068, y =0.86), col = "orange") +
      geom_point(aes(x = 2017.5466, y =0.68), col = "orange") +
      geom_point(aes(x = 2016.5642, y =1.05), col = "orange") +
      geom_point(aes(x = 2021.5849, y = 1.1), col = "orange") +
      labs(y = expression("T"["[rec]"]*" (°C)"), x = "Timepoint (years)") +
      geom_hline(yintercept = 1.1, linetype = 2) +
      geom_hline(yintercept = 0.68, linetype = 2) +
      geom_label(aes(y = -2.5, x = 1990, label = "No interpolation")) +
      scale_x_continuous(limits = c(1960,2022), breaks = seq(1960,2020,5), sec.axis = sec_axis(~ -(. - 2021)*51, name = "Distance from coral wall (µm)")) +
      scale_y_continuous(limits = c(-5,10)) +
      facet_grid(rows = vars(Specimen)) +
      theme_classic()

Mg_thermometry_plot_uninterpolated_averages <- All_samples_thermometry_data_V2 %>%
      group_by(distance.um, Specimen) %>% 
      summarise(Timepoint = 2021-(distance.um/51),
            Mg_Ca_proxy = ((0.34*Mg_Ca/1000)-23.9),
            Mg_Ca_proxy_TJW = ((0.313*Mg_Ca/1000)-21.4)) %>%
filter(Timepoint >= 2000 & Timepoint <= 2021 & Mg_Ca_proxy <= 10 & Mg_Ca_proxy >= -5 & Mg_Ca_proxy_TJW <= 10 & Mg_Ca_proxy_TJW >= -5) %>%
  group_by(Specimen) %>%
  summarise(Samples = n(),
    Pub_mean = mean(Mg_Ca_proxy, na.rm = T),
            Pub_sd = sd(Mg_Ca_proxy, na.rm = T),
            Pub_se = sd(Mg_Ca_proxy, na.rm = T)/sqrt(n()),
        TJW_mean = mean(Mg_Ca_proxy_TJW, na.rm = T),
            TJW_sd = sd(Mg_Ca_proxy_TJW, na.rm = T),
            TJW_se = sd(Mg_Ca_proxy_TJW, na.rm = T)/sqrt(n())) %>%
  mutate(Pub_alpha = c(-0.06,-0.22,-0.15,-0.05),
         TJW_alpha = c(-0.06,-0.21,-0.15,-0.04)) %>%
  pivot_longer(cols = c(3:10), names_to = "Calculation", values_to = "value") %>%
  separate(col = "Calculation", "_", into = c("Calibration", "Calculation")) %>%
  pivot_wider(names_from = "Calculation", values_from = "value") %>%
      ggplot() +
          geom_hline(yintercept = 1.1, linetype = 2) +
      geom_hline(yintercept = 0.68, linetype = 2) +
  geom_vline(xintercept = 0, linetype = 2) +
    geom_errorbar(aes(x = alpha, ymin = mean-sd, ymax = mean+sd, linetype = Calibration), 
                width = 0.1) +
      geom_point(aes(x = alpha, y = mean, col = Specimen, fill = Calibration), 
                 pch = 21, size = 4, stroke = 2) +
  scale_fill_manual(values = c("white", "black")) +
  scale_linetype_manual(values = c(3,1)) +
      labs(y = expression("T"["[rec]"]*" (°C)"), x = expression("T"["[rec]"]*" trend (°C.yr"^"-1"*")")) +
       scale_y_continuous(limits = c(-5,10)) +
      scale_x_continuous(limits = c(-0.40,0.6)) +
      theme_classic()

Mg_thermometry_plot_seasonal_interpolation <- All_samples_thermometry_data_V2 %>%
      group_by(distance.um, Specimen) %>% 
      summarise(Timepoint = 2021-(distance.um/51),
            Mg_Ca_proxy = ((0.34*Mg_Ca/1000)-23.9),
            Mg_Ca_proxy_TJW = ((0.313*Mg_Ca/1000)-21.4)) %>%
  drop_na() %>%
  ungroup(distance.um) %>%
  group_by(Specimen) %>%
  summarise(
            Time = spline(Timepoint, Mg_Ca_proxy_TJW, xout = seq(min(Timepoint),2021, by = 0.25))$x,
            Mg_Ca_proxy_season_TJW = spline(Timepoint, Mg_Ca_proxy_TJW, xout = seq(min(Timepoint),2021, by = 0.25))$y,
            Mg_Ca_proxy_season = spline(Timepoint, Mg_Ca_proxy, xout = seq(min(Timepoint),2021, by = 0.25))$y) %>% 
  ggplot() +
  geom_path(aes(Time, Mg_Ca_proxy_season, group = Specimen, col = Specimen), linetype = 3) +
      geom_path(aes(Time, Mg_Ca_proxy_season_TJW, group = Specimen, col = Specimen)) +
      geom_point(aes(x = 2018.6068, y =0.86), col = "orange") +
      geom_point(aes(x = 2017.5466, y =0.68), col = "orange") +
      geom_point(aes(x = 2016.5642, y =1.05), col = "orange") +
      geom_point(aes(x = 2021.5849, y = 1.1), col = "orange") +
      labs(y = expression("T"["[rec]"]*" (°C)"), x = "Timepoint (years)") +
      geom_hline(yintercept = 1.1, linetype = 2) +
      geom_hline(yintercept = 0.68, linetype = 2) +
      geom_label(aes(y = -2.5, x = 1990, label = "Seasonal interpolation (spline)")) +
      scale_x_continuous(limits = c(1960,2022), breaks = seq(1960,2020,5), sec.axis = sec_axis(~ -(. - 2021)*51, name = "Distance from coral wall (µm)")) +
      scale_y_continuous(limits = c(-5,10)) +
      theme_classic()

Mg_thermometry_plot_seasonal_interpolation_averages <- All_samples_thermometry_data_V2 %>%
      group_by(distance.um, Specimen) %>% 
      summarise(Timepoint = 2021-(distance.um/51),
            Mg_Ca_proxy = ((0.34*Mg_Ca/1000)-23.9),
            Mg_Ca_proxy_TJW = ((0.313*Mg_Ca/1000)-21.4)) %>%
  drop_na() %>%
  ungroup(distance.um) %>%
  group_by(Specimen) %>%
  summarise(
            Time = spline(Timepoint, Mg_Ca_proxy_TJW, xout = seq(min(Timepoint),2021, by = 0.25))$x,
            Mg_Ca_proxy_season_TJW = spline(Timepoint, Mg_Ca_proxy_TJW, xout = seq(min(Timepoint),2021, by = 0.25))$y,
            Mg_Ca_proxy_season = spline(Timepoint, Mg_Ca_proxy, xout = seq(min(Timepoint),2021, by = 0.25))$y) %>% 
filter(Time >= 2000 & Time <= 2021 & Mg_Ca_proxy_season <= 10 & Mg_Ca_proxy_season >= -5 & Mg_Ca_proxy_season_TJW <= 10 & Mg_Ca_proxy_season_TJW >= -5) %>%
  group_by(Specimen) %>%
  summarise(Samples = n(),
    Pub_mean = mean(Mg_Ca_proxy_season, na.rm = T),
            Pub_sd = sd(Mg_Ca_proxy_season, na.rm = T),
            Pub_se = sd(Mg_Ca_proxy_season, na.rm = T)/sqrt(n()),
        TJW_mean = mean(Mg_Ca_proxy_season_TJW, na.rm = T),
            TJW_sd = sd(Mg_Ca_proxy_season_TJW, na.rm = T),
            TJW_se = sd(Mg_Ca_proxy_season_TJW, na.rm = T)/sqrt(n())) %>%
  mutate(Pub_alpha = c(-0.07,-0.22,-0.15,-0.04),
         TJW_alpha = c(-0.06,-0.2,-0.16,-0.04)) %>%
  pivot_longer(cols = c(3:10), names_to = "Calculation", values_to = "value") %>%
  separate(col = "Calculation", "_", into = c("Calibration", "Calculation")) %>%
  pivot_wider(names_from = "Calculation", values_from = "value") %>%
      ggplot() +
          geom_hline(yintercept = 1.1, linetype = 2) +
      geom_hline(yintercept = 0.68, linetype = 2) +
  geom_vline(xintercept = 0, linetype = 2) +
    geom_errorbar(aes(x = alpha, ymin = mean-sd, ymax = mean+sd, linetype = Calibration), 
                width = 0.1) +
      geom_point(aes(x = alpha, y = mean, col = Specimen, fill = Calibration), 
                 pch = 21, size = 4, stroke = 2) +
  scale_fill_manual(values = c("white", "black")) +
  scale_linetype_manual(values = c(3,1)) +
      labs(y = expression("T"["[rec]"]*" (°C)"), x = expression("T"["[rec]"]*" trend (°C.yr"^"-1"*")")) +
       scale_y_continuous(limits = c(-5,10)) +
      scale_x_continuous(limits = c(-0.40,0.6)) +
      theme_classic()

Mg_thermometry_plot_annual_interpolation <- All_samples_thermometry_data_V2 %>%
      group_by(distance.um, Specimen) %>% 
      summarise(Timepoint = 2021-(distance.um/51),
            Mg_Ca_proxy = ((0.34*Mg_Ca/1000)-23.9),
            Mg_Ca_proxy_TJW = ((0.313*Mg_Ca/1000)-21.4)) %>%
  drop_na() %>%
  ungroup(distance.um) %>%
  group_by(Specimen) %>%
  summarise(
            Time = spline(Timepoint, Mg_Ca_proxy_TJW, xout = seq(min(Timepoint),2021, by = 1))$x,
            Mg_Ca_proxy_season_TJW = spline(Timepoint, Mg_Ca_proxy_TJW, xout = seq(min(Timepoint),2021, by = 1))$y,
            Mg_Ca_proxy_season = spline(Timepoint, Mg_Ca_proxy, xout = seq(min(Timepoint),2021, by = 1))$y) %>% 
  ggplot() +
  geom_path(aes(Time, Mg_Ca_proxy_season, group = Specimen, col = Specimen), linetype = 3) +
      geom_path(aes(Time, Mg_Ca_proxy_season_TJW, group = Specimen, col = Specimen)) +
      geom_point(aes(x = 2018.6068, y =0.86), col = "orange") +
      geom_point(aes(x = 2017.5466, y =0.68), col = "orange") +
      geom_point(aes(x = 2016.5642, y =1.05), col = "orange") +
      geom_point(aes(x = 2021.5849, y = 1.1), col = "orange") +
      labs(y = expression("T"["[rec]"]*" (°C)"), x = "Timepoint (years)") +
      geom_hline(yintercept = 1.1, linetype = 2) +
      geom_hline(yintercept = 0.68, linetype = 2) +
      geom_label(aes(y = -2.5, x = 1990, label = "Annual interpolation (spline)")) +
      scale_x_continuous(limits = c(1960,2022), breaks = seq(1960,2020,5), sec.axis = sec_axis(~ -(. - 2021)*51, name = "Distance from coral wall (µm)")) +
      scale_y_continuous(limits = c(-5,10)) +
      theme_classic()

Mg_thermometry_plot_annual_interpolation_averages <- All_samples_thermometry_data_V2 %>%
      group_by(distance.um, Specimen) %>% 
      summarise(Timepoint = 2021-(distance.um/51),
            Mg_Ca_proxy = ((0.34*Mg_Ca/1000)-23.9),
            Mg_Ca_proxy_TJW = ((0.313*Mg_Ca/1000)-21.4)) %>%
  drop_na() %>%
  ungroup(distance.um) %>%
  group_by(Specimen) %>%
  summarise(
            Time = spline(Timepoint, Mg_Ca_proxy_TJW, xout = seq(min(Timepoint),2021, by = 1))$x,
            Mg_Ca_proxy_season_TJW = spline(Timepoint, Mg_Ca_proxy_TJW, xout = seq(min(Timepoint),2021, by = 1))$y,
            Mg_Ca_proxy_season = spline(Timepoint, Mg_Ca_proxy, xout = seq(min(Timepoint),2021, by = 1))$y) %>% 
  filter(Time >= 2000 & Time <= 2021 & Mg_Ca_proxy_season <= 10 & Mg_Ca_proxy_season >= -5 & Mg_Ca_proxy_season_TJW <= 10 & Mg_Ca_proxy_season_TJW >= -5) %>%
  group_by(Specimen) %>%
  summarise(Samples = n(),
    Pub_mean = mean(Mg_Ca_proxy_season, na.rm = T),
            Pub_sd = sd(Mg_Ca_proxy_season, na.rm = T),
            Pub_se = sd(Mg_Ca_proxy_season, na.rm = T)/sqrt(n()),
        TJW_mean = mean(Mg_Ca_proxy_season_TJW, na.rm = T),
            TJW_sd = sd(Mg_Ca_proxy_season_TJW, na.rm = T),
            TJW_se = sd(Mg_Ca_proxy_season_TJW, na.rm = T)/sqrt(n())) %>%
  mutate(Pub_alpha = c(-0.09,-0.27,-0.17,-0.06),
         TJW_alpha = c(-0.08,-0.25,-0.16,-0.05)) %>%
  pivot_longer(cols = c(3:10), names_to = "Calculation", values_to = "value") %>%
  separate(col = "Calculation", "_", into = c("Calibration", "Calculation")) %>%
  pivot_wider(names_from = "Calculation", values_from = "value") %>%
      ggplot() +
          geom_hline(yintercept = 1.1, linetype = 2) +
      geom_hline(yintercept = 0.68, linetype = 2) +
  geom_vline(xintercept = 0, linetype = 2) +
    geom_errorbar(aes(x = alpha, ymin = mean-sd, ymax = mean+sd, linetype = Calibration), 
                width = 0.1) +
      geom_point(aes(x = alpha, y = mean, col = Specimen, fill = Calibration), 
                 pch = 21, size = 4, stroke = 2) +
  scale_fill_manual(values = c("white", "black")) +
  scale_linetype_manual(values = c(3,1)) +
      labs(y = expression("T"["[rec]"]*" (°C)"), x = expression("T"["[rec]"]*" trend (°C.yr"^"-1"*")")) +
       scale_y_continuous(limits = c(-5,10)) +
      scale_x_continuous(limits = c(-0.40,0.6)) +
      theme_classic()


Mg_thermometry_plots <- Mg_thermometry_plot_uninterpolated + theme(axis.title.x.bottom = element_blank(), axis.title.y = element_blank()) + 
  Mg_thermometry_plot_uninterpolated_averages + theme(axis.title.x.bottom = element_blank(), axis.title.y = element_blank()) +
  Mg_thermometry_plot_seasonal_interpolation  + theme(axis.title.x = element_blank()) +
  Mg_thermometry_plot_seasonal_interpolation_averages  + theme(axis.title.x.bottom = element_blank(), axis.title.y = element_blank()) +
  Mg_thermometry_plot_annual_interpolation + theme(axis.title.y = element_blank(), axis.title.x.top = element_blank()) +
  Mg_thermometry_plot_annual_interpolation_averages + theme(axis.title.y = element_blank()) +
  plot_layout(design = layout, guides = "collect", )

### Remove coral edge and central axis - common timeframe is now 2003 to 2016 ####
Mg_thermometry_plot_uninterpolated_constrained <- All_samples_thermometry_data_V2 %>%
      group_by(distance.um, Specimen) %>% 
      summarise(Timepoint = 2021-(distance.um/51),
            Mg_Ca_proxy = ((0.34*Mg_Ca/1000)-23.9),
            Mg_Ca_proxy_TJW = ((0.313*Mg_Ca/1000)-21.4)) %>%
    ungroup() %>%
  filter(Specimen == "S_23_6" & Timepoint >= 1967 | Specimen == "S_23_1" & Timepoint >= 1998 |
           Specimen == "S_23_16" & Timepoint >= 2001 | Specimen == "S_23_10" & Timepoint >= 1995) %>%
      ggplot() +
      geom_path(aes(x = Timepoint, y = Mg_Ca_proxy, col = Specimen), linetype = 3)+ # Thresher et al., 2016 - Geochim. et Cosmich. Acta
      geom_path(aes(x = Timepoint, y = Mg_Ca_proxy_TJW, col = Specimen)) + # My calculated relationship
      geom_point(aes(x = 2018.6068, y =0.86), col = "orange") +
      geom_point(aes(x = 2017.5466, y =0.68), col = "orange") +
      geom_point(aes(x = 2016.5642, y =1.05), col = "orange") +
      geom_point(aes(x = 2021.5849, y = 1.1), col = "orange") +
      labs(y = expression("T"["[rec]"]*" (°C)"), x = "Timepoint (years)") +
      geom_hline(yintercept = 1.1, linetype = 2) +
      geom_hline(yintercept = 0.68, linetype = 2) +
      geom_label(aes(y = -2.5, x = 1990, label = "No interpolation")) +
      scale_x_continuous(limits = c(1960,2016), breaks = seq(1960,2020,5), sec.axis = sec_axis(~ -(. - 2021)*51, name = "Distance from coral wall (µm)")) +
      scale_y_continuous(limits = c(-5,10)) +
      theme_classic()

Mg_thermometry_plot_uninterpolated_constrained_averages <- All_samples_thermometry_data_V2 %>%
      group_by(distance.um, Specimen) %>% 
      summarise(Timepoint = 2021-(distance.um/51),
            Mg_Ca_proxy = ((0.34*Mg_Ca/1000)-23.9),
            Mg_Ca_proxy_TJW = ((0.313*Mg_Ca/1000)-21.4)) %>%
    ungroup() %>%
  filter(Specimen == "S_23_6" & Timepoint >= 1967 | Specimen == "S_23_1" & Timepoint >= 1998 |
           Specimen == "S_23_16" & Timepoint >= 2001 | Specimen == "S_23_10" & Timepoint >= 1995) %>%
filter(Timepoint >= 2003 & Timepoint <= 2016 & Mg_Ca_proxy <= 10 & Mg_Ca_proxy >= -5 & Mg_Ca_proxy_TJW <= 10 & Mg_Ca_proxy_TJW >= -5) %>%
  group_by(Specimen) %>%
  summarise(Samples = n(),
    Pub_mean = mean(Mg_Ca_proxy, na.rm = T),
            Pub_sd = sd(Mg_Ca_proxy, na.rm = T),
            Pub_se = sd(Mg_Ca_proxy, na.rm = T)/sqrt(n()),
        TJW_mean = mean(Mg_Ca_proxy_TJW, na.rm = T),
            TJW_sd = sd(Mg_Ca_proxy_TJW, na.rm = T),
            TJW_se = sd(Mg_Ca_proxy_TJW, na.rm = T)/sqrt(n())) %>%
  mutate(Pub_alpha = c(-0.03,-0.17,-0.02,-0.00253),
         TJW_alpha = c(-0.02,-0.16,-0.02,-0.00233)) %>%
  pivot_longer(cols = c(3:10), names_to = "Calculation", values_to = "value") %>%
  separate(col = "Calculation", "_", into = c("Calibration", "Calculation")) %>%
  pivot_wider(names_from = "Calculation", values_from = "value") %>%
      ggplot() +
          geom_hline(yintercept = 1.1, linetype = 2) +
      geom_hline(yintercept = 0.68, linetype = 2) +
  geom_vline(xintercept = 0, linetype = 2) +
    geom_errorbar(aes(x = alpha, ymin = mean-sd, ymax = mean+sd, linetype = Calibration), 
                width = 0.1) +
      geom_point(aes(x = alpha, y = mean, col = Specimen, fill = Calibration), 
                 pch = 21, size = 4, stroke = 2) +
  scale_fill_manual(values = c("white", "black")) +
  scale_linetype_manual(values = c(3,1)) +
      labs(y = expression("T"["[rec]"]*" (°C)"), x = expression("T"["[rec]"]*" trend (°C.yr"^"-1"*")")) +
       scale_y_continuous(limits = c(-5,10)) +
      scale_x_continuous(limits = c(-0.40,0.6)) +
      theme_classic()

Mg_thermometry_plot_seasonal_interpolation_constrained <- All_samples_thermometry_data_V2 %>%
      group_by(distance.um, Specimen) %>% 
      summarise(Timepoint = 2021-(distance.um/51),
            Mg_Ca_proxy = ((0.34*Mg_Ca/1000)-23.9),
            Mg_Ca_proxy_TJW = ((0.313*Mg_Ca/1000)-21.4)) %>%
  drop_na() %>%
    ungroup() %>%
  filter(Specimen == "S_23_6" & Timepoint >= 1967 | Specimen == "S_23_1" & Timepoint >= 1998 |
           Specimen == "S_23_16" & Timepoint >= 2001 | Specimen == "S_23_10" & Timepoint >= 1995) %>%
  group_by(Specimen) %>%
  summarise(
            Time = spline(Timepoint, Mg_Ca_proxy_TJW, xout = seq(min(Timepoint),2021, by = 0.25))$x,
            Mg_Ca_proxy_season_TJW = spline(Timepoint, Mg_Ca_proxy_TJW, xout = seq(min(Timepoint),2021, by = 0.25))$y,
            Mg_Ca_proxy_season = spline(Timepoint, Mg_Ca_proxy, xout = seq(min(Timepoint),2021, by = 0.25))$y) %>% 
  ggplot() +
  geom_path(aes(Time, Mg_Ca_proxy_season, group = Specimen, col = Specimen), linetype = 3) +
      geom_path(aes(Time, Mg_Ca_proxy_season_TJW, group = Specimen, col = Specimen)) +
      geom_point(aes(x = 2018.6068, y =0.86), col = "orange") +
      geom_point(aes(x = 2017.5466, y =0.68), col = "orange") +
      geom_point(aes(x = 2016.5642, y =1.05), col = "orange") +
      geom_point(aes(x = 2021.5849, y = 1.1), col = "orange") +
      labs(y = expression("T"["[rec]"]*" (°C)"), x = "Timepoint (years)") +
      geom_hline(yintercept = 1.1, linetype = 2) +
      geom_hline(yintercept = 0.68, linetype = 2) +
      geom_label(aes(y = -2.5, x = 1990, label = "Seasonal interpolation (spline)")) +
      scale_x_continuous(limits = c(1960,2016), breaks = seq(1960,2020,5), sec.axis = sec_axis(~ -(. - 2021)*51, name = "Distance from coral wall (µm)")) +
      scale_y_continuous(limits = c(-5,10)) +
      theme_classic()

Mg_thermometry_plot_seasonal_interpolation_constrained_averages <- All_samples_thermometry_data_V2 %>%
      group_by(distance.um, Specimen) %>% 
      summarise(Timepoint = 2021-(distance.um/51),
            Mg_Ca_proxy = ((0.34*Mg_Ca/1000)-23.9),
            Mg_Ca_proxy_TJW = ((0.313*Mg_Ca/1000)-21.4)) %>%
  drop_na() %>%
    ungroup() %>%
  filter(Specimen == "S_23_6" & Timepoint >= 1967 | Specimen == "S_23_1" & Timepoint >= 1998 |
           Specimen == "S_23_16" & Timepoint >= 2001 | Specimen == "S_23_10" & Timepoint >= 1995) %>%
  group_by(Specimen) %>%
  summarise(
            Time = spline(Timepoint, Mg_Ca_proxy_TJW, xout = seq(min(Timepoint),2021, by = 0.25))$x,
            Mg_Ca_proxy_season_TJW = spline(Timepoint, Mg_Ca_proxy_TJW, xout = seq(min(Timepoint),2021, by = 0.25))$y,
            Mg_Ca_proxy_season = spline(Timepoint, Mg_Ca_proxy, xout = seq(min(Timepoint),2021, by = 0.25))$y) %>% 
filter(Time >= 2003 & Time <= 2016 & Mg_Ca_proxy_season <= 10 & Mg_Ca_proxy_season >= -5 & Mg_Ca_proxy_season_TJW <= 10 & Mg_Ca_proxy_season_TJW >= -5) %>%
  group_by(Specimen) %>%
  summarise(Samples = n(),
    Pub_mean = mean(Mg_Ca_proxy_season, na.rm = T),
            Pub_sd = sd(Mg_Ca_proxy_season, na.rm = T),
            Pub_se = sd(Mg_Ca_proxy_season, na.rm = T)/sqrt(n()),
        TJW_mean = mean(Mg_Ca_proxy_season_TJW, na.rm = T),
            TJW_sd = sd(Mg_Ca_proxy_season_TJW, na.rm = T),
            TJW_se = sd(Mg_Ca_proxy_season_TJW, na.rm = T)/sqrt(n())) %>%
  mutate(Pub_alpha = c(-0.02,-0.17,-0.02,-0.00158),
         TJW_alpha = c(-0.02,-0.16,-0.02,-0.00146)) %>%
  pivot_longer(cols = c(3:10), names_to = "Calculation", values_to = "value") %>%
  separate(col = "Calculation", "_", into = c("Calibration", "Calculation")) %>%
  pivot_wider(names_from = "Calculation", values_from = "value") %>%
      ggplot() +
          geom_hline(yintercept = 1.1, linetype = 2) +
      geom_hline(yintercept = 0.68, linetype = 2) +
  geom_vline(xintercept = 0, linetype = 2) +
    geom_errorbar(aes(x = alpha, ymin = mean-sd, ymax = mean+sd, linetype = Calibration), 
                width = 0.1) +
      geom_point(aes(x = alpha, y = mean, col = Specimen, fill = Calibration), 
                 pch = 21, size = 4, stroke = 2) +
  scale_fill_manual(values = c("white", "black")) +
  scale_linetype_manual(values = c(3,1)) +
      labs(y = expression("T"["[rec]"]*" (°C)"), x = expression("T"["[rec]"]*" trend (°C.yr"^"-1"*")")) +
       scale_y_continuous(limits = c(-5,10)) +
      scale_x_continuous(limits = c(-0.40,0.6)) +
      theme_classic()

Mg_thermometry_plot_annual_interpolation_constrained <- All_samples_thermometry_data_V2 %>%
      group_by(distance.um, Specimen) %>% 
      summarise(Timepoint = 2021-(distance.um/51),
            Mg_Ca_proxy = ((0.34*Mg_Ca/1000)-23.9),
            Mg_Ca_proxy_TJW = ((0.313*Mg_Ca/1000)-21.4)) %>%
  drop_na() %>%
    ungroup() %>%
  filter(Specimen == "S_23_6" & Timepoint >= 1967 | Specimen == "S_23_1" & Timepoint >= 1998 |
           Specimen == "S_23_16" & Timepoint >= 2001 | Specimen == "S_23_10" & Timepoint >= 1995) %>%
  group_by(Specimen) %>%
  summarise(
            Time = spline(Timepoint, Mg_Ca_proxy_TJW, xout = seq(min(Timepoint),2021, by = 1))$x,
            Mg_Ca_proxy_season_TJW = spline(Timepoint, Mg_Ca_proxy_TJW, xout = seq(min(Timepoint),2021, by = 1))$y,
            Mg_Ca_proxy_season = spline(Timepoint, Mg_Ca_proxy, xout = seq(min(Timepoint),2021, by = 1))$y) %>% 
  ggplot() +
  geom_path(aes(Time, Mg_Ca_proxy_season, group = Specimen, col = Specimen), linetype = 3) +
      geom_path(aes(Time, Mg_Ca_proxy_season_TJW, group = Specimen, col = Specimen)) +
      geom_point(aes(x = 2018.6068, y =0.86), col = "orange") +
      geom_point(aes(x = 2017.5466, y =0.68), col = "orange") +
      geom_point(aes(x = 2016.5642, y =1.05), col = "orange") +
      geom_point(aes(x = 2021.5849, y = 1.1), col = "orange") +
      labs(y = expression("T"["[rec]"]*" (°C)"), x = "Timepoint (years)") +
      geom_hline(yintercept = 1.1, linetype = 2) +
      geom_hline(yintercept = 0.68, linetype = 2) +
      geom_label(aes(y = -2.5, x = 1990, label = "Annual interpolation (spline)")) +
      scale_x_continuous(limits = c(1960,2016), breaks = seq(1960,2020,5), sec.axis = sec_axis(~ -(. - 2021)*51, name = "Distance from coral wall (µm)")) +
      scale_y_continuous(limits = c(-5,10)) +
      theme_classic()

Mg_thermometry_plot_annual_interpolation_constrained_averages <- All_samples_thermometry_data_V2 %>%
      group_by(distance.um, Specimen) %>% 
      summarise(Timepoint = 2021-(distance.um/51),
            Mg_Ca_proxy = ((0.34*Mg_Ca/1000)-23.9),
            Mg_Ca_proxy_TJW = ((0.313*Mg_Ca/1000)-21.4)) %>%
  drop_na() %>%
    ungroup() %>%
  filter(Specimen == "S_23_6" & Timepoint >= 1967 | Specimen == "S_23_1" & Timepoint >= 1998 |
           Specimen == "S_23_16" & Timepoint >= 2001 | Specimen == "S_23_10" & Timepoint >= 1995) %>%
  group_by(Specimen) %>%
  summarise(
            Time = spline(Timepoint, Mg_Ca_proxy_TJW, xout = seq(min(Timepoint),2021, by = 1))$x,
            Mg_Ca_proxy_season_TJW = spline(Timepoint, Mg_Ca_proxy_TJW, xout = seq(min(Timepoint),2021, by = 1))$y,
            Mg_Ca_proxy_season = spline(Timepoint, Mg_Ca_proxy, xout = seq(min(Timepoint),2021, by = 1))$y) %>% 
  filter(Time >= 2003 & Time <= 2016 & Mg_Ca_proxy_season <= 10 & Mg_Ca_proxy_season >= -5 & Mg_Ca_proxy_season_TJW <= 10 & Mg_Ca_proxy_season_TJW >= -5) %>%
  group_by(Specimen) %>%
  summarise(Samples = n(),
    Pub_mean = mean(Mg_Ca_proxy_season, na.rm = T),
            Pub_sd = sd(Mg_Ca_proxy_season, na.rm = T),
            Pub_se = sd(Mg_Ca_proxy_season, na.rm = T)/sqrt(n()),
        TJW_mean = mean(Mg_Ca_proxy_season_TJW, na.rm = T),
            TJW_sd = sd(Mg_Ca_proxy_season_TJW, na.rm = T),
            TJW_se = sd(Mg_Ca_proxy_season_TJW, na.rm = T)/sqrt(n())) %>%
  mutate(Pub_alpha = c(-0.02,-0.17,-0.03,0.006),
         TJW_alpha = c(-0.02,-0.16,-0.02,0.006)) %>%
  pivot_longer(cols = c(3:10), names_to = "Calculation", values_to = "value") %>%
  separate(col = "Calculation", "_", into = c("Calibration", "Calculation")) %>%
  pivot_wider(names_from = "Calculation", values_from = "value") %>%
      ggplot() +
          geom_hline(yintercept = 1.1, linetype = 2) +
      geom_hline(yintercept = 0.68, linetype = 2) +
  geom_vline(xintercept = 0, linetype = 2) +
    geom_errorbar(aes(x = alpha, ymin = mean-sd, ymax = mean+sd, linetype = Calibration), 
                width = 0.1) +
      geom_point(aes(x = alpha, y = mean, col = Specimen, fill = Calibration), 
                 pch = 21, size = 4, stroke = 2) +
  scale_fill_manual(values = c("white", "black")) +
  scale_linetype_manual(values = c(3,1)) +
      labs(y = expression("T"["[rec]"]*" (°C)"), x = expression("T"["[rec]"]*" trend (°C.yr"^"-1"*")")) +
       scale_y_continuous(limits = c(-5,10)) +
      scale_x_continuous(limits = c(-0.40,0.6)) +
      theme_classic()


Mg_thermometry_plots_constrained <- Mg_thermometry_plot_uninterpolated_constrained + theme(axis.title.x.bottom = element_blank(), axis.title.y = element_blank()) + 
  Mg_thermometry_plot_uninterpolated_constrained_averages + theme(axis.title.x.bottom = element_blank(), axis.title.y = element_blank()) +
  Mg_thermometry_plot_seasonal_interpolation_constrained  + theme(axis.title.x = element_blank()) +
  Mg_thermometry_plot_seasonal_interpolation_constrained_averages  + theme(axis.title.x.bottom = element_blank(), axis.title.y = element_blank()) +
  Mg_thermometry_plot_annual_interpolation_constrained + theme(axis.title.y = element_blank(), axis.title.x.top = element_blank()) +
  Mg_thermometry_plot_annual_interpolation_constrained_averages + theme(axis.title.y = element_blank()) +
  plot_layout(design = layout, guides = "collect", )

## S ####

S_thermometry_plot_uninterpolated <- All_samples_thermometry_data_V2 %>%
      group_by(distance.um, Specimen) %>% 
      summarise(Timepoint = 2021-(distance.um/51),
            S_Ca_proxy = ((-0.3*S_Ca/1000)+7.52),
            S_Ca_proxy_TJW = ((0.128*S_Ca/1000)+3.79)) %>%
      ggplot() +
      geom_path(aes(x = Timepoint, y = S_Ca_proxy, col = Specimen), linetype = 3)+ # Thresher et al., 2016 - Geochim. et Cosmich. Acta
      geom_path(aes(x = Timepoint, y = S_Ca_proxy_TJW, col = Specimen)) + # My calculated relationship
      geom_point(aes(x = 2018.6068, y =0.86), col = "orange") +
      geom_point(aes(x = 2017.5466, y =0.68), col = "orange") +
      geom_point(aes(x = 2016.5642, y =1.05), col = "orange") +
      geom_point(aes(x = 2021.5849, y = 1.1), col = "orange") +
      labs(y = expression("T"["[rec]"]*" (°C)"), x = "Timepoint (years)") +
      geom_hline(yintercept = 1.1, linetype = 2) +
      geom_hline(yintercept = 0.68, linetype = 2) +
      geom_label(aes(y = 8, x = 1990, label = "No interpolation")) +
      scale_x_continuous(limits = c(1960,2022), breaks = seq(1960,2020,5), sec.axis = sec_axis(~ -(. - 2021)*51, name = "Distance from coral wall (µm)")) +
      scale_y_continuous(limits = c(0,7)) +
      theme_classic()

S_thermometry_plot_seasonal_interpolation <- All_samples_thermometry_data_V2 %>%
      group_by(distance.um, Specimen) %>% 
      summarise(Timepoint = 2021-(distance.um/51),
            S_Ca_proxy = ((-0.3*S_Ca/1000)+7.52),
            S_Ca_proxy_TJW = ((0.128*S_Ca/1000)+3.79)) %>%
  drop_na() %>%
  ungroup(distance.um) %>%
  group_by(Specimen) %>%
  summarise(
            Time = spline(Timepoint, S_Ca_proxy_TJW, xout = seq(min(Timepoint),2021, by = 0.25))$x,
            S_Ca_proxy_season_TJW = spline(Timepoint, S_Ca_proxy_TJW, xout = seq(min(Timepoint),2021, by = 0.25))$y,
            S_Ca_proxy_season = spline(Timepoint, S_Ca_proxy, xout = seq(min(Timepoint),2021, by = 0.25))$y) %>% 
  ggplot() +
  geom_path(aes(Time, S_Ca_proxy_season, group = Specimen, col = Specimen), linetype = 3) +
      geom_path(aes(Time, S_Ca_proxy_season_TJW, group = Specimen, col = Specimen)) +
      geom_point(aes(x = 2018.6068, y =0.86), col = "orange") +
      geom_point(aes(x = 2017.5466, y =0.68), col = "orange") +
      geom_point(aes(x = 2016.5642, y =1.05), col = "orange") +
      geom_point(aes(x = 2021.5849, y = 1.1), col = "orange") +
      labs(y = expression("T"["[rec]"]*" (°C)"), x = "Timepoint (years)") +
      geom_hline(yintercept = 1.1, linetype = 2) +
      geom_hline(yintercept = 0.68, linetype = 2) +
      geom_label(aes(y = 8, x = 1990, label = "Seasonal interpolation (spline)")) +
      scale_x_continuous(limits = c(1960,2022), breaks = seq(1960,2020,5), sec.axis = sec_axis(~ -(. - 2021)*51, name = "Distance from coral wall (µm)")) +
      scale_y_continuous(limits = c(0,7)) +
      theme_classic()

data <- All_samples_thermometry_data_V2 %>%
      group_by(distance.um, Specimen) %>% 
      summarise(Timepoint = 2021-(distance.um/51),
            S_Ca_proxy = ((-0.3*S_Ca/1000)+7.52),
            S_Ca_proxy_TJW = ((0.128*S_Ca/1000)+3.79)) %>%
  drop_na() %>%
  ungroup(distance.um) %>%
  group_by(Specimen) %>%
  summarise(
            Time = spline(Timepoint, S_Ca_proxy_TJW, xout = seq(min(Timepoint),2021, by = 1))$x,
            S_Ca_proxy_season_TJW = spline(Timepoint, S_Ca_proxy_TJW, xout = seq(min(Timepoint),2021, by = 1))$y,
            S_Ca_proxy_season = spline(Timepoint, S_Ca_proxy, xout = seq(min(Timepoint),2021, by = 1))$y)

S_thermometry_plot_annual_interpolation <- All_samples_thermometry_data_V2 %>%
      group_by(distance.um, Specimen) %>% 
      summarise(Timepoint = 2021-(distance.um/51),
            S_Ca_proxy = ((-0.3*S_Ca/1000)+7.52),
            S_Ca_proxy_TJW = ((0.128*S_Ca/1000)+3.79)) %>%
  drop_na() %>%
  ungroup(distance.um) %>%
  group_by(Specimen) %>%
  summarise(
            Time = spline(Timepoint, S_Ca_proxy_TJW, xout = seq(min(Timepoint),2021, by = 1))$x,
            S_Ca_proxy_season_TJW = spline(Timepoint, S_Ca_proxy_TJW, xout = seq(min(Timepoint),2021, by = 1))$y,
            S_Ca_proxy_season = spline(Timepoint, S_Ca_proxy, xout = seq(min(Timepoint),2021, by = 1))$y) %>% 
  ggplot() +
  geom_path(aes(Time, S_Ca_proxy_season, group = Specimen, col = Specimen), linetype = 3) +
      geom_path(aes(Time, S_Ca_proxy_season_TJW, group = Specimen, col = Specimen)) +
      geom_point(aes(x = 2018.6068, y =0.86), col = "orange") +
      geom_point(aes(x = 2017.5466, y =0.68), col = "orange") +
      geom_point(aes(x = 2016.5642, y =1.05), col = "orange") +
      geom_point(aes(x = 2021.5849, y = 1.1), col = "orange") +
      labs(y = expression("T"["[rec]"]*" (°C)"), x = "Timepoint (years)") +
      geom_hline(yintercept = 1.1, linetype = 2) +
      geom_hline(yintercept = 0.68, linetype = 2) +
      geom_label(aes(y = 8, x = 1990, label = "Annual interpolation (spline)")) +
      scale_x_continuous(limits = c(1960,2022), breaks = seq(1960,2020,5), sec.axis = sec_axis(~ -(. - 2021)*51, name = "Distance from coral wall (µm)")) +
      scale_y_continuous(limits = c(0,7)) +
      theme_classic()


S_thermometry_plots <- S_thermometry_plot_uninterpolated + theme(axis.title.x.bottom = element_blank(), axis.title.y = element_blank()) +
  S_thermometry_plot_seasonal_interpolation  + theme(axis.title.x = element_blank()) +
  S_thermometry_plot_annual_interpolation + theme(axis.title.y = element_blank(), axis.title.x.top = element_blank()) +
  plot_layout(nrow = 3, guides = "collect")


## Sr ####
Sr_thermometry_plot_uninterpolated <- All_samples_thermometry_data_V2 %>%
      group_by(distance.um, Specimen) %>% 
      summarise(Timepoint = 2021-(distance.um/51),
            Sr_Ca_proxy = ((3.1367*Sr_Ca/1000)-2.06),
            Sr_Ca_proxy_TJW = ((4.39*Sr_Ca/1000)-7.87)) %>%
      ggplot() +
      geom_path(aes(x = Timepoint, y = Sr_Ca_proxy, col = Specimen), linetype = 3)+ # Thresher et al., 2016 - Geochim. et Cosmich. Acta
      geom_path(aes(x = Timepoint, y = Sr_Ca_proxy_TJW, col = Specimen)) + # My calculated relationship
      geom_point(aes(x = 2018.6068, y =0.86), col = "orange") +
      geom_point(aes(x = 2017.5466, y =0.68), col = "orange") +
      geom_point(aes(x = 2016.5642, y =1.05), col = "orange") +
      geom_point(aes(x = 2021.5849, y = 1.1), col = "orange") +
      labs(y = expression("T"["[rec]"]*" (°C)"), x = "Timepoint (years)") +
      geom_hline(yintercept = 1.1, linetype = 2) +
      geom_hline(yintercept = 0.68, linetype = 2) +
      geom_label(aes(y = 9, x = 1990, label = "No interpolation")) +
      scale_x_continuous(limits = c(1960,2022), breaks = seq(1960,2020,5), sec.axis = sec_axis(~ -(. - 2021)*51, name = "Distance from coral wall (µm)")) +
      scale_y_continuous(limits = c(0,8)) +
      theme_classic()


Sr_thermometry_plot_seasonal_interpolation <- All_samples_thermometry_data_V2 %>%
      group_by(distance.um, Specimen) %>% 
      summarise(Timepoint = 2021-(distance.um/51),
            Sr_Ca_proxy = ((3.1367*Sr_Ca/1000)-2.06),
            Sr_Ca_proxy_TJW = ((4.39*Sr_Ca/1000)-7.87)) %>%
  drop_na() %>%
  ungroup(distance.um) %>%
  group_by(Specimen) %>%
  summarise(
            Time = spline(Timepoint, Sr_Ca_proxy_TJW, xout = seq(min(Timepoint),2021, by = 0.25))$x,
            Sr_Ca_proxy_season_TJW = spline(Timepoint, Sr_Ca_proxy_TJW, xout = seq(min(Timepoint),2021, by = 0.25))$y,
            Sr_Ca_proxy_season = spline(Timepoint, Sr_Ca_proxy, xout = seq(min(Timepoint),2021, by = 0.25))$y) %>% 
  ggplot() +
  geom_path(aes(Time, Sr_Ca_proxy_season, group = Specimen, col = Specimen), linetype = 3) +
      geom_path(aes(Time, Sr_Ca_proxy_season_TJW, group = Specimen, col = Specimen)) +
      geom_point(aes(x = 2018.6068, y =0.86), col = "orange") +
      geom_point(aes(x = 2017.5466, y =0.68), col = "orange") +
      geom_point(aes(x = 2016.5642, y =1.05), col = "orange") +
      geom_point(aes(x = 2021.5849, y = 1.1), col = "orange") +
      labs(y = expression("T"["[rec]"]*" (°C)"), x = "Timepoint (years)") +
      geom_hline(yintercept = 1.1, linetype = 2) +
      geom_hline(yintercept = 0.68, linetype = 2) +
      geom_label(aes(y = 9, x = 1990, label = "Seasonal interpolation (spline)")) +
      scale_x_continuous(limits = c(1960,2022), breaks = seq(1960,2020,5), sec.axis = sec_axis(~ -(. - 2021)*51, name = "Distance from coral wall (µm)")) +
      scale_y_continuous(limits = c(0,8)) +
      theme_classic()

Sr_thermometry_plot_annual_interpolation <- All_samples_thermometry_data_V2 %>%
      group_by(distance.um, Specimen) %>% 
      summarise(Timepoint = 2021-(distance.um/51),
            Sr_Ca_proxy = ((3.1367*Sr_Ca/1000)-2.06),
            Sr_Ca_proxy_TJW = ((4.39*Sr_Ca/1000)-7.87)) %>%
  drop_na() %>%
  ungroup(distance.um) %>%
  group_by(Specimen) %>%
  summarise(
            Time = spline(Timepoint, Sr_Ca_proxy_TJW, xout = seq(min(Timepoint),2021, by = 1))$x,
            Sr_Ca_proxy_season_TJW = spline(Timepoint, Sr_Ca_proxy_TJW, xout = seq(min(Timepoint),2021, by = 1))$y,
            Sr_Ca_proxy_season = spline(Timepoint, Sr_Ca_proxy, xout = seq(min(Timepoint),2021, by = 1))$y) %>% 
  ggplot() +
  geom_path(aes(Time, Sr_Ca_proxy_season, group = Specimen, col = Specimen), linetype = 3) +
      geom_path(aes(Time, Sr_Ca_proxy_season_TJW, group = Specimen, col = Specimen)) +
      geom_point(aes(x = 2018.6068, y =0.86), col = "orange") +
      geom_point(aes(x = 2017.5466, y =0.68), col = "orange") +
      geom_point(aes(x = 2016.5642, y =1.05), col = "orange") +
      geom_point(aes(x = 2021.5849, y = 1.1), col = "orange") +
      labs(y = expression("T"["[rec]"]*" (°C)"), x = "Timepoint (years)") +
      geom_hline(yintercept = 1.1, linetype = 2) +
      geom_hline(yintercept = 0.68, linetype = 2) +
      geom_label(aes(y = 9, x = 1990, label = "Annual interpolation (spline)")) +
      scale_x_continuous(limits = c(1960,2022), breaks = seq(1960,2020,5), sec.axis = sec_axis(~ -(. - 2021)*51, name = "Distance from coral wall (µm)")) +
      scale_y_continuous(limits = c(0,8)) +
      theme_classic()


Sr_thermometry_plots <- Sr_thermometry_plot_uninterpolated + theme(axis.title.x.bottom = element_blank(), axis.title.y = element_blank()) +
  Sr_thermometry_plot_seasonal_interpolation  + theme(axis.title.x = element_blank()) +
  Sr_thermometry_plot_annual_interpolation + theme(axis.title.y = element_blank(), axis.title.x.top = element_blank()) +
  plot_layout(nrow = 3, guides = "collect")

## U ####
U_thermometry_plot_uninterpolated <- All_samples_thermometry_data_V2 %>%
      group_by(distance.um, Specimen) %>% 
      summarise(Timepoint = 2021-(distance.um/51),
            U_Ca_proxy = ((-0.3*U_Ca/1000)+7.52),
            U_Ca_proxy_TJW = (((3.36*10^5)*U_Ca/1000)+0.978)) %>%
      ggplot() +
      geom_path(aes(x = Timepoint, y = U_Ca_proxy, col = Specimen), linetype = 3)+ # Thresher et al., 2016 - Geochim. et Cosmich. Acta
      geom_path(aes(x = Timepoint, y = U_Ca_proxy_TJW, col = Specimen)) + # My calculated relationship
      geom_point(aes(x = 2018.6068, y =0.86), col = "orange") +
      geom_point(aes(x = 2017.5466, y =0.68), col = "orange") +
      geom_point(aes(x = 2016.5642, y =1.05), col = "orange") +
      geom_point(aes(x = 2021.5849, y = 1.1), col = "orange") +
      labs(y = expression("T"["[rec]"]*" (°C)"), x = "Timepoint (years)") +
      geom_hline(yintercept = 1.1, linetype = 2) +
      geom_hline(yintercept = 0.68, linetype = 2) +
      geom_label(aes(y = 2.5, x = 1990, label = "No interpolation")) +
      scale_x_continuous(limits = c(1960,2022), breaks = seq(1960,2020,5), sec.axis = sec_axis(~ -(. - 2021)*51, name = "Distance from coral wall (µm)")) +
      scale_y_continuous(limits = c(0,10)) +
      theme_classic()

U_thermometry_plot_uninterpolated_averages <- All_samples_thermometry_data_V2 %>%
      group_by(distance.um, Specimen) %>% 
      summarise(Timepoint = 2021-(distance.um/51),
            U_Ca_proxy = ((-0.3*U_Ca/1000)+7.52),
            U_Ca_proxy_TJW = (((3.36*10^5)*U_Ca/1000)+0.978)) %>%
filter(Timepoint >= 2000 & Timepoint <= 2021 & U_Ca_proxy <= 10 & U_Ca_proxy >= 0 & U_Ca_proxy_TJW <= 10 & U_Ca_proxy_TJW >= 0) %>%
  group_by(Specimen) %>%
  summarise(Samples = n(),
    Pub_mean = mean(U_Ca_proxy, na.rm = T),
            Pub_sd = sd(U_Ca_proxy, na.rm = T),
            Pub_se = sd(U_Ca_proxy, na.rm = T)/sqrt(n()),
        TJW_mean = mean(U_Ca_proxy_TJW, na.rm = T),
            TJW_sd = sd(U_Ca_proxy_TJW, na.rm = T),
            TJW_se = sd(U_Ca_proxy_TJW, na.rm = T)/sqrt(n())) %>%
  mutate(Pub_alpha = c(-0.06,-0.22,-0.15,-0.05),
         TJW_alpha = c(-0.06,-0.21,-0.15,-0.04)) %>%
  pivot_longer(cols = c(3:10), names_to = "Calculation", values_to = "value") %>%
  separate(col = "Calculation", "_", into = c("Calibration", "Calculation")) %>%
  pivot_wider(names_from = "Calculation", values_from = "value") %>%
      ggplot() +
          geom_hline(yintercept = 1.1, linetype = 2) +
      geom_hline(yintercept = 0.68, linetype = 2) +
  geom_vline(xintercept = 0, linetype = 2) +
    geom_errorbar(aes(x = alpha, ymin = mean-sd, ymax = mean+sd, linetype = Calibration), 
                width = 0.1) +
      geom_point(aes(x = alpha, y = mean, col = Specimen, fill = Calibration), 
                 pch = 21, size = 4, stroke = 2) +
  scale_fill_manual(values = c("white", "black")) +
  scale_linetype_manual(values = c(3,1)) +
      labs(y = expression("T"["[rec]"]*" (°C)"), x = expression("T"["[rec]"]*" trend (°C.yr"^"-1"*")")) +
       scale_y_continuous(limits = c(0,10)) +
      scale_x_continuous(limits = c(-0.40,0.6)) +
      theme_classic()



U_thermometry_plot_seasonal_interpolation <- All_samples_thermometry_data_V2 %>%
      group_by(distance.um, Specimen) %>% 
      summarise(Timepoint = 2021-(distance.um/51),
            U_Ca_proxy = ((-0.3*U_Ca/1000)+7.52),
            U_Ca_proxy_TJW = (((3.36*10^5)*U_Ca/1000)+0.978)) %>%
  drop_na() %>%
  ungroup(distance.um) %>%
  group_by(Specimen) %>%
  summarise(
            Time = spline(Timepoint, U_Ca_proxy_TJW, xout = seq(min(Timepoint),2021, by = 0.25))$x,
            U_Ca_proxy_season_TJW = spline(Timepoint, U_Ca_proxy_TJW, xout = seq(min(Timepoint),2021, by = 0.25))$y,
            U_Ca_proxy_season = spline(Timepoint, U_Ca_proxy, xout = seq(min(Timepoint),2021, by = 0.25))$y) %>% 
  ggplot() +
  geom_path(aes(Time, U_Ca_proxy_season, group = Specimen, col = Specimen), linetype = 3) +
      geom_path(aes(Time, U_Ca_proxy_season_TJW, group = Specimen, col = Specimen)) +
      geom_point(aes(x = 2018.6068, y =0.86), col = "orange") +
      geom_point(aes(x = 2017.5466, y =0.68), col = "orange") +
      geom_point(aes(x = 2016.5642, y =1.05), col = "orange") +
      geom_point(aes(x = 2021.5849, y = 1.1), col = "orange") +
      labs(y = expression("T"["[rec]"]*" (°C)"), x = "Timepoint (years)") +
      geom_hline(yintercept = 1.1, linetype = 2) +
      geom_hline(yintercept = 0.68, linetype = 2) +
      geom_label(aes(y = 2.5, x = 1990, label = "Seasonal interpolation (spline)")) +
      scale_x_continuous(limits = c(1960,2022), breaks = seq(1960,2020,5), sec.axis = sec_axis(~ -(. - 2021)*51, name = "Distance from coral wall (µm)")) +
      scale_y_continuous(limits = c(0,10)) +
      theme_classic()

U_thermometry_plot_annual_interpolation <- All_samples_thermometry_data_V2 %>%
      group_by(distance.um, Specimen) %>% 
      summarise(Timepoint = 2021-(distance.um/51),
            U_Ca_proxy = ((-0.3*U_Ca/1000)+7.52),
            U_Ca_proxy_TJW = (((3.36*10^5)*U_Ca/1000)+0.978)) %>%
  drop_na() %>%
  ungroup(distance.um) %>%
  group_by(Specimen) %>%
  summarise(
            Time = spline(Timepoint, U_Ca_proxy_TJW, xout = seq(min(Timepoint),2021, by = 1))$x,
            U_Ca_proxy_season_TJW = spline(Timepoint, U_Ca_proxy_TJW, xout = seq(min(Timepoint),2021, by = 1))$y,
            U_Ca_proxy_season = spline(Timepoint, U_Ca_proxy, xout = seq(min(Timepoint),2021, by = 1))$y) %>% 
  ggplot() +
  geom_path(aes(Time, U_Ca_proxy_season, group = Specimen, col = Specimen), linetype = 3) +
      geom_path(aes(Time, U_Ca_proxy_season_TJW, group = Specimen, col = Specimen)) +
      geom_point(aes(x = 2018.6068, y =0.86), col = "orange") +
      geom_point(aes(x = 2017.5466, y =0.68), col = "orange") +
      geom_point(aes(x = 2016.5642, y =1.05), col = "orange") +
      geom_point(aes(x = 2021.5849, y = 1.1), col = "orange") +
      labs(y = expression("T"["[rec]"]*" (°C)"), x = "Timepoint (years)") +
      geom_hline(yintercept = 1.1, linetype = 2) +
      geom_hline(yintercept = 0.68, linetype = 2) +
      geom_label(aes(y = 2.5, x = 1990, label = "Annual interpolation (spline)")) +
      scale_x_continuous(limits = c(1960,2022), breaks = seq(1960,2020,5), sec.axis = sec_axis(~ -(. - 2021)*51, name = "Distance from coral wall (µm)")) +
      scale_y_continuous(limits = c(0,10)) +
      theme_classic()


U_thermometry_plots <- U_thermometry_plot_uninterpolated + theme(axis.title.x.bottom = element_blank(), axis.title.y = element_blank()) +
  U_thermometry_plot_seasonal_interpolation  + theme(axis.title.x = element_blank()) +
  U_thermometry_plot_annual_interpolation + theme(axis.title.y = element_blank(), axis.title.x.top = element_blank()) +
  plot_layout(nrow = 3, guides = "collect")

# TREND SCRIPT
#    ggpmisc::stat_poly_eq(data = data[which(data$Time >=2000),], method = "rlm", label.x = 0.1, label.y = c(0.95, 0.9,0.85,0.8),
                        # aes(x = Time, y = U_Ca_proxy_season_TJW, col = Specimen,
                        #     label = paste(after_stat(eq.label), after_stat(rr.label), sep = "*\", \"*"))) 
  
## Saving files ####
Thermometry_folder_path <- "~/OneDrive - University of Southampton/PhD, INSPIRE DTP/Countries_Chapters/UK [Soton]/Chpt4 Bamboo Coral Analysis/LAICPMS/Data_R_processed/NIST612_Corrected_Thermometry"

ggsave(
  "Li_Mg_thermometry.tiff",
  plot = `Li_Mg_thermometry_plots`,
  path = Thermometry_folder_path,
  scale = 1,
  width = 30,
  height = 15,
  units = "cm",
  dpi = 300,
)

ggsave(
  "Li_Mg_thermometry_constrained.tiff",
  plot = `Li_Mg_thermometry_plots_constrained`,
  path = Thermometry_folder_path,
  scale = 1,
  width = 30,
  height = 15,
  units = "cm",
  dpi = 300,
)

ggsave(
  "Mg_thermometry.tiff",
  plot = `Mg_thermometry_plots`,
  path = Thermometry_folder_path,
  scale = 1,
  width = 30,
  height = 15,
  units = "cm",
  dpi = 300,
)

ggsave(
  "Mg_thermometry_constrained.tiff",
  plot = `Mg_thermometry_plots_constrained`,
  path = Thermometry_folder_path,
  scale = 1,
  width = 30,
  height = 15,
  units = "cm",
  dpi = 300,
)

ggsave(
  "S_thermometry.tiff",
  plot = `S_thermometry_plots`,
  path = Thermometry_folder_path,
  scale = 1,
  width = 30,
  height = 15,
  units = "cm",
  dpi = 300,
)

ggsave(
  "Sr_thermometry.tiff",
  plot = `Sr_thermometry_plots`,
  path = Thermometry_folder_path,
  scale = 1,
  width = 30,
  height = 15,
  units = "cm",
  dpi = 300,
)

ggsave(
  "U_thermometry.tiff",
  plot = `U_thermometry_plots`,
  path = Thermometry_folder_path,
  scale = 1,
  width = 30,
  height = 15,
  units = "cm",
  dpi = 300,
)

# Standard error table ####
ggplot(Standard_errors[which(Standard_errors$Element == "Sr_Ca"),]) +
  geom_point(aes(x = Sample, y = mean_value, col = Section), position = position_dodge2(width= 0.5)) +
  geom_errorbar(aes(x = Sample, ymax = mean_value+coefficient_variation_av, ymin = mean_value-coefficient_variation_av, col = Section), position = position_dodge(width = 0.5))


Standard_errors %>%
  filter(Element %in% c("Li_Ca", "Mg_Ca", "S_Ca", "Sr_Ca", "U_Ca")) %>%
  mutate(mean_value= ifelse(Element == "Mg_Ca" | Element == "S_Ca" | Element == "Sr_Ca", mean_value/1000, 
                            ifelse(Element == "U_Ca", mean_value*1000, mean_value)),
         standard_dev_2_av= ifelse(Element == "Mg_Ca" | Element == "S_Ca" | Element == "Sr_Ca", standard_dev_2_av/1000, 
                            ifelse(Element == "U_Ca", standard_dev_2_av*1000, standard_dev_2_av)),
         standard_error_2_av= ifelse(Element == "Mg_Ca" | Element == "S_Ca" | Element == "Sr_Ca", standard_error_2_av/1000, 
                            ifelse(Element == "U_Ca", standard_error_2_av*1000, standard_error_2_av)),
         max_value= ifelse(Element == "Mg_Ca" | Element == "S_Ca" | Element == "Sr_Ca", max_value/1000, 
                            ifelse(Element == "U_Ca", max_value*1000, max_value)),
         min_value= ifelse(Element == "Mg_Ca" | Element == "S_Ca" | Element == "Sr_Ca", min_value/1000, 
                            ifelse(Element == "U_Ca", min_value*1000, min_value)),
         ) %>%
  write.csv("Table_averages_rasters.csv") %>%
  ggplot() +
  geom_point(aes(x = Sample, y = mean_value, col = Section), position = position_dodge2(width= 0.5)) +
  geom_errorbar(aes(x = Sample, ymax = mean_value+standard_error_2_av, ymin = mean_value-standard_error_2_av, col = Section), position = position_dodge(width = 0.5)) +
  facet_grid( ~ Element) +
  theme_classic()

# ASTROCHRON PACKAGE ####
library(astrochron)

for(a in 1:length(Ratios)) {
  for(c in 1:length(Samples)) {
    pattern_data <- c(paste0(Samples[c],"_"), paste0(Ratios[a],"_patterndata"))
Sample_Pattern_Data <- grep(paste0(pattern_data, collapse = ".*"),names(.GlobalEnv),value=TRUE)
Pattern_Data_list <-do.call("list",mget(Sample_Pattern_Data))
Pattern_Data_list <- Pattern_Data_list[order(names(Pattern_Data_list))]
Internode <- c(1,2,3)
Pattern_Data_list <- mapply(cbind, Pattern_Data_list, "Internode"=Internode, SIMPLIFY=F)
assign(paste0("Sample_",Samples[c],"_",Ratios[a], "_Pattern_Data_list"), Pattern_Data_list)
  }
}

Trace_data <- data.frame(distance = -`Sample_23_1 1 thermometry_data`$distance.um,
                         Sr_Ca = `Sample_23_1 1 thermometry_data`$Sr_Ca)

Trace_data_2 <- data.frame(distance = -`Sample_23_1 2 thermometry_data`$distance.um,
                         Sr_Ca = `Sample_23_1 2 thermometry_data`$Sr_Ca)

Trace_data_3 <- data.frame(distance = -Sample_23_1_Ba_Ca_Pattern_Data_list[[3]]$distance.um,
                         Li_Ca = Sample_23_1_Ba_Ca_Pattern_Data_list[[3]]$mean)
dev.new()
a <-  astrochron::linage(Trace_data, Trace_data_2, extrapolate = F, output =3)

plot (a[[2]]$distance, -Sample_23_1_Ba_Ca_Pattern_Data_list[[2]]$distance.um)
plot (a[[2]]$distance, a[[2]]$Ba_Ca)
lines (-Sample_23_1_Ba_Ca_Pattern_Data_list[[1]]$distance.um, Sample_23_1_Ba_Ca_Pattern_Data_list[[1]]$mean, col="red")


```