---
title: "LAICPMS_Data_rastering&analysis Script"
author: "Thomas J Williams"
date: "26/05/2022"
version: "2.10"
edited by: "Thomas J Williams"
edit date: "24/01/2023"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r packages and functions, echo = F, message=T}

packages <- c("tidyverse", "janitor", "sjmisc", "Hmisc", "viridis", "ggthemes", "ggpmisc", "patchwork", "raster", "terra", "GGally")
rasterpackages <- c("caTools", "scatterplot3d", "wesanderson", "matrixStats", "viridis", "RColorBrewer", "raster", "rasterVis", "hillshader")

options(scipen = 100)

for (i in packages) {
if (i %in% rownames(installed.packages()) == FALSE) 
{install.packages(i)
  require(i, character.only = T)} else {
    require(i, character.only = T)
  }
}

for (i in rasterpackages) {
if (i %in% rownames(installed.packages()) == FALSE) 
{install.packages(i)
  require(i, character.only = T)} else {
    require(i, character.only = T)
  }
}

# plotting multiple plots in a list
plot_a_list <- function(master_list_with_plots, no_of_rows, no_of_cols, ylim, xlim, ylab, xlab) {
  if(missing(ylim) | missing(xlim) | missing(ylab) | missing(xlab)) {
    patchwork::wrap_plots(master_list_with_plots, 
                        nrow = no_of_rows, ncol = no_of_cols)
  } else {
      patchwork::wrap_plots(master_list_with_plots, 
                        nrow = no_of_rows, ncol = no_of_cols) &
  ggplot2::lims(y = ylim, x = xlim) &
      ggplot2::xlab(label = xlab) &
      ggplot2::ylab(label = ylab)
  }
}

# pause function
testit <- function(x)
{
    p1 <- proc.time()
    Sys.sleep(x)
    proc.time() - p1 # The cpu usage should be negligible
}

# my_fun function
my_fn <- function(data, mapping, ...){
      p <- ggplot(data = data, mapping = mapping) + 
        geom_bin_2d(bins = 30, alpha = 0.5, show.legend = T, na.rm = T) +
  scale_fill_continuous(type = "viridis") +
  theme_classic()
      p
   }

```

## Collating tracks to each coral section (5 adjacent tracks per section) and applying secondary normalisation based off JcP inaccuracies

```{r collating tracks per section - 612 corrected, echo=T, message=T}

View(NIST612_Corrected_Samples)
detach(package::plyr)

Samples <-c("23_10", "23_6", "23_1", "23_16")
j <-1
a<-1
i <- 70

# for all ratios ####
for(j in 1:length(Samples)) { # 4 samples
  for(a in 1:3) { # 3 sections
    Sample_ratios <- list()
  for(i in 70:78) { # 9 element ratios
    Tracks <- get(paste0("NIST612_Corrected_Sample_",Samples[j],"_",a))
    Element <- colnames(Tracks[[1]])[[i]]
    cat("Sample: ", Samples[j], a, Element, "\n")
    Track1_data <- data.frame(Row = seq(1,nrow(Tracks[[1]]), by = 1),
                              Track1 = Tracks[[1]][[i]])
    Track2_data <- data.frame(Row = seq(1,nrow(Tracks[[2]]), by = 1),
                              Track2 = Tracks[[2]][[i]])
    Track3_data <- data.frame(Row = seq(1,nrow(Tracks[[3]]), by = 1),
                              Track3 = Tracks[[3]][[i]])
    Track4_data <- data.frame(Row = seq(1,nrow(Tracks[[4]]), by = 1),
                              Track4 = Tracks[[4]][[i]])
    Track5_data <- data.frame(Row = seq(1,nrow(Tracks[[5]]), by = 1),
                              Track5 = Tracks[[5]][[i]])
    Tracks_data <- full_join(full_join(full_join(full_join(Track1_data,
                                                           Track2_data),
                                                 Track3_data),
                                       Track4_data), 
                             Track5_data) 
    Tracks_data <- Tracks_data[-c(1:60),] # remove first 60 rows (30 second blank at 0.5s)
    Tracks_data <- head(Tracks_data, -90) # remove last 90 rows (45 second blank at 0.5s)
    Tracks_data$Row <- NULL
    
    # Secondary normalization - based off JCp standard inaccuracies (no P or Mn as massive variability - %SD > 70)
    if(Element == "Li_Ca_umol_mol") {
      Tracks_data_normalised <- Tracks_data * (100-8.76811768)/100
    } else { if(Element == "B_Ca_umol_mol"){
      Tracks_data_normalised <- Tracks_data * (100+1.7848328)/100
    } else { if(Element == "Mg_Ca_umol_mol"){
      Tracks_data_normalised <- Tracks_data * (100-3.76115643)/100
    } else { if(Element == "Sr_Ca_umol_mol"){
      Tracks_data_normalised <- Tracks_data * (100+4.6428207)/100
    } else { if(Element == "U_Ca_umol_mol"){
      Tracks_data_normalised <- Tracks_data * (100+8.6738645)/100
    } else { if(Element == "S_Ca_umol_mol"){
      Tracks_data_normalised <- Tracks_data * (100+27.92745)/100
    } else { if(Element == "Ba_Ca_umol_mol"){
      Tracks_data_normalised <- Tracks_data * (100+28.26798)/100
    } else { Tracks_data_normalised <- Tracks_data }}}}}}}
    
    assign(paste0(Element), Tracks_data_normalised)
    Sample_ratios[[paste0(Element)]] <- Tracks_data_normalised
    rm(Tracks_data)
    rm(Tracks_data_normalised)
    }
  assign(paste0("Sample_",Samples[j],"_",a,"_ratios"), Sample_ratios)
  rm(Sample_ratios)
  }
}
# View(Sample_23_16_3_ratios)

# Adding Li/Mg to samples 
Sample_23_1_1_ratios[["Li_Mg_umol_mmol"]] <- Sample_23_1_1_ratios[["Li_Ca_umol_mol"]]/(Sample_23_1_1_ratios[["Mg_Ca_umol_mol"]]/1000)
Sample_23_1_2_ratios[["Li_Mg_umol_mmol"]] <- Sample_23_1_2_ratios[["Li_Ca_umol_mol"]]/(Sample_23_1_2_ratios[["Mg_Ca_umol_mol"]]/1000)
Sample_23_1_3_ratios[["Li_Mg_umol_mmol"]] <- Sample_23_1_3_ratios[["Li_Ca_umol_mol"]]/(Sample_23_1_3_ratios[["Mg_Ca_umol_mol"]]/1000)

Sample_23_6_1_ratios[["Li_Mg_umol_mmol"]] <- Sample_23_6_1_ratios[["Li_Ca_umol_mol"]]/(Sample_23_6_1_ratios[["Mg_Ca_umol_mol"]]/1000)
Sample_23_6_2_ratios[["Li_Mg_umol_mmol"]] <- Sample_23_6_2_ratios[["Li_Ca_umol_mol"]]/(Sample_23_6_2_ratios[["Mg_Ca_umol_mol"]]/1000)
Sample_23_6_3_ratios[["Li_Mg_umol_mmol"]] <- Sample_23_6_3_ratios[["Li_Ca_umol_mol"]]/(Sample_23_6_3_ratios[["Mg_Ca_umol_mol"]]/1000)

Sample_23_10_1_ratios[["Li_Mg_umol_mmol"]] <- Sample_23_10_1_ratios[["Li_Ca_umol_mol"]]/(Sample_23_10_1_ratios[["Mg_Ca_umol_mol"]]/1000)
Sample_23_10_2_ratios[["Li_Mg_umol_mmol"]] <- Sample_23_10_2_ratios[["Li_Ca_umol_mol"]]/(Sample_23_10_2_ratios[["Mg_Ca_umol_mol"]]/1000)
Sample_23_10_3_ratios[["Li_Mg_umol_mmol"]] <- Sample_23_10_3_ratios[["Li_Ca_umol_mol"]]/(Sample_23_10_3_ratios[["Mg_Ca_umol_mol"]]/1000)

Sample_23_16_1_ratios[["Li_Mg_umol_mmol"]] <- Sample_23_16_1_ratios[["Li_Ca_umol_mol"]]/(Sample_23_16_1_ratios[["Mg_Ca_umol_mol"]]/1000)
Sample_23_16_2_ratios[["Li_Mg_umol_mmol"]] <- Sample_23_16_2_ratios[["Li_Ca_umol_mol"]]/(Sample_23_16_2_ratios[["Mg_Ca_umol_mol"]]/1000)
Sample_23_16_3_ratios[["Li_Mg_umol_mmol"]] <- Sample_23_16_3_ratios[["Li_Ca_umol_mol"]]/(Sample_23_16_3_ratios[["Mg_Ca_umol_mol"]]/1000)

# for Calcium counts ONLY ####
for(j in 1:length(Samples)) { # 4 samples
  for(a in 1:3) { # 3 sections
    Ca43_counts <- list()
    Tracks <- get(paste0("NIST612_Corrected_Sample_",Samples[j],"_",a))
    Element <- colnames(Tracks[[1]])[[47]] #Ca45_analysis_blankcorrected (Ca counts per second)
    cat("Sample: ", Samples[j], a, Element, "\n")
    Track1_data <- data.frame(Row = seq(1,nrow(Tracks[[1]]), by = 1),
                              Track1 = Tracks[[1]][[47]])
    Track2_data <- data.frame(Row = seq(1,nrow(Tracks[[2]]), by = 1),
                              Track2 = Tracks[[2]][[47]])
    Track3_data <- data.frame(Row = seq(1,nrow(Tracks[[3]]), by = 1),
                              Track3 = Tracks[[3]][[47]])
    Track4_data <- data.frame(Row = seq(1,nrow(Tracks[[4]]), by = 1),
                              Track4 = Tracks[[4]][[47]])
    Track5_data <- data.frame(Row = seq(1,nrow(Tracks[[5]]), by = 1),
                              Track5 = Tracks[[5]][[47]])
    Tracks_data <- full_join(full_join(full_join(full_join(Track1_data,
                                                           Track2_data),
                                                 Track3_data),
                                       Track4_data), 
                             Track5_data) 
    Tracks_data <- Tracks_data[-c(1:60),] # remove first 60 rows (30 second blank at 0.5s)
    Tracks_data <- head(Tracks_data, -90) # remove last 90 rows (45 second blank at 0.5s)
    Tracks_data$Row <- NULL
    assign(paste0(Element), Tracks_data)
    Ca43_counts[[paste0(Element)]] <- Tracks_data
    rm(Tracks_data)
  assign(paste0("Sample_",Samples[j],"_",a,"_Ca43_counts"), Ca43_counts)
  rm(Ca43_counts)
  }
}

# View(Sample_23_16_1_Ca43_counts)

```

# 1st half of code; reading element data of collated tracks, removing outliers, smoothing and plotting. 
# Second half of code; rastering in various formats

```{r intial read and plot of line scans}

Ratios <- c("Li_Ca", "B_Ca", "Mg_Ca", "P_Ca", "S_Ca", "Mn_Ca", "Sr_Ca", "Ba_Ca", "U_Ca", "Li_Mg")

plotdimensions <- par(mfrow=c(1,1),
                     mar=c(0.2,0.2,0.2,0.2),
                     oma=c(5,4,1,5),
                     bty = "n", 
                     bg = "transparent")

# Separate folders for rasters, line plots and the dimension files. These can be adapted to whichever folder you decide. 
Rasterpath <- "~/OneDrive - University of Southampton/PhD, INSPIRE DTP/Countries_Chapters/UK [Soton]/Chpt4 Bamboo Coral Analysis/LAICPMS/Data_R_processed/NIST612_Corrected_rasters/"
Linepath <- "~/OneDrive - University of Southampton/PhD, INSPIRE DTP/Countries_Chapters/UK [Soton]/Chpt4 Bamboo Coral Analysis/LAICPMS/Data_R_processed/NIST612_Corrected_lineplots/"
Dimensionspath <- "~/OneDrive - University of Southampton/PhD, INSPIRE DTP/Countries_Chapters/UK [Soton]/Chpt4 Bamboo Coral Analysis/LAICPMS/Data_R_processed/XY_dimensions_samples/"

# Reset for loops (should happen anyway but just in case)
a <- 1
c <- 1
b <- 1

# Do you want to plot outputs or just run code?
lineplot = F
pattern = T

#Standard error output dataframe
Standard_errors <- data.frame(Sample = character(),
                              Section = character(),
                              Element = character(),
                              mean_value = numeric(),
                              standard_dev_2_av = numeric(),
                              standard_error_2_av = numeric(),
                              coefficient_variation_av = numeric(),
                              max_value = numeric(),
                              min_value = numeric()
                                 )

#Reset plot dimensions
dev.off()

# for all ratios ####
#START OF SUPERLOOP
b <- 1
for(c in 1:length(Samples)) { # 4 samples
  for(b in 1:3) { # 3 sections
    
    Sample_ratios <- get(paste0("Sample_",Samples[c],"_",b,"_ratios"))
    testit(0.05) #pause for script to find file in time before reading
    temp = list.files(path = Dimensionspath, pattern = paste0(Samples[c],"_",b,"_TJW.csv"))
    testit(0.05) #pause for script to find file in time before reading
    XY_dim<-read.csv(file = paste0(Dimensionspath,temp), header=TRUE)
    
    for(a in 1:length(Ratios)) { # 10 ratios
      Sample_ratio <- Sample_ratios[[a]]
      cat("Sample: ", Samples[c], b, Ratios[a], "\n")

size <- length(Sample_ratio[,1])
r.depth <- seq(1, size, by =1)

#number of line scans used to make the image
no.tracks<-length(Sample_ratio[1,])

##degree of smoothing----
SM<-5

##level of rejection----
if (Ratios[a] == "U_Ca" | Ratios[a] == "Ba_Ca" | Ratios[a] == "Mn_Ca") {
  R<-2 
} else { if(Ratios[a] == "P_Ca") {
  R<-3
} else { if (Ratios[a] == "Li_Ca" | Ratios[a] == "Sr_Ca" | Ratios[a] == "Li_Mg") {
  R<-3
} else {
  R<-4
  }
  }
  }

#resolution factor ---- converts QQQ integration to MCICPMS integration of 2s 
#degrades the Y resolution of the raster
RS<-1 

###make the grid ---- 
#using the Y length and spot spacing

dim.Y<-XY_dim$Y[2]-XY_dim$Y[1] #nb for landscape orientation this is the Y dimension

x.grid.dim<-seq (1, size,  by=1)
y.grid.dim<-seq (-1, -no.tracks, by=-1)
x.grid<-matrix (NA, ncol=no.tracks, nrow=size/RS)
y.grid<-matrix (NA, ncol=no.tracks, nrow=size/RS)

for (i in 1:no.tracks){
  x.grid[,i]<-seq (1, size/RS,  by=1)
}
for (i in 1:no.tracks){
  y.grid[,i]<-rep (y.grid.dim[i], size/RS)
}

##turn the grid into dimensions ####
spot.size<-50 #um
#int.time <-1*RS #seconds per data point #0.472 s for TE on QQQ and 1.049s for d11B
#scan.speed <- 10 #microns per second

x.grid.um<-x.grid*(dim.Y/size)
y.grid.um<-y.grid*spot.size

#plot (x.grid.um, y.grid.um)

# #colours
# nc<-wes_palette(no.tracks, name="Darjeeling1", type="continuous")
# 
# ##Plots ####
# plot (r.depth, Sample_ratio[,1], type="n", ylim=c(min (Sample_ratio, na.rm=TRUE),max(Sample_ratio, na.rm=TRUE)), ylab = paste0(Ratios[a]))
# mtext("Raw data", side = 3)
# #loop to plot each line scan, stepping through the Li_Ca vector column at a time (j increase by 1 up to a max = number of lines) 
# for (j in 1:no.tracks){
#   lines (r.depth, (Sample_ratio[,j]), col=nc[j])
# }

#want to now do some rejection of "bad" data - we use a +/-3sd limit
#determine the means and sd of each line
m.L<-rep (NA, size)
m.sd<-rep (NA, size)

#loop again to determine the mean and sd of each line
for (j in 1:no.tracks){
  m.L[j]<-mean (Sample_ratio[,j], na.rm=TRUE)
  m.sd[j]<-sd (Sample_ratio[,j], na.rm=TRUE)
  }

# #plot of these 
# plot (m.L)
# plot (m.sd)





#replace 3sd outliers with NA ####
#make matrix to fill with original data and NA when original data outside of +/-3sd

L.o<-matrix (NA, ncol=no.tracks, nrow=size)

#bit of a more complex loop - where it uses an ifelse statment to evaluate each data point
for (j in 1:no.tracks){
  for (i in 1:size) {
    L.o[i,j]<-ifelse (Sample_ratio[i,j] < m.L[j]+R*m.sd[j] & Sample_ratio[i,j] > m.L[j]-R*m.sd[j], Sample_ratio[i,j], NA)
  }}

# #have a look at the data -rejections
# plot (r.depth, Sample_ratio[,1], type="n", ylim=c(min(L.o, na.rm=TRUE),max(L.o, na.rm=TRUE)), ylab = paste0(Ratios[a]))
# mtext("No outliers", side = 3)
# #number of colours
# #loop to plot each line
# for (j in 1:no.tracks){
#   lines (r.depth, (L.o[,j]), col=nc[j])
# }

##smoothing ####
#degree of smoothing (choose a variable from 2 to n, 5 is probably ok)

#make a couple of matrix's to be filled with smoothed data
L.o.s<-matrix (NA, ncol=no.tracks, nrow=size)
L.o.s.sd<-matrix (NA, ncol=no.tracks, nrow=size)


for (j in 1:no.tracks){
    L.o.s[,j]<-runmean (L.o[,j], SM, endrule = "NA")
    L.o.s.sd[,j]<-runsd (L.o[,j], SM, endrule = "NA")
    
  }

# #take a look at the results of the smoothing
# plot (r.depth, Sample_ratio[,1], type="n", ylim=c(min(L.o.s, na.rm = T),max(L.o.s, na.rm=TRUE)), ylab = paste0(Ratios[a]))
# mtext("Smoothed data", side = 3)
# for (j in 1:no.tracks){
#   lines (r.depth, (L.o.s[,j]), col=nc[j])
# }
# dev.copy(png, paste0(Smoothpath, "Sample_",Samples[c],"_",b,"_",Ratios[a], "smoothplot.png"))
# dev.off()
# assign(paste0("Sample_",Samples[c],"_",b,"_",Ratios[a], "_smoothplot"), smoothplot)
# rm(smoothplot)

# # standard deviation over the track
# plot (r.depth, Sample_ratio[,1], type="n", ylim=c(min(L.o.s.sd, na.rm=TRUE),max(L.o.s.sd, na.rm=TRUE)), ylab = paste0(Ratios[a]))
# mtext("Rolling st.dev", side = 3)
# #number of cols
# for (j in 1:no.tracks){
#   lines (r.depth, (L.o.s.sd[,j])/(no.tracks^0.5), col=nc[j])
# }

##average se for each of the smoothed points####
se <- mean (L.o.s.sd/(SM^0.5), na.rm=TRUE)*2

## collate the lineplots and export####
if(lineplot == T) {
dev.off()
pdf(file = paste0(Linepath, "Sample_", Samples[c],"_",b," ", Ratios[a], " line plots.pdf"))

par(oma = c(3,3,0,0), mar = c(3,3,2,2), 
    layout(mat = matrix(c(1,3,2,4), 
                  nrow= 2, 
                  ncol = 2), 
                  heights = c(1, 1), # Heights of the two rows
                  widths = c(2, 2)), 
    bty= "n")


{plot (r.depth, Sample_ratio[,1], type="n", ylim=c(min (Sample_ratio, na.rm=TRUE),max(Sample_ratio, na.rm=TRUE)), ylab = paste0(Ratios[a]))
mtext("Raw data", side = 3)
#loop to plot each line scan, stepping through the Li_Ca vector column at a time (j increase by 1 up to a max = number of lines) 
for (j in 1:no.tracks){
  lines (r.depth, (Sample_ratio[,j]), col=nc[j])
}}
{plot (r.depth, Sample_ratio[,1], type="n", ylim=c(min(L.o, na.rm=TRUE),max(L.o, na.rm=TRUE)), ylab = paste0(Ratios[a]))
mtext("No outliers", side = 3)
#number of colours
#loop to plot each line
for (j in 1:no.tracks){
  lines (r.depth, (L.o[,j]), col=nc[j])
}}

{plot (r.depth, Sample_ratio[,1], type="n", ylim=c(min(L.o.s, na.rm=TRUE),max(L.o.s, na.rm=TRUE)), ylab = paste0(Ratios[a]))
mtext("Smoothed data", side = 3)
for (j in 1:no.tracks){
  lines (r.depth, (L.o.s[,j]), col=nc[j])
}}

{plot (r.depth, Sample_ratio[,1], type="n", ylim=c(min(L.o.s.sd, na.rm=TRUE),max(L.o.s.sd, na.rm=TRUE)), ylab = paste0(Ratios[a]))
mtext("Rolling st.dev", side = 3)
#number of cols
for (j in 1:no.tracks){
  lines (r.depth, (L.o.s.sd[,j])/(no.tracks^0.5), col=nc[j])
}}
mtext(text= "Distance",side=1,line=0,outer=TRUE)
mtext(text=paste0(Ratios[a]),side=2,line=0,outer=TRUE)

dev.off()
}

## pattern plots ####
if (pattern == T) {
  pattern_data <- as.data.frame(L.o.s)
  if(Samples[c] == "23_6") { 
    pattern_data$distance.um <- x.grid.um[,1] } else {
         pattern_data$distance.um <- -x.grid.um[,1] 
       }
  
pattern_data <-  pattern_data %>%
    rowwise() %>%
    mutate(n = count(!is.na(c(V1,V2,V3,V4,V5))),
           mean = mean(c(V1,V2,V3,V4,V5), na.rm = TRUE),
           sd = sd(c(V1,V2,V3,V4,V5), na.rm = TRUE),
           sd2 = sd*2,
           se2 = sd2/sqrt(n),
           max = max(c(V1,V2,V3,V4,V5), na.rm = TRUE),
           min = min(c(V1,V2,V3,V4,V5), na.rm = TRUE),
           coefficient_var = sd/mean)

pattern_data[pattern_data$max == -Inf,]$max <- NA
pattern_data[pattern_data$min == Inf,]$min <- NA

assign(paste0("Sample_",Samples[c],"_",b,"_",Ratios[a], "_patterndata"), pattern_data)

Standard_errors <- Standard_errors %>% add_row(
  Sample = paste0(Samples[c]),
  Section = paste0(b),
  Element = Ratios[a],
  mean_value = mean(pattern_data$mean, na.rm = T),
  standard_dev_2_av = mean(pattern_data$sd2, na.rm = T),
  standard_error_2_av = mean(pattern_data$se2, na.rm = T),
  coefficient_variation_av = mean(pattern_data$coefficient_var, na.rm = T),
  max_value = max(pattern_data$max, na.rm = T),
  min_value = min(pattern_data$min, na.rm = T)
)

Variability_plot <- ggplot(data = pattern_data, aes(x = distance.um, y = mean)) +
  geom_ribbon(aes(x = distance.um, y=mean, ymax=mean+se2, ymin=mean-se2), fill="#227988",alpha=.5) +
  geom_path(aes(distance.um, max), lty =2, size = 0.5) +
  geom_path(aes(distance.um, min), lty =2, size = 0.5) +
  geom_path(aes(distance.um, mean), lty =1, size = 0.8) +
  stat_poly_line(col = "red", linetype = 3) +
  stat_poly_eq(aes(label = paste(after_stat(eq.label),
                                 after_stat(rr.label), sep = "*\", \"*"))) +
  ggpubr::stat_cor(method = "pearson", label.x.npc = .5) +
  scale_y_continuous(name = paste0(Ratios[a]," (µmol/mol)")) +
  scale_x_reverse(name = "Distance from coral edge (µm)") +
  theme_classic()

assign(paste0("Sample_",Samples[c],"_",b,"_",Ratios[a], "_variabilityplot"), Variability_plot)

rm(pattern_data)
rm(Variability_plot)

}
#now we have rejected the outliers and smoothed the data we can make a raster image (a map)
## rasterise ####
#sets the dimensions of the plot 

#fill up a matrix with X and Y coordinates and smoothed and rejected laser ablation values
s100<-matrix (c(x.grid.um, rev(y.grid.um), L.o.s), ncol=3, byrow=FALSE)
#s100<-matrix (c(x.grid, rev(y.grid), L.o), ncol=3, byrow=FALSE) #not smoothed
colnames(s100) <- c('X', 'Y', 'Z')
e <- extent(s100[,1:2]) #tells the raster its X and Y that form the grid

# important - nrow here is the number of laser lines going into the raster
# for some reason n-1 makes the best images and makes the resolution correct (Gavin)
# HOWEVER, with smaller number of tracks I (Tom) find that it works better having n and changing the aspect of the plots accordingly.  Otherwise the last track has weird overlapping data.  
r <- raster(e, ncol=size, nrow=no.tracks)

#using nrow < lenght of lines or ncol< number of lines will lower the resolution

# you need to provide a function 'fun' for when there are multiple points per cell
x <- rasterize(s100[, 1:2], r, s100[,3], fun=mean)

assign(paste0("Sample_", Samples[c],"_",b," ", Ratios[a], " raster"), x)
    }
  }
}


# For Ca43 ONLY ####

for(c in 1:length(Samples)) { # 4 samples
  for(b in 1:3) { # 3 sections
    
    Ca43_counts <- get(paste0("Sample_",Samples[c],"_",b,"_Ca43_counts"))
    testit(0.05) #pause for script to find file in time before reading
    temp = list.files(path = Dimensionspath, pattern = paste0(Samples[c],"_",b,"_TJW.csv"))
    testit(0.05) #pause for script to find file in time before reading
    XY_dim<-read.csv(file = paste0(Dimensionspath,temp), header=TRUE)
    
      Ca43_count <- Ca43_counts[[1]]
      cat("Sample: ", Samples[c], b, "Ca43_counts", "\n")

size <- length(Ca43_count[,1])
r.depth <- seq(1, size, by =1)

#number of line scans used to make the image
no.tracks<-length(Ca43_count[1,])

#degree of smoothing----
SM<-5

#level of rejection----
R<-4
 
#resolution factor ---- converts QQQ integration to MCICPMS integration of 2s 
#degrades the Y resolution of the raster
RS<-1 

###make the grid ---- 
#using the Y length and spot spacing

dim.Y<-XY_dim$Y[2]-XY_dim$Y[1] #nb for landscape orientation this is the Y dimension

x.grid.dim<-seq (1, size,  by=1)
y.grid.dim<-seq (-1, -no.tracks, by=-1)
x.grid<-matrix (NA, ncol=no.tracks, nrow=size/RS)
y.grid<-matrix (NA, ncol=no.tracks, nrow=size/RS)

for (i in 1:no.tracks){
  x.grid[,i]<-seq (1, size/RS,  by=1)
}
for (i in 1:no.tracks){
  y.grid[,i]<-rep (y.grid.dim[i], size/RS)
}

#turn the grid into dimensions ####
spot.size<-50 #um
#int.time <-1*RS #seconds per data point #0.472 s for TE on QQQ and 1.049s for d11B
#scan.speed <- 10 #microns per second

x.grid.um<-x.grid*(dim.Y/size)
y.grid.um<-y.grid*spot.size

#plot (x.grid.um, y.grid.um)

#colours
nc<-wes_palette(no.tracks, name="Darjeeling1", type="continuous")

#Plots ####
plot (r.depth, Ca43_count[,1], type="n", ylim=c(min (Ca43_count, na.rm=TRUE),max(Ca43_count, na.rm=TRUE)), ylab = paste0("Ca43 (counts per second)"))
mtext("Raw data", side = 3)
#loop to plot each line scan, stepping through the Li_Ca vector column at a time (j increase by 1 up to a max = number of lines) 
for (j in 1:no.tracks){
  lines (r.depth, (Ca43_count[,j]), col=nc[j])
}

#want to now do some rejection of "bad" data - we use a +/-3sd limit
#determine the means and sd of each line
m.L<-rep (NA, size)
m.sd<-rep (NA, size)

#loop again to determine the mean and sd of each line
for (j in 1:no.tracks){
  m.L[j]<-mean (Ca43_count[,j], na.rm=TRUE)
  m.sd[j]<-sd (Ca43_count[,j], na.rm=TRUE)
  }

#plot of these 
plot (m.L)
plot (m.sd)

#replace 3sd outliers with NA ####
#make matrix to fill with original data and NA when original data outside of +/-3sd

L.o<-matrix (NA, ncol=no.tracks, nrow=size)

#bit of a more complex loop - where it uses an ifelse statment to evaluate each data point
for (j in 1:no.tracks){
  for (i in 1:size) {
    L.o[i,j]<-ifelse (Ca43_count[i,j] < m.L[j]+R*m.sd[j] & Ca43_count[i,j] > m.L[j]-R*m.sd[j], Ca43_count[i,j], NA)
  }}

#have a look at the data -rejections
plot (r.depth, Ca43_count[,1], type="n", ylim=c(min(L.o, na.rm=TRUE),max(L.o, na.rm=TRUE)), ylab = paste0("Ca43 (counts per second)"))
mtext("No outliers", side = 3)
#number of colours
#loop to plot each line
for (j in 1:no.tracks){
  lines (r.depth, (L.o[,j]), col=nc[j])
}

#smoothing ####
#degree of smoothing (choose a variable from 2 to n, 5 is probably ok)

#make a couple of matrix's to be filled with smoothed data
L.o.s<-matrix (NA, ncol=no.tracks, nrow=size)
L.o.s.sd<-matrix (NA, ncol=no.tracks, nrow=size)


for (j in 1:no.tracks){
    L.o.s[,j]<-runmean (L.o[,j], SM, endrule = "NA")
    L.o.s.sd[,j]<-runsd (L.o[,j], SM, endrule = "NA")
    
  }

#take a look at the results of the smoothing
plot (r.depth, Ca43_count[,1], type="n", ylim=c(min(L.o.s, na.rm = T),max(L.o.s, na.rm=TRUE)), ylab = paste0("Ca43 (counts per second)"))
mtext("Smoothed data", side = 3)
for (j in 1:no.tracks){
  lines (r.depth, (L.o.s[,j]), col=nc[j])
}


# standard deviation over the track
plot (r.depth, Ca43_count[,1], type="n", ylim=c(min(L.o.s.sd, na.rm=TRUE),max(L.o.s.sd, na.rm=TRUE)), ylab = paste0("Ca43 (counts per second)"))
mtext("Rolling st.dev", side = 3)
#number of cols
for (j in 1:no.tracks){
  lines (r.depth, (L.o.s.sd[,j])/(no.tracks^0.5), col=nc[j])
}

#average se for each of the smoothed points####
se <- mean (L.o.s.sd/(SM^0.5), na.rm=TRUE)*2


#now we have rejected the outliers and smoothed the data we can make a raster image (a map)
## rasterise ####
#sets the dimensions of the plot 

#fill up a matrix with X and Y coordinates and smoothed and rejected laser ablation values
s100<-matrix (c(x.grid.um, rev(y.grid.um), L.o.s), ncol=3, byrow=FALSE)
#s100<-matrix (c(x.grid, rev(y.grid), L.o), ncol=3, byrow=FALSE) #not smoothed
colnames(s100) <- c('X', 'Y', 'Z')
e <- extent(s100[,1:2]) #tells the raster its X and Y that form the grid

# important - nrow here is the number of laser lines going into the raster
# for some reason n-1 makes the best images and makes the resolution correct (Gavin)
# HOWEVER, with smaller number of tracks I (Tom) find that it works better having n and changing the aspect of the plots accordingly.  Otherwise the last track has weird overlapping data.  
r <- raster(e, ncol=size, nrow=no.tracks)

#using nrow < lenght of lines or ncol< number of lines will lower the resolution

# you need to provide a function 'fun' for when there are multiple points per cell
x <- rasterize(s100[, 1:2], r, s100[,3], fun=mean)

assign(paste0("Sample_", Samples[c],"_",b, "_Ca43_counts_raster"), x)
    }
  }
```


Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.

```{r rastering each element ratio seperately}

for(a in 1:length(Ratios)) {
Element_rasters <- grep(paste0("*",Ratios[a], " raster"),names(.GlobalEnv),value=TRUE)
Element_raster_list <-do.call("list",mget(Element_rasters))
assign(paste0(Ratios[a], "_raster_list"), Element_raster_list)
}
rm(Element_raster_list)

Sr_Ca_rasters <- grep(paste0("*","Sr_Ca", " raster"),names(.GlobalEnv),value=TRUE)
Sr_Ca_rasters_list <- do.call("list", mget(Sr_Ca_rasters))
Sr_Ca_rasters_list <- Sr_Ca_rasters_list[order(names(Sr_Ca_rasters_list))]
U_Ca_rasters <- grep(paste0("*","U_Ca", " raster"),names(.GlobalEnv),value=TRUE)
U_Ca_rasters_list <- do.call("list", mget(U_Ca_rasters))
U_Ca_rasters_list <- U_Ca_rasters_list[order(names(U_Ca_rasters_list))]

rm(Sr_Ca_rasters)
rm(U_Ca_rasters)


for(a in 1:length(Mg_Ca_raster_list)) {
  Mg_Ca_raster_list[[a]] <- Mg_Ca_raster_list[[a]]/1000
}



for(a in 1:length(Sr_Ca_rasters_list)) {
  Sr_U_raster <- (Sr_Ca_rasters_list[[a]]/1000) - (U_Ca_rasters_list[[a]]*1.1107)
  assign(paste0(gsub(" .*$", "", names(Sr_Ca_raster_list[a])), " Sr_U raster"), Sr_U_raster)
}

Sr_U_rasters <- grep(paste0("*","Sr_U", " raster"),names(.GlobalEnv),value=TRUE)
Sr_U_raster_list <-do.call("list",mget(Sr_U_rasters))

rm(Sr_U_rasters)


for(a in 1:length(Sr_Ca_raster_list)) {
  Sr_Ca_raster_list[[a]] <- Sr_Ca_raster_list[[a]]/1000
}



Rasterpath_viridis <- "~/OneDrive - University of Southampton/PhD, INSPIRE DTP/Countries_Chapters/UK [Soton]/Chpt4 Bamboo Coral Analysis/LAICPMS/Data_R_processed/NIST612_Corrected_rasters/Interpolated/"

b<- 1
# Temperature proxies
col2 <- viridis(40)
plot.new()
for (b in 1:length(Li_Mg_raster_list)) {
  par(mfrow=c(1,1),
                     mar=c(0.2,0.2,0.2,0.2),
                     oma=c(5,5,1,4),
                     bty = "n",
                     bg = "transparent")
plot(Li_Mg_raster_list[[b]],col=(col2), interpolate=TRUE, axes = F, cex.axis=0.8, asp = 1.25, alpha = 0.6, legend.args=list(text=" Li/Mg (µmol/mol)", side=4, line=3,cex=0.8, las=0), breaks = seq(0,2,by = 0.05))
mtext(paste0(names(Li_Mg_raster_list[b]),"_viridis"), side = 3)
dev.copy(png, paste0(Rasterpath_viridis, names(Li_Mg_raster_list[b]), "_viridis_interpolated.png"))
dev.off()
frame()
}


col2 <- c(inferno(20),rep("#FFFFFF",20))

# V high values, not saying much
col2 <- inferno(40)

plot.new()
for (b in 1:length(Mg_Ca_raster_list)) {
  par(mfrow=c(1,1),
                     mar=c(0.2,0.2,0.2,0.2),
                     oma=c(5,5,1,4),
                     bty = "n",
                     bg = "transparent")

plot(Mg_Ca_raster_list[[b]],col=(col2), interpolate=TRUE, axes = F, cex.axis=0.8, asp = 1.25, alpha = 0.6, legend.args=list(text=" Mg/Ca (mmol/mol)", side=4, line=3,cex=0.8, las=0), breaks = seq(60,140,by = 2), legend = F)
plot(Mg_Ca_raster_list[[b]], col =(inferno(20)), breaks = seq(60,100, by = 2), zlim = c(60,100), interpolate=T, axes = F, legend.args=list(text=" Mg/Ca (mmol/mol)", side=4, line=3,cex=0.8, las=0), legend.only = T)

plot(Mg_Ca_raster_list[[b]],col=(col2), interpolate=TRUE, axes = F, cex.axis=0.8, asp = 1.25, alpha = 0.6, legend.args=list(text=" Mg/Ca (µmol/mol)", side=4, line=3,cex=0.8, las=0), breaks = seq(60000,100000,by = 1000))

mtext(paste0(names(Mg_Ca_raster_list[b]),"_viridis"), side = 3)
dev.copy(png, paste0(Rasterpath_viridis, names(Mg_Ca_raster_list[b]), "_viridis_interpolated.png"))
dev.off()
frame()
}


col1 <-c(viridis(20),rep("#FFFFFF",20))

col1 <-inferno(20)

plot.new()
for (b in 1:length(Sr_Ca_raster_list)) {
  par(mfrow=c(1,1),
                     mar=c(0.2,0.2,0.2,0.2),
                     oma=c(5,5,1,4),
                     bty = "n",
                     bg = "transparent")

plot(Sr_Ca_raster_list[[b]],col=(col1), interpolate=TRUE, axes = F, cex.axis=0.8, asp = 1.25, alpha = 0.6, breaks = seq(2.5,4.5,by = 0.05), legend = F)
plot(Sr_Ca_raster_list[[b]],col=(viridis(20)), interpolate=TRUE, axes = F, cex.axis=0.8, asp = 1.25, alpha = 0.6, legend.args=list(text=" Sr/Ca (mmol/mol)", side=4, line=3,cex=0.8, las=0), breaks = seq(2.5,3.5,by = 0.05), legend.only = T)

plot(Sr_Ca_raster_list[[b]],col=(col1), interpolate=TRUE, axes = F, cex.axis=0.8, asp = 1.25, alpha = 0.6, legend.args=list(text=" Sr/Ca (µmol/mol)", side=4, line=3,cex=0.8, las=0), breaks = seq(2500,3500,by = 50))

mtext(paste0(names(Sr_Ca_raster_list[b]),"_viridis"), side = 3)
dev.copy(png, paste0(Rasterpath_viridis, names(Sr_Ca_raster_list[b]), "_inferno_interpolated.png"))
dev.off()
frame()
}

col1 <-inferno(20)
plot.new
for (b in 1:length(Sr_U_raster_list)) {
  par(mfrow=c(1,1),
                     mar=c(0.2,0.2,0.2,0.2),
                     oma=c(5,5,1,4),
                     bty = "n",
                     bg = "transparent")
plot(Sr_U_raster_list[[b]],col=(col1), interpolate=TRUE, axes = F, cex.axis=0.8, asp = 1.25, alpha = 0.6, legend.args=list(text=" Sr/U (mmol/µmol)", side=4, line=3,cex=0.8, las=0), breaks = seq(2,4,by = 0.1))
mtext(paste0(names(Sr_U_raster_list[b]),"_viridis"), side = 3)
dev.copy(png, paste0(Rasterpath_viridis, names(Sr_U_raster_list[b]), "_inferno_interpolated.png"))
dev.off()
frame()
}


col2 <- c(viridis(20), rep("#FFFFFF", 20))

col2 <- viridis(24)

plot.new()
for (b in 1:length(Li_Ca_raster_list)) {
  par(mfrow=c(1,1),
                     mar=c(0.2,0.2,0.2,0.2),
                     oma=c(5,5,1,4),
                     bty = "n",
                     bg = "transparent")

plot(Li_Ca_raster_list[[b]],col=(col2), interpolate=TRUE, axes = F, cex.axis=0.8, asp = 1.25, alpha = 0.6, breaks = seq(0,200,by = 5), legend = F)
plot(Li_Ca_raster_list[[b]],col=(col2), interpolate=TRUE, axes = F, cex.axis=0.8, asp = 1.25, alpha = 0.6, legend.args=list(text=" Li/Ca (µmol/mol)", side=4, line=3,cex=0.8, las=0), breaks = seq(0,100,by = 5), legend.only = T)

plot(Li_Ca_raster_list[[b]],col=(col2), interpolate=TRUE, axes = F, cex.axis=0.8, asp = 1.25, alpha = 0.6, legend.args=list(text=" Li/Ca (µmol/mol)", side=4, line=3,cex=0.8, las=0), breaks = seq(0,120,by = 5))

mtext(paste0(names(Li_Ca_raster_list[b]),"_viridis"), side = 3)
dev.copy(png, paste0(Rasterpath_viridis, names(Li_Ca_raster_list[b]), "_viridis_interpolated.png"))
dev.off()
frame()
}

col3 <-c(inferno(20),rep("#FFFFFF",20))
plot.new()
for (b in 1:length(Ba_Ca_raster_list)) {
  par(mfrow=c(1,1),
                     mar=c(0.2,0.2,0.2,0.2),
                     oma=c(5,5,1,4),
                     bty = "n",
                     bg = "transparent")
plot(Ba_Ca_raster_list[[b]],col=(col3), interpolate=TRUE, axes = F, cex.axis=0.8, asp = 1.25, alpha = 0.6, legend = F, breaks = seq(0,40,by = 1))
plot(Ba_Ca_raster_list[[b]], col =(inferno(20)), breaks = seq(0,20, by = 1), zlim = c(0,10), interpolate=T, axes = F, legend.args=list(text=" Ba/Ca (µmol/mol)", side=4, line=3,cex=0.8, las=0), legend.only = T)
mtext(paste0(names(Ba_Ca_raster_list[b]),"_inferno"), side = 3)
dev.copy(png, paste0(Rasterpath_viridis, names(Ba_Ca_raster_list[b]), "_Inferno_interpolated.png"))
dev.off()
frame()
}

col1 <- inferno(40)
plot.new()
for (b in 1:length(B_Ca_raster_list)) {
  par(mfrow=c(1,1),
                     mar=c(0.2,0.2,0.2,0.2),
                     oma=c(5,5,1,4),
                     bty = "n",
                     bg = "transparent")
plot(B_Ca_raster_list[[b]],col=(col1), interpolate=TRUE, axes = F, cex.axis=0.8, asp = 1.25, alpha = 0.6, legend.args=list(text=" B/Ca (µmol/mol)", side=4, line=3,cex=0.8, las=0), breaks = seq(100,300,by = 5))
mtext(paste0(names(B_Ca_raster_list[b]),"_viridis"), side = 3)
dev.copy(png, paste0(Rasterpath_viridis, names(B_Ca_raster_list[b]), "_inferno_interpolated.png"))
dev.off()
frame()
}



col3 <-c(inferno(20),rep("#FFFFFF",20))
plot.new()
for (b in 1:length(Ba_Ca_raster_list)) {
  par(mfrow=c(1,1),
                     mar=c(0.2,0.2,0.2,0.2),
                     oma=c(5,5,1,4),
                     bty = "n",
                     bg = "transparent")
plot(Ba_Ca_raster_list[[b]],col=(col3), interpolate=TRUE, axes = F, cex.axis=0.8, asp = 1.25, alpha = 0.6, legend = F, breaks = seq(0,40,by = 1))
plot(Ba_Ca_raster_list[[b]], col =(inferno(20)), breaks = seq(0,20, by = 1), zlim = c(0,10), interpolate=T, axes = F, legend.args=list(text=" Ba/Ca (µmol/mol)", side=4, line=3,cex=0.8, las=0), legend.only = T)
mtext(paste0(names(Ba_Ca_raster_list[b]),"_inferno"), side = 3)
dev.copy(png, paste0(Rasterpath_viridis, names(Ba_Ca_raster_list[b]), "_Inferno_interpolated.png"))
dev.off()
frame()
}


# Poor, negative ratios. Peaks at coral boundary edge (opposite to Li and B)
col1 <- c(inferno(20), rep("#FFFFFF", 50))
plot.new()
for (b in 1:length(Mn_Ca_raster_list)) {
  par(mfrow=c(1,1),
                     mar=c(0.2,0.2,0.2,0.2),
                     oma=c(5,5,1,4),
                     bty = "n",
                     bg = "transparent")
plot(Mn_Ca_raster_list[[b]],col=(col1), interpolate=TRUE, axes = F, cex.axis=0.8, asp = 1.25, alpha = 0.6, breaks = seq(0,35,by = 0.5), zlim = c(0,35), legend = FALSE)
plot(Mn_Ca_raster_list[[b]], col =(inferno(20)), breaks = seq(0,10, by = 0.5), zlim = c(0,10), interpolate=T, axes = F, legend.args=list(text=" Mn/Ca (µmol/mol)", side=4, line=3,cex=0.8, las=0), legend.only = T)

mtext(paste0(names(Mn_Ca_raster_list[b]),"_viridis"), side = 3)

dev.copy(png, paste0(Rasterpath_viridis, names(Mn_Ca_raster_list[b]), "_inferno_interpolated.png"))
dev.off()
frame()
}

col3 <-wes_palette(24, name="FantasticFox1", type="continuous")
plot.new()
for (b in 1:length(P_Ca_raster_list)) {
  par(mfrow=c(1,1),
                     mar=c(0.2,0.2,0.2,0.2),
                     oma=c(5,5,1,4),
                     bty = "n",
                     bg = "transparent")
plot(P_Ca_raster_list[[b]],col=(col3), interpolate=TRUE, axes = F, cex.axis=0.8, asp = 1.25, alpha = 0.6, legend.args=list(text=" P/Ca (µmol/mol)", side=4, line=3,cex=0.8, las=0), breaks = seq(150,700,by = 25))
mtext(paste0(names(P_Ca_raster_list[b]),"_viridis"), side = 3)
dev.copy(png, paste0(Rasterpath_viridis, names(P_Ca_raster_list[b]), "_FF_interpolated.png"))
dev.off()
frame()
}

col2 <-viridis(40)
plot.new()
for (b in 1:length(S_Ca_raster_list)) {
  par(mfrow=c(1,1),
                     mar=c(0.2,0.2,0.2,0.2),
                     oma=c(5,5,1,4),
                     bty = "n",
                     bg = "transparent")
plot(S_Ca_raster_list[[b]],col=(col2), interpolate=TRUE, axes = F, cex.axis=0.8, asp = 1.25, alpha = 0.6, legend.args=list(text=" S/Ca (µmol/mol)", side=4, line=3,cex=0.8, las=0), breaks = seq(6000,12000,by = 150))
mtext(paste0(names(S_Ca_raster_list[b]),"_viridis"), side = 3)
dev.copy(png, paste0(Rasterpath_viridis, names(S_Ca_raster_list[b]), "_viridis_interpolated.png"))
dev.off()
frame()
}

col3 <-c(viridis(20),rep("#FFFFFF", 50))
plot.new()
for (b in 1:length(U_Ca_raster_list)) {
  par(mfrow=c(1,1),
                     mar=c(0.2,0.2,0.2,0.2),
                     oma=c(5,5,1,4),
                     bty = "n",
                     bg = "transparent")
plot(U_Ca_raster_list[[b]],col=(col3), interpolate=TRUE, axes = F, cex.axis=0.8, asp = 1.25, alpha = 0.6, breaks = seq(0,0.28,by = 0.004), zlim = c(0,0.28), legend = FALSE)
plot(U_Ca_raster_list[[b]], col =(col3), breaks = seq(0,0.08, by = 0.004), zlim = c(0,0.08), interpolate=T, axes = F, legend.args=list(text=" U/Ca (µmol/mol)", side=4, line=3,cex=0.8, las=0), legend.only = T)

mtext(paste0(names(U_Ca_raster_list[b]),"_viridis"), side = 3)

dev.copy(png, paste0(Rasterpath_viridis, names(U_Ca_raster_list[b]), "_DJ_interpolated.png"))
dev.off()
frame()
}

# for Ca43 ONLY ####


Ca43_rasters <- grep(paste0("*","_Ca43_counts_raster"),names(.GlobalEnv),value=TRUE)
Ca43_raster_list <-do.call("list",mget(Ca43_rasters))

col1 <-inferno(25)
plot.new()
for (b in 1:length(Ca43_raster_list)) {
  par(mfrow=c(1,1),
                     mar=c(0.2,0.2,0.2,0.2),
                     oma=c(5,5,1,4),
                     bty = "n",
                     bg = "transparent")
plot(Ca43_raster_list[[b]],col=(col1), interpolate=TRUE, axes = F, cex.axis=0.8, asp = 1.25, alpha = 0.6, legend.args=list(text=" Ca (counts per second)", side=4, line=4.5,cex=0.8, las=0), breaks = seq(4000000,9000000,by = 200000))
mtext(paste0(names(Ca43_raster_list[b]),"_viridis"), side = 3)
dev.copy(png, paste0(Rasterpath_viridis, names(Ca43_raster_list[b]), "_inferno_interpolated.png"))
dev.off()
frame()
}
```

```{r Intra & inter-individual reproducibility}

#Varability plots####
for(a in 1:length(Ratios)) {
  for(c in 1:length(Samples)) {
    patterns <- c(paste0(Samples[c],"_"), paste0(Ratios[a],"_variabilityplot"))
Sample_Variability_plots <- grep(paste0(patterns, collapse = ".*"),names(.GlobalEnv),value=TRUE)
Variability_plots_list <-do.call("list",mget(Sample_Variability_plots))
Variability_plots_list <- Variability_plots_list[order(names(Variability_plots_list))]
assign(paste0("Sample_",Samples[c]," ",Ratios[a], " Variability_plots_list"), Variability_plots_list)
  }
}
rm(Variability_plots_list)

## Sample 23-16 ####
plot_a_list(`Sample_23_16 B_Ca Variability_plots_list`, 3,1, ylim = c(100,300), xlim = c(1200,0), ylab = "B/Ca (µmol/mol)", xlab = "Distance (µm)")
plot_a_list(`Sample_23_16 Ba_Ca Variability_plots_list`, 3,1, ylim = c(5,20), xlim = c(1200,0), ylab = "Ba/Ca (µmol/mol)", xlab = "Distance (µm)")
plot_a_list(`Sample_23_16 Mg_Ca Variability_plots_list`, 3,1, ylim = c(60000,100000), xlim = c(1200,0), ylab = "Mg/Ca (µmol/mol)", xlab = "Distance (µm)")
plot_a_list(`Sample_23_16 Mg_Ca Variability_plots_list`, 3,1, ylim = c(60000,100000), xlim = c(1200,0), ylab = "Mg/Ca (µmol/mol)", xlab = "Distance (µm)")
plot_a_list(`Sample_23_16 Li_Ca Variability_plots_list`, 3,1, ylim = c(0,100), xlim = c(1200,0), ylab = "Li/Ca (µmol/mol)", xlab = "Distance (µm)")
plot_a_list(`Sample_23_16 Mn_Ca Variability_plots_list`, 3,1, ylim = c(0,80), xlim = c(1200,0), ylab = "Mn/Ca (µmol/mol)", xlab = "Distance (µm)")
plot_a_list(`Sample_23_16 Mn_Ca Variability_plots_list`, 3,1, ylim = c(0,5), xlim = c(1200,250), ylab = "Mn/Ca (µmol/mol)", xlab = "Distance (µm)")
plot_a_list(`Sample_23_16 P_Ca Variability_plots_list`, 3,1, ylim = c(150,800), xlim = c(1200,0), ylab = "P/Ca (µmol/mol)", xlab = "Distance (µm)")
plot_a_list(`Sample_23_16 S_Ca Variability_plots_list`, 3,1, ylim = c(5000,9000), xlim = c(1200,0), ylab = "S/Ca (µmol/mol)", xlab = "Distance (µm)")
plot_a_list(`Sample_23_16 Sr_Ca Variability_plots_list`, 3,1, ylim = c(2500,3500), xlim = c(1200,0), ylab = "Sr/Ca (µmol/mol)", xlab = "Distance (µm)")
plot_a_list(`Sample_23_16 U_Ca Variability_plots_list`, 3,1, ylim = c(0,0.08), xlim = c(1200,0), ylab = "U/Ca (µmol/mol)", xlab = "Distance (µm)")
plot_a_list(`Sample_23_16 U_Ca Variability_plots_list`, 3,1, ylim = c(0,0.02), xlim = c(1200,250), ylab = "U/Ca (µmol/mol)", xlab = "Distance (µm)")

## Sample 23-10 ####
plot_a_list(`Sample_23_10 B_Ca Variability_plots_list`, 3,1, ylim = c(100,300), xlim = c(1600,0), ylab = "B/Ca (µmol/mol)", xlab = "Distance (µm)")
plot_a_list(`Sample_23_10 Ba_Ca Variability_plots_list`, 3,1, ylim = c(5,15), xlim = c(1600,0), ylab = "Ba/Ca (µmol/mol)", xlab = "Distance (µm)")
plot_a_list(`Sample_23_10 Mg_Ca Variability_plots_list`, 3,1, ylim = c(60000,100000), xlim = c(1600,0), ylab = "Mg/Ca (µmol/mol)", xlab = "Distance (µm)")
plot_a_list(`Sample_23_10 Li_Ca Variability_plots_list`, 3,1, ylim = c(0,100), xlim = c(1600,0), ylab = "Li/Ca (µmol/mol)", xlab = "Distance (µm)")
plot_a_list(`Sample_23_10 Mn_Ca Variability_plots_list`, 3,1, ylim = c(0,25), xlim = c(1600,0), ylab = "Mn/Ca (µmol/mol)", xlab = "Distance (µm)")
plot_a_list(`Sample_23_10 Mn_Ca Variability_plots_list`, 3,1, ylim = c(0,5), xlim = c(1600,250), ylab = "Mn/Ca (µmol/mol)", xlab = "Distance (µm)")
plot_a_list(`Sample_23_10 P_Ca Variability_plots_list`, 3,1, ylim = c(150,800), xlim = c(1600,0), ylab = "P/Ca (µmol/mol)", xlab = "Distance (µm)")
plot_a_list(`Sample_23_10 S_Ca Variability_plots_list`, 3,1, ylim = c(6500,12000), xlim = c(1600,0), ylab = "S/Ca (µmol/mol)", xlab = "Distance (µm)")
plot_a_list(`Sample_23_10 Sr_Ca Variability_plots_list`, 3,1, ylim = c(2800,4000), xlim = c(1600,0), ylab = "Sr/Ca (µmol/mol)", xlab = "Distance (µm)")
plot_a_list(`Sample_23_10 U_Ca Variability_plots_list`, 3,1, ylim = c(0,0.1), xlim = c(1600,0), ylab = "U/Ca (µmol/mol)", xlab = "Distance (µm)")
plot_a_list(`Sample_23_10 U_Ca Variability_plots_list`, 3,1, ylim = c(0,0.025), xlim = c(1600,250), ylab = "U/Ca (µmol/mol)", xlab = "Distance (µm)")

## Sample 23-6 ####
plot_a_list(`Sample_23_6 B_Ca Variability_plots_list`, 3,1, ylim = c(100,250), xlim = c(3500,0), ylab = "B/Ca (µmol/mol)", xlab = "Distance (µm)")
plot_a_list(`Sample_23_6 Ba_Ca Variability_plots_list`, 3,1, ylim = c(5,15), xlim = c(3500,0), ylab = "Ba/Ca (µmol/mol)", xlab = "Distance (µm)")
plot_a_list(`Sample_23_6 Mg_Ca Variability_plots_list`, 3,1, ylim = c(60000,100000), xlim = c(3500,0), ylab = "Mg/Ca (µmol/mol)", xlab = "Distance (µm)")
plot_a_list(`Sample_23_6 Li_Ca Variability_plots_list`, 3,1, ylim = c(0,75), xlim = c(3500,0), ylab = "Li/Ca (µmol/mol)", xlab = "Distance (µm)")
plot_a_list(`Sample_23_6 Mn_Ca Variability_plots_list`, 3,1, ylim = c(0,20), xlim = c(3500,0), ylab = "Mn/Ca (µmol/mol)", xlab = "Distance (µm)")
plot_a_list(`Sample_23_6 Mn_Ca Variability_plots_list`, 3,1, ylim = c(0,5), xlim = c(-3500,250), ylab = "Mn/Ca (µmol/mol)", xlab = "Distance (µm)")
plot_a_list(`Sample_23_6 P_Ca Variability_plots_list`, 3,1, ylim = c(150,600), xlim = c(3500,0), ylab = "P/Ca (µmol/mol)", xlab = "Distance (µm)")
plot_a_list(`Sample_23_6 S_Ca Variability_plots_list`, 3,1, ylim = c(6000,10000), xlim = c(3500,0), ylab = "S/Ca (µmol/mol)", xlab = "Distance (µm)")
plot_a_list(`Sample_23_6 Sr_Ca Variability_plots_list`, 3,1, ylim = c(2900,3500), xlim = c(3500,0), ylab = "Sr/Ca (µmol/mol)", xlab = "Distance (µm)")
plot_a_list(`Sample_23_6 U_Ca Variability_plots_list`, 3,1, ylim = c(0,0.05), xlim = c(3500,0), ylab = "U/Ca (µmol/mol)", xlab = "Distance (µm)")
plot_a_list(`Sample_23_6 U_Ca Variability_plots_list`, 3,1, ylim = c(0,0.025), xlim = c(3500,250), ylab = "U/Ca (µmol/mol)", xlab = "Distance (µm)")

## Sample 23-1 ####
plot_a_list(`Sample_23_1 B_Ca Variability_plots_list`, 3,1, ylim = c(100,300), xlim = c(1600,0), ylab = "B/Ca (µmol/mol)", xlab = "Distance (µm)")
plot_a_list(`Sample_23_1 Ba_Ca Variability_plots_list`, 3,1, ylim = c(5,20), xlim = c(1600,0), ylab = "Ba/Ca (µmol/mol)", xlab = "Distance (µm)")
plot_a_list(`Sample_23_1 Mg_Ca Variability_plots_list`, 3,1, ylim = c(60000,100000), xlim = c(1600,0), ylab = "Mg/Ca (µmol/mol)", xlab = "Distance (µm)")
plot_a_list(`Sample_23_1 Li_Ca Variability_plots_list`, 3,1, ylim = c(0,100), xlim = c(1600,0), ylab = "Li/Ca (µmol/mol)", xlab = "Distance (µm)")
plot_a_list(`Sample_23_1 Mn_Ca Variability_plots_list`, 3,1, ylim = c(0,30), xlim = c(1600,0), ylab = "Mn/Ca (µmol/mol)", xlab = "Distance (µm)")
plot_a_list(`Sample_23_1 Mn_Ca Variability_plots_list`, 3,1, ylim = c(0,5), xlim = c(1600,250), ylab = "Mn/Ca (µmol/mol)", xlab = "Distance (µm)")
plot_a_list(`Sample_23_1 P_Ca Variability_plots_list`, 3,1, ylim = c(150,700), xlim = c(1600,0), ylab = "P/Ca (µmol/mol)", xlab = "Distance (µm)")
plot_a_list(`Sample_23_1 S_Ca Variability_plots_list`, 3,1, ylim = c(6500,10000), xlim = c(1600,0), ylab = "S/Ca (µmol/mol)", xlab = "Distance (µm)")
plot_a_list(`Sample_23_1 Sr_Ca Variability_plots_list`, 3,1, ylim = c(3000,3400), xlim = c(-1600,0), ylab = "Sr/Ca (µmol/mol)", xlab = "Distance (µm)")
plot_a_list(`Sample_23_1 U_Ca Variability_plots_list`, 3,1, ylim = c(0,0.05), xlim = c(1600,0), ylab = "U/Ca (µmol/mol)", xlab = "Distance (µm)")
plot_a_list(`Sample_23_1 U_Ca Variability_plots_list`, 3,1, ylim = c(0,0.02), xlim = c(1600,250), ylab = "U/Ca (µmol/mol)", xlab = "Distance (µm)")

# Element vs element plots####
Sample_element_patterns_list <- list()
Ratios_folder_path <- paste0("~/OneDrive - University of Southampton/PhD, INSPIRE DTP/Countries_Chapters/UK [Soton]/Chpt4 Bamboo Coral Analysis/LAICPMS/Data_R_processed/NIST612_Corrected_Element_ratios/")
c <- 1
b <- 1
i <- 1
j <- 1

for(c in 1:length(Samples)) { # 4 samples
   for(b in 1:3) { # 3 sections
     cat("Sample: ", Samples[c], b, "\n")
    patterns <- c(paste0(Samples[c],"_",b), "_patterndata")
Section_element_patterns <- grep(paste0(patterns, collapse = ".*"),names(.GlobalEnv),value=TRUE)
Section_element_patterns_list <-do.call("list",mget(Section_element_patterns))
for(i in 1:length(Section_element_patterns_list)) {
  Tracks_element_patterns_list <- list()
  for(j in 1:5){
  Tracks_element_patterns_list[[j]] <- Section_element_patterns_list[[i]][c(j,6)]
  Data_name <- names(Section_element_patterns_list[i])
  Element_name <- sub(paste0("Sample_",Samples[c],"_",b,"_"), "", Data_name)
  Element_name <- sub("_patterndata", "", Element_name)
  colnames(Tracks_element_patterns_list[[j]]) <- c(Element_name, "distance.um")
  Tracks_element_patterns_list[[j]] <- Tracks_element_patterns_list[[j]] %>%
    mutate(Track = j)
  }
  Section_element_patterns_list[[i]] <- Tracks_element_patterns_list %>%
    reduce(full_join , by = c("distance.um", "Track", Element_name)) 
}
Section_element_pattern_data <- Section_element_patterns_list %>%
  reduce(full_join, by = c("distance.um", "Track")) %>% 
  mutate(Internode = b) 
assign(paste0("Sample_",Samples[c]," ",b, " element_patterns_data"), Section_element_pattern_data)
Sample_element_patterns_list[[paste0("Sample_",Samples[c]," ",b, " element_patterns_data")]] <- Section_element_pattern_data
   }
   
   cat("Sample: ", Samples[c], "combining internodes...", "\n")
   
   Sample_element_patterns_data <- Sample_element_patterns_list[grep(paste0(Samples[c]), names(Sample_element_patterns_list))] %>%
     reduce(full_join, by = c("distance.um", 
                              "Mg_Ca","Mn_Ca", 
                              "Ba_Ca","Sr_Ca", 
                              "P_Ca","U_Ca",
                              "B_Ca","Li_Ca",
                              "S_Ca","Li_Mg", 
                              "Internode", 
                              "Track")) 
   
      Sample_element_patterns_data <- Sample_element_patterns_data[, c("distance.um","Internode","Track","Li_Mg","Li_Ca","B_Ca","Mg_Ca","P_Ca","S_Ca","Mn_Ca","Sr_Ca","Ba_Ca","U_Ca")]
      
      
   my_fn <- function(data, mapping, ...){
      p <- data %>%
        ggplot(data = data, mapping = mapping) + 
        geom_point(show.legend = T, na.rm = T, alpha =0.4) +
        # scale_color_manual(values = c("red", "green",  "blue"), name = "Internode") +
        # scale_shape_manual(values = c(21,22,24), name = "Internode") +
        theme_classic()
      p
   }

   # All element ratios    
   Sample_element_patterns_ggpairs_internode <- ggpairs(Sample_element_patterns_data, columns = c(4:13), 
           aes(color = as.factor(Internode), pch = as.factor(Internode), alpha = 0.6),
           title = paste0("Sample ",Samples[c], " element ratios [by internode]  (µmol/mol)"),
           legend = 1,
           lower = list(continuous = my_fn), 
           diag = list(continuous = "densityDiag", alpha = 0.6),
           upper = list(continuous = wrap("cor", method = "spearman", size = 2.5))) +
           scale_color_manual(values = c("red", "green",  "blue")) +
           theme(legend.position = "bottom", axis.text.x.bottom = element_text(size = 6, angle = 45, vjust = 1, hjust=1)) +
     labs(fill = "Internode", color = "Internode")
   

    Sample_element_patterns_ggpairs_internode[1,1] <- Sample_element_patterns_ggpairs_internode[1,1] +
        scale_fill_manual(values=c("red", "green", "blue"))
    Sample_element_patterns_ggpairs_internode[2,2] <- Sample_element_patterns_ggpairs_internode[2,2] +
        scale_fill_manual(values=c("red", "green", "blue")) 
    Sample_element_patterns_ggpairs_internode[3,3] <- Sample_element_patterns_ggpairs_internode[3,3] +
        scale_fill_manual(values=c("red", "green", "blue"))
    Sample_element_patterns_ggpairs_internode[4,4] <- Sample_element_patterns_ggpairs_internode[4,4] +
        scale_fill_manual(values=c("red", "green", "blue")) 
    Sample_element_patterns_ggpairs_internode[5,5] <- Sample_element_patterns_ggpairs_internode[5,5] +
        scale_fill_manual(values=c("red", "green", "blue")) 
    Sample_element_patterns_ggpairs_internode[6,6] <- Sample_element_patterns_ggpairs_internode[6,6] +
        scale_fill_manual(values=c("red", "green", "blue"))
    Sample_element_patterns_ggpairs_internode[7,7] <- Sample_element_patterns_ggpairs_internode[7,7] +
        scale_fill_manual(values=c("red", "green", "blue")) 
    Sample_element_patterns_ggpairs_internode[8,8] <- Sample_element_patterns_ggpairs_internode[8,8] +
        scale_fill_manual(values=c("red", "green", "blue")) 
    Sample_element_patterns_ggpairs_internode[9,9] <- Sample_element_patterns_ggpairs_internode[9,9] +
        scale_fill_manual(values=c("red", "green", "blue")) 
    Sample_element_patterns_ggpairs_internode[9,9] <- Sample_element_patterns_ggpairs_internode[10,10] +
        scale_fill_manual(values=c("red", "green", "blue")) 
    
   assign(paste0("Sample_",Samples[c]," element ratios [by internode]"), Sample_element_patterns_ggpairs_internode)
   rm(Sample_element_patterns_ggpairs_internode)
   

   # Li, Mg, Sr, Ba and U
      Sample_Tempproxy_element_patterns_ggpairs_internode <- ggpairs(Sample_element_patterns_data, columns = c(4,5,7,11,12,13), 
           aes(color = as.factor(Internode), pch = as.factor(Internode), fill = as.factor(Internode), linetype = as.factor(Internode)),
           legend = 1,
           lower = list(continuous = my_fn), 
           diag = list(continuous = wrap("densityDiag", alpha = 0.6)),
           upper = list(continuous = wrap("cor", method = "spearman", size = 4)),
           columnLabels = c("Li/Mg", "Li/Ca", "Mg/Ca", "Sr/Ca", "Ba/Ca", "U/Ca"),
           labeller = "label_parsed") +
           scale_color_manual(values = c("red", "green",  "blue")) +
           scale_shape_manual(values = c(21,22,24), name = "Internode") +
           scale_linetype_manual(values = c(1,2,3), name = "Internode") +
           theme(legend.position = "bottom", axis.text.x.bottom = element_text(size = 9, angle = 45, vjust = 1, hjust=1),
                 strip.placement = "outside", text = element_text(size = 12)) +
     labs(fill = "Internode", color = "Internode")
   

    Sample_Tempproxy_element_patterns_ggpairs_internode[1,1] <- Sample_Tempproxy_element_patterns_ggpairs_internode[1,1] + scale_x_continuous(limits = c(0,1.5)) + theme_classic()
    Sample_Tempproxy_element_patterns_ggpairs_internode[1,2] <- Sample_Tempproxy_element_patterns_ggpairs_internode[1,2] + theme(panel.ontop = T, panel.background = element_rect(fill = "black"))
    Sample_Tempproxy_element_patterns_ggpairs_internode[1,3] <- Sample_Tempproxy_element_patterns_ggpairs_internode[1,3] + theme(panel.ontop = T, panel.background = element_rect(fill = "black"))
    Sample_Tempproxy_element_patterns_ggpairs_internode[2,1] <- Sample_Tempproxy_element_patterns_ggpairs_internode[2,1] + scale_x_continuous(limits = c(0,1.5)) + scale_y_continuous(limits = c(0,120)) + theme_classic() + theme(panel.ontop = T, panel.background = element_rect(fill = "black"))
    Sample_Tempproxy_element_patterns_ggpairs_internode[2,2] <- Sample_Tempproxy_element_patterns_ggpairs_internode[2,2] + scale_x_continuous(limits = c(0,120)) + theme_classic()
    Sample_Tempproxy_element_patterns_ggpairs_internode[3,1] <- Sample_Tempproxy_element_patterns_ggpairs_internode[3,1] + scale_x_continuous(limits = c(0,1.5)) + scale_y_continuous(limits = c(40000,140000)) + theme(panel.ontop = T, panel.background = element_rect(fill = "black"))  
    Sample_Tempproxy_element_patterns_ggpairs_internode[3,2] <- Sample_Tempproxy_element_patterns_ggpairs_internode[3,2] + scale_x_continuous(limits = c(0,120)) + scale_y_continuous(limits = c(40000,140000)) 
    Sample_Tempproxy_element_patterns_ggpairs_internode[3,3] <- Sample_Tempproxy_element_patterns_ggpairs_internode[3,3] + scale_x_continuous(limits = c(40000,140000)) + theme_classic()
    Sample_Tempproxy_element_patterns_ggpairs_internode[4,1] <- Sample_Tempproxy_element_patterns_ggpairs_internode[4,1] + scale_x_continuous(limits = c(0,1.5)) + scale_y_continuous(limits = c(2000,5000))     
    Sample_Tempproxy_element_patterns_ggpairs_internode[4,2] <- Sample_Tempproxy_element_patterns_ggpairs_internode[4,2] + scale_x_continuous(limits = c(0,120)) + scale_y_continuous(limits = c(2000,5000)) 
    Sample_Tempproxy_element_patterns_ggpairs_internode[4,3] <- Sample_Tempproxy_element_patterns_ggpairs_internode[4,3] + scale_x_continuous(limits = c(40000,140000)) + scale_y_continuous(limits = c(2000,5000)) 
    Sample_Tempproxy_element_patterns_ggpairs_internode[4,4] <- Sample_Tempproxy_element_patterns_ggpairs_internode[4,4] + scale_x_continuous(limits = c(2000,5000)) + theme_classic() 
    Sample_Tempproxy_element_patterns_ggpairs_internode[5,1] <- Sample_Tempproxy_element_patterns_ggpairs_internode[5,1] + scale_x_continuous(limits = c(0,1.5)) + scale_y_continuous(limits = c(0,50))
    Sample_Tempproxy_element_patterns_ggpairs_internode[5,2] <- Sample_Tempproxy_element_patterns_ggpairs_internode[5,2] + scale_x_continuous(limits = c(0,120)) + scale_y_continuous(limits = c(0,50))
    Sample_Tempproxy_element_patterns_ggpairs_internode[5,3] <- Sample_Tempproxy_element_patterns_ggpairs_internode[5,3] + scale_x_continuous(limits = c(40000,140000)) + scale_y_continuous(limits = c(0,50))
    Sample_Tempproxy_element_patterns_ggpairs_internode[5,4] <- Sample_Tempproxy_element_patterns_ggpairs_internode[5,4] + scale_x_continuous(limits = c(2000,5000)) + scale_y_continuous(limits = c(0,50))
    Sample_Tempproxy_element_patterns_ggpairs_internode[5,5] <- Sample_Tempproxy_element_patterns_ggpairs_internode[5,5] + scale_x_continuous(limits = c(0,50)) + theme_classic()
    Sample_Tempproxy_element_patterns_ggpairs_internode[6,1] <- Sample_Tempproxy_element_patterns_ggpairs_internode[6,1] + scale_x_continuous(limits = c(0,1.5)) + scale_y_continuous(limits = c(0,0.15))    
    Sample_Tempproxy_element_patterns_ggpairs_internode[6,2] <- Sample_Tempproxy_element_patterns_ggpairs_internode[6,2] + scale_x_continuous(limits = c(0,120)) + scale_y_continuous(limits = c(0,0.15))
    Sample_Tempproxy_element_patterns_ggpairs_internode[6,3] <- Sample_Tempproxy_element_patterns_ggpairs_internode[6,3] + scale_x_continuous(limits = c(40000,140000)) + scale_y_continuous(limits = c(0,0.15))
    Sample_Tempproxy_element_patterns_ggpairs_internode[6,4] <- Sample_Tempproxy_element_patterns_ggpairs_internode[6,4] + scale_x_continuous(limits = c(2000,5000)) + scale_y_continuous(limits = c(0,0.15))
    Sample_Tempproxy_element_patterns_ggpairs_internode[6,5] <- Sample_Tempproxy_element_patterns_ggpairs_internode[6,5] + scale_x_continuous(limits = c(0,50)) + scale_y_continuous(limits = c(0,0.15)) 

    Sample_Tempproxy_element_patterns_ggpairs_internode[1,1] <- Sample_Tempproxy_element_patterns_ggpairs_internode[1,1] + scale_x_continuous(limits = c(0,2)) + theme_classic()
    Sample_Tempproxy_element_patterns_ggpairs_internode[1,2] <- Sample_Tempproxy_element_patterns_ggpairs_internode[1,2] + theme(panel.ontop = T, panel.background = element_rect(fill = "black"))
    Sample_Tempproxy_element_patterns_ggpairs_internode[1,3] <- Sample_Tempproxy_element_patterns_ggpairs_internode[1,3] + theme(panel.ontop = T, panel.background = element_rect(fill = "black"))
    Sample_Tempproxy_element_patterns_ggpairs_internode[2,1] <- Sample_Tempproxy_element_patterns_ggpairs_internode[2,1] + scale_x_continuous(limits = c(0,2)) + scale_y_continuous(limits = c(0,120)) + theme_classic() + theme(panel.ontop = T, panel.background = element_rect(fill = "black"))
    Sample_Tempproxy_element_patterns_ggpairs_internode[2,2] <- Sample_Tempproxy_element_patterns_ggpairs_internode[2,2] + scale_x_continuous(limits = c(0,120)) + theme_classic()
    Sample_Tempproxy_element_patterns_ggpairs_internode[3,1] <- Sample_Tempproxy_element_patterns_ggpairs_internode[3,1] + scale_x_continuous(limits = c(0,2)) + scale_y_continuous(limits = c(40000,130000)) + theme(panel.ontop = T, panel.background = element_rect(fill = "black"))  
    Sample_Tempproxy_element_patterns_ggpairs_internode[3,2] <- Sample_Tempproxy_element_patterns_ggpairs_internode[3,2] + scale_x_continuous(limits = c(0,120)) + scale_y_continuous(limits = c(40000,130000)) 
    Sample_Tempproxy_element_patterns_ggpairs_internode[3,3] <- Sample_Tempproxy_element_patterns_ggpairs_internode[3,3] + scale_x_continuous(limits = c(40000,130000)) + theme_classic()
    Sample_Tempproxy_element_patterns_ggpairs_internode[4,1] <- Sample_Tempproxy_element_patterns_ggpairs_internode[4,1] + scale_x_continuous(limits = c(0,2)) + scale_y_continuous(limits = c(3000,15000))     
    Sample_Tempproxy_element_patterns_ggpairs_internode[4,2] <- Sample_Tempproxy_element_patterns_ggpairs_internode[4,2] + scale_x_continuous(limits = c(0,120)) + scale_y_continuous(limits = c(3000,15000)) 
    Sample_Tempproxy_element_patterns_ggpairs_internode[4,3] <- Sample_Tempproxy_element_patterns_ggpairs_internode[4,3] + scale_x_continuous(limits = c(40000,130000)) + scale_y_continuous(limits = c(3000,15000)) 
    Sample_Tempproxy_element_patterns_ggpairs_internode[4,4] <- Sample_Tempproxy_element_patterns_ggpairs_internode[4,4] + scale_x_continuous(limits = c(3000,15000)) + theme_classic()
    Sample_Tempproxy_element_patterns_ggpairs_internode[5,1] <- Sample_Tempproxy_element_patterns_ggpairs_internode[5,1] + scale_x_continuous(limits = c(0,2)) + scale_y_continuous(limits = c(2000,5000))     
    Sample_Tempproxy_element_patterns_ggpairs_internode[5,2] <- Sample_Tempproxy_element_patterns_ggpairs_internode[5,2] + scale_x_continuous(limits = c(0,120)) + scale_y_continuous(limits = c(2000,5000)) 
    Sample_Tempproxy_element_patterns_ggpairs_internode[5,3] <- Sample_Tempproxy_element_patterns_ggpairs_internode[5,3] + scale_x_continuous(limits = c(40000,130000)) + scale_y_continuous(limits = c(2000,5000)) 
    Sample_Tempproxy_element_patterns_ggpairs_internode[5,4] <- Sample_Tempproxy_element_patterns_ggpairs_internode[5,4] + scale_x_continuous(limits = c(3000,15000)) + scale_y_continuous(limits = c(2000,5000)) 
    Sample_Tempproxy_element_patterns_ggpairs_internode[5,5] <- Sample_Tempproxy_element_patterns_ggpairs_internode[5,5] + scale_x_continuous(limits = c(2000,5000)) + theme_classic()
    Sample_Tempproxy_element_patterns_ggpairs_internode[6,1] <- Sample_Tempproxy_element_patterns_ggpairs_internode[6,1] + scale_x_continuous(limits = c(0,2)) + scale_y_continuous(limits = c(0,0.15))    
    Sample_Tempproxy_element_patterns_ggpairs_internode[6,2] <- Sample_Tempproxy_element_patterns_ggpairs_internode[6,2] + scale_x_continuous(limits = c(0,120)) + scale_y_continuous(limits = c(0,0.15))
    Sample_Tempproxy_element_patterns_ggpairs_internode[6,3] <- Sample_Tempproxy_element_patterns_ggpairs_internode[6,3] + scale_x_continuous(limits = c(40000,130000)) + scale_y_continuous(limits = c(0,0.15))
    Sample_Tempproxy_element_patterns_ggpairs_internode[6,4] <- Sample_Tempproxy_element_patterns_ggpairs_internode[6,4] + scale_x_continuous(limits = c(3000,15000)) + scale_y_continuous(limits = c(0,0.15))
    Sample_Tempproxy_element_patterns_ggpairs_internode[6,5] <- Sample_Tempproxy_element_patterns_ggpairs_internode[6,5] + scale_x_continuous(limits = c(2000,5000)) + scale_y_continuous(limits = c(0,0.15)) 

    Sample_Tempproxy_element_patterns_ggpairs_internode[6,6] <- Sample_Tempproxy_element_patterns_ggpairs_internode[6,6] + scale_x_continuous(limits = c(0,0.15)) + theme_classic()

    
   assign(paste0("Sample_",Samples[c]," Temp proxy element ratios [by internode]"), Sample_Tempproxy_element_patterns_ggpairs_internode)
   rm(Sample_Tempproxy_element_patterns_ggpairs_internode)
   
   


      # Ba vs Li, Mg, Sr, S and U
      Sample_Ba_patterns_ggpairs_internode <- ggpairs(Sample_element_patterns_data, columns = c(5,7,9,11,13,12), 
           aes(color = as.factor(Internode), pch = as.factor(Internode), fill = as.factor(Internode), linetype = as.factor(Internode)),
           legend = 1,
           lower = list(continuous = my_fn), 
           diag = list(continuous = wrap("densityDiag", alpha = 0.6)),
           upper = list(continuous = wrap("cor", method = "spearman", size = 4)),
           columnLabels = c("Li/Ca", "Mg/Ca", "S/Ca", "Sr/Ca", "U/Ca", "Ba/Ca"),
           labeller = "label_parsed") +
           scale_color_manual(values = c("red", "green",  "blue")) +
           scale_shape_manual(values = c(21,22,24), name = "Internode") +
           scale_linetype_manual(values = c(1,2,3), name = "Internode") +
           theme(legend.position = "bottom", axis.text.x.bottom = element_text(size = 9, angle = 45, vjust = 1, hjust=1),
                 strip.placement = "outside", text = element_text(size = 12), axis.text.y.left = element_blank(), axis.ticks.y.left = element_blank()) +
     labs(fill = "Internode", color = "Internode")
   

    Sample_Ba_patterns_ggpairs_internode[1,1] <- Sample_Ba_patterns_ggpairs_internode[1,1] + theme_classic()
    Sample_Ba_patterns_ggpairs_internode[2,2] <- Sample_Ba_patterns_ggpairs_internode[2,2] + theme_classic()
    Sample_Ba_patterns_ggpairs_internode[3,3] <- Sample_Ba_patterns_ggpairs_internode[3,3] + theme_classic()
    Sample_Ba_patterns_ggpairs_internode[4,4] <- Sample_Ba_patterns_ggpairs_internode[4,4] + theme_classic()
    Sample_Ba_patterns_ggpairs_internode[5,5] <- Sample_Ba_patterns_ggpairs_internode[5,5] + theme_classic()
    Sample_Ba_patterns_ggpairs_internode[6,6] <- Sample_Ba_patterns_ggpairs_internode[6,6] + theme_classic()
    
    plots <- lapply(1:Sample_Ba_patterns_ggpairs_internode$nrow, function(i) getPlot(Sample_Ba_patterns_ggpairs_internode, i = i, j = 6))
    
    Sample_Ba_patterns_ggpairs_internode <- ggmatrix(plots,
    nrow = Sample_Ba_patterns_ggpairs_internode$nrow,
    ncol = 6,
    xAxisLabels = "Ba/Ca",
    yAxisLabels = Sample_Ba_patterns_ggpairs_internode$yAxisLabels)
    
   assign(paste0("Sample_",Samples[c]," Ba/Ca vs TE Spearman cor [by internode]"), Sample_Ba_patterns_ggpairs_internode)
   rm(Sample_Ba_patterns_ggpairs_internode)
   
   Sample_Ba_patterns_ggpairs_internode <- ggpairs(Sample_element_patterns_data, columns = c(4,6,8,10,12,11), 
           aes(color = as.factor(Internode), pch = as.factor(Internode), fill = as.factor(Internode), linetype = as.factor(Internode)),
           legend = 1,
           lower = list(continuous = my_fn), 
           diag = list(continuous = wrap("densityDiag", alpha = 0.6)),
           upper = list(continuous = wrap("cor", method = "pearson", size = 4)),
           columnLabels = c("Li/Ca", "Mg/Ca", "S/Ca", "Sr/Ca", "U/Ca", "Ba/Ca"),
           labeller = "label_parsed") +
           scale_color_manual(values = c("red", "green",  "blue")) +
           scale_shape_manual(values = c(21,22,24), name = "Internode") +
           scale_linetype_manual(values = c(1,2,3), name = "Internode") +
           theme(legend.position = "bottom", axis.text.x.bottom = element_text(size = 9, angle = 45, vjust = 1, hjust=1),
                 strip.placement = "outside", text = element_text(size = 12), axis.text.y.left = element_blank(), axis.ticks.y.left = element_blank()) +
     labs(fill = "Internode", color = "Internode")
   

    Sample_Ba_patterns_ggpairs_internode[1,1] <- Sample_Ba_patterns_ggpairs_internode[1,1] + theme_classic()
    Sample_Ba_patterns_ggpairs_internode[2,2] <- Sample_Ba_patterns_ggpairs_internode[2,2] + theme_classic()
    Sample_Ba_patterns_ggpairs_internode[3,3] <- Sample_Ba_patterns_ggpairs_internode[3,3] + theme_classic()
    Sample_Ba_patterns_ggpairs_internode[4,4] <- Sample_Ba_patterns_ggpairs_internode[4,4] + theme_classic()
    Sample_Ba_patterns_ggpairs_internode[5,5] <- Sample_Ba_patterns_ggpairs_internode[5,5] + theme_classic()
    Sample_Ba_patterns_ggpairs_internode[6,6] <- Sample_Ba_patterns_ggpairs_internode[6,6] + theme_classic()
    
    plots <- lapply(1:Sample_Ba_patterns_ggpairs_internode$nrow, function(i) getPlot(Sample_Ba_patterns_ggpairs_internode, i = i, j = 6))
    
    Sample_Ba_patterns_ggpairs_internode <- ggmatrix(plots,
    nrow = Sample_Ba_patterns_ggpairs_internode$nrow,
    ncol = 6,
    xAxisLabels = "Ba/Ca",
    yAxisLabels = Sample_Ba_patterns_ggpairs_internode$yAxisLabels)
    
   assign(paste0("Sample_",Samples[c]," Ba/Ca vs TE Pearson cor [by internode]"), Sample_Ba_patterns_ggpairs_internode)
   rm(Sample_Ba_patterns_ggpairs_internode)
   

   my_fn <- function(data, mapping, ...){
      p <- ggplot(data = data, mapping = mapping) + 
        geom_point(show.legend = T, na.rm = T, alpha =0.4) +
  theme_classic()
      p
   }
   
   # All element ratios
      Sample_element_patterns_ggpairs <- ggpairs(Sample_element_patterns_data, columns = c(4:13), 
           title = paste0("Sample ",Samples[c], " element ratios  (µmol/mol)"),
           lower = list(continuous = my_fn), 
           upper = list(continuous = "blank")) +
        theme(axis.text.x.bottom = element_text(size = 6, angle = 45, vjust = 1, hjust=1))
  
    assign(paste0("Sample_",Samples[c]," element ratios"), Sample_element_patterns_ggpairs)
    rm(Sample_element_patterns_ggpairs)
  
    # Li, Mg, Sr, S and U
        Sample_Tempproxy_element_patterns_ggpairs <- ggpairs(Sample_element_patterns_data, columns = c(4,5,7,9,11,13), 
           title = paste0("Sample ",Samples[c], " element ratios  (µmol/mol)"),
           lower = list(continuous = my_fn), 
           upper = list(continuous = "blank")) +
        theme(axis.text.x.bottom = element_text(size = 6, angle = 45, vjust = 1, hjust=1))
  
    assign(paste0("Sample_",Samples[c]," Temp proxy element ratios"), Sample_Tempproxy_element_patterns_ggpairs)
    rm(Sample_Tempproxy_element_patterns_ggpairs)
  }

#Ratio vs ratio plots ####
# `Sample_23_16 element ratios` # missing legend for geom_bins
# 
# ggsave(
#   "Sample_23_16 element ratios.tiff",
#   plot = `Sample_23_16 element ratios`,
#   path = Ratios_folder_path,
#   scale = 1,
#   width = 20,
#   height = 20,
#   units = "cm",
#   dpi = 300,
# )

`Sample_23_16 Temp proxy element ratios` # missing legend for geom_bins

ggsave(
  "Sample_23_16 Temp proxy element ratios.tiff",
  plot = `Sample_23_16 Temp proxy element ratios`,
  path = Ratios_folder_path,
  scale = 1,
  width = 20,
  height = 20,
  units = "cm",
  dpi = 300,
)


# `Sample_23_16 element ratios [by internode]` # missing legend for geom_bins
# 
# ggsave(
#   "Sample_23_16 element ratios [by internode].tiff",
#   plot = `Sample_23_16 element ratios [by internode]`,
#   path = Ratios_folder_path,
#   scale = 1,
#   width = 20,
#   height = 20,
#   units = "cm",
#   dpi = 300,
# )

`Sample_23_16 Temp proxy element ratios [by internode]` # missing legend for geom_bins

`Sample_23_16 Temp proxy element ratios` # missing legend for geom_bins

ggsave(
  "Sample_23_16 Temp proxy element ratios.tiff",
  plot = `Sample_23_16 Temp proxy element ratios`,
  path = Ratios_folder_path,
  scale = 1,
  width = 20,
  height = 20,
  units = "cm",
  dpi = 300,
)

`Sample_23_16 element ratios [by internode]` # missing legend for geom_bins


ggsave(
  "Sample_23_16 Temp proxy element ratios [by internode].tiff",
  plot = `Sample_23_16 Temp proxy element ratios [by internode]`,
  path = Ratios_folder_path,
  scale = 1,
  width = 20,
  height = 20,
  units = "cm",
  dpi = 300,
)


# `Sample_23_10 element ratios` # missing legend for geom_bins
# 
# ggsave(
#   "Sample_23_10 element ratios.tiff",
#   plot = `Sample_23_10 element ratios`,
#   path = Ratios_folder_path,
#   scale = 1,
#   width = 20,
#   height = 20,
#   units = "cm",
#   dpi = 300,
# )

`Sample_23_10 Temp proxy element ratios` # missing legend for geom_bins

`Sample_23_16 Temp proxy element ratios [by internode]` # missing legend for geom_bins

ggsave(
  "Sample_23_16 Temp proxy element ratios [by internode].tiff",
  plot = `Sample_23_16 Temp proxy element ratios [by internode]`,
  path = Ratios_folder_path,
  scale = 1,
  width = 20,
  height = 20,
  units = "cm",
  dpi = 300,
)

`Sample_23_10 element ratios` # missing legend for geom_bins


ggsave(
  "Sample_23_10 Temp proxy element ratios.tiff",
  plot = `Sample_23_10 Temp proxy element ratios`,
  path = Ratios_folder_path,
  scale = 1,
  width = 20,
  height = 20,
  units = "cm",
  dpi = 300,
)


# `Sample_23_10 element ratios [by internode]` # missing legend for geom_bins
# 
# ggsave(
#   "Sample_23_10 element ratios [by internode].tiff",
#   plot = `Sample_23_10 element ratios [by internode]`,
#   path = Ratios_folder_path,
#   scale = 1,
#   width = 20,
#   height = 20,
#   units = "cm",
#   dpi = 300,
# )

`Sample_23_10 Temp proxy element ratios [by internode]` # missing legend for geom_bins

`Sample_23_10 Temp proxy element ratios` # missing legend for geom_bins

ggsave(
  "Sample_23_10 Temp proxy element ratios.tiff",
  plot = `Sample_23_10 Temp proxy element ratios`,
  path = Ratios_folder_path,
  scale = 1,
  width = 20,
  height = 20,
  units = "cm",
  dpi = 300,
)

`Sample_23_10 element ratios [by internode]` # missing legend for geom_bins

ggsave(
  "Sample_23_10 element ratios [by internode].tiff",
  plot = `Sample_23_10 element ratios [by internode]`,
  path = Ratios_folder_path,
  scale = 1,
  width = 20,
  height = 20,
  units = "cm",
  dpi = 300,
)


# `Sample_23_6 element ratios` # missing legend for geom_bins
# 
# ggsave(
#   "Sample_23_6 element ratios.tiff",
#   plot = `Sample_23_6 element ratios`,
#   path = Ratios_folder_path,
#   scale = 1,
#   width = 20,
#   height = 20,
#   units = "cm",
#   dpi = 300,
# )

`Sample_23_6 Temp proxy element ratios` # missing legend for geom_bins

`Sample_23_10 Temp proxy element ratios [by internode]` # missing legend for geom_bins

ggsave(
  "Sample_23_10 Temp proxy element ratios [by internode].tiff",
  plot = `Sample_23_10 Temp proxy element ratios [by internode]`,
  path = Ratios_folder_path,
  scale = 1,
  width = 20,
  height = 20,
  units = "cm",
  dpi = 300,
)

`Sample_23_6 element ratios` # missing legend for geom_bins


ggsave(
  "Sample_23_6 Temp proxy element ratios.tiff",
  plot = `Sample_23_6 Temp proxy element ratios`,
  path = Ratios_folder_path,
  scale = 1,
  width = 20,
  height = 20,
  units = "cm",
  dpi = 300,
)


# `Sample_23_6 element ratios [by internode]` # missing legend for geom_bins
# 
# ggsave(
#   "Sample_23_6 element ratios [by internode].tiff",
#   plot = `Sample_23_6 element ratios [by internode]`,
#   path = Ratios_folder_path,
#   scale = 1,
#   width = 20,
#   height = 20,
#   units = "cm",
#   dpi = 300,
# )

`Sample_23_6 Temp proxy element ratios [by internode]` # missing legend for geom_bins

`Sample_23_6 Temp proxy element ratios` # missing legend for geom_bins

ggsave(
  "Sample_23_6 Temp proxy element ratios.tiff",
  plot = `Sample_23_6 Temp proxy element ratios`,
  path = Ratios_folder_path,
  scale = 1,
  width = 20,
  height = 20,
  units = "cm",
  dpi = 300,
)

`Sample_23_6 element ratios [by internode]` # missing legend for geom_bins


ggsave(
  "Sample_23_6 Temp proxy element ratios [by internode].tiff",
  plot = `Sample_23_6 Temp proxy element ratios [by internode]`,
  path = Ratios_folder_path,
  scale = 1,
  width = 20,
  height = 20,
  units = "cm",
  dpi = 300,
)



# `Sample_23_1 element ratios` # missing legend for geom_bins
# 
# ggsave(
#   "Sample_23_1 element ratios.tiff",
#   plot = `Sample_23_1 element ratios`,
#   path = Ratios_folder_path,
#   scale = 1,
#   width = 20,
#   height = 20,
#   units = "cm",
#   dpi = 300,
# )

`Sample_23_1 Temp proxy element ratios` # missing legend for geom_bins

`Sample_23_6 Temp proxy element ratios [by internode]` # missing legend for geom_bins

ggsave(
  "Sample_23_6 Temp proxy element ratios [by internode].tiff",
  plot = `Sample_23_6 Temp proxy element ratios [by internode]`,
  path = Ratios_folder_path,
  scale = 1,
  width = 20,
  height = 20,
  units = "cm",
  dpi = 300,
)


`Sample_23_1 element ratios` # missing legend for geom_bins


ggsave(
  "Sample_23_1 Temp proxy element ratios.tiff",
  plot = `Sample_23_1 Temp proxy element ratios`,
  path = Ratios_folder_path,
  scale = 1,
  width = 20,
  height = 20,
  units = "cm",
  dpi = 300,
)


# `Sample_23_1 element ratios [by internode]` # missing legend for geom_bins
# 
# ggsave(
#   "Sample_23_1 element ratios [by internode].tiff",
#   plot = `Sample_23_1 element ratios [by internode]`,
#   path = Ratios_folder_path,
#   scale = 1,
#   width = 20,
#   height = 20,
#   units = "cm",
#   dpi = 300,
# )

`Sample_23_1 Temp proxy element ratios [by internode]` # missing legend for geom_bins

`Sample_23_1 Temp proxy element ratios` # missing legend for geom_bins

ggsave(
  "Sample_23_1 Temp proxy element ratios.tiff",
  plot = `Sample_23_1 Temp proxy element ratios`,
  path = Ratios_folder_path,
  scale = 1,
  width = 20,
  height = 20,
  units = "cm",
  dpi = 300,
)

`Sample_23_1 element ratios [by internode]` # missing legend for geom_bins


ggsave(
  "Sample_23_1 Temp proxy element ratios [by internode].tiff",
  plot = `Sample_23_1 Temp proxy element ratios [by internode]`,
  path = Ratios_folder_path,
  scale = 1,
  width = 20,
  height = 20,
  units = "cm",
  dpi = 300,
)


`Sample_23_1 Ba/Ca vs TE Spearman cor [by internode]`

`Sample_23_1 Temp proxy element ratios [by internode]` # missing legend for geom_bins

ggsave(
  "Sample_23_1 Temp proxy element ratios [by internode].tiff",
  plot = `Sample_23_1 Temp proxy element ratios [by internode]`,
  path = Ratios_folder_path,
  scale = 1,
  width = 20,
  height = 20,
  units = "cm",
  dpi = 300,
)


`Sample_23_1 Ba/Ca vs TE Pearson cor [by internode]`

`Sample_23_1 Ba/Ca vs TE Spearman cor [by internode]`

ggsave(
  "Sample_23_1 Barium v element ratios [spearman by internode].tiff",
  plot = `Sample_23_1 Ba/Ca vs TE Spearman cor [by internode]`,
  path = Ratios_folder_path,
  scale = 1,
  width = 5,
  height = 24,
  units = "cm",
  dpi = 300,
)


`Sample_23_6 Ba/Ca vs TE Spearman cor [by internode]`

`Sample_23_1 Ba/Ca vs TE Pearson cor [by internode]`

ggsave(
  "Sample_23_1 Barium v element ratios [pearson by internode].tiff",
  plot = `Sample_23_1 Ba/Ca vs TE Pearson cor [by internode]`,
  path = Ratios_folder_path,
  scale = 1,
  width = 5,
  height = 24,
  units = "cm",
  dpi = 300,
)


`Sample_23_6 Ba/Ca vs TE Pearson cor [by internode]`

`Sample_23_6 Ba/Ca vs TE Spearman cor [by internode]`

ggsave(
  "Sample_23_6 Barium v element ratios [spearman by internode].tiff",
  plot = `Sample_23_6 Ba/Ca vs TE Spearman cor [by internode]`,
  path = Ratios_folder_path,
  scale = 1,
  width = 5,
  height = 24,
  units = "cm",
  dpi = 300,
)


`Sample_23_10 Ba/Ca vs TE Spearman cor [by internode]`

`Sample_23_6 Ba/Ca vs TE Pearson cor [by internode]`

ggsave(
  "Sample_23_6 Barium v element ratios [pearson by internode].tiff",
  plot = `Sample_23_6 Ba/Ca vs TE Pearson cor [by internode]`,
  path = Ratios_folder_path,
  scale = 1,
  width = 5,
  height = 24,
  units = "cm",
  dpi = 300,
)


`Sample_23_10 Ba/Ca vs TE Pearson cor [by internode]`

`Sample_23_10 Ba/Ca vs TE Spearman cor [by internode]`

ggsave(
  "Sample_23_10 Barium v element ratios [spearman by internode].tiff",
  plot = `Sample_23_10 Ba/Ca vs TE Spearman cor [by internode]`,
  path = Ratios_folder_path,
  scale = 1,
  width = 5,
  height = 24,
  units = "cm",
  dpi = 300,
)


`Sample_23_16 Ba/Ca vs TE Spearman cor [by internode]`

`Sample_23_10 Ba/Ca vs TE Pearson cor [by internode]`

ggsave(
  "Sample_23_10 Barium v element ratios [pearson by internode].tiff",
  plot = `Sample_23_10 Ba/Ca vs TE Pearson cor [by internode]`,
  path = Ratios_folder_path,
  scale = 1,
  width = 5,
  height = 24,
  units = "cm",
  dpi = 300,
)


`Sample_23_16 Ba/Ca vs TE Pearson cor [by internode]`

`Sample_23_16 Ba/Ca vs TE Spearman cor [by internode]`

ggsave(
  "Sample_23_16 Barium v element ratios [spearman by internode].tiff",
  plot = `Sample_23_16 Ba/Ca vs TE Spearman cor [by internode]`,
  path = Ratios_folder_path,
  scale = 1,
  width = 5,
  height = 24,
  units = "cm",
  dpi = 300,
)

`Sample_23_16 Ba/Ca vs TE Pearson cor [by internode]`


ggsave(
  "Sample_23_16 Barium v element ratios [pearson by internode].tiff",
  plot = `Sample_23_16 Ba/Ca vs TE Pearson cor [by internode]`,
  path = Ratios_folder_path,
  scale = 1,
  width = 5,
  height = 24,
  units = "cm",
  dpi = 300,
)

```



```{r paleothermometry reconstruction}

View(Sample_element_patterns_list)

Sample_element_patterns_list[["Sample_23_10 1 element_patterns_data"]] <- Sample_element_patterns_list[["Sample_23_10 1 element_patterns_data"]] %>% mutate_all(~ifelse(is.nan(.), NA, .))

## Thermometry data for QAnalyseries #####
i <- "23_6"
j <- 1
for(i in Samples) {
  for (j in 1:3) {
    
    thermometry_data <- Sample_element_patterns_list[[paste0("Sample_",i, " ",j, " element_patterns_data")]] %>%
      ungroup() %>%
      mutate_all(~ifelse(is.nan(.), NA, .)) %>%
      group_by(distance.um) %>% # calculate across all tracks
      summarise(Li_Ca = mean(Li_Ca, na.rm = T),
            Mg_Ca = mean(Mg_Ca, na.rm = T),
            Ba_Ca = mean(Ba_Ca, na.rm = T),
            S_Ca = mean(S_Ca, na.rm = T),
            Sr_Ca = mean(Sr_Ca, na.rm = T),
            U_Ca = mean(U_Ca, na.rm = T),
            Li_Mg = Li_Ca/(Mg_Ca/1000),
            Li_Mg_proxy = ((log(Li_Mg/0.522))/-0.0343),
            Mg_Ca_proxy = ((0.313*Mg_Ca/1000)-21.4),
            S_Ca_proxy = (3.79*S_Ca/1000) + 0.128,
            Sr_U = (Sr_Ca/1000) - (1.1107*U_Ca),
            Sr_Ca_proxy = (1.76*Sr_Ca/1000) + 0.553,
            Sr_U_proxy = (1.85*Sr_U) - 0.292)
    
    thermometry_mean <- thermometry_data %>%
      ungroup() %>%
      summarise(Li_Mg = mean(Li_Mg, na.rm = T),
                Mg_Ca = mean(Mg_Ca, na.rm = T),
                Ba_Ca = mean(Ba_Ca, na.rm = T),
                S_Ca = mean(S_Ca, na.rm = T),
                Sr_Ca = mean(Sr_Ca, na.rm = T),
                U_Ca = mean(U_Ca, na.rm = T),
                Li_Mg_proxy = mean(Li_Mg_proxy, na.rm = T),
                Mg_Ca_proxy = mean(Mg_Ca_proxy, na.rm = T),
                S_Ca_proxy = mean(S_Ca_proxy, na.rm = T),
                Sr_Ca_proxy = mean(Sr_Ca_proxy, na.rm = T),
                Sr_U_proxy = mean(Sr_U_proxy, na.rm = T))
    
    assign(paste0("Sample_",i, " ",j, " thermometry_data"), thermometry_data)
    assign(paste0("Sample_",i, " ",j, " thermometry_mean"), thermometry_mean)
    rm(thermometry_data)
    rm(thermometry_mean)
  }
}

`Sample_23_1 1 thermometry_data` %>%
  na.omit %>%
  dplyr::summarise(Distance = distance.um,
         Li_Ca, Mg_Ca, Sr_Ca, Ba_Ca, S_Ca, U_Ca, Li_Mg) %>%
  write_csv(., file = "Sample_23_1_1 TE_data.csv")

`Sample_23_1 2 thermometry_data` %>%
  na.omit %>%
  dplyr::summarise(Distance = distance.um,
         Li_Ca, Mg_Ca, Sr_Ca, Ba_Ca, S_Ca, U_Ca, Li_Mg) %>%
  write_csv(., file = "Sample_23_1_2 TE_data.csv")

`Sample_23_1 3 thermometry_data` %>%
  na.omit %>%
  dplyr::summarise(Distance = distance.um,
         Li_Ca, Mg_Ca, Sr_Ca, Ba_Ca, S_Ca, U_Ca, Li_Mg) %>%
  write_csv(., file = "Sample_23_1_3 TE_data.csv")

`Sample_23_10 1 thermometry_data` %>%
  na.omit %>%
  dplyr::summarise(Distance = distance.um,
         Li_Ca, Mg_Ca, Sr_Ca, Ba_Ca, S_Ca, U_Ca, Li_Mg) %>%
  write_csv(., file = "Sample_23_10_1 TE_data.csv")

`Sample_23_10 2 thermometry_data` %>%
  na.omit %>%
  dplyr::summarise(Distance = distance.um,
         Li_Ca, Mg_Ca, Sr_Ca, Ba_Ca, S_Ca, U_Ca, Li_Mg) %>%
  write_csv(., file = "Sample_23_10_2 TE_data.csv")

`Sample_23_10 3 thermometry_data` %>%
  na.omit %>%
  dplyr::summarise(Distance = distance.um,
         Li_Ca, Mg_Ca, Sr_Ca, Ba_Ca, S_Ca, U_Ca, Li_Mg) %>%
  write_csv(., file = "Sample_23_10_3 TE_data.csv")

`Sample_23_6 1 thermometry_data` %>%
  na.omit %>%
  dplyr::summarise(Distance = distance.um,
         Li_Ca, Mg_Ca, Sr_Ca, Ba_Ca, S_Ca, U_Ca, Li_Mg) %>%
  write_csv(., file = "Sample_23_6_1 TE_data.csv")

`Sample_23_6 2 thermometry_data` %>%
  na.omit %>%
  dplyr::summarise(Distance = distance.um,
         Li_Ca, Mg_Ca, Sr_Ca, Ba_Ca, S_Ca, U_Ca, Li_Mg) %>%
  write_csv(., file = "Sample_23_6_2 TE_data.csv")

`Sample_23_6 3 thermometry_data` %>%
  na.omit %>%
  dplyr::summarise(Distance = distance.um,
         Li_Ca, Mg_Ca, Sr_Ca, Ba_Ca, S_Ca, U_Ca, Li_Mg) %>%
  write_csv(., file = "Sample_23_6_3 TE_data.csv")

`Sample_23_16 1 thermometry_data` %>%
  na.omit %>%
  dplyr::summarise(Distance = distance.um,
         Li_Ca, Mg_Ca, Sr_Ca, Ba_Ca, S_Ca, U_Ca, Li_Mg) %>%
  write_csv(., file = "Sample_23_16_1 TE_data.csv")

`Sample_23_16 2 thermometry_data` %>%
  na.omit %>%
  dplyr::summarise(Distance = distance.um,
         Li_Ca, Mg_Ca, Sr_Ca, Ba_Ca, S_Ca, U_Ca, Li_Mg) %>%
  write_csv(., file = "Sample_23_16_2 TE_data.csv")

`Sample_23_16 3 thermometry_data` %>%
  na.omit %>%
  dplyr::summarise(Distance = distance.um,
         Li_Ca, Mg_Ca, Sr_Ca, Ba_Ca, S_Ca, U_Ca, Li_Mg) %>%
  write_csv(., file = "Sample_23_16_3 TE_data.csv")


# Tuned thermometry data ####

# Thermometry plots ####


All_samples_thermometry_data <- dplyr::bind_rows(list(S_23_1=`Sample_23_1 1 thermometry_data`, S_23_6=`Sample_23_6 1 thermometry_data`, S_23_10=`Sample_23_10 1 thermometry_data`, S_23_16=`Sample_23_16 1 thermometry_data`), .id = 'Specimen')

# Adding the tuned internodes 
All_samples_thermometry_data <- All_samples_thermometry_data %>%
  mutate(Internode = 1) 


Sample_23_1_2_tuned_data <- Sample_23_1_2_ages %>%
  dplyr::select(-old.depth) %>%
  mutate(Specimen = "S_23_1",
         Internode = 2)

Sample_23_1_3_tuned_data <- Sample_23_1_3_ages %>%
  dplyr::select(-old.depth) %>%
  mutate(Specimen = "S_23_1",
         Internode = 3)

Sample_23_6_2_tuned_data <- Sample_23_6_2_ages %>%
  dplyr::select(-old.depth) %>%
  mutate(Specimen = "S_23_6",
         Internode = 2)

Sample_23_6_3_tuned_data <- Sample_23_6_3_ages %>%
  dplyr::select(-old.depth) %>%
  mutate(Specimen = "S_23_6",
         Internode = 3)

Sample_23_10_2_tuned_data <- Sample_23_10_2_ages %>%
  dplyr::select(-old.depth) %>%
  mutate(Specimen = "S_23_10",
         Internode = 2)

Sample_23_10_3_tuned_data <- Sample_23_10_3_ages %>%
  dplyr::select(-old.depth) %>%
  mutate(Specimen = "S_23_10",
         Internode = 3)

Sample_23_16_2_tuned_data <- Sample_23_16_2_ages %>%
  dplyr::select(-old.depth) %>%
  mutate(Specimen = "S_23_16",
         Internode = 2)

Sample_23_16_3_tuned_data <- Sample_23_16_3_ages %>%
  dplyr::select(-old.depth) %>%
  mutate(Specimen = "S_23_16",
         Internode = 3)

All_samples_thermometry_data_V2 <- dplyr::full_join(All_samples_thermometry_data, Sample_23_1_2_tuned_data,
          by = c("distance.um" ="tuned.depth", "Specimen", "Internode", "Li_Ca", "Mg_Ca", "Ba_Ca", "S_Ca", "Sr_Ca", "U_Ca", "Li_Mg"))

All_samples_thermometry_data_V2 <- dplyr::full_join(All_samples_thermometry_data_V2, Sample_23_6_2_tuned_data, 
          by = c("distance.um" ="tuned.depth", "Specimen", "Internode", "Li_Ca", "Mg_Ca", "Ba_Ca", "S_Ca", "Sr_Ca", "U_Ca", "Li_Mg"))

All_samples_thermometry_data_V2 <- dplyr::full_join(All_samples_thermometry_data_V2, Sample_23_10_2_tuned_data, 
          by = c("distance.um" ="tuned.depth", "Specimen", "Internode", "Li_Ca", "Mg_Ca", "Ba_Ca", "S_Ca", "Sr_Ca", "U_Ca", "Li_Mg"))

All_samples_thermometry_data_V2 <- dplyr::full_join(All_samples_thermometry_data_V2, Sample_23_16_2_tuned_data, 
          by = c("distance.um" ="tuned.depth", "Specimen", "Internode", "Li_Ca", "Mg_Ca", "Ba_Ca", "S_Ca", "Sr_Ca", "U_Ca", "Li_Mg"))

All_samples_thermometry_data_V2 <- dplyr::full_join(All_samples_thermometry_data_V2, Sample_23_1_3_tuned_data,
          by = c("distance.um" ="tuned.depth", "Specimen", "Internode", "Li_Ca", "Mg_Ca", "Ba_Ca", "S_Ca", "Sr_Ca", "U_Ca", "Li_Mg"))

All_samples_thermometry_data_V2 <- dplyr::full_join(All_samples_thermometry_data_V2, Sample_23_6_3_tuned_data,
          by = c("distance.um" ="tuned.depth", "Specimen", "Internode", "Li_Ca", "Mg_Ca", "Ba_Ca", "S_Ca", "Sr_Ca", "U_Ca", "Li_Mg"))

All_samples_thermometry_data_V2 <- dplyr::full_join(All_samples_thermometry_data_V2, Sample_23_10_3_tuned_data,
          by = c("distance.um" ="tuned.depth", "Specimen", "Internode", "Li_Ca", "Mg_Ca", "Ba_Ca", "S_Ca", "Sr_Ca", "U_Ca", "Li_Mg"))

All_samples_thermometry_data_V2 <- dplyr::full_join(All_samples_thermometry_data_V2, Sample_23_16_3_tuned_data,
          by = c("distance.um" ="tuned.depth", "Specimen", "Internode", "Li_Ca", "Mg_Ca", "Ba_Ca", "S_Ca", "Sr_Ca", "U_Ca", "Li_Mg"))

All_samples_thermometry_data_V2 <- All_samples_thermometry_data_V2 %>%

  dplyr::select(-c(10:15)) %>%
  unique()

# layout ####
layout <- "
AAABB
CCCDD
EEEFF
"

## OISST data ####
library(ncdf4)
OISST_path <- "~/Library/CloudStorage/OneDrive-UniversityofSouthampton/PhD, INSPIRE DTP/Countries_Chapters/UK [Soton]/Chpt4 Bamboo Coral Analysis/Environmental data/OISST/"
ncfname <- paste0(OISST_path,"SST_OISST_V2_weekly_1981_2022.nc")
ncin <- nc_open(ncfname)
 
ncin
temp <- ncvar_get(ncin, "sst")
time <- ncvar_get(ncin, "time")
lon <- ncvar_get(ncin, "lon")
lat <- ncvar_get(ncin, "lat")
latlong <- c("68.5_298", "68.5_300", "68.5_302", "67.5_298", "67.5_300", "67.5_302")
temp.dataframe <- data.frame(matrix(temp, nrow=dim(temp)[3], byrow=TRUE)) 
names(temp.dataframe) <- latlong

temp.dataframe_V2 <- temp.dataframe %>%
  mutate(Timepoint = as.Date(time, origin = as.Date("1800-1-1"),format =  "%d/%m/%Y %H:%M:%S")) %>%
  pivot_longer(cols = c(1:6), names_to = "lat_long", values_to = "temp") %>%
  separate(lat_long, sep = "_", into = c("lat", "long"))
rm(lat,lon,time,temp)
### 1991 to 2021 ####
#### uninterpolated ####
SST_plot_uninterpolated <- temp.dataframe_V2 %>%
  group_by(Timepoint) %>%
  summarise(temp_mean = mean(temp),
            temp_sd = sd(temp),
            Time_yr = lubridate::decimal_date(Timepoint)) 

SST_plot_uninterpolated_common <- SST_plot_uninterpolated %>%
  filter(Time_yr >= 2000 & Time_yr <= 2021)

SST_plot_uninterpolated_common_model <- lmodel2::lmodel2(temp_mean ~ Time_yr, data = SST_plot_uninterpolated_common, "interval", "interval", 999)
SST_plot_uninterpolated_common_trend <- SST_plot_uninterpolated_common_model$regression.results[1,3]

SST_plot_uninterpolated_plot <- SST_plot_uninterpolated %>%
  ggplot() +
  geom_ribbon(aes(Time_yr, ymax = temp_mean+(2*temp_sd), ymin = temp_mean-(2*temp_sd)), fill = "#FF9933",alpha = 0.4)+
  geom_line(aes(Time_yr, as.numeric(temp_mean)), col = "#FF9933", lwd = 0.8) +
      geom_point(aes(x = 2018.6068, y = 0.86), col = "darkgrey") +
      geom_point(aes(x = 2017.5466, y =0.68), col = "darkgrey") +
      geom_point(aes(x = 2016.5642, y =1.05), col = "darkgrey") +
      labs(y = expression("T"["[insitu]"]*" (°C)"), x = "Timepoint (years)") +
      geom_hline(yintercept = 1.1, linetype = 4, col = "darkgrey") +
      geom_hline(yintercept = 0.68, linetype = 4, col = "darkgrey") +
      scale_x_continuous(limits = c(1960,2021), breaks = seq(1960,2020,5), sec.axis = sec_axis(~ -(. - 2021)*51, name = "Distance from coral wall (µm)")) +
      scale_y_continuous(limits = c(-5,10)) +
      theme_classic()

#### seasonally interpolated ####
SST_plot_season_interpolated <- temp.dataframe_V2 %>%
  group_by(Timepoint) %>%
  summarise(temp_mean = mean(temp),
            temp_sd = sd(temp),
            Time_yr = lubridate::decimal_date(Timepoint)) %>%
  ungroup(Timepoint) %>%
  summarise(
            Time = spline(Time_yr, temp_mean, xout = seq(min(Time_yr),2021, by = 0.25))$x,
            temp_mean_season = spline(Time_yr, temp_mean, xout = seq(min(Time_yr),2021, by = 0.25))$y,
            temp_sd_season = spline(Time_yr, temp_sd, xout = seq(min(Time_yr),2021, by = 0.25))$y)

SST_plot_season_interpolated_common <- SST_plot_season_interpolated %>%
   filter(Time >= 2000 & Time <= 2021)

SST_plot_season_interpolated_common_model <- lmodel2::lmodel2(temp_mean_season ~ Time, data = SST_plot_season_interpolated_common, "interval", "interval", 999)
SST_plot_season_interpolated_common_trend <- SST_plot_season_interpolated_common_model$regression.results[1,3]

SST_plot_season_interpolated_plot <- SST_plot_season_interpolated %>%
  ggplot() +
  geom_ribbon(aes(Time, ymax = temp_mean_season+(2*temp_sd_season), ymin = temp_mean_season-(2*temp_sd_season)), fill = "#FF9933", alpha = 0.4)+
  geom_line(aes(Time, as.numeric(temp_mean_season)), col = "#FF9933", lwd = 0.8) +
      geom_point(aes(x = 2018.6068, y = 0.86), col = "darkgrey") +
      geom_point(aes(x = 2017.5466, y =0.68), col = "darkgrey") +
      geom_point(aes(x = 2016.5642, y =1.05), col = "darkgrey") +
      labs(y = expression("T"["[insitu]"]*" (°C)"), x = "Timepoint (years)") +
      geom_hline(yintercept = 1.1, linetype = 4, col = "darkgrey") +
      geom_hline(yintercept = 0.68, linetype = 4, col = "darkgrey") +
      scale_x_continuous(limits = c(1960,2021), breaks = seq(1960,2020,5), sec.axis = sec_axis(~ -(. - 2021)*51, name = "Distance from coral wall (µm)")) +
      scale_y_continuous(limits = c(-5,10)) +
      theme_classic()

#### annually interpolated ####
SST_plot_annual_interpolated <- temp.dataframe_V2 %>%
  group_by(Timepoint) %>%
  summarise(temp_mean = mean(temp),
            temp_sd = sd(temp),
            Time_yr = lubridate::decimal_date(Timepoint)) %>%
  ungroup(Timepoint) %>%
  summarise(
            Time = spline(Time_yr, temp_mean, xout = seq(min(Time_yr),2021, by = 1))$x,
            temp_mean_annual = spline(Time_yr, temp_mean, xout = seq(min(Time_yr),2021, by = 1))$y,
            temp_sd_annual = spline(Time_yr, temp_sd, xout = seq(min(Time_yr),2021, by = 1))$y)

SST_plot_annual_interpolated_common <- SST_plot_annual_interpolated %>%
   filter(Time >= 2000 & Time <= 2021)

SST_plot_annual_interpolated_common_model <- lmodel2::lmodel2(temp_mean_annual ~ Time, data = SST_plot_annual_interpolated_common, "interval", "interval", 999)
SST_plot_annual_interpolated_common_trend <- SST_plot_annual_interpolated_common_model$regression.results[1,3]

SST_plot_annual_interpolated_plot <- SST_plot_annual_interpolated %>%
  ggplot() +
  geom_ribbon(aes(Time, ymax = temp_mean_annual+(2*temp_sd_annual), ymin = temp_mean_annual-(2*temp_sd_annual)), fill = "#FF9933", alpha = 0.4)+
  geom_line(aes(Time, as.numeric(temp_mean_annual)), col = "#FF9933", lwd = 0.8) +
      geom_point(aes(x = 2018.6068, y = 0.86), col = "darkgrey") +
      geom_point(aes(x = 2017.5466, y =0.68), col = "darkgrey") +
      geom_point(aes(x = 2016.5642, y =1.05), col = "darkgrey") +
      labs(y = expression("T"["[insitu]"]*" (°C)"), x = "Timepoint (years)") +
      geom_hline(yintercept = 1.1, linetype = 4, col = "darkgrey") +
      geom_hline(yintercept = 0.68, linetype = 4, col = "darkgrey") +
      scale_x_continuous(limits = c(1960,2021), breaks = seq(1960,2020,5), sec.axis = sec_axis(~ -(. - 2021)*51, name = "Distance from coral wall (µm)")) +
      scale_y_continuous(limits = c(-5,10)) +
      theme_classic()

### 2003 to 2016 ####
#### uninterpolated ####
SST_plot_uninterpolated_constrained <- temp.dataframe_V2 %>%
  group_by(Timepoint) %>%
  summarise(temp_mean = mean(temp),
            temp_sd = sd(temp),
            Time_yr = lubridate::decimal_date(Timepoint)) 

SST_plot_uninterpolated_constrained_common <- SST_plot_uninterpolated_constrained %>%
  filter(Time_yr >= 2003 & Time_yr <= 2016)

SST_plot_uninterpolated_constrained_common_model <- lmodel2::lmodel2(temp_mean ~ Time_yr, data = SST_plot_uninterpolated_constrained_common, "interval", "interval", 999)
SST_plot_uninterpolated_constrained_common_trend <- SST_plot_uninterpolated_constrained_common_model$regression.results[1,3]

#### seasonally interpolated ####
SST_plot_season_interpolated_constrained <- temp.dataframe_V2 %>%
  group_by(Timepoint) %>%
  summarise(temp_mean = mean(temp),
            temp_sd = sd(temp),
            Time_yr = lubridate::decimal_date(Timepoint)) %>%
  ungroup(Timepoint) %>%
  summarise(
            Time = spline(Time_yr, temp_mean, xout = seq(min(Time_yr),2021, by = 0.25))$x,
            temp_mean_season = spline(Time_yr, temp_mean, xout = seq(min(Time_yr),2021, by = 0.25))$y,
            temp_sd_season = spline(Time_yr, temp_sd, xout = seq(min(Time_yr),2021, by = 0.25))$y)

SST_plot_season_interpolated_constrained_common <- SST_plot_season_interpolated_constrained %>%
   filter(Time >= 2003 & Time <= 2016)

SST_plot_season_interpolated_constrained_common_model <- lmodel2::lmodel2(temp_mean_season ~ Time, data = SST_plot_season_interpolated_constrained_common, "interval", "interval", 999)
SST_plot_season_interpolated_constrained_common_trend <- SST_plot_season_interpolated_constrained_common_model$regression.results[1,3]

#### annually interpolated ####
SST_plot_annual_interpolated_constrained <- temp.dataframe_V2 %>%
  group_by(Timepoint) %>%
  summarise(temp_mean = mean(temp),
            temp_sd = sd(temp),
            Time_yr = lubridate::decimal_date(Timepoint)) %>%
  ungroup(Timepoint) %>%
  summarise(
            Time = spline(Time_yr, temp_mean, xout = seq(min(Time_yr),2021, by = 1))$x,
            temp_mean_annual = spline(Time_yr, temp_mean, xout = seq(min(Time_yr),2021, by = 1))$y,
            temp_sd_annual = spline(Time_yr, temp_sd, xout = seq(min(Time_yr),2021, by = 1))$y)

SST_plot_annual_interpolated_constrained_common <- SST_plot_annual_interpolated_constrained %>%
   filter(Time >= 2003 & Time <= 2016)

SST_plot_annual_interpolated_constrained_common_model <- lmodel2::lmodel2(temp_mean_annual ~ Time, data = SST_plot_annual_interpolated_constrained_common, "interval", "interval", 999)
SST_plot_annual_interpolated_constrained_common_trend <- SST_plot_annual_interpolated_constrained_common_model$regression.results[1,3]

# Thermometry plots ####

  dplyr::select(-c(10:15))

# Interpolation ####
layout <- "
AAAABB
CCCCDD
EEEEFF
"

## Li/Mg ####
Li_Mg_thermometry_plot_uninterpolated <- All_samples_thermometry_data_V2 %>%
      group_by(distance.um, Specimen) %>% 
      summarise(Timepoint = 2021-(distance.um/51),
            Li_Mg = Li_Ca/(Mg_Ca/1000),
            Li_Mg_proxy = ((log(Li_Mg/0.63))/-0.050),
            Li_Mg_proxy_TJW = ((log(Li_Mg/0.521))/-0.0343)) %>%
      ggplot() +
      geom_path(aes(x = Timepoint, y = Li_Mg_proxy, col = Specimen), linetype = 3) + # Steward et al., 2020 Ear. Plan. Sci. Lett. for high-Mg octocorals
      geom_path(aes(x = Timepoint, y = Li_Mg_proxy_TJW, col = Specimen)) + # this study

      geom_point(aes(x = 2018.6068, y =0.86), col = "darkgrey") +
      geom_point(aes(x = 2017.5466, y =0.68), col = "darkgrey") +
      geom_point(aes(x = 2016.5642, y =1.05), col = "darkgrey") +
      geom_point(aes(x = 2021.5849, y = 1.1), col = "darkgrey") +

geom_point(aes(x = 2018.6068, y =0.86), col = "orange") +
      geom_point(aes(x = 2017.5466, y =0.68), col = "orange") +
      geom_point(aes(x = 2016.5642, y =1.05), col = "orange") +
      geom_point(aes(x = 2021.5849, y = 1.1), col = "orange") +

      labs(y = expression("T"["[rec]"]*" (°C)"), x = "Timepoint (years)") +
      geom_hline(yintercept = 1.1, linetype = 2) +
      geom_hline(yintercept = 0.68, linetype = 2) +
      geom_label(aes(y = 30, x = 1990, label = "No interpolation")) +
      scale_x_continuous(limits = c(1960,2021), breaks = seq(1960,2020,5), sec.axis = sec_axis(~ -(. - 2021)*51, name = "Distance from coral wall (µm)")) +
      scale_y_continuous(limits = c(-5,45)) +
      theme_classic()

Li_Mg_thermometry_plot_uninterpolated_averages <- All_samples_thermometry_data_V2 %>%
      group_by(distance.um, Specimen) %>% 
      summarise(Timepoint = 2021-(distance.um/51),
            Li_Mg = Li_Ca/(Mg_Ca/1000),
            Li_Mg_proxy = ((log(Li_Mg/0.63))/-0.050),
            Li_Mg_proxy_TJW = ((log(Li_Mg/0.521))/-0.0343)) %>%
 filter(Timepoint >= 2000 & Timepoint <= 2021 & Li_Mg_proxy <= 45 & Li_Mg_proxy >= -5 & Li_Mg_proxy_TJW <= 45 & Li_Mg_proxy_TJW >= -5) %>%
  group_by(Specimen) %>%
  summarise(Samples = n(),
    Pub_mean = mean(Li_Mg_proxy, na.rm = T),
            Pub_sd = sd(Li_Mg_proxy, na.rm = T),
            Pub_se = sd(Li_Mg_proxy, na.rm = T)/sqrt(n()),
        TJW_mean = mean(Li_Mg_proxy_TJW, na.rm = T),
            TJW_sd = sd(Li_Mg_proxy_TJW, na.rm = T),
            TJW_se = sd(Li_Mg_proxy_TJW, na.rm = T)/sqrt(n())) %>%
  mutate(Pub_alpha = c(0.499,0.259,0.989,0.586),
         TJW_alpha = c(0.399,0.378,1.41,0.781)) %>%
  pivot_longer(cols = c(3:10), names_to = "Calculation", values_to = "value") %>%
  separate(col = "Calculation", "_", into = c("Calibration", "Calculation")) %>%
  pivot_wider(names_from = "Calculation", values_from = "value") %>%
      ggplot() +
          geom_hline(yintercept = 1.1, linetype = 2) +
      geom_hline(yintercept = 0.68, linetype = 2) +
  geom_vline(xintercept = 0, linetype = 2) +
    geom_errorbar(aes(x = alpha, ymin = mean-sd, ymax = mean+sd, linetype = Calibration), 
                width = 0.1) +
      geom_point(aes(x = alpha, y = mean, col = Specimen, fill = Calibration), 
                 pch = 21, size = 4, stroke = 2) +
  scale_fill_manual(values = c("white", "black")) +
  scale_linetype_manual(values = c(3,1)) +
      labs(y = expression("T"["[rec]"]*" (°C)"), x = expression("T"["[rec]"]*" trend (°C.yr"^"-1"*")")) +
      scale_y_continuous(limits = c(-5,45)) +
      scale_x_continuous(limits = c(-0.25,1.5)) +
      theme_classic()
    

Li_Mg_thermometry_plot_seasonal_interpolation <- All_samples_thermometry_data_V2 %>%
      group_by(distance.um, Specimen) %>% 
      summarise(Timepoint = 2021-(distance.um/51),
            Li_Mg = Li_Ca/(Mg_Ca/1000),
            Li_Mg_proxy = ((log(Li_Mg/0.63))/-0.050),
            Li_Mg_proxy_TJW = ((log(Li_Mg/0.521))/-0.0343)) %>%
  drop_na() %>%
  ungroup(distance.um) %>%
  group_by(Specimen) %>%
  summarise(
            Time = spline(Timepoint, Li_Mg_proxy_TJW, xout = seq(min(Timepoint),2021, by = 0.25))$x,
            Li_Mg_proxy_season_TJW = spline(Timepoint, Li_Mg_proxy_TJW, xout = seq(min(Timepoint),2021, by = 0.25))$y,
            Li_Mg_proxy_season = spline(Timepoint, Li_Mg_proxy, xout = seq(min(Timepoint),2021, by = 0.25))$y) %>% 
  ggplot() +
  geom_path(aes(Time, Li_Mg_proxy_season_TJW, group = Specimen, col = Specimen)) +
  geom_path(aes(Time, Li_Mg_proxy_season, group = Specimen, col = Specimen), linetype = 3) +

  geom_point(aes(x = 2018.6068, y =0.86), col = "darkgrey") +
      geom_point(aes(x = 2017.5466, y =0.68), col = "darkgrey") +
      geom_point(aes(x = 2016.5642, y =1.05), col = "darkgrey") +
      geom_point(aes(x = 2021.5849, y = 1.1), col = "darkgrey") +

  geom_point(aes(x = 2018.6068, y =0.86), col = "orange") +
      geom_point(aes(x = 2017.5466, y =0.68), col = "orange") +
      geom_point(aes(x = 2016.5642, y =1.05), col = "orange") +
      geom_point(aes(x = 2021.5849, y = 1.1), col = "orange") +

      labs(y = expression("T"["[rec]"]*" (°C)"), x = "Timepoint (years)") +
      geom_hline(yintercept = 1.1, linetype = 2) +
      geom_hline(yintercept = 0.68, linetype = 2) +
      geom_label(aes(y = 30, x = 1990, label = "Seasonal interpolation (spline)")) +
      scale_x_continuous(limits = c(1960,2021), breaks = seq(1960,2020,5), sec.axis = sec_axis(~ -(. - 2021)*51, name = "Distance from coral wall (µm)")) +
      scale_y_continuous(limits = c(-5,45)) +
      theme_classic()

Li_Mg_thermometry_plot_seasonal_interpolation_averages <- All_samples_thermometry_data_V2 %>%
      group_by(distance.um, Specimen) %>% 
      summarise(Timepoint = 2021-(distance.um/51),
            Li_Mg = Li_Ca/(Mg_Ca/1000),
            Li_Mg_proxy = ((log(Li_Mg/0.63))/-0.050),
            Li_Mg_proxy_TJW = ((log(Li_Mg/0.521))/-0.0343)) %>%
  drop_na() %>%
  ungroup(distance.um) %>%
  group_by(Specimen) %>%
  summarise(
            Time = spline(Timepoint, Li_Mg_proxy_TJW, xout = seq(min(Timepoint),2021, by = 0.25))$x,
            Li_Mg_proxy_season_TJW = spline(Timepoint, Li_Mg_proxy_TJW, xout = seq(min(Timepoint),2021, by = 0.25))$y,
            Li_Mg_proxy_season = spline(Timepoint, Li_Mg_proxy, xout = seq(min(Timepoint),2021, by = 0.25))$y) %>% 
  filter(Time >= 2000 & Time <= 2021 & Li_Mg_proxy_season <= 45 & Li_Mg_proxy_season >= -5 & Li_Mg_proxy_season_TJW <= 45 & Li_Mg_proxy_season_TJW >= -5) %>%
  group_by(Specimen) %>%
  summarise(Samples = n(),
    Pub_mean = mean(Li_Mg_proxy_season, na.rm = T),
            Pub_sd = sd(Li_Mg_proxy_season, na.rm = T),
            Pub_se = sd(Li_Mg_proxy_season, na.rm = T)/sqrt(n()),
        TJW_mean = mean(Li_Mg_proxy_season_TJW, na.rm = T),
            TJW_sd = sd(Li_Mg_proxy_season_TJW, na.rm = T),
            TJW_se = sd(Li_Mg_proxy_season_TJW, na.rm = T)/sqrt(n())) %>%
  mutate(Pub_alpha = c(0.499,0.259,0.989,0.586),
         TJW_alpha = c(0.399,0.378,1.41,0.781)) %>%
  pivot_longer(cols = c(3:10), names_to = "Calculation", values_to = "value") %>%
  separate(col = "Calculation", "_", into = c("Calibration", "Calculation")) %>%
  pivot_wider(names_from = "Calculation", values_from = "value") %>%
      ggplot() +
          geom_hline(yintercept = 1.1, linetype = 2) +
      geom_hline(yintercept = 0.68, linetype = 2) +
  geom_vline(xintercept = 0, linetype = 2) +
    geom_errorbar(aes(x = alpha, ymin = mean-sd, ymax = mean+sd, linetype = Calibration), 
                width = 0.1) +
      geom_point(aes(x = alpha, y = mean, col = Specimen, fill = Calibration), 
                 pch = 21, size = 4, stroke = 2) +
  scale_fill_manual(values = c("white", "black")) +
  scale_linetype_manual(values = c(3,1)) +
      labs(y = expression("T"["[rec]"]*" (°C)"), x = expression("T"["[rec]"]*" trend (°C.yr"^"-1"*")")) +
      scale_y_continuous(limits = c(-5,45)) +
      scale_x_continuous(limits = c(-0.25,1.5)) +
      theme_classic()

Li_Mg_thermometry_plot_annual_interpolation <- All_samples_thermometry_data_V2 %>%
      group_by(distance.um, Specimen) %>% 
      summarise(Timepoint = 2021-(distance.um/51),
            Li_Mg = Li_Ca/(Mg_Ca/1000),
            Li_Mg_proxy = ((log(Li_Mg/0.63))/-0.050),
            Li_Mg_proxy_TJW = ((log(Li_Mg/0.521))/-0.0343)
            ) %>%
  drop_na() %>%
  ungroup(distance.um) %>%
  group_by(Specimen) %>%
  summarise(
            Time = spline(Timepoint, Li_Mg_proxy_TJW, xout = seq(min(Timepoint),2021, by = 1))$x,
            Li_Mg_proxy_season_TJW = spline(Timepoint, Li_Mg_proxy_TJW, xout = seq(min(Timepoint),2021, by = 1))$y,
            Li_Mg_proxy_season = spline(Timepoint, Li_Mg_proxy, xout = seq(min(Timepoint),2021, by = 1))$y) %>% 
  ggplot() +
  geom_path(aes(Time, Li_Mg_proxy_season, group = Specimen, col = Specimen), linetype = 3) +
      geom_path(aes(Time, Li_Mg_proxy_season_TJW, group = Specimen, col = Specimen)) +

      geom_point(aes(x = 2018.6068, y =0.86), col = "darkgrey") +
      geom_point(aes(x = 2017.5466, y =0.68), col = "darkgrey") +
      geom_point(aes(x = 2016.5642, y =1.05), col = "darkgrey") +
      geom_point(aes(x = 2021.5849, y = 1.1), col = "darkgrey") +

      geom_point(aes(x = 2018.6068, y =0.86), col = "orange") +
      geom_point(aes(x = 2017.5466, y =0.68), col = "orange") +
      geom_point(aes(x = 2016.5642, y =1.05), col = "orange") +
      geom_point(aes(x = 2021.5849, y = 1.1), col = "orange") +

      labs(y = expression("T"["[rec]"]*" (°C)"), x = "Timepoint (years)") +
      geom_hline(yintercept = 1.1, linetype = 2) +
      geom_hline(yintercept = 0.68, linetype = 2) +
      geom_label(aes(y = 30, x = 1990, label = "Annual interpolation (spline)")) +
      scale_x_continuous(limits = c(1960,2021), breaks = seq(1960,2020,5), sec.axis = sec_axis(~ -(. - 2021)*51, name = "Distance from coral wall (µm)")) +
      scale_y_continuous(limits = c(-5,45)) +
      theme_classic()

Li_Mg_thermometry_plot_annual_interpolation_averages <- All_samples_thermometry_data_V2 %>%
      group_by(distance.um, Specimen) %>% 
      summarise(Timepoint = 2021-(distance.um/51),
            Li_Mg = Li_Ca/(Mg_Ca/1000),
            Li_Mg_proxy = ((log(Li_Mg/0.63))/-0.050),
            Li_Mg_proxy_TJW = ((log(Li_Mg/0.521))/-0.0343)
            ) %>%
  drop_na() %>%
  ungroup(distance.um) %>%
  group_by(Specimen) %>%
  summarise(
            Time = spline(Timepoint, Li_Mg_proxy_TJW, xout = seq(min(Timepoint),2021, by = 1))$x,
            Li_Mg_proxy_season_TJW = spline(Timepoint, Li_Mg_proxy_TJW, xout = seq(min(Timepoint),2021, by = 1))$y,
            Li_Mg_proxy_season = spline(Timepoint, Li_Mg_proxy, xout = seq(min(Timepoint),2021, by = 1))$y) %>% 
  filter(Time >= 2000 & Time <= 2021 & Li_Mg_proxy_season <= 45 & Li_Mg_proxy_season >= -5 & Li_Mg_proxy_season_TJW <= 45 & Li_Mg_proxy_season_TJW >= -5) %>%
  group_by(Specimen) %>%
  summarise(Samples = n(),
    Pub_mean = mean(Li_Mg_proxy_season, na.rm = T),
            Pub_sd = sd(Li_Mg_proxy_season, na.rm = T),
            Pub_se = sd(Li_Mg_proxy_season, na.rm = T)/sqrt(n()),
        TJW_mean = mean(Li_Mg_proxy_season_TJW, na.rm = T),
            TJW_sd = sd(Li_Mg_proxy_season_TJW, na.rm = T),
            TJW_se = sd(Li_Mg_proxy_season_TJW, na.rm = T)/sqrt(n())) %>%
  mutate(Pub_alpha = c(0.495,0.199,0.921,0.612),
         TJW_alpha = c(0.379,0.289,1.34,0.892)) %>%
  pivot_longer(cols = c(3:10), names_to = "Calculation", values_to = "value") %>%
  separate(col = "Calculation", "_", into = c("Calibration", "Calculation")) %>%
  pivot_wider(names_from = "Calculation", values_from = "value") %>%
      ggplot() +
          geom_hline(yintercept = 1.1, linetype = 2) +
      geom_hline(yintercept = 0.68, linetype = 2) +
  geom_vline(xintercept = 0, linetype = 2) +
    geom_errorbar(aes(x = alpha, ymin = mean-sd, ymax = mean+sd, linetype = Calibration), 
                width = 0.1) +
      geom_point(aes(x = alpha, y = mean, col = Specimen, fill = Calibration), 
                 pch = 21, size = 4, stroke = 2) +
  scale_fill_manual(values = c("white", "black")) +
  scale_linetype_manual(values = c(3,1)) +
      labs(y = expression("T"["[rec]"]*" (°C)"), x = expression("T"["[rec]"]*" trend (°C.yr"^"-1"*")")) +
      scale_y_continuous(limits = c(-5,45)) +
      scale_x_continuous(limits = c(-0.25,1.5)) +
      theme_classic()

Li_Mg_thermometry_plots <- Li_Mg_thermometry_plot_uninterpolated + theme(axis.title.x.bottom = element_blank(), axis.title.y = element_blank()) + 
  Li_Mg_thermometry_plot_uninterpolated_averages + theme(axis.title.x.bottom = element_blank(), axis.title.y = element_blank()) +
  Li_Mg_thermometry_plot_seasonal_interpolation  + theme(axis.title.x = element_blank()) +
  Li_Mg_thermometry_plot_seasonal_interpolation_averages  + theme(axis.title.x.bottom = element_blank(), axis.title.y = element_blank()) +
  Li_Mg_thermometry_plot_annual_interpolation + theme(axis.title.y = element_blank(), axis.title.x.top = element_blank()) +
  Li_Mg_thermometry_plot_annual_interpolation_averages + theme(axis.title.y = element_blank()) +
  plot_layout(design = layout, guides = "collect", )

### Remove coral edge and central axis - common timeframe is now 2003 to 2016 ####

Li_Mg_thermometry_plot_uninterpolated_constrained <- All_samples_thermometry_data_V2 %>%
      group_by(distance.um, Specimen) %>% 
      summarise(Timepoint = 2021-(distance.um/51),
            Li_Mg = Li_Ca/(Mg_Ca/1000),
            Li_Mg_proxy = ((log(Li_Mg/0.63))/-0.050),
            Li_Mg_proxy_TJW = ((log(Li_Mg/0.521))/-0.0343)) %>%
  ungroup() %>%
  filter(Specimen == "S_23_6" & Timepoint >= 1967 | Specimen == "S_23_1" & Timepoint >= 1999 |
           Specimen == "S_23_16" & Timepoint >= 2003 | Specimen == "S_23_10" & Timepoint >= 1996) %>%
      ggplot() +
      geom_path(aes(x = Timepoint, y = Li_Mg_proxy, col = Specimen), linetype = 3) + # Steward et al., 2020 Ear. Plan. Sci. Lett. for high-Mg octocorals
      geom_path(aes(x = Timepoint, y = Li_Mg_proxy_TJW, col = Specimen)) + # this study

geom_point(aes(x = 2018.6068, y =0.86), col = "darkgrey") +
      geom_point(aes(x = 2017.5466, y =0.68), col = "darkgrey") +
      geom_point(aes(x = 2016.5642, y =1.05), col = "darkgrey") +
      geom_point(aes(x = 2021.5849, y = 1.1), col = "darkgrey") +

geom_point(aes(x = 2018.6068, y =0.86), col = "orange") +
      geom_point(aes(x = 2017.5466, y =0.68), col = "orange") +
      geom_point(aes(x = 2016.5642, y =1.05), col = "orange") +
      geom_point(aes(x = 2021.5849, y = 1.1), col = "orange") +

      labs(y = expression("T"["[rec]"]*" (°C)"), x = "Timepoint (years)") +
      geom_hline(yintercept = 1.1, linetype = 2) +
      geom_hline(yintercept = 0.68, linetype = 2) +
      geom_label(aes(y = 30, x = 1990, label = "No interpolation")) +
      scale_x_continuous(limits = c(1960,2016), breaks = seq(1960,2020,5), sec.axis = sec_axis(~ -(. - 2021)*51, name = "Distance from coral wall (µm)")) +
      scale_y_continuous(limits = c(-5,45)) +
      theme_classic()

Li_Mg_thermometry_plot_uninterpolated_constrained_averages <- All_samples_thermometry_data_V2 %>%
      group_by(distance.um, Specimen) %>% 
      summarise(Timepoint = 2021-(distance.um/51),
            Li_Mg = Li_Ca/(Mg_Ca/1000),
            Li_Mg_proxy = ((log(Li_Mg/0.63))/-0.050),
            Li_Mg_proxy_TJW = ((log(Li_Mg/0.521))/-0.0343)) %>%
  ungroup() %>%
  filter(Specimen == "S_23_6" & Timepoint >= 1967 | Specimen == "S_23_1" & Timepoint >= 1999 |
           Specimen == "S_23_16" & Timepoint >= 2003 | Specimen == "S_23_10" & Timepoint >= 1996) %>%
  filter(Timepoint >= 2003 & Timepoint <= 2016 & Li_Mg_proxy <= 45 & Li_Mg_proxy >= -5 & Li_Mg_proxy_TJW <= 45 & Li_Mg_proxy_TJW >= -5) %>%
  group_by(Specimen) %>%
  summarise(Samples = n(),
    Pub_mean = mean(Li_Mg_proxy, na.rm = T),
            Pub_sd = sd(Li_Mg_proxy, na.rm = T),
            Pub_se = sd(Li_Mg_proxy, na.rm = T)/sqrt(n()),
        TJW_mean = mean(Li_Mg_proxy_TJW, na.rm = T),
            TJW_sd = sd(Li_Mg_proxy_TJW, na.rm = T),
            TJW_se = sd(Li_Mg_proxy_TJW, na.rm = T)/sqrt(n())) %>%
  mutate(Pub_alpha = c(-0.13,-0.06,0.3,0.345),
         TJW_alpha = c(-0.19,-0.09,0.437,0.502)) %>%
  pivot_longer(cols = c(3:10), names_to = "Calculation", values_to = "value") %>%
  separate(col = "Calculation", "_", into = c("Calibration", "Calculation")) %>%
  pivot_wider(names_from = "Calculation", values_from = "value") %>%
      ggplot() +
          geom_hline(yintercept = 1.1, linetype = 2) +
      geom_hline(yintercept = 0.68, linetype = 2) +
  geom_vline(xintercept = 0, linetype = 2) +
    geom_errorbar(aes(x = alpha, ymin = mean-sd, ymax = mean+sd, linetype = Calibration), 
                width = 0.1) +
      geom_point(aes(x = alpha, y = mean, col = Specimen, fill = Calibration), 
                 pch = 21, size = 4, stroke = 2) +
  scale_fill_manual(values = c("white", "black")) +
  scale_linetype_manual(values = c(3,1)) +
      labs(y = expression("T"["[rec]"]*" (°C)"), x = expression("T"["[rec]"]*" trend (°C.yr"^"-1"*")")) +
      scale_y_continuous(limits = c(-5,45)) +
      scale_x_continuous(limits = c(-0.25,0.75)) +
      theme_classic()

Li_Mg_thermometry_plot_seasonal_interpolation_constrained <- All_samples_thermometry_data_V2 %>%
      group_by(distance.um, Specimen) %>% 
      summarise(Timepoint = 2021-(distance.um/51),
            Li_Mg = Li_Ca/(Mg_Ca/1000),
            Li_Mg_proxy = ((log(Li_Mg/0.63))/-0.050),
            Li_Mg_proxy_TJW = ((log(Li_Mg/0.521))/-0.0343)) %>%
  drop_na() %>%
  ungroup() %>%
  filter(Specimen == "S_23_6" & Timepoint >= 1967 | Specimen == "S_23_1" & Timepoint >= 1999 |
           Specimen == "S_23_16" & Timepoint >= 2003 | Specimen == "S_23_10" & Timepoint >= 1996) %>%
  group_by(Specimen) %>%
  summarise(
            Time = spline(Timepoint, Li_Mg_proxy_TJW, xout = seq(min(Timepoint),2021, by = 0.25))$x,
            Li_Mg_proxy_season_TJW = spline(Timepoint, Li_Mg_proxy_TJW, xout = seq(min(Timepoint),2021, by = 0.25))$y,
            Li_Mg_proxy_season = spline(Timepoint, Li_Mg_proxy, xout = seq(min(Timepoint),2021, by = 0.25))$y) %>% 
  ggplot() +
  geom_path(aes(Time, Li_Mg_proxy_season_TJW, group = Specimen, col = Specimen)) +
  geom_path(aes(Time, Li_Mg_proxy_season, group = Specimen, col = Specimen), linetype = 3) +

  geom_point(aes(x = 2018.6068, y =0.86), col = "darkgrey") +
      geom_point(aes(x = 2017.5466, y =0.68), col = "darkgrey") +
      geom_point(aes(x = 2016.5642, y =1.05), col = "darkgrey") +
      geom_point(aes(x = 2021.5849, y = 1.1), col = "darkgrey") +

  geom_point(aes(x = 2018.6068, y =0.86), col = "orange") +
      geom_point(aes(x = 2017.5466, y =0.68), col = "orange") +
      geom_point(aes(x = 2016.5642, y =1.05), col = "orange") +
      geom_point(aes(x = 2021.5849, y = 1.1), col = "orange") +

      labs(y = expression("T"["[rec]"]*" (°C)"), x = "Timepoint (years)") +
      geom_hline(yintercept = 1.1, linetype = 2) +
      geom_hline(yintercept = 0.68, linetype = 2) +
      geom_label(aes(y = 30, x = 1990, label = "Seasonal interpolation (spline)")) +
      scale_x_continuous(limits = c(1960,2016), breaks = seq(1960,2020,5), sec.axis = sec_axis(~ -(. - 2021)*51, name = "Distance from coral wall (µm)")) +
      scale_y_continuous(limits = c(-5,45)) +
      theme_classic()

Li_Mg_thermometry_plot_seasonal_interpolation_constrained_averages <- All_samples_thermometry_data_V2 %>%
      group_by(distance.um, Specimen) %>% 
      summarise(Timepoint = 2021-(distance.um/51),
            Li_Mg = Li_Ca/(Mg_Ca/1000),
            Li_Mg_proxy = ((log(Li_Mg/0.63))/-0.050),
            Li_Mg_proxy_TJW = ((log(Li_Mg/0.521))/-0.0343)) %>%
  drop_na() %>%
  ungroup() %>%
  filter(Specimen == "S_23_6" & Timepoint >= 1967 | Specimen == "S_23_1" & Timepoint >= 1999 |
           Specimen == "S_23_16" & Timepoint >= 2003 | Specimen == "S_23_10" & Timepoint >= 1996) %>%
  group_by(Specimen) %>%
  summarise(
            Time = spline(Timepoint, Li_Mg_proxy_TJW, xout = seq(min(Timepoint),2021, by = 0.25))$x,
            Li_Mg_proxy_season_TJW = spline(Timepoint, Li_Mg_proxy_TJW, xout = seq(min(Timepoint),2021, by = 0.25))$y,
            Li_Mg_proxy_season = spline(Timepoint, Li_Mg_proxy, xout = seq(min(Timepoint),2021, by = 0.25))$y) %>% 
  filter(Time >= 2003 & Time <= 2016 & Li_Mg_proxy_season <= 45 & Li_Mg_proxy_season >= -5 & Li_Mg_proxy_season_TJW <= 45 & Li_Mg_proxy_season_TJW >= -5) %>%
  group_by(Specimen) %>%
  summarise(Samples = n(),
    Pub_mean = mean(Li_Mg_proxy_season, na.rm = T),
            Pub_sd = sd(Li_Mg_proxy_season, na.rm = T),
            Pub_se = sd(Li_Mg_proxy_season, na.rm = T)/sqrt(n()),
        TJW_mean = mean(Li_Mg_proxy_season_TJW, na.rm = T),
            TJW_sd = sd(Li_Mg_proxy_season_TJW, na.rm = T),
            TJW_se = sd(Li_Mg_proxy_season_TJW, na.rm = T)/sqrt(n())) %>%
  mutate(Pub_alpha = c(-0.12,-0.06,0.281,0.342),
         TJW_alpha = c(-0.18, -0.09, 0.41, 0.498)) %>%
  pivot_longer(cols = c(3:10), names_to = "Calculation", values_to = "value") %>%
  separate(col = "Calculation", "_", into = c("Calibration", "Calculation")) %>%
  pivot_wider(names_from = "Calculation", values_from = "value") %>%
      ggplot() +
          geom_hline(yintercept = 1.1, linetype = 2) +
      geom_hline(yintercept = 0.68, linetype = 2) +
  geom_vline(xintercept = 0, linetype = 2) +
    geom_errorbar(aes(x = alpha, ymin = mean-sd, ymax = mean+sd, linetype = Calibration), 
                width = 0.1) +
      geom_point(aes(x = alpha, y = mean, col = Specimen, fill = Calibration), 
                 pch = 21, size = 4, stroke = 2) +
  scale_fill_manual(values = c("white", "black")) +
  scale_linetype_manual(values = c(3,1)) +
      labs(y = expression("T"["[rec]"]*" (°C)"), x = expression("T"["[rec]"]*" trend (°C.yr"^"-1"*")")) +
      scale_y_continuous(limits = c(-5,45)) +
      scale_x_continuous(limits = c(-0.25,0.75)) +
      theme_classic()

Li_Mg_thermometry_plot_annual_interpolation_constrained <- All_samples_thermometry_data_V2 %>%
      group_by(distance.um, Specimen) %>% 
      summarise(Timepoint = 2021-(distance.um/51),
            Li_Mg = Li_Ca/(Mg_Ca/1000),
            Li_Mg_proxy = ((log(Li_Mg/0.63))/-0.050),
            Li_Mg_proxy_TJW = ((log(Li_Mg/0.521))/-0.0343)
            ) %>%
  drop_na() %>%
  ungroup() %>%
  filter(Specimen == "S_23_6" & Timepoint >= 1967 | Specimen == "S_23_1" & Timepoint >= 1999 |
           Specimen == "S_23_16" & Timepoint >= 2003 | Specimen == "S_23_10" & Timepoint >= 1996) %>%
  group_by(Specimen) %>%
  summarise(
            Time = spline(Timepoint, Li_Mg_proxy_TJW, xout = seq(min(Timepoint),2021, by = 1))$x,
            Li_Mg_proxy_season_TJW = spline(Timepoint, Li_Mg_proxy_TJW, xout = seq(min(Timepoint),2021, by = 1))$y,
            Li_Mg_proxy_season = spline(Timepoint, Li_Mg_proxy, xout = seq(min(Timepoint),2021, by = 1))$y) %>% 
  ggplot() +
  geom_path(aes(Time, Li_Mg_proxy_season, group = Specimen, col = Specimen), linetype = 3) +
      geom_path(aes(Time, Li_Mg_proxy_season_TJW, group = Specimen, col = Specimen)) +

      geom_point(aes(x = 2018.6068, y =0.86), col = "darkgrey") +
      geom_point(aes(x = 2017.5466, y =0.68), col = "darkgrey") +
      geom_point(aes(x = 2016.5642, y =1.05), col = "darkgrey") +
      geom_point(aes(x = 2021.5849, y = 1.1), col = "darkgrey") +

      geom_point(aes(x = 2018.6068, y =0.86), col = "orange") +
      geom_point(aes(x = 2017.5466, y =0.68), col = "orange") +
      geom_point(aes(x = 2016.5642, y =1.05), col = "orange") +
      geom_point(aes(x = 2021.5849, y = 1.1), col = "orange") +

      labs(y = expression("T"["[rec]"]*" (°C)"), x = "Timepoint (years)") +
      geom_hline(yintercept = 1.1, linetype = 2) +
      geom_hline(yintercept = 0.68, linetype = 2) +
      geom_label(aes(y = 30, x = 1990, label = "Annual interpolation (spline)")) +
      scale_x_continuous(limits = c(1960,2016), breaks = seq(1960,2020,5), sec.axis = sec_axis(~ -(. - 2021)*51, name = "Distance from coral wall (µm)")) +
      scale_y_continuous(limits = c(-5,45)) +
      theme_classic()

Li_Mg_thermometry_plot_annual_interpolation_constrained_averages <- All_samples_thermometry_data_V2 %>%
      group_by(distance.um, Specimen) %>% 
      summarise(Timepoint = 2021-(distance.um/51),
            Li_Mg = Li_Ca/(Mg_Ca/1000),
            Li_Mg_proxy = ((log(Li_Mg/0.63))/-0.050),
            Li_Mg_proxy_TJW = ((log(Li_Mg/0.521))/-0.0343)
            ) %>%
  drop_na() %>%
  ungroup() %>%
  filter(Specimen == "S_23_6" & Timepoint >= 1967 | Specimen == "S_23_1" & Timepoint >= 1999 |
           Specimen == "S_23_16" & Timepoint >= 2003 | Specimen == "S_23_10" & Timepoint >= 1996) %>%
  group_by(Specimen) %>%
  summarise(
            Time = spline(Timepoint, Li_Mg_proxy_TJW, xout = seq(min(Timepoint),2021, by = 1))$x,
            Li_Mg_proxy_season_TJW = spline(Timepoint, Li_Mg_proxy_TJW, xout = seq(min(Timepoint),2021, by = 1))$y,
            Li_Mg_proxy_season = spline(Timepoint, Li_Mg_proxy, xout = seq(min(Timepoint),2021, by = 1))$y) %>% 
  filter(Time >= 2003 & Time <= 2016 & Li_Mg_proxy_season <= 45 & Li_Mg_proxy_season >= -5 & Li_Mg_proxy_season_TJW <= 45 & Li_Mg_proxy_season_TJW >= -5) %>%
  group_by(Specimen) %>%
  summarise(Samples = n(),
    Pub_mean = mean(Li_Mg_proxy_season, na.rm = T),
            Pub_sd = sd(Li_Mg_proxy_season, na.rm = T),
            Pub_se = sd(Li_Mg_proxy_season, na.rm = T)/sqrt(n()),
        TJW_mean = mean(Li_Mg_proxy_season_TJW, na.rm = T),
            TJW_sd = sd(Li_Mg_proxy_season_TJW, na.rm = T),
            TJW_se = sd(Li_Mg_proxy_season_TJW, na.rm = T)/sqrt(n())) %>%
  mutate(Pub_alpha = c(-0.11,-0.07,0.28,0.362),
         TJW_alpha = c(-0.16, -0.11, 0.408, 0.527)) %>%
  pivot_longer(cols = c(3:10), names_to = "Calculation", values_to = "value") %>%
  separate(col = "Calculation", "_", into = c("Calibration", "Calculation")) %>%
  pivot_wider(names_from = "Calculation", values_from = "value") %>%
      ggplot() +
          geom_hline(yintercept = 1.1, linetype = 2) +
      geom_hline(yintercept = 0.68, linetype = 2) +
  geom_vline(xintercept = 0, linetype = 2) +
    geom_errorbar(aes(x = alpha, ymin = mean-sd, ymax = mean+sd, linetype = Calibration), 
                width = 0.1) +
      geom_point(aes(x = alpha, y = mean, col = Specimen, fill = Calibration), 
                 pch = 21, size = 4, stroke = 2) +
  scale_fill_manual(values = c("white", "black")) +
  scale_linetype_manual(values = c(3,1)) +
      labs(y = expression("T"["[rec]"]*" (°C)"), x = expression("T"["[rec]"]*" trend (°C.yr"^"-1"*")")) +
      scale_y_continuous(limits = c(-5,45)) +
      scale_x_continuous(limits = c(-0.25,0.75)) +
      theme_classic()

Li_Mg_thermometry_plots_constrained <- Li_Mg_thermometry_plot_uninterpolated_constrained + theme(axis.title.x.bottom = element_blank(), axis.title.y = element_blank()) + 
  Li_Mg_thermometry_plot_uninterpolated_constrained_averages + theme(axis.title.x.bottom = element_blank(), axis.title.y = element_blank()) +
  Li_Mg_thermometry_plot_seasonal_interpolation_constrained  + theme(axis.title.x = element_blank()) +
  Li_Mg_thermometry_plot_seasonal_interpolation_constrained_averages  + theme(axis.title.x.bottom = element_blank(), axis.title.y = element_blank()) +
  Li_Mg_thermometry_plot_annual_interpolation_constrained + theme(axis.title.y = element_blank(), axis.title.x.top = element_blank()) +
  Li_Mg_thermometry_plot_annual_interpolation_constrained_averages + theme(axis.title.y = element_blank()) +
  plot_layout(design = layout, guides = "collect")
    
## Mg ####

layout_2 <- "
AABBCC
AABBCC
AABBCC
AABBCC
"
# New facet label names for supp variable
sample_labs <- c("23-1", "23-10", "23-16", "23-6")
names(sample_labs) <- c("S_23_1", "S_23_10", "S_23_16", "S_23_6")
All_samples_thermometry_data_V2$Specimen <- factor(All_samples_thermometry_data_V2$Specimen, levels = c("S_23_16", "S_23_1", "S_23_10", "S_23_6"))

Mg_thermometry_trends <- data.frame(Relationship = as.character(),
              Specimen = as.character(),
              Internode = as.numeric(),
              Timerange = as.character(),
              Interpolation = as.character(),
                          n = as.numeric(),
                          r = as.numeric(),
                          rsq = as.numeric(),
                          Regression_type = as.character(),
                          p = as.numeric(),
                          Ttrend_Gradient = as.numeric(),
                          Ttrend_Gradient_2SD = as.numeric(),
                          Ttrend_Intercept = as.numeric(),
                          Ttrend_Intercept_2SD = as.numeric())

### Common timeframe is 2000 to 2021 ####
#### uninterpolated ####
All_samples_Mg_thermometry <- All_samples_thermometry_data_V2 %>%
      group_by(distance.um, Specimen, Internode) %>% 
      summarise(Timepoint = 2021-(distance.um/51),
            # Mg_Ca_proxy = ((0.34*Mg_Ca/1000)-23.9),
            Mg_Ca_proxy_TJW = ((0.32*Mg_Ca/1000)-21.88),
            Mg_Ca_proxy_TJW_LL = ((0.29*Mg_Ca/1000)-24.22), # 95% CI
            Mg_Ca_proxy_TJW_UL = ((0.34*Mg_Ca/1000)-19.55)) %>%
  na.omit()

All_samples_Mg_thermometry_common <- All_samples_Mg_thermometry %>%
  filter(Timepoint >= 2000 & Timepoint <= 2021 & Mg_Ca_proxy_TJW <= 10 & Mg_Ca_proxy_TJW >= -5)

Mg_thermometry_plot_uninterpolated <- All_samples_Mg_thermometry %>%
      ggplot() +
      # geom_path(aes(x = Timepoint, y = Mg_Ca_proxy, col = Specimen), linetype = 3)+ # Thresher et al., 2016 - Geochim. et Cosmich. Acta
      geom_ribbon(aes(x = Timepoint, ymin = Mg_Ca_proxy_TJW_LL, ymax = Mg_Ca_proxy_TJW_UL, fill = as.factor(Specimen), linetype = as.factor(Internode)), alpha = 0.4) +
      geom_path(aes(x = Timepoint, y = Mg_Ca_proxy_TJW, linetype = as.factor(Internode), col = as.factor(Specimen)), lwd = 0.8) + # My calculated relationship
      geom_point(aes(x = 2018.6068, y =0.86), col = "darkgrey") +
      geom_point(aes(x = 2017.5466, y =0.68), col = "darkgrey") +
      geom_point(aes(x = 2016.5642, y =1.05), col = "darkgrey") +
      geom_point(aes(x = 2021.5849, y = 1.1), col = "darkgrey") +
      labs(y = expression("T"["[rec]"]*" (°C)"), x = "Timepoint (years)") +
      geom_hline(yintercept = 1.1, linetype = 4, col = "darkgrey") +
      geom_hline(yintercept = 0.68, linetype = 4, col = "darkgrey") +
      scale_x_continuous(limits = c(1960, 2021), breaks = seq(1960,2020,5), sec.axis = sec_axis(~ -(. - 2021)*51, name = "Distance from coral wall (µm)")) +
      coord_cartesian(ylim = c(-5,10), xlim = c(1960,2021)) +
      scale_fill_discrete(name = "Colony ID", breaks = c("S_23_1", "S_23_10", "S_23_16", "S_23_6"), labels = c("23-1", "23-10", "23-16", "23-6")) +
      scale_colour_manual(name = "Colony ID", breaks = c("S_23_1", "S_23_10", "S_23_16", "S_23_6"), labels = c("23-1", "23-10", "23-16", "23-6"), values = c("#003300", "#000099", "#990000", "#330066")) +
      scale_linetype_manual(name = "Internode", values = c(1,2,3)) +
      facet_grid(rows = vars(Specimen), labeller = labeller(Specimen = sample_labs)) +
      theme_classic()


library(lmodel2)
for(i in levels(All_samples_Mg_thermometry_common$Specimen)){
  for (j in 1:3) {
    lmodel <- lmodel2(Mg_Ca_proxy_TJW ~ Timepoint, data = All_samples_Mg_thermometry_common[which(All_samples_Mg_thermometry_common$Specimen == i & All_samples_Mg_thermometry_common$Internode == j),], "interval", "interval", 999)
    
    OLS_intercept <- lmodel$regression.results[1,2]
    OLS_slope <- lmodel$regression.results[1,3]
    OLS_p <- lmodel$regression.results[1,5]
    RMA_intercept <- lmodel$regression.results[4,2]
    RMA_slope <- lmodel$regression.results[4,3]
    RMA_p <- lmodel$regression.results[4,5]
    
    lmodel_n <- lmodel$n
    lmodel_r <- lmodel$r
    lmodel_rsq <- lmodel$rsquare
    OLS_intercept_2SD <- OLS_intercept - lmodel$confidence.intervals[1,2]
    OLS_slope_2SD <- OLS_slope - lmodel$confidence.intervals[1,4]
    RMA_intercept_2SD <- RMA_intercept - lmodel$confidence.intervals[4,2]
    RMA_slope_2SD <- RMA_slope - lmodel$confidence.intervals[4,4]
    
    Mg_thermometry_trends <- Mg_thermometry_trends %>%
      add_row(Relationship = paste0("Temperature ~ Time"),
              Specimen = i,
              Internode = j,
              Timerange = "2000-2021",
              Interpolation = "none",
                          n = lmodel_n,
                          r = lmodel_r,
                          rsq = lmodel_rsq,
                          Regression_type = "OLS",
                          p = OLS_p,
                          Ttrend_Gradient = OLS_slope,
                          Ttrend_Gradient_2SD = OLS_slope_2SD,
                          Ttrend_Intercept = OLS_intercept,
                          Ttrend_Intercept_2SD = OLS_intercept_2SD)
    
         Mg_thermometry_trends <- Mg_thermometry_trends %>%
      add_row(Relationship = paste0("Temperature ~ Time"),
              Specimen = i,
              Internode = j,
              Timerange = "2000-2021",
              Interpolation = "none",
                          n = lmodel_n,
                          r = lmodel_r,
                          rsq = lmodel_rsq,
                          Regression_type = "RMA",
                          p = RMA_p,
                          Ttrend_Gradient = RMA_slope,
                          Ttrend_Gradient_2SD = RMA_slope_2SD,
                          Ttrend_Intercept = RMA_intercept,
                          Ttrend_Intercept_2SD = RMA_intercept_2SD)
  }
}


Mg_thermometry_plot_uninterpolated_averages <- All_samples_Mg_thermometry_common %>%
  group_by(Specimen, Internode) %>%
  summarise(Samples = n(),
            Interpolation = "none",
            Timerange = "2000-2021",
    # Pub_mean = mean(Mg_Ca_proxy, na.rm = T),
    #         Pub_sd = sd(Mg_Ca_proxy, na.rm = T),
    #         Pub_se = sd(Mg_Ca_proxy, na.rm = T)/sqrt(n()),
        Trec_mean = mean(Mg_Ca_proxy_TJW, na.rm = T),
            Trec_sd = sd(Mg_Ca_proxy_TJW, na.rm = T),
            Trec_se = sd(Mg_Ca_proxy_TJW, na.rm = T)/sqrt(n())) %>%
  left_join(Mg_thermometry_trends, by = c("Specimen", "Internode", "Interpolation", "Timerange")) %>%
  # pivot_longer(cols = c(6:9), names_to = "Calculation", values_to = "value") %>%
  # separate(col = "Calculation", "_", into = c("Calibration", "Calculation")) %>%
  # pivot_wider(names_from = "Calculation", values_from = "value") %>%
  filter(Regression_type == "OLS") %>%
      ggplot() +
      geom_hline(yintercept = 1.1, linetype = 4, col = "darkgrey") +
      geom_hline(yintercept = 0.68, linetype = 4, col = "darkgrey") +
  geom_vline(xintercept = SST_plot_uninterpolated_common_trend, linetype = 4, col = "#FF9933") +
  geom_vline(xintercept = 0.01684166, linetype = 4, col = "#000033") +
  annotate("text", x = 0.02684166, y = 7, label = "webODV", angle = -90, col = "#000033") +
  annotate("text", x = SST_plot_uninterpolated_common_trend-0.01, y = 7, label = "OISST", angle = 90, col = "#FF9933") +
  geom_errorbar(aes(x = Ttrend_Gradient, ymin = Trec_mean-Trec_sd, ymax = Trec_mean+Trec_sd, linetype = as.factor(Internode)), 
                width = 0.025, lwd = 1) +
    geom_errorbarh(aes(xmin = Ttrend_Gradient-(Ttrend_Gradient_2SD/2), xmax = Ttrend_Gradient+(Ttrend_Gradient_2SD/2), y = Trec_mean, linetype = as.factor(Internode)),
                 height = 0.5, lwd = 1) +
      geom_point(aes(x = Ttrend_Gradient, y = Trec_mean, fill = Specimen), 
                 pch = 21, size = 4, stroke = 2) +
  # scale_fill_manual(values = c("white", "black")) +
  scale_linetype_manual(values = c(1,2,3), name = "Internode") +
  scale_fill_manual(name = "Colony ID", breaks = c("S_23_1", "S_23_10", "S_23_16", "S_23_6"), labels = c("23-1", "23-10", "23-16", "23-6"), values = c("#99CC66", "#33CCCC", "#FF6666", "#9933FF")) +
      labs(y = expression("T"["[rec]"]*" (°C)"), x = expression("T"["[rec]"]*" trend (°C.yr"^"-1"*")")) +
       scale_y_continuous(limits = c(-1,8)) +
      scale_x_continuous(limits = c(-0.65,0.1)) +
      theme_classic()

#### seasonally interpolated ####
All_samples_Mg_thermometry_season <- All_samples_Mg_thermometry %>% 
  drop_na() %>%
  ungroup(distance.um) %>%
  group_by(Specimen, Internode) %>%
  summarise(
            Time = spline(Timepoint, Mg_Ca_proxy_TJW, xout = seq(min(Timepoint),2021, by = 0.25))$x,
            Mg_Ca_proxy_season_TJW = spline(Timepoint, Mg_Ca_proxy_TJW, xout = seq(min(Timepoint),2021, by = 0.25))$y,
            Mg_Ca_proxy_season_TJW_LL = spline(Timepoint, Mg_Ca_proxy_TJW_LL, xout = seq(min(Timepoint),2021, by = 0.25))$y,
            Mg_Ca_proxy_season_TJW_UL = spline(Timepoint, Mg_Ca_proxy_TJW_UL, xout = seq(min(Timepoint),2021, by = 0.25))$y)

All_samples_Mg_thermometry_season_common <- All_samples_Mg_thermometry_season %>%
  filter(Time >= 2000 & Time <= 2021 & Mg_Ca_proxy_season_TJW <= 10 & Mg_Ca_proxy_season_TJW >= -5)

Mg_thermometry_plot_seasonal_interpolation <-  All_samples_Mg_thermometry_season %>% 
  ggplot() +
    geom_ribbon(aes(x = Time, ymin = Mg_Ca_proxy_season_TJW_LL, ymax = Mg_Ca_proxy_season_TJW_UL, fill = as.factor(Specimen), linetype = as.factor(Internode)), alpha = 0.4) +
    geom_path(aes(x = Time, y = Mg_Ca_proxy_season_TJW, linetype = as.factor(Internode), col = as.factor(Specimen)), lwd = 0.8) + # My calculated relationship
      geom_point(aes(x = 2018.6068, y =0.86), col = "darkgrey") +
      geom_point(aes(x = 2017.5466, y =0.68), col = "darkgrey") +
      geom_point(aes(x = 2016.5642, y =1.05), col = "darkgrey") +
      geom_point(aes(x = 2021.5849, y = 1.1), col = "darkgrey") +
      labs(y = expression("T"["[rec]"]*" (°C)"), x = "Timepoint (years)") +
      geom_hline(yintercept = 1.1, linetype = 4, col = "darkgrey") +
      geom_hline(yintercept = 0.68, linetype = 4, col = "darkgrey") +
      scale_x_continuous(limits = c(1960,2021), breaks = seq(1960,2020,5), sec.axis = sec_axis(~ -(. - 2021)*51, name = "Distance from coral wall (µm)")) +
      coord_cartesian(ylim = c(-5,10), xlim = c(1960,2021)) +
      scale_fill_discrete(name = "Colony ID", breaks = c("S_23_1", "S_23_10", "S_23_16", "S_23_6"), labels = c("23-1", "23-10", "23-16", "23-6")) +
      scale_colour_manual(name = "Colony ID", breaks = c("S_23_1", "S_23_10", "S_23_16", "S_23_6"), labels = c("23-1", "23-10", "23-16", "23-6"), values = c("#003300", "#000099", "#990000", "#330066")) +
  scale_linetype_manual(name = "Internode", values = c(1,2,3)) +
      facet_grid(rows = vars(Specimen), labeller = labeller(Specimen = sample_labs)) +
      theme_classic()


for(i in levels(All_samples_Mg_thermometry_season_common$Specimen)){
  for (j in 1:3) {
    lmodel <- lmodel2(Mg_Ca_proxy_season_TJW ~ Time, data = All_samples_Mg_thermometry_season_common[which(All_samples_Mg_thermometry_season_common$Specimen == i & All_samples_Mg_thermometry_season_common$Internode == j),], "interval", "interval", 999)
    OLS_intercept <- lmodel$regression.results[1,2]
    OLS_slope <- lmodel$regression.results[1,3]
    OLS_p <- lmodel$regression.results[1,5]
    RMA_intercept <- lmodel$regression.results[4,2]
    RMA_slope <- lmodel$regression.results[4,3]
    RMA_p <- lmodel$regression.results[4,5]
    
    lmodel_n <- lmodel$n
    lmodel_r <- lmodel$r
    lmodel_rsq <- lmodel$rsquare
    OLS_intercept_2SD <- OLS_intercept - lmodel$confidence.intervals[1,2]
    OLS_slope_2SD <- OLS_slope - lmodel$confidence.intervals[1,4]
    RMA_intercept_2SD <- RMA_intercept - lmodel$confidence.intervals[4,2]
    RMA_slope_2SD <- RMA_slope - lmodel$confidence.intervals[4,4]
    
    Mg_thermometry_trends <- Mg_thermometry_trends %>%
      add_row(Relationship = paste0("Temperature ~ Time"),
              Specimen = i,
              Internode = j,
              Timerange = "2000-2021",
              Interpolation = "seasonal",
                          n = lmodel_n,
                          r = lmodel_r,
                          rsq = lmodel_rsq,
                          Regression_type = "OLS",
                          p = OLS_p,
                          Ttrend_Gradient = OLS_slope,
                          Ttrend_Gradient_2SD = OLS_slope_2SD,
                          Ttrend_Intercept = OLS_intercept,
                          Ttrend_Intercept_2SD = OLS_intercept_2SD)
    
         Mg_thermometry_trends <- Mg_thermometry_trends %>%
      add_row(Relationship = paste0("Temperature ~ Time"),
              Specimen = i,
              Internode = j,
              Timerange = "2000-2021",
              Interpolation = "seasonal",
                          n = lmodel_n,
                          r = lmodel_r,
                          rsq = lmodel_rsq,
                          Regression_type = "RMA",
                          p = RMA_p,
                          Ttrend_Gradient = RMA_slope,
                          Ttrend_Gradient_2SD = RMA_slope_2SD,
                          Ttrend_Intercept = RMA_intercept,
                          Ttrend_Intercept_2SD = RMA_intercept_2SD)
  }
}

Mg_thermometry_plot_seasonal_interpolation_averages <- All_samples_Mg_thermometry_season_common %>%
  group_by(Specimen, Internode) %>%
  summarise(Samples = n(),
            Interpolation = "seasonal",
            Timerange = "2000-2021",
    # Pub_mean = mean(Mg_Ca_proxy, na.rm = T),
    #         Pub_sd = sd(Mg_Ca_proxy, na.rm = T),
    #         Pub_se = sd(Mg_Ca_proxy, na.rm = T)/sqrt(n()),
        Trec_mean = mean(Mg_Ca_proxy_season_TJW, na.rm = T),
            Trec_sd = sd(Mg_Ca_proxy_season_TJW, na.rm = T),
            Trec_se = sd(Mg_Ca_proxy_season_TJW, na.rm = T)/sqrt(n())) %>%
  left_join(Mg_thermometry_trends, by = c("Specimen", "Internode", "Interpolation", "Timerange")) %>%
  # pivot_longer(cols = c(6:9), names_to = "Calculation", values_to = "value") %>%
  # separate(col = "Calculation", "_", into = c("Calibration", "Calculation")) %>%
  # pivot_wider(names_from = "Calculation", values_from = "value") %>%
  filter(Regression_type == "OLS") %>%
      ggplot() +
geom_hline(yintercept = 1.1, linetype = 4, col = "darkgrey") +
      geom_hline(yintercept = 0.68, linetype = 4, col = "darkgrey") +
  geom_vline(xintercept = SST_plot_season_interpolated_common_trend, linetype = 4, col = "#FF9933") +
  geom_vline(xintercept = 0.01684166, linetype = 4, col = "#000033") +
  annotate("text", x = 0.02684166, y = 7, label = "webODV", angle = -90, col = "#000033") +
  annotate("text", x = SST_plot_season_interpolated_common_trend-0.01, y = 7, label = "OISST", angle = 90, col = "#FF9933") +
  geom_errorbar(aes(x = Ttrend_Gradient, ymin = Trec_mean-Trec_sd, ymax = Trec_mean+Trec_sd, linetype = as.factor(Internode)), 
                width = 0.025, lwd = 1) +
    geom_errorbarh(aes(xmin = Ttrend_Gradient-(Ttrend_Gradient_2SD/2), xmax = Ttrend_Gradient+(Ttrend_Gradient_2SD/2), y = Trec_mean, linetype = as.factor(Internode)),
                 height = 0.5, lwd = 1) +
      geom_point(aes(x = Ttrend_Gradient, y = Trec_mean, fill = Specimen), 
                 pch = 21, size = 4, stroke = 2) +
  # scale_fill_manual(values = c("white", "black")) +
  scale_linetype_manual(values = c(1,2,3), name = "Internode") +
  scale_fill_manual(name = "Colony ID", breaks = c("S_23_1", "S_23_10", "S_23_16", "S_23_6"), labels = c("23-1", "23-10", "23-16", "23-6"), values = c("#99CC66", "#33CCCC", "#FF6666", "#9933FF")) +
      labs(y = expression("T"["[rec]"]*" (°C)"), x = expression("T"["[rec]"]*" trend (°C.yr"^"-1"*")")) +
       scale_y_continuous(limits = c(-1,8)) +
      scale_x_continuous(limits = c(-0.65,0.1)) +
      theme_classic()

#### annually interpolated ####
All_samples_Mg_thermometry_annual <- All_samples_Mg_thermometry %>% 
  drop_na() %>%
  ungroup(distance.um) %>%
  group_by(Specimen, Internode) %>%
  summarise(
            Time = spline(Timepoint, Mg_Ca_proxy_TJW, xout = seq(min(Timepoint),2021, by = 1))$x,
            Mg_Ca_proxy_annual_TJW = spline(Timepoint, Mg_Ca_proxy_TJW, xout = seq(min(Timepoint),2021, by = 1))$y,
            Mg_Ca_proxy_annual_TJW_LL = spline(Timepoint, Mg_Ca_proxy_TJW_LL, xout = seq(min(Timepoint),2021, by = 1))$y,
            Mg_Ca_proxy_annual_TJW_UL = spline(Timepoint, Mg_Ca_proxy_TJW_UL, xout = seq(min(Timepoint),2021, by = 1))$y)

All_samples_Mg_thermometry_annual_common <- All_samples_Mg_thermometry_annual %>%
  filter(Time >= 2000 & Time <= 2021 & Mg_Ca_proxy_annual_TJW <= 10 & Mg_Ca_proxy_annual_TJW >= -5)

Mg_thermometry_plot_annual_interpolation <- All_samples_Mg_thermometry_annual %>% 
  ggplot() +
    geom_ribbon(aes(x = Time, ymin = Mg_Ca_proxy_annual_TJW_LL, ymax = Mg_Ca_proxy_annual_TJW_UL, fill = as.factor(Specimen), linetype = as.factor(Internode)), alpha = 0.4) +
    geom_path(aes(x = Time, y = Mg_Ca_proxy_annual_TJW, linetype = as.factor(Internode), col = as.factor(Specimen)), lwd = 0.8) + # My calculated relationship
      geom_point(aes(x = 2018.6068, y =0.86), col = "darkgrey") +
      geom_point(aes(x = 2017.5466, y =0.68), col = "darkgrey") +
      geom_point(aes(x = 2016.5642, y =1.05), col = "darkgrey") +
      geom_point(aes(x = 2021.5849, y = 1.1), col = "darkgrey") +
      labs(y = expression("T"["[rec]"]*" (°C)"), x = "Timepoint (years)") +
      geom_hline(yintercept = 1.1, linetype = 4, col = "darkgrey") +
      geom_hline(yintercept = 0.68, linetype = 4, col = "darkgrey") +
      scale_x_continuous(limits = c(1960,2021), breaks = seq(1960,2020,5), sec.axis = sec_axis(~ -(. - 2021)*51, name = "Distance from coral wall (µm)")) +
      coord_cartesian(ylim = c(-5,10), xlim = c(1960,2021)) +
      scale_fill_discrete(name = "Colony ID", breaks = c("S_23_1", "S_23_10", "S_23_16", "S_23_6"), labels = c("23-1", "23-10", "23-16", "23-6")) +
      scale_colour_manual(name = "Colony ID", breaks = c("S_23_1", "S_23_10", "S_23_16", "S_23_6"), labels = c("23-1", "23-10", "23-16", "23-6"), values = c("#003300", "#000099", "#990000", "#330066")) +
  scale_linetype_manual(name = "Internode", values = c(1,2,3)) +
      facet_grid(rows = vars(Specimen), labeller = labeller(Specimen = sample_labs)) +
      theme_classic()

for(i in levels(All_samples_Mg_thermometry_annual_common$Specimen)){
  for (j in 1:3) {
    lmodel <- lmodel2(Mg_Ca_proxy_annual_TJW ~ Time, data = All_samples_Mg_thermometry_annual_common[which(All_samples_Mg_thermometry_annual_common$Specimen == i & All_samples_Mg_thermometry_annual_common$Internode == j),], "interval", "interval", 999)
    OLS_intercept <- lmodel$regression.results[1,2]
    OLS_slope <- lmodel$regression.results[1,3]
    OLS_p <- lmodel$regression.results[1,5]
    RMA_intercept <- lmodel$regression.results[4,2]
    RMA_slope <- lmodel$regression.results[4,3]
    RMA_p <- lmodel$regression.results[4,5]
    
    lmodel_n <- lmodel$n
    lmodel_r <- lmodel$r
    lmodel_rsq <- lmodel$rsquare
    OLS_intercept_2SD <- OLS_intercept - lmodel$confidence.intervals[1,2]
    OLS_slope_2SD <- OLS_slope - lmodel$confidence.intervals[1,4]
    RMA_intercept_2SD <- RMA_intercept - lmodel$confidence.intervals[4,2]
    RMA_slope_2SD <- RMA_slope - lmodel$confidence.intervals[4,4]
    
    Mg_thermometry_trends <- Mg_thermometry_trends %>%
      add_row(Relationship = paste0("Temperature ~ Time"),
              Specimen = i,
              Internode = j,
              Timerange = "2000-2021",
              Interpolation = "annual",
                          n = lmodel_n,
                          r = lmodel_r,
                          rsq = lmodel_rsq,
                          Regression_type = "OLS",
                          p = OLS_p,
                          Ttrend_Gradient = OLS_slope,
                          Ttrend_Gradient_2SD = OLS_slope_2SD,
                          Ttrend_Intercept = OLS_intercept,
                          Ttrend_Intercept_2SD = OLS_intercept_2SD)
    
         Mg_thermometry_trends <- Mg_thermometry_trends %>%
      add_row(Relationship = paste0("Temperature ~ Time"),
              Specimen = i,
              Internode = j,
              Timerange = "2000-2021",
              Interpolation = "annual",
                          n = lmodel_n,
                          r = lmodel_r,
                          rsq = lmodel_rsq,
                          Regression_type = "RMA",
                          p = RMA_p,
                          Ttrend_Gradient = RMA_slope,
                          Ttrend_Gradient_2SD = RMA_slope_2SD,
                          Ttrend_Intercept = RMA_intercept,
                          Ttrend_Intercept_2SD = RMA_intercept_2SD)
  }
}

Mg_thermometry_plot_annual_interpolation_averages <-  All_samples_Mg_thermometry_annual_common %>%
  group_by(Specimen, Internode) %>%
  summarise(Samples = n(),
            Interpolation = "annual",
            Timerange = "2000-2021",
    # Pub_mean = mean(Mg_Ca_proxy, na.rm = T),
    #         Pub_sd = sd(Mg_Ca_proxy, na.rm = T),
    #         Pub_se = sd(Mg_Ca_proxy, na.rm = T)/sqrt(n()),
        Trec_mean = mean(Mg_Ca_proxy_annual_TJW, na.rm = T),
            Trec_sd = sd(Mg_Ca_proxy_annual_TJW, na.rm = T),
            Trec_se = sd(Mg_Ca_proxy_annual_TJW, na.rm = T)/sqrt(n())) %>%
  left_join(Mg_thermometry_trends, by = c("Specimen", "Internode", "Interpolation", "Timerange")) %>%
  # pivot_longer(cols = c(6:9), names_to = "Calculation", values_to = "value") %>%
  # separate(col = "Calculation", "_", into = c("Calibration", "Calculation")) %>%
  # pivot_wider(names_from = "Calculation", values_from = "value") %>%
  filter(Regression_type == "OLS") %>%
      ggplot() +
          geom_hline(yintercept = 1.1, linetype = 4, col = "darkgrey") +
      geom_hline(yintercept = 0.68, linetype = 4, col = "darkgrey") +
  geom_vline(xintercept = SST_plot_annual_interpolated_common_trend, linetype = 4, col = "#FF9933") +
  geom_vline(xintercept = 0.01684166, linetype = 4, col = "#000033") +
  annotate("text", x = 0.02684166, y = 7, label = "webODV", angle = -90, col = "#000033") +
  annotate("text", x = SST_plot_annual_interpolated_common_trend-0.01, y = 7, label = "OISST", angle = 90, col = "#FF9933") +
  geom_errorbar(aes(x = Ttrend_Gradient, ymin = Trec_mean-Trec_sd, ymax = Trec_mean+Trec_sd, linetype = as.factor(Internode)), 
                width = 0.025, lwd = 1) +
    geom_errorbarh(aes(xmin = Ttrend_Gradient-(Ttrend_Gradient_2SD/2), xmax = Ttrend_Gradient+(Ttrend_Gradient_2SD/2), y = Trec_mean, linetype = as.factor(Internode)),
                 height = 0.5, lwd = 1) +
      geom_point(aes(x = Ttrend_Gradient, y = Trec_mean, fill = Specimen), 
                 pch = 21, size = 4, stroke = 2) +
  # scale_fill_manual(values = c("white", "black")) +
  scale_linetype_manual(values = c(1,2,3), name = "Internode") +
  scale_fill_manual(name = "Colony ID", breaks = c("S_23_1", "S_23_10", "S_23_16", "S_23_6"), labels = c("23-1", "23-10", "23-16", "23-6"), values = c("#99CC66", "#33CCCC", "#FF6666", "#9933FF")) +
      labs(y = expression("T"["[rec]"]*" (°C)"), x = expression("T"["[rec]"]*" trend (°C.yr"^"-1"*")")) +
       scale_y_continuous(limits = c(-1,8)) +
      scale_x_continuous(limits = c(-0.65,0.1)) +

Mg_thermometry_plot_uninterpolated <- All_samples_thermometry_data_V2 %>%
      group_by(distance.um, Specimen, Internode) %>% 
      summarise(Timepoint = 2021-(distance.um/51),
            Mg_Ca_proxy = ((0.34*Mg_Ca/1000)-23.9),
            Mg_Ca_proxy_TJW = ((0.313*Mg_Ca/1000)-21.4)) %>%
      ggplot() +
      # geom_path(aes(x = Timepoint, y = Mg_Ca_proxy, col = Specimen), linetype = 3)+ # Thresher et al., 2016 - Geochim. et Cosmich. Acta
      geom_path(aes(x = Timepoint, y = Mg_Ca_proxy_TJW, col = Specimen, linetype = as.factor(Internode))) + # My calculated relationship
      geom_point(aes(x = 2018.6068, y =0.86), col = "orange") +
      geom_point(aes(x = 2017.5466, y =0.68), col = "orange") +
      geom_point(aes(x = 2016.5642, y =1.05), col = "orange") +
      geom_point(aes(x = 2021.5849, y = 1.1), col = "orange") +
      labs(y = expression("T"["[rec]"]*" (°C)"), x = "Timepoint (years)") +
      geom_hline(yintercept = 1.1, linetype = 2) +
      geom_hline(yintercept = 0.68, linetype = 2) +
      geom_label(aes(y = -2.5, x = 1990, label = "No interpolation")) +
      scale_x_continuous(limits = c(1960,2022), breaks = seq(1960,2020,5), sec.axis = sec_axis(~ -(. - 2021)*51, name = "Distance from coral wall (µm)")) +
      scale_y_continuous(limits = c(-5,10)) +
      facet_grid(rows = vars(Specimen)) +
      theme_classic()

Mg_thermometry_plot_uninterpolated_averages <- All_samples_thermometry_data_V2 %>%
      group_by(distance.um, Specimen) %>% 
      summarise(Timepoint = 2021-(distance.um/51),
            Mg_Ca_proxy = ((0.34*Mg_Ca/1000)-23.9),
            Mg_Ca_proxy_TJW = ((0.313*Mg_Ca/1000)-21.4)) %>%
filter(Timepoint >= 2000 & Timepoint <= 2021 & Mg_Ca_proxy <= 10 & Mg_Ca_proxy >= -5 & Mg_Ca_proxy_TJW <= 10 & Mg_Ca_proxy_TJW >= -5) %>%
  group_by(Specimen) %>%
  summarise(Samples = n(),
    Pub_mean = mean(Mg_Ca_proxy, na.rm = T),
            Pub_sd = sd(Mg_Ca_proxy, na.rm = T),
            Pub_se = sd(Mg_Ca_proxy, na.rm = T)/sqrt(n()),
        TJW_mean = mean(Mg_Ca_proxy_TJW, na.rm = T),
            TJW_sd = sd(Mg_Ca_proxy_TJW, na.rm = T),
            TJW_se = sd(Mg_Ca_proxy_TJW, na.rm = T)/sqrt(n())) %>%
  mutate(Pub_alpha = c(-0.06,-0.22,-0.15,-0.05),
         TJW_alpha = c(-0.06,-0.21,-0.15,-0.04)) %>%
  pivot_longer(cols = c(3:10), names_to = "Calculation", values_to = "value") %>%
  separate(col = "Calculation", "_", into = c("Calibration", "Calculation")) %>%
  pivot_wider(names_from = "Calculation", values_from = "value") %>%
      ggplot() +
          geom_hline(yintercept = 1.1, linetype = 2) +
      geom_hline(yintercept = 0.68, linetype = 2) +
  geom_vline(xintercept = 0, linetype = 2) +
    geom_errorbar(aes(x = alpha, ymin = mean-sd, ymax = mean+sd, linetype = Calibration), 
                width = 0.1) +
      geom_point(aes(x = alpha, y = mean, col = Specimen, fill = Calibration), 
                 pch = 21, size = 4, stroke = 2) +
  scale_fill_manual(values = c("white", "black")) +
  scale_linetype_manual(values = c(3,1)) +
      labs(y = expression("T"["[rec]"]*" (°C)"), x = expression("T"["[rec]"]*" trend (°C.yr"^"-1"*")")) +
       scale_y_continuous(limits = c(-5,10)) +
      scale_x_continuous(limits = c(-0.40,0.6)) +
      theme_classic()

Mg_thermometry_plot_seasonal_interpolation <- All_samples_thermometry_data_V2 %>%
      group_by(distance.um, Specimen) %>% 
      summarise(Timepoint = 2021-(distance.um/51),
            Mg_Ca_proxy = ((0.34*Mg_Ca/1000)-23.9),
            Mg_Ca_proxy_TJW = ((0.313*Mg_Ca/1000)-21.4)) %>%
  drop_na() %>%
  ungroup(distance.um) %>%
  group_by(Specimen) %>%
  summarise(
            Time = spline(Timepoint, Mg_Ca_proxy_TJW, xout = seq(min(Timepoint),2021, by = 0.25))$x,
            Mg_Ca_proxy_season_TJW = spline(Timepoint, Mg_Ca_proxy_TJW, xout = seq(min(Timepoint),2021, by = 0.25))$y,
            Mg_Ca_proxy_season = spline(Timepoint, Mg_Ca_proxy, xout = seq(min(Timepoint),2021, by = 0.25))$y) %>% 
  ggplot() +
  geom_path(aes(Time, Mg_Ca_proxy_season, group = Specimen, col = Specimen), linetype = 3) +
      geom_path(aes(Time, Mg_Ca_proxy_season_TJW, group = Specimen, col = Specimen)) +
      geom_point(aes(x = 2018.6068, y =0.86), col = "orange") +
      geom_point(aes(x = 2017.5466, y =0.68), col = "orange") +
      geom_point(aes(x = 2016.5642, y =1.05), col = "orange") +
      geom_point(aes(x = 2021.5849, y = 1.1), col = "orange") +
      labs(y = expression("T"["[rec]"]*" (°C)"), x = "Timepoint (years)") +
      geom_hline(yintercept = 1.1, linetype = 2) +
      geom_hline(yintercept = 0.68, linetype = 2) +
      geom_label(aes(y = -2.5, x = 1990, label = "Seasonal interpolation (spline)")) +
      scale_x_continuous(limits = c(1960,2022), breaks = seq(1960,2020,5), sec.axis = sec_axis(~ -(. - 2021)*51, name = "Distance from coral wall (µm)")) +
      scale_y_continuous(limits = c(-5,10)) +
      theme_classic()

Mg_thermometry_plot_seasonal_interpolation_averages <- All_samples_thermometry_data_V2 %>%
      group_by(distance.um, Specimen) %>% 
      summarise(Timepoint = 2021-(distance.um/51),
            Mg_Ca_proxy = ((0.34*Mg_Ca/1000)-23.9),
            Mg_Ca_proxy_TJW = ((0.313*Mg_Ca/1000)-21.4)) %>%
  drop_na() %>%
  ungroup(distance.um) %>%
  group_by(Specimen) %>%
  summarise(
            Time = spline(Timepoint, Mg_Ca_proxy_TJW, xout = seq(min(Timepoint),2021, by = 0.25))$x,
            Mg_Ca_proxy_season_TJW = spline(Timepoint, Mg_Ca_proxy_TJW, xout = seq(min(Timepoint),2021, by = 0.25))$y,
            Mg_Ca_proxy_season = spline(Timepoint, Mg_Ca_proxy, xout = seq(min(Timepoint),2021, by = 0.25))$y) %>% 
filter(Time >= 2000 & Time <= 2021 & Mg_Ca_proxy_season <= 10 & Mg_Ca_proxy_season >= -5 & Mg_Ca_proxy_season_TJW <= 10 & Mg_Ca_proxy_season_TJW >= -5) %>%
  group_by(Specimen) %>%
  summarise(Samples = n(),
    Pub_mean = mean(Mg_Ca_proxy_season, na.rm = T),
            Pub_sd = sd(Mg_Ca_proxy_season, na.rm = T),
            Pub_se = sd(Mg_Ca_proxy_season, na.rm = T)/sqrt(n()),
        TJW_mean = mean(Mg_Ca_proxy_season_TJW, na.rm = T),
            TJW_sd = sd(Mg_Ca_proxy_season_TJW, na.rm = T),
            TJW_se = sd(Mg_Ca_proxy_season_TJW, na.rm = T)/sqrt(n())) %>%
  mutate(Pub_alpha = c(-0.07,-0.22,-0.15,-0.04),
         TJW_alpha = c(-0.06,-0.2,-0.16,-0.04)) %>%
  pivot_longer(cols = c(3:10), names_to = "Calculation", values_to = "value") %>%
  separate(col = "Calculation", "_", into = c("Calibration", "Calculation")) %>%
  pivot_wider(names_from = "Calculation", values_from = "value") %>%
      ggplot() +
          geom_hline(yintercept = 1.1, linetype = 2) +
      geom_hline(yintercept = 0.68, linetype = 2) +
  geom_vline(xintercept = 0, linetype = 2) +
    geom_errorbar(aes(x = alpha, ymin = mean-sd, ymax = mean+sd, linetype = Calibration), 
                width = 0.1) +
      geom_point(aes(x = alpha, y = mean, col = Specimen, fill = Calibration), 
                 pch = 21, size = 4, stroke = 2) +
  scale_fill_manual(values = c("white", "black")) +
  scale_linetype_manual(values = c(3,1)) +
      labs(y = expression("T"["[rec]"]*" (°C)"), x = expression("T"["[rec]"]*" trend (°C.yr"^"-1"*")")) +
       scale_y_continuous(limits = c(-5,10)) +
      scale_x_continuous(limits = c(-0.40,0.6)) +
      theme_classic()

Mg_thermometry_plot_annual_interpolation <- All_samples_thermometry_data_V2 %>%
      group_by(distance.um, Specimen) %>% 
      summarise(Timepoint = 2021-(distance.um/51),
            Mg_Ca_proxy = ((0.34*Mg_Ca/1000)-23.9),
            Mg_Ca_proxy_TJW = ((0.313*Mg_Ca/1000)-21.4)) %>%
  drop_na() %>%
  ungroup(distance.um) %>%
  group_by(Specimen) %>%
  summarise(
            Time = spline(Timepoint, Mg_Ca_proxy_TJW, xout = seq(min(Timepoint),2021, by = 1))$x,
            Mg_Ca_proxy_season_TJW = spline(Timepoint, Mg_Ca_proxy_TJW, xout = seq(min(Timepoint),2021, by = 1))$y,
            Mg_Ca_proxy_season = spline(Timepoint, Mg_Ca_proxy, xout = seq(min(Timepoint),2021, by = 1))$y) %>% 
  ggplot() +
  geom_path(aes(Time, Mg_Ca_proxy_season, group = Specimen, col = Specimen), linetype = 3) +
      geom_path(aes(Time, Mg_Ca_proxy_season_TJW, group = Specimen, col = Specimen)) +
      geom_point(aes(x = 2018.6068, y =0.86), col = "orange") +
      geom_point(aes(x = 2017.5466, y =0.68), col = "orange") +
      geom_point(aes(x = 2016.5642, y =1.05), col = "orange") +
      geom_point(aes(x = 2021.5849, y = 1.1), col = "orange") +
      labs(y = expression("T"["[rec]"]*" (°C)"), x = "Timepoint (years)") +
      geom_hline(yintercept = 1.1, linetype = 2) +
      geom_hline(yintercept = 0.68, linetype = 2) +
      geom_label(aes(y = -2.5, x = 1990, label = "Annual interpolation (spline)")) +
      scale_x_continuous(limits = c(1960,2022), breaks = seq(1960,2020,5), sec.axis = sec_axis(~ -(. - 2021)*51, name = "Distance from coral wall (µm)")) +
      scale_y_continuous(limits = c(-5,10)) +
      theme_classic()

Mg_thermometry_plot_annual_interpolation_averages <- All_samples_thermometry_data_V2 %>%
      group_by(distance.um, Specimen) %>% 
      summarise(Timepoint = 2021-(distance.um/51),
            Mg_Ca_proxy = ((0.34*Mg_Ca/1000)-23.9),
            Mg_Ca_proxy_TJW = ((0.313*Mg_Ca/1000)-21.4)) %>%
  drop_na() %>%
  ungroup(distance.um) %>%
  group_by(Specimen) %>%
  summarise(
            Time = spline(Timepoint, Mg_Ca_proxy_TJW, xout = seq(min(Timepoint),2021, by = 1))$x,
            Mg_Ca_proxy_season_TJW = spline(Timepoint, Mg_Ca_proxy_TJW, xout = seq(min(Timepoint),2021, by = 1))$y,
            Mg_Ca_proxy_season = spline(Timepoint, Mg_Ca_proxy, xout = seq(min(Timepoint),2021, by = 1))$y) %>% 
  filter(Time >= 2000 & Time <= 2021 & Mg_Ca_proxy_season <= 10 & Mg_Ca_proxy_season >= -5 & Mg_Ca_proxy_season_TJW <= 10 & Mg_Ca_proxy_season_TJW >= -5) %>%
  group_by(Specimen) %>%
  summarise(Samples = n(),
    Pub_mean = mean(Mg_Ca_proxy_season, na.rm = T),
            Pub_sd = sd(Mg_Ca_proxy_season, na.rm = T),
            Pub_se = sd(Mg_Ca_proxy_season, na.rm = T)/sqrt(n()),
        TJW_mean = mean(Mg_Ca_proxy_season_TJW, na.rm = T),
            TJW_sd = sd(Mg_Ca_proxy_season_TJW, na.rm = T),
            TJW_se = sd(Mg_Ca_proxy_season_TJW, na.rm = T)/sqrt(n())) %>%
  mutate(Pub_alpha = c(-0.09,-0.27,-0.17,-0.06),
         TJW_alpha = c(-0.08,-0.25,-0.16,-0.05)) %>%
  pivot_longer(cols = c(3:10), names_to = "Calculation", values_to = "value") %>%
  separate(col = "Calculation", "_", into = c("Calibration", "Calculation")) %>%
  pivot_wider(names_from = "Calculation", values_from = "value") %>%
      ggplot() +
          geom_hline(yintercept = 1.1, linetype = 2) +
      geom_hline(yintercept = 0.68, linetype = 2) +
  geom_vline(xintercept = 0, linetype = 2) +
    geom_errorbar(aes(x = alpha, ymin = mean-sd, ymax = mean+sd, linetype = Calibration), 
                width = 0.1) +
      geom_point(aes(x = alpha, y = mean, col = Specimen, fill = Calibration), 
                 pch = 21, size = 4, stroke = 2) +
  scale_fill_manual(values = c("white", "black")) +
  scale_linetype_manual(values = c(3,1)) +
      labs(y = expression("T"["[rec]"]*" (°C)"), x = expression("T"["[rec]"]*" trend (°C.yr"^"-1"*")")) +
       scale_y_continuous(limits = c(-5,10)) +
      scale_x_continuous(limits = c(-0.40,0.6)) +

      theme_classic()


Mg_thermometry_plots <- Mg_thermometry_plot_uninterpolated + theme(axis.title.x.bottom = element_blank(), axis.title.y = element_blank()) + 
  Mg_thermometry_plot_uninterpolated_averages + theme(axis.title.x.bottom = element_blank(), axis.title.y = element_blank()) +
  Mg_thermometry_plot_seasonal_interpolation  + theme(axis.title.x = element_blank()) +
  Mg_thermometry_plot_seasonal_interpolation_averages  + theme(axis.title.x.bottom = element_blank(), axis.title.y = element_blank()) +
  Mg_thermometry_plot_annual_interpolation + theme(axis.title.y = element_blank(), axis.title.x.top = element_blank()) +
  Mg_thermometry_plot_annual_interpolation_averages + theme(axis.title.y = element_blank()) +

  plot_layout(design = layout, guides = "collect")

layout_2 <- "
AABBCC
AABBCC
AABBCC
AABBCC
DDEEFF
"

Mg_thermometry_plots_V2 <- Mg_thermometry_plot_uninterpolated + theme(strip.text = element_blank(), axis.line.x.bottom = element_blank(), axis.ticks.x.bottom = element_blank(), axis.text.x.bottom = element_blank(), axis.title.x.bottom = element_blank()) +
  Mg_thermometry_plot_seasonal_interpolation  + theme(axis.title.y = element_blank(), axis.text.y = element_blank(), strip.text = element_blank(), axis.line.x.bottom = element_blank(), axis.ticks.x.bottom = element_blank(), axis.text.x.bottom = element_blank(), axis.title.x.bottom = element_blank()) +
  Mg_thermometry_plot_annual_interpolation + theme(axis.title.y = element_blank(), axis.text.y = element_blank(), strip.text = element_blank(), axis.line.x.bottom = element_blank(), axis.ticks.x.bottom = element_blank(), axis.text.x.bottom = element_blank(), axis.title.x.bottom = element_blank()) +
  SST_plot_uninterpolated_plot + theme(axis.text.x.top = element_blank(), axis.title.x.top = element_blank(), axis.line.x.top = element_blank(), axis.ticks.x.top = element_blank()) +
  SST_plot_season_interpolated_plot + theme(axis.text.x.top = element_blank(), axis.title.x.top = element_blank(), axis.line.x.top = element_blank(), axis.ticks.x.top = element_blank(), axis.title.y = element_blank(), axis.text.y = element_blank()) +
  SST_plot_annual_interpolated_plot + theme(axis.text.x.top = element_blank(), axis.title.x.top = element_blank(), axis.line.x.top = element_blank(), axis.ticks.x.top = element_blank(), axis.title.y = element_blank(), axis.text.y = element_blank()) +
  plot_layout(design = layout_2, guides = "collect")

Mg_thermometry_plots_V3 <- Mg_thermometry_plot_uninterpolated + theme(strip.text = element_blank()) +
  Mg_thermometry_plot_seasonal_interpolation  + theme(axis.title.y = element_blank(), axis.text.y = element_blank(), strip.text = element_blank()) +
  Mg_thermometry_plot_annual_interpolation + theme(axis.title.y = element_blank(), axis.text.y = element_blank(), strip.text = element_blank()) +
  Mg_thermometry_plot_uninterpolated_averages  +
  Mg_thermometry_plot_seasonal_interpolation_averages + theme(axis.title.y = element_blank(), axis.text.y = element_blank()) +
  Mg_thermometry_plot_annual_interpolation_averages + theme(axis.title.y = element_blank(), axis.text.y = element_blank()) +
  plot_layout(design = layout_2, guides = "collect")


### Remove coral edge and central axis - common timeframe is now 2003 to 2016 ####
#### uninterpolated ####
All_samples_Mg_thermometry_constrained <- All_samples_thermometry_data_V2 %>%
  distinct(distance.um, Specimen, Internode, .keep_all = T) %>%
  group_by(distance.um, Specimen, Internode) %>% 
  summarise(Timepoint = 2021-(distance.um/51),
            # Mg_Ca_proxy = ((0.34*Mg_Ca/1000)-23.9),
            Mg_Ca_proxy_TJW = ((0.32*Mg_Ca/1000)-21.88),
            Mg_Ca_proxy_TJW_LL = ((0.29*Mg_Ca/1000)-24.22), # 95% CI
            Mg_Ca_proxy_TJW_UL = ((0.34*Mg_Ca/1000)-19.55)) %>%
  ungroup() %>%
  filter(Specimen == "S_23_6" & Internode == 1 & Timepoint >= 1967 | Specimen == "S_23_1" & Internode == 1 & Timepoint >= 1998 |
           Specimen == "S_23_16" & Internode == 1 & Timepoint >= 2001 | Specimen == "S_23_10" & Internode == 1 & Timepoint >= 1995 |
            Specimen == "S_23_6" & Internode == 2 & Timepoint >= 1968 |  Specimen == "S_23_1" & Internode == 2 & Timepoint >= 1998 |
           Specimen == "S_23_16" & Internode == 2 & Timepoint >= 2004 | Specimen == "S_23_10" & Internode == 2 & Timepoint >= 1995 |
           Specimen == "S_23_6" & Internode == 3 & Timepoint >= 1978 | Specimen == "S_23_1" & Internode == 3 & Timepoint >= 2000 |
           Specimen == "S_23_16" & Internode == 3 & Timepoint >= 2004 | Specimen == "S_23_10" & Internode == 3 & Timepoint >= 1997) %>%
  na.omit()


# All_samples_Mg_thermometry_constrained %>%
# group_by(Specimen, Internode) %>%
# summarise(distance_max = max(distance.um),
#             distance_min = min(distance.um)) %>%
#   mutate(distance_total = distance_max - distance_min)
# 
# All_samples_thermometry_data_V2 %>%
# group_by(Specimen, Internode) %>%
# summarise(distance_max = max(distance.um),
#             distance_min = min(distance.um)) %>%
#   mutate(distance_total = distance_max - distance_min)

All_samples_Mg_thermometry_common_constrained <- All_samples_Mg_thermometry_constrained %>%
  filter(Timepoint >= 2003 & Timepoint <= 2016 & Mg_Ca_proxy_TJW <= 10 & Mg_Ca_proxy_TJW >= -5)

Mg_thermometry_plot_uninterpolated_constrained <- All_samples_Mg_thermometry_constrained %>%
  ggplot() +
  # geom_path(aes(x = Timepoint, y = Mg_Ca_proxy, col = Specimen), linetype = 3)+ # Thresher et al., 2016 - Geochim. et Cosmich. Acta
  geom_ribbon(aes(x = Timepoint, ymin = Mg_Ca_proxy_TJW_LL, ymax = Mg_Ca_proxy_TJW_UL, fill = as.factor(Specimen), linetype = as.factor(Internode)), alpha = 0.4) +
  geom_path(aes(x = Timepoint, y = Mg_Ca_proxy_TJW, linetype = as.factor(Internode), col = as.factor(Specimen)), lwd = 0.8) + # My calculated relationship
  geom_point(aes(x = 2018.6068, y =0.86), col = "darkgrey") +
  geom_point(aes(x = 2017.5466, y =0.68), col = "darkgrey") +
  geom_point(aes(x = 2016.5642, y =1.05), col = "darkgrey") +
  geom_point(aes(x = 2021.5849, y = 1.1), col = "darkgrey") +
  geom_point(data = BBay_data, aes(x = Timepoint, y = Temperature), col = "darkgrey") +
  labs(y = expression("T"["[rec]"]*" (°C)"), x = "Timepoint (years)") +
  geom_hline(yintercept = 1.36, linetype = 4, col = "darkgrey") +
  geom_hline(yintercept = 0.39, linetype = 4, col = "darkgrey") +
  scale_x_continuous(limits = c(1960,2016), breaks = seq(1960,2015,5), sec.axis = sec_axis(~ -(. - 2021)*51, name = "Distance from coral wall (µm)")) +
  coord_cartesian(ylim = c(-5,10), xlim = c(1960,2016)) +
  scale_fill_discrete(name = "Colony ID", breaks = c("S_23_1", "S_23_10", "S_23_16", "S_23_6"), labels = c("23-1", "23-10", "23-16", "23-6")) +
  scale_colour_manual(name = "Colony ID", breaks = c("S_23_1", "S_23_10", "S_23_16", "S_23_6"), labels = c("23-1", "23-10", "23-16", "23-6"), values = c("#003300", "#000099", "#990000", "#330066")) +
  scale_linetype_manual(name = "Internode", values = c(1,2,3)) +
  facet_grid(rows = vars(Specimen), labeller = labeller(Specimen = sample_labs)) +
  theme_classic()


library(lmodel2)
for(i in levels(All_samples_Mg_thermometry_common_constrained$Specimen)){
  for (j in 1:3) {
    lmodel <- lmodel2(Mg_Ca_proxy_TJW ~ Timepoint, data = All_samples_Mg_thermometry_common_constrained[which(All_samples_Mg_thermometry_common_constrained$Specimen == i & All_samples_Mg_thermometry_common_constrained$Internode == j),], "interval", "interval", 999)
    
    OLS_intercept <- lmodel$regression.results[1,2]
    OLS_slope <- lmodel$regression.results[1,3]
    OLS_p <- lmodel$regression.results[1,5]
    RMA_intercept <- lmodel$regression.results[4,2]
    RMA_slope <- lmodel$regression.results[4,3]
    RMA_p <- lmodel$regression.results[4,5]
    
    lmodel_n <- lmodel$n
    lmodel_r <- lmodel$r
    lmodel_rsq <- lmodel$rsquare
    OLS_intercept_2SD <- OLS_intercept - lmodel$confidence.intervals[1,2]
    OLS_slope_2SD <- OLS_slope - lmodel$confidence.intervals[1,4]
    RMA_intercept_2SD <- RMA_intercept - lmodel$confidence.intervals[4,2]
    RMA_slope_2SD <- RMA_slope - lmodel$confidence.intervals[4,4]
    
    Mg_thermometry_trends <- Mg_thermometry_trends %>%
      add_row(Relationship = paste0("Temperature ~ Time"),
              Specimen = i,
              Internode = j,
              Timerange = "2003-2016",
              Interpolation = "none",
                          n = lmodel_n,
                          r = lmodel_r,
                          rsq = lmodel_rsq,
                          Regression_type = "OLS",
                          p = OLS_p,
                          Ttrend_Gradient = OLS_slope,
                          Ttrend_Gradient_2SD = OLS_slope_2SD,
                          Ttrend_Intercept = OLS_intercept,
                          Ttrend_Intercept_2SD = OLS_intercept_2SD)
    
         Mg_thermometry_trends <- Mg_thermometry_trends %>%
      add_row(Relationship = paste0("Temperature ~ Time"),
              Specimen = i,
              Internode = j,
              Timerange = "2003-2016",
              Interpolation = "none",
                          n = lmodel_n,
                          r = lmodel_r,
                          rsq = lmodel_rsq,
                          Regression_type = "RMA",
                          p = RMA_p,
                          Ttrend_Gradient = RMA_slope,
                          Ttrend_Gradient_2SD = RMA_slope_2SD,
                          Ttrend_Intercept = RMA_intercept,
                          Ttrend_Intercept_2SD = RMA_intercept_2SD)
  }
}


Mg_thermometry_plot_uninterpolated_averages_constrained <- All_samples_Mg_thermometry_common_constrained %>%
  group_by(Specimen, Internode) %>%
  summarise(Samples = n(),
            Interpolation = "none",
            Timerange = "2003-2016",
            # Pub_mean = mean(Mg_Ca_proxy, na.rm = T),
            #         Pub_sd = sd(Mg_Ca_proxy, na.rm = T),
            #         Pub_se = sd(Mg_Ca_proxy, na.rm = T)/sqrt(n()),
            Trec_mean = mean(Mg_Ca_proxy_TJW, na.rm = T),
            Trec_sd = sd(Mg_Ca_proxy_TJW, na.rm = T),
            Trec_se = sd(Mg_Ca_proxy_TJW, na.rm = T)/sqrt(n())) %>%
  left_join(Mg_thermometry_trends, by = c("Specimen", "Internode", "Interpolation", "Timerange")) %>%
  # pivot_longer(cols = c(6:9), names_to = "Calculation", values_to = "value") %>%
  # separate(col = "Calculation", "_", into = c("Calibration", "Calculation")) %>%
  # pivot_wider(names_from = "Calculation", values_from = "value") %>%
  filter(Regression_type == "OLS") %>%
  ggplot() +
  geom_hline(yintercept = 1.36, linetype = 4, col = "darkgrey") +
  geom_hline(yintercept = 0.39, linetype = 4, col = "darkgrey") +
  geom_vline(xintercept = SST_plot_uninterpolated_constrained_common_trend, linetype = 4, col = "#FF9933") +
  annotate("text", x = SST_plot_uninterpolated_constrained_common_trend-0.01, y = 7, label = "OISST", angle = 90, col = "#FF9933") +
  geom_errorbar(aes(x = Ttrend_Gradient, ymin = Trec_mean-Trec_sd, ymax = Trec_mean+Trec_sd, linetype = as.factor(Internode)), 
                width = 0.025, lwd = 1) +
    geom_errorbarh(aes(xmin = Ttrend_Gradient-(Ttrend_Gradient_2SD/2), xmax = Ttrend_Gradient+(Ttrend_Gradient_2SD/2), y = Trec_mean, linetype = as.factor(Internode)),
                 height = 0.5, lwd = 1) +
  geom_point(aes(x = Ttrend_Gradient, y = Trec_mean, fill = Specimen), 
             pch = 21, size = 4, stroke = 2) +
  geom_label(aes(x = -0.15, y = 7, label = "Timeperiod: 2003-2016")) +
  # scale_fill_manual(values = c("white", "black")) +
  scale_linetype_manual(values = c(1,2,3), name = "Internode") +
  scale_fill_manual(name = "Colony ID", breaks = c("S_23_1", "S_23_10", "S_23_16", "S_23_6"), labels = c("23-1", "23-10", "23-16", "23-6"), values = c("#99CC66", "#33CCCC", "#FF6666", "#9933FF")) +
  labs(y = expression("T"["[rec]"]*" (°C)"), x = expression("T"["[rec]"]*" trend (°C.yr"^"-1"*")")) +
  scale_y_continuous(limits = c(-1,8)) +
  scale_x_continuous(limits = c(-0.4,0.1)) +
  theme_classic()

#### seasonally interpolated ####
All_samples_Mg_thermometry_season_constrained <- All_samples_Mg_thermometry_constrained %>% 
  drop_na() %>%
  group_by(Specimen, Internode) %>%
  summarise(
    Time = spline(Timepoint, Mg_Ca_proxy_TJW, xout = seq(min(Timepoint),2021, by = 0.25))$x,
    Mg_Ca_proxy_season_TJW = spline(Timepoint, Mg_Ca_proxy_TJW, xout = seq(min(Timepoint),2021, by = 0.25))$y,
    Mg_Ca_proxy_season_TJW_LL = spline(Timepoint, Mg_Ca_proxy_TJW_LL, xout = seq(min(Timepoint),2021, by = 0.25))$y,
    Mg_Ca_proxy_season_TJW_UL = spline(Timepoint, Mg_Ca_proxy_TJW_UL, xout = seq(min(Timepoint),2021, by = 0.25))$y)

All_samples_Mg_thermometry_season_common_constrained <- All_samples_Mg_thermometry_season_constrained %>%
  filter(Time >= 2003 & Time <= 2016 & Mg_Ca_proxy_season_TJW <= 10 & Mg_Ca_proxy_season_TJW >= -5)

All_samples_Mg_thermometry_constrained_leveraged <- All_samples_Mg_thermometry_season_constrained %>%
  group_by(Specimen, Time) %>%
    filter(Time <= 2016) %>%
  mutate(Time = round(Time, digits = 1)) %>%
    summarise(Time = Time,
            Mg_Ca_proxy_season_TJW_mean = mean(Mg_Ca_proxy_season_TJW, na.rm = T),
            Mg_Ca_proxy_season_TJW_sd = sd(Mg_Ca_proxy_season_TJW, na.rm = T),
            n = n()) %>%
  unique() %>%
  mutate(Mg_Ca_proxy_season_TJW_se = Mg_Ca_proxy_season_TJW_sd/(n-1)^0.5,
         Mg_Ca_proxy_season_TJW_UL = Mg_Ca_proxy_season_TJW_mean+(Mg_Ca_proxy_season_TJW_sd*1.96),
         Mg_Ca_proxy_season_TJW_LL = Mg_Ca_proxy_season_TJW_mean-(Mg_Ca_proxy_season_TJW_sd*1.96)
         #error = qt(0.975,df=n-1)*Mg_Ca_proxy_season_TJW_sd/sqrt(n)
         ) %>% 
  filter(n > 1) %>%
  #mutate(Mg_Ca_proxy_season_TJW_UL = Mg_Ca_proxy_season_TJW_mean+error,
 #        Mg_Ca_proxy_season_TJW_LL = Mg_Ca_proxy_season_TJW_mean-error) %>%
  summarise(Mg_Ca_proxy_season_TJW_CI = (Mg_Ca_proxy_season_TJW_UL-Mg_Ca_proxy_season_TJW_LL)/2) %>%
  ungroup() %>%
  summarise(mean = mean(Mg_Ca_proxy_season_TJW_CI, na.rm = T),
            max = max(Mg_Ca_proxy_season_TJW_CI, na.rm = T),
            min = min(Mg_Ca_proxy_season_TJW_CI, na.rm = T))


Mg_thermometry_plot_seasonal_interpolation_constrained <-  All_samples_Mg_thermometry_season_constrained %>% 
  ggplot() +
  geom_ribbon(aes(x = Time, ymin = Mg_Ca_proxy_season_TJW_LL, ymax = Mg_Ca_proxy_season_TJW_UL, fill = as.factor(Specimen), linetype = as.factor(Internode)), alpha = 0.4) +
  geom_path(aes(x = Time, y = Mg_Ca_proxy_season_TJW, linetype = as.factor(Internode), col = as.factor(Specimen)), lwd = 0.8) + # My calculated relationship
  geom_point(aes(x = 2018.6068, y =0.86), col = "darkgrey") +
  geom_point(aes(x = 2017.5466, y =0.68), col = "darkgrey") +
  geom_point(aes(x = 2016.5642, y =1.05), col = "darkgrey") +
  geom_point(aes(x = 2021.5849, y = 1.1), col = "darkgrey") +
  geom_point(data = BBay_data, aes(x = Timepoint, y = Temperature), col = "darkgrey") +
  labs(y = expression("T"["[rec]"]*" (°C)"), x = "Timepoint (years)") +
  geom_hline(yintercept = 1.36, linetype = 4, col = "darkgrey") +
  geom_hline(yintercept = 0.39, linetype = 4, col = "darkgrey") +
  scale_x_continuous(limits = c(1960,2016), breaks = seq(1960,2015,5), sec.axis = sec_axis(~ -(. - 2021)*51, name = "Distance from coral wall (µm)")) +
  coord_cartesian(ylim = c(-5,10), xlim = c(1960,2016)) +
  scale_fill_discrete(name = "Colony ID", breaks = c("S_23_1", "S_23_10", "S_23_16", "S_23_6"), labels = c("23-1", "23-10", "23-16", "23-6")) +
  scale_colour_manual(name = "Colony ID", breaks = c("S_23_1", "S_23_10", "S_23_16", "S_23_6"), labels = c("23-1", "23-10", "23-16", "23-6"), values = c("#003300", "#000099", "#990000", "#330066")) +
  scale_linetype_manual(name = "Internode", values = c(1,2,3)) +
  facet_grid(rows = vars(Specimen), labeller = labeller(Specimen = sample_labs)) +
  theme_classic()


for(i in levels(All_samples_Mg_thermometry_season_common_constrained$Specimen)){
  for (j in 1:3) {
    lmodel <- lmodel2(Mg_Ca_proxy_season_TJW ~ Time, data = All_samples_Mg_thermometry_season_common_constrained[which(All_samples_Mg_thermometry_season_common_constrained$Specimen == i & All_samples_Mg_thermometry_season_common_constrained$Internode == j),], "interval", "interval", 999)
    
    OLS_intercept <- lmodel$regression.results[1,2]
    OLS_slope <- lmodel$regression.results[1,3]
    OLS_p <- lmodel$regression.results[1,5]
    RMA_intercept <- lmodel$regression.results[4,2]
    RMA_slope <- lmodel$regression.results[4,3]
    RMA_p <- lmodel$regression.results[4,5]
    
    lmodel_n <- lmodel$n
    lmodel_r <- lmodel$r
    lmodel_rsq <- lmodel$rsquare
    OLS_intercept_2SD <- OLS_intercept - lmodel$confidence.intervals[1,2]
    OLS_slope_2SD <- OLS_slope - lmodel$confidence.intervals[1,4]
    RMA_intercept_2SD <- RMA_intercept - lmodel$confidence.intervals[4,2]
    RMA_slope_2SD <- RMA_slope - lmodel$confidence.intervals[4,4]
    
    Mg_thermometry_trends <- Mg_thermometry_trends %>%
      add_row(Relationship = paste0("Temperature ~ Time"),
              Specimen = i,
              Internode = j,
              Timerange = "2003-2016",
              Interpolation = "seasonal",
                          n = lmodel_n,
                          r = lmodel_r,
                          rsq = lmodel_rsq,
                          Regression_type = "OLS",
                          p = OLS_p,
                          Ttrend_Gradient = OLS_slope,
                          Ttrend_Gradient_2SD = OLS_slope_2SD,
                          Ttrend_Intercept = OLS_intercept,
                          Ttrend_Intercept_2SD = OLS_intercept_2SD)
    
         Mg_thermometry_trends <- Mg_thermometry_trends %>%
      add_row(Relationship = paste0("Temperature ~ Time"),
              Specimen = i,
              Internode = j,
              Timerange = "2003-2016",
              Interpolation = "seasonal",
                          n = lmodel_n,
                          r = lmodel_r,
                          rsq = lmodel_rsq,
                          Regression_type = "RMA",
                          p = RMA_p,
                          Ttrend_Gradient = RMA_slope,
                          Ttrend_Gradient_2SD = RMA_slope_2SD,
                          Ttrend_Intercept = RMA_intercept,
                          Ttrend_Intercept_2SD = RMA_intercept_2SD)
  }
}

Mg_thermometry_plot_seasonal_interpolation_averages_constrained <- All_samples_Mg_thermometry_season_common_constrained %>%
  group_by(Specimen, Internode) %>%
  summarise(Samples = n(),
            Interpolation = "seasonal",
            Timerange = "2003-2016",
            # Pub_mean = mean(Mg_Ca_proxy, na.rm = T),
            #         Pub_sd = sd(Mg_Ca_proxy, na.rm = T),
            #         Pub_se = sd(Mg_Ca_proxy, na.rm = T)/sqrt(n()),
            Trec_mean = mean(Mg_Ca_proxy_season_TJW, na.rm = T),
            Trec_sd = sd(Mg_Ca_proxy_season_TJW, na.rm = T),
            Trec_se = sd(Mg_Ca_proxy_season_TJW, na.rm = T)/sqrt(n())) %>%
  left_join(Mg_thermometry_trends, by = c("Specimen", "Internode", "Interpolation", "Timerange")) %>%
  # pivot_longer(cols = c(6:9), names_to = "Calculation", values_to = "value") %>%
  # separate(col = "Calculation", "_", into = c("Calibration", "Calculation")) %>%
  # pivot_wider(names_from = "Calculation", values_from = "value") %>%
  filter(Regression_type == "OLS") %>%
  ggplot() +
  geom_hline(yintercept = 1.36, linetype = 4, col = "darkgrey") +
  geom_hline(yintercept = 0.39, linetype = 4, col = "darkgrey") +
  geom_vline(xintercept = SST_plot_season_interpolated_constrained_common_trend, linetype = 4, col = "#FF9933") +
  annotate("text", x = SST_plot_season_interpolated_constrained_common_trend-0.01, y = 7, label = "OISST", angle = 90, col = "#FF9933") +
  geom_errorbar(aes(x = Ttrend_Gradient, ymin = Trec_mean-Trec_sd, ymax = Trec_mean+Trec_sd, linetype = as.factor(Internode)), 
                width = 0.025, lwd = 1) +
    geom_errorbarh(aes(xmin = Ttrend_Gradient-(Ttrend_Gradient_2SD/2), xmax = Ttrend_Gradient+(Ttrend_Gradient_2SD/2), y = Trec_mean, linetype = as.factor(Internode)),
                 height = 0.5, lwd = 1) +
  geom_point(aes(x = Ttrend_Gradient, y = Trec_mean, fill = Specimen), 
             pch = 21, size = 4, stroke = 2) +
  geom_label(aes(x = -0.15, y = 7, label = "Timeperiod: 2003-2016")) +
  # scale_fill_manual(values = c("white", "black")) +
  scale_linetype_manual(values = c(1,2,3), name = "Internode") +
  scale_fill_manual(name = "Colony ID", breaks = c("S_23_1", "S_23_10", "S_23_16", "S_23_6"), labels = c("23-1", "23-10", "23-16", "23-6"), values = c("#99CC66", "#33CCCC", "#FF6666", "#9933FF")) +
  labs(y = expression("T"["[rec]"]*" (°C)"), x = expression("T"["[rec]"]*" trend (°C.yr"^"-1"*")")) +
  scale_y_continuous(limits = c(-1,8)) +
  scale_x_continuous(limits = c(-0.4,0.1)) +
  theme_classic()

#### annually interpolated ####
All_samples_Mg_thermometry_annual_constrained <- All_samples_Mg_thermometry_constrained %>% 
  drop_na() %>%
  group_by(Specimen, Internode) %>%
  summarise(
    Time = spline(Timepoint, Mg_Ca_proxy_TJW, xout = seq(min(Timepoint),2021, by = 1))$x,
    Mg_Ca_proxy_annual_TJW = spline(Timepoint, Mg_Ca_proxy_TJW, xout = seq(min(Timepoint),2021, by = 1))$y,
    Mg_Ca_proxy_annual_TJW_LL = spline(Timepoint, Mg_Ca_proxy_TJW_LL, xout = seq(min(Timepoint),2021, by = 1))$y,
    Mg_Ca_proxy_annual_TJW_UL = spline(Timepoint, Mg_Ca_proxy_TJW_UL, xout = seq(min(Timepoint),2021, by = 1))$y) 

All_samples_Mg_thermometry_annual_common_constrained <- All_samples_Mg_thermometry_annual_constrained %>%
  filter(Time >= 2000 & Time <= 2021 & Mg_Ca_proxy_annual_TJW <= 10 & Mg_Ca_proxy_annual_TJW >= -5)

All_samples_Mg_thermometry_constrained_leveraged <- All_samples_Mg_thermometry_annual_constrained %>%
  group_by(Specimen, Time) %>%
    filter(Time <= 2016) %>%
  mutate(Time = round(Time, digits = 0)) %>%
    summarise(Time = Time,
            Mg_Ca_proxy_annual_TJW_mean = mean(Mg_Ca_proxy_annual_TJW, na.rm = T),
            Mg_Ca_proxy_annual_TJW_sd = sd(Mg_Ca_proxy_annual_TJW, na.rm = T),
            n = n()) %>%
  unique() %>%
  mutate(Mg_Ca_proxy_annual_TJW_se = Mg_Ca_proxy_annual_TJW_sd/(n-1)^0.5,
         Mg_Ca_proxy_annual_TJW_UL = Mg_Ca_proxy_annual_TJW_mean+(Mg_Ca_proxy_annual_TJW_sd*1.96),
         Mg_Ca_proxy_annual_TJW_LL = Mg_Ca_proxy_annual_TJW_mean-(Mg_Ca_proxy_annual_TJW_sd*1.96)
         #error = qt(0.975,df=n-1)*Mg_Ca_proxy_annual_TJW_sd/sqrt(n)
         ) %>% 
  filter(n > 1) %>%
  #mutate(Mg_Ca_proxy_annual_TJW_UL = Mg_Ca_proxy_annual_TJW_mean+error,
 #        Mg_Ca_proxy_annual_TJW_LL = Mg_Ca_proxy_annual_TJW_mean-error) %>%
  summarise(Mg_Ca_proxy_annual_TJW_CI = (Mg_Ca_proxy_annual_TJW_UL-Mg_Ca_proxy_annual_TJW_LL)/2) %>%
  ungroup() %>%
  summarise(mean = mean(Mg_Ca_proxy_annual_TJW_CI, na.rm = T),
            max = max(Mg_Ca_proxy_annual_TJW_CI, na.rm = T),
            min = min(Mg_Ca_proxy_annual_TJW_CI, na.rm = T))

Mg_thermometry_plot_annual_interpolation_constrained <- All_samples_Mg_thermometry_annual_constrained %>% 
  ggplot() +
  geom_ribbon(aes(x = Time, ymin = Mg_Ca_proxy_annual_TJW_LL, ymax = Mg_Ca_proxy_annual_TJW_UL, fill = as.factor(Specimen), linetype = as.factor(Internode)), alpha = 0.4) +
  geom_path(aes(x = Time, y = Mg_Ca_proxy_annual_TJW, linetype = as.factor(Internode), col = as.factor(Specimen)), lwd = 0.8) + # My calculated relationship
  geom_point(aes(x = 2018.6068, y =0.86), col = "darkgrey") +
  geom_point(aes(x = 2017.5466, y =0.68), col = "darkgrey") +
  geom_point(aes(x = 2016.5642, y =1.05), col = "darkgrey") +
  geom_point(aes(x = 2021.5849, y = 1.1), col = "darkgrey") +
  geom_point(data = BBay_data, aes(x = Timepoint, y = Temperature), col = "darkgrey") +
  labs(y = expression("T"["[rec]"]*" (°C)"), x = "Timepoint (years)") +
  geom_hline(yintercept = 1.36, linetype = 4, col = "darkgrey") +
  geom_hline(yintercept = 0.39, linetype = 4, col = "darkgrey") +
  scale_x_continuous(limits = c(1960,2016), breaks = seq(1960,2015,5), sec.axis = sec_axis(~ -(. - 2021)*51, name = "Distance from coral wall (µm)")) +
  coord_cartesian(ylim = c(-5,10), xlim = c(1960,2016)) +
  scale_fill_discrete(name = "Colony ID", breaks = c("S_23_1", "S_23_10", "S_23_16", "S_23_6"), labels = c("23-1", "23-10", "23-16", "23-6")) +
  scale_colour_manual(name = "Colony ID", breaks = c("S_23_1", "S_23_10", "S_23_16", "S_23_6"), labels = c("23-1", "23-10", "23-16", "23-6"), values = c("#003300", "#000099", "#990000", "#330066")) +
  scale_linetype_manual(name = "Internode", values = c(1,2,3)) +
  facet_grid(rows = vars(Specimen), labeller = labeller(Specimen = sample_labs)) +
  theme_classic()

for(i in levels(All_samples_Mg_thermometry_annual_common_constrained$Specimen)){
  for (j in 1:3) {
    lmodel <- lmodel2(Mg_Ca_proxy_annual_TJW ~ Time, data = All_samples_Mg_thermometry_annual_common_constrained[which(All_samples_Mg_thermometry_annual_common_constrained$Specimen == i & All_samples_Mg_thermometry_annual_common_constrained$Internode == j),], "interval", "interval", 999)
    
    OLS_intercept <- lmodel$regression.results[1,2]
    OLS_slope <- lmodel$regression.results[1,3]
    OLS_p <- lmodel$regression.results[1,5]
    RMA_intercept <- lmodel$regression.results[4,2]
    RMA_slope <- lmodel$regression.results[4,3]
    RMA_p <- lmodel$regression.results[4,5]
    
    lmodel_n <- lmodel$n
    lmodel_r <- lmodel$r
    lmodel_rsq <- lmodel$rsquare
    OLS_intercept_2SD <- OLS_intercept - lmodel$confidence.intervals[1,2]
    OLS_slope_2SD <- OLS_slope - lmodel$confidence.intervals[1,4]
    RMA_intercept_2SD <- RMA_intercept - lmodel$confidence.intervals[4,2]
    RMA_slope_2SD <- RMA_slope - lmodel$confidence.intervals[4,4]
    
    Mg_thermometry_trends <- Mg_thermometry_trends %>%
      add_row(Relationship = paste0("Temperature ~ Time"),
              Specimen = i,
              Internode = j,
              Timerange = "2003-2016",
              Interpolation = "annual",
                          n = lmodel_n,
                          r = lmodel_r,
                          rsq = lmodel_rsq,
                          Regression_type = "OLS",
                          p = OLS_p,
                          Ttrend_Gradient = OLS_slope,
                          Ttrend_Gradient_2SD = OLS_slope_2SD,
                          Ttrend_Intercept = OLS_intercept,
                          Ttrend_Intercept_2SD = OLS_intercept_2SD)
    
         Mg_thermometry_trends <- Mg_thermometry_trends %>%
      add_row(Relationship = paste0("Temperature ~ Time"),
              Specimen = i,
              Internode = j,
              Timerange = "2003-2016",
              Interpolation = "annual",
                          n = lmodel_n,
                          r = lmodel_r,
                          rsq = lmodel_rsq,
                          Regression_type = "RMA",
                          p = RMA_p,
                          Ttrend_Gradient = RMA_slope,
                          Ttrend_Gradient_2SD = RMA_slope_2SD,
                          Ttrend_Intercept = RMA_intercept,
                          Ttrend_Intercept_2SD = RMA_intercept_2SD)
  }
}

Mg_thermometry_plot_annual_interpolation_averages_constrained <-  All_samples_Mg_thermometry_annual_common_constrained %>%
  group_by(Specimen, Internode) %>%
  summarise(Samples = n(),
            Interpolation = "annual",
            Timerange = "2003-2016",
            # Pub_mean = mean(Mg_Ca_proxy, na.rm = T),
            #         Pub_sd = sd(Mg_Ca_proxy, na.rm = T),
            #         Pub_se = sd(Mg_Ca_proxy, na.rm = T)/sqrt(n()),
            Trec_mean = mean(Mg_Ca_proxy_annual_TJW, na.rm = T),
            Trec_sd = sd(Mg_Ca_proxy_annual_TJW, na.rm = T),
            Trec_se = sd(Mg_Ca_proxy_annual_TJW, na.rm = T)/sqrt(n())) %>%
  left_join(Mg_thermometry_trends, by = c("Specimen", "Internode", "Interpolation", "Timerange")) %>%
  # pivot_longer(cols = c(6:9), names_to = "Calculation", values_to = "value") %>%
  # separate(col = "Calculation", "_", into = c("Calibration", "Calculation")) %>%
  # pivot_wider(names_from = "Calculation", values_from = "value") %>%
  filter(Regression_type == "OLS") %>%
  ggplot() +
  geom_hline(yintercept = 1.36, linetype = 4, col = "darkgrey") +
  geom_hline(yintercept = 0.39, linetype = 4, col = "darkgrey") +
  geom_vline(xintercept = SST_plot_annual_interpolated_constrained_common_trend, linetype = 4, col = "#FF9933") +
  annotate("text", x = SST_plot_annual_interpolated_constrained_common_trend-0.01, y = 7, label = "OISST", angle = 90, col = "#FF9933") +
  geom_errorbar(aes(x = Ttrend_Gradient, ymin = Trec_mean-Trec_sd, ymax = Trec_mean+Trec_sd, linetype = as.factor(Internode)), 
                width = 0.025, lwd = 1) +
    geom_errorbarh(aes(xmin = Ttrend_Gradient-(Ttrend_Gradient_2SD/2), xmax = Ttrend_Gradient+(Ttrend_Gradient_2SD/2), y = Trec_mean, linetype = as.factor(Internode)),
                 height = 0.5, lwd = 1) +
  geom_point(aes(x = Ttrend_Gradient, y = Trec_mean, fill = Specimen), 
             pch = 21, size = 4, stroke = 2) +
  geom_label(aes(x = -0.15, y = 7, label = "Timeperiod: 2003-2016")) +
  # scale_fill_manual(values = c("white", "black")) +
  scale_linetype_manual(values = c(1,2,3), name = "Internode") +
  scale_fill_manual(name = "Colony ID", breaks = c("S_23_1", "S_23_10", "S_23_16", "S_23_6"), labels = c("23-1", "23-10", "23-16", "23-6"), values = c("#99CC66", "#33CCCC", "#FF6666", "#9933FF")) +
  labs(y = expression("T"["[rec]"]*" (°C)"), x = expression("T"["[rec]"]*" trend (°C.yr"^"-1"*")")) +
  scale_y_continuous(limits = c(-1,8)) +
  scale_x_continuous(limits = c(-0.4,0.1)) +
  theme_classic()


Mg_thermometry_plots_constrained <- Mg_thermometry_plot_uninterpolated_constrained + theme(axis.title.x.bottom = element_blank(), axis.title.y = element_blank()) + 
  Mg_thermometry_plot_uninterpolated_averages_constrained + theme(axis.title.x.bottom = element_blank(), axis.title.y = element_blank()) +
  Mg_thermometry_plot_seasonal_interpolation_constrained  + theme(axis.title.x = element_blank()) +
  Mg_thermometry_plot_seasonal_interpolation_averages_constrained  + theme(axis.title.x.bottom = element_blank(), axis.title.y = element_blank()) +
  Mg_thermometry_plot_annual_interpolation_constrained + theme(axis.title.y = element_blank(), axis.title.x.top = element_blank()) +
  Mg_thermometry_plot_annual_interpolation_averages_constrained + theme(axis.title.y = element_blank()) +
  plot_layout(design = layout, guides = "collect")

layout_2 <- "
AABBCC
AABBCC
AABBCC
AABBCC
DDEEFF
"

Mg_thermometry_plots_constrained_V2 <- Mg_thermometry_plot_uninterpolated_constrained + theme(strip.text = element_blank(), axis.line.x.bottom = element_blank(), axis.ticks.x.bottom = element_blank(), axis.text.x.bottom = element_blank(), axis.title.x.bottom = element_blank()) +
  Mg_thermometry_plot_seasonal_interpolation_constrained  + theme(axis.title.y = element_blank(), axis.text.y = element_blank(), strip.text = element_blank(), axis.line.x.bottom = element_blank(), axis.ticks.x.bottom = element_blank(), axis.text.x.bottom = element_blank(), axis.title.x.bottom = element_blank()) +
  Mg_thermometry_plot_annual_interpolation_constrained + theme(axis.title.y = element_blank(), axis.text.y = element_blank(), strip.text = element_blank(), axis.line.x.bottom = element_blank(), axis.ticks.x.bottom = element_blank(), axis.text.x.bottom = element_blank(), axis.title.x.bottom = element_blank()) +
  SST_plot_uninterpolated_plot + theme(axis.text.x.top = element_blank(), axis.title.x.top = element_blank(), axis.line.x.top = element_blank(), axis.ticks.x.top = element_blank()) +
  SST_plot_season_interpolated_plot + theme(axis.text.x.top = element_blank(), axis.title.x.top = element_blank(), axis.line.x.top = element_blank(), axis.ticks.x.top = element_blank(), axis.title.y = element_blank(), axis.text.y = element_blank()) +
  SST_plot_annual_interpolated_plot + theme(axis.text.x.top = element_blank(), axis.title.x.top = element_blank(), axis.line.x.top = element_blank(), axis.ticks.x.top = element_blank(), axis.title.y = element_blank(), axis.text.y = element_blank()) +
  plot_layout(design = layout_2, guides = "collect")

Mg_thermometry_plots_constrained_V3 <- Mg_thermometry_plot_uninterpolated_constrained + theme(strip.text = element_blank(), axis.title = element_text(size = 15), axis.text = element_text(size = 12)) +
  Mg_thermometry_plot_seasonal_interpolation_constrained  + theme(axis.title.y = element_blank(), axis.text.y = element_blank(), strip.text = element_blank(), axis.title.x = element_text(size = 15), axis.text.x = element_text(size = 12)) +
  Mg_thermometry_plot_annual_interpolation_constrained + theme(axis.title.y = element_blank(), axis.text.y = element_blank(), strip.text = element_blank(), axis.title.x = element_text(size = 15), axis.text.x = element_text(size = 12)) +
  Mg_thermometry_plot_uninterpolated_averages_constrained  + theme(axis.title = element_text(size = 15), axis.text = element_text(size = 12)) +
  Mg_thermometry_plot_seasonal_interpolation_averages_constrained + theme(axis.title.y = element_blank(), axis.text.y = element_blank(), axis.title.x = element_text(size = 15), axis.text.x = element_text(size = 12)) +
  Mg_thermometry_plot_annual_interpolation_averages_constrained + theme(axis.title.y = element_blank(), axis.text.y = element_blank(), axis.title.x = element_text(size = 15), axis.text.x = element_text(size = 12)) +
  plot_layout(design = layout_2, guides = "collect")

## Ba ####
# New facet label names for supp variable
sample_labs <- c("23-1", "23-10", "23-16", "23-6")
names(sample_labs) <- c("S_23_1", "S_23_10", "S_23_16", "S_23_6")
All_samples_thermometry_data_V2$Specimen <- factor(All_samples_thermometry_data_V2$Specimen, levels = c("S_23_16", "S_23_1", "S_23_10", "S_23_6"))

Ba_SW_trends <- data.frame(Specimen = as.character(),
                                    Internode = numeric(),
                                    Timerange = as.character(),
                                    Interpolation = as.character(),
                                    Ttrend_Gradient = as.numeric(),
                                    Ttrend_Gradient_SD = as.numeric()
                                    )

### Common timeframe is 1998 to 2021 ####
#### uninterpolated ####
All_samples_Ba_SW <- All_samples_thermometry_data_V2 %>%
  unique() %>%
      group_by(distance.um, Specimen, Internode) %>% 
      summarise(Timepoint = 2021-(distance.um/51),
            Ba_Ca_proxy_TJW = 6.53*Ba_Ca,
            Ba_Ca_proxy_TJW_LL = (6.293*Ba_Ca), # 95% CI
            Ba_Ca_proxy_TJW_UL = (6.767*Ba_Ca)) # %>%
  na.omit() %>%
  summarise(Ba_Ca_proxy_TJW_CI = (Ba_Ca_proxy_TJW_UL-Ba_Ca_proxy_TJW_LL)/2) %>%
  ungroup() %>%
  summarise(mean = mean(Ba_Ca_proxy_TJW_CI, na.rm = T),
            max = max(Ba_Ca_proxy_TJW_CI, na.rm = T),
            min = min(Ba_Ca_proxy_TJW_CI, na.rm = T))

All_samples_Ba_SW_common <- All_samples_Ba_SW %>%
  filter(Timepoint >= 1998 & Timepoint <= 2021)

Ba_SW_plot_uninterpolated <- All_samples_Ba_SW %>%
      ggplot() +
      # geom_path(aes(x = Timepoint, y = Ba_Ca_proxy, col = Specimen), linetype = 3)+ # Thresher et al., 2016 - Geochim. et Cosmich. Acta
      geom_ribbon(aes(x = Timepoint, ymin = Ba_Ca_proxy_TJW_LL, ymax = Ba_Ca_proxy_TJW_UL, fill = as.factor(Specimen), linetype = as.factor(Internode)), alpha = 0.4) +
      geom_path(aes(x = Timepoint, y = Ba_Ca_proxy_TJW, linetype = as.factor(Internode), col = as.factor(Specimen)), lwd = 0.8) + # My calculated relationship
      geom_point(aes(x = 2015.215, y =52.5), col = "darkgrey") +
      geom_point(aes(x = 2015.215, y =52.4), col = "darkgrey") +
      geom_point(aes(x = 2015.215, y =52.7), col = "darkgrey") +
      geom_hline(aes(yintercept =52.4), col = "darkgrey", linetype = 4) +
      geom_hline(aes(yintercept =52.7), col = "darkgrey", linetype = 4) +
      labs(y = expression(paste("[Ba]"["SW"]*" (nmol.kg"^-1*")")), x = "Timepoint (years)") +
      scale_x_continuous(limits = c(1960, 2021), breaks = seq(1960,2020,5), sec.axis = sec_axis(~ -(. - 2021)*51, name = "Distance from coral wall (µm)")) +
      coord_cartesian(xlim = c(1960,2021)) +
      scale_fill_discrete(name = "Colony ID", breaks = c("S_23_1", "S_23_10", "S_23_16", "S_23_6"), labels = c("23-1", "23-10", "23-16", "23-6")) +
      scale_colour_manual(name = "Colony ID", breaks = c("S_23_1", "S_23_10", "S_23_16", "S_23_6"), labels = c("23-1", "23-10", "23-16", "23-6"), values = c("#003300", "#000099", "#990000", "#330066")) +
      scale_linetype_manual(name = "Internode", values = c(1,2,3)) +
      facet_grid(rows = vars(Specimen), labeller = labeller(Specimen = sample_labs)) +
      theme_classic()

Ba_SW_plot_uninterpolated_averages <- All_samples_Ba_SW_common %>%
  group_by(Specimen, Internode) %>%
  summarise(Samples = n(),
            Interpolation = "none",
            Timerange = "2000-2021",
            # Pub_mean = mean(Mg_Ca_proxy, na.rm = T),
            #         Pub_sd = sd(Mg_Ca_proxy, na.rm = T),
            #         Pub_se = sd(Mg_Ca_proxy, na.rm = T)/sqrt(n()),
            BaSw_mean = mean(Ba_Ca_proxy_TJW, na.rm = T),
            BaSw_sd = sd(Ba_Ca_proxy_TJW, na.rm = T),
            BaSw_se = sd(Ba_Ca_proxy_TJW, na.rm = T)/sqrt(n())) %>%
  ggplot() +
  geom_hline(aes(yintercept =52.4), col = "darkgrey", linetype = 4) +
  geom_hline(aes(yintercept =52.7), col = "darkgrey", linetype = 4) +
  geom_errorbar(aes(x = Specimen, ymin = BaSw_mean-BaSw_sd, ymax = BaSw_mean+BaSw_sd, linetype = as.factor(Internode)), 
                width = 0.5, lwd = 1, position = position_dodge(width = 1)) +
  geom_point(aes(x = Specimen, y = BaSw_mean, fill = Specimen), 
             pch = 21, size = 4, stroke = 2, position = position_dodge2(width = 1)) +
  ggpp::geom_label_npc(aes(npcx = 0.5, npcy = 0.85, label = "Timeperiod: 1998-2021")) +
  # scale_fill_manual(values = c("white", "black")) +
  scale_y_continuous(limits = c(40,100)) +
  scale_linetype_manual(values = c(1,2,3), name = "Internode") +
  scale_fill_manual(name = "Colony ID", breaks = c("S_23_1", "S_23_10", "S_23_16", "S_23_6"), labels = c("23-1", "23-10", "23-16", "23-6"), values = c("#99CC66", "#33CCCC", "#FF6666", "#9933FF")) +
  scale_x_discrete(name = "Colony ID", breaks = c("S_23_1", "S_23_10", "S_23_16", "S_23_6"), labels = c("23-1", "23-10", "23-16", "23-6")) +
  labs(y = expression("[Ba]"["SW"]*" (nmol.kg"^-1*")"), x = "Specimen") +
  theme_classic()

#### seasonally interpolated ####
All_samples_Ba_SW_season <- All_samples_Ba_SW %>% 
  drop_na() %>%
  group_by(Specimen, Internode) %>%
  summarise(
    Time = spline(Timepoint, Ba_Ca_proxy_TJW, xout = seq(min(Timepoint),2021, by = 0.25))$x,
    Ba_Ca_proxy_season_TJW = spline(Timepoint, Ba_Ca_proxy_TJW, xout = seq(min(Timepoint),2021, by = 0.25))$y,
    Ba_Ca_proxy_season_TJW_LL = spline(Timepoint, Ba_Ca_proxy_TJW_LL, xout = seq(min(Timepoint),2021, by = 0.25))$y,
    Ba_Ca_proxy_season_TJW_UL = spline(Timepoint, Ba_Ca_proxy_TJW_UL, xout = seq(min(Timepoint),2021, by = 0.25))$y)

All_samples_Ba_SW_season_common <- All_samples_Ba_SW_season %>%
  filter(Time >= 1998 & Time <= 2021 & Ba_Ca_proxy_season_TJW >= 40 & Ba_Ca_proxy_season_TJW <= 140)

# All_samples_Ba_thermometry_constrained_leveraged <- All_samples_Ba_thermometry_season_constrained %>%
#   group_by(Specimen, Time) %>%
#     filter(Time <= 2016) %>%
#   mutate(Time = round(Time, digits = 1)) %>%
#     summarise(Time = Time,
#             Mg_Ca_proxy_season_TJW_mean = mean(Mg_Ca_proxy_season_TJW, na.rm = T),
#             Mg_Ca_proxy_season_TJW_sd = sd(Mg_Ca_proxy_season_TJW, na.rm = T),
#             n = n()) %>%
#   unique() %>%
#   mutate(Mg_Ca_proxy_season_TJW_se = Mg_Ca_proxy_season_TJW_sd/(n-1)^0.5,
#          Mg_Ca_proxy_season_TJW_UL = Mg_Ca_proxy_season_TJW_mean+(Mg_Ca_proxy_season_TJW_sd*1.96),
#          Mg_Ca_proxy_season_TJW_LL = Mg_Ca_proxy_season_TJW_mean-(Mg_Ca_proxy_season_TJW_sd*1.96)
#          #error = qt(0.975,df=n-1)*Mg_Ca_proxy_season_TJW_sd/sqrt(n)
#          ) %>% 
#   filter(n > 1) %>%
#   #mutate(Mg_Ca_proxy_season_TJW_UL = Mg_Ca_proxy_season_TJW_mean+error,
#  #        Mg_Ca_proxy_season_TJW_LL = Mg_Ca_proxy_season_TJW_mean-error) %>%
#   summarise(Mg_Ca_proxy_season_TJW_CI = (Mg_Ca_proxy_season_TJW_UL-Mg_Ca_proxy_season_TJW_LL)/2) %>%
#   ungroup() %>%
#   summarise(mean = mean(Mg_Ca_proxy_season_TJW_CI, na.rm = T),
#             max = max(Mg_Ca_proxy_season_TJW_CI, na.rm = T),
#             min = min(Mg_Ca_proxy_season_TJW_CI, na.rm = T))

Ba_SW_plot_season_interpolated <- All_samples_Ba_SW_season %>%
      ggplot() +
      # geom_path(aes(x = Time, y = Ba_Ca_proxy, col = Specimen), linetype = 3)+ # Thresher et al., 2016 - Geochim. et Cosmich. Acta
      geom_ribbon(aes(x = Time, ymin = Ba_Ca_proxy_season_TJW_LL, ymax = Ba_Ca_proxy_season_TJW_UL, fill = as.factor(Specimen), linetype = as.factor(Internode)), alpha = 0.4) +
      geom_path(aes(x = Time, y = Ba_Ca_proxy_season_TJW, linetype = as.factor(Internode), col = as.factor(Specimen)), lwd = 0.8) + # My calculated relationship
      geom_point(aes(x = 2015.215, y =52.5), col = "darkgrey") +
      geom_point(aes(x = 2015.215, y =52.4), col = "darkgrey") +
      geom_point(aes(x = 2015.215, y =52.7), col = "darkgrey") +
      geom_hline(aes(yintercept =52.4), col = "darkgrey", linetype = 4) +
      geom_hline(aes(yintercept =52.7), col = "darkgrey", linetype = 4) +
      labs(y = expression(paste("[Ba]"["SW"]*" (nmol.kg"^-1*")")), x = "Timepoint (years)") +
      scale_x_continuous(limits = c(1960, 2021), breaks = seq(1960,2020,5), sec.axis = sec_axis(~ -(. - 2021)*51, name = "Distance from coral wall (µm)")) +
      scale_y_continuous(limits = c(40,140), breaks = seq(40,140,20)) +
      coord_cartesian(xlim = c(1960,2021)) +
      scale_fill_discrete(name = "Colony ID", breaks = c("S_23_1", "S_23_10", "S_23_16", "S_23_6"), labels = c("23-1", "23-10", "23-16", "23-6")) +
      scale_colour_manual(name = "Colony ID", breaks = c("S_23_1", "S_23_10", "S_23_16", "S_23_6"), labels = c("23-1", "23-10", "23-16", "23-6"), values = c("#003300", "#000099", "#990000", "#330066")) +
      scale_linetype_manual(name = "Internode", values = c(1,2,3)) +
      facet_grid(rows = vars(Specimen), labeller = labeller(Specimen = sample_labs)) +
      theme_classic()

Ba_SW_plot_season_interpolated_averages <- All_samples_Ba_SW_season_common %>%
  group_by(Specimen, Internode) %>%
  summarise(Samples = n(),
            Interpolation = "season",
            Timerange = "2000-2021",
            # Pub_mean = mean(Mg_Ca_proxy, na.rm = T),
            #         Pub_sd = sd(Mg_Ca_proxy, na.rm = T),
            #         Pub_se = sd(Mg_Ca_proxy, na.rm = T)/sqrt(n()),
            BaSw_mean = mean(Ba_Ca_proxy_season_TJW, na.rm = T),
            BaSw_sd = sd(Ba_Ca_proxy_season_TJW, na.rm = T),
            BaSw_se = sd(Ba_Ca_proxy_season_TJW, na.rm = T)/sqrt(n())) %>%
  ggplot() +
  geom_hline(aes(yintercept =52.4), col = "darkgrey", linetype = 4) +
  geom_hline(aes(yintercept =52.7), col = "darkgrey", linetype = 4) +
  geom_errorbar(aes(x = Specimen, ymin = BaSw_mean-BaSw_sd, ymax = BaSw_mean+BaSw_sd, linetype = as.factor(Internode)), 
                width = 0.5, lwd = 1, position = position_dodge(width = 1)) +
  geom_point(aes(x = Specimen, y = BaSw_mean, fill = Specimen), 
             pch = 21, size = 4, stroke = 2, position = position_dodge2(width = 1)) +
  ggpp::geom_label_npc(aes(npcx = 0.5, npcy = 0.85, label = "Timeperiod: 1998-2021")) +
  # scale_fill_manual(values = c("white", "black")) +
  scale_y_continuous(limits = c(40,100)) +
  scale_linetype_manual(values = c(1,2,3), name = "Internode") +
  scale_fill_manual(name = "Colony ID", breaks = c("S_23_1", "S_23_10", "S_23_16", "S_23_6"), labels = c("23-1", "23-10", "23-16", "23-6"), values = c("#99CC66", "#33CCCC", "#FF6666", "#9933FF")) +
  scale_x_discrete(name = "Colony ID", breaks = c("S_23_1", "S_23_10", "S_23_16", "S_23_6"), labels = c("23-1", "23-10", "23-16", "23-6")) +
  labs(y = expression("[Ba]"["SW"]*" (nmol.kg"^-1*")"), x = "Specimen") +
  theme_classic()

#### annually interpolated ####
All_samples_Ba_SW_annual <- All_samples_Ba_SW %>% 
  drop_na() %>%
  group_by(Specimen, Internode) %>%
  summarise(
    Time = spline(Timepoint, Ba_Ca_proxy_TJW, xout = seq(min(Timepoint),2021, by = 1))$x,
    Ba_Ca_proxy_annual_TJW = spline(Timepoint, Ba_Ca_proxy_TJW, xout = seq(min(Timepoint),2021, by = 1))$y,
    Ba_Ca_proxy_annual_TJW_LL = spline(Timepoint, Ba_Ca_proxy_TJW_LL, xout = seq(min(Timepoint),2021, by = 1))$y,
    Ba_Ca_proxy_annual_TJW_UL = spline(Timepoint, Ba_Ca_proxy_TJW_UL, xout = seq(min(Timepoint),2021, by = 1))$y)

All_samples_Ba_SW_annual_common <- All_samples_Ba_SW_annual %>%
  filter(Time >= 1998 & Time <= 2021 & Ba_Ca_proxy_annual_TJW >= 40 & Ba_Ca_proxy_annual_TJW <= 140)

Ba_SW_plot_annual_interpolated <- All_samples_Ba_SW_annual %>%
      ggplot() +
      # geom_path(aes(x = Time, y = Ba_Ca_proxy, col = Specimen), linetype = 3)+ # Thresher et al., 2016 - Geochim. et Cosmich. Acta
      geom_ribbon(aes(x = Time, ymin = Ba_Ca_proxy_annual_TJW_LL, ymax = Ba_Ca_proxy_annual_TJW_UL, fill = as.factor(Specimen), linetype = as.factor(Internode)), alpha = 0.4) +
      geom_path(aes(x = Time, y = Ba_Ca_proxy_annual_TJW, linetype = as.factor(Internode), col = as.factor(Specimen)), lwd = 0.8) + # My calculated relationship
      geom_point(aes(x = 2015.215, y =52.5), col = "darkgrey") +
      geom_point(aes(x = 2015.215, y =52.4), col = "darkgrey") +
      geom_point(aes(x = 2015.215, y =52.7), col = "darkgrey") +
      geom_hline(aes(yintercept =52.4), col = "darkgrey", linetype = 4) +
      geom_hline(aes(yintercept =52.7), col = "darkgrey", linetype = 4) +
      labs(y = expression(paste("[Ba]"["SW"]*" (nmol.kg"^-1*")")), x = "Timepoint (years)") +
      scale_x_continuous(limits = c(1960, 2021), breaks = seq(1960,2020,5), sec.axis = sec_axis(~ -(. - 2021)*51, name = "Distance from coral wall (µm)")) +
      scale_y_continuous(limits = c(40,140), breaks = seq(40,140,20)) +
      coord_cartesian(xlim = c(1960,2021)) +
      scale_fill_discrete(name = "Colony ID", breaks = c("S_23_1", "S_23_10", "S_23_16", "S_23_6"), labels = c("23-1", "23-10", "23-16", "23-6")) +
      scale_colour_manual(name = "Colony ID", breaks = c("S_23_1", "S_23_10", "S_23_16", "S_23_6"), labels = c("23-1", "23-10", "23-16", "23-6"), values = c("#003300", "#000099", "#990000", "#330066")) +
      scale_linetype_manual(name = "Internode", values = c(1,2,3)) +
      facet_grid(rows = vars(Specimen), labeller = labeller(Specimen = sample_labs)) +
      theme_classic()

Ba_SW_plot_annual_interpolated_averages <- All_samples_Ba_SW_annual_common %>%
  group_by(Specimen, Internode) %>%
  summarise(Samples = n(),
            Interpolation = "annual",
            Timerange = "2000-2021",
            # Pub_mean = mean(Mg_Ca_proxy, na.rm = T),
            #         Pub_sd = sd(Mg_Ca_proxy, na.rm = T),
            #         Pub_se = sd(Mg_Ca_proxy, na.rm = T)/sqrt(n()),
            BaSw_mean = mean(Ba_Ca_proxy_annual_TJW, na.rm = T),
            BaSw_sd = sd(Ba_Ca_proxy_annual_TJW, na.rm = T),
            BaSw_se = sd(Ba_Ca_proxy_annual_TJW, na.rm = T)/sqrt(n())) %>%
  ggplot() +
  geom_hline(aes(yintercept =52.4), col = "darkgrey", linetype = 4) +
  geom_hline(aes(yintercept =52.7), col = "darkgrey", linetype = 4) +
  geom_errorbar(aes(x = Specimen, ymin = BaSw_mean-BaSw_sd, ymax = BaSw_mean+BaSw_sd, linetype = as.factor(Internode)), 
                width = 0.5, lwd = 1, position = position_dodge(width = 1)) +
  geom_point(aes(x = Specimen, y = BaSw_mean, fill = Specimen), 
             pch = 21, size = 4, stroke = 2, position = position_dodge2(width = 1)) +
  ggpp::geom_label_npc(aes(npcx = 0.5, npcy = 0.85, label = "Timeperiod: 1998-2021")) +
  # scale_fill_manual(values = c("white", "black")) +
  scale_y_continuous(limits = c(40,100)) +
  scale_linetype_manual(values = c(1,2,3), name = "Internode") +
  scale_fill_manual(name = "Colony ID", breaks = c("S_23_1", "S_23_10", "S_23_16", "S_23_6"), labels = c("23-1", "23-10", "23-16", "23-6"), values = c("#99CC66", "#33CCCC", "#FF6666", "#9933FF")) +
  scale_x_discrete(name = "Colony ID", breaks = c("S_23_1", "S_23_10", "S_23_16", "S_23_6"), labels = c("23-1", "23-10", "23-16", "23-6")) +
  labs(y = expression("[Ba]"["SW"]*" (nmol.kg"^-1*")"), x = "Colony") +
  theme_classic()

Ba_SW_plots <- Ba_SW_plot_uninterpolated + theme(strip.text = element_blank(), axis.title = element_text(size = 15), axis.text = element_text(size = 12)) +
  Ba_SW_plot_season_interpolated + theme(axis.title.y = element_blank(), axis.text.y = element_blank(), strip.text = element_blank(), axis.title.x = element_text(size = 15), axis.text.x = element_text(size = 12)) +
  Ba_SW_plot_annual_interpolated + theme(axis.title.y = element_blank(), axis.text.y = element_blank(), strip.text = element_blank(), axis.title.x = element_text(size = 15), axis.text.x = element_text(size = 12)) +
  Ba_SW_plot_uninterpolated_averages + theme(axis.title = element_text(size = 15), axis.text = element_text(size = 12)) +
  Ba_SW_plot_season_interpolated_averages + theme(axis.title.y = element_blank(), axis.text.y = element_blank(), axis.title.x = element_text(size = 15), axis.text.x = element_text(size = 12)) +
  Ba_SW_plot_annual_interpolated_averages + theme(axis.title.y = element_blank(), axis.text.y = element_blank(), axis.title.x = element_text(size = 15), axis.text.x = element_text(size = 12)) +
  plot_layout(guides = "collect", design = layout_2)

## Saving files ####
Thermometry_folder_path <- "~/Library/CloudStorage/OneDrive-UniversityofSouthampton/PhD, INSPIRE DTP/Countries_Chapters/UK [Soton]/Chpt4 Bamboo Coral Analysis/LAICPMS/Data_R_processed/NIST612_Corrected_Thermometry"

  plot_layout(design = layout, guides = "collect", )

### Remove coral edge and central axis - common timeframe is now 2003 to 2016 ####
Mg_thermometry_plot_uninterpolated_constrained <- All_samples_thermometry_data_V2 %>%
      group_by(distance.um, Specimen) %>% 
      summarise(Timepoint = 2021-(distance.um/51),
            Mg_Ca_proxy = ((0.34*Mg_Ca/1000)-23.9),
            Mg_Ca_proxy_TJW = ((0.313*Mg_Ca/1000)-21.4)) %>%
    ungroup() %>%
  filter(Specimen == "S_23_6" & Timepoint >= 1967 | Specimen == "S_23_1" & Timepoint >= 1998 |
           Specimen == "S_23_16" & Timepoint >= 2001 | Specimen == "S_23_10" & Timepoint >= 1995) %>%
      ggplot() +
      geom_path(aes(x = Timepoint, y = Mg_Ca_proxy, col = Specimen), linetype = 3)+ # Thresher et al., 2016 - Geochim. et Cosmich. Acta
      geom_path(aes(x = Timepoint, y = Mg_Ca_proxy_TJW, col = Specimen)) + # My calculated relationship
      geom_point(aes(x = 2018.6068, y =0.86), col = "orange") +
      geom_point(aes(x = 2017.5466, y =0.68), col = "orange") +
      geom_point(aes(x = 2016.5642, y =1.05), col = "orange") +
      geom_point(aes(x = 2021.5849, y = 1.1), col = "orange") +
      labs(y = expression("T"["[rec]"]*" (°C)"), x = "Timepoint (years)") +
      geom_hline(yintercept = 1.1, linetype = 2) +
      geom_hline(yintercept = 0.68, linetype = 2) +
      geom_label(aes(y = -2.5, x = 1990, label = "No interpolation")) +
      scale_x_continuous(limits = c(1960,2016), breaks = seq(1960,2020,5), sec.axis = sec_axis(~ -(. - 2021)*51, name = "Distance from coral wall (µm)")) +
      scale_y_continuous(limits = c(-5,10)) +
      theme_classic()

Mg_thermometry_plot_uninterpolated_constrained_averages <- All_samples_thermometry_data_V2 %>%
      group_by(distance.um, Specimen) %>% 
      summarise(Timepoint = 2021-(distance.um/51),
            Mg_Ca_proxy = ((0.34*Mg_Ca/1000)-23.9),
            Mg_Ca_proxy_TJW = ((0.313*Mg_Ca/1000)-21.4)) %>%
    ungroup() %>%
  filter(Specimen == "S_23_6" & Timepoint >= 1967 | Specimen == "S_23_1" & Timepoint >= 1998 |
           Specimen == "S_23_16" & Timepoint >= 2001 | Specimen == "S_23_10" & Timepoint >= 1995) %>%
filter(Timepoint >= 2003 & Timepoint <= 2016 & Mg_Ca_proxy <= 10 & Mg_Ca_proxy >= -5 & Mg_Ca_proxy_TJW <= 10 & Mg_Ca_proxy_TJW >= -5) %>%
  group_by(Specimen) %>%
  summarise(Samples = n(),
    Pub_mean = mean(Mg_Ca_proxy, na.rm = T),
            Pub_sd = sd(Mg_Ca_proxy, na.rm = T),
            Pub_se = sd(Mg_Ca_proxy, na.rm = T)/sqrt(n()),
        TJW_mean = mean(Mg_Ca_proxy_TJW, na.rm = T),
            TJW_sd = sd(Mg_Ca_proxy_TJW, na.rm = T),
            TJW_se = sd(Mg_Ca_proxy_TJW, na.rm = T)/sqrt(n())) %>%
  mutate(Pub_alpha = c(-0.03,-0.17,-0.02,-0.00253),
         TJW_alpha = c(-0.02,-0.16,-0.02,-0.00233)) %>%
  pivot_longer(cols = c(3:10), names_to = "Calculation", values_to = "value") %>%
  separate(col = "Calculation", "_", into = c("Calibration", "Calculation")) %>%
  pivot_wider(names_from = "Calculation", values_from = "value") %>%
      ggplot() +
          geom_hline(yintercept = 1.1, linetype = 2) +
      geom_hline(yintercept = 0.68, linetype = 2) +
  geom_vline(xintercept = 0, linetype = 2) +
    geom_errorbar(aes(x = alpha, ymin = mean-sd, ymax = mean+sd, linetype = Calibration), 
                width = 0.1) +
      geom_point(aes(x = alpha, y = mean, col = Specimen, fill = Calibration), 
                 pch = 21, size = 4, stroke = 2) +
  scale_fill_manual(values = c("white", "black")) +
  scale_linetype_manual(values = c(3,1)) +
      labs(y = expression("T"["[rec]"]*" (°C)"), x = expression("T"["[rec]"]*" trend (°C.yr"^"-1"*")")) +
       scale_y_continuous(limits = c(-5,10)) +
      scale_x_continuous(limits = c(-0.40,0.6)) +
      theme_classic()

Mg_thermometry_plot_seasonal_interpolation_constrained <- All_samples_thermometry_data_V2 %>%
      group_by(distance.um, Specimen) %>% 
      summarise(Timepoint = 2021-(distance.um/51),
            Mg_Ca_proxy = ((0.34*Mg_Ca/1000)-23.9),
            Mg_Ca_proxy_TJW = ((0.313*Mg_Ca/1000)-21.4)) %>%
  drop_na() %>%
    ungroup() %>%
  filter(Specimen == "S_23_6" & Timepoint >= 1967 | Specimen == "S_23_1" & Timepoint >= 1998 |
           Specimen == "S_23_16" & Timepoint >= 2001 | Specimen == "S_23_10" & Timepoint >= 1995) %>%
  group_by(Specimen) %>%
  summarise(
            Time = spline(Timepoint, Mg_Ca_proxy_TJW, xout = seq(min(Timepoint),2021, by = 0.25))$x,
            Mg_Ca_proxy_season_TJW = spline(Timepoint, Mg_Ca_proxy_TJW, xout = seq(min(Timepoint),2021, by = 0.25))$y,
            Mg_Ca_proxy_season = spline(Timepoint, Mg_Ca_proxy, xout = seq(min(Timepoint),2021, by = 0.25))$y) %>% 
  ggplot() +
  geom_path(aes(Time, Mg_Ca_proxy_season, group = Specimen, col = Specimen), linetype = 3) +
      geom_path(aes(Time, Mg_Ca_proxy_season_TJW, group = Specimen, col = Specimen)) +
      geom_point(aes(x = 2018.6068, y =0.86), col = "orange") +
      geom_point(aes(x = 2017.5466, y =0.68), col = "orange") +
      geom_point(aes(x = 2016.5642, y =1.05), col = "orange") +
      geom_point(aes(x = 2021.5849, y = 1.1), col = "orange") +
      labs(y = expression("T"["[rec]"]*" (°C)"), x = "Timepoint (years)") +
      geom_hline(yintercept = 1.1, linetype = 2) +
      geom_hline(yintercept = 0.68, linetype = 2) +
      geom_label(aes(y = -2.5, x = 1990, label = "Seasonal interpolation (spline)")) +
      scale_x_continuous(limits = c(1960,2016), breaks = seq(1960,2020,5), sec.axis = sec_axis(~ -(. - 2021)*51, name = "Distance from coral wall (µm)")) +
      scale_y_continuous(limits = c(-5,10)) +
      theme_classic()

Mg_thermometry_plot_seasonal_interpolation_constrained_averages <- All_samples_thermometry_data_V2 %>%
      group_by(distance.um, Specimen) %>% 
      summarise(Timepoint = 2021-(distance.um/51),
            Mg_Ca_proxy = ((0.34*Mg_Ca/1000)-23.9),
            Mg_Ca_proxy_TJW = ((0.313*Mg_Ca/1000)-21.4)) %>%
  drop_na() %>%
    ungroup() %>%
  filter(Specimen == "S_23_6" & Timepoint >= 1967 | Specimen == "S_23_1" & Timepoint >= 1998 |
           Specimen == "S_23_16" & Timepoint >= 2001 | Specimen == "S_23_10" & Timepoint >= 1995) %>%
  group_by(Specimen) %>%
  summarise(
            Time = spline(Timepoint, Mg_Ca_proxy_TJW, xout = seq(min(Timepoint),2021, by = 0.25))$x,
            Mg_Ca_proxy_season_TJW = spline(Timepoint, Mg_Ca_proxy_TJW, xout = seq(min(Timepoint),2021, by = 0.25))$y,
            Mg_Ca_proxy_season = spline(Timepoint, Mg_Ca_proxy, xout = seq(min(Timepoint),2021, by = 0.25))$y) %>% 
filter(Time >= 2003 & Time <= 2016 & Mg_Ca_proxy_season <= 10 & Mg_Ca_proxy_season >= -5 & Mg_Ca_proxy_season_TJW <= 10 & Mg_Ca_proxy_season_TJW >= -5) %>%
  group_by(Specimen) %>%
  summarise(Samples = n(),
    Pub_mean = mean(Mg_Ca_proxy_season, na.rm = T),
            Pub_sd = sd(Mg_Ca_proxy_season, na.rm = T),
            Pub_se = sd(Mg_Ca_proxy_season, na.rm = T)/sqrt(n()),
        TJW_mean = mean(Mg_Ca_proxy_season_TJW, na.rm = T),
            TJW_sd = sd(Mg_Ca_proxy_season_TJW, na.rm = T),
            TJW_se = sd(Mg_Ca_proxy_season_TJW, na.rm = T)/sqrt(n())) %>%
  mutate(Pub_alpha = c(-0.02,-0.17,-0.02,-0.00158),
         TJW_alpha = c(-0.02,-0.16,-0.02,-0.00146)) %>%
  pivot_longer(cols = c(3:10), names_to = "Calculation", values_to = "value") %>%
  separate(col = "Calculation", "_", into = c("Calibration", "Calculation")) %>%
  pivot_wider(names_from = "Calculation", values_from = "value") %>%
      ggplot() +
          geom_hline(yintercept = 1.1, linetype = 2) +
      geom_hline(yintercept = 0.68, linetype = 2) +
  geom_vline(xintercept = 0, linetype = 2) +
    geom_errorbar(aes(x = alpha, ymin = mean-sd, ymax = mean+sd, linetype = Calibration), 
                width = 0.1) +
      geom_point(aes(x = alpha, y = mean, col = Specimen, fill = Calibration), 
                 pch = 21, size = 4, stroke = 2) +
  scale_fill_manual(values = c("white", "black")) +
  scale_linetype_manual(values = c(3,1)) +
      labs(y = expression("T"["[rec]"]*" (°C)"), x = expression("T"["[rec]"]*" trend (°C.yr"^"-1"*")")) +
       scale_y_continuous(limits = c(-5,10)) +
      scale_x_continuous(limits = c(-0.40,0.6)) +
      theme_classic()

Mg_thermometry_plot_annual_interpolation_constrained <- All_samples_thermometry_data_V2 %>%
      group_by(distance.um, Specimen) %>% 
      summarise(Timepoint = 2021-(distance.um/51),
            Mg_Ca_proxy = ((0.34*Mg_Ca/1000)-23.9),
            Mg_Ca_proxy_TJW = ((0.313*Mg_Ca/1000)-21.4)) %>%
  drop_na() %>%
    ungroup() %>%
  filter(Specimen == "S_23_6" & Timepoint >= 1967 | Specimen == "S_23_1" & Timepoint >= 1998 |
           Specimen == "S_23_16" & Timepoint >= 2001 | Specimen == "S_23_10" & Timepoint >= 1995) %>%
  group_by(Specimen) %>%
  summarise(
            Time = spline(Timepoint, Mg_Ca_proxy_TJW, xout = seq(min(Timepoint),2021, by = 1))$x,
            Mg_Ca_proxy_season_TJW = spline(Timepoint, Mg_Ca_proxy_TJW, xout = seq(min(Timepoint),2021, by = 1))$y,
            Mg_Ca_proxy_season = spline(Timepoint, Mg_Ca_proxy, xout = seq(min(Timepoint),2021, by = 1))$y) %>% 
  ggplot() +
  geom_path(aes(Time, Mg_Ca_proxy_season, group = Specimen, col = Specimen), linetype = 3) +
      geom_path(aes(Time, Mg_Ca_proxy_season_TJW, group = Specimen, col = Specimen)) +
      geom_point(aes(x = 2018.6068, y =0.86), col = "orange") +
      geom_point(aes(x = 2017.5466, y =0.68), col = "orange") +
      geom_point(aes(x = 2016.5642, y =1.05), col = "orange") +
      geom_point(aes(x = 2021.5849, y = 1.1), col = "orange") +
      labs(y = expression("T"["[rec]"]*" (°C)"), x = "Timepoint (years)") +
      geom_hline(yintercept = 1.1, linetype = 2) +
      geom_hline(yintercept = 0.68, linetype = 2) +
      geom_label(aes(y = -2.5, x = 1990, label = "Annual interpolation (spline)")) +
      scale_x_continuous(limits = c(1960,2016), breaks = seq(1960,2020,5), sec.axis = sec_axis(~ -(. - 2021)*51, name = "Distance from coral wall (µm)")) +
      scale_y_continuous(limits = c(-5,10)) +
      theme_classic()

Mg_thermometry_plot_annual_interpolation_constrained_averages <- All_samples_thermometry_data_V2 %>%
      group_by(distance.um, Specimen) %>% 
      summarise(Timepoint = 2021-(distance.um/51),
            Mg_Ca_proxy = ((0.34*Mg_Ca/1000)-23.9),
            Mg_Ca_proxy_TJW = ((0.313*Mg_Ca/1000)-21.4)) %>%
  drop_na() %>%
    ungroup() %>%
  filter(Specimen == "S_23_6" & Timepoint >= 1967 | Specimen == "S_23_1" & Timepoint >= 1998 |
           Specimen == "S_23_16" & Timepoint >= 2001 | Specimen == "S_23_10" & Timepoint >= 1995) %>%
  group_by(Specimen) %>%
  summarise(
            Time = spline(Timepoint, Mg_Ca_proxy_TJW, xout = seq(min(Timepoint),2021, by = 1))$x,
            Mg_Ca_proxy_season_TJW = spline(Timepoint, Mg_Ca_proxy_TJW, xout = seq(min(Timepoint),2021, by = 1))$y,
            Mg_Ca_proxy_season = spline(Timepoint, Mg_Ca_proxy, xout = seq(min(Timepoint),2021, by = 1))$y) %>% 
  filter(Time >= 2003 & Time <= 2016 & Mg_Ca_proxy_season <= 10 & Mg_Ca_proxy_season >= -5 & Mg_Ca_proxy_season_TJW <= 10 & Mg_Ca_proxy_season_TJW >= -5) %>%
  group_by(Specimen) %>%
  summarise(Samples = n(),
    Pub_mean = mean(Mg_Ca_proxy_season, na.rm = T),
            Pub_sd = sd(Mg_Ca_proxy_season, na.rm = T),
            Pub_se = sd(Mg_Ca_proxy_season, na.rm = T)/sqrt(n()),
        TJW_mean = mean(Mg_Ca_proxy_season_TJW, na.rm = T),
            TJW_sd = sd(Mg_Ca_proxy_season_TJW, na.rm = T),
            TJW_se = sd(Mg_Ca_proxy_season_TJW, na.rm = T)/sqrt(n())) %>%
  mutate(Pub_alpha = c(-0.02,-0.17,-0.03,0.006),
         TJW_alpha = c(-0.02,-0.16,-0.02,0.006)) %>%
  pivot_longer(cols = c(3:10), names_to = "Calculation", values_to = "value") %>%
  separate(col = "Calculation", "_", into = c("Calibration", "Calculation")) %>%
  pivot_wider(names_from = "Calculation", values_from = "value") %>%
      ggplot() +
          geom_hline(yintercept = 1.1, linetype = 2) +
      geom_hline(yintercept = 0.68, linetype = 2) +
  geom_vline(xintercept = 0, linetype = 2) +
    geom_errorbar(aes(x = alpha, ymin = mean-sd, ymax = mean+sd, linetype = Calibration), 
                width = 0.1) +
      geom_point(aes(x = alpha, y = mean, col = Specimen, fill = Calibration), 
                 pch = 21, size = 4, stroke = 2) +
  scale_fill_manual(values = c("white", "black")) +
  scale_linetype_manual(values = c(3,1)) +
      labs(y = expression("T"["[rec]"]*" (°C)"), x = expression("T"["[rec]"]*" trend (°C.yr"^"-1"*")")) +
       scale_y_continuous(limits = c(-5,10)) +
      scale_x_continuous(limits = c(-0.40,0.6)) +
      theme_classic()


Mg_thermometry_plots_constrained <- Mg_thermometry_plot_uninterpolated_constrained + theme(axis.title.x.bottom = element_blank(), axis.title.y = element_blank()) + 
  Mg_thermometry_plot_uninterpolated_constrained_averages + theme(axis.title.x.bottom = element_blank(), axis.title.y = element_blank()) +
  Mg_thermometry_plot_seasonal_interpolation_constrained  + theme(axis.title.x = element_blank()) +
  Mg_thermometry_plot_seasonal_interpolation_constrained_averages  + theme(axis.title.x.bottom = element_blank(), axis.title.y = element_blank()) +
  Mg_thermometry_plot_annual_interpolation_constrained + theme(axis.title.y = element_blank(), axis.title.x.top = element_blank()) +
  Mg_thermometry_plot_annual_interpolation_constrained_averages + theme(axis.title.y = element_blank()) +
  plot_layout(design = layout, guides = "collect", )

## S ####

S_thermometry_plot_uninterpolated <- All_samples_thermometry_data_V2 %>%
      group_by(distance.um, Specimen) %>% 
      summarise(Timepoint = 2021-(distance.um/51),
            S_Ca_proxy = ((-0.3*S_Ca/1000)+7.52),
            S_Ca_proxy_TJW = ((0.128*S_Ca/1000)+3.79)) %>%
      ggplot() +
      geom_path(aes(x = Timepoint, y = S_Ca_proxy, col = Specimen), linetype = 3)+ # Thresher et al., 2016 - Geochim. et Cosmich. Acta
      geom_path(aes(x = Timepoint, y = S_Ca_proxy_TJW, col = Specimen)) + # My calculated relationship
      geom_point(aes(x = 2018.6068, y =0.86), col = "orange") +
      geom_point(aes(x = 2017.5466, y =0.68), col = "orange") +
      geom_point(aes(x = 2016.5642, y =1.05), col = "orange") +
      geom_point(aes(x = 2021.5849, y = 1.1), col = "orange") +
      labs(y = expression("T"["[rec]"]*" (°C)"), x = "Timepoint (years)") +
      geom_hline(yintercept = 1.1, linetype = 2) +
      geom_hline(yintercept = 0.68, linetype = 2) +
      geom_label(aes(y = 8, x = 1990, label = "No interpolation")) +
      scale_x_continuous(limits = c(1960,2022), breaks = seq(1960,2020,5), sec.axis = sec_axis(~ -(. - 2021)*51, name = "Distance from coral wall (µm)")) +
      scale_y_continuous(limits = c(0,7)) +
      theme_classic()

S_thermometry_plot_seasonal_interpolation <- All_samples_thermometry_data_V2 %>%
      group_by(distance.um, Specimen) %>% 
      summarise(Timepoint = 2021-(distance.um/51),
            S_Ca_proxy = ((-0.3*S_Ca/1000)+7.52),
            S_Ca_proxy_TJW = ((0.128*S_Ca/1000)+3.79)) %>%
  drop_na() %>%
  ungroup(distance.um) %>%
  group_by(Specimen) %>%
  summarise(
            Time = spline(Timepoint, S_Ca_proxy_TJW, xout = seq(min(Timepoint),2021, by = 0.25))$x,
            S_Ca_proxy_season_TJW = spline(Timepoint, S_Ca_proxy_TJW, xout = seq(min(Timepoint),2021, by = 0.25))$y,
            S_Ca_proxy_season = spline(Timepoint, S_Ca_proxy, xout = seq(min(Timepoint),2021, by = 0.25))$y) %>% 
  ggplot() +
  geom_path(aes(Time, S_Ca_proxy_season, group = Specimen, col = Specimen), linetype = 3) +
      geom_path(aes(Time, S_Ca_proxy_season_TJW, group = Specimen, col = Specimen)) +
      geom_point(aes(x = 2018.6068, y =0.86), col = "orange") +
      geom_point(aes(x = 2017.5466, y =0.68), col = "orange") +
      geom_point(aes(x = 2016.5642, y =1.05), col = "orange") +
      geom_point(aes(x = 2021.5849, y = 1.1), col = "orange") +
      labs(y = expression("T"["[rec]"]*" (°C)"), x = "Timepoint (years)") +
      geom_hline(yintercept = 1.1, linetype = 2) +
      geom_hline(yintercept = 0.68, linetype = 2) +
      geom_label(aes(y = 8, x = 1990, label = "Seasonal interpolation (spline)")) +
      scale_x_continuous(limits = c(1960,2022), breaks = seq(1960,2020,5), sec.axis = sec_axis(~ -(. - 2021)*51, name = "Distance from coral wall (µm)")) +
      scale_y_continuous(limits = c(0,7)) +
      theme_classic()

data <- All_samples_thermometry_data_V2 %>%
      group_by(distance.um, Specimen) %>% 
      summarise(Timepoint = 2021-(distance.um/51),
            S_Ca_proxy = ((-0.3*S_Ca/1000)+7.52),
            S_Ca_proxy_TJW = ((0.128*S_Ca/1000)+3.79)) %>%
  drop_na() %>%
  ungroup(distance.um) %>%
  group_by(Specimen) %>%
  summarise(
            Time = spline(Timepoint, S_Ca_proxy_TJW, xout = seq(min(Timepoint),2021, by = 1))$x,
            S_Ca_proxy_season_TJW = spline(Timepoint, S_Ca_proxy_TJW, xout = seq(min(Timepoint),2021, by = 1))$y,
            S_Ca_proxy_season = spline(Timepoint, S_Ca_proxy, xout = seq(min(Timepoint),2021, by = 1))$y)

S_thermometry_plot_annual_interpolation <- All_samples_thermometry_data_V2 %>%
      group_by(distance.um, Specimen) %>% 
      summarise(Timepoint = 2021-(distance.um/51),
            S_Ca_proxy = ((-0.3*S_Ca/1000)+7.52),
            S_Ca_proxy_TJW = ((0.128*S_Ca/1000)+3.79)) %>%
  drop_na() %>%
  ungroup(distance.um) %>%
  group_by(Specimen) %>%
  summarise(
            Time = spline(Timepoint, S_Ca_proxy_TJW, xout = seq(min(Timepoint),2021, by = 1))$x,
            S_Ca_proxy_season_TJW = spline(Timepoint, S_Ca_proxy_TJW, xout = seq(min(Timepoint),2021, by = 1))$y,
            S_Ca_proxy_season = spline(Timepoint, S_Ca_proxy, xout = seq(min(Timepoint),2021, by = 1))$y) %>% 
  ggplot() +
  geom_path(aes(Time, S_Ca_proxy_season, group = Specimen, col = Specimen), linetype = 3) +
      geom_path(aes(Time, S_Ca_proxy_season_TJW, group = Specimen, col = Specimen)) +
      geom_point(aes(x = 2018.6068, y =0.86), col = "orange") +
      geom_point(aes(x = 2017.5466, y =0.68), col = "orange") +
      geom_point(aes(x = 2016.5642, y =1.05), col = "orange") +
      geom_point(aes(x = 2021.5849, y = 1.1), col = "orange") +
      labs(y = expression("T"["[rec]"]*" (°C)"), x = "Timepoint (years)") +
      geom_hline(yintercept = 1.1, linetype = 2) +
      geom_hline(yintercept = 0.68, linetype = 2) +
      geom_label(aes(y = 8, x = 1990, label = "Annual interpolation (spline)")) +
      scale_x_continuous(limits = c(1960,2022), breaks = seq(1960,2020,5), sec.axis = sec_axis(~ -(. - 2021)*51, name = "Distance from coral wall (µm)")) +
      scale_y_continuous(limits = c(0,7)) +
      theme_classic()


S_thermometry_plots <- S_thermometry_plot_uninterpolated + theme(axis.title.x.bottom = element_blank(), axis.title.y = element_blank()) +
  S_thermometry_plot_seasonal_interpolation  + theme(axis.title.x = element_blank()) +
  S_thermometry_plot_annual_interpolation + theme(axis.title.y = element_blank(), axis.title.x.top = element_blank()) +
  plot_layout(nrow = 3, guides = "collect")


## Sr ####
Sr_thermometry_plot_uninterpolated <- All_samples_thermometry_data_V2 %>%
      group_by(distance.um, Specimen) %>% 
      summarise(Timepoint = 2021-(distance.um/51),
            Sr_Ca_proxy = ((3.1367*Sr_Ca/1000)-2.06),
            Sr_Ca_proxy_TJW = ((4.39*Sr_Ca/1000)-7.87)) %>%
      ggplot() +
      geom_path(aes(x = Timepoint, y = Sr_Ca_proxy, col = Specimen), linetype = 3)+ # Thresher et al., 2016 - Geochim. et Cosmich. Acta
      geom_path(aes(x = Timepoint, y = Sr_Ca_proxy_TJW, col = Specimen)) + # My calculated relationship
      geom_point(aes(x = 2018.6068, y =0.86), col = "orange") +
      geom_point(aes(x = 2017.5466, y =0.68), col = "orange") +
      geom_point(aes(x = 2016.5642, y =1.05), col = "orange") +
      geom_point(aes(x = 2021.5849, y = 1.1), col = "orange") +
      labs(y = expression("T"["[rec]"]*" (°C)"), x = "Timepoint (years)") +
      geom_hline(yintercept = 1.1, linetype = 2) +
      geom_hline(yintercept = 0.68, linetype = 2) +
      geom_label(aes(y = 9, x = 1990, label = "No interpolation")) +
      scale_x_continuous(limits = c(1960,2022), breaks = seq(1960,2020,5), sec.axis = sec_axis(~ -(. - 2021)*51, name = "Distance from coral wall (µm)")) +
      scale_y_continuous(limits = c(0,8)) +
      theme_classic()


Sr_thermometry_plot_seasonal_interpolation <- All_samples_thermometry_data_V2 %>%
      group_by(distance.um, Specimen) %>% 
      summarise(Timepoint = 2021-(distance.um/51),
            Sr_Ca_proxy = ((3.1367*Sr_Ca/1000)-2.06),
            Sr_Ca_proxy_TJW = ((4.39*Sr_Ca/1000)-7.87)) %>%
  drop_na() %>%
  ungroup(distance.um) %>%
  group_by(Specimen) %>%
  summarise(
            Time = spline(Timepoint, Sr_Ca_proxy_TJW, xout = seq(min(Timepoint),2021, by = 0.25))$x,
            Sr_Ca_proxy_season_TJW = spline(Timepoint, Sr_Ca_proxy_TJW, xout = seq(min(Timepoint),2021, by = 0.25))$y,
            Sr_Ca_proxy_season = spline(Timepoint, Sr_Ca_proxy, xout = seq(min(Timepoint),2021, by = 0.25))$y) %>% 
  ggplot() +
  geom_path(aes(Time, Sr_Ca_proxy_season, group = Specimen, col = Specimen), linetype = 3) +
      geom_path(aes(Time, Sr_Ca_proxy_season_TJW, group = Specimen, col = Specimen)) +
      geom_point(aes(x = 2018.6068, y =0.86), col = "orange") +
      geom_point(aes(x = 2017.5466, y =0.68), col = "orange") +
      geom_point(aes(x = 2016.5642, y =1.05), col = "orange") +
      geom_point(aes(x = 2021.5849, y = 1.1), col = "orange") +
      labs(y = expression("T"["[rec]"]*" (°C)"), x = "Timepoint (years)") +
      geom_hline(yintercept = 1.1, linetype = 2) +
      geom_hline(yintercept = 0.68, linetype = 2) +
      geom_label(aes(y = 9, x = 1990, label = "Seasonal interpolation (spline)")) +
      scale_x_continuous(limits = c(1960,2022), breaks = seq(1960,2020,5), sec.axis = sec_axis(~ -(. - 2021)*51, name = "Distance from coral wall (µm)")) +
      scale_y_continuous(limits = c(0,8)) +
      theme_classic()

Sr_thermometry_plot_annual_interpolation <- All_samples_thermometry_data_V2 %>%
      group_by(distance.um, Specimen) %>% 
      summarise(Timepoint = 2021-(distance.um/51),
            Sr_Ca_proxy = ((3.1367*Sr_Ca/1000)-2.06),
            Sr_Ca_proxy_TJW = ((4.39*Sr_Ca/1000)-7.87)) %>%
  drop_na() %>%
  ungroup(distance.um) %>%
  group_by(Specimen) %>%
  summarise(
            Time = spline(Timepoint, Sr_Ca_proxy_TJW, xout = seq(min(Timepoint),2021, by = 1))$x,
            Sr_Ca_proxy_season_TJW = spline(Timepoint, Sr_Ca_proxy_TJW, xout = seq(min(Timepoint),2021, by = 1))$y,
            Sr_Ca_proxy_season = spline(Timepoint, Sr_Ca_proxy, xout = seq(min(Timepoint),2021, by = 1))$y) %>% 
  ggplot() +
  geom_path(aes(Time, Sr_Ca_proxy_season, group = Specimen, col = Specimen), linetype = 3) +
      geom_path(aes(Time, Sr_Ca_proxy_season_TJW, group = Specimen, col = Specimen)) +
      geom_point(aes(x = 2018.6068, y =0.86), col = "orange") +
      geom_point(aes(x = 2017.5466, y =0.68), col = "orange") +
      geom_point(aes(x = 2016.5642, y =1.05), col = "orange") +
      geom_point(aes(x = 2021.5849, y = 1.1), col = "orange") +
      labs(y = expression("T"["[rec]"]*" (°C)"), x = "Timepoint (years)") +
      geom_hline(yintercept = 1.1, linetype = 2) +
      geom_hline(yintercept = 0.68, linetype = 2) +
      geom_label(aes(y = 9, x = 1990, label = "Annual interpolation (spline)")) +
      scale_x_continuous(limits = c(1960,2022), breaks = seq(1960,2020,5), sec.axis = sec_axis(~ -(. - 2021)*51, name = "Distance from coral wall (µm)")) +
      scale_y_continuous(limits = c(0,8)) +
      theme_classic()


Sr_thermometry_plots <- Sr_thermometry_plot_uninterpolated + theme(axis.title.x.bottom = element_blank(), axis.title.y = element_blank()) +
  Sr_thermometry_plot_seasonal_interpolation  + theme(axis.title.x = element_blank()) +
  Sr_thermometry_plot_annual_interpolation + theme(axis.title.y = element_blank(), axis.title.x.top = element_blank()) +
  plot_layout(nrow = 3, guides = "collect")

## U ####
U_thermometry_plot_uninterpolated <- All_samples_thermometry_data_V2 %>%
      group_by(distance.um, Specimen) %>% 
      summarise(Timepoint = 2021-(distance.um/51),
            U_Ca_proxy = ((-0.3*U_Ca/1000)+7.52),
            U_Ca_proxy_TJW = (((3.36*10^5)*U_Ca/1000)+0.978)) %>%
      ggplot() +
      geom_path(aes(x = Timepoint, y = U_Ca_proxy, col = Specimen), linetype = 3)+ # Thresher et al., 2016 - Geochim. et Cosmich. Acta
      geom_path(aes(x = Timepoint, y = U_Ca_proxy_TJW, col = Specimen)) + # My calculated relationship
      geom_point(aes(x = 2018.6068, y =0.86), col = "orange") +
      geom_point(aes(x = 2017.5466, y =0.68), col = "orange") +
      geom_point(aes(x = 2016.5642, y =1.05), col = "orange") +
      geom_point(aes(x = 2021.5849, y = 1.1), col = "orange") +
      labs(y = expression("T"["[rec]"]*" (°C)"), x = "Timepoint (years)") +
      geom_hline(yintercept = 1.1, linetype = 2) +
      geom_hline(yintercept = 0.68, linetype = 2) +
      geom_label(aes(y = 2.5, x = 1990, label = "No interpolation")) +
      scale_x_continuous(limits = c(1960,2022), breaks = seq(1960,2020,5), sec.axis = sec_axis(~ -(. - 2021)*51, name = "Distance from coral wall (µm)")) +
      scale_y_continuous(limits = c(0,10)) +
      theme_classic()

U_thermometry_plot_uninterpolated_averages <- All_samples_thermometry_data_V2 %>%
      group_by(distance.um, Specimen) %>% 
      summarise(Timepoint = 2021-(distance.um/51),
            U_Ca_proxy = ((-0.3*U_Ca/1000)+7.52),
            U_Ca_proxy_TJW = (((3.36*10^5)*U_Ca/1000)+0.978)) %>%
filter(Timepoint >= 2000 & Timepoint <= 2021 & U_Ca_proxy <= 10 & U_Ca_proxy >= 0 & U_Ca_proxy_TJW <= 10 & U_Ca_proxy_TJW >= 0) %>%
  group_by(Specimen) %>%
  summarise(Samples = n(),
    Pub_mean = mean(U_Ca_proxy, na.rm = T),
            Pub_sd = sd(U_Ca_proxy, na.rm = T),
            Pub_se = sd(U_Ca_proxy, na.rm = T)/sqrt(n()),
        TJW_mean = mean(U_Ca_proxy_TJW, na.rm = T),
            TJW_sd = sd(U_Ca_proxy_TJW, na.rm = T),
            TJW_se = sd(U_Ca_proxy_TJW, na.rm = T)/sqrt(n())) %>%
  mutate(Pub_alpha = c(-0.06,-0.22,-0.15,-0.05),
         TJW_alpha = c(-0.06,-0.21,-0.15,-0.04)) %>%
  pivot_longer(cols = c(3:10), names_to = "Calculation", values_to = "value") %>%
  separate(col = "Calculation", "_", into = c("Calibration", "Calculation")) %>%
  pivot_wider(names_from = "Calculation", values_from = "value") %>%
      ggplot() +
          geom_hline(yintercept = 1.1, linetype = 2) +
      geom_hline(yintercept = 0.68, linetype = 2) +
  geom_vline(xintercept = 0, linetype = 2) +
    geom_errorbar(aes(x = alpha, ymin = mean-sd, ymax = mean+sd, linetype = Calibration), 
                width = 0.1) +
      geom_point(aes(x = alpha, y = mean, col = Specimen, fill = Calibration), 
                 pch = 21, size = 4, stroke = 2) +
  scale_fill_manual(values = c("white", "black")) +
  scale_linetype_manual(values = c(3,1)) +
      labs(y = expression("T"["[rec]"]*" (°C)"), x = expression("T"["[rec]"]*" trend (°C.yr"^"-1"*")")) +
       scale_y_continuous(limits = c(0,10)) +
      scale_x_continuous(limits = c(-0.40,0.6)) +
      theme_classic()



U_thermometry_plot_seasonal_interpolation <- All_samples_thermometry_data_V2 %>%
      group_by(distance.um, Specimen) %>% 
      summarise(Timepoint = 2021-(distance.um/51),
            U_Ca_proxy = ((-0.3*U_Ca/1000)+7.52),
            U_Ca_proxy_TJW = (((3.36*10^5)*U_Ca/1000)+0.978)) %>%
  drop_na() %>%
  ungroup(distance.um) %>%
  group_by(Specimen) %>%
  summarise(
            Time = spline(Timepoint, U_Ca_proxy_TJW, xout = seq(min(Timepoint),2021, by = 0.25))$x,
            U_Ca_proxy_season_TJW = spline(Timepoint, U_Ca_proxy_TJW, xout = seq(min(Timepoint),2021, by = 0.25))$y,
            U_Ca_proxy_season = spline(Timepoint, U_Ca_proxy, xout = seq(min(Timepoint),2021, by = 0.25))$y) %>% 
  ggplot() +
  geom_path(aes(Time, U_Ca_proxy_season, group = Specimen, col = Specimen), linetype = 3) +
      geom_path(aes(Time, U_Ca_proxy_season_TJW, group = Specimen, col = Specimen)) +
      geom_point(aes(x = 2018.6068, y =0.86), col = "orange") +
      geom_point(aes(x = 2017.5466, y =0.68), col = "orange") +
      geom_point(aes(x = 2016.5642, y =1.05), col = "orange") +
      geom_point(aes(x = 2021.5849, y = 1.1), col = "orange") +
      labs(y = expression("T"["[rec]"]*" (°C)"), x = "Timepoint (years)") +
      geom_hline(yintercept = 1.1, linetype = 2) +
      geom_hline(yintercept = 0.68, linetype = 2) +
      geom_label(aes(y = 2.5, x = 1990, label = "Seasonal interpolation (spline)")) +
      scale_x_continuous(limits = c(1960,2022), breaks = seq(1960,2020,5), sec.axis = sec_axis(~ -(. - 2021)*51, name = "Distance from coral wall (µm)")) +
      scale_y_continuous(limits = c(0,10)) +
      theme_classic()

U_thermometry_plot_annual_interpolation <- All_samples_thermometry_data_V2 %>%
      group_by(distance.um, Specimen) %>% 
      summarise(Timepoint = 2021-(distance.um/51),
            U_Ca_proxy = ((-0.3*U_Ca/1000)+7.52),
            U_Ca_proxy_TJW = (((3.36*10^5)*U_Ca/1000)+0.978)) %>%
  drop_na() %>%
  ungroup(distance.um) %>%
  group_by(Specimen) %>%
  summarise(
            Time = spline(Timepoint, U_Ca_proxy_TJW, xout = seq(min(Timepoint),2021, by = 1))$x,
            U_Ca_proxy_season_TJW = spline(Timepoint, U_Ca_proxy_TJW, xout = seq(min(Timepoint),2021, by = 1))$y,
            U_Ca_proxy_season = spline(Timepoint, U_Ca_proxy, xout = seq(min(Timepoint),2021, by = 1))$y) %>% 
  ggplot() +
  geom_path(aes(Time, U_Ca_proxy_season, group = Specimen, col = Specimen), linetype = 3) +
      geom_path(aes(Time, U_Ca_proxy_season_TJW, group = Specimen, col = Specimen)) +
      geom_point(aes(x = 2018.6068, y =0.86), col = "orange") +
      geom_point(aes(x = 2017.5466, y =0.68), col = "orange") +
      geom_point(aes(x = 2016.5642, y =1.05), col = "orange") +
      geom_point(aes(x = 2021.5849, y = 1.1), col = "orange") +
      labs(y = expression("T"["[rec]"]*" (°C)"), x = "Timepoint (years)") +
      geom_hline(yintercept = 1.1, linetype = 2) +
      geom_hline(yintercept = 0.68, linetype = 2) +
      geom_label(aes(y = 2.5, x = 1990, label = "Annual interpolation (spline)")) +
      scale_x_continuous(limits = c(1960,2022), breaks = seq(1960,2020,5), sec.axis = sec_axis(~ -(. - 2021)*51, name = "Distance from coral wall (µm)")) +
      scale_y_continuous(limits = c(0,10)) +
      theme_classic()


U_thermometry_plots <- U_thermometry_plot_uninterpolated + theme(axis.title.x.bottom = element_blank(), axis.title.y = element_blank()) +
  U_thermometry_plot_seasonal_interpolation  + theme(axis.title.x = element_blank()) +
  U_thermometry_plot_annual_interpolation + theme(axis.title.y = element_blank(), axis.title.x.top = element_blank()) +
  plot_layout(nrow = 3, guides = "collect")

# TREND SCRIPT
#    ggpmisc::stat_poly_eq(data = data[which(data$Time >=2000),], method = "rlm", label.x = 0.1, label.y = c(0.95, 0.9,0.85,0.8),
                        # aes(x = Time, y = U_Ca_proxy_season_TJW, col = Specimen,
                        #     label = paste(after_stat(eq.label), after_stat(rr.label), sep = "*\", \"*"))) 
  
## Saving files ####
Thermometry_folder_path <- "~/OneDrive - University of Southampton/PhD, INSPIRE DTP/Countries_Chapters/UK [Soton]/Chpt4 Bamboo Coral Analysis/LAICPMS/Data_R_processed/NIST612_Corrected_Thermometry"


ggsave(
  "Li_Mg_thermometry.tiff",
  plot = `Li_Mg_thermometry_plots`,
  path = Thermometry_folder_path,
  scale = 1,
  width = 30,
  height = 15,
  units = "cm",
  dpi = 300,
)

ggsave(
  "Li_Mg_thermometry_constrained.tiff",
  plot = `Li_Mg_thermometry_plots_constrained`,
  path = Thermometry_folder_path,
  scale = 1,
  width = 30,
  height = 15,
  units = "cm",
  dpi = 300,
)

ggsave(
  "Mg_thermometry.tiff",
  plot = `Mg_thermometry_plots`,
  path = Thermometry_folder_path,
  scale = 1,
  width = 30,
  height = 15,
  units = "cm",
  dpi = 300,
)

ggsave(
  "Mg_thermometry_V2.tiff",
  plot = `Mg_thermometry_plots_V2`,
  path = Thermometry_folder_path,
  scale = 2,
  width = 25,
  height = 20,
  units = "cm",
  dpi = 300,
)

ggsave(
  "Mg_thermometry_V3.tiff",
  plot = `Mg_thermometry_plots_V3`,
  path = Thermometry_folder_path,
  scale = 2,
  width = 25,
  height = 20,
  units = "cm",
  dpi = 300,
)

 ggsave(
  "Mg_thermometry_constrained.tiff",
  plot = `Mg_thermometry_plots_constrained`,
  path = Thermometry_folder_path,
  scale = 2,
  width = 30,
  height = 20,
  units = "cm",
  dpi = 300,
)

ggsave(

  "Mg_thermometry_constrained_V2.tiff",
  plot = `Mg_thermometry_plots_constrained_V2`,
  path = Thermometry_folder_path,
  scale = 2,
  width = 25,
  height = 20,
  units = "cm",
  dpi = 300,
)

ggsave(

  "Mg_thermometry_constrained_V3.tiff",
  plot = `Mg_thermometry_plots_constrained_V3`,
  path = Thermometry_folder_path,
  scale = 2,
  width = 25,
  height = 20,
  units = "cm",
  dpi = 300,
)

ggsave(
  "Ba_SW_reconstructed.tiff",
  plot = Ba_SW_plots,
  path = Thermometry_folder_path,
  scale = 2,
  width = 25,
  height = 20,
  units = "cm",
  dpi = 300,
)

# Standard error table ####
ggplot(Standard_errors[which(Standard_errors$Element == "Sr_Ca"),]) +
  geom_point(aes(x = Sample, y = mean_value, col = Section), position = position_dodge2(width= 0.5)) +
  geom_errorbar(aes(x = Sample, ymax = mean_value+coefficient_variation_av, ymin = mean_value-coefficient_variation_av, col = Section), position = position_dodge(width = 0.5))


Standard_errors %>%
  filter(Element %in% c("Li_Ca", "Mg_Ca", "S_Ca", "Sr_Ca", "U_Ca")) %>%
  mutate(mean_value= ifelse(Element == "Mg_Ca" | Element == "S_Ca" | Element == "Sr_Ca", mean_value/1000, 
                            ifelse(Element == "U_Ca", mean_value*1000, mean_value)),
         standard_dev_2_av= ifelse(Element == "Mg_Ca" | Element == "S_Ca" | Element == "Sr_Ca", standard_dev_2_av/1000, 
                            ifelse(Element == "U_Ca", standard_dev_2_av*1000, standard_dev_2_av)),
         standard_error_2_av= ifelse(Element == "Mg_Ca" | Element == "S_Ca" | Element == "Sr_Ca", standard_error_2_av/1000, 
                            ifelse(Element == "U_Ca", standard_error_2_av*1000, standard_error_2_av)),
         max_value= ifelse(Element == "Mg_Ca" | Element == "S_Ca" | Element == "Sr_Ca", max_value/1000, 
                            ifelse(Element == "U_Ca", max_value*1000, max_value)),
         min_value= ifelse(Element == "Mg_Ca" | Element == "S_Ca" | Element == "Sr_Ca", min_value/1000, 
                            ifelse(Element == "U_Ca", min_value*1000, min_value)),
         ) %>%
  write.csv("Table_averages_rasters.csv") %>%

  ggplot() +
  geom_point(aes(x = Sample, y = mean_value, col = Section), position = position_dodge2(width= 0.5)) +
  geom_errorbar(aes(x = Sample, ymax = mean_value+standard_error_2_av, ymin = mean_value-standard_error_2_av, col = Section), position = position_dodge(width = 0.5)) +
  facet_grid( ~ Element) +
  theme_classic()

  
# Comparing data from Baffin Bay deep-basin vs coral Mg/Ca proxy ####

BBay_data <- data.frame(Timepoint = c(1940.617181,
                                          1952.560467,
                                          1953.494579,
                                          1959.566305,
                                          1960.567139,
                                          1962.63553,
                                          1961.567973,
                                          1963.569641,
                                          1964.70392,
                                          1965.704754,
                                          1966.505421,
                                          1969.507923,
                                          1971.976647,
                                          1978.648874,
                                          1979.71643,
                                          1977.581318,
                                          1984.386989,
                                          1987.589658,
                                          1990.658882,
                                          1983.5196,
                                          1997.531276,
                                          2003.53628), Temperature = c(0.410084034,
                                                                       0.645378151,
                                                                       0.971428571,
                                                                       0.736134454,
                                                                       0.816806723,
                                                                       0.699159664,
                                                                       0.581512605,
                                                                       0.581512605,
                                                                       0.507563025,
                                                                       0.396638655,
                                                                       0.655462185,
                                                                       0.715966387,
                                                                       0.611764706,
                                                                       0.833613445,
                                                                       0.917647059,
                                                                       0.998319328,
                                                                       0.937815126,
                                                                       1.062184874,
                                                                       1.156302521,
                                                                       1.361344538,
                                                                       0.968067227,
                                                                       1.008403361))

Mg_T_23_6 <- All_samples_Mg_thermometry_annual_constrained[which(All_samples_Mg_thermometry_annual_constrained$Specimen == "S_23_6" & All_samples_Mg_thermometry_annual_constrained$Time <= 1998),] %>%
  group_by(Specimen, Time) %>%
  mutate(Time = round(Time, digits = 0)) %>%
    summarise(Time = Time,
            Mg_Ca_proxy_annual_TJW_mean = mean(Mg_Ca_proxy_annual_TJW, na.rm = T),
            Mg_Ca_proxy_annual_TJW_sd = sd(Mg_Ca_proxy_annual_TJW, na.rm = T),
            n = n()) %>%
  unique()

lmodel2(Mg_Ca_proxy_annual_TJW_mean ~ Time, data = Mg_T_23_6, "interval", "interval", 999)

lmodel2(Temperature ~ Timepoint, data = BBay_data[which(BBay_data$Timepoint < 2000 & BBay_data$Timepoint >= 1966),], "interval", "interval", 999)


Figure5 <- ggplot() +
  geom_errorbar(data = Mg_T_23_6, aes(x = Time, ymin = Mg_Ca_proxy_annual_TJW_mean-Mg_Ca_proxy_annual_TJW_sd, ymax = Mg_Ca_proxy_annual_TJW_mean+Mg_Ca_proxy_annual_TJW_sd), size = 0.25, na.rm = T)+
  geom_point(data = Mg_T_23_6, aes(x = Time, y = Mg_Ca_proxy_annual_TJW_mean), fill = "purple", pch = 21, size = 2) +
  geom_point(data = BBay_data[which(BBay_data$Timepoint <= 1998 & BBay_data$Timepoint >= 1966),], aes(x = Timepoint, y = Temperature), fill = "green", pch = 22, size = 2) +
  geom_smooth(method = lm, data = Mg_T_23_6, aes(x = Time, y = Mg_Ca_proxy_annual_TJW_mean), col = "purple") +
  geom_smooth(method = lm, data = BBay_data[which(BBay_data$Timepoint <= 1998 & BBay_data$Timepoint >= 1966),], aes(x = Timepoint, y = Temperature), col = "green") +
  geom_text(aes(x = 1975, y = 4, label = as.character(expression("T"["[trend]"]*" = 0.060 ± 0.017 (°C/yr), p < 0.0001"))), col = "purple", parse = T) +
  geom_text(aes(x = 1975, y = 3.7, label = as.character(expression("T"["[trend]"]*" = 0.016 ± 0.013 (°C/yr), p < 0.0001"))), col = "green", parse = T) +
  labs(y = expression("T"["[rec]"]*" (°C)"), x = "Timepoint (years)") +
  theme_classic()


ggsave("BBdata_v_Coraldata.tiff",
       plot = Figure5,
       path = Thermometry_folder_path,
       height = 8,
       width = 10,
       scale = 1.5,
       units = "cm", dpi = 300)
```

# Statistical testing of mean T[rec] and its trend of the common time period

```{r ANOVA of Mg/Ca T[rec]}

Uninterpolated_temperature_data <- All_samples_Mg_thermometry_common_constrained %>%
  group_by(Specimen, Internode) %>%
  summarise(Samples = n(),
            Interpolation = "none",
            Timerange = "2003-2016",
            # Pub_mean = mean(Mg_Ca_proxy, na.rm = T),
            #         Pub_sd = sd(Mg_Ca_proxy, na.rm = T),
            #         Pub_se = sd(Mg_Ca_proxy, na.rm = T)/sqrt(n()),
            Trec_mean = mean(Mg_Ca_proxy_TJW, na.rm = T),
            Trec_sd = sd(Mg_Ca_proxy_TJW, na.rm = T),
            Trec_se = sd(Mg_Ca_proxy_TJW, na.rm = T)/sqrt(n())) %>%
  left_join(Mg_thermometry_trends, by = c("Specimen", "Internode", "Interpolation", "Timerange")) %>%
  # pivot_longer(cols = c(6:9), names_to = "Calculation", values_to = "value") %>%
  # separate(col = "Calculation", "_", into = c("Calibration", "Calculation")) %>%
  # pivot_wider(names_from = "Calculation", values_from = "value") %>%
  filter(Regression_type == "OLS") %>%
  dplyr::select(Specimen, Internode, Interpolation, Trec_mean, Trec_se, Ttrend_Gradient)


Seasonal_interpolated_data <- All_samples_Mg_thermometry_season_common_constrained %>%
  group_by(Specimen, Internode) %>%
  summarise(Samples = n(),
            Interpolation = "seasonal",
            Timerange = "2003-2016",
            # Pub_mean = mean(Mg_Ca_proxy, na.rm = T),
            #         Pub_sd = sd(Mg_Ca_proxy, na.rm = T),
            #         Pub_se = sd(Mg_Ca_proxy, na.rm = T)/sqrt(n()),
            Trec_mean = mean(Mg_Ca_proxy_season_TJW, na.rm = T),
            Trec_sd = sd(Mg_Ca_proxy_season_TJW, na.rm = T),
            Trec_se = sd(Mg_Ca_proxy_season_TJW, na.rm = T)/sqrt(n())) %>%
  left_join(Mg_thermometry_trends, by = c("Specimen", "Internode", "Interpolation", "Timerange")) %>%
  # pivot_longer(cols = c(6:9), names_to = "Calculation", values_to = "value") %>%
  # separate(col = "Calculation", "_", into = c("Calibration", "Calculation")) %>%
  # pivot_wider(names_from = "Calculation", values_from = "value") %>%
  filter(Regression_type == "OLS") %>%
  dplyr::select(Specimen, Internode, Interpolation, Trec_mean, Ttrend_Gradient)

Annual_interpolated_data <- All_samples_Mg_thermometry_annual_common_constrained %>%
  group_by(Specimen, Internode) %>%
  summarise(Samples = n(),
            Interpolation = "annual",
            Timerange = "2003-2016",
            # Pub_mean = mean(Mg_Ca_proxy, na.rm = T),
            #         Pub_sd = sd(Mg_Ca_proxy, na.rm = T),
            #         Pub_se = sd(Mg_Ca_proxy, na.rm = T)/sqrt(n()),
            Trec_mean = mean(Mg_Ca_proxy_annual_TJW, na.rm = T),
            Trec_sd = sd(Mg_Ca_proxy_annual_TJW, na.rm = T),
            Trec_se = sd(Mg_Ca_proxy_annual_TJW, na.rm = T)/sqrt(n())) %>%
  left_join(Mg_thermometry_trends, by = c("Specimen", "Internode", "Interpolation", "Timerange")) %>%
  # pivot_longer(cols = c(6:9), names_to = "Calculation", values_to = "value") %>%
  # separate(col = "Calculation", "_", into = c("Calibration", "Calculation")) %>%
  # pivot_wider(names_from = "Calculation", values_from = "value") %>%
  filter(Regression_type == "OLS") %>%
  dplyr::select(Specimen, Internode, Interpolation, Trec_mean, Ttrend_Gradient)

Temperature_data <-  rbind(Uninterpolated_temperature_data, Seasonal_interpolated_data, Annual_interpolated_data)

Ba_uninterpolated_data <- All_samples_Ba_SW_common %>%
  group_by(Specimen, Internode) %>%
  summarise(Samples = n(),
            Interpolation = "none",
            Timerange = "2000-2021",
            # Pub_mean = mean(Mg_Ca_proxy, na.rm = T),
            #         Pub_sd = sd(Mg_Ca_proxy, na.rm = T),
            #         Pub_se = sd(Mg_Ca_proxy, na.rm = T)/sqrt(n()),
            BaSw_mean = mean(Ba_Ca_proxy_TJW, na.rm = T),
            BaSw_sd = sd(Ba_Ca_proxy_TJW, na.rm = T),
            BaSw_se = sd(Ba_Ca_proxy_TJW, na.rm = T)/sqrt(n()))

Ba_season_interpolated_data <- All_samples_Ba_SW_season_common %>%
  group_by(Specimen, Internode) %>%
  summarise(Samples = n(),
            Interpolation = "season",
            Timerange = "2000-2021",
            # Pub_mean = mean(Mg_Ca_proxy, na.rm = T),
            #         Pub_sd = sd(Mg_Ca_proxy, na.rm = T),
            #         Pub_se = sd(Mg_Ca_proxy, na.rm = T)/sqrt(n()),
            BaSw_mean = mean(Ba_Ca_proxy_season_TJW, na.rm = T),
            BaSw_sd = sd(Ba_Ca_proxy_season_TJW, na.rm = T),
            BaSw_se = sd(Ba_Ca_proxy_season_TJW, na.rm = T)/sqrt(n()))

Ba_annual_interpolated_data <- All_samples_Ba_SW_annual_common %>%
  group_by(Specimen, Internode) %>%
  summarise(Samples = n(),
            Interpolation = "annual",
            Timerange = "2000-2021",
            # Pub_mean = mean(Mg_Ca_proxy, na.rm = T),
            #         Pub_sd = sd(Mg_Ca_proxy, na.rm = T),
            #         Pub_se = sd(Mg_Ca_proxy, na.rm = T)/sqrt(n()),
            BaSw_mean = mean(Ba_Ca_proxy_annual_TJW, na.rm = T),
            BaSw_sd = sd(Ba_Ca_proxy_annual_TJW, na.rm = T),
            BaSw_se = sd(Ba_Ca_proxy_annual_TJW, na.rm = T)/sqrt(n()))

Ba_data <- rbind(Ba_uninterpolated_data, Ba_season_interpolated_data, Ba_annual_interpolated_data)

# Temperature intercept (mean reconstructed temperature) ####
## 1. Data exploration####
library(nlme)
par(mfrow = c(1,2))
hist(Temperature_data$Trec_mean) # normal
qqnorm(Temperature_data$Trec_mean) 



## 2. Full linear model with all interaction terms####
Trec_mean.lm <- lm(Trec_mean ~ as.factor(Specimen)*as.factor(Internode), data = Temperature_data)


## 3. Diagnostics on residuals from linear model to show heterogeneity of variance####
par(mfrow=c(2,2))
plot(Trec_mean.lm) ## cone shape in residuals vs fitted values, long tailed distribution

##Cooks distance gives you information on outliers.
cooks <- cooks.distance(Trec_mean.lm)
par(mfrow=c(1,1))
plot(cooks) 
## one  point >0.3 cooks distance.

Temperature_data$Interpolation <- fct_relevel(factor(Temperature_data$Interpolation), levels = c("none", "seasonal", "annual"))
  
## 3b. Testing the linear mixed-effects model with all interaction terms.####
Trec_mean.lm <- gls(Trec_mean ~ as.factor(Specimen)*as.factor(Internode), data = Temperature_data, method = "REML")
Trec_mean.lme <- lme(Trec_mean ~ as.factor(Specimen)*as.factor(Internode), random =~ 1|as.factor(Interpolation), data = Temperature_data, method = "REML") #random intercept Interpolation effect

anova(Trec_mean.lm, Trec_mean.lme)
#             Model df      AIC      BIC    logLik   Test L.Ratio p-value
# Trec_mean.lm      1 13 24.19662 39.51131  0.901692                       
# Trec_mean.lme     2 14  0.52992 17.02267 13.735040 1 vs 2 25.6667  <.0001

# Now get correct p value by running 0.5 * (1-pchisq(L.ratio, d.f.)) = 0.000001 so marginal effect
plot(as.factor(Temperature_data$Interpolation),(resid(Trec_mean.lm, type = 'pearson')))
abline(lm((resid(Trec_mean.lm, type = 'pearson')) ~ as.factor(Temperature_data$Interpolation)), col = "black")
abline(lm((resid(Trec_mean.lme, type = 'pearson')) ~ as.factor(Temperature_data$Interpolation)), col = "red", lty = 2)

## 3c. Retest residuals from best linear mixed effects model ####
plot(Trec_mean.lme) ##slight cone shape in residuals vs fitted values


## 4. If you have a cone shape, then plot residuals against factors in turn, to identify where the problems lie ####
par(mfrow=c(1,1))
E <- resid(Trec_mean.lme, method = "normalized")
plot(as.factor(Trec_mean.lme$data$Specimen), E) # largest spread in 23-10 and 23-6, outliers in 23-16
plot(as.factor(Trec_mean.lme$data$Internode), E) # largest spread in internode 2, 
# biggest problem in specimen

## 5. Run LME model with NO WEIGHTING and REML set to true. This will be the base model for future model comparisons ####
library(nlme)
Trec_mean.lme <- lme(Trec_mean ~ as.factor(Specimen)*as.factor(Internode), random =~ 1|as.factor(Interpolation), data = Temperature_data, method = "REML")
summary(Trec_mean.lme)

## 6. Run several lme models with weighting along single factors (one at a time), again using REML.
## lme models with a single weighting…
## Formula for Trec_mean_mean
f3 <- formula(Trec_mean ~ as.factor(Specimen) + as.factor(Internode) +
                as.factor(Specimen):as.factor(Internode))
Trec_mean.lme <- lme(f3, random =~ 1|as.factor(Interpolation), data = Temperature_data, method = "REML")



## 7. Use anova to look at AIC scores for each single weighted model (tmp.lme1 etc.) to compare with base model (tmp.lme).  ####
Trec_mean.lme1 <- lme(f3, random =~ 1|as.factor(Interpolation), weights = varIdent(form = ~ 1|as.factor(Specimen)), method = "REML", data = Temperature_data)
Trec_mean.lme2 <- lme(f3, random =~ 1|as.factor(Interpolation), weights = varIdent(form = ~ 1|as.factor(Internode)), method = "REML", data = Temperature_data)

## Compare baseline lme model  with weighted models 
anova(Trec_mean.lme, Trec_mean.lme1) # lowest AIC 
anova(Trec_mean.lme, Trec_mean.lme2) 

# both new weighted models have an AIC two units different from previous model
# residual plots
plot(Trec_mean.lme)
plot(Trec_mean.lme1) # massive improvement in residual spread = go with weighted lme
plot(Trec_mean.lme2)

# Check whether there needs to be two weighted term
Trec_mean.lme3 <- lme(f3, random =~ 1|as.factor(Interpolation), weights = varIdent(form = ~ 1|as.factor(Internode)*as.factor(Specimen)), method = "REML", data = Temperature_data)

anova(Trec_mean.lme1, Trec_mean.lme3)
#                Model df       AIC      BIC   logLik   Test  L.Ratio p-value
# Trec_mean.lme1     1 17 -5.404802 14.62211 19.70240                        
# Trec_mean.lme3     2 25 -2.515088 26.93626 26.25754 1 vs 2 13.11029  0.1081

plot(Trec_mean.lme3) # not big improvement in residual spread = go with one weighed lme

## 8.  Manual backward step regression. MODELS WILL BE RUN WITH ML (i.e. method = “ML”). ####

## Best Model - with all interaction terms and weighting for one factor - Specimen
Trec_mean.lme100 <- lme(Trec_mean ~ as.factor(Specimen) + as.factor(Internode) +
                as.factor(Specimen):as.factor(Internode), 
                random =~ 1|as.factor(Interpolation),
                            weights = varIdent(form = ~ 1|as.factor(Specimen)), method = "ML", data = Temperature_data)


#  Make alternative models with each of the 3-way interactions (or whatever your highest number of interactions is) removed in turn, and then compare each one of these models to the full model to see if there is any improvement using the MAXIMUM LIKELIHOOD test

## Model with 2-way interaction term between Specimen and Internode removed 
Trec_mean.lme101 <- lme(Trec_mean ~ as.factor(Specimen) + as.factor(Internode),
                      random =~ 1|as.factor(Interpolation),
                            weights = varIdent(form = ~ 1|as.factor(Specimen)), method = "ML", data = Temperature_data)

anova(Trec_mean.lme100,Trec_mean.lme101) 
#                Model df       AIC       BIC    logLik   Test  L.Ratio p-value
# Trec_mean.lme100     1 17 -59.47897 -32.55915  46.73948                        
# Trec_mean.lme101     2 11  45.85858  63.27729 -11.92929 1 vs 2 117.3375  <.0001

# p value significant and AIC worsened, so have to keep two way interaction from model

## 9. To determine the importance of single terms ####
Trec_mean.lme.Specimen <- lme(Trec_mean ~ as.factor(Internode), 
                            random =~ 1|as.factor(Interpolation),
                            weights = varIdent(form = ~ 1|as.factor(Specimen)), method = "ML", data = Temperature_data)

Trec_mean.lme.Internode <- lme(Trec_mean ~ as.factor(Specimen), 
                            random =~ 1|as.factor(Interpolation),
                            weights = varIdent(form = ~ 1|as.factor(Specimen)), method = "ML", data = Temperature_data)

anova(Trec_mean.lme100, Trec_mean.lme.Specimen)
#                        Model df       AIC       BIC    logLik   Test  L.Ratio p-value
# Trec_mean.lme100           1 17 -59.47897 -32.55915  46.73948                        
# Trec_mean.lme.Specimen     2  8  98.33741 111.00556 -41.16870 1 vs 2 175.8164  <.0001

anova(Trec_mean.lme100, Trec_mean.lme.Internode)
#                         Model df       AIC       BIC    logLik   Test L.Ratio p-value
# Trec_mean.lme100            1 17 -59.47897 -32.55915  46.73948                       
# Trec_mean.lme.Internode     2  9 113.60000 127.85167 -47.80000 1 vs 2 189.079  <.0001

# best mode with REML method 
Trec_mean.lmebest <- lme(Trec_mean ~ as.factor(Specimen) + as.factor(Internode) +
                as.factor(Specimen):as.factor(Internode), 
                random =~ 1|as.factor(Interpolation),
                            weights = varIdent(form = ~ 1|as.factor(Specimen)), method = "REML", data = Temperature_data)

anova(Trec_mean.lmebest)
#                                          numDF denDF  F-value p-value
# (Intercept)                                  1    22 47.30499  <.0001
# as.factor(Specimen)                          3    22 54.95708  <.0001
# as.factor(Internode)                         2    22 54.86051  <.0001
# as.factor(Specimen):as.factor(Internode)     6    22  5.30968  0.0016

summary(Trec_mean.lmebest)
##quick diagnostic check on the final model
plot(Trec_mean.lmebest)
# Temperature slope (reconstructed temperature trend) ####
## 1. Data exploration####
library(nlme)
par(mfrow = c(1,2))
hist(Temperature_data$Ttrend_Gradient) # skewed
qqnorm(Temperature_data$Ttrend_Gradient) 



## 2. Full linear model with all interaction terms####
T_trend.lm <- lm(Ttrend_Gradient ~ as.factor(Specimen)*as.factor(Internode), data = Temperature_data)


## 3. Diagnostics on residuals from linear model to show heterogeneity of variance####
par(mfrow=c(2,2))
plot(T_trend.lm) ##slight cone shape in residuals vs fitted values, long tailed distribution

##Cooks distance gives you information on outliers.
cooks <- cooks.distance(T_trend.lm)
par(mfrow=c(1,1))
plot(cooks) 
## one  point >0.5 cooks distance.

Temperature_data$Interpolation <- fct_relevel(factor(Temperature_data$Interpolation), levels = c("none", "seasonal", "annual"))
  
## 3b. Testing the linear mixed-effects model with all interaction terms.####
T_trend.lm <- gls(Ttrend_Gradient ~ as.factor(Specimen)*as.factor(Internode), data = Temperature_data, method = "REML")
T_trend.lme <- lme(Ttrend_Gradient ~ as.factor(Specimen)*as.factor(Internode), random =~ 1|as.factor(Interpolation), data = Temperature_data, method = "REML") #random intercept Interpolation effect

anova(T_trend.lm, T_trend.lme)
#             Model df       AIC       BIC   logLik   Test L.Ratio p-value
# T_trend.lm      1 13 -40.50115 -25.18645 33.25058                       
# T_trend.lme     2 14 -40.65499 -24.16224 34.32750 1 vs 2 2.15384  0.1422

# Now get correct p value by running 0.5 * (1-pchisq(L.ratio, d.f.)) = 0.07110691 so marginal effect
plot(as.factor(Temperature_data$Interpolation),(resid(T_trend.lm, type = 'pearson')))
abline(lm((resid(T_trend.lm, type = 'pearson')) ~ as.factor(Temperature_data$Interpolation)), col = "black")
abline(lm((resid(T_trend.lme, type = 'pearson')) ~ as.factor(Temperature_data$Interpolation)), col = "red", lty = 2)


## 3c. Retest residuals from best linear mixed effects model ####
par(mfrow=c(2,2))
plot(T_trend.lme) ##still cone shape in residuals vs fitted values


## 4. If you have a cone shape, then plot residuals against factors in turn, to identify where the problems lie ####
par(mfrow=c(1,2))
E <- resid(T_trend.lme, method = "normalized")
plot(as.factor(T_trend.lme$data$Specimen), E) # largest spread in 23-16, outliers in 23-10
plot(as.factor(T_trend.lme$data$Internode), E) # largest spread in internode 3, outliers in all
# biggest problem in specimen

## 5. Run LME model with NO WEIGHTING and REML set to true. This will be the base model for future model comparisons ####
library(nlme)
T_trend.lme <- lme(Ttrend_Gradient ~ as.factor(Specimen)*as.factor(Internode), random =~ 1|as.factor(Interpolation), data = Temperature_data, method = "REML")
summary(T_trend.lme)

## 6. Run several lme models with weighting along single factors (one at a time), again using REML.
## lme models with a single weighting…
## Formula for T_trend_mean
f3 <- formula(Ttrend_Gradient ~ as.factor(Specimen) + as.factor(Internode) +
                as.factor(Specimen):as.factor(Internode))
T_trend.lme <- lme(f3, random =~ 1|as.factor(Interpolation), data = Temperature_data, method = "REML")



## 7. Use anova to look at AIC scores for each single weighted model (tmp.lme1 etc.) to compare with base model (tmp.lme).  ####
T_trend.lme1 <- lme(f3, random =~ 1|as.factor(Interpolation), weights = varIdent(form = ~ 1|as.factor(Specimen)), method = "REML", data = Temperature_data)
T_trend.lme2 <- lme(f3, random =~ 1|as.factor(Interpolation), weights = varIdent(form = ~ 1|as.factor(Internode)), method = "REML", data = Temperature_data)

## Compare baseline lme model  with weighted models 
anova(T_trend.lme, T_trend.lme1) # lowest AIC 
anova(T_trend.lme, T_trend.lme2) 

# both new weighted models have an AIC two units different from previous model
# residual plots
plot(T_trend.lme)
plot(T_trend.lme1) # massive improvement in residual spread = go with weighted lme
plot(T_trend.lme2)

# Check whether there needs to be two weighted term
T_trend.lme3 <- lme(f3, random =~ 1|as.factor(Interpolation), weights = varIdent(form = ~ 1|as.factor(Internode)*as.factor(Specimen)), method = "REML", data = Temperature_data)

anova(T_trend.lme1, T_trend.lme3)
#              Model df       AIC       BIC   logLik   Test  L.Ratio p-value
# T_trend.lme1     1 17 -62.18189 -42.15497 48.09094                        
# T_trend.lme3     2 25 -64.84708 -35.39573 57.42354 1 vs 2 18.66519  0.0168

plot(T_trend.lme3) # massive improvement in residual spread = go with two weighed lme

## 8.  Manual backward step regression. MODELS WILL BE RUN WITH ML (i.e. method = “ML”). ####

## Best Model - with all interaction terms and weighting for one factor - Specimen
T_trend.lme100 <- lme(Ttrend_Gradient ~ as.factor(Specimen) + as.factor(Internode) +
                as.factor(Specimen):as.factor(Internode), 
                random =~ 1|as.factor(Interpolation),
                            weights = varIdent(form = ~ 1|as.factor(Internode)*as.factor(Specimen)), method = "ML", data = Temperature_data)


#  Make alternative models with each of the 3-way interactions (or whatever your highest number of interactions is) removed in turn, and then compare each one of these models to the full model to see if there is any improvement using the MAXIMUM LIKELIHOOD test

## Model with 2-way interaction term between Specimen and Internode removed 
T_trend.lme101 <- lme(Ttrend_Gradient ~ as.factor(Specimen) + as.factor(Internode),
                      random =~ 1|as.factor(Interpolation),
                            weights = varIdent(form = ~ 1|as.factor(Internode)*as.factor(Specimen)), method = "ML", data = Temperature_data)

anova(T_trend.lme100,T_trend.lme101) 
#                Model df       AIC       BIC    logLik   Test  L.Ratio p-value
# T_trend.lme100     1 25 -156.6424 -117.0544 103.32119                        
# T_trend.lme101     2 19 -148.0158 -117.9290  93.00792 1 vs 2 20.62654  0.0021

# p value significant and AIC worsened, so have to keep two way interaction from model

## 9. To determine the importance of single terms ####
T_trend.lme.Specimen <- lme(Ttrend_Gradient ~ as.factor(Internode), 
                            random =~ 1|as.factor(Interpolation),
                            weights = varIdent(form = ~ 1|as.factor(Internode)*as.factor(Specimen)), method = "ML", data = Temperature_data)

T_trend.lme.Internode <- lme(Ttrend_Gradient ~ as.factor(Specimen), 
                            random =~ 1|as.factor(Interpolation),
                            weights = varIdent(form = ~ 1|as.factor(Internode)*as.factor(Specimen)), method = "ML", data = Temperature_data, control =list(msMaxIter = 1000, msMaxEval = 1000))

anova(T_trend.lme100, T_trend.lme.Specimen)
#                      Model df       AIC        BIC    logLik   Test  L.Ratio p-value
# T_trend.lme100           1 25 -156.6424 -117.05441 103.32119                        
# T_trend.lme.Specimen     2 16 -107.7115  -82.37522  69.85576 1 vs 2 66.93086  <.0001

anova(T_trend.lme100, T_trend.lme.Internode)
#                       Model df       AIC       BIC    logLik   Test  L.Ratio p-value
# T_trend.lme100            1 25 -156.6424 -117.0544 103.32119                        
# T_trend.lme.Internode     2  9 -123.9976 -109.7460  70.99883 1 vs 2 64.64473  <.0001

# best mode with REML method 
T_trend.lmebest <- lme(Ttrend_Gradient ~ as.factor(Specimen) + as.factor(Internode) +
                as.factor(Specimen):as.factor(Internode), 
                random =~ 1|as.factor(Interpolation),
                            weights = varIdent(form = ~ 1|as.factor(Internode)*as.factor(Specimen)), method = "REML", data = Temperature_data)

anova(T_trend.lmebest)
#                                          numDF denDF  F-value p-value
# (Intercept)                                  1    22  25.4418  <.0001
# as.factor(Specimen)                          3    22 691.4990  <.0001
# as.factor(Internode)                         2    22  82.5673  <.0001
# as.factor(Specimen):as.factor(Internode)     6    22   6.6741   4e-04

summary(T_trend.lmebest)
##quick diagnostic check on the final model
plot(T_trend.lmebest)


# Ba intercept (mean reconstructed Ba) ####
## 1. Data exploration####
library(nlme)
par(mfrow = c(1,2))
hist(Ba_data$BaSw_mean) # skewed
qqnorm(Ba_data$BaSw_mean) 



## 2. Full linear model with all interaction terms####
BaSw_mean.lm <- lm(BaSw_mean ~ as.factor(Specimen)*as.factor(Internode), data = Ba_data)


## 3. Diagnostics on residuals from linear model to show heterogeneity of variance####
par(mfrow=c(2,2))
plot(BaSw_mean.lm) ##slight cone shape in residuals vs fitted values, long tailed distribution

##Cooks distance gives you information on outliers.
cooks <- cooks.distance(BaSw_mean.lm)
par(mfrow=c(1,1))
plot(cooks) 
## one  point >0.5 cooks distance.

Ba_data$Interpolation <- fct_relevel(factor(Ba_data$Interpolation), levels = c("none", "season", "annual"))
  
## 3b. Testing the linear mixed-effects model with all interaction terms.####
BaSw_mean.lm <- gls(BaSw_mean ~ as.factor(Specimen)*as.factor(Internode), data = Ba_data, method = "REML")
BaSw_mean.lme <- lme(BaSw_mean ~ as.factor(Specimen)*as.factor(Internode), random =~ 1|as.factor(Interpolation), data = Ba_data, method = "REML") #random intercept Interpolation effect

anova(BaSw_mean.lm, BaSw_mean.lme)
#               Model df      AIC      BIC    logLik   Test     L.Ratio p-value
# BaSw_mean.lm      1 13 116.3172 131.6319 -45.15860                           
# BaSw_mean.lme     2 14 118.3076 134.8004 -45.15383 1 vs 2 0.009553064  0.9221

# Now get correct p value by running 0.5 * (1-pchisq(L.ratio, d.f.)) = 0.4610757 so marginal effect
plot(as.factor(Ba_data$Interpolation),(resid(BaSw_mean.lm, type = 'pearson')))
abline(lm((resid(BaSw_mean.lm, type = 'pearson')) ~ as.factor(Ba_data$Interpolation)), col = "black")
abline(lm((resid(BaSw_mean.lme, type = 'pearson')) ~ as.factor(Ba_data$Interpolation)), col = "red", lty = 2)


## 3c. Retest residuals from best linear mixed effects model ####
par(mfrow=c(2,2))
plot(BaSw_mean.lme) ##still cone shape in residuals vs fitted values


## 4. If you have a cone shape, then plot residuals against factors in turn, to identify where the problems lie ####
par(mfrow=c(1,2))
E <- resid(BaSw_mean.lme, method = "normalized")
plot(as.factor(BaSw_mean.lme$data$Specimen), E) # largest spread in 23-16 and 23-10, outliers in 23-16, 23-6 and 23-1
plot(as.factor(BaSw_mean.lme$data$Internode), E) # largest spread in internode 3, outliers in 1 and 2
# biggest problem in specimen

## 5. Run LME model with NO WEIGHTING and REML set to true. This will be the base model for future model comparisons ####
library(nlme)
BaSw_mean.lme <- lme(BaSw_mean ~ as.factor(Specimen)*as.factor(Internode), random =~ 1|as.factor(Interpolation), data = Ba_data, method = "REML")
summary(BaSw_mean.lme)

## 6. Run several lme models with weighting along single factors (one at a time), again using REML.
## lme models with a single weighting…
## Formula for BaSw_mean_mean
f3 <- formula(BaSw_mean ~ as.factor(Specimen) + as.factor(Internode) +
                as.factor(Specimen):as.factor(Internode))
BaSw_mean.lme <- lme(f3, random =~ 1|as.factor(Interpolation), data = Ba_data, method = "REML")



## 7. Use anova to look at AIC scores for each single weighted model (tmp.lme1 etc.) to compare with base model (tmp.lme).  ####
BaSw_mean.lme1 <- lme(f3, random =~ 1|as.factor(Interpolation), weights = varIdent(form = ~ 1|as.factor(Specimen)), method = "REML", data = Ba_data)
BaSw_mean.lme2 <- lme(f3, random =~ 1|as.factor(Interpolation), weights = varIdent(form = ~ 1|as.factor(Internode)), method = "REML", data = Ba_data)

## Compare baseline lme model  with weighted models 
anova(BaSw_mean.lme, BaSw_mean.lme1) # neither improved AIC
anova(BaSw_mean.lme, BaSw_mean.lme2) 

# both new weighted models have an AIC two units different from previous model
# residual plots
plot(BaSw_mean.lme)
plot(BaSw_mean.lme1) #  improvement in residual spread = go with weighted lme
plot(BaSw_mean.lme2)

# Check whether there needs to be two weighted term
BaSw_mean.lme3 <- lme(f3, random =~ 1|as.factor(Interpolation), weights = varIdent(form = ~ 1|as.factor(Internode)*as.factor(Specimen)), method = "REML", data = Ba_data)

anova(BaSw_mean.lme1, BaSw_mean.lme3)
#                Model df      AIC      BIC    logLik   Test  L.Ratio p-value
# BaSw_mean.lme1     1 17 119.5655 139.5924 -42.78273                        
# BaSw_mean.lme3     2 25 106.6800 136.1313 -28.33998 1 vs 2 28.88551   3e-04

plot(BaSw_mean.lme3) # massive improvement in residual spread = go with two weighed lme

## 8.  Manual backward step regression. MODELS WILL BE RUN WITH ML (i.e. method = “ML”). ####

## Best Model - with all interaction terms and weighting for one factor - Specimen
BaSw_mean.lme100 <- lme(BaSw_mean ~ as.factor(Specimen) + as.factor(Internode) +
                as.factor(Specimen):as.factor(Internode), 
                random =~ 1|as.factor(Interpolation),
                            weights = varIdent(form = ~ 1|as.factor(Internode)*as.factor(Specimen)), method = "ML", data = Ba_data)


#  Make alternative models with each of the 3-way interactions (or whatever your highest number of interactions is) removed in turn, and then compare each one of these models to the full model to see if there is any improvement using the MAXIMUM LIKELIHOOD test

## Model with 2-way interaction term between Specimen and Internode removed 
BaSw_mean.lme101 <- lme(BaSw_mean ~ as.factor(Specimen) + as.factor(Internode),
                      random =~ 1|as.factor(Interpolation),
                            weights = varIdent(form = ~ 1|as.factor(Internode)*as.factor(Specimen)), method = "ML", data = Ba_data)

anova(BaSw_mean.lme100,BaSw_mean.lme101) 
#                  Model df      AIC      BIC    logLik   Test  L.Ratio p-value
# BaSw_mean.lme100     1 25 100.6482 140.2362 -25.32409                        
# BaSw_mean.lme101     2 19 120.8813 150.9681 -41.44063 1 vs 2 32.23309  <.0001

# p value significant and AIC worsened, so have to keep two way interaction from model

## 9. To determine the importance of single terms ####
BaSw_mean.lme.Specimen <- lme(BaSw_mean ~ as.factor(Internode), 
                            random =~ 1|as.factor(Interpolation),
                            weights = varIdent(form = ~ 1|as.factor(Internode)*as.factor(Specimen)), method = "ML", data = Ba_data)

BaSw_mean.lme.Internode <- lme(BaSw_mean ~ as.factor(Specimen), 
                            random =~ 1|as.factor(Interpolation),
                            weights = varIdent(form = ~ 1|as.factor(Internode)*as.factor(Specimen)), method = "ML", data = Ba_data)

anova(BaSw_mean.lme100, BaSw_mean.lme.Specimen)
#                        Model df      AIC      BIC    logLik   Test  L.Ratio p-value
# BaSw_mean.lme100           1 25 100.6482 140.2362 -25.32409                        
# BaSw_mean.lme.Specimen     2 16 186.7900 212.1263 -77.39498 1 vs 2 104.1418  <.0001

anova(BaSw_mean.lme100, BaSw_mean.lme.Internode)
#                         Model df      AIC      BIC    logLik   Test L.Ratio p-value
# BaSw_mean.lme100            1 25 100.6482 140.2362 -25.32409                       
# BaSw_mean.lme.Internode     2 17 117.6257 144.5455 -41.81284 1 vs 2 32.9775   1e-04

# best mode with REML method 
BaSw_mean.lmebest <- lme(BaSw_mean ~ as.factor(Specimen) + as.factor(Internode) +
                as.factor(Specimen):as.factor(Internode), 
                random =~ 1|as.factor(Interpolation),
                            weights = varIdent(form = ~ 1|as.factor(Internode)*as.factor(Specimen)), method = "REML", data = Ba_data)

anova(BaSw_mean.lmebest)
#                                          numDF denDF   F-value p-value
# (Intercept)                                  1    22 1294419.2  <.0001
# as.factor(Specimen)                          3    22    4647.2  <.0001
# as.factor(Internode)                         2    22      54.5  <.0001
# as.factor(Specimen):as.factor(Internode)     6    22      14.1  <.0001

summary(BaSw_mean.lmebest)
##quick diagnostic check on the final model
plot(BaSw_mean.lmebest)



```

